<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Cairo ÙƒØ®Ø· Ø£Ø³Ø§Ø³ÙŠ */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            overscroll-behavior: none;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… */
        .equation-font {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95rem; 
            font-weight: 700;
            text-align: center;
        }

        sub {
            font-size: 0.75em;
            vertical-align: sub;
            line-height: 0;
            font-family: 'Courier New', Courier, monospace;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ³ÙˆØ± */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.2em;
            vertical-align: middle;
            position: relative;
            top: -0.3em;
        }
        .numerator {
            font-size: 0.85em;
            line-height: 1;
        }
        .denominator {
            font-size: 0.85em;
            border-top: 2px solid currentColor;
            line-height: 1;
            padding-top: 2px;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ø­Ø¬Ù… Ù…Ø¶ØºÙˆØ· ÙˆØ£Ù†ÙŠÙ‚ */
        .choice-button {
            width: 100%;
            padding: 0.3rem 0.2rem;
            background-color: #ffffff;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .choice-button:hover:not(:disabled) {
            background-color: #f9fafb;
            border-color: #6b7280;
        }
        .choice-button.selected {
            border-color: #2563eb;
            background-color: #dbeafe;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .choice-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .choice-button.correct {
            border-color: #16a34a;
            background-color: #dcfce7;
        }
        .choice-button.incorrect {
            border-color: #dc2626;
            background-color: #fee2e2;
        }
        
        /* Ø§Ù„Ø´Ø¨ÙƒØ© */
        .choices-grid-3 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .choices-grid-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
        }
        
        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 320px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª - ØªØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù… */
        .level-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.5rem 0.2rem;
            border-radius: 0.5rem;
            border: 2px solid;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
            min-height: 5rem;
        }
        
        /* Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­ */
        .level-button.suggested {
            border-color: #f59e0b;
            background-color: #fffbeb;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
            animation: bounce-subtle 2s infinite;
        }
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        .level-button.locked {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .level-button.unlocked {
            background-color: #ffffff;
            border-color: #3b82f6;
            color: #1d4ed8;
            cursor: pointer;
        }
        .level-button.completed {
            background-color: #dcfce7;
            border-color: #16a34a;
            color: #166534;
            cursor: pointer;
        }
        
        /* Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f59e0b;
            color: white;
            font-size: 0.6rem;
            padding: 1px 6px;
            border-radius: 8px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .level-title { font-size: 0.85rem; font-weight: 700; margin-top: 0.2rem; }
        .level-score { font-size: 0.65rem; font-weight: 600; margin-top: 0.1rem; }
        .level-icon { font-size: 1.2rem; line-height: 1; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙÙ„ */
        .lock-icon {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1rem !important;
            height: 1rem !important;
            color: #6b7280;
            z-index: 5;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© */
        .replay-icon {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1rem !important;
            height: 1rem !important;
            color: #15803d;
            z-index: 5;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£) */
        #visitor-banner {
            background-color: #eff6ff; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
            border-bottom: 1px solid #bfdbfe;
            color: #1e40af;
            text-align: center;
            padding: 0.25rem;
            font-size: 0.7rem;
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        }
        
        #solution-content {
            max-height: 45vh;
            overflow-y: auto;
            padding-left: 0.5rem;
            margin-left: -0.5rem;
        }
        .leaderboard-scroll-container {
            max-height: 35vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        .equations-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 3.5rem;
            padding: 0.5rem;
        }
        @media (min-width: 400px) {
            .equations-box {
                flex-direction: row;
                gap: 0.75rem;
            }
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-dvh flex flex-col text-sm">

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø·Ø£) -->
    <div id="visitor-banner">
        â„¹ï¸ <strong>ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù„Ø¹Ø¨ ÙˆØªØ­Ø¯ÙŠ Ù†ÙØ³Ùƒ (Ø§Ù„Ø¯Ø±Ø¬Ø© Ù„Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ÙØµÙ„).
    </div>

    <div class="flex-grow flex items-center justify-center p-2">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
    <div id="welcome-modal" class="modal-overlay show" style="z-index: 80;">
        <div class="modal-content text-center">
            <h1 class="text-xl sm:text-2xl font-bold text-blue-700 mb-2">
                Ù„Ø¹Ø¨Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª
            </h1>
            <p id="welcomeMessage" class="text-sm text-gray-700 mb-3">
                Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø·Ù„!
            </p>
            <p class="text-xs text-gray-500 mb-4">
                Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†
            </p>
            <button id="show-levels-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-md transition duration-200 animate-pulse">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ ğŸš€
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ø§Ù„Ù…Ø­Ø³Ù†Ø©) -->
    <div id="level-select-modal" class="modal-overlay" style="z-index: 79;">
        <div class="modal-content" style="width: 280px;">
            
            <div class="flex items-center justify-between w-full mb-3 relative">
                <h3 class="text-lg font-bold text-blue-700 text-center w-full">
                    Ø®Ø§Ø±Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠ
                </h3>
                <button id="show-leaderboard-btn" title="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„" class="absolute left-0 top-1/2 -translate-y-1/2 w-7 h-7 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center font-bold text-xs transition hover:bg-yellow-200 border border-yellow-300">
                    ğŸ†
                </button>
           </div>
            
            <!-- ØªØµØºÙŠØ± Ø§Ù„ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
            <div id="levels-container" class="grid grid-cols-2 gap-2 mb-3"> 
                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
            </div>

            <!-- Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
            <button id="finish-game-main-btn" class="w-full hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md shadow-md transition duration-200 mt-1 flex items-center justify-center gap-2 text-xs">
                <span>âœ… Ø§Ù†ØªÙ‡ÙŠØª! Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©</span>
            </button>

            <div id="quote-container" class="mt-2 p-1 bg-gray-50 rounded text-center text-[10px] text-gray-500 italic h-8 flex items-center justify-center">
                <!-- Ø¹Ø¨Ø§Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ© -->
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø±Ø­ -->
    <div id="info-modal" class="modal-overlay" style="z-index: 60;"> 
        <div class="modal-content" style="width: 380px;"> 
            <h3 class="text-base font-bold text-blue-700 mb-2 text-center">Ø´Ø±Ø­ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©</h3>
            <p class="text-[10px] text-center text-gray-600 mb-2 px-1">ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹: Øµ = Ù… Ø³ + Ø¨</p>
            <div class="space-y-2 text-gray-700 text-xs text-right">
                <div class="border border-blue-200 bg-blue-50 p-2 rounded-md">
                    <p class="font-bold text-blue-600 text-xs">Ù¡. Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„ (Ø­Ù„ ÙˆØ­ÙŠØ¯):</p>
                    <p class="text-[10px]">Ø§Ù„Ù…ÙŠÙ„ Ù…Ø®ØªÙ„Ù (Ù…Ù¡ â‰  Ù…Ù¢). Ù…ØªÙ‚Ø§Ø·Ø¹Ø§Ù†.</p>
                </div>
                <div class="border border-red-200 bg-red-50 p-2 rounded-md">
                    <p class="font-bold text-red-600 text-xs">Ù¢. ØºÙŠØ± Ù…ØªØ³Ù‚ (Ù„Ø§ Ø­Ù„):</p>
                    <p class="text-[10px]">Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙ (Ù…Ù¡ = Ù…Ù¢)ØŒ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ø®ØªÙ„Ù. Ù…ØªÙˆØ§Ø²ÙŠØ§Ù†.</p>
                </div>
                <div class="border border-green-200 bg-green-50 p-2 rounded-md">
                    <p class="font-bold text-green-600 text-xs">Ù£. Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„ (Ù„Ø§Ù†Ù‡Ø§ÙŠØ©):</p>
                    <p class="text-[10px]">Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙØŒ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…ØªØ³Ø§ÙˆÙ. Ù…ØªØ·Ø§Ø¨Ù‚Ø§Ù†.</p>
                </div>
            </div>
            <button id="close-info-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-4 rounded-md text-xs">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
    </div>

    <!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© -->
    <div id="replay-confirm-modal" class="modal-overlay" style="z-index: 85;">
        <div class="modal-content text-center" style="width: 250px;">
            <h3 class="text-base font-bold text-yellow-700 mb-2">ØªÙ†Ø¨ÙŠÙ‡</h3>
            <p class="text-gray-700 mb-3 text-xs" id="replay-msg">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø³ØªØ­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
            </p>
            <div class="flex justify-center gap-2">
                <button id="confirm-replay-btn" class="bg-yellow-600 text-white font-bold py-1 px-4 rounded-md text-xs">Ù†Ø¹Ù…</button>
                <button id="cancel-replay-btn" class="bg-gray-400 text-white font-bold py-1 px-4 rounded-md text-xs">Ù„Ø§</button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="post-game-modal" class="modal-overlay" style="z-index: 84;">
        <div class="modal-content text-center" style="width: 260px;">
            <h3 class="text-lg font-bold text-green-600 mb-2">ğŸ‰ Ø£Ø­Ø³Ù†Øª! ğŸ‰</h3>
            <p class="text-gray-700 mb-4 text-xs">Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª!</p>
            <button id="show-result-btn" class="w-full bg-blue-600 text-white font-bold py-1.5 px-4 rounded-md mb-2 text-xs">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
            <button id="improve-score-btn" class="w-full bg-gray-600 text-white font-bold py-1.5 px-4 rounded-md text-xs">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        </div>
    </div>

    <!-- Ù†Ù‚Ø§Ø· -->
    <div id="score-modal" class="modal-overlay" style="z-index: 70;">
        <div class="modal-content text-center" style="width: 260px;">
            <h3 id="score-title" class="text-lg font-bold text-green-600 mb-1"></h3>
            <p id="points-earned-text" class="text-2xl font-bold text-blue-700 mb-2 equation-font"></p>
            <div class="border-t pt-2 mt-2 space-y-1 text-[10px] text-gray-600">
                <p id="current-question-text"></p>
                <p id="total-score-text"></p>
            </div>
            <button id="continue-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-1.5 px-4 rounded-md text-xs">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
    </div>

    <!-- Ø§Ù„Ø­Ù„ -->
    <div id="solution-modal" class="modal-overlay" style="z-index: 75;">
        <div class="modal-content text-right" style="width: 350px;">
            <h3 class="text-base font-bold text-blue-700 mb-2 text-center">Ø´Ø±Ø­ Ø§Ù„Ø­Ù„</h3>
            <div id="solution-content" class="space-y-2 text-gray-700 text-xs"></div>
            <button id="close-solution-btn" class="mt-3 w-full bg-blue-600 text-white font-bold py-1.5 px-4 rounded-md text-xs">ÙÙ‡Ù…Øª</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
    <div id="end-game-screen" class="container max-w-sm w-full mx-auto bg-white p-4 rounded-xl shadow-xl flex-col items-center justify-center text-center hidden">
        <h1 class="text-xl font-bold text-blue-700 mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
        <div id="final-result-display" class="my-2 p-2 bg-gray-100 rounded-md w-full text-xs"></div>
        <div id="leaderboard-loader" class="my-2 hidden"><p class="text-blue-500 text-xs">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        <div id="leaderboard-container" class="w-full text-xs"></div>
        <div id="finish-game-wrapper" class="mt-4 hidden w-full">
            <button id="finish-game-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md mb-2 w-full text-xs">Ø®Ø±ÙˆØ¬ (Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡)</button>
            <button id="back-to-levels-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md w-full text-xs">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>
        </div>
    </div>

    <!-- Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="game-container" class="container max-w-md w-full mx-auto bg-white p-3 rounded-xl shadow-xl flex-col hidden">
        <div class="flex-shrink-0 mb-2 p-2 bg-gray-50 rounded-md shadow-inner text-center">
            <div class="flex items-center justify-between gap-2 mb-1">
                 <button id="back-to-menu-btn" class="w-6 h-6 bg-red-100 text-red-700 rounded-full flex items-center justify-center font-bold text-xs hover:bg-red-200">âœ•</button>
                 <h2 id="question-text" class="text-xs font-semibold text-gray-800"></h2>
                 <button id="info-btn" class="w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-xs hover:bg-blue-200">â„¹ï¸</button>
            </div>
            <div class="equations-box">
                <span id="equation1" class="equation-font text-blue-600 bg-white px-2 py-1 rounded border border-blue-200 text-sm"></span>
                <span class="text-gray-500 font-bold text-xs mx-1">Ùˆ</span>
                <span id="equation2" class="equation-font text-purple-600 bg-white px-2 py-1 rounded border border-purple-200 text-sm"></span>
            </div>
        </div>
        <div class="flex-grow min-h-0 mb-2 px-1"> 
            <div id="options-container" class="choices-grid-3"></div>
        </div>
        <div class="flex-shrink-0 text-center">
            <div id="feedback" class="h-6 mb-1 text-xs font-bold"></div>
            <div class="flex justify-center gap-2">
                <button id="check-btn" class="bg-blue-600 text-white font-bold py-1.5 px-6 rounded-md shadow-md text-xs hover:bg-blue-700">ØªØ­Ù‚Ù‚</button>
                <button id="next-btn" class="bg-green-600 text-white font-bold py-1.5 px-6 rounded-md shadow-md hidden text-xs hover:bg-green-700">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="show-solution-btn" class="bg-yellow-500 text-white font-bold py-1.5 px-4 rounded-md shadow-md hidden text-xs hover:bg-yellow-600">Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                <button id="reset-choices-btn" class="bg-gray-400 text-white font-bold py-1.5 px-4 rounded-md shadow-md text-xs hover:bg-gray-500">Ù…Ø³Ø­</button>
            </div>
        </div>
    </div>

    </div> <!-- End flex-grow -->

    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <symbol id="icon-lock" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></symbol>
            <symbol id="icon-replay" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.755l-.091-.454A6.5 6.5 0 002.5 12.5a6.5 6.5 0 0011.603 4.475l.894.447A7.5 7.5 0 014.28 18.179a.75.75 0 011.04-1.082l.006.003a5.5 5.5 0 019.986-3.676l.091.454A6.5 6.5 0 0017.5 7.5a6.5 6.5 0 00-11.603-4.475l-.894-.447A7.5 7.5 0 0115.72 1.821a.75.75 0 01-1.04 1.082l-.006-.003a5.5 5.5 0 01-4.688 8.524l.003-.001.002.001z" clip-rule="evenodd" /></symbol>
            <symbol id="icon-check" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></symbol>
        </defs>
    </svg>

    <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ -->
    <script>
        const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        function toArabicNumerals(num) {
            if (num == null) return '';
            return String(num).replace(/\d/g, d => arabicNumerals[d]).replace('-', '\u200E-');
        }
        function formatEquation(equation, showOne = false) {
            let formatted = String(equation)
                .replace(/=\s*1x/g, '= x').replace(/\(\s*1x/g, '(x')
                .replace(/=\s*-1x/g, '= -x').replace(/\(\s*-1x/g, '(-x')
                .replace(/= -x/g, '= \u200E-Ø³')
                .replace(/\+\s*0$/, '').replace(/\-\s*0$/, '')
                .replace(/\((-?\d+)\/(\d+)\)/g, (m, n, d) => `<span class="fraction"><span class="numerator">${toArabicNumerals(n)}</span><span class="denominator">${toArabicNumerals(d)}</span></span>`)
                .replace(/-?\d+/g, m => m.includes('<') ? m : toArabicNumerals(m))
                .replace(/x/g, 'Ø³').replace(/y/g, 'Øµ')
                .replace(/ \+ /g, ' \u200E+\u200E ').replace(/ \- /g, ' \u200E-\u200E ');
            return formatted.trim();
        }
    </script>

    <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GAME_ID = 'g5_1_1';
            const APP_STORAGE_KEY = `linearGameProgress_${GAME_ID}`;
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            const hint_slope = "Ù„Ø§Ø­Ø¸ Ø§Ù„Ù…ÙŠÙ„ (Ù…). Ù‡Ù„ Ù‡Ùˆ Ù…ØªØ³Ø§ÙˆÙ Ø£Ù… Ù…Ø®ØªÙ„ÙØŸ";
            const hint_intercept = "Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙ. Ù…Ø§Ø°Ø§ Ø¹Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ (Ø¨)ØŸ";
            const questionBank = {
                easy: [
                    { eq1: "y = 2x + 1", m1: 2, b1: 1, eq2: "y = 2x - 3", m2: 2, b2: -3, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = -1x + 4", m1: -1, b1: 4, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = 1x + 5", m1: 1, b1: 5, eq2: "y = 1x + 5", m2: 1, b2: 5, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept }
                ],
                medium: [
                    { eq1: "y = 4x - 5", m1: 4, b1: -5, eq2: "3x + y = 2", eq2_simple: "y = -3x + 2", m2: -3, b2: 2, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -2x + 4", m1: -2, b1: 4, eq2: "2x + y = 1", eq2_simple: "y = -2x + 1", m2: -2, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = 1x + 3", m1: 1, b1: 3, eq2: "x - y = -3", eq2_simple: "y = 1x + 3", m2: 1, b2: 3, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept }
                ],
                hard: [
                    { eq1: "2x + y = 6", eq1_simple: "y = -2x + 6", m1: -2, b1: 6, eq2: "x + y = 4", eq2_simple: "y = -1x + 4", m2: -1, b2: 4, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y + 4 = -2(x - 1)", eq1_simple: "y = -2x - 2", m1: -2, b1: -2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "2y = 6x + 4", eq1_simple: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = 3x + 2", m2: 3, b2: 2, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept }
                ]
            };
            // ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            const extraQ = {
                 easy: [
                    { eq1: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -4x + 1", m1: -4, b1: 1, eq2: "y = -4x + 1", m2: -4, b2: 1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 1x - 3", m1: 1, b1: -3, eq2: "y = 1x + 4", m2: 1, b2: 4, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = 5x + 0", m1: 5, b1: 0, eq2: "y = -1x + 0", m2: -1, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = (1/2)x + 1", m1: 0.5, b1: 1, eq2: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = -2x + 7", m1: -2, b1: 7, eq2: "y = -2x + 7", m2: -2, b2: 7, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept }
                 ],
                 medium: [
                    { eq1: "x + y = 5", eq1_simple: "y = -1x + 5", m1: -1, b1: 5, eq2: "y = -1x + 2", m2: -1, b2: 2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "2x - y = 1", eq1_simple: "y = 2x - 1", m1: 2, b1: -1, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "6x + 2y = 8", eq1_simple: "y = -3x + 4", m1: -3, b1: 4, eq2: "y = -3x + 4", m2: -3, b2: 4, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 5x - 1", m1: 5, b1: -1, eq2: "10x - 2y = 2", eq2_simple: "y = 5x - 1", m2: 5, b2: -1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 1x - 6", m1: 1, b1: -6, eq2: "4x + y = 9", eq2_simple: "y = -4x + 9", m2: -4, b2: 9, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -1x + 7", m1: -1, b1: 7, eq2: "3x + 3y = 1", eq2_simple: "y = -1x + (1/3)", m2: -1, b2: 1/3, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept }
                 ],
                 hard: [
                    { eq1: "x - 3y = 6", eq1_simple: "y = (1/3)x - 2", m1: 1/3, b1: -2, eq2: "y = (1/3)x + 1", m2: 1/3, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y - 2 = 3(x - 1)", eq1_simple: "y = 3x - 1", m1: 3, b1: -1, eq2: "y + 1 = 3(x + 1)", eq2_simple: "y = 3x + 2", m2: 3, b2: 2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "x + 2y = 4", eq1_simple: "y = (-1/2)x + 2", m1: -0.5, b1: 2, eq2: "3x - y = 5", eq2_simple: "y = 3x - 5", m2: 3, b2: -5, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "4x - 2y = 8", eq1_simple: "y = 2x - 4", m1: 2, b1: -4, eq2: "y = 2x - 4", m2: 2, b2: -4, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y - 5 = 2(x - 1)", eq1_simple: "y = 2x + 3", m1: 2, b1: 3, eq2: "y - 1 = -1(x - 4)", eq2_simple: "y = -1x + 5", m2: -1, b2: 5, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = (1/2)x - 1", m1: 0.5, b1: -1, eq2: "2x - 4y = 4", eq2_simple: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "3x + 3y = 9", eq1_simple: "y = -1x + 3", m1: -1, b1: 3, eq2: "x + y = 3", eq2_simple: "y = -1x + 3", m2: -1, b2: 3, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = (2/3)x + 1", m1: 2/3, b1: 1, eq2: "3y = 2x - 6", eq2_simple: "y = (2/3)x - 2", m2: 2/3, b2: -2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "5x - y = 0", eq1_simple: "y = 5x + 0", m1: 5, b1: 0, eq2: "x + y = 6", eq2_simple: "y = -1x + 6", m2: -1, b2: 6, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope }
                 ]
            };
            questionBank.easy.push(...extraQ.easy);
            questionBank.medium.push(...extraQ.medium);
            questionBank.hard.push(...extraQ.hard);

            const gameChoices = ["Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", "ØºÙŠØ± Ù…ØªØ³Ù‚"];
            const motivationalQuotes = ["Ø£Ù†Øª Ø¨Ø·Ù„!", "Ø§Ø³ØªÙ…Ø±!", "Ø±Ø§Ø¦Ø¹!", "Ù…Ù…ØªØ§Ø²!", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ØªØ¹Ø©!"];

            const defaultProgress = {
                easy: { score: -1, total: 30, questions: 3, unlocked: true },
                medium: { score: -1, total: 30, questions: 3, unlocked: false },
                hard: { score: -1, total: 40, questions: 4, unlocked: false }
            };
            let playerProgress = { ...defaultProgress };
            let currentLevelName = 'easy', currentLevelQuestions = [], currentQuestionIndex = 0, currentLevelScore = 0, lastPointsEarned = 0, isSecondTry = false, totalGameErrors = 0;

            // Elements
            const els = {
                welcomeModal: document.getElementById('welcome-modal'),
                showLevelsBtn: document.getElementById('show-levels-btn'),
                levelSelectModal: document.getElementById('level-select-modal'),
                levelsContainer: document.getElementById('levels-container'),
                finishGameMainBtn: document.getElementById('finish-game-main-btn'),
                quoteContainer: document.getElementById('quote-container'),
                gameContainer: document.getElementById('game-container'),
                endGameScreen: document.getElementById('end-game-screen'),
                scoreModal: document.getElementById('score-modal'),
                replayModal: document.getElementById('replay-confirm-modal'),
                postGameModal: document.getElementById('post-game-modal'),
                solutionModal: document.getElementById('solution-modal'),
                infoModal: document.getElementById('info-modal'),
                pointsText: document.getElementById('points-earned-text'),
                scoreTitle: document.getElementById('score-title'),
                finalResult: document.getElementById('final-result-display')
            };

            function loadProgress() {
                const saved = localStorage.getItem(APP_STORAGE_KEY);
                if (saved) playerProgress = JSON.parse(saved);
                else saveProgress();
            }
            function saveProgress() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(playerProgress)); }
            
            function showModal(m) { if(m) m.classList.add('show'); }
            function hideModal(m) { if(m) m.classList.remove('show'); }
            function hideAll() {
                document.querySelectorAll('.modal-overlay').forEach(hideModal);
                els.gameContainer.classList.add('hidden');
                els.endGameScreen.classList.add('hidden');
                els.endGameScreen.classList.remove('flex');
                els.gameContainer.classList.remove('flex');
            }

            // Logic to determine which level is "Next"
            function getNextActionableLevel() {
                if (playerProgress.easy.score === -1) return 'easy';
                if (playerProgress.medium.score === -1) return 'medium';
                if (playerProgress.hard.score === -1) return 'hard';
                return null; // All done
            }

            function renderLevelButtons() {
                els.levelsContainer.innerHTML = '';
                const nextLevel = getNextActionableLevel();
                const allDone = (nextLevel === null);

                const levels = [
                    { id: 'easy', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„', icon: 'ğŸ™‚' },
                    { id: 'medium', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·', icon: 'ğŸ¤”' },
                    { id: 'hard', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨', icon: 'ğŸ§ ' }
                ];

                levels.forEach(lvl => {
                    const prog = playerProgress[lvl.id];
                    const btn = document.createElement('button');
                    btn.className = 'level-button';
                    
                    let statusHTML = '';
                    let scoreText = 'Ù…Ù‚ÙÙ„';
                    let iconHTML = '<svg class="lock-icon"><use href="#icon-lock"></use></svg>';

                    if (prog.unlocked) {
                        if (prog.score > -1) {
                            btn.classList.add('completed');
                            scoreText = `Ø§Ù„Ø¯Ø±Ø¬Ø©: ${toArabicNumerals(prog.score)} / ${toArabicNumerals(prog.total)}`;
                            iconHTML = `<svg class="replay-icon text-green-700 opacity-100"><use href="#icon-check"></use></svg>`;
                            statusHTML = '<span class="status-badge bg-green-500">Ù…ÙƒØªÙ…Ù„</span>';
                            btn.onclick = () => confirmReplay(lvl.id);
                        } else {
                            btn.classList.add('unlocked');
                            scoreText = 'Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡';
                            iconHTML = '';
                            btn.onclick = () => startLevel(lvl.id);
                            
                            // Highlight if it's the next suggested level
                            if (lvl.id === nextLevel) {
                                btn.classList.add('suggested');
                                statusHTML = '<span class="status-badge animate-pulse">Ø§Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†</span>';
                            }
                        }
                    } else {
                        btn.classList.add('locked');
                        btn.disabled = true;
                    }

                    btn.innerHTML = `
                        ${statusHTML}
                        ${iconHTML}
                        <span class="level-icon">${lvl.icon}</span>
                        <span class="level-title">${lvl.name}</span>
                        <span class="level-score">${scoreText}</span>
                    `;
                    els.levelsContainer.appendChild(btn);
                });

                // Show Finish button if all done
                if (allDone) {
                    els.finishGameMainBtn.classList.remove('hidden');
                    els.finishGameMainBtn.onclick = handleGameEnd;
                } else {
                    els.finishGameMainBtn.classList.add('hidden');
                }
                
                const q = motivationalQuotes[Math.floor(Math.random()*motivationalQuotes.length)];
                els.quoteContainer.innerText = q;
            }

            function confirmReplay(lvlId) {
                document.getElementById('replay-msg').innerText = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŸ Ø³ØªÙØ­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.';
                showModal(els.replayModal);
                
                const yesBtn = document.getElementById('confirm-replay-btn');
                // Remove old listeners to prevent stacking
                const newYes = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYes, yesBtn);
                
                newYes.addEventListener('click', () => {
                    hideModal(els.replayModal);
                    startLevel(lvlId);
                });
            }

            // Game Logic
            function startLevel(lvl) {
                currentLevelName = lvl;
                // Shuffle questions
                const bank = [...questionBank[lvl]];
                for(let i=bank.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [bank[i], bank[j]]=[bank[j], bank[i]]; }
                currentLevelQuestions = bank.slice(0, playerProgress[lvl].questions);
                currentQuestionIndex = 0;
                currentLevelScore = 0;
                isSecondTry = false;
                hideAll();
                els.gameContainer.classList.remove('hidden');
                els.gameContainer.classList.add('flex');
                loadQuestion();
            }

            function loadQuestion() {
                const q = currentLevelQuestions[currentQuestionIndex];
                document.getElementById('feedback').innerText = '';
                document.getElementById('feedback').className = 'h-6 mb-1 text-xs font-bold';
                document.getElementById('question-text').innerText = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${currentLevelName=='easy'?'Ø§Ù„Ø³Ù‡Ù„':currentLevelName=='medium'?'Ø§Ù„Ù…ØªÙˆØ³Ø·':'Ø§Ù„ØµØ¹Ø¨'} (${toArabicNumerals(currentQuestionIndex+1)}/${toArabicNumerals(currentLevelQuestions.length)})`;
                
                document.getElementById('equation1').innerHTML = formatEquation(q.eq1);
                document.getElementById('equation2').innerHTML = formatEquation(q.eq2);

                const opts = document.getElementById('options-container');
                opts.innerHTML = '';
                const choices = [...gameChoices];
                for(let i=choices.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [choices[i], choices[j]]=[choices[j], choices[i]]; }
                
                choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-button hover:border-blue-500';
                    btn.innerText = c;
                    btn.dataset.val = c;
                    btn.onclick = () => {
                        opts.querySelectorAll('.choice-button').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                    };
                    opts.appendChild(btn);
                });

                document.getElementById('check-btn').classList.remove('hidden');
                document.getElementById('reset-choices-btn').classList.remove('hidden');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('show-solution-btn').classList.add('hidden');
            }

            document.getElementById('check-btn').onclick = () => {
                const sel = document.querySelector('.choice-button.selected');
                if(!sel) {
                    document.getElementById('feedback').innerText = 'Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹';
                    document.getElementById('feedback').className = 'h-6 mb-1 text-xs font-bold text-red-600';
                    return;
                }
                const q = currentLevelQuestions[currentQuestionIndex];
                const isCorrect = (sel.dataset.val === q.answer);

                if(isCorrect) {
                    sel.classList.add('correct');
                    const pts = isSecondTry ? 5 : 10;
                    currentLevelScore += pts;
                    lastPointsEarned = pts;
                    document.getElementById('feedback').innerText = `Ù…Ù…ØªØ§Ø²! +${toArabicNumerals(pts)} Ù†Ù‚Ø§Ø·`;
                    document.getElementById('feedback').className = 'h-6 mb-1 text-xs font-bold text-green-600';
                    endQuestionState();
                } else {
                    sel.classList.add('incorrect');
                    if(isSecondTry) {
                        totalGameErrors++;
                        document.getElementById('feedback').innerText = 'Ø®Ø·Ø£. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…ÙˆØ¶Ø­Ø©.';
                        document.getElementById('feedback').className = 'h-6 mb-1 text-xs font-bold text-red-600';
                        lastPointsEarned = 0;
                        // Reveal correct
                        document.querySelectorAll('.choice-button').forEach(b => { if(b.dataset.val === q.answer) b.classList.add('correct'); });
                        endQuestionState();
                    } else {
                        isSecondTry = true;
                        document.getElementById('feedback').innerText = `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. ØªÙ„Ù…ÙŠØ­: ${q.hint}`;
                        document.getElementById('feedback').className = 'h-6 mb-1 text-xs font-bold text-yellow-600';
                        sel.disabled = true;
                        sel.classList.remove('selected');
                        document.getElementById('reset-choices-btn').classList.add('hidden');
                    }
                }
            };

            function endQuestionState() {
                document.getElementById('check-btn').classList.add('hidden');
                document.getElementById('reset-choices-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('show-solution-btn').classList.remove('hidden');
                document.querySelectorAll('.choice-button').forEach(b => b.disabled = true);
            }

            document.getElementById('next-btn').onclick = () => {
                // Show Score Modal
                const pts = lastPointsEarned;
                els.scoreTitle.innerText = pts > 0 ? (pts==10?'Ù…Ù…ØªØ§Ø²!':'Ø£Ø­Ø³Ù†Øª!') : 'Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ±';
                els.scoreTitle.className = `text-lg font-bold mb-1 ${pts>0?'text-green-600':'text-red-600'}`;
                els.pointsText.innerText = `+${toArabicNumerals(pts)} Ù†Ù‚Ø§Ø·`;
                document.getElementById('total-score-text').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${toArabicNumerals(currentLevelScore)}`;
                document.getElementById('current-question-text').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${toArabicNumerals(currentQuestionIndex+1)}`;
                showModal(els.scoreModal);
            };

            document.getElementById('continue-btn').onclick = () => {
                hideModal(els.scoreModal);
                currentQuestionIndex++;
                if(currentQuestionIndex < currentLevelQuestions.length) {
                    loadQuestion();
                } else {
                    finishLevel();
                }
            };

            function finishLevel() {
                playerProgress[currentLevelName].score = currentLevelScore;
                // Unlock logic
                if(currentLevelName === 'easy') playerProgress.medium.unlocked = true;
                if(currentLevelName === 'medium') playerProgress.hard.unlocked = true;
                saveProgress();

                // If Hard done for first time, show special modal
                if(currentLevelName === 'hard') {
                    hideAll();
                    showModal(els.postGameModal);
                } else {
                    hideAll();
                    showModal(els.levelSelectModal);
                    renderLevelButtons();
                }
            }

            function handleGameEnd() {
                hideAll();
                els.endGameScreen.classList.remove('hidden');
                els.endGameScreen.classList.add('flex');
                
                const totalScore = playerProgress.easy.score + playerProgress.medium.score + playerProgress.hard.score;
                // Call the internal saveData function directly
                saveData(totalScore, totalGameErrors);
            }

            // Listeners
            els.showLevelsBtn.onclick = () => { hideAll(); showModal(els.levelSelectModal); renderLevelButtons(); };
            document.getElementById('show-leaderboard-btn').onclick = () => { hideAll(); els.endGameScreen.classList.remove('hidden'); els.endGameScreen.classList.add('flex'); fetchLeaderboard(); };
            document.getElementById('show-result-btn').onclick = handleGameEnd;
            document.getElementById('improve-score-btn').onclick = () => { hideAll(); showModal(els.levelSelectModal); renderLevelButtons(); };
            document.getElementById('back-to-levels-btn').onclick = () => { hideAll(); showModal(els.levelSelectModal); renderLevelButtons(); };
            document.getElementById('back-to-menu-btn').onclick = () => {
                document.getElementById('replay-msg').innerText = 'Ø§Ù„Ø®Ø±ÙˆØ¬ Ø³ÙŠÙ„ØºÙŠ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ';
                showModal(els.replayModal);
                // Setup exit listener
                const yesBtn = document.getElementById('confirm-replay-btn');
                const newYes = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYes, yesBtn);
                newYes.onclick = () => { hideAll(); showModal(els.levelSelectModal); renderLevelButtons(); };
            };
            document.getElementById('cancel-replay-btn').onclick = () => hideModal(els.replayModal);
            
            // Show Solution Logic (Simplified for brevity as it's just text logic)
            document.getElementById('show-solution-btn').onclick = () => {
                const q = currentLevelQuestions[currentQuestionIndex];
                document.getElementById('solution-content').innerHTML = `
                    <div class="p-2 bg-blue-50 rounded mb-2">Ù…Ù¡=${q.m1}, Ø¨Ù¡=${q.b1}</div>
                    <div class="p-2 bg-purple-50 rounded mb-2">Ù…Ù¢=${q.m2}, Ø¨Ù¢=${q.b2}</div>
                    <p class="font-bold">${q.answer}</p>
                `;
                showModal(els.solutionModal);
            };
            document.getElementById('close-solution-btn').onclick = () => hideModal(els.solutionModal);
            document.getElementById('info-btn').onclick = () => showModal(els.infoModal);
            document.getElementById('close-info-btn').onclick = () => hideModal(els.infoModal);
            document.getElementById('reset-choices-btn').onclick = () => {
                document.querySelectorAll('.choice-button').forEach(b => { b.classList.remove('selected'); b.disabled = false; });
                document.getElementById('feedback').innerText = '';
                isSecondTry = false;
            };

            // --- Backend Logic Merged Here ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const MAX_PTS = 100;
            const PLATFORM_GRADE = 5;

            // URL Params
            const urlParams = new URLSearchParams(window.location.search);
            let sId = urlParams.get('studentId');
            let cId = urlParams.get('classId');
            let sName = urlParams.get('studentName');

            // *** FIX FOR SAVING ***
            // If IDs are missing, create a "Demo" session so the teacher sees it working
            const isDemo = !sId || !cId;
            if(isDemo) {
                // FIXED: Checked if element exists to prevent crash
                const banner = document.getElementById('visitor-banner');
                if (banner) banner.style.display = 'block';
                // Use dummy data for testing logic, but label it
                sId = "TEST_TEACHER";
                cId = "TEST_CLASS";
                sName = sName || "Ø²Ø§Ø¦Ø±"; // Changed default name to Visitor
            }

            if(sName) document.getElementById('welcomeMessage').innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ <span class="text-blue-600 font-bold">${sName}</span>!`;

            function saveData(score, errors) {
                const final = parseFloat(score)||0;
                const grade = (final/MAX_PTS)*PLATFORM_GRADE;
                
                const disp = document.getElementById('final-result-display');
                disp.innerHTML = `
                    <p>Ø§Ù„Ù†Ù‚Ø§Ø·: <b>${Math.round(final)}</b> / ${MAX_PTS}</p>
                    <p class="text-blue-600 text-xl">Ø§Ù„Ø¯Ø±Ø¬Ø©: <b>${grade.toFixed(1)}</b> / 5</p>
                    <p class="text-red-500 text-xs">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${errors}</p>
                    ${isDemo ? '<p class="text-[10px] text-orange-600 mt-2">* ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±: Ø§Ù„Ø¯Ø±Ø¬Ø© Ù„Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.</p>' : ''}
                `;

                if(isDemo) {
                    // Mock save for demo
                    console.log("Demo Save:", score);
                    fetchLeaderboard();
                    return;
                }

                // Real Save
                fetch(`${SCRIPT_URL}?action=saveGrade&studentId=${sId}&classId=${cId}&itemId=${GAME_ID}&grade=${grade.toFixed(2)}&metricValue=${errors}`)
                .then(r=>r.json())
                .then(() => fetchLeaderboard())
                .catch(e => console.error(e));
            };

            function fetchLeaderboard() {
                const container = document.getElementById('leaderboard-container');
                const loader = document.getElementById('leaderboard-loader');
                
                loader.style.display = 'block';
                container.innerHTML = '';

                // If demo, skip fetching real data or fetch dummy
                if(isDemo) {
                    loader.style.display = 'none';
                    // Now playerProgress IS visible here because we are in the same scope
                    const totalScore = (playerProgress.easy.score > -1 ? playerProgress.easy.score : 0) +
                                       (playerProgress.medium.score > -1 ? playerProgress.medium.score : 0) +
                                       (playerProgress.hard.score > -1 ? playerProgress.hard.score : 0);
                    
                    container.innerHTML = `
                        <div class="mt-2 border p-2 rounded bg-gray-50">
                            <h4 class="font-bold mb-1 text-xs">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</h4>
                            <table class="w-full text-xs text-right">
                                <tr class="bg-gray-200"><th>Ø§Ù„ØªØ±ØªÙŠØ¨</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>
                                <tr><td>ğŸ¥‡</td><td>${sName}</td><td>${(totalScore/100*5).toFixed(1)}</td></tr>
                                <tr><td>ğŸ¥ˆ</td><td>Ø·Ø§Ù„Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ</td><td>4.5</td></tr>
                            </table>
                            <p class="text-[10px] text-gray-500 mt-1">Ù‡Ø°Ø§ Ø³Ø¬Ù„ ÙˆÙ‡Ù…ÙŠ Ù„Ø£Ù†Ùƒ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±.</p>
                        </div>
                        <button onclick="location.reload()" class="mt-2 bg-gray-500 text-white py-1 px-4 rounded w-full text-xs">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
                    `;
                    return;
                }

                fetch(`${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${cId}&metricType=errors`)
                .then(r=>r.json())
                .then(res => {
                    if(res.status === 'success') renderTable(res.data);
                    else container.innerHTML = '<p class="text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
                })
                .catch(() => container.innerHTML = '<p class="text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.</p>')
                .finally(() => loader.style.display = 'none');
            };

            function renderTable(data) {
                let html = `
                <div class="mt-2 overflow-hidden rounded-lg shadow border">
                <table class="w-full text-xs bg-white">
                    <thead class="bg-gray-800 text-white">
                        <tr><th class="p-1">#</th><th class="p-1 text-right">Ø§Ù„Ø§Ø³Ù…</th><th class="p-1">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>
                    </thead>
                    <tbody>`;
                data.forEach((p, i) => {
                    const rank = i+1;
                    const medal = rank===1?'ğŸ¥‡':rank===2?'ğŸ¥ˆ':rank===3?'ğŸ¥‰':rank;
                    const isMe = p.name === sName;
                    html += `<tr class="${isMe?'bg-blue-100 font-bold':(i%2?'bg-gray-50':'')} border-b">
                        <td class="p-1">${medal}</td>
                        <td class="p-1 text-right">${p.name}</td>
                        <td class="p-1">${p.grade}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>
                <button onclick="location.reload()" class="mt-2 bg-gray-500 text-white py-1 px-4 rounded w-full text-xs">Ø§Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹</button>`;
                document.getElementById('leaderboard-container').innerHTML = html;
            }

            loadProgress();
            showModal(els.welcomeModal);
        });
    </script>
</body>
</html>

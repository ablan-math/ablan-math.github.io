<!-- 
    ๐๐ ููุทูุฉ ูุญุธูุฑุฉ ูููุทูุฑูู ูุงูุฐูุงุก ุงูุงุตุทูุงุนู (STRICT PROTOCOL) ๐๐
    =========================================================================
    ุจุฑูุชูููู ุงูุชุนุงูู ูุน ูุฐุง ุงููุงูุจ (Master Template V2):

    1. ุงูุซูุงุจุช ุงูููุฏุณุฉ (Do Not Touch):
       - ููููุน ููุนุงู ุจุงุชุงู ุชุนุฏูู ุฃู ุญุฐู ุฏูุงู ุงูุงุชุตุงู (fetchStudentData, saveScoreToBackend).
       - ููููุน ุชุนุฏูู "ูุญุฑู ุงููููุฉ" (Theme Engine) ุฃู ูุงููุณ ุงูุฃููุงู (CHAPTER_THEMES).
       - ููููุน ุชุบููุฑ ููุทู "ุฌูุจ ุงูุฃูุนุงุจ" (renderDynamicGames).
       - โ๏ธ ููููุน ุงููุณุงุณ ุจููุทู "ุฒุฑ ุงูุชุญูู" (Quiz Button Logic).
       - โ๏ธ ููููุน ุญุฐู ุฃู ุฅุฎูุงุก "ุงููุคูุช ุงูุนููู ู ุงูุณููู".
       - โ๏ธ ููููุน ุชุบููุฑ ูููููุฉ "ุฃุฒุฑุงุฑ ุงูุชูุฌูู ุงูุซูุงุซุฉ" (ููุงุฐุงุ - ุงูุญู ุงูุฐูู - ูุฑุงุฌุนุฉ ุงูุฏุฑุณ).

    2. ูุฑููุฉ ุงูููุงููู (Concept Flexibility):
       - ุงููุงูุจ ูุญุชูู ุงูุชุฑุงุถูุงู ุนูู 4 ููุงููู (Tabs).

    3. ุงูุชุฎุตูุต ุงููุณููุญ (Allowed Edits):
       - ุชุบููุฑ ูููุฉ LESSON_KEY ูู ุงูู <head>.
       - ุชุบููุฑ ุงููุตูุต ุงูุนุฑุจูุฉ ูู ุจูู ุงูุฃุณุฆูุฉ (questionBank).
       - ุชุบููุฑ ุงููุญุชูู ุงููุงุฏู ุฏุงุฎู ุงูุชุจููุจุงุช.
    =========================================================================
-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ุถุฑุจ ูุญูุฏุงุช ุงูุญุฏ</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- [THEME DICTIONARY] -->
    <script>
        const LESSON_KEY = 'c6_l5'; 
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ"[d]); }

        const CHAPTER_THEMES = {
            '6': { name: 'ูุซูุฑุงุช ุงูุญุฏูุฏ', gradient: 'from-blue-600 to-blue-800', baseColor: 'blue', hex: '#2563eb', icon: 'fa-graduation-cap' },
            '7': { name: 'ุงูุชุญููู ูุงููุนุงุฏูุงุช ุงูุชุฑุจูุนูุฉ', gradient: 'from-purple-600 to-purple-800', baseColor: 'purple', hex: '#9333ea', icon: 'fa-puzzle-piece' },
            'default': { gradient: 'from-gray-700 to-gray-900', baseColor: 'gray', hex: '#374151', icon: 'fa-book' }
        };

        function getTheme() {
            const match = LESSON_KEY.match(/c(\d+)/);
            const chNum = match ? match[1] : 'default';
            const theme = CHAPTER_THEMES[chNum] || CHAPTER_THEMES['default'];
            theme.chNum = chNum === 'default' ? '#' : chNum;
            return theme;
        }
        const currentTheme = getTheme();
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        :root { --theme-hex: #374151; }

        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .var-blue { color: #2563eb; } .op-purple { color: #9333ea; font-weight: 800; } 
        .tiny-sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.6em; margin-right: 1px; line-height: 0; font-family: 'Cairo', sans-serif; }
        
        .btn-theme { background-color: var(--theme-hex); color: white; transition: all 0.3s ease; }
        .btn-theme:hover { filter: brightness(0.85); transform: translateY(-1px); }

        .step-box { border-right: 3px solid var(--theme-hex); background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item.active { color: var(--theme-hex); font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: var(--theme-hex); border-radius: 4px 4px 0 0; }
        
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } 
        .step-interactive.active { display: block; opacity: 1; }
        
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; text-align: center; }
        input[type="radio"]:checked + .option-label { border-color: var(--theme-hex); background-color: #eff6ff; color: var(--theme-hex); font-weight: bold; }

        #game-modal-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #game-modal-content { background: white; width: 90%; height: 85%; max-width: 1200px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        #game-frame { flex-grow: 1; width: 100%; height: 100%; border: none; }
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 80px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <script>
        (function() {
            const root = document.documentElement;
            root.style.setProperty('--theme-hex', currentTheme.hex);
        })();
    </script>

    <!-- HEADER (Sacred UI) -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative">
        <script>document.getElementById('main-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <i id="bg-giant-icon" class="fas absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <script>document.getElementById('bg-giant-icon').classList.add(currentTheme.icon);</script>
            <span class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">
                <script>document.write(currentTheme.chNum)</script>
            </span>
            <i class="fas fa-plus absolute top-4 left-[20%] text-xl text-white opacity-10 transform rotate-12"></i>
            <i class="fas fa-minus absolute bottom-4 right-[30%] text-2xl text-white opacity-10 transform -rotate-6"></i>
            <i class="fas fa-times absolute top-8 right-12 text-lg text-white opacity-10"></i>
            <i class="fas fa-divide absolute bottom-6 left-8 text-xl text-white opacity-10 transform rotate-45"></i>
        </div>
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas text-lg md:text-2xl"></i>
                    <script>document.getElementById('header-icon').classList.add(currentTheme.icon);</script>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">ููุตุฉ ุงูุฑูุงุถูุงุช ุงูุชูุงุนููุฉ</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">
                            <script>document.write(convertToArabic('6-5'));</script>
                        </span>
                        <span id="lesson-title-text">ุถุฑุจ ูุญูุฏุงุช ุงูุญุฏ</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> 
                    <span id="student-name">
                        <script>
                            (function(){
                                const p = new URLSearchParams(window.location.search);
                                const n = p.get('name');
                                if(n) document.write(n); else document.write('ูุฑุญุจุง ุจู');
                            })();
                        </script>
                    </span>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>ุฑุฌูุน</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- [TAB 1: Concept 1] -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg bg-blue-100 text-blue-700 border border-blue-200">ูก</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ุถุฑุจ ูุญูุฏุฉ ุญุฏ ูู ูุซูุฑุฉ ุญุฏูุฏ</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition border-r-4 border-blue-500">
                <p class="text-gray-600 text-sm md:text-lg mb-3">ูุถุฑุจ ูุญูุฏุฉ ุญุฏ ูู ูุซูุฑุฉ ุญุฏูุฏุ ูุณุชุฎุฏู **ุฎุงุตูุฉ ุงูุชูุฒูุน**ุ ูุถุฑุจ ูุญูุฏุฉ ุงูุญุฏ ูู ูู ุญุฏ ูู ุญุฏูุฏ ูุซูุฑุฉ ุงูุญุฏูุฏ.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 border border-blue-100 shadow-inner">
                    <span class="math-eq text-xl"><span class="num-red">ุฃ</span> ( <span class="var-green">ุจ</span> + <span class="var-blue">ุฌู</span> ) = <span class="num-red">ุฃ</span><span class="var-green">ุจ</span> + <span class="num-red">ุฃ</span><span class="var-blue">ุฌู</span></span>
                </div>
            </div>

            <!-- ุชุทุจูู 1 -->
            <div id="interactive-container-1-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <h3 class="font-bold text-blue-800 mb-4">ูุซุงู ูก: ูุญูุฏุฉ ุญุฏ ููุฌุจุฉ</h3>
                <div class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 mb-4 text-center">
                    <span class="math-eq text-xl"><span class="num-red">ูฃุณ</span> ( <span class="var-green">ูขุณ</span> + <span class="var-blue">ูฅ</span> )</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6">ุงุถุบุท "ุงูุชุงูู" ููุดุงูุฏุฉ ุงูุฎุทูุงุช</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4>
                        <p class="text-center"><span class="math-eq">(<span class="num-red">ูฃุณ</span> ร <span class="var-green">ูขุณ</span>) + (<span class="num-red">ูฃุณ</span> ร <span class="var-blue">ูฅ</span>)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุงููุงุชุฌ ุงูููุงุฆู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ูฆุณ<span class="tiny-sup">ูข</span> + ูกูฅุณ</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">ุฅุนุงุฏุฉ</button>
                </div>
            </div>

            <!-- ุชุทุจูู 2 -->
            <div id="interactive-container-1-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <h3 class="font-bold text-red-800 mb-4">ูุซุงู ูข: ูุญูุฏุฉ ุญุฏ ุณุงูุจุฉ</h3>
                <div class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 mb-4 text-center">
                    <span class="math-eq text-xl"><span class="num-red">-ูคุฃ</span> ( <span class="var-green">ูฃุฃ<span class="tiny-sup">ูข</span></span> - <span class="var-blue">ูง</span> )</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ุชูุฒูุน ุงูุณุงูุจ</h4>
                        <p class="text-center"><span class="math-eq">(<span class="num-red">-ูคุฃ</span> ร <span class="var-green">ูฃุฃ<span class="tiny-sup">ูข</span></span>) - (<span class="num-red">-ูคุฃ</span> ร <span class="var-blue">ูง</span>)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุงููุงุชุฌ ุงูููุงุฆู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">-ูกูขุฃ<span class="tiny-sup">ูฃ</span> + ูขูจุฃ</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                </div>
            </div>

            <button onclick="switchTab('learn2')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>ุงูุชุงูู: ุชุจุณูุท ุงูุนุจุงุฑุงุช</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 2: Simplifying] -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg bg-purple-100 text-purple-700 border border-purple-200">ูข</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ุชุจุณูุท ุงูุนุจุงุฑุงุช ุงูุฌุจุฑูุฉ</h2>
            </div>
            
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden border-r-4 border-purple-500">
                <div class="absolute top-0 right-0 w-1 h-full bg-purple-500"></div>
                <div class="bg-purple-50 border border-purple-100 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-purple-800 mb-1">ุงููุงุนุฏุฉ:</h4>
                    <p class="text-gray-700 leading-relaxed">ุชุนุชูุฏ ุนูููุฉ ุงูุชุจุณูุท ุนูู **ุชูุฒูุน ุงูุถุฑุจ ุนูู ุงูุฌูุน ูุงูุทุฑุญ** ููุชุฎูุต ูู ุงูุฃููุงุณุ ุซู **ุฏูุฌ ูุญูุฏุงุช ุงูุญุฏ ุงููุชุดุงุจูุฉ**.</p>
                </div>
            </div>

            <!-- ุชุทุจูู 1 -->
            <div id="interactive-container-2-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-4">
                <h3 class="font-bold text-purple-800 mb-4">ูุซุงู ูก: ุฏูุฌ ุงูุญุฏูุฏ ุงููุชุดุงุจูุฉ</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                    <span class="math-eq text-lg">ูฃ(ุณ + ูค) + ูข(ุณ - ูก)</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ูู ุงูุฃููุงุณ (ุชูุฒูุน)</h4>
                        <p class="text-center"><span class="math-eq"><span class="var-green">ูฃุณ</span> + <span class="var-blue">ูกูข</span> + <span class="var-green">ูขุณ</span> - <span class="var-blue">ูข</span></span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูข: ุฏูุฌ ุงููุชุดุงุจูุงุช</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq"><span class="var-green">ูฅุณ</span> + <span class="var-blue">ูกู</span></span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                </div>
            </div>

            <!-- ุชุทุจูู 2 -->
            <div id="interactive-container-2-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-4">
                <h3 class="font-bold text-purple-800 mb-4">ูุซุงู ูข: ุงูุชุจุณูุท ูุน ุงูุฃุณุณ</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                    <span class="math-eq text-lg">ูขุณ(ุณ + ูฃ) + ุณ<span class="tiny-sup">ูข</span></span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4>
                        <p class="text-center"><span class="math-eq"><span class="var-green">ูขุณ<span class="tiny-sup">ูข</span></span> + ูฆุณ + <span class="var-green">ุณ<span class="tiny-sup">ูข</span></span></span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูข: ุฏูุฌ ุงููุชุดุงุจูุงุช</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq"><span class="var-green">ูฃุณ<span class="tiny-sup">ูข</span></span> + ูฆุณ</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                </div>
            </div>

            <button onclick="switchTab('learn3')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>ุงูุชุงูู: ุญู ุงููุนุงุฏูุงุช</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 3: Equations] -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg bg-emerald-100 text-emerald-700 border border-emerald-200">ูฃ</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ุญู ุงููุนุงุฏูุงุช ุงูุฌุจุฑูุฉ</h2>
            </div>
            
            <div id="interactive-container-3-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-emerald-50 mb-4">
                <h3 class="font-bold text-emerald-800 mb-4">ูุซุงู ูก: ุชูุฒูุน ูุญุฐู ุงูุฃุณุณ</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                    <span class="math-eq text-lg">ุณ(ุณ + ูค) = ุณ<span class="tiny-sup">ูข</span> + ูจ</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ุชูููู ุงูุญุฏ ุงูููุฒุน</h4>
                        <p class="text-center"><span class="math-eq"><span class="num-red">ุณ</span>(ุณ + ูค) = ุณ<span class="tiny-sup">ูข</span> + ูจ</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูข: ุงูุชูุฒูุน ุงูุตุฑูุญ</h4>
                        <p class="text-center"><span class="math-eq">(<span class="num-red">ุณ</span> ร ุณ) + (<span class="num-red">ุณ</span> ร ูค) = ุณ<span class="tiny-sup">ูข</span> + ูจ</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูฃ: ุญุฐู ุณยฒ ูุงูุญู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ูคุณ = ูจ  โ  ุณ = ูข</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                </div>
            </div>

            <div id="interactive-container-3-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-emerald-50 mb-4">
                <h3 class="font-bold text-emerald-800 mb-4">ูุซุงู ูข: ุชูุฒูุน ุทุฑูู ุงููุนุงุฏูุฉ</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                    <span class="math-eq text-lg">ูฃ(ุณ - ูข) = ูข(ุณ + ูค)</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ุชูููู ุงูุญุฏูุฏ</h4>
                        <p class="text-center"><span class="math-eq"><span class="num-red">ูฃ</span>(ุณ - ูข) = <span class="var-green">ูข</span>(ุณ + ูค)</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูข: ุงูุชูุฒูุน ุงูุตุฑูุญ (ร)</h4>
                        <p class="text-center"><span class="math-eq">(<span class="num-red">ูฃ</span> ร ุณ) - (<span class="num-red">ูฃ</span> ร ูข) = (<span class="var-green">ูข</span> ร ุณ) + (<span class="var-green">ูข</span> ร ูค)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูฃ: ุงูุชุจุณูุท ูุงูุญู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ูฃุณ - ูฆ = ูขุณ + ูจ  โ  ุณ = ูกูค</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">ุงูุชุงูู</button>
                </div>
            </div>

            <button onclick="switchTab('learn4')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>ุงูุชุงูู: ุชุทุจููุงุช ุญูุงุชูุฉ</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 4: Life Applications] -->
        <div id="tab-learn4" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg bg-amber-100 text-amber-700 border border-amber-200">ูค</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ุชุทุจููุงุช ูู ูุงูุน ุงูุญูุงุฉ</h2>
            </div>

            <!-- ุชุทุจูู 1 -->
            <div id="interactive-container-4-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-amber-50 mb-6">
                <h3 class="font-bold text-amber-800 mb-4">ุชุทุจูู ูก: ูุณุงุญุฉ ูุณุจุญ ูุณุชุทูู</h3>
                <div class="bg-amber-50 p-5 rounded-lg mb-4 text-gray-700 border-r-4 border-amber-300">
                    <p class="leading-relaxed">ุตูู ูููุฏุณ ูุณุจุญุงู ูุณุชุทูู ุงูุดููุ ูุจูุบ ุนุฑุถู <span class="math-eq">ูขุณ</span> ูุชุฑุงูุ ูุทููู ูุฒูุฏ ุนู ุนุฑุถู ุจููุฏุงุฑ ูฃ ุฃูุชุงุฑุ ุฃู ุฃู ุทููู ูู <span class="math-eq">ุณ + ูฃ</span>. ุงูุชุจ ุงูุนุจุงุฑุฉ ุงูุชู ุชูุซู ูุณุงุญุฉ ุงููุณุจุญ ูู ุฃุจุณุท ุตูุฑุฉ.</p>
                </div>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-2">
                    <div class="interactive-placeholder text-center text-gray-400 py-10">ุงุถุบุท "ุฅุธูุงุฑ ุงูุญู" ููุชูุตูู</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ูุชุงุจุฉ ุงููุงููู</h4>
                        <p class="text-sm">ุงููุณุงุญุฉ (ู) = ุงูุทูู ร ุงูุนุฑุถ</p>
                        <p class="text-center font-bold mt-1"><span class="math-eq">ู = <span class="num-red">ูขุณ</span> ร ( <span class="var-green">ุณ</span> + <span class="var-blue">ูฃ</span> )</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูข: ุชูุฒูุน ูุญูุฏุฉ ุงูุญุฏ</h4>
                        <p class="text-center"><span class="math-eq">ู = (<span class="num-red">ูขุณ</span> ร ุณ) + (<span class="num-red">ูขุณ</span> ร ูฃ)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูฃ: ุงูุชุจุณูุท ุงูููุงุฆู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ู = ูขุณ<span class="tiny-sup">ูข</span> + ูฆุณ</span></p>
                    </div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">ุฅุธูุงุฑ ุงูุญู</button>
            </div>

            <!-- ุชุทุจูู 2 -->
            <div id="interactive-container-4-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-amber-50 mb-6">
                <h3 class="font-bold text-amber-800 mb-4">ุชุทุจูู ูข: ูุณุงุญุฉ ููุญุฉ ูููุฉ ูุซูุซูุฉ</h3>
                <div class="bg-amber-50 p-5 rounded-lg mb-4 text-gray-700 border-r-4 border-amber-300">
                    <p class="leading-relaxed">ุตูู ููุงู ููุญุฉ ุฌุฏุงุฑูุฉ ูุซูุซูุฉุ ุทูู ูุงุนุฏุชูุง <span class="math-eq">ูคุณ</span> ุณูุ ูุงุฑุชูุงุนูุง ููุซู ุจุงูุนุจุงุฑุฉ <span class="math-eq">ุณ + ูข</span> ุณู. ุฃูุฌุฏ ุชุนุจูุฑุงู ุฌุจุฑูุงู ููุซู ูุณุงุญุฉ ุณุทุญ ุงูููุญุฉ ูู ุฃุจุณุท ุตูุฑุฉ.</p>
                </div>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-2">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ูุงููู ูุณุงุญุฉ ุงููุซูุซ</h4>
                        <p class="text-sm">ุงููุณุงุญุฉ = ู,ูฅ ร ุงููุงุนุฏุฉ ร ุงูุงุฑุชูุงุน</p>
                        <p class="text-center font-bold mt-1"><span class="math-eq">ู = ู,ูฅ ร <span class="num-red">ูคุณ</span> ร ( <span class="var-green">ุณ</span> + <span class="var-blue">ูข</span> )</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูข: ุถุฑุจ ุงููุตู ูู ุงููุงุนุฏุฉ</h4>
                        <p class="text-center"><span class="math-eq">ู = <span class="num-red">ูขุณ</span> ร ( <span class="var-green">ุณ</span> + <span class="var-blue">ูข</span> )</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูฃ: ุงูุชูุฒูุน ุงูููุงุฆู</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ู = ูขุณ<span class="tiny-sup">ูข</span> + ูคุณ</span></p>
                    </div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">ุฅุธูุงุฑ ุงูุญู</button>
            </div>

            <!-- ุชุทุจูู 3 -->
            <div id="interactive-container-4-3" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-amber-50 mb-6">
                <h3 class="font-bold text-amber-800 mb-4">ุชุทุจูู ูฃ: ุชูููุฉ ูุฌูู ุทุจูุนู</h3>
                <div class="bg-amber-50 p-5 rounded-lg mb-4 text-gray-700 border-r-4 border-amber-300">
                    <p class="leading-relaxed">ุฅุฐุง ูุงู ุณุนุฑ ุงููุฌูู ุงูุทุจูุนู ูููุชุฑ ุงููุฑุจุน ุงููุงุญุฏ ูู <span class="math-eq">ูกูฅ</span> ุฑูุงูุงูุ ููุณุงุญุฉ ุญุฏููุฉ ุงูููุฒู ุชูุซู ุจุงูุนุจุงุฑุฉ <span class="math-eq">ุณ + ูกู</span> ูุชุฑุงู ูุฑุจุนุงู. ููุง ูู ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ ุงูุชู ุณูุฏูุนูุง ุตุงุญุจ ุงูููุฒูุ</p>
                </div>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-2">
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูก: ูุงููู ุงูุชูููุฉ</h4>
                        <p class="text-center font-bold mt-1"><span class="math-eq">ุงูุชูููุฉ = ูกูฅ ร ( <span class="var-green">ุณ</span> + <span class="var-blue">ูกู</span> )</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs text-blue-600 mb-1">ุฎุทูุฉ ูข: ุชูุฒูุน ุงูุถุฑุจ</h4>
                        <p class="text-center"><span class="math-eq">ุช = (ูกูฅ ร ุณ) + (ูกูฅ ร ูกู)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs text-green-600 mb-1">ุฎุทูุฉ ูฃ: ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</h4>
                        <p class="text-lg font-bold text-center"><span class="math-eq">ุช = ูกูฅุณ + ูกูฅู</span></p>
                    </div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">ุฅุธูุงุฑ ุงูุญู</button>
            </div>

            <button onclick="switchTab('quiz')" class="btn-theme w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 mt-4 animate-bounce"><span>ุฌุงูุฒ ููุงุฎุชุจุงุฑุ</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [QUIZ TAB] (Sacred Section) -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">ุงุฎุชุจุงุฑ ุงูููู</h2><p class="text-xs md:text-sm text-gray-500">ูฅ ุฃุณุฆูุฉ ูุฎุชุงุฑุฉ ูู ุฃุตู ูกูฅ</p></div>
                    <div class="text-center">
                        <div id="loading-attempts" class="hidden"><div class="loader"></div></div>
                        <div id="attempts-display" class="flex flex-col items-center">
                            <span class="block text-xl md:text-2xl font-bold" style="color: var(--theme-hex)" id="attempts-count">-</span>
                            <div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>ูุญุงููุงุช</span></div>
                        </div>
                        <div id="timer-top-container" class="hidden mt-1 font-mono text-red-500 text-xs font-bold"><span id="timer-display-top">00:00:00</span></div>
                    </div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto">
                    <div class="result-content p-4">
                        <p class="text-sm text-gray-600 font-bold mb-1">ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ</p>
                        <p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p>
                        <div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div>
                        <div class="mt-4">
                            <div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block">
                                <span class="block text-lg font-bold text-red-600 font-mono tracking-wider" id="timer-display-bottom">00:00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <h2 id="games-title" class="text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> ุงุณุชูุชุน ูุชุนูู</h2>
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"></div>
                </div>
            </div>
        </div>
        
        <footer class="lesson-footer"><p>ุชุตููู ูุฅุนุฏุงุฏ: <strong>ุฃ. ุนุจุฏุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู</strong></p><p class="mt-1 opacity-70">ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ ูขููขูฅ</p></footer>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 shadow-2xl">
            <div class="flex justify-between mb-4 items-center">
                <div class="flex items-center gap-2" style="color: var(--theme-hex)">
                    <i id="modal-icon" data-lucide="info" class="w-5 h-5"></i>
                    <h3 id="modal-title" class="font-bold text-lg">ุชูุถูุญ</h3>
                </div>
                <button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div>
        </div>
    </div>

    <!-- Game Modal Structure -->
    <div id="game-modal-container">
        <div id="game-modal-content">
            <div id="game-modal-header" class="text-white flex justify-between items-center py-1 px-3 shadow-md">
                <script>document.getElementById('game-modal-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
                <div class="flex items-center gap-2"><i class="fas fa-gamepad"></i><span id="game-modal-title" class="font-bold">ุงููุนุจุฉ ุฌุงุฑูุฉ...</span></div>
                <button onclick="closeGameModal()" class="hover:bg-red-500 px-2 py-1 rounded transition"><i class="fas fa-times"></i></button>
            </div>
            <iframe id="game-frame" src=""></iframe>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let timerInterval;
        let studentData = null;

        const tabs = [
            { id: 'learn1', icon: 'book', label: 'ุงูุถุฑุจ' },
            { id: 'learn2', icon: 'layers', label: 'ุงูุชุจุณูุท' },
            { id: 'learn3', icon: 'target', label: 'ุงููุนุงุฏูุงุช' },
            { id: 'learn4', icon: 'star', label: 'ุชุทุจููุงุช' },
            { id: 'quiz', icon: 'clipboard-check', label: 'ุงูุงุฎุชุจุงุฑ' }
        ];

        const typeLabels = { 'learn1': 'ุถุฑุจ ูุญูุฏุฉ ุญุฏ', 'learn2': 'ุชุจุณูุท ุนุจุงุฑุฉ', 'learn3': 'ุญู ูุนุงุฏูุฉ', 'learn4': 'ุชุทุจูู ุญูุงุชู', 'mixed': 'ุชุญุฏู' };

        const questionBank = [
            { id: 1, type: 'learn1', t: 'ุฃูุฌุฏ ูุงุชุฌ ุถุฑุจ: ูขุณ(ุณ + ูค)', o: [{t:'ูขุณ<span class="tiny-sup">ูข</span> + ูจุณ', v:'a'}, {t:'ูขุณ + ูจ', v:'b'}, {t:'ูขุณ<span class="tiny-sup">ูข</span> + ูค', v:'c'}, {t:'ุณ<span class="tiny-sup">ูข</span> + ูจุณ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน ุงููููู</h4><p><span class="math-eq">(<span class="num-red">ูขุณ</span> ร <span class="var-green">ุณ</span>) + (<span class="num-red">ูขุณ</span> ร <span class="var-blue">ูค</span>)</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงููุงุชุฌ ุงูููุงุฆู</h4><p><span class="math-eq">ูขุณ<span class="tiny-sup">ูข</span> + ูจุณ</span></p></div></div>', smart: 'ูุถุฑุจ ุงููุนุงููุงุช ุฃููุงู ุซู ูุฌูุน ุงูุฃุณุณ ุนูุฏ ุชุดุงุจู ุงููุชุบูุฑุงุช.' },
            { id: 2, type: 'learn1', t: 'ูุงุชุฌ ุถุฑุจ -ูฃุฃ(ูคุฃ - ูข) ูู:', o: [{t:'-ูกูขุฃ<span class="tiny-sup">ูข</span> + ูฆุฃ', v:'a'}, {t:'-ูกูขุฃ<span class="tiny-sup">ูข</span> - ูฆุฃ', v:'b'}, {t:'ูกูขุฃ<span class="tiny-sup">ูข</span> + ูฆุฃ', v:'c'}, {t:'-ูงุฃ + ูข', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุถุฑุจ ุงููุนุงููุงุช</h4><p><span class="math-eq">(<span class="num-red">-ูฃุฃ</span> ร <span class="var-green">ูคุฃ</span>) + (<span class="num-red">-ูฃุฃ</span> ร <span class="var-blue">-ูข</span>)</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงููุงุชุฌ</h4><p><span class="math-eq">-ูกูขุฃ<span class="tiny-sup">ูข</span> + ูฆุฃ</span></p></div></div>', smart: 'ุงูุชุจู ูุฅุดุงุฑุฉ ุงูุณุงูุจ: ุณุงูุจ ร ุณุงูุจ = ููุฌุจ.' },
            { id: 3, type: 'learn1', t: 'ุจุณุท ุงูุนุจุงุฑุฉ: ูฅุต(ุต<span class="tiny-sup">ูข</span> - ุต + ูฃ)', o: [{t:'ูฅุต<span class="tiny-sup">ูฃ</span> - ูฅุต<span class="tiny-sup">ูข</span> + ูกูฅุต', v:'a'}, {t:'ูฅุต<span class="tiny-sup">ูฃ</span> + ูกูฅุต', v:'b'}, {t:'ูฅุต<span class="tiny-sup">ูข</span> - ูฅุต + ูกูฅ', v:'c'}, {t:'ุต<span class="tiny-sup">ูฃ</span> - ุต + ูกูฅ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq"><span class="num-red">ูฅุต</span> ร ุต<span class="tiny-sup">ูข</span> + <span class="num-red">ูฅุต</span> ร (-ุต) + <span class="num-red">ูฅุต</span> ร ูฃ</span></p></div></div>', smart: 'ุชูุฒุน ูุญูุฏุฉ ุงูุญุฏ ุนูู ูู ุญุฏ ุฏุงุฎู ุงูููุณ ูููุง ูุซุฑ ุนุฏุฏูู.' },
            { id: 4, type: 'learn2', t: 'ุจุณุท ุงูุนุจุงุฑุฉ: ูฃ(ุณ + ูข) + ูคุณ', o: [{t:'ูงุณ + ูฆ', v:'a'}, {t:'ูงุณ + ูข', v:'b'}, {t:'ูฃุณ + ูฆ', v:'c'}, {t:'ูกูขุณ + ูฆ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq"><span class="var-green">ูฃุณ</span> + <span class="var-blue">ูฆ</span> + <span class="var-green">ูคุณ</span></span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุฎุทูุฉ ูข: ุฏูุฌ ุงูุญุฏูุฏ ุงููุชุดุงุจูุฉ</h4><p><span class="math-eq"><span class="var-green">ูงุณ</span> + <span class="var-blue">ูฆ</span></span></p></div></div>', smart: 'ูุฌูุน ุงููุชุบูุฑุงุช ุงูุชู ููุง ููุณ ุงูุฃุณ ูุนุงู.' },
            { id: 5, type: 'learn2', t: 'ุฃุจุณุท ุตูุฑุฉ ูู: ุณ(ุณ + ูฃ) - ุณ<span class="tiny-sup">ูข</span>', o: [{t:'ูฃุณ', v:'a'}, {t:'ูขุณ<span class="tiny-sup">ูข</span> + ูฃุณ', v:'b'}, {t:'ุณ<span class="tiny-sup">ูข</span>', v:'c'}, {t:'ู', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq"><span class="var-green">ุณ<span class="tiny-sup">ูข</span></span> + ูฃุณ - <span class="var-green">ุณ<span class="tiny-sup">ูข</span></span></span></p></div><div class="step-box border-red-500 bg-red-50"><h4 class="font-bold text-red-600 mb-1">ุงูุญุฐู</h4><p>ูุชู ุญุฐู <span class="var-green">ุณ<span class="tiny-sup">ูข</span></span> ูุน <span class="var-green">-ุณ<span class="tiny-sup">ูข</span></span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงููุงุชุฌ ุงูููุงุฆู</h4><p><span class="math-eq">ูฃุณ</span></p></div></div>', smart: 'ุงูุญุฏ ููุนููุณู ูุญุฐูุงู ุจุนุถููุง ููุฑุงู.' },
            { id: 6, type: 'learn2', t: 'ุจุณุท: ูขู(ู + ูฅ) + ูฃ(ู<span class="tiny-sup">ูข</span> - ูข)', o: [{t:'ูฅู<span class="tiny-sup">ูข</span> + ูกูู - ูฆ', v:'a'}, {t:'ูฅู<span class="tiny-sup">ูข</span> + ูกูู + ูฆ', v:'b'}, {t:'ูขู<span class="tiny-sup">ูข</span> + ูกูู + ูฃู<span class="tiny-sup">ูข</span>', v:'c'}, {t:'ูฅู<span class="tiny-sup">ูข</span> - ูฆ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ูู ุงูุฃููุงุณ</h4><p><span class="math-eq"><span class="var-green">ูขู<span class="tiny-sup">ูข</span></span> + ูกูู + <span class="var-green">ูฃู<span class="tiny-sup">ูข</span></span> - ูฆ</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุฎุทูุฉ ูข: ุงูุฏูุฌ</h4><p><span class="math-eq"><span class="var-green">ูฅู<span class="tiny-sup">ูข</span></span> + ูกูู - ูฆ</span></p></div></div>', smart: 'ูู ูู ููุณ ุนูู ุญุฏุฉ ุซู ุงุฌูุน.' },
            { id: 7, type: 'learn3', t: 'ุญู ุงููุนุงุฏูุฉ: ุณ(ุณ + ูข) = ุณ<span class="tiny-sup">ูข</span> + ูฆ', o: [{t:'ูฃ', v:'a'}, {t:'ูข', v:'b'}, {t:'ูฆ', v:'c'}, {t:'-ูฃ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ูู ุงูููุณ</h4><p><span class="math-eq"><span class="var-green">ุณ<span class="tiny-sup">ูข</span></span> + ูขุณ = <span class="var-green">ุณ<span class="tiny-sup">ูข</span></span> + ูฆ</span></p></div><div class="step-box border-red-500 bg-red-50"><h4 class="font-bold text-red-600 mb-1">ุงูุญุฐู</h4><p>ูุญุฐู <span class="var-green">ุณ<span class="tiny-sup">ูข</span></span> ูู ุงูุทุฑููู</p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงูุญู</h4><p><span class="math-eq">ูขุณ = ูฆ  โ  ุณ = ูฃ</span></p></div></div>', smart: 'ุงุญุฐู ุงููุชุบูุฑุงุช ุฐุงุช ุงูุฃุณุณ ุงููุจูุฑุฉ ุงููุชุทุงุจูุฉ ูู ุงูุฌูุชูู.' },
            { id: 8, type: 'learn3', t: 'ุญู ุงููุนุงุฏูุฉ: ูข(ุณ - ูก) = ูจ', o: [{t:'ูฅ', v:'a'}, {t:'ูค', v:'b'}, {t:'ูฃ', v:'c'}, {t:'ูฆ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq">ูขุณ - ูข = ูจ</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงูุญู</h4><p><span class="math-eq">ูขุณ = ูกู โ ุณ = ูฅ</span></p></div></div>', smart: 'ููููู ูุณูุฉ ุงูุทุฑููู ุนูู ูข ูุจุฏุงูุฉ ุฃุณุฑุน.' },
            { id: 9, type: 'learn3', t: 'ูููุฉ ุณ ูู: ูฃุณ + ุณ(ุณ - ูฃ) = ูขูฅ', o: [{t:'ูฅ ุฃู -ูฅ', v:'a'}, {t:'ูฅ', v:'b'}, {t:'ู', v:'c'}, {t:'ูขูฅ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq"><span class="var-blue">ูฃุณ</span> + ุณ<span class="tiny-sup">ูข</span> - <span class="var-blue">ูฃุณ</span> = ูขูฅ</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุงูุญู</h4><p><span class="math-eq">ุณ<span class="tiny-sup">ูข</span> = ูขูฅ โ ุณ = ูฅ</span></p></div></div>', smart: 'ุฏุงุฆูุงู ูุฒุน ูุชูุชุดู ุงูุญุฏูุฏ ุงูุชู ุชุญุฐู ุจุนุถูุง.' },
            { id: 10, type: 'learn4', t: 'ูุณุชุทูู ุนุฑุถู ุณ ูุทููู ุณ + ูฅุ ูุณุงุญุชู ูู:', o: [{t:'ุณ<span class="tiny-sup">ูข</span> + ูฅุณ', v:'a'}, {t:'ูขุณ + ูฅ', v:'b'}, {t:'ุณ<span class="tiny-sup">ูข</span> + ูฅ', v:'c'}, {t:'ูฅุณ<span class="tiny-sup">ูข</span>', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงููุงููู</h4><p>ุงููุณุงุญุฉ = ุณ ร (ุณ + ูฅ)</p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุฎุทูุฉ ูข: ุงูุชูุฒูุน</h4><p><span class="math-eq">ุณ<span class="tiny-sup">ูข</span> + ูฅุณ</span></p></div></div>', smart: 'ูุณุงุญุฉ ุงููุณุชุทูู ูู ุญุงุตู ุถุฑุจ ุงูุนุฑุถ ูู ุงูุทูู.' },
            { id: 11, type: 'learn4', t: 'ูุซูุซ ูุงุนุฏุชู ูขุณ ูุงุฑุชูุงุนู ุณ - ูฃุ ูุณุงุญุชู ูู:', o: [{t:'ุณ<span class="tiny-sup">ูข</span> - ูฃุณ', v:'a'}, {t:'ูขุณ<span class="tiny-sup">ูข</span> - ูฆุณ', v:'b'}, {t:'ุณ<span class="tiny-sup">ูข</span> + ูฃุณ', v:'c'}, {t:'ุณ - ูฃ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงููุงููู</h4><p><span class="math-eq">ู,ูฅ ร ูขุณ ร (ุณ - ูฃ)</span></p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-green-600 mb-1">ุฎุทูุฉ ูข: ุงูุชุจุณูุท</h4><p><span class="math-eq">ุณ(ุณ - ูฃ) = ุณ<span class="tiny-sup">ูข</span> - ูฃุณ</span></p></div></div>', smart: 'ูุตู ุงููุงุนุฏุฉ ูุญุฐู ุฑูู ูข ููุจูู ุณ.' },
            { id: 12, type: 'learn4', t: 'ุชูููุฉ ุฏูุงู ูุณุงุญุฉ (ุณ+ูกู) ุจุณุนุฑ ูฅ ุฑูุงูุงุช ูููุชุฑ:', o: [{t:'ูฅุณ + ูฅู', v:'a'}, {t:'ูฅุณ + ูกู', v:'b'}, {t:'ุณ + ูฅู', v:'c'}, {t:'ูฅูุณ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><h4 class="font-bold text-blue-600 mb-1">ุฎุทูุฉ ูก: ุงูุชูุฒูุน</h4><p><span class="math-eq">ูฅ ร (ุณ + ูกู) = ูฅุณ + ูฅู</span></p></div></div>', smart: 'ุงุถุฑุจ ุงูุณุนุฑ ูู ุงููุณุงุญุฉ ุงููููุฉ.' },
            { id: 13, type: 'mixed', t: 'ุฃู ูุญูุฏุฉ ุญุฏ ุชุฌุนู ุงูุฌููุฉ ุตุญูุญุฉ: (...) (ุณ+ูข) = ูฅุณยฒ + ูกูุณุ', o: [{t:'ูฅุณ', v:'a'}, {t:'ุณ', v:'b'}, {t:'ูฅ', v:'c'}, {t:'ูขุณ', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><p>ุจุงูุชูุฒูุน:</p><p><span class="math-eq"><span class="num-red">ูฅุณ</span> ร ุณ = ูฅุณ<span class="tiny-sup">ูข</span></span></p><p><span class="math-eq"><span class="num-red">ูฅุณ</span> ร ูข = ูกูุณ</span></p></div></div>', smart: 'ุงูุณู ุงูุญุฏ ุงูุฃูู ุนูู ุณ ูุชุนุฑู ูุญูุฏุฉ ุงูุญุฏ.' },
            { id: 14, type: 'mixed', t: 'ุญู ุงููุนุงุฏูุฉ: ูขุณ(ุณ + ูฃ) + ูค = ูขุณ<span class="tiny-sup">ูข</span> + ูกู', o: [{t:'ูก', v:'a'}, {t:'ูฃ', v:'b'}, {t:'ูข', v:'c'}, {t:'ู', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><p><span class="math-eq"><span class="var-green">ูขุณ<span class="tiny-sup">ูข</span></span> + ูฆุณ + ูค = <span class="var-green">ูขุณ<span class="tiny-sup">ูข</span></span> + ูกู</span></p></div><div class="step-box border-green-500 bg-green-50"><p><span class="math-eq">ูฆุณ = ูฆ โ ุณ = ูก</span></p></div></div>', smart: 'ุงูุชูุฒูุน ูููุฏ ูู ุทุฑูู ุงูุญู ุฏุงุฆูุงู.' },
            { id: 15, type: 'mixed', t: 'ุชุจุณูุท: ุต(ุต + ูก) + ุต(ุต - ูก) ูู:', o: [{t:'ูขุต<span class="tiny-sup">ูข</span>', v:'a'}, {t:'ูขุต', v:'b'}, {t:'ุต<span class="tiny-sup">ูข</span>', v:'c'}, {t:'ู', v:'d'}], c: 'a', e: '<div class="flex flex-col gap-3"><div class="step-box"><p><span class="math-eq">ุต<span class="tiny-sup">ูข</span> + <span class="var-blue">ุต</span> + ุต<span class="tiny-sup">ูข</span> - <span class="var-blue">ุต</span></span></p></div><div class="step-box border-green-500 bg-green-50"><p><span class="math-eq">ูขุต<span class="tiny-sup">ูข</span></span></p></div></div>', smart: 'ุต ู -ุต ูุฎุชููุงู ููุจูู ูขุตยฒ.' }
        ];

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById('tab-' + tabId);
            const navEl = document.getElementById('nav-' + tabId);
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') {
                if(document.getElementById('quizForm').innerHTML === '') generateQuiz();
                renderDynamicGames(); 
                fetchStudentData();
            }
        }

        function initInteractive() {
            document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive');
                const placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                let current = -1;
                const update = () => {
                    if (placeholder) {
                        if (current === -1) placeholder.classList.remove('hidden'); 
                        else placeholder.classList.add('hidden');
                    }
                    steps.forEach((s, i) => { if (i <= current) s.classList.add('active'); else s.classList.remove('active'); });
                    if (current >= steps.length - 1) { 
                        if(nextBtn) nextBtn.classList.add('hidden'); 
                        if(resetBtn) resetBtn.classList.remove('hidden'); 
                    } else { 
                        if(nextBtn) nextBtn.classList.remove('hidden'); 
                        if(resetBtn) resetBtn.classList.add('hidden'); 
                    }
                    if(prevBtn) prevBtn.disabled = current === -1;
                };
                if(nextBtn) nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
                if(prevBtn) prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
                update();
            });
        }

        // --- SACRED CONNECTION FUNCTIONS (DO NOT TOUCH) ---
        async function fetchStudentData() {
            const urlParams = new URLSearchParams(window.location.search);
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') return;
            const loadEl = document.getElementById('loading-attempts');
            const dispEl = document.getElementById('attempts-display');
            if(loadEl) loadEl.classList.remove('hidden');
            if(dispEl) dispEl.classList.add('hidden');
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url);
                const json = await response.json();
                studentData = json;
                if (json.status === "success" && json.data) {
                    let d = (json.data.lessons && json.data.lessons[LESSON_KEY]) ? json.data.lessons[LESSON_KEY] : { attempts: 0, grade: 0 };
                    attemptsLeft = Math.max(0, 3 - (d.attempts || 0));
                    if (attemptsLeft === 0 && d.waitTime > 0) { startTimer(Date.now() + d.waitTime); }
                    const scoreBadge = document.getElementById('header-score-badge');
                    if (d.grade > 0) { 
                        document.getElementById('student-score').textContent = d.grade; 
                        if(scoreBadge) scoreBadge.classList.remove('hidden'); 
                    }
                    if (json.data.name) document.getElementById('student-name').textContent = json.data.name;
                    syncGamesWithData();
                }
            } catch (e) { console.error(e); } finally { 
                updateAttemptsUI(); 
                if(loadEl) loadEl.classList.add('hidden'); 
                if(dispEl) dispEl.classList.remove('hidden'); 
            }
        }

        function initAttempts() {
            const urlParams = new URLSearchParams(window.location.search);
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                const saved = localStorage.getItem(ATTEMPTS_KEY + '_visitor');
                attemptsLeft = saved !== null ? parseInt(saved) : 1;
                const next = localStorage.getItem(NEXT_ATTEMPT_KEY + '_visitor');
                if (next && parseInt(next) > Date.now()) { startTimer(parseInt(next)); attemptsLeft = 0; }
                updateAttemptsUI();
            } else {
                attemptsLeft = 0; updateAttemptsUI(); fetchStudentData();
            }
        }

        async function saveScoreToBackend(lessonId, grade) {
            const urlParams = new URLSearchParams(window.location.search);
            const sId = urlParams.get('studentId');
            const cId = urlParams.get('classId');
            const saveStatus = document.getElementById('save-status');
            if (!sId || !cId) { if(saveStatus) saveStatus.innerHTML = '<span class="text-yellow-600">ุชู ุชุณุฌูู ุงููุชูุฌุฉ ูุญููุงู (ุฒุงุฆุฑ)</span>'; return; }
            if(saveStatus) saveStatus.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุญูุธ ุงููุชูุฌุฉ...</span>';
            const requestUrl = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            try {
                await fetch(requestUrl);
                if(saveStatus) saveStatus.innerHTML = '<span class="text-green-600 font-bold">โ ุชู ุญูุธ ุงููุชูุฌุฉ ุจูุฌุงุญ!</span>';
                setTimeout(() => fetchStudentData(), 1500);
            } catch (e) { 
                if(saveStatus) saveStatus.innerHTML = '<span class="text-red-600 font-bold">โ ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู.</span>';
            }
        }

        function generateQuiz() {
            currentQuestions = [];
            const requiredTypes = ['learn1', 'learn2', 'learn3', 'learn4', 'mixed'];
            requiredTypes.forEach(type => {
                const pool = questionBank.filter(q => q.type === type);
                if(pool.length > 0) currentQuestions.push(pool[Math.floor(Math.random() * pool.length)]);
            });
            renderQuiz();
        }

        function renderQuiz() {
            const f = document.getElementById('quizForm');
            if(!f) return;
            let h = '';
            currentQuestions.forEach((q, i) => {
                h += `<div class="border border-gray-200 rounded-xl p-4 bg-white mb-6 hover:shadow-sm transition">
                        <div class="flex justify-between items-center mb-4">
                            <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold">ุณุคุงู ${convertToArabic(i+1)}</span>
                            <span class="text-[10px] text-gray-400 font-bold">${typeLabels[q.type]}</span>
                        </div>
                        <p class="font-bold text-gray-800 mb-4">${q.t}</p>
                        <div class="options-grid">${q.o.map((o, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${o.v}" class="hidden"><label for="q${i}o${oi}" class="option-label shadow-sm text-sm">${o.t}</label></div>`).join('')}</div>
                        <div id="feedback-${i}" class="hidden p-3 rounded-lg mt-2 font-bold"></div>
                        <div id="actions-${i}" class="hidden mt-3 flex flex-wrap gap-2 items-center">
                             <button type="button" onclick="showExplain(${i})" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg flex items-center gap-1 transition"><i data-lucide="help-circle" class="w-3 h-3"></i> ููุงุฐุงุ</button>
                             <button type="button" onclick="showSmart(${i})" class="text-xs bg-purple-50 text-purple-600 px-3 py-2 rounded-lg flex items-center gap-1 transition"><i data-lucide="lightbulb" class="w-3 h-3"></i> ุงูุญู ุงูุฐูู</button>
                             <button type="button" onclick="switchTab('${q.type.replace('mixed','learn4')}')" class="text-xs border border-gray-200 text-gray-500 px-3 py-2 rounded-lg mr-auto flex items-center gap-1 transition"><i data-lucide="book-open" class="w-3 h-3"></i> ูุฑุงุฌุนุฉ ุงูุฏุฑุณ</button>
                        </div>
                      </div>`;
            });
            h += '<button type="submit" id="quiz-action-btn" class="btn-theme w-full font-bold py-3 rounded-xl shadow-lg transition">ุชุญูู ูู ุงูุฅุฌุงุจุงุช</button>';
            f.innerHTML = h;
            f.onsubmit = handleQuizSubmit;
            lucide.createIcons();
            updateAttemptsUI();
        }

        async function handleQuizSubmit(e) {
            e.preventDefault();
            if (attemptsLeft <= 0) return;
            attemptsLeft--;
            
            const urlParams = new URLSearchParams(window.location.search);
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.setItem(ATTEMPTS_KEY + '_visitor', attemptsLeft);
                if (attemptsLeft === 0) {
                    const nextTime = Date.now() + COOLDOWN_MS;
                    localStorage.setItem(NEXT_ATTEMPT_KEY + '_visitor', nextTime);
                    startTimer(nextTime);
                }
            } else {
                if (attemptsLeft === 0) startTimer(Date.now() + COOLDOWN_MS);
            }

            let score = 0;
            currentQuestions.forEach((q, i) => {
                const sel = document.querySelector('input[name="q'+i+'"]:checked');
                const fb = document.getElementById('feedback-' + i);
                const acts = document.getElementById('actions-' + i);
                if(sel && sel.value === q.c) { 
                    score++; 
                    if(fb) { fb.innerHTML = 'โ ุฅุฌุงุจุฉ ุตุญูุญุฉ'; fb.className = 'block bg-green-50 text-green-700 p-3 rounded-lg mt-2 text-xs font-bold border border-green-100'; }
                } else { 
                    if(fb) { fb.innerHTML = 'โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ'; fb.className = 'block bg-red-50 text-red-700 p-3 rounded-lg mt-2 text-xs font-bold border border-red-100'; }
                }
                if(acts) acts.classList.remove('hidden');
                document.querySelectorAll('input[name="q'+i+'"]').forEach(inp => inp.disabled = true);
            });
            
            const grade = score * 2;
            const resDiv = document.getElementById('quiz-results');
            if(resDiv) resDiv.classList.remove('hidden');
            const scoreEl = document.getElementById('quiz-score');
            if(scoreEl) scoreEl.textContent = convertToArabic(grade) + ' / ูกู';
            
            saveScoreToBackend(LESSON_KEY, grade);
            updateAttemptsUI();
        }

        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);
            const btn = document.getElementById('quiz-action-btn');
            if (!btn) return;
            const resDiv = document.getElementById('quiz-results');
            if (!resDiv) return;
            const resultsVisible = !resDiv.classList.contains('hidden');
            if (resultsVisible) {
                if (attemptsLeft > 0) { 
                    btn.textContent = "ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ"; btn.disabled = false; btn.type = "button"; btn.onclick = resetQuizView; 
                    btn.className = "btn-theme w-full font-bold py-3 rounded-xl shadow-lg";
                } else { 
                    btn.textContent = "ุงูุชูุช ุงููุญุงููุงุช"; btn.disabled = true; 
                    btn.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-xl cursor-not-allowed";
                }
            } else {
                if (attemptsLeft > 0) {
                    btn.textContent = "ุชุญูู ูู ุงูุฅุฌุงุจุงุช"; btn.disabled = false; btn.type = "submit"; btn.onclick = null;
                    btn.className = "btn-theme w-full font-bold py-3 rounded-xl shadow-lg";
                } else {
                    btn.textContent = "ุงููุญุงููุงุช ูุณุชููุฐุฉ"; btn.disabled = true;
                    btn.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-xl cursor-not-allowed";
                }
            }
        }

        function resetQuizView() {
            const resDiv = document.getElementById('quiz-results');
            if(resDiv) resDiv.classList.add('hidden');
            generateQuiz();
        }

        function startTimer(target) {
            const topC = document.getElementById('timer-top-container');
            const botC = document.getElementById('timer-bottom-container');
            if(topC) topC.classList.remove('hidden');
            if(botC) botC.classList.remove('hidden');
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = target - Date.now();
                if (diff <= 0) { 
                    clearInterval(timerInterval); 
                    location.reload(); 
                    return; 
                } 
                const t = new Date(diff).toISOString().substr(11, 8).replace(/\d/g, d=>"ููกูขูฃูคูฅูฆูงูจูฉ"[d]);
                const topD = document.getElementById('timer-display-top');
                const botD = document.getElementById('timer-display-bottom');
                if(topD) topD.textContent = t;
                if(botD) botD.textContent = t;
            }, 1000);
        }

        function renderDynamicGames() {
            const container = document.getElementById('dynamic-games-container');
            if (!container) return;
            container.innerHTML = '';
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/);
            const ch = match ? match[1] : '0';
            const ls = match ? match[2] : '0';
            const gameIds = ['g'+ch+'_'+ls+'_1', 'g'+ch+'_'+ls+'_2'];
            
            gameIds.forEach((gid, idx) => {
                const i = idx + 1;
                const cid = `game-card-${i}`;
                const sid = `game-status-${i}`;
                const iid = `game-icon-${i}`;
                const title = gid === gameIds[0] ? 'ูุนุจุฉ ูุญูุฏุงุช ุงูุญุฏ' : 'ุชุญุฏู ุงููุณุงุญุงุช';
                const icon = gid === gameIds[0] ? 'fa-rocket' : 'fa-trophy';
                const url = `https://ablan-math.github.io/games/${gid}.html`;

                container.innerHTML += `<div id="${cid}" class="p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition bg-white" onclick="openGameModal('${url}', '${title}')">
                    <div id="${iid}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors" style="background-color: ${currentTheme.hex}15; color: ${currentTheme.hex}"><i class="fas ${icon}"></i></div>
                    <div class="flex flex-col"><span class="font-bold text-gray-800 text-sm">${title}</span><span id="${sid}" class="text-[10px] font-bold opacity-70">ุงุถุบุท ููุจุฏุก</span></div>
                </div>`;
            });
            const wrapper = document.getElementById('games-wrapper');
            if(wrapper) wrapper.classList.remove('hidden');
        }

        function syncGamesWithData() {
            if (!studentData || !studentData.data) return;
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/);
            if (!match) return;
            const gameIds = [`g${match[1]}_${match[2]}_1`, `g${match[1]}_${match[2]}_2`];
            gameIds.forEach((gid, idx) => {
                const data = studentData.data.games?.[gid] || studentData.data.lessons?.[gid] || studentData.data[gid];
                if (data && data.grade !== undefined) {
                    const card = document.getElementById(`game-card-${idx+1}`);
                    const status = document.getElementById(`game-status-${idx+1}`);
                    if(card && status) {
                        status.textContent = `ุชู ุงูุฅูุฌุงุฒ (${data.grade}/ูฅ)`;
                        card.classList.add('bg-blue-50');
                    }
                }
            });
        }

        function openGameModal(url, title) {
            const frame = document.getElementById('game-frame');
            const tit = document.getElementById('game-modal-title');
            const cont = document.getElementById('game-modal-container');
            if(frame) frame.src = url;
            if(tit) tit.textContent = title;
            if(cont) cont.style.display = 'flex';
        }

        function closeGameModal() {
            const cont = document.getElementById('game-modal-container');
            const frame = document.getElementById('game-frame');
            if(cont) cont.style.display = 'none';
            if(frame) frame.src = '';
        }

        function showExplain(i) { 
            const cont = document.getElementById('modal-content');
            if(cont) {
                cont.innerHTML = currentQuestions[i].e; 
                document.getElementById('modal')?.classList.remove('hidden'); 
            }
        }
        function showSmart(i) { 
            const cont = document.getElementById('modal-content');
            if(cont) {
                cont.innerHTML = currentQuestions[i].smart; 
                document.getElementById('modal')?.classList.remove('hidden'); 
            }
        }
        function closeModal() { document.getElementById('modal')?.classList.add('hidden'); }

        window.onload = function() {
            const nav = document.getElementById('bottom-nav-container');
            if(nav) {
                tabs.forEach((t, i) => {
                    nav.innerHTML += `<div class="nav-item ${i===0?'active':''}" id="nav-${t.id}" onclick="switchTab('${t.id}')"><i data-lucide="${t.icon}"></i><span>${t.label}</span></div>`;
                });
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
            initInteractive();
            initAttempts();
        };
    </script>
</body>
</html>

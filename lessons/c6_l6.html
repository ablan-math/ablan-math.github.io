<!-- 
    ğŸ›‘ğŸ›‘ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¸ÙˆØ±Ø© Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (STRICT PROTOCOL) ğŸ›‘ğŸ›‘
    =========================================================================
    Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ (Master Template V2):

    1. Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù…Ù‚Ø¯Ø³Ø© (Do Not Touch):
       - Ù…Ù…Ù†ÙˆØ¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (fetchStudentData, saveScoreToBackend).
       - Ù…Ù…Ù†ÙˆØ¹ ØªØ¹Ø¯ÙŠÙ„ "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡ÙˆÙŠØ©" (Theme Engine) Ø£Ùˆ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (CHAPTER_THEMES).
       - Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ± Ù…Ù†Ø·Ù‚ "Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨" (renderDynamicGames).
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ù…Ù†Ø·Ù‚ "Ø²Ø± Ø§Ù„ØªØ­Ù‚Ù‚" (Quiz Button Logic): ØªØ­ÙˆÙ„Ù‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† (ØªØ­Ù‚Ù‚) -> (Ø¥Ø¹Ø§Ø¯Ø©) -> (Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª).
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ Ø­Ø°Ù Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ "Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ Ùˆ Ø§Ù„Ø³ÙÙ„ÙŠ" (Bottom Timer) Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ± Ù‡ÙŠÙƒÙ„ÙŠØ© "Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø«Ù„Ø§Ø«Ø©" (Ù„Ù…Ø§Ø°Ø§ØŸ - Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³) Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø´Ø±Ø­ Ø¯Ø§Ø®Ù„Ù‡Ø§).

    2. Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… (Concept Flexibility):
       - Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù„Ù‰ 4 Ù…ÙØ§Ù‡ÙŠÙ… (Tabs).
       - âœ… Ù…Ø³Ù…ÙˆØ­ Ø¬Ø¯Ø§Ù‹ ÙˆÙ…ØªÙˆÙ‚Ø¹ Ø­Ø°Ù "Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹" (Tab 4) Ø£Ùˆ "Ø§Ù„Ø«Ø§Ù„Ø«" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ù‚ØµÙŠØ±Ø§Ù‹.
       - Ø¹Ù†Ø¯ Ø­Ø°Ù ØªØ¨ÙˆÙŠØ¨ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ HTML Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ ÙÙ‚Ø·. Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (JS) Ø°ÙƒÙŠ ÙˆØ³ÙŠØªØ£Ù‚Ù„Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
       - Ø§Ù„ØºØ§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ù‡Ùˆ 3 Ù…ÙØ§Ù‡ÙŠÙ…ØŒ ÙˆØ§Ù„Ù†Ø§Ø¯Ø± 2.

    3. Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (Allowed Edits):
       - ØªØºÙŠÙŠØ± Ù‚ÙŠÙ…Ø© LESSON_KEY ÙÙŠ Ø§Ù„Ù€ <head> Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¯Ø±Ø³ (Ù†Ù…Ø·: cX_lY).
       - ØªØºÙŠÙŠØ± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (questionBank).
       - ØªØºÙŠÙŠØ± Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª.
    =========================================================================
-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¶Ø±Ø¨ ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- [THEME DICTIONARY] -->
    <script>
        // 1. Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯Ø±Ø³ (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
        const LESSON_KEY = 'c6_l6'; 

        // [Global Helper]
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }

        // 2. Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù‡ÙˆÙŠØ© (Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØºÙŠÙŠØ±Ù‡ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹Ø±Ù Ù…Ø§ ØªÙØ¹Ù„)
        const CHAPTER_THEMES = {
            '6': { name: 'ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯', gradient: 'from-blue-600 to-blue-800', baseColor: 'blue', hex: '#2563eb', icon: 'fa-graduation-cap' },
            '7': { name: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠØ©', gradient: 'from-purple-600 to-purple-800', baseColor: 'purple', hex: '#9333ea', icon: 'fa-puzzle-piece' },
            '8': { name: 'Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠØ©', gradient: 'from-emerald-600 to-emerald-800', baseColor: 'emerald', hex: '#059669', icon: 'fa-bezier-curve' },
            '9': { name: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø¬Ø°Ø±ÙŠØ© Ùˆ Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª', gradient: 'from-amber-600 to-amber-800', baseColor: 'amber', hex: '#d97706', icon: 'fa-bolt' },
            '10': { name: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¡ ÙˆØ§Ù„Ø§Ø­ØªÙ…Ø§Ù„', gradient: 'from-rose-600 to-rose-800', baseColor: 'rose', hex: '#e11d48', icon: 'fa-chart-pie' },
            'default': { gradient: 'from-gray-700 to-gray-900', baseColor: 'gray', hex: '#374151', icon: 'fa-book' }
        };

        function getTheme() {
            const match = LESSON_KEY.match(/c(\d+)/);
            const chNum = match ? match[1] : 'default';
            const theme = CHAPTER_THEMES[chNum] || CHAPTER_THEMES['default'];
            theme.chNum = chNum === 'default' ? '#' : chNum;
            return theme;
        }
        const currentTheme = getTheme();
    </script>

    <style>
        /* CORE STYLES */
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        :root { --theme-hex: #374151; }

        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        @media (min-width: 768px) { .math-eq { font-size: 1.1em; padding: 4px 12px; } }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .var-blue { color: #2563eb; } .op-purple { color: #9333ea; font-weight: 800; } 
        .tiny-sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.6em; margin-right: 1px; line-height: 0; font-family: 'Cairo', sans-serif; }
        .fix-pos { display: inline-flex; flex-direction: row; align-items: baseline; gap: 1px; direction: rtl; } 
        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 4px; font-size: 0.85em; vertical-align: middle; }
        .fraction > span { padding: 0 2px; display: block; line-height: 1; }
        .fraction > .bar { border-top: 2px solid currentColor; height: 0; width: 100%; margin: 2px 0; }
        .fraction > span:last-child .tiny-sup { top: -0.2em !important; }
        
        /* THEME BUTTON CLASS */
        .btn-theme { background-color: var(--theme-hex); color: white; transition: all 0.3s ease; }
        .btn-theme:hover { filter: brightness(0.85); transform: translateY(-1px); }
        .btn-theme:active { transform: scale(0.98); }
        .btn-theme:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; filter: none; }

        .step-box { border-right: 3px solid var(--theme-hex); background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .v-step { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
        .v-arrow { color: #9ca3af; margin: 4px 0; font-size: 1.2rem; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item span { margin-top: 2px; text-align: center; line-height: 1.1; max-width: 60px; }
        .nav-item.active { color: var(--theme-hex); font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: var(--theme-hex); border-radius: 4px 4px 0 0; }
        @media (min-width: 768px) { .nav-item { font-size: 0.8rem; } .nav-item svg, .nav-item i { font-size: 1.4rem; margin-bottom: 4px; } .nav-item span { max-width: none; } }
        
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } .step-interactive.active { display: block; opacity: 1; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; }
        input[type="radio"]:checked + .option-label { border-color: var(--theme-hex); background-color: #eff6ff; color: var(--theme-hex); font-weight: bold; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        
        .result-card-base { position: relative; overflow: hidden; padding: 1.5rem !important; transition: all 0.3s ease; }
        .result-card-trophy { background-color: #fffbeb; border-color: #fcd34d !important; border-width: 2px; } 
        .result-card-star { background-color: #fff7ed; border-color: #fdba74 !important; border-width: 2px; } 
        .result-card-retry { background-color: #fef2f2; border-color: #fca5a5 !important; border-width: 2px; } 
        
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--theme-hex); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 80px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }

        /* FOIL ANIMATION STYLES */
        .foil-term { transition: all 0.3s ease; padding: 2px 6px; border-radius: 6px; display: inline-block; position: relative; }
        .foil-highlight-1 { background-color: #dbeafe; color: #1e40af; transform: scale(1.15); border: 2px solid #3b82f6; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .foil-highlight-2 { background-color: #dcfce7; color: #166534; transform: scale(1.15); border: 2px solid #22c55e; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .foil-box { width: 100%; height: 40px; border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: 'Cairo'; font-size: 1rem; color: #94a3b8; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: #f8fafc; }
        .foil-box.filled { border-style: solid; color: #1e293b; border-color: var(--theme-hex); background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .foil-box.active-slot { border-color: #fbbf24; background-color: #fffbeb; animation: pulse-border 1.5s infinite; }
        @keyframes pulse-border { 0% { border-color: #fbbf24; box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); } 70% { border-color: #f59e0b; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0); } 100% { border-color: #fbbf24; box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } }

        /* DISTRIBUTION ANIMATION STYLES */
        .dist-term-red { color: #dc2626; font-weight: bold; }
        .dist-term-green { color: #16a34a; font-weight: bold; }
        .dist-term-blue { color: #2563eb; font-weight: bold; }
        .dist-block { border: 2px dashed #e2e8f0; padding: 8px; border-radius: 8px; margin-bottom: 8px; background: #fff; transition: all 0.5s; opacity: 0; transform: translateY(10px); }
        .dist-block.visible { opacity: 1; transform: translateY(0); border-style: solid; border-color: #cbd5e1; }
        .dist-step-highlight { background-color: #f0f9ff; border-color: #bae6fd; }

        /* COMPACT GAME MODAL CONTROLS */
        #game-modal-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #game-modal-content { background: white; width: 90%; height: 85%; max-width: 1200px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #game-modal-content.fullscreen { width: 100%; height: 100%; border-radius: 0; max-width: none; }
        #game-modal-header { padding: 4px 10px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 32px; }
        #game-frame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #f3f4f6; }
        .win-btn { padding: 2px 8px; border-radius: 4px; transition: background 0.2s; color: rgba(255,255,255,0.9); font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }
        .win-btn:hover { background-color: rgba(255,255,255,0.2); color: white; }
        .win-btn-close:hover { background-color: #ef4444; }
        #minimized-game-bar { display: none; position: fixed; bottom: 80px; left: 20px; background: white; border: 2px solid; border-radius: 50px; padding: 8px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9998; cursor: pointer; align-items: center; gap: 10px; font-weight: bold; transition: transform 0.2s; animation: slideInUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <script>
        (function() {
            const root = document.documentElement;
            root.style.setProperty('--theme-hex', currentTheme.hex);
            try {
                const params = new URLSearchParams(window.location.search);
                const name = params.get('name');
                const dynamicTitle = params.get('title') || params.get('lesson_title');
                if (name) { window.__studentName = name; }
                if (dynamicTitle) { window.__lessonTitle = dynamicTitle; document.title = dynamicTitle; }
            } catch(e) { console.error("Init Error", e); }
        })();
    </script>

    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative">
        <script>document.getElementById('main-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <i id="bg-giant-icon" class="fas absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <script>document.getElementById('bg-giant-icon').classList.add(currentTheme.icon);</script>
            <span class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">
                <script>document.write(currentTheme.chNum)</script>
            </span>
            <i class="fas fa-plus absolute top-4 left-[20%] text-xl text-white opacity-10 transform rotate-12"></i>
            <i class="fas fa-minus absolute bottom-4 right-[30%] text-2xl text-white opacity-10 transform -rotate-6"></i>
            <i class="fas fa-times absolute top-8 right-12 text-lg text-white opacity-10"></i>
            <i class="fas fa-divide absolute bottom-6 left-8 text-xl text-white opacity-10 transform rotate-45"></i>
        </div>
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas text-lg md:text-2xl"></i>
                    <script>document.getElementById('header-icon').classList.add(currentTheme.icon);</script>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">
                            <script>
                                const rawNum = LESSON_KEY.replace('c','').replace('_l','-');
                                document.write(convertToArabic(rawNum));
                            </script>
                        </span>
                        <span id="lesson-title-text">Ø¶Ø±Ø¨ ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> 
                    <span id="student-name">
                        <script>
                            (function(){
                                const p = new URLSearchParams(window.location.search);
                                const n = p.get('name');
                                const id = p.get('studentId');
                                if(n) document.write(n);
                                else if(id === 'visitor') document.write('Ø²Ø§Ø¦Ø±');
                                else document.write('Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ');
                            })();
                        </script>
                    </span>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>Ø±Ø¬ÙˆØ¹</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- [TAB 1: Concept 1 - FOIL] -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span id="tab1-num" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border shadow-sm">Ù¡</span>
                <script>document.getElementById('tab1-num').className += ` bg-${currentTheme.baseColor}-100 text-${currentTheme.baseColor}-700 border-${currentTheme.baseColor}-200`;</script>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ (FOIL)</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div id="card-stripe-1" class="absolute top-0 right-0 w-1 h-full"></div>
                <script>document.getElementById('card-stripe-1').className += ` bg-${currentTheme.baseColor}-500`;</script>
                <p class="text-gray-600 text-sm md:text-lg mb-3">Ù„Ø¶Ø±Ø¨ Ø«Ù†Ø§Ø¦ÙŠØªÙŠ Ø­Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„ØªÙŠ ØªØªÙ„Ø®Øµ ÙÙŠ Ø¶Ø±Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯: <span class="font-bold text-blue-600">Ø§Ù„Ø£ÙˆÙ„ÙŠÙ†</span>ØŒ <span class="font-bold text-green-600">Ø§Ù„Ø·Ø±ÙÙŠÙ†</span>ØŒ <span class="font-bold text-orange-600">Ø§Ù„ÙˆØ³Ø·ÙŠÙ†</span>ØŒ <span class="font-bold text-purple-600">Ø§Ù„Ø£Ø®ÙŠØ±ÙŠÙ†</span>ØŒ Ø«Ù… Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner"><span class="math-eq text-xl">(Ø£ + Ø¨)(Ø¬Ù€ + Ø¯) = Ø£.Ø¬Ù€ + Ø£.Ø¯ + Ø¨.Ø¬Ù€ + Ø¨.Ø¯</span></div>
            </div>
            
            <!-- FOIL CONTAINER 1 -->
            <div id="foil-interactive-zone" class="bg-white rounded-xl p-3 md:p-4 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¡: <span class="math-eq">(Ù¢<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span> + Ù¥)</span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">ØªÙØ§Ø¹Ù„ÙŠ</span>
                </div>
                
                <div class="min-h-[100px] bg-gray-50 rounded-xl p-3 flex flex-col items-center justify-center gap-2 relative overflow-hidden">
                    <div class="text-2xl md:text-4xl font-bold font-mono text-gray-700 dir-ltr flex items-center justify-center gap-1 md:gap-2">
                        <span>(</span><span id="term-f1" class="foil-term">Ù¢Ø³</span><span>+</span><span id="term-l1" class="foil-term">Ù£</span><span>)</span>
                        <span>(</span><span id="term-f2" class="foil-term">Ø³</span><span>+</span><span id="term-l2" class="foil-term">Ù¥</span><span>)</span>
                    </div>
                    <div class="w-full grid grid-cols-4 gap-2 md:gap-3 dir-ltr mt-1">
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-blue-500 font-bold opacity-0 transition-opacity" id="label-box-1">Ø§Ù„Ø£ÙˆÙ„ Ã— Ø§Ù„Ø£ÙˆÙ„</span><div id="foil-box-1" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-green-500 font-bold opacity-0 transition-opacity" id="label-box-2">Ø§Ù„Ø·Ø±ÙÙŠÙ†</span><div id="foil-box-2" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-orange-500 font-bold opacity-0 transition-opacity" id="label-box-3">Ø§Ù„ÙˆØ³Ø·ÙŠÙ†</span><div id="foil-box-3" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-purple-500 font-bold opacity-0 transition-opacity" id="label-box-4">Ø§Ù„Ø£Ø®ÙŠØ± Ã— Ø§Ù„Ø£Ø®ÙŠØ±</span><div id="foil-box-4" class="foil-box">ØŸ</div></div>
                    </div>
                    
                    <!-- NEW INTERMEDIATE STEP -->
                    <div id="foil-intermediate-result" class="hidden opacity-0 transition-all transform translate-y-4 font-bold text-base md:text-xl text-gray-600 bg-yellow-50 px-3 py-1.5 rounded-lg border border-yellow-200 shadow-sm">
                        Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + <span class="text-red-600 font-black px-1 border-b-2 border-red-200">Ù¡Ù <span class="var-green">Ø³</span></span> + <span class="text-red-600 font-black px-1 border-b-2 border-red-200">Ù£<span class="var-green">Ø³</span></span> + Ù¡Ù¥
                    </div>

                    <div id="foil-final-result" class="hidden opacity-0 transition-all transform translate-y-4 font-bold text-base md:text-xl text-gray-800 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                        Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span class="math-eq">Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù£<span class="var-green">Ø³</span> + Ù¡Ù¥</span>
                    </div>
                    <div id="foil-instruction" class="text-xs md:text-base text-gray-500 font-bold animate-pulse mt-2">Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ø±Ø¨" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
                </div>
                <div class="flex justify-between mt-3">
                    <button id="foil-reset-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition" disabled><i class="fas fa-undo"></i></button>
                    <button id="foil-action-btn" class="btn-theme px-8 py-2 rounded-xl font-bold shadow-lg text-sm md:text-lg min-w-[120px]">Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ø±Ø¨</button>
                    <div class="w-10"></div>
                </div>
            </div>

            <!-- FOIL CONTAINER 2 (NEW - With Negatives) -->
            <div id="foil-interactive-zone-2" class="bg-white rounded-xl p-3 md:p-4 shadow-sm border-2 border-red-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¢ (ØªØ­Ø¯ÙŠ): <span class="math-eq">(<span class="var-green">Ø³</span> - Ù¤)(Ù¢<span class="var-green">Ø³</span> + Ù£)</span></h3>
                    <span class="text-[10px] md:text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">Ø³ÙˆØ§Ù„Ø¨</span>
                </div>
                
                <div class="min-h-[100px] bg-gray-50 rounded-xl p-3 flex flex-col items-center justify-center gap-2 relative overflow-hidden">
                    <div class="text-2xl md:text-4xl font-bold font-mono text-gray-700 dir-ltr flex items-center justify-center gap-1 md:gap-2">
                        <span>(</span><span id="term-f1-2" class="foil-term">Ø³</span><span id="term-l1-2" class="foil-term text-red-600">-Ù¤</span><span>)</span>
                        <span>(</span><span id="term-f2-2" class="foil-term">Ù¢Ø³</span><span>+</span><span id="term-l2-2" class="foil-term">Ù£</span><span>)</span>
                    </div>
                    <div class="w-full grid grid-cols-4 gap-2 md:gap-3 dir-ltr mt-1">
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-blue-500 font-bold opacity-0 transition-opacity" id="label-box-1-2">Ø§Ù„Ø£ÙˆÙ„ Ã— Ø§Ù„Ø£ÙˆÙ„</span><div id="foil-box-1-2" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-green-500 font-bold opacity-0 transition-opacity" id="label-box-2-2">Ø§Ù„Ø·Ø±ÙÙŠÙ†</span><div id="foil-box-2-2" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-orange-500 font-bold opacity-0 transition-opacity" id="label-box-3-2">Ø§Ù„ÙˆØ³Ø·ÙŠÙ†</span><div id="foil-box-3-2" class="foil-box">ØŸ</div></div>
                        <div class="flex flex-col gap-1 items-center"><span class="text-[9px] md:text-[10px] text-purple-500 font-bold opacity-0 transition-opacity" id="label-box-4-2">Ø§Ù„Ø£Ø®ÙŠØ± Ã— Ø§Ù„Ø£Ø®ÙŠØ±</span><div id="foil-box-4-2" class="foil-box">ØŸ</div></div>
                    </div>
                    
                    <!-- NEW INTERMEDIATE STEP 2 -->
                    <div id="foil-intermediate-result-2" class="hidden opacity-0 transition-all transform translate-y-4 font-bold text-base md:text-xl text-gray-600 bg-yellow-50 px-3 py-1.5 rounded-lg border border-yellow-200 shadow-sm">
                        Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + <span class="text-red-600 font-black px-1 border-b-2 border-red-200">Ù£<span class="var-green">Ø³</span></span> <span class="text-red-600 font-black px-1 border-b-2 border-red-200">- Ù¨<span class="var-green">Ø³</span></span> - Ù¡Ù¢
                    </div>

                    <div id="foil-final-result-2" class="hidden opacity-0 transition-all transform translate-y-4 font-bold text-base md:text-xl text-gray-800 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                        Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span class="math-eq">Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¥<span class="var-green">Ø³</span> - Ù¡Ù¢</span>
                    </div>
                    <div id="foil-instruction-2" class="text-xs md:text-base text-gray-500 font-bold animate-pulse mt-2">Ø§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ø±Ø¨" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
                </div>
                <div class="flex justify-between mt-3">
                    <button id="foil-reset-btn-2" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition" disabled><i class="fas fa-undo"></i></button>
                    <button id="foil-action-btn-2" class="btn-theme px-8 py-2 rounded-xl font-bold shadow-lg text-sm md:text-lg min-w-[120px]">Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ø±Ø¨</button>
                    <div class="w-10"></div>
                </div>
            </div>

            <!-- UPDATED: Use .btn-theme -->
            <button onclick="switchTab('learn2')" class="btn-theme w-full py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ (Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù…)</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 2: Concept 2 - Distribution Property] -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span id="tab2-num" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border shadow-sm">Ù¢</span>
                <script>document.getElementById('tab2-num').className += ` bg-${currentTheme.baseColor}-100 text-${currentTheme.baseColor}-700 border-${currentTheme.baseColor}-200`;</script>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div id="card-stripe-2" class="absolute top-0 right-0 w-1 h-full"></div>
                <script>document.getElementById('card-stripe-2').className += ` bg-${currentTheme.baseColor}-500`;</script>
                <p class="text-gray-600 text-sm md:text-lg mb-3">ØªØ³ØªØ®Ø¯Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ø¶Ø±Ø¨ Ø£ÙŠ ÙƒØ«ÙŠØ±ØªÙŠ Ø­Ø¯ÙˆØ¯ Ø¨Ø¨Ø¹Ø¶Ù‡Ù…Ø§. Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡ÙŠ Ø¶Ø±Ø¨ <strong>ÙƒÙ„ Ø­Ø¯</strong> Ù…Ù† Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ <strong>Ø¬Ù…ÙŠØ¹ Ø­Ø¯ÙˆØ¯</strong> Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø«Ø§Ù†ÙŠ.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner"><span class="math-eq text-xl">Ù†ÙˆØ²Ø¹ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø«Ù… Ø§Ù„Ø­Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ</span></div>
            </div>

            <!-- Dist App 1: Binomial x Binomial -->
            <div id="dist-interactive-1" class="bg-white rounded-xl p-3 md:p-4 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¡ (Ø«Ù†Ø§Ø¦ÙŠØ© Ã— Ø«Ù†Ø§Ø¦ÙŠØ©): <span class="math-eq">(<span class="dist-term-red">Ø³</span> + <span class="dist-term-green">Ù¥</span>)(<span class="dist-term-blue">Ø³</span> + Ù£)</span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">ØªÙØ§Ø¹Ù„ÙŠ</span>
                </div>
                <div class="min-h-[60px] bg-gray-50 rounded-lg p-3 flex flex-col gap-2 justify-center items-center relative overflow-hidden">
                    <div id="dist-1-step1" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¡: ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</p>
                        <span class="math-eq text-base md:text-xl"><span class="dist-term-red">Ø³</span>(<span class="dist-term-blue">Ø³</span> + Ù£) + <span class="dist-term-green">Ù¥</span>(<span class="dist-term-blue">Ø³</span> + Ù£)</span>
                    </div>
                    <div id="dist-1-step2" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„Ø¶Ø±Ø¨</p>
                        <span class="math-eq text-base md:text-xl">(<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="dist-term-red">Ø³</span>) + (Ù¥<span class="dist-term-blue">Ø³</span> + Ù¡Ù¥)</span>
                    </div>
                    <div id="dist-1-step3" class="dist-block w-full text-center bg-yellow-50 border-yellow-200 hidden">
                        <p class="text-xs text-yellow-600 mb-1 font-bold">Ø®Ø·ÙˆØ© Ù£: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</p>
                        <span class="math-eq text-base md:text-lg font-bold">
                            <span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> + 
                            <span class="text-green-600 border-b-2 border-green-200 px-1">(Ù£<span class="dist-term-red">Ø³</span> + Ù¥<span class="dist-term-blue">Ø³</span>)</span> + Ù¡Ù¥
                        </span>
                    </div>
                    <div id="dist-1-step4" class="dist-block w-full text-center bg-green-50 border-green-200 hidden">
                        <p class="text-xs text-green-600 mb-1 font-bold">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
                        <span class="math-eq text-lg md:text-xl font-bold"><span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¨<span class="dist-term-blue">Ø³</span> + Ù¡Ù¥</span>
                    </div>
                    <div id="dist-1-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10"><span class="text-gray-400 font-bold animate-pulse text-xs md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹</span></div>
                </div>
                <div class="flex justify-between mt-2">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>

            <!-- Dist App 2: Binomial x Trinomial (UPDATED) -->
            <div id="dist-interactive-2" class="bg-white rounded-xl p-3 md:p-4 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¢ (Ø«Ù†Ø§Ø¦ÙŠØ© Ã— Ø«Ù„Ø§Ø«ÙŠØ©): <span class="math-eq">(<span class="dist-term-red">Ø³</span> - <span class="dist-term-green">Ù¢</span>)(<span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="dist-term-blue">Ø³</span> - Ù¤)</span></h3>
                    <span class="text-[10px] md:text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-bold">ØªÙØ§Ø¹Ù„ÙŠ</span>
                </div>
                <div class="min-h-[60px] bg-gray-50 rounded-lg p-3 flex flex-col gap-2 justify-center items-center relative overflow-hidden">
                    <div id="dist-2-step1" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¡: ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</p>
                        <span class="math-eq text-base md:text-xl"><span class="dist-term-red">Ø³</span>(<span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="dist-term-blue">Ø³</span> - Ù¤) - <span class="dist-term-green">Ù¢</span>(<span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="dist-term-blue">Ø³</span> - Ù¤)</span>
                    </div>
                    <div id="dist-2-step2" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„Ø¶Ø±Ø¨</p>
                        <span class="math-eq text-sm md:text-lg">(<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù£<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¤<span class="dist-term-red">Ø³</span>) + (-Ù¢<span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¦<span class="dist-term-blue">Ø³</span> + Ù¨)</span>
                    </div>
                    <!-- NEW STEP 3: GROUPING -->
                    <div id="dist-2-step3" class="dist-block w-full text-center bg-yellow-50 border-yellow-200 hidden">
                        <p class="text-xs text-yellow-600 mb-1 font-bold">Ø®Ø·ÙˆØ© Ù£: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</p>
                        <span class="math-eq text-base md:text-lg font-bold">
                            <span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù£</sup> + 
                            <span class="text-green-600 border-b-2 border-green-200 px-1">(Ù£<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¢<span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup>)</span> + 
                            <span class="text-purple-600 border-b-2 border-purple-200 px-1">(-Ù¤<span class="dist-term-red">Ø³</span> - Ù¦<span class="dist-term-blue">Ø³</span>)</span> + Ù¨
                        </span>
                    </div>
                    <div id="dist-2-step4" class="dist-block w-full text-center bg-green-50 border-green-200 hidden">
                        <p class="text-xs text-green-600 mb-1 font-bold">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
                        <span class="math-eq text-lg md:text-xl font-bold"><span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù£</sup> + <span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¡Ù <span class="dist-term-blue">Ø³</span> + Ù¨</span>
                    </div>
                    <div id="dist-2-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10"><span class="text-gray-400 font-bold animate-pulse text-xs md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹</span></div>
                </div>
                <div class="flex justify-between mt-2">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>

            <!-- Dist App 3: Trinomial x Trinomial -->
            <div id="dist-interactive-3" class="bg-white rounded-xl p-3 md:p-4 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù£ (Ø«Ù„Ø§Ø«ÙŠØ© Ã— Ø«Ù„Ø§Ø«ÙŠØ©): <span class="math-eq text-xs md:text-base">(<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> + <span class="dist-term-green">Ø³</span> + <span class="dist-term-blue">Ù¡</span>)(<span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup> - <span class="dist-term-green">Ø³</span> + <span class="dist-term-blue">Ù¡</span>)</span></h3>
                    <span class="text-[10px] md:text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold">Ù…ØªÙ‚Ø¯Ù…</span>
                </div>
                <div class="min-h-[60px] bg-gray-50 rounded-lg p-3 flex flex-col gap-2 justify-center items-center relative overflow-hidden">
                    <div id="dist-3-step1" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¡: ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ (Ø·ÙˆÙŠÙ„Ø© Ù„ÙƒÙ† Ù…Ù†Ø¸Ù…Ø©)</p>
                        <span class="math-eq text-xs md:text-sm block leading-loose">
                            <span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¢</sup>(...) + <span class="dist-term-green">Ø³</span>(...) + <span class="dist-term-blue">Ù¡</span>(...)
                        </span>
                    </div>
                    <div id="dist-3-step2" class="dist-block w-full text-center hidden">
                        <p class="text-xs text-gray-400 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ù†Ø§ØªØ¬ Ø§Ù„Ø¶Ø±Ø¨ Ù„ÙƒÙ„ Ø¬Ø²Ø¡</p>
                        <span class="math-eq text-xs md:text-sm block leading-loose">
                            (<span class="text-red-600">Ø³â´ - Ø³Â³ + Ø³Â²</span>) + (<span class="text-green-600">Ø³Â³ - Ø³Â² + Ø³</span>) + (<span class="text-blue-600">Ø³Â² - Ø³ + Ù¡</span>)
                        </span>
                    </div>
                    <!-- NEW STEP 3: GROUPING FOR APP 3 -->
                    <div id="dist-3-step3" class="dist-block w-full text-center bg-yellow-50 border-yellow-200 hidden">
                        <p class="text-xs text-yellow-600 mb-1 font-bold">Ø®Ø·ÙˆØ© Ù£: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</p>
                        <span class="math-eq text-xs md:text-base font-bold leading-loose">
                            Ø³â´ + <span class="text-red-600 border-b border-red-300">(-Ø³Â³ + Ø³Â³)</span> + <span class="text-green-600 border-b border-green-300">(Ø³Â² - Ø³Â² + Ø³Â²)</span> + <span class="text-purple-600 border-b border-purple-300">(Ø³ - Ø³)</span> + Ù¡
                        </span>
                    </div>
                    <div id="dist-3-step4" class="dist-block w-full text-center bg-green-50 border-green-200 hidden">
                        <p class="text-xs text-green-600 mb-1 font-bold">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø­Ø¯ÙˆØ¯)</p>
                        <span class="math-eq text-lg md:text-xl font-bold"><span class="dist-term-red">Ø³</span><sup class="tiny-sup">Ù¤</sup> + <span class="dist-term-blue">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡</span>
                    </div>
                    <div id="dist-3-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10"><span class="text-gray-400 font-bold animate-pulse text-xs md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹</span></div>
                </div>
                <div class="flex justify-between mt-2">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>

            <!-- UPDATED: Use .btn-theme -->
            <button onclick="switchTab('learn3')" class="btn-theme w-full py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù† ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 3: Concept 3 - Real Life] -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span id="tab3-num" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border shadow-sm">Ù£</span>
                <script>document.getElementById('tab3-num').className += ` bg-${currentTheme.baseColor}-100 text-${currentTheme.baseColor}-700 border-${currentTheme.baseColor}-200`;</script>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù‡Ù†Ø¯Ø³ÙŠØ© (Ø§Ù„Ù…Ø³Ø§Ø­Ø©)</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div id="card-stripe-3" class="absolute top-0 right-0 w-1 h-full"></div>
                <script>document.getElementById('card-stripe-3').className += ` bg-${currentTheme.baseColor}-500`;</script>
                <p class="text-gray-600 text-sm md:text-lg mb-3">ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¶Ø±Ø¨ ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ø¹Ø¨Ø§Ø±Ø§Øª Ø¬Ø¨Ø±ÙŠØ©.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner"><span class="math-eq text-xl">Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶</span></div>
            </div>
            <div id="interactive-container-3-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù£: Ù…Ø³Ø¨Ø­ Ø·ÙˆÙ„Ù‡ <span class="math-eq">(<span class="var-green">Ø³</span> + Ù¦)</span> ÙˆØ¹Ø±Ø¶Ù‡ <span class="math-eq">(<span class="var-green">Ø³</span> + Ù¤)</span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">ØªÙØ§Ø¹Ù„ÙŠ</span>
                </div>
                <div class="min-h-[80px] bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø©</div>
                    
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¡: ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©</h4>
                        <p class="text-sm">Ø§Ù„Ù…Ø³Ø§Ø­Ø© = <span class="math-eq">(<span class="var-green">Ø³</span> + Ù¦)(<span class="var-green">Ø³</span> + Ù¤)</span></p>
                    </div>
                    
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„Ø¶Ø±Ø¨ (Ø§Ù„Ø£ÙˆÙ„ÙŠÙ†ØŒ Ø§Ù„Ø·Ø±ÙÙŠÙ†ØŒ Ø§Ù„ÙˆØ³Ø·ÙŠÙ†ØŒ Ø§Ù„Ø£Ø®ÙŠØ±ÙŠÙ†)</h4>
                        <p class="text-sm text-center"><span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¤<span class="var-green">Ø³</span> + Ù¦<span class="var-green">Ø³</span> + Ù¢Ù¤</span></p>
                    </div>

                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4>
                        <p class="text-center font-bold">
                            <span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù <span class="var-green">Ø³</span> + Ù¢Ù¤</span> ÙˆØ­Ø¯Ø© Ù…Ø±Ø¨Ø¹Ø©
                        </p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <!-- UPDATED: Use .btn-theme -->
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>
            <!-- UPDATED: Use .btn-theme -->
            <button onclick="switchTab('learn4')" class="btn-theme w-full py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ© (ØªØ­Ø¯ÙŠ)</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 4: Concept 4 - Challenge (Special Cases)] -->
        <div id="tab-learn4" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span id="tab4-num" class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border shadow-sm">Ù¤</span>
                <script>document.getElementById('tab4-num').className += ` bg-${currentTheme.baseColor}-100 text-${currentTheme.baseColor}-700 border-${currentTheme.baseColor}-200`;</script>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ© (Ù…Ø±Ø¨Ø¹ ÙˆÙ…ÙƒØ¹Ø¨)</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div id="card-stripe-4" class="absolute top-0 right-0 w-1 h-full"></div>
                <script>document.getElementById('card-stripe-4').className += ` bg-${currentTheme.baseColor}-500`;</script>
                <p class="text-gray-600 text-sm md:text-lg mb-3">Ø³Ù†ØªØ¹Ù„Ù… Ù‡Ù†Ø§ ÙƒÙŠÙÙŠØ© ØªØ¨Ø³ÙŠØ· Ù…Ø±Ø¨Ø¹ ÙˆÙ…ÙƒØ¹Ø¨ Ø«Ù†Ø§Ø¦ÙŠØ© Ø­Ø¯. ØªØ°ÙƒØ± Ø£Ù† Ø§Ù„Ø£Ø³ ÙŠØ¹Ù†ÙŠ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¶Ø±Ø¨.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner"><span class="math-eq text-xl">(Ø£ + Ø¨)Â² â‰  Ø£Â² + Ø¨Â²</span></div>
            </div>
            
            <!-- App 4: Square -->
            <div id="interactive-container-4-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¤: Ø¨Ø³Ù‘Ø· <span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)<sup class="tiny-sup">Ù¢</sup></span></h3><span class="text-[10px] md:text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">ØªØ­Ø¯ÙŠ</span>
                </div>
                <div class="min-h-[80px] bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„Ø­Ù„</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¡: ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± ÙƒØ¶Ø±Ø¨</h4>
                        <p class="text-center text-lg font-bold"><span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span> + Ù£)</span></p>
                    </div>
                    <div class="step-interactive step-box">
                         <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„ØªÙˆØ²ÙŠØ¹ (FOIL)</h4>
                         <p class="text-center text-lg"><span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="var-green">Ø³</span> + Ù£<span class="var-green">Ø³</span> + Ù©</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4>
                        <p class="text-center font-bold text-xl"><span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø³</span> + Ù©</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>

            <!-- App 5: Cube (New) -->
            <div id="interactive-container-4-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¥: Ø¨Ø³Ù‘Ø· <span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)<sup class="tiny-sup">Ù£</sup></span></h3><span class="text-[10px] md:text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-bold">Ù…ØªÙ‚Ø¯Ù… Ø¬Ø¯Ø§Ù‹</span>
                </div>
                <div class="min-h-[80px] bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„Ø­Ù„</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„ØªÙÙƒÙŠÙƒ</h4>
                        <p class="text-center text-lg"><span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span> + Ù£)<sup class="tiny-sup">Ù¢</sup></span></p>
                    </div>
                    <div class="step-interactive step-box">
                         <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„ØªØ¹ÙˆÙŠØ¶ Ø¨Ù†Ø§ØªØ¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø§Ø¨Ù‚</h4>
                         <p class="text-center text-lg"><span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø³</span> + Ù©)</span></p>
                    </div>
                    <div class="step-interactive step-box">
                         <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù£: Ø§Ù„ØªÙˆØ²ÙŠØ¹</h4>
                         <p class="text-center text-sm md:text-base leading-loose"><span class="math-eq">(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¦<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù©<span class="var-green">Ø³</span>) + (Ù£<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù¨<span class="var-green">Ø³</span> + Ù¢Ù§)</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¬Ù…Ø¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡)</h4>
                        <p class="text-center font-bold text-xl"><span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¢Ù§<span class="var-green">Ø³</span> + Ù¢Ù§</span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>

            <div class="mt-4 text-center">
                <!-- UPDATED: Use .btn-theme -->
                <button onclick="switchTab('quiz')" class="btn-theme px-8 py-3 md:py-4 rounded-full text-sm md:text-lg font-bold shadow-lg flex items-center justify-center gap-2 mx-auto w-full max-w-xs animate-bounce"><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</span><i data-lucide="arrow-left"></i></button>
            </div>
        </div>

        <!-- [QUIZ TAB] -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…</h2><p class="text-xs md:text-sm text-gray-500">5 Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø£ØµÙ„ 15</p></div>
                    <div class="text-center"><div id="loading-attempts" class="hidden"><div class="loader w-4 h-4"></div></div><div id="attempts-display" class="flex flex-col items-center"><span class="block text-xl md:text-2xl font-bold" style="color: var(--theme-hex)" id="attempts-count">-</span><div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span></div></div><div id="timer-top-container" class="hidden mt-1"><span class="block text-xs font-bold text-red-500 font-mono" id="timer-display-top">00:00:00</span></div></div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto">
                    <div class="result-content"><p class="text-sm text-gray-600 font-bold mb-1">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p><p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p><div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div>
                    <div class="mt-4"><div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block"><span class="block text-lg font-bold text-red-600 font-mono tracking-wider" id="timer-display-bottom">00:00:00</span></div></div>
                    </div>
                </div>
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <h2 id="games-title" class="col-span-1 md:col-span-2 text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> Ø§Ø³ØªÙ…ØªØ¹ ÙˆØªØ¹Ù„Ù…</h2>
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"></div>
                </div>
            </div>
        </div>
        
        <footer class="lesson-footer"><p>ØªØµÙ…ÙŠÙ… ÙˆØ¥Ø¹Ø¯Ø§Ø¯: <strong>Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</strong></p><p class="mt-1 opacity-70">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</p></footer>
        <div class="h-20"></div>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 transform transition-transform duration-300 shadow-2xl"><div class="flex justify-between mb-4 items-center"><div class="flex items-center gap-2" style="color: var(--theme-hex)"><i id="modal-icon" data-lucide="info" class="w-5 h-5"></i><h3 id="modal-title" class="font-bold text-lg">ØªÙˆØ¶ÙŠØ­</h3></div><button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div></div></div>

    <!-- Game Modal Structure -->
    <div id="game-modal-container">
        <div id="game-modal-content">
            <div id="game-modal-header" class="text-white flex justify-between items-center py-1 px-3 shadow-md">
                <script>document.getElementById('game-modal-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
                <div class="flex items-center gap-2"><i class="fas fa-gamepad"></i><span id="game-modal-title" class="font-bold"></span></div>
                <div class="flex items-center gap-2">
                    <button onclick="minimizeGameModal()" class="win-btn" title="ØªØµØºÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„"><i class="fas fa-window-minimize relative bottom-1"></i></button>
                    <button onclick="toggleGameFullscreen()" class="win-btn" title="ØªÙƒØ¨ÙŠØ±/Ø§Ø³ØªØ¹Ø§Ø¯Ø©"><i id="game-max-icon" class="fas fa-window-maximize"></i></button>
                    <button onclick="closeGameModal()" class="win-btn win-btn-close" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <iframe id="game-frame" src=""></iframe>
        </div>
    </div>
    <div id="minimized-game-bar" onclick="restoreGameModal()" class="border-blue-600 text-blue-600"><i class="fas fa-gamepad"></i><span id="minimized-game-title">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ©...</span><i class="fas fa-chevron-up"></i></div>

    <script>
        // --- CONFIGURATION ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        
        // Use the LESSON_KEY defined in the Head script
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let timerInterval;
        let studentData = null; // Global store for user data

        const tabs = [
            { id: 'learn1', icon: 'book', label: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹' },
            { id: 'learn2', icon: 'layers', label: 'Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù…' },
            { id: 'learn3', icon: 'target', label: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª' },
            { id: 'learn4', icon: 'star', label: 'ØªØ­Ø¯ÙŠ' },
            { id: 'quiz', icon: 'clipboard-check', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' }
        ];

        const typeLabels = { 'learn1': 'Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨', 'learn2': 'Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹', 'learn3': 'ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©', 'learn4': 'ØªØ­Ø¯ÙŠ', 'mixed': 'Ù…Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø©' };

        // [QUESTION BANK: 15 Questions - Arabic Math - UPDATED EXPLANATIONS]
        // Updated 'e' to have vertical steps logic using flex-col and badges
        const questionBank = [
             // Concept 1: Binomial x Binomial (FOIL)
             { 
                 id: 101, type: 'learn1', 
                 t: 'Ø£ÙˆØ¬Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¶Ø±Ø¨: <span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span> + Ù¢)</span>', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¥<span class="var-green">Ø³</span> + Ù¦</span>', v:'a'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø³</span> + Ù¥</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¥<span class="var-green">Ø³</span> + Ù¥</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø³</span> + Ù¥</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠÙ†: Ø³ Ã— Ø³ = Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø·Ø±ÙÙŠÙ† (Ù¢Ø³) ÙˆØ§Ù„ÙˆØ³Ø·ÙŠÙ† (Ù£Ø³)</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡: Ù¢Ø³ + Ù£Ø³ = Ù¥Ø³</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø®ÙŠØ±ÙŠÙ†: Ù£ Ã— Ù¢ = Ù¦</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ø³Â² + Ù¥Ø³ + Ù¦</div></div></div>', 
                 smart: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø®ÙŠØ± Ù‡Ùˆ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ù£ Ã— Ù¢ = Ù¦ØŒ ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆØ³Ø· Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹Ù‡Ù…Ø§ Ù£ + Ù¢ = Ù¥.' 
             },
             { 
                 id: 102, type: 'learn1', 
                 t: 'Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨: <span class="math-eq">(<span class="var-green">Øµ</span> - Ù¤)(<span class="var-green">Øµ</span> + Ù¡)</span>', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Øµ</span><sup class="tiny-sup">Ù¢</sup> - Ù¤</span>', v:'a'}, 
                     {t:'<span class="math-eq"><span class="var-green">Øµ</span><sup class="tiny-sup">Ù¢</sup> - Ù¥<span class="var-green">Øµ</span> - Ù¤</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Øµ</span><sup class="tiny-sup">Ù¢</sup> - Ù£<span class="var-green">Øµ</span> - Ù¤</span>', v:'c'}, 
                     {t:'<span class="math-eq"><span class="var-green">Øµ</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="var-green">Øµ</span> - Ù¤</span>', v:'d'}
                 ], 
                 c: 'c', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ø§Ù„Ø£ÙˆÙ„ Ã— Ø§Ù„Ø£ÙˆÙ„ = ØµÂ²</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ø·Ø±ÙÙŠÙ†: Ù¡Øµ ØŒ Ø§Ù„ÙˆØ³Ø·ÙŠÙ†: -Ù¤Øµ</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø§Ù„Ø¬Ù…Ø¹: Ù¡Øµ + (-Ù¤Øµ) = -Ù£Øµ</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ø§Ù„Ø£Ø®ÙŠØ± Ã— Ø§Ù„Ø£Ø®ÙŠØ± = -Ù¤ Ã— Ù¡ = -Ù¤</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: ØµÂ² - Ù£Øµ - Ù¤</div></div></div>', 
                 smart: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø¯ÙŠÙ† Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨Ù‡Ù…Ø§ -Ù¤ ÙˆÙ…Ø¬Ù…ÙˆØ¹Ù‡Ù…Ø§ -Ù£.' 
             },
             { 
                 id: 103, type: 'learn1', 
                 t: 'Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ Ù‡Ùˆ ØªØ¨Ø³ÙŠØ· Ù„Ù€ <span class="math-eq">(Ù¢<span class="var-green">Ø£</span> + Ù¡)(<span class="var-green">Ø£</span> + Ù£)</span> ØŸ', 
                 o: [
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø£</span><sup class="tiny-sup">Ù¢</sup> + Ù§<span class="var-green">Ø£</span> + Ù£</span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø£</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø£</span> + Ù£</span>', v:'b'}, 
                     {t:'<span class="math-eq">Ù£<span class="var-green">Ø£</span><sup class="tiny-sup">Ù¢</sup> + Ù¤<span class="var-green">Ø£</span> + Ù£</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø£</span><sup class="tiny-sup">Ù¢</sup> + Ù£</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù¢Ø£ Ã— Ø£ = Ù¢Ø£Â²</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ø·Ø±ÙÙŠÙ† (Ù¦Ø£) + Ø§Ù„ÙˆØ³Ø·ÙŠÙ† (Ù¡Ø£)</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ = Ù§Ø£</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ù¡ Ã— Ù£ = Ù£</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ù¢Ø£Â² + Ù§Ø£ + Ù£</div></div></div>', 
                 smart: 'Ø§Ø¶Ø±Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø£ÙˆÙ„: Ù¢Ø£ Ã— Ø£ = Ù¢Ø£Â²ØŒ ÙˆØ§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ø£Ø®ÙŠØ±: Ù¡ Ã— Ù£ = Ù£.' 
             },

             // Concept 2: General / Trinomial
             { 
                 id: 201, type: 'learn2', 
                 t: 'Ø¹Ù†Ø¯ Ø¶Ø±Ø¨ Ø«Ù†Ø§Ø¦ÙŠØ© Ø­Ø¯ ÙÙŠ Ø«Ù„Ø§Ø«ÙŠØ© Ø­Ø¯ÙˆØ¯ØŒ ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø³ÙŠØ·ØŸ', 
                 o: [
                     {t:'Ù¥ Ø­Ø¯ÙˆØ¯', v:'a'}, 
                     {t:'Ù¦ Ø­Ø¯ÙˆØ¯', v:'b'}, 
                     {t:'Ù£ Ø­Ø¯ÙˆØ¯', v:'c'}, 
                     {t:'Ù© Ø­Ø¯ÙˆØ¯', v:'d'}
                 ], 
                 c: 'b', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø§Ù„ØªÙˆØ¶ÙŠØ­:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø¯ÙŠÙ† (Ù¢)</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø«Ù„Ø§Ø«Ø© Ø­Ø¯ÙˆØ¯ (Ù£)</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù£</span> <span>Ù†Ø¶Ø±Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¯ÙˆØ¯: Ù¢ Ã— Ù£ = Ù¦</span></div></div></div>', 
                 smart: 'Ø¹Ø¯Ø¯ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£ÙˆÙ„ Ã— Ø¹Ø¯Ø¯ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø«Ø§Ù†ÙŠ.' 
             },
             { 
                 id: 202, type: 'learn2', 
                 t: 'Ø£ÙˆØ¬Ø¯ Ù†Ø§ØªØ¬: <span class="math-eq">(<span class="var-green">Ø³</span> - Ù¡)(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + <span class="var-green">Ø³</span> + Ù¡)</span>', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> - Ù¡</span>', v:'a'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¡</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + <span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¡</span>', v:'c'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> - <span class="var-green">Ø³</span> + Ù¡</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>ØªÙˆØ²ÙŠØ¹ Ø³: Ø³Â³ + Ø³Â² + Ø³</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>ØªÙˆØ²ÙŠØ¹ -Ù¡: -Ø³Â² - Ø³ - Ù¡</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø§Ù„Ø¬Ù…Ø¹: (Ø³Â² - Ø³Â²) Ùˆ (Ø³ - Ø³) ÙŠØ°Ù‡Ø¨ÙˆÙ† Ø¨ØµÙØ±</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ø³Â³ - Ù¡</div></div></div>', 
                 smart: 'Ù‡Ø°Ù‡ Ù…ØªØ·Ø§Ø¨Ù‚Ø© Ø´Ù‡ÙŠØ±Ø©: Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ù…ÙƒØ¹Ø¨ÙŠÙ†.' 
             },
             { 
                 id: 203, type: 'learn2', 
                 t: 'Ù…Ø¹Ø§Ù…Ù„ <span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup></span> ÙÙŠ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ <span class="math-eq">(<span class="var-green">Ø³</span> + Ù¢)(Ù£<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¤<span class="var-green">Ø³</span> + Ù¡)</span> Ù‡Ùˆ:', 
                 o: [
                     {t:'Ù¡Ù ', v:'a'}, 
                     {t:'Ù¦', v:'b'}, 
                     {t:'Ù§', v:'c'}, 
                     {t:'Ù¡Ù¢', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¯:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù†Ø¨Ø­Ø« Ø¹Ù† Ø³Â²: (Ø³ Ã— Ù¤Ø³) = Ù¤Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø¨Ø­Ø« Ø¹Ù† Ø³Â²: (Ù¢ Ã— Ù£Ø³Â²) = Ù¦Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: Ù¤ + Ù¦ = Ù¡Ù </span></div></div></div>', 
                 smart: 'Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªÙŠ ØªØ¹Ø·ÙŠ Ø³Â² ÙˆØ§Ø¬Ù…Ø¹Ù‡Ø§.' 
             },

             // Concept 3: Real Life
             { 
                 id: 301, type: 'learn3', 
                 t: 'Ù…Ø³ØªØ·ÙŠÙ„ Ø·ÙˆÙ„Ù‡ <span class="math-eq">(<span class="var-green">Ø³</span> + Ù¥)</span> ÙˆØ¹Ø±Ø¶Ù‡ <span class="math-eq">(<span class="var-green">Ø³</span> - Ù¢)</span>. Ù…Ø§ Ù…Ø³Ø§Ø­ØªÙ‡ØŸ', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù£<span class="var-green">Ø³</span> - Ù¡Ù </span>', v:'a'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù£<span class="var-green">Ø³</span> - Ù¡Ù </span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù§<span class="var-green">Ø³</span> - Ù¡Ù </span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø³</span> + Ù£</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø¶Ø±Ø¨: (Ø³ + Ù¥)(Ø³ - Ù¢)</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø§Ù„ÙˆØ³Ø·ÙŠÙ† (Ù¥Ø³) + Ø§Ù„Ø·Ø±ÙÙŠÙ† (-Ù¢Ø³) = Ù£Ø³</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ø³Â² + Ù£Ø³ - Ù¡Ù </div></div></div>', 
                 smart: 'Ø·Ø¨Ù‚ Ù‚Ø§Ø¹Ø¯Ø© Ø¶Ø±Ø¨ Ø«Ù†Ø§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¯.' 
             },
             { 
                 id: 302, type: 'learn3', 
                 t: 'Ø­Ø¯ÙŠÙ‚Ø© Ù…Ø±Ø¨Ø¹Ø© Ø§Ù„Ø´ÙƒÙ„ Ø·ÙˆÙ„ Ø¶Ù„Ø¹Ù‡Ø§ <span class="math-eq">(Ù£<span class="var-green">Ø³</span> + Ù¢)</span>. Ù…Ø³Ø§Ø­ØªÙ‡Ø§ Ù‡ÙŠ:', 
                 o: [
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¤</span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø³</span> + Ù¤</span>', v:'b'}, 
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù¢<span class="var-green">Ø³</span> + Ù¤</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¦<span class="var-green">Ø³</span> + Ù¤</span>', v:'d'}
                 ], 
                 c: 'c', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹ = (Ø§Ù„Ø¶Ù„Ø¹)Â²</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„: (Ù£Ø³)Â² = Ù©Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù¢ Ã— Ø§Ù„Ø£ÙˆÙ„ Ã— Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù¢ Ã— Ù£Ø³ Ã— Ù¢ = Ù¡Ù¢Ø³</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: (Ù¢)Â² = Ù¤</span></div></div></div>', 
                 smart: 'ØªØ°ÙƒØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: (Ø£+Ø¨)Â² = Ø£Â² + Ù¢Ø£Ø¨ + Ø¨Â²' 
             },
             { 
                 id: 303, type: 'learn3', 
                 t: 'Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø³Ø§Ø­Ø© Ù…Ø«Ù„Ø« Ù‡ÙŠ <span class="math-eq"><span class="fraction"><span>Ù¡</span><span class="bar"></span><span>Ù¢</span></span> Ù‚ Ø¹</span>ØŒ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø¯Ø© <span class="math-eq">(Ù¢<span class="var-green">Ø³</span> + Ù¤)</span> ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ <span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)</span>ØŒ ÙØ¥Ù† Ø§Ù„Ù…Ø³Ø§Ø­Ø©:', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¥<span class="var-green">Ø³</span> + Ù¦</span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù <span class="var-green">Ø³</span> + Ù¡Ù¢</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù§<span class="var-green">Ø³</span> + Ù¡Ù¢</span>', v:'c'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¦<span class="var-green">Ø³</span> + Ù¥</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù†ØµÙ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: Ù¡/Ù¢(Ù¢Ø³ + Ù¤) = Ø³ + Ù¢</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø¶Ø±Ø¨ Ù†ØµÙ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>(Ø³ + Ù¢)(Ø³ + Ù£)</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ø³Â² + Ù¥Ø³ + Ù¦</div></div></div>', 
                 smart: 'Ø¨Ø³Ø· Ø§Ù„Ù†ØµÙ Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø²ÙˆØ¬ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¶Ø±Ø¨.' 
             },

             // Concept 4: Challenge
             { 
                 id: 401, type: 'learn4', 
                 t: 'Ù…Ø§ Ù‚ÙŠÙ…Ø© <span class="math-eq">Ø¬Ù€</span> Ø§Ù„ØªÙŠ ØªØ¬Ø¹Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© ØµØ­ÙŠØ­Ø©: <span class="math-eq">(<span class="var-green">Ø³</span> + Ù£)(<span class="var-green">Ø³</span> + Ø¬Ù€) = <span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¢<span class="var-green">Ø³</span> - Ù¡Ù¥</span>', 
                 o: [
                     {t:'-Ù¥', v:'a'}, 
                     {t:'Ù¥', v:'b'}, 
                     {t:'-Ù¢', v:'c'}, 
                     {t:'-Ù¡Ù¥', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù‡Ùˆ -Ù¡Ù¥</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø¹Ù„Ù… Ø£Ù† Ø§Ù„Ø£Ø®ÙŠØ± ÙŠØ£ØªÙŠ Ù…Ù† Ù£ Ã— Ø¬Ù€</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø¥Ø°Ù† Ù£ Ã— Ø¬Ù€ = -Ù¡Ù¥</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ø¨Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ù£: Ø¬Ù€ = -Ù¥</span></div></div></div>', 
                 smart: 'Ø§Ù†Ø¸Ø± Ù„Ù„Ø­Ø¯ Ø§Ù„Ø«Ø§Ø¨Øª: Ù…Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø°ÙŠ ØªØ¶Ø±Ø¨Ù‡ ÙÙŠ Ù£ ÙŠØ¹Ø·ÙŠÙƒ -Ù¡Ù¥ØŸ' 
             },
             { 
                 id: 402, type: 'learn4', 
                 t: 'Ù†Ø§ØªØ¬ <span class="math-eq">(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡)(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¡)</span> Ù‡Ùˆ:', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¤</sup> - Ù¡</span>', v:'a'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¤</sup> + Ù¡</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¤</sup> - Ù¢<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡</span>', v:'c'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span> - Ù¡</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ù…Ø±Ø¨Ø¹ÙŠÙ†</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: (Ø£+Ø¨)(Ø£-Ø¨) = Ø£Â² - Ø¨Â²</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù‡Ù†Ø§ Ø£ = Ø³Â²ØŒ Ø¨ = Ù¡</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: (Ø³Â²)Â² - Ù¡Â² = Ø³â´ - Ù¡</div></div></div>', 
                 smart: 'Ù…Ø¬Ù…ÙˆØ¹ Ø­Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ†Ù‡Ù…Ø§ = Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„ - Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ.' 
             },
             { 
                 id: 403, type: 'learn4', 
                 t: 'Ø¯Ø±Ø¬Ø© ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬Ø© Ù…Ù† Ø¶Ø±Ø¨ <span class="math-eq">(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¡)</span> ÙÙŠ <span class="math-eq">(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¤)</span> Ù‡ÙŠ:', 
                 o: [
                     {t:'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©', v:'a'}, 
                     {t:'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ø§Ø¯Ø³Ø©', v:'b'}, 
                     {t:'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©', v:'c'}, 
                     {t:'Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù†Ø­Ø¯Ø¯ Ø£ÙƒØ¨Ø± Ø£Ø³ ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£ÙˆÙ„: Ù£</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù†Ø­Ø¯Ø¯ Ø£ÙƒØ¨Ø± Ø£Ø³ ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù¢</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ù£ + Ù¢ = Ù¥ (Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©)</div></div></div>', 
                 smart: 'Ø§Ø¬Ù…Ø¹ Ø£ÙƒØ¨Ø± Ø£Ø³ ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¹ Ø£ÙƒØ¨Ø± Ø£Ø³ ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø«Ø§Ù†ÙŠ.' 
             },

             // Mixed
             { 
                 id: 501, type: 'mixed', 
                 t: 'Ø£ÙˆØ¬Ø¯ <span class="math-eq">(Ù£<span class="var-green">Ø³</span> - Ù¤)</span><sup class="tiny-sup">Ù¢</sup>', 
                 o: [
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¡Ù¦</span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¢Ù¤<span class="var-green">Ø³</span> + Ù¡Ù¦</span>', v:'b'}, 
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¡Ù¢<span class="var-green">Ø³</span> + Ù¡Ù¦</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù©<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¢Ù¤<span class="var-green">Ø³</span> + Ù¡Ù¦</span>', v:'d'}
                 ], 
                 c: 'b', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„ - Ù¢Ã—Ø§Ù„Ø£ÙˆÙ„Ã—Ø§Ù„Ø«Ø§Ù†ÙŠ + Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ø£ÙˆÙ„Â²: (Ù£Ø³)Â² = Ù©Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ø§Ù„ÙˆØ³Ø·: -Ù¢ Ã— Ù£Ø³ Ã— Ù¤ = -Ù¢Ù¤Ø³</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ø§Ù„Ø«Ø§Ù†ÙŠÂ²: (-Ù¤)Â² = Ù¡Ù¦</span></div></div></div>', 
                 smart: 'ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆØ³Ø· (Ø³Ø§Ù„Ø¨) ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø®ÙŠØ± (Ù…ÙˆØ¬Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„ØªØ±Ø¨ÙŠØ¹).' 
             },
             { 
                 id: 502, type: 'mixed', 
                 t: 'Ù†Ø§ØªØ¬ <span class="math-eq">Ù¥<span class="var-green">Ø³</span>(<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¢<span class="var-green">Ø³</span> - Ù¡)</span>', 
                 o: [
                     {t:'<span class="math-eq">Ù¥<span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¡Ù <span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> - Ù¥<span class="var-green">Ø³</span></span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù¥<span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¡Ù <span class="var-green">Ø³</span> - Ù¥</span>', v:'b'}, 
                     {t:'<span class="math-eq">Ù¥<span class="var-green">Ø³</span><sup class="tiny-sup">Ù£</sup> + Ù¢<span class="var-green">Ø³</span> - Ù¡</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¥<span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù <span class="var-green">Ø³</span> - Ù¥</span>', v:'d'}
                 ], 
                 c: 'a', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ù†ÙˆØ²Ø¹ Ù¥Ø³ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ù¥Ø³ Ã— Ø³Â² = Ù¥Ø³Â³</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù¥Ø³ Ã— Ù¢Ø³ = Ù¡Ù Ø³Â²</span></div><div class="flex items-center gap-2"><span class="bg-purple-100 text-purple-800 px-2 rounded font-bold">Ù¤</span> <span>Ù¥Ø³ Ã— -Ù¡ = -Ù¥Ø³</span></div></div></div>', 
                 smart: 'Ù„Ø§ ØªÙ†Ø³ Ø¶Ø±Ø¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: Ø³ Ã— Ø³Â² = Ø³Â³.' 
             },
             { 
                 id: 503, type: 'mixed', 
                 t: 'Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø¨Ø± Ø¹Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø´ÙƒÙ„: (Ø·ÙˆÙ„ <span class="math-eq">Ø³+Ù¤</span>ØŒ Ø¹Ø±Ø¶ <span class="math-eq">Ø³+Ù¤</span>)', 
                 o: [
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¡Ù¦</span>', v:'a'}, 
                     {t:'<span class="math-eq">Ù¢<span class="var-green">Ø³</span> + Ù¨</span>', v:'b'}, 
                     {t:'<span class="math-eq"><span class="var-green">Ø³</span><sup class="tiny-sup">Ù¢</sup> + Ù¨<span class="var-green">Ø³</span> + Ù¡Ù¦</span>', v:'c'}, 
                     {t:'<span class="math-eq">Ù¤<span class="var-green">Ø³</span> + Ù¡Ù¦</span>', v:'d'}
                 ], 
                 c: 'c', 
                 e: '<div class="step-box text-right"><p class="font-bold border-b mb-2 pb-1 text-blue-700">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</p><div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-800 px-2 rounded font-bold">Ù¡</span> <span>Ø§Ù„Ø´ÙƒÙ„ Ù…Ø±Ø¨Ø¹ Ù„Ø£Ù† Ø§Ù„Ø·ÙˆÙ„ = Ø§Ù„Ø¹Ø±Ø¶</span></div><div class="flex items-center gap-2"><span class="bg-green-100 text-green-800 px-2 rounded font-bold">Ù¢</span> <span>Ø§Ù„Ù…Ø³Ø§Ø­Ø© = (Ø³+Ù¤)Â²</span></div><div class="flex items-center gap-2"><span class="bg-orange-100 text-orange-800 px-2 rounded font-bold">Ù£</span> <span>Ù†ÙÙƒ Ø§Ù„ØªØ±Ø¨ÙŠØ¹: Ø³Â² + Ù¢(Ù¤)Ø³ + Ù¤Â²</span></div><div class="mt-2 font-bold bg-gray-50 p-2 rounded border border-gray-200 text-center">Ø§Ù„Ù†Ø§ØªØ¬: Ø³Â² + Ù¨Ø³ + Ù¡Ù¦</div></div></div>', 
                 smart: 'Ø§Ù„ÙˆØ³Ø·ÙŠÙ†: Ù¤Ø³ + Ù¤Ø³ = Ù¨Ø³.' 
             }
        ];

        // --- CORE FUNCTIONS ---
        const urlParams = new URLSearchParams(window.location.search);
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabId}`);
            const navEl = document.getElementById(`nav-${tabId}`);
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') {
                if(document.getElementById('quizForm').innerHTML === '') { generateQuiz(); }
                renderDynamicGames(); 
                const sId = urlParams.get('studentId');
                if(sId && sId !== 'visitor') fetchStudentData();
            }
        }

        // --- GAME MODAL LOGIC (FIXED CONTROLS) ---
        function openGameModal(url, title) {
            const modal = document.getElementById('game-modal-container');
            const iframe = document.getElementById('game-frame');
            iframe.src = url;
            document.getElementById('game-modal-title').textContent = title || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            modal.style.display = 'flex';
            document.getElementById('minimized-game-bar').style.display = 'none';
        }
        function closeGameModal() { 
            const modal = document.getElementById('game-modal-container');
            modal.style.display = 'none'; 
            document.getElementById('game-frame').src = ''; 
            // Reset state
            document.getElementById('game-modal-content').classList.remove('fullscreen');
            document.getElementById('game-max-icon').className = 'fas fa-window-maximize';
        }
        function toggleGameFullscreen() { 
            const content = document.getElementById('game-modal-content');
            const icon = document.getElementById('game-max-icon');
            content.classList.toggle('fullscreen');
            if(content.classList.contains('fullscreen')) {
                icon.className = 'fas fa-compress';
            } else {
                icon.className = 'fas fa-window-maximize';
            }
        }
        function minimizeGameModal() { 
            document.getElementById('game-modal-container').style.display = 'none'; 
            document.getElementById('minimized-game-bar').style.display = 'flex'; 
        }
        function restoreGameModal() { 
            document.getElementById('game-modal-container').style.display = 'flex'; 
            document.getElementById('minimized-game-bar').style.display = 'none'; 
        }

        function initInteractive() {
            // GENERIC INTERACTIVE LOGIC (for Tab 3, 4)
            document.querySelectorAll('[id^="interactive-container-"]:not(#foil-interactive-zone):not(#foil-interactive-zone-2)').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive');
                const placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                let current = -1;
                const update = () => {
                    if(!prevBtn) return;
                    prevBtn.disabled = current === -1;
                    if (current === -1) placeholder.classList.remove('hidden'); else placeholder.classList.add('hidden');
                    steps.forEach((s, i) => { if (i <= current) s.classList.add('active'); else s.classList.remove('active'); });
                    if (current >= steps.length - 1) { nextBtn.classList.add('hidden'); resetBtn.classList.remove('hidden'); } 
                    else { nextBtn.classList.remove('hidden'); resetBtn.classList.add('hidden'); }
                };
                if(nextBtn) nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
                if(prevBtn) prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
                update();
            });

            // DISTRIBUTION APPS LOGIC (App 1, 2, 3) - Custom Steps
            // Updated App 1, 2, 3 to have 4 steps (New Grouping Step)
            const setupDistApp = (idPrefix, maxSteps) => {
                const container = document.getElementById(`dist-interactive-${idPrefix}`);
                if (!container) return;
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                const placeholder = document.getElementById(`dist-${idPrefix}-placeholder`);
                let currentStep = 0;

                const updateDist = () => {
                    // Placeholder logic
                    if (currentStep === 0) placeholder.classList.remove('hidden');
                    else placeholder.classList.add('hidden');

                    // Steps visibility
                    for(let i=1; i<=maxSteps; i++) {
                        const stepEl = document.getElementById(`dist-${idPrefix}-step${i}`);
                        if(stepEl) {
                            if(i <= currentStep) stepEl.classList.add('visible');
                            else stepEl.classList.remove('visible');
                        }
                    }

                    // Buttons
                    prevBtn.disabled = currentStep === 0;
                    if (currentStep === maxSteps) {
                        nextBtn.classList.add('hidden');
                        resetBtn.classList.remove('hidden');
                    } else {
                        nextBtn.classList.remove('hidden');
                        resetBtn.classList.add('hidden');
                    }
                };

                nextBtn.onclick = () => { if(currentStep < maxSteps) { currentStep++; updateDist(); } };
                prevBtn.onclick = () => { if(currentStep > 0) { currentStep--; updateDist(); } };
                resetBtn.onclick = () => { currentStep = 0; updateDist(); };
                updateDist();
            };

            setupDistApp('1', 4); // All apps now have 4 steps
            setupDistApp('2', 4); 
            setupDistApp('3', 4); 


            // CUSTOM FOIL INTERACTIVE LOGIC (Tab 1 - App 1 & 2)
            const setupFoilApp = (suffix) => {
                const foilBtn = document.getElementById(`foil-action-btn${suffix}`);
                const foilReset = document.getElementById(`foil-reset-btn${suffix}`);
                if(!foilBtn) return;

                let foilStep = 0;
                
                // Define terms and labels based on suffix
                const s = suffix; // e.g. "" or "-2"
                
                const steps = [
                    // Step 1: First x First
                    () => {
                        highlightTerms(`term-f1${s}`, `term-f2${s}`, 'foil-highlight-1');
                        const val = s === '-2' ? 'Ù¢Ø³Â²' : 'Ù¢Ø³Â²'; 
                        activateBox(`foil-box-1${s}`, `label-box-1${s}`, val);
                    },
                    // Step 2: Last x Last (Priority moved up)
                    () => {
                         highlightTerms(`term-l1${s}`, `term-l2${s}`, 'foil-highlight-2');
                         const val = s === '-2' ? '-Ù¡Ù¢' : 'Ù¡Ù¥';
                         activateBox(`foil-box-4${s}`, `label-box-4${s}`, val);
                    },
                    // Step 3: Outer x Outer
                    () => {
                         highlightTerms(`term-f1${s}`, `term-l2${s}`, 'foil-highlight-2');
                         const val = s === '-2' ? 'Ù£Ø³' : 'Ù¡Ù Ø³';
                         activateBox(`foil-box-2${s}`, `label-box-2${s}`, val);
                    },
                    // Step 4: Inner x Inner + Show Intermediate Step (NEW)
                    () => {
                         highlightTerms(`term-l1${s}`, `term-f2${s}`, 'foil-highlight-1');
                         const val = s === '-2' ? '-Ù¨Ø³' : 'Ù£Ø³';
                         activateBox(`foil-box-3${s}`, `label-box-3${s}`, val);
                         
                         // Show Intermediate Result with Highlighted Like Terms
                         document.getElementById(`foil-intermediate-result${s}`).classList.remove('hidden', 'opacity-0', 'translate-y-4');
                         foilBtn.textContent = 'Ø¬Ù…Ø¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡';
                    },
                    // Step 5: Final Result (NEW)
                    () => {
                         document.getElementById(`foil-final-result${s}`).classList.remove('hidden', 'opacity-0', 'translate-y-4');
                         foilBtn.textContent = 'Ø£Ø­Ø³Ù†Øª!';
                         foilBtn.disabled = true;
                         foilBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                ];

                foilBtn.onclick = () => {
                    if(foilStep < steps.length) {
                        steps[foilStep]();
                        foilStep++;
                        if (foilStep === 1) {
                            foilBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ';
                            foilReset.disabled = false;
                            document.getElementById(`foil-instruction${s}`).classList.add('hidden');
                        }
                    }
                };

                foilReset.onclick = () => {
                    foilStep = 0;
                    resetFoilViz(s);
                    foilBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ø±Ø¨';
                    foilBtn.disabled = false;
                    foilBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    foilReset.disabled = true;
                    document.getElementById(`foil-instruction${s}`).classList.remove('hidden');
                }
            };

            setupFoilApp('');
            setupFoilApp('-2');
        }
        
        function highlightTerms(id1, id2, highlightClass) {
            document.querySelectorAll('.foil-term').forEach(el => el.classList.remove('foil-highlight-1', 'foil-highlight-2'));
            const t1 = document.getElementById(id1);
            const t2 = document.getElementById(id2);
            if(t1) t1.classList.add(highlightClass);
            if(t2) t2.classList.add(highlightClass);
        }

        function activateBox(boxId, labelId, value) {
            document.querySelectorAll('.foil-box').forEach(el => el.classList.remove('active-slot'));
            const box = document.getElementById(boxId);
            const label = document.getElementById(labelId);
            if(box) { box.textContent = value; box.classList.add('filled', 'active-slot'); }
            if(label) label.classList.remove('opacity-0');
        }

        function resetFoilViz(suffix) {
             const s = suffix || '';
             // Reset specific containers terms
             const container = document.getElementById(s === '-2' ? 'foil-interactive-zone-2' : 'foil-interactive-zone');
             container.querySelectorAll('.foil-term').forEach(el => el.classList.remove('foil-highlight-1', 'foil-highlight-2'));
             
             // Reset boxes
             for(let i=1; i<=4; i++) {
                 const box = document.getElementById(`foil-box-${i}${s}`);
                 const label = document.getElementById(`label-box-${i}${s}`);
                 if(box) { box.textContent = 'ØŸ'; box.classList.remove('filled', 'active-slot'); }
                 if(label) label.classList.add('opacity-0');
             }
             const intermediate = document.getElementById(`foil-intermediate-result${s}`);
             const final = document.getElementById(`foil-final-result${s}`);
             
             intermediate.classList.add('hidden', 'opacity-0', 'translate-y-4');
             final.classList.add('hidden', 'opacity-0', 'translate-y-4');
        }
        
        async function saveScoreToBackend(lessonId, grade) {
            const sId = urlParams.get('studentId');
            const cId = urlParams.get('classId');
            const saveStatus = document.getElementById('save-status');
            if (!sId || !cId) { if(saveStatus) saveStatus.innerHTML = '<span class="text-yellow-600">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø²Ø§Ø¦Ø±)</span>'; return; }
            if(saveStatus) saveStatus.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©...</span>';
            const requestUrl = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            let success = false;
            for(let i=0; i<3; i++) { try { await fetch(requestUrl); success = true; break; } catch (error) { await new Promise(r => setTimeout(r, 1500)); } }
            if(success) { if(saveStatus) saveStatus.innerHTML = '<span class="text-green-600 font-bold">âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­!</span>'; setTimeout(() => fetchStudentData(), 1000); } 
            else { if(saveStatus) saveStatus.innerHTML = '<span class="text-red-600 font-bold">âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</span>'; }
        }
        
        async function fetchStudentData() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') return;
            document.getElementById('loading-attempts').classList.remove('hidden');
            document.getElementById('attempts-display').classList.add('hidden');
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url);
                const json = await response.json();
                
                // Store global data
                studentData = json;

                if (json.status === "success" && json.data) {
                    let d = json.data.lessons && json.data.lessons[LESSON_KEY] ? json.data.lessons[LESSON_KEY] : { attempts: 0, grade: 0 };
                    attemptsLeft = Math.max(0, 3 - (d.attempts || 0));
                    if (attemptsLeft === 0 && d.waitTime > 0) { startTimer(Date.now() + d.waitTime); }
                    if (d.grade > 0) { document.getElementById('student-score').textContent = d.grade; document.getElementById('header-score-badge').classList.remove('hidden'); }
                    // Update name again just in case server has better data
                    if (json.data.name) document.getElementById('student-name').textContent = json.data.name;
                    
                    // Trigger game updates if they are rendered
                    syncGamesWithData();
                }
            } catch (e) { console.error(e); } finally { updateAttemptsUI(); document.getElementById('loading-attempts').classList.add('hidden'); document.getElementById('attempts-display').classList.remove('hidden'); }
        }

        function initAttempts() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') { 
                const visitorAttempts = localStorage.getItem(ATTEMPTS_KEY + '_visitor');
                if (visitorAttempts !== null) { attemptsLeft = parseInt(visitorAttempts); } else { attemptsLeft = 1; }
                const nextAttempt = localStorage.getItem(NEXT_ATTEMPT_KEY + '_visitor');
                if (nextAttempt && parseInt(nextAttempt) > Date.now()) { startTimer(parseInt(nextAttempt)); attemptsLeft = 0; }
                updateAttemptsUI(); 
            } 
            else { attemptsLeft = 0; updateAttemptsUI(); fetchStudentData(); }
        }
        
        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);
            const btn = document.getElementById('quiz-action-btn');
            if (!btn) return;
            const resultsVisible = !document.getElementById('quiz-results').classList.contains('hidden');
            if (resultsVisible) {
                if (attemptsLeft > 0) {
                    btn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"; btn.disabled = false; btn.type = "button"; btn.onclick = resetQuizView; 
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); 
                    btn.classList.add('btn-theme'); // Use theme class
                } else {
                    btn.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª"; btn.disabled = true; 
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed'); 
                    btn.classList.remove('btn-theme'); // Remove theme color
                }
            } else {
                btn.onclick = null; 
                if (attemptsLeft > 0) {
                    btn.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª"; btn.disabled = false; btn.type = "submit"; 
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); 
                    btn.classList.add('btn-theme'); // Use theme class
                } else {
                    btn.textContent = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø³ØªÙ†ÙØ°Ø©"; btn.disabled = true; 
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed'); 
                    btn.classList.remove('btn-theme'); // Remove theme color
                }
            }
        }

        function startTimer(target) {
             clearInterval(timerInterval);
             document.getElementById('timer-top-container').classList.remove('hidden'); 
             document.getElementById('timer-bottom-container').classList.remove('hidden'); // Fixed: Show bottom timer too
             timerInterval = setInterval(() => {
                const diff = target - Date.now();
                if (diff <= 0) { clearInterval(timerInterval); location.reload(); return; } 
                const t = new Date(diff).toISOString().substr(11, 8).replace(/\d/g, d=>"Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
                document.getElementById('timer-display-top').textContent = t; 
                document.getElementById('timer-display-bottom').textContent = t; // Fixed: Update bottom timer
             }, 1000);
        }

        function generateQuiz() { 
            currentQuestions = [];
            const requiredTypes = ['learn1', 'learn2', 'learn3', 'learn4', 'mixed'];
            requiredTypes.forEach(type => {
                const pool = questionBank.filter(q => q.type === type);
                // The user requested 5 random questions from the 15.
                // However, to ensure distribution, I will pick 1 from each type (since I have 5 types).
                // Or I can pick randomly from the whole pool if desired. 
                // Given the prompt "15 questions, show 5 randomly based on topics", 
                // picking 1 from each type guarantees full coverage.
                if(pool.length > 0) {
                    const randomQ = pool[Math.floor(Math.random() * pool.length)];
                    currentQuestions.push(randomQ);
                }
            });
            renderQuiz(); 
        }

        function renderQuiz() {
            const f = document.getElementById('quizForm');
            if(!f) return;
            let h = '';
            currentQuestions.forEach((q, i) => {
                h += `<div class="border border-gray-200 rounded-xl p-4 bg-white mb-6 hover:shadow-sm transition">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] md:text-xs font-bold">Ø³Ø¤Ø§Ù„ ${convertToArabic(i+1)}</span>
                                <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1"><i class="fas fa-tag text-xs"></i> ${typeLabels[q.type] || 'Ø¹Ø§Ù…'}</span>
                            </div>
                            <p class="font-bold text-gray-800 text-sm md:text-lg leading-6 mt-1">${q.t}</p>
                        </div>
                        <div class="options-grid">${q.o.map((o, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${o.v}" class="hidden"><label for="q${i}o${oi}" class="option-label shadow-sm">${o.t}</label></div>`).join('')}</div>
                        <div id="feedback-${i}" class="hidden p-3 rounded-lg mt-2 font-bold"></div>
                        <div id="actions-${i}" class="hidden mt-3 flex flex-wrap gap-2 items-center">
                             <button type="button" onclick="showExplain(${i})" class="text-xs md:text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 flex items-center gap-1 transition"><i data-lucide="help-circle" class="w-3 h-3"></i> Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                             <button type="button" onclick="showSmart(${i})" class="text-xs md:text-sm bg-purple-50 text-purple-600 px-3 py-2 rounded-lg hover:bg-purple-100 flex items-center gap-1 transition"><i data-lucide="lightbulb" class="w-3 h-3"></i> Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ</button>
                             <button type="button" onclick="switchTab('${q.type.replace('mixed','learn4')}')" class="text-xs md:text-sm border border-gray-200 text-gray-500 px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-1 transition mr-auto"><i data-lucide="book-open" class="w-3 h-3"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³</button>
                        </div>
                      </div>`;
            });
            h += '<button type="submit" id="quiz-action-btn" class="btn-theme w-full font-bold py-3 rounded-xl shadow-lg transition">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>';
            f.innerHTML = h;
            f.onsubmit = handleQuizSubmit;
            lucide.createIcons(); 
        }

        function handleQuizSubmit(e) {
            e.preventDefault();
            if (attemptsLeft <= 0) return;
            attemptsLeft--;
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.setItem(ATTEMPTS_KEY + '_visitor', attemptsLeft);
                if (attemptsLeft === 0) { 
                    const nextTime = Date.now() + COOLDOWN_MS;
                    localStorage.setItem(NEXT_ATTEMPT_KEY + '_visitor', nextTime);
                    startTimer(nextTime); 
                }
            } else { if (attemptsLeft === 0) startTimer(Date.now() + COOLDOWN_MS); }

            let score = 0;
            currentQuestions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                const fb = document.getElementById(`feedback-${i}`);
                const acts = document.getElementById(`actions-${i}`);
                if(sel && sel.value === q.c) { score++; fb.innerHTML = 'âœ” Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©'; fb.className = 'block bg-green-50 text-green-700 p-3 rounded-lg mt-2 font-bold border border-green-100'; } 
                else { fb.innerHTML = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'; fb.className = 'block bg-red-50 text-red-700 p-3 rounded-lg mt-2 font-bold border border-red-100'; }
                acts.classList.remove('hidden');
                document.querySelectorAll(`input[name="q${i}"]`).forEach(inp => inp.disabled = true);
            });
            
            saveScoreToBackend(LESSON_KEY, score * 2);
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${convertToArabic(score * 2)} / Ù¡Ù `;
            updateAttemptsUI();
        }

        function resetQuizView() {
            document.getElementById('quiz-results').classList.add('hidden');
            generateQuiz(); 
            document.getElementById('tab-quiz').scrollIntoView({behavior: 'smooth'});
            const sId = urlParams.get('studentId');
            if(sId && sId !== 'visitor') fetchStudentData();
            else updateAttemptsUI();
        }

        // --- PLATINUM LOGIC REVISED (Not Played Handling) ---
        function getParam(key) {
            const val = urlParams.get(key);
            return (val !== null && val.trim() !== '') ? val : null;
        }

        function renderDynamicGames() {
            const container = document.getElementById('dynamic-games-container');
            if (!container) return;
            container.innerHTML = '';
            
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/);
            if (!match) return; 
            const ch = match[1]; 
            const ls = match[2]; 
            
            const gamesDefaults = [
                { suffix: '1', defaultTitle: 'Ù„Ø¹Ø¨Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø¯ÙˆØ¯', icon: 'fa-gamepad', defaultMax: 5 },
                { suffix: '2', defaultTitle: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„Ø³Ø±ÙŠØ¹', icon: 'fa-trophy', defaultMax: 5 }
            ];

            const sId = urlParams.get('studentId') || '';
            const cId = urlParams.get('classId') || '';
            
            gamesDefaults.forEach((gDef, idx) => {
                const i = idx + 1; 
                const gameId = `g${ch}_${ls}_${gDef.suffix}`; 
                
                // Get Title ONLY from URL (Ignore Score from URL as per user request)
                const title = getParam(`g${i}_title`) || getParam(`${gameId}_title`) || gDef.defaultTitle;
                const max = parseInt(getParam(`g${i}_max`)) || gDef.defaultMax;
                
                // IDs for async update
                const cardId = `game-card-${i}`;
                const statusId = `game-status-${i}`;
                const iconId = `game-icon-${i}`;
                
                const gameUrl = `https://ablan-math.github.io/games/${gameId}.html?studentId=${sId}&classId=${cId}`;
                
                // Default: Unplayed state (Theme Color)
                let iconHtml = `<div id="${iconId}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors" style="background-color: ${currentTheme.hex}15; color: ${currentTheme.hex}"><i class="fas ${gDef.icon}"></i></div>`;
                let statusText = "Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡";

                container.innerHTML += `
                <div id="${cardId}" class="p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition bg-white border-gray-200" 
                     onclick="openGameModal('${gameUrl}', '${title}')">
                    ${iconHtml}
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-800 text-sm">${title}</span>
                        <span id="${statusId}" class="text-[10px] font-bold opacity-70">${statusText}</span>
                    </div>
                </div>`;
            });
            document.getElementById('games-wrapper').classList.remove('hidden');
            
            // Trigger Sync
            if(sId && sId !== 'visitor') {
                syncGamesWithData();
            }
        }

        function syncGamesWithData() {
            if (!studentData || !studentData.data) return;

            // Extract relevant game IDs based on Lesson Key
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/);
            if (!match) return;
            const ch = match[1];
            const ls = match[2];
            const gameIds = [`g${ch}_${ls}_1`, `g${ch}_${ls}_2`];
            const maxScores = [5, 5]; // Default max

            gameIds.forEach((gameId, idx) => {
                const i = idx + 1;
                const cardId = `game-card-${i}`;
                const statusId = `game-status-${i}`;
                const iconId = `game-icon-${i}`;

                // Search priority: games -> lessons -> root
                let data = null;
                if (studentData.data.games && studentData.data.games[gameId]) {
                    data = studentData.data.games[gameId];
                } else if (studentData.data.lessons && studentData.data.lessons[gameId]) {
                    data = studentData.data.lessons[gameId];
                } else if (studentData.data[gameId]) {
                    data = studentData.data[gameId];
                }

                // If data exists, update. If not, it stays default (Unplayed).
                if (data && data.grade !== undefined && data.grade !== null) {
                    const score = parseFloat(data.grade);
                    updateGameCard(score, maxScores[idx], cardId, statusId, iconId);
                } else {
                    // Explicitly reset to default if data is missing or null
                    updateGameCard(null, maxScores[idx], cardId, statusId, iconId);
                }
            });
        }

        function updateGameCard(score, max, cardId, statusId, iconId) {
            const card = document.getElementById(cardId);
            const status = document.getElementById(statusId);
            const iconContainer = document.getElementById(iconId);
            
            if(!card || !status) return;

            // Reset base classes first
            card.className = "p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition bg-white border-gray-200";
            
            let iconHtml = '';
            let statusText = '';
            let iconClass = '';

            // [LOGIC UPDATE V16.3] Handle "Not Played" (null) vs "Played but 0"
            if (score === null) {
                // Case: Not Played Yet -> Reset to Default
                // [VISUAL FIX] Force unified icon 'fa-gamepad' for unplayed state
                const defIcon = 'fa-gamepad';
                
                iconHtml = `<i class="fas ${defIcon}"></i>`;
                statusText = "Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡";
                // Theme color styling
                iconContainer.style.backgroundColor = `${currentTheme.hex}15`;
                iconContainer.style.color = currentTheme.hex;
                iconClass = "w-10 h-10 rounded-full flex items-center justify-center transition-colors";
                
                // Ensure container styles are applied
                iconContainer.innerHTML = iconHtml;
                iconContainer.className = iconClass;
                return; // Exit early for unplayed state
                
            } else if (score >= max) {
                // Full Mark -> Gold
                card.className = "p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition result-card-trophy";
                iconHtml = `<i class="fas fa-trophy"></i>`;
                statusText = `Ø£Ø­Ø³Ù†Øª! (${score}/${max})`;
                iconClass = "w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center";
                iconContainer.style = "";
            } else if (score >= max / 2) {
                // Half or more -> Yellow
                card.className = "p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition result-card-star";
                iconHtml = `<i class="fas fa-star"></i>`;
                statusText = `Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ (${score}/${max})`;
                iconClass = "w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center";
                iconContainer.style = "";
            } else {
                // Less than half (Played) -> Red
                card.className = "p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition result-card-retry";
                iconHtml = `<i class="fas fa-redo"></i>`;
                statusText = `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (${score}/${max})`;
                iconClass = "w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center";
                iconContainer.style = "";
            }
            
            status.textContent = statusText;
            iconContainer.innerHTML = iconHtml;
            iconContainer.className = iconClass;
        }

        function showExplain(i) { document.getElementById('modal-content').innerHTML = currentQuestions[i].e; document.getElementById('modal').classList.remove('hidden'); }
        function showSmart(i) { document.getElementById('modal-content').innerHTML = `<p class="font-bold text-purple-700 mb-2">ğŸ’¡ Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ:</p>${currentQuestions[i].smart}`; document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = function() {
            if(window.__lessonTitle) {
               const titleEl = document.getElementById('lesson-title-text');
               if(titleEl) titleEl.textContent = window.__lessonTitle;
            }
            const nav = document.getElementById('bottom-nav-container');
            if(nav) {
                tabs.forEach((t, i) => {
                    nav.innerHTML += `<div class="nav-item ${i===0?'active':''}" id="nav-${t.id}" onclick="switchTab('${t.id}')"><i data-lucide="${t.icon}"></i><span>${t.label}</span></div>`;
                });
                lucide.createIcons();
            }
            initInteractive();
            initAttempts();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† - Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ V19.27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 420px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; max-height: 96vh; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b;
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        /* Math UI Components */
        .math-exp { vertical-align: super; font-size: 0.65em; font-weight: 900; color: #2563eb; }
        .bg-blue-600 .math-exp, .bg-blue-600 .math-exp * { color: #ffffff !important; }
        
        .math-fraction { display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 4px; font-size: 0.85em; }
        .math-num { border-bottom: 2px solid #334155; padding: 0 4px; line-height: 1; }
        .math-den { padding: 0 4px; line-height: 1.2; }

        .option-card { 
            border: 2px solid #f1f5f9; transition: all 0.2s; cursor: pointer;
            display: flex; align-items: center; justify-content: center; padding: 10px;
            border-radius: 1rem; font-weight: 800; background: #fff; text-align: center;
            font-size: 13px; min-height: 60px; color: #1e293b;
        }
        
        /* Feedback Animations */
        @keyframes blink-green { 
            0%, 100% { border-color: #10b981; background: #ecfdf5; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
            50% { border-color: #f1f5f9; background: #fff; box-shadow: none; }
        }
        .option-correct-base { border-color: #10b981 !important; background: #ecfdf5 !important; color: #065f46; border-width: 3px !important; }
        .option-wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b; border-width: 3px !important; }
        .option-blink { animation: blink-green 0.5s infinite; }

        .modal-overlay {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); z-index: 200;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            opacity: 0; pointer-events: none; transition: all 0.3s ease;
        }
        .modal-active { opacity: 1; pointer-events: auto; }
        
        .explanation-scroll { max-height: 280px; overflow-y: auto; padding-right: 8px; scrollbar-width: thin; }
        .explanation-scroll::-webkit-scrollbar { width: 4px; }
        .explanation-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .leaderboard-modal { 
            position: absolute; inset: 0; background: #ffffff; z-index: 100; 
            display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; 
        }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #e2e8f0; }

        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        canvas { display: block; margin: 0 auto; background: white; border-radius: 1rem; border: 1px solid #f1f5f9; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-3 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden flex-1">
                <i class="fas fa-user-hard-hat text-blue-500"></i>
                <span id="top-student-name" class="truncate font-black text-[10px]">Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ</span>
            </div>
            <div class="flex items-center gap-1.5 px-2 border-x border-slate-200">
                <i class="fas fa-stopwatch text-blue-400 text-[10px]"></i>
                <span id="game-timer" class="font-black text-slate-700 text-[10px]">Ù Ù :Ù Ù </span>
                <span id="paused-text" class="hidden text-[7px] text-red-500 font-black animate-pulse">Ù…ØªÙˆÙ‚Ù</span>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-4 h-full justify-center">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 shadow-inner border border-blue-200">
                <i class="fas fa-building text-3xl text-blue-600"></i>
            </div>
            <h1 class="text-xl font-black text-slate-800 leading-tight">Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†<br><span class="text-blue-600 text-lg font-extrabold">Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ Ù…Ø³Ø§Ø¦Ù„ ÙˆØªØ·Ø¨ÙŠÙ‚Ø§Øª V19.27</span></h1>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-[11px] font-bold text-blue-700 leading-relaxed text-center">
                Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! Ø§Ø³ØªÙ†ØªØ¬ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ø¨Ø¯Ù‚Ø©. ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙŠØªØºÙŠØ± Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ø§Ù„ØªÙƒ ÙˆØªØ±ÙƒÙŠØ²Ùƒ!
            </div>
            
            <div class="flex flex-row gap-2 items-stretch mt-2">
                <button onclick="startGame()" class="btn-touch flex-[2.5] bg-blue-600 text-white shadow-lg text-lg font-black">
                    Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© <i class="fas fa-play mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-slate-600 border border-slate-200 text-[10px] flex-col leading-tight py-2 font-black">
                    <i class="fas fa-trophy text-yellow-500 text-xl mb-1"></i>
                    <span>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
            <p class="text-[10px] text-slate-400 font-bold mt-2 tracking-widest uppercase text-center">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="game-screen" class="hidden p-5 flex flex-col gap-2 overflow-y-auto">
            <div class="flex justify-between items-center px-1">
                <span id="step-indicator" class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full italic uppercase">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù¡</span>
                <span id="question-number" class="text-[10px] font-black text-slate-400">Ù…Ù‡Ù…Ø© Ù¡ Ù…Ù† Ù¤</span>
            </div>

            <div id="question-box" class="bg-slate-50 p-3 rounded-2xl border border-slate-100 text-center text-black">
                <div id="drawing-area" class="mb-2 hidden">
                    <canvas id="question-canvas" width="300" height="150" class="w-full"></canvas>
                </div>
                <h3 id="scenario-title" class="font-black text-slate-800 text-sm mb-1 uppercase"></h3>
                <div id="scenario-desc" class="text-[11px] text-slate-500 font-bold leading-relaxed"></div>
            </div>

            <div id="options-grid" class="grid grid-cols-1 gap-2 mt-1"></div>
        </div>

        <!-- Ø¥Ø·Ø§Ø± Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ -->
        <div id="explanation-modal" class="modal-overlay">
            <div class="explanation-card bg-white w-full rounded-[1.5rem] shadow-2xl p-5 border border-slate-200">
                <h4 class="font-black text-blue-600 text-sm border-b pb-2 mb-3"><i class="fas fa-lightbulb ml-1"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù„Ù„Ù…Ø±Ø­Ù„Ø©</h4>
                
                <div class="explanation-scroll">
                    <div id="explanation-drawing-area" class="mb-3">
                        <canvas id="explanation-canvas" width="300" height="150" class="w-full"></canvas>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-black">
                        <div id="explanation-text" class="text-[11px] font-bold text-blue-800 leading-loose space-y-2"></div>
                    </div>
                </div>

                <button onclick="closeExplanation()" class="btn-touch w-full bg-blue-600 text-white shadow-md mt-4 font-black">
                    Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ù…Ø© <i class="fas fa-chevron-left mr-2"></i>
                </button>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø­Ù„ÙŠØ© -->
        <div id="partial-result-modal" class="modal-overlay">
            <div class="explanation-card text-center p-8 bg-white rounded-[2rem]">
                <div id="partial-icon-box" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-emerald-100 text-emerald-600 shadow-inner">
                    <i class="fas fa-check-double text-3xl"></i>
                </div>
                <h3 class="text-lg font-black text-slate-800 mb-1 font-black text-center">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h3>
                <div class="bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100 text-center">
                    <p id="partial-score-text" class="text-4xl font-black text-blue-600 tracking-tighter">Ù  / Ù¡Ù </p>
                </div>
                <button onclick="closePartialResult()" class="btn-touch w-full bg-slate-900 text-white shadow-lg font-black">
                    Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full overflow-hidden text-center justify-center">
            <div id="final-stats" class="grid grid-cols-3 gap-1 mb-4 text-black"></div>
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 mb-4 shadow-sm text-center">
                <i class="fas fa-award text-emerald-500 text-2xl mb-1"></i>
                <p class="font-black text-emerald-800 text-sm uppercase italic">Ø£Ù†Øª Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¹ØªÙ…Ø¯ Ø¨Ø§Ù…ØªÙŠØ§Ø²!</p>
            </div>
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-4 shadow-md font-black">
                Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ <i class="fas fa-crown mr-2"></i>
            </button>
            <div class="mt-auto flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 text-sm font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
                <button id="finish-btn" class="btn-touch flex-[2] bg-slate-900 text-white text-sm font-bold uppercase font-black">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                <button onclick="closeLeaderboardModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center transition-all hover:bg-red-50 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„ÙƒÙ„)</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl border border-slate-100 p-1 relative text-black text-right">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><div class="sync-loader text-blue-500 text-3xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4/exec"; 
        const GAME_ID = 'g6_6_2'; 
        const urlParams = new URLSearchParams(window.location.search);
        
        const studentId = urlParams.get('studentId') || urlParams.get('userId') || urlParams.get('uid');
        const classId = urlParams.get('classId');
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('user') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
        const toArHTML = (html) => {
            return html.replace(/(<[^>]*>)|(\d)/g, (match, tag, digit) => tag ? tag : "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[digit]);
        };

        const exp2 = `<span class="math-exp">Ù¢</span>`;
        const fracHTML = `<div class="math-fraction"><span class="math-num">${toAr(1)}</span><span class="math-den">${toAr(2)}</span></div>`;

        // --- Data Scenarios ---
        const taskData = [
            { variants: [
                { type: 'rect', title: "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¨ØªØ¯Ø¦", desc: "Ø£ÙˆØ¬Ø¯ ØªØ¹Ø¨ÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø·Ù‰.", opt1: ["(Ø³+Ù¥)(Ø³+Ù£)", "(Ø³+Ù¨)(Ø³+Ù¢)", "(Ù¢Ø³+Ù¥)(Ø³+Ù£)"], correct1: 0, opt2: ["Ø³"+exp2+"+Ù¨Ø³+Ù¡Ù¥", "Ø³"+exp2+"+Ù¥Ø³+Ù¡Ù¥", "Ù¢Ø³"+exp2+"+Ù¨Ø³+Ù¡Ù¥"], correct2: 0, draw: (ctx) => { ctx.strokeRect(80,50,140,60); ctx.font='bold 12px Cairo'; ctx.fillText('Ø³+Ù¥', 140, 40); ctx.fillText('Ø³+Ù£', 40, 85); }, expl1: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶." },
                { type: 'square', title: "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¨ØªØ¯Ø¦", desc: "Ø£ÙˆØ¬Ø¯ ØªØ¹Ø¨ÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø·Ù‰.", opt1: ["(Ø³+Ù¤)"+exp2, "(Ø³+Ù¨)(Ø³+Ù¤)", "(Ù¤Ø³+Ù¤)"+exp2], correct1: 0, opt2: ["Ø³"+exp2+"+Ù¨Ø³+Ù¡Ù¦", "Ø³"+exp2+"+Ù¡Ù¦", "Ø³"+exp2+"+Ù¤Ø³+Ù¡Ù¦"], correct2: 0, draw: (ctx) => { ctx.strokeRect(100,40,100,100); ctx.font='bold 12px Cairo'; ctx.fillText('Ø³+Ù¤', 130, 30); ctx.fillText('Ø³+Ù¤', 60, 95); }, expl1: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹ = Ø·ÙˆÙ„ Ø§Ù„Ø¶Ù„Ø¹ ÙÙŠ Ù†ÙØ³Ù‡." }
            ]},
            { variants: [
                { type: 'tri', title: "Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¶Ù„Ø¹Ø§Øª", desc: "Ø£ÙˆØ¬Ø¯ ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ù…ÙˆØ¶Ø­ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·.", opt1: [fracHTML + "(Ù¤Ø³)(Ø³+Ù£)", "(Ù¤Ø³)(Ø³+Ù£)", fracHTML + "(Ù¤Ø³)+(Ø³+Ù£)"], correct1: 0, opt2: ["Ù¢Ø³"+exp2+"+Ù¦Ø³", "Ù¤Ø³"+exp2+"+Ù¡Ù¢Ø³", "Ù¢Ø³"+exp2+"+Ù£Ø³"], correct2: 0, 
                    draw: (ctx) => { 
                        ctx.beginPath(); ctx.moveTo(80,110); ctx.lineTo(220,110); ctx.lineTo(150,40); ctx.closePath(); ctx.stroke(); 
                        ctx.strokeStyle='red'; ctx.setLineDash([5,3]); ctx.beginPath(); ctx.moveTo(150,40); ctx.lineTo(150,110); ctx.stroke(); 
                        ctx.setLineDash([]); ctx.fillStyle='black'; ctx.font='bold 12px Cairo'; ctx.fillText('Ù¤Ø³', 150, 125); ctx.fillStyle='red'; ctx.fillText('Ø³+Ù£', 155, 80); 
                    }, expl1: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« = Ù†ØµÙ Ã— Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ã— Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ù†Ù‚Ø· Ø¨Ø§Ù„Ø£Ø­Ù…Ø±."
                },
                { type: 'para', title: "Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¶Ù„Ø¹Ø§Øª", desc: "Ø£ÙˆØ¬Ø¯ ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù…ØªÙˆØ§Ø²ÙŠ Ø§Ù„Ø£Ø¶Ù„Ø§Ø¹ Ø§Ù„Ù…Ø¹Ø·Ù‰.", opt1: ["(Ù¢Ø³+Ù£)(Ø³+Ù¢)", "(Ù¢Ø³+Ù£)+(Ø³+Ù¢)", "(Ø³+Ù£)(Ù¢Ø³+Ù¢)"], correct1: 0, opt2: ["Ù¢Ø³"+exp2+"+Ù§Ø³+Ù¦", "Ù¢Ø³"+exp2+"+Ù¥Ø³+Ù¦", "Ø³"+exp2+"+Ù§Ø³+Ù¦"], correct2: 0, draw: (ctx) => { ctx.beginPath(); ctx.moveTo(80,100); ctx.lineTo(180,100); ctx.lineTo(210,50); ctx.lineTo(110,50); ctx.closePath(); ctx.stroke(); ctx.setLineDash([5,3]); ctx.moveTo(110,50); ctx.lineTo(110,100); ctx.stroke(); ctx.setLineDash([]); ctx.fillText('Ù¢Ø³+Ù£', 130, 115); ctx.fillText('Ø³+Ù¢', 85, 80); }, expl1: "Ù…Ø³Ø§Ø­Ø© Ù…ØªÙˆØ§Ø²ÙŠ Ø§Ù„Ø£Ø¶Ù„Ø§Ø¹ = Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ã— Ø§Ù„Ø§Ø±ØªÙØ§Ø¹." }
            ]},
            { variants: [
                { type: 'garden', title: "Ø®Ø¨ÙŠØ± Ø§Ù„ØªØ®Ø·ÙŠØ·", desc: "ÙŠØ­ÙŠØ· Ù…Ù…Ø± Ø¹Ø±Ø¶Ù‡ (Ø³) Ø¨Ø­Ø¯ÙŠÙ‚Ø© Ù…Ø³ØªØ·ÙŠÙ„Ø© Ø·ÙˆÙ„Ù‡Ø§ Ù¨ Ø£Ù…ØªØ§Ø± ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ù¦ Ø£Ù…ØªØ§Ø±. Ø§Ø³ØªÙ†ØªØ¬ ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø© + Ø§Ù„Ù…Ù…Ø±).", opt1: ["(Ù¢Ø³+Ù¨)(Ù¢Ø³+Ù¦)", "(Ø³+Ù¨)(Ø³+Ù¦)", "(Ù¢Ø³+Ù¤)(Ù¢Ø³+Ù£)"], correct1: 0, opt2: ["Ù¤Ø³"+exp2+"+Ù¢Ù¨Ø³+Ù¤Ù¨", "Ù¢Ø³"+exp2+"+Ù¡Ù¤Ø³+Ù¤Ù¨", "Ù¤Ø³"+exp2+"+Ù¡Ù¤Ø³+Ù¢Ù¤"], correct2: 0, showInQ: false, draw: (ctx) => { ctx.fillStyle='rgba(239,68,68,0.1)'; ctx.fillRect(60,35,180,80); ctx.strokeStyle='#2563eb'; ctx.strokeRect(60,35,180,80); ctx.fillStyle='white'; ctx.fillRect(90,50,120,50); ctx.setLineDash([4,4]); ctx.strokeRect(90,50,120,50); ctx.setLineDash([]); ctx.font='bold 10px Cairo'; ctx.fillStyle='black'; ctx.fillText('Ù¨ Ù…',150,80); ctx.fillText('Ù¦ Ù…',75,80); ctx.fillStyle='red'; ctx.fillText('Ø³', 75, 45); ctx.fillText('Ø³', 225, 45); ctx.fillText('Ø³', 75, 115); ctx.fillText('Ø³', 225, 115); }, expl1: "Ø§Ù„Ù…Ù…Ø± ÙŠØ¶ÙŠÙ (Ù¢Ø³) Ù„Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„Ø¹Ø±Ø¶." },
                { type: 'warehouse', title: "Ø®Ø¨ÙŠØ± Ø§Ù„ØªØ®Ø·ÙŠØ·", desc: "Ù…Ø®Ø·Ø· Ù…Ø¬Ù…Ø¹ Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…ÙƒÙˆÙ† Ù…Ù† Ù‚Ø³Ù…ÙŠÙ† Ù…ØªÙ„Ø§ØµÙ‚ÙŠÙ†: Ø§Ù„Ø£ÙˆÙ„ Ø·ÙˆÙ„Ù‡ (Ù¢Ø³+Ù¡) ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ø·ÙˆÙ„Ù‡ (Ø³+Ù¥)ØŒ ÙˆÙƒÙ„Ø§Ù‡Ù…Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ø±Ø¶ (Ù¢Ø³+Ù£). Ø§Ø³ØªÙ†ØªØ¬ ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙ„ÙŠØ©.", opt1: ["(Ù£Ø³+Ù¦)(Ù¢Ø³+Ù£)", "(Ù¢Ø³+Ù¡)(Ø³+Ù¥)", "(Ù£Ø³+Ù¦)+(Ù¢Ø³+Ù£)"], correct1: 0, opt2: ["Ù¦Ø³"+exp2+"+Ù¢Ù¡Ø³+Ù¡Ù¨", "Ù¦Ø³"+exp2+"+Ù¡Ù¢Ø³+Ù¡Ù¨", "Ù¦Ø³"+exp2+"+Ù¢Ù¡Ø³+Ù©"], correct2: 0, showInQ: false, draw: (ctx) => { ctx.fillStyle='#eff6ff'; ctx.fillRect(60,50,100,70); ctx.strokeStyle='#3b82f6'; ctx.strokeRect(60,50,100,70); ctx.fillStyle='#f8fafc'; ctx.fillRect(160,50,80,70); ctx.strokeRect(160,50,80,70); ctx.fillStyle='black'; ctx.font='bold 9px Cairo'; ctx.fillText('Ù¢Ø³+Ù¡', 110, 45); ctx.fillText('Ø³+Ù¥', 200, 45); ctx.fillText('Ù¢Ø³+Ù£', 35, 85); }, expl1: "Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø·ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹: (Ù¢Ø³+Ù¡) + (Ø³+Ù¥) = (Ù£Ø³+Ù¦)." }
            ]},
            { isComplex: true, variants: [
                { type: 'sub', title: "ÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", 
                    p1: { desc: "Ø§Ø¯Ø±Ø³ Ø§Ù„Ù…Ø®Ø·Ø·: ÙƒÙŠÙ Ù†Ø­Ø³Ø¨ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¸Ù„Ù„Ø© Ø¨Ø§Ù„Ø£ØµÙØ±ØŸ", opt: ["Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¤ - Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¢", "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¤ + Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¢", "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù£ + Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¡"], correct: 0, expl: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¸Ù„Ù„Ø© = Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù¤) Ù…Ø·Ø±ÙˆØ­Ø§Ù‹ Ù…Ù†Ù‡ Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ø£Ø¨ÙŠØ¶ (Ù¢)." },
                    p2: { desc: "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¬Ø¨Ø±ÙŠ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ø£Ø¨ÙŠØ¶ (Ù¢).", opt: [fracHTML + "(Ù¢Ø³-Ù£)(Ù¤Ø³+Ù¡)", "(Ù¢Ø³-Ù£)(Ù¤Ø³+Ù¡)", fracHTML + "(Ù¥Ø³)(Ù¤Ø³+Ù¡)"], correct: 0, expl: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« = Ù¡/Ù¢ Ã— Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ã— Ø§Ù„Ø§Ø±ØªÙØ§Ø¹." },
                    p3: { desc: "Ø§Ø­Ø³Ø¨ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ø£Ø¨ÙŠØ¶ (Ù¢).", opt: ["Ù¤Ø³"+exp2+"-Ù¥Ø³-Ù¡,Ù¥", "Ù¤Ø³"+exp2+"-Ù¡Ù Ø³-Ù£", "Ù¨Ø³"+exp2+"-Ù¡Ù Ø³-Ù£"], correct: 0, expl: "Ø¨Ø§Ù„ØªØ¨Ø³ÙŠØ· ÙˆØ§Ù„Ø¶Ø±Ø¨: Ù¤Ø³Â² - Ù¥Ø³ - Ù¡,Ù¥" },
                    p4: { desc: "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¬Ø¨Ø±ÙŠ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù¤).", opt: ["(Ù§Ø³-Ù£)(Ù¤Ø³+Ù¡)", "(Ù¥Ø³)(Ù¤Ø³+Ù¡)", "(Ù¢Ø³-Ù£)(Ù¤Ø³+Ù¡)"], correct: 0, expl: "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø³ØªØ·ÙŠÙ„ = (Ù¥Ø³) + (Ù¢Ø³-Ù£) = Ù§Ø³ - Ù£." },
                    p5: { desc: "Ø§Ø­Ø³Ø¨ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù¤).", opt: ["Ù¢Ù¨Ø³"+exp2+"-Ù¥Ø³-Ù£", "Ù¢Ù¨Ø³"+exp2+"-Ù¡Ù¤Ø³-Ù£", "Ù¢Ù¤Ø³"+exp2+"-Ù¥Ø³-Ù£"], correct: 0, expl: "Ø¨Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: Ù¢Ù¨Ø³Â² - Ù¥Ø³ - Ù£" },
                    p6: { desc: "Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¸Ù„Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.", opt: ["Ù¢Ù¤Ø³"+exp2+"-Ù¡,Ù¥", "Ù¢Ù¤Ø³"+exp2+"-Ù¡Ù Ø³-Ù¤,Ù¥", "Ù¢Ù¨Ø³"+exp2+"-Ù¡,Ù¥"], correct: 0, expl: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© = Ù†Ø§ØªØ¬ Ø·Ø±Ø­ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„." },
                    draw: (ctx, step) => {
                        ctx.fillStyle='#eff6ff'; ctx.fillRect(70,35,80,80); ctx.strokeStyle='#3b82f6'; ctx.strokeRect(70,35,80,80);
                        ctx.fillStyle='#fef3c7'; ctx.fillRect(150,35,80,80);
                        ctx.strokeStyle='#ef4444'; ctx.lineWidth=3; ctx.strokeRect(70,35,160,80); ctx.lineWidth=1.5;
                        ctx.beginPath(); ctx.moveTo(150,35); ctx.lineTo(150,115); ctx.stroke();
                        ctx.fillStyle='white'; ctx.beginPath(); ctx.moveTo(150,35); ctx.lineTo(230,115); ctx.lineTo(150,115); ctx.closePath(); ctx.fill(); ctx.stroke();
                        ctx.font='bold 11px Cairo'; ctx.textAlign='center';
                        if(step === 1) { ctx.fillStyle='#ef4444'; ctx.fillText('Ù¤', 150, 25); ctx.fillStyle='#2563eb'; ctx.fillText('Ù¡', 110, 75); ctx.fillStyle='#991b1b'; ctx.fillText('Ù¢', 170, 95); }
                        else { ctx.fillStyle='black'; ctx.fillText('Ù¤Ø³+Ù¡', 35, 80); ctx.fillText('Ù¥Ø³', 110, 130); ctx.fillText('Ù¢Ø³-Ù£', 190, 130); ctx.beginPath(); ctx.moveTo(150, 120); ctx.quadraticCurveTo(190, 125, 230, 120); ctx.stroke(); ctx.strokeStyle='red'; ctx.setLineDash([5,3]); ctx.beginPath(); ctx.moveTo(230,35); ctx.lineTo(230,115); ctx.stroke(); ctx.setLineDash([]); }
                    }
                },
                { type: 'add', title: "ÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", 
                    p1: { desc: "ÙƒÙŠÙ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ù£) Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø®Ø·Ø·ØŸ", opt: ["Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¡ + Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¢", "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¡ - Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¢", "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¡ Ã— Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù¢"], correct: 0, expl: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ù£) Ù‡ÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ (Ù¡) ÙˆÙ…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« (Ù¢)." },
                    p2: { desc: "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¬Ø¨Ø±ÙŠ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ù…Ø«Ù„Ø« (Ù¢).", opt: [fracHTML + "(Ù¤Ø³+Ù¢)(Ø³+Ù¡)", "(Ù¤Ø³+Ù¢)(Ø³+Ù¡)", fracHTML + "(Ù£Ø³)(Ø³+Ù¡)"], correct: 0, expl: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø« = Ù¡/Ù¢ Ã— Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ã— Ø§Ù„Ø§Ø±ØªÙØ§Ø¹." },
                    p3: { desc: "Ø§Ø­Ø³Ø¨ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ù…Ø«Ù„Ø« (Ù¢).", opt: ["Ù¢Ø³"+exp2+"+Ù£Ø³+Ù¡", "Ù¤Ø³"+exp2+"+Ù¦Ø³+Ù¢", "Ù¢Ø³"+exp2+"+Ø³+Ù¡"], correct: 0, expl: "Ø¨Ø§Ù„ØªØ¨Ø³ÙŠØ· Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰: Ù¢Ø³Â² + Ù£Ø³ + Ù¡" },
                    p4: { desc: "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¬Ø¨Ø±ÙŠ Ù„Ù…Ø³Ø§Ø­Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„Ø© (Ù¡).", opt: ["(Ù¤Ø³+Ù¢)(Ù£Ø³)", "(Ù¤Ø³+Ù¢)+(Ù£Ø³)", "(Ù£Ø³)(Ø³+Ù¡)"], correct: 0, expl: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ = Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶." },
                    p5: { desc: "Ø§Ø­Ø³Ø¨ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„Ø© (Ù¡).", opt: ["Ù¡Ù¢Ø³"+exp2+"+Ù¦Ø³", "Ù¡Ù¢Ø³"+exp2+"+Ù¢Ø³", "Ù¡Ù¥Ø³"+exp2+"+Ù¦Ø³"], correct: 0, expl: "Ø¨Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: Ù¡Ù¢Ø³Â² + Ù¦Ø³" },
                    p6: { desc: "Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¨ÙŠØª.", opt: ["Ù¡Ù¤Ø³"+exp2+"+Ù©Ø³+Ù¡", "Ù¡Ù¤Ø³"+exp2+"+Ù¦Ø³+Ù¡", "Ù¡Ù¥Ø³"+exp2+"+Ù©Ø³+Ù¡"], correct: 0, expl: "Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙƒÙ„ÙŠØ© = Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ø³Ù‚Ù." },
                    draw: (ctx, step) => {
                        ctx.fillStyle='#eff6ff'; ctx.fillRect(80,80,140,50); ctx.strokeStyle='#2563eb'; ctx.strokeRect(80,80,140,50);
                        ctx.fillStyle='#fee2e2'; ctx.beginPath(); ctx.moveTo(80,80); ctx.lineTo(220,80); ctx.lineTo(150,30); ctx.closePath(); ctx.fill(); ctx.strokeStyle='#dc2626'; ctx.stroke();
                        ctx.strokeStyle='#ef4444'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(80,130); ctx.lineTo(220,130); ctx.lineTo(220,80); ctx.lineTo(150,30); ctx.lineTo(80,80); ctx.closePath(); ctx.stroke(); ctx.lineWidth=1.5;
                        ctx.font='bold 11px Cairo'; ctx.textAlign='center';
                        if(step === 1) { ctx.fillStyle='#ef4444'; ctx.fillText('Ù£', 150, 20); ctx.fillStyle='#2563eb'; ctx.fillText('Ù¡', 150, 110); ctx.fillStyle='#dc2626'; ctx.fillText('Ù¢', 150, 60); }
                        else { ctx.fillStyle='black'; ctx.fillText('Ù¤Ø³+Ù¢', 150, 145); ctx.fillText('Ù£Ø³', 55, 105); ctx.fillStyle='red'; ctx.fillText('Ø³+Ù¡', 180, 55); ctx.setLineDash([5,3]); ctx.beginPath(); ctx.moveTo(150,30); ctx.lineTo(150,80); ctx.stroke(); ctx.setLineDash([]); }
                    }
                }
            ]}
        ];

        let currentQ = 0, currentSubStage = 1, totalScore = 0, qPoints = 0, variantIdx = 0;
        let timerInterval, seconds = 0, isPaused = false;
        let currentLeaderboardMode = classId ? 'class' : 'global';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            
            // --- ID Logic Fix ---
            if (!classId) {
                document.getElementById('tab-class').style.display = 'none';
                currentLeaderboardMode = 'global';
            } else {
                document.getElementById('tab-class').className = 'tab-btn tab-inactive';
                document.getElementById('tab-global').className = 'tab-btn tab-active';
            }

            if (studentId && classId) {
                document.getElementById('sync-icon').classList.remove('hidden');
                fetchInitialCloudData();
            }
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        async function fetchInitialCloudData() {
            try {
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                if (res.status === 'success' && res.data && res.data.games?.[GAME_ID]) {
                    document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                }
            } catch(e) {} finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        function startTimer() { timerInterval = setInterval(() => { if (!isPaused) { seconds++; updateTimerDisplay(); } }, 1000); }
        function updateTimerDisplay() {
            const m = Math.floor(seconds / 60); const s = seconds % 60;
            const timerEl = document.getElementById('game-timer');
            if (timerEl) timerEl.textContent = `${toAr(m.toString().padStart(2, 'Ù '))}:${toAr(s.toString().padStart(2, 'Ù '))}`;
        }

        window.startGame = () => {
            variantIdx = Math.floor(Math.random() * (taskData[currentQ].variants.length));
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            startTimer(); loadQuestion();
        };

        function loadQuestion() {
            const task = taskData[currentQ];
            const variant = task.variants[variantIdx];
            document.getElementById('question-number').textContent = `Ù…Ù‡Ù…Ø© ${toAr(currentQ + 1)} Ù…Ù† ${toAr(taskData.length)}`;
            document.getElementById('step-indicator').textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${toAr(currentSubStage)}`;
            document.getElementById('scenario-title').textContent = variant.title;

            const drawingArea = document.getElementById('drawing-area');
            const canvas = document.getElementById('question-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.textAlign = 'center'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 1.5; ctx.fillStyle='black';

            const grid = document.getElementById('options-grid'); grid.innerHTML = '';

            if (!task.isComplex) {
                if (currentSubStage === 1) {
                    if(variant.showInQ === false) drawingArea.classList.add('hidden');
                    else { drawingArea.classList.remove('hidden'); variant.draw(ctx); }
                    document.getElementById('scenario-desc').innerHTML = variant.desc;
                    renderOptions(variant.opt1, variant.correct1);
                } else {
                    drawingArea.classList.add('hidden');
                    const prevHTML = variant.opt1[variant.correct1];
                    document.getElementById('scenario-desc').innerHTML = `
                        <div class="bg-blue-600 text-white p-3 rounded-xl mb-2 text-center shadow-lg font-black text-sm">
                            Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: <span class="font-black">${toArHTML(prevHTML)}</span>
                        </div>
                        <p class="text-slate-600 text-[10px] text-center font-bold">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ø·Ù‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¶Ø±Ø¨.</p>`;
                    renderOptions(variant.opt2, variant.correct2);
                }
            } else {
                drawingArea.classList.remove('hidden');
                variant.draw(ctx, currentSubStage);
                const stage = variant['p' + currentSubStage];
                if (currentSubStage === 6) {
                    const v1 = variant['p5'].opt[variant['p5'].correct];
                    const v2 = variant['p3'].opt[variant['p3'].correct];
                    document.getElementById('scenario-desc').innerHTML = `
                        <div class="bg-slate-100 p-2 rounded-xl mb-2 text-[10px] border-2 border-slate-200">
                            <p>Ù¡. Ø§Ù„Ø£ÙˆÙ„: <span class="text-blue-600 font-black">${toArHTML(v1)}</span></p>
                            <p>Ù¢. Ø§Ù„Ø«Ø§Ù†ÙŠ: <span class="text-blue-600 font-black">${toArHTML(v2)}</span></p>
                            <p class="mt-1 font-black text-center pt-1 border-t-2 border-dashed border-slate-300 text-slate-400 italic">Ø§Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠÙ† Ù„Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
                        </div>
                        <p class="text-slate-800 font-black text-center">${stage.desc}</p>`;
                } else if (currentSubStage === 3 || currentSubStage === 5) {
                    const prevKey = currentSubStage === 3 ? 'p2' : 'p4';
                    const pCorrect = variant[prevKey].opt[variant[prevKey].correct];
                    document.getElementById('scenario-desc').innerHTML = `
                        <div class="bg-blue-600 text-white p-3 rounded-xl mb-2 text-center shadow-lg font-black text-xs font-black">Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±: ${toArHTML(pCorrect)}</div>
                        <p class="text-slate-800 font-black text-center">${stage.desc}</p>`;
                } else {
                    document.getElementById('scenario-desc').innerHTML = stage.desc;
                }
                renderOptions(stage.opt, stage.correct);
            }
        }

        function renderOptions(opts, correctIdx) {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            let pairs = opts.map((opt, index) => ({ text: opt, isCorrect: index === correctIdx }));
            pairs.sort(() => Math.random() - 0.5);
            pairs.forEach((pair) => {
                const div = document.createElement('div');
                div.className = 'option-card';
                div.innerHTML = toArHTML(pair.text);
                div.onclick = () => checkAnswer(pair.isCorrect, div, pairs);
                grid.appendChild(div);
            });
        }

        function checkAnswer(isRight, element, allPairs) {
            const allOptionElements = document.querySelectorAll('.option-card');
            allOptionElements.forEach(opt => opt.style.pointerEvents = 'none');
            if (isRight) {
                element.classList.add('option-correct-base', 'option-blink');
                qPoints += (taskData[currentQ].isComplex ? 1.66 : 5);
            } else {
                element.classList.add('option-wrong');
                allOptionElements.forEach((el, idx) => { if (allPairs[idx].isCorrect) el.classList.add('option-blink'); });
            }
            setTimeout(() => showExplanation(isRight), 3000);
        }

        function showExplanation(isRight) {
            isPaused = true; document.getElementById('paused-text').classList.remove('hidden');
            const modal = document.getElementById('explanation-modal');
            const task = taskData[currentQ]; const variant = task.variants[variantIdx];
            let explText = "", correctVal = "";
            if (!task.isComplex) {
                if (currentSubStage === 1) { explText = variant.expl1; correctVal = variant.opt1[variant.correct1]; }
                else { explText = "ØªÙ… Ø¶Ø±Ø¨ ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© Ø¨Ø¯Ù‚Ø©."; correctVal = variant.opt2[variant.correct2]; }
            } else {
                explText = variant['p' + currentSubStage].expl;
                correctVal = variant['p' + currentSubStage].opt[variant['p' + currentSubStage].correct];
            }
            document.getElementById('explanation-text').innerHTML = `
                <div class="mb-3 text-center bg-white p-3 rounded-xl border-2 border-blue-100 shadow-md">
                    <span class="text-[9px] text-slate-400 block font-bold mb-1 uppercase tracking-widest">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</span>
                    <span class="text-blue-700 font-black text-base font-black">${toArHTML(correctVal)}</span>
                </div>
                <div class="text-slate-600 leading-relaxed font-bold">${explText}</div>`;
            const canvas = document.getElementById('explanation-canvas'); const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,300,150); ctx.textAlign='center'; ctx.strokeStyle='#2563eb'; ctx.lineWidth=1.5; ctx.fillStyle='black';
            if (task.isComplex) variant.draw(ctx, currentSubStage); else variant.draw(ctx);
            modal.classList.add('modal-active');
        }

        window.closeExplanation = () => {
            isPaused = false; document.getElementById('explanation-modal').classList.remove('modal-active');
            document.getElementById('paused-text').classList.add('hidden');
            const task = taskData[currentQ];
            if (!task.isComplex) { if (currentSubStage === 1) { currentSubStage = 2; loadQuestion(); } else showPartialResult(); }
            else { if (currentSubStage < 6) { currentSubStage++; loadQuestion(); } else showPartialResult(); }
        };

        function showPartialResult() { isPaused = true; const modal = document.getElementById('partial-result-modal'); document.getElementById('partial-score-text').textContent = `${toAr(Math.round(qPoints))} / Ù¡Ù `; modal.classList.add('modal-active'); }

        window.closePartialResult = () => {
            isPaused = false; document.getElementById('partial-result-modal').classList.remove('modal-active');
            totalScore += qPoints; qPoints = 0; 
            if (currentQ < taskData.length - 1) { 
                currentQ++; currentSubStage = 1; 
                variantIdx = Math.floor(Math.random() * (taskData[currentQ].variants.length));
                loadQuestion(); 
            } else finishGame();
        };

        function finishGame() {
            clearInterval(timerInterval); const totalPossible = taskData.length * 10; const grade = ((totalScore / totalPossible) * 5).toFixed(1);
            document.getElementById('game-screen').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `<div class="bg-blue-50 p-2 rounded-xl border border-blue-100 flex flex-col justify-center text-center shadow-sm"><p class="text-[8px] font-bold text-blue-400 uppercase">Ø§Ù„Ù†Ù‚Ø§Ø·</p><p class="text-[11px] font-black text-blue-900">${toAr(Math.round(totalScore))} / ${toAr(totalPossible)}</p></div><div class="bg-emerald-50 p-2 rounded-xl border border-emerald-100 flex flex-col justify-center text-center shadow-md"><p class="text-[8px] font-bold text-emerald-600 uppercase">Ø§Ù„Ø¯Ø±Ø¬Ø©</p><p class="text-xl font-black text-emerald-900">${toAr(grade)}</p></div><div class="bg-purple-50 p-2 rounded-xl border border-purple-100 flex flex-col justify-center text-center shadow-sm"><p class="text-[8px] font-bold text-purple-400 uppercase">Ø§Ù„ÙˆÙ‚Øª</p><p class="text-lg font-black text-purple-900">${toAr(seconds)}Ø«</p></div>`;
            if (studentId && classId) saveScore(grade, seconds);
        }

        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } catch(e) {} finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            
            // Fix: Determine request ID correctly
            let reqClassId = (currentLeaderboardMode === 'class' && classId) ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId)}&t=${Date.now()}`;
            
            fetch(url).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="bg-slate-100 text-slate-500"><tr><th class="p-2 text-center font-black">#</th><th class="p-2 text-right font-black">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center text-emerald-600 font-black">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody>`;
                    data.forEach((p, i) => {
                        const isMe = (studentId && String(p.studentId || p.userId || p.name).trim() === String(studentId || studentName).trim());
                        h += `<tr class="${isMe ? 'bg-blue-50 border-r-4 border-blue-600' : ''} border-b border-slate-50 transition-colors">
                            <td class="p-2 text-center font-black ${i<3 ? 'text-lg' : ''}">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td>
                            <td class="p-2 font-bold ${isMe ? 'text-blue-700' : 'text-slate-700'}">${p.name}</td>
                            <td class="p-2 text-center font-black text-emerald-600">${toAr(parseFloat(p.grade).toFixed(1))}</td>
                        </tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="p-10 text-center text-slate-400 text-xs italic font-bold tracking-widest">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            }).catch(() => {
                content.innerHTML = `<div class="p-10 text-center text-red-400 text-xs font-bold">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (mode) => { 
            currentLeaderboardMode = mode; 
            document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; 
            document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; 
            fetchAndShowLeaderboard(false); 
        };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

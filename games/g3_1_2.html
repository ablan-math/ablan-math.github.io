<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الميل والمقطع</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            touch-action: manipulation;
        }
        canvas {
            border-radius: 0.5rem;
            cursor: crosshair;
        }
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin: 0 0.2em;
            line-height: 1;
        }
        .numerator {
            display: block;
            padding: 0 0.2em;
            font-size: 0.9em;
        }
        .denominator {
            display: block;
            border-top: 1.5px solid currentColor;
            padding: 0 0.2em;
            font-size: 0.9em;
        }
        .choice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            min-height: 50px;
        }
        #equation-display, .choice-equation {
            gap: 0.25rem; /* For spacing between equation parts */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-2">

    <!-- Start Screen -->
    <div id="start-screen" class="w-full max-w-2xl mx-auto p-4 flex flex-col items-center justify-center text-center">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full">
            <h1 id="start-title" class="text-3xl md:text-4xl font-bold text-sky-700">لعبة الميل والمقطع</h1>
            
            <p id="welcomeMessage" class="text-slate-500 mt-2 text-lg">تعلم كيفية إيجاد الميل والمقطع ورسم المستقيم</p>

            <div id="final-result-display" class="my-4 text-center"></div>

            <div id="author-info" class="my-8">
                <p class="text-slate-600">إعداد وبرمجة</p>
                <p class="text-xl font-bold text-slate-800">أ. عبدالعزيز خالد العبلان</p>
            </div>

            <button id="start-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-sky-700">
                ابدأ اللعبة
            </button>

            <div id="leaderboard-loader" style="display: none;" class="mt-4">
                <p>جاري تحميل سجل الأبطال...</p>
            </div>
            <div id="leaderboard-container"></div>

            <div id="finish-game-wrapper" style="display: none;" class="mt-6">
                <button id="finish-game-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-gray-600">
                    العودة إلى المنصة
                </button>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-2xl mx-auto flex flex-col items-center justify-center space-y-3 hidden">
        <main class="w-full bg-white p-4 rounded-xl shadow-lg flex flex-col items-center space-y-3">
            
            <div class="w-full flex justify-between items-center px-2">
                <div id="score-display" class="font-bold text-sky-700 text-base">الدرجة: ٠ / ١٠</div>
                <div id="timer-display" class="font-bold text-red-600 text-base">٠٠:٠٠</div>
                <div id="question-counter" class="text-slate-500 text-sm">السؤال ١ / ٥</div>
            </div>

            <div class="text-center w-full">
                <h2 id="stage-title" class="text-base font-bold text-sky-600">المرحلة 1: أوجد الميل والمقطع</h2>
                <p id="instruction" class="text-sm">من المعادلة التالية:</p>
                <div id="equation-display" class="text-xl font-bold my-2 bg-slate-100 p-2 rounded-lg inline-flex items-center justify-center"></div>
                <p id="word-problem-display" class="text-slate-700 text-center hidden p-3 text-base bg-sky-50 border-2 border-sky-200 rounded-lg w-full max-w-sm mx-auto"></p>
            </div>

            <div id="stage1-choices" class="w-full max-w-sm grid grid-cols-2 gap-3">
                <button class="choice-btn border-2 border-slate-300 p-2 rounded-lg hover:bg-sky-100 hover:border-sky-400 transition"></button>
                <button class="choice-btn border-2 border-slate-300 p-2 rounded-lg hover:bg-sky-100 hover:border-sky-400 transition"></button>
                <button class="choice-btn border-2 border-slate-300 p-2 rounded-lg hover:bg-sky-100 hover:border-sky-400 transition"></button>
                <button class="choice-btn border-2 border-slate-300 p-2 rounded-lg hover:bg-sky-100 hover:border-sky-400 transition"></button>
            </div>

            <div id="stage2-canvas" class="hidden w-full aspect-square max-w-sm relative">
                <canvas id="graph-canvas"></canvas>
                <div id="animation-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none flex items-start justify-center p-2">
                    <div id="intercept-popup" class="hidden bg-white/90 backdrop-blur-sm text-sky-600 font-bold p-2 rounded-lg shadow-lg"></div>
                    <div id="slope-popup" class="hidden bg-white/90 backdrop-blur-sm font-bold p-2 rounded-lg shadow-lg flex items-center gap-1"></div>
                </div>
            </div>


            <div id="feedback" class="h-5 text-center text-sm font-bold"></div>
            
            <div id="explanation-panel" class="hidden w-full max-w-sm p-3 my-1 bg-sky-50 border-2 border-sky-200 rounded-lg text-sm text-center"></div>

            <div id="action-buttons" class="w-full flex justify-center pt-1 gap-2">
                 <button id="draw-reset-btn" class="hidden bg-amber-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-amber-600 transition-transform transform hover:scale-105 text-sm">مسح الرسم</button>
                 <button id="replay-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-600 transition-transform transform hover:scale-105 text-sm">إعادة الشرح</button>
                 <button id="know-why-btn" class="hidden bg-sky-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-sky-700 transition-transform transform hover:scale-105 text-sm">اعرف لماذا؟</button>
                 <button id="continue-btn" class="hidden bg-sky-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-sky-600 transition-transform transform hover:scale-105 text-sm">متابعة إلى الرسم</button>
                 <button id="next-btn" class="hidden bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition-transform transform hover:scale-105 text-sm">السؤال التالي</button>
            </div>
        </main>
    </div>

<script>
    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen'), startBtn = document.getElementById('start-btn'), startTitle = document.getElementById('start-title');
    const authorInfo = document.getElementById('author-info');
    const gameContainer = document.getElementById('game-container');
    const scoreDisplay = document.getElementById('score-display'), questionCounter = document.getElementById('question-counter'), timerDisplay = document.getElementById('timer-display');
    const stageTitle = document.getElementById('stage-title'), instruction = document.getElementById('instruction');
    const equationDisplay = document.getElementById('equation-display'), wordProblemDisplay = document.getElementById('word-problem-display');
    const stage1Choices = document.getElementById('stage1-choices'), choiceBtns = document.querySelectorAll('.choice-btn');
    const stage2CanvasContainer = document.getElementById('stage2-canvas'), canvas = document.getElementById('graph-canvas'), ctx = canvas.getContext('2d');
    const interceptPopup = document.getElementById('intercept-popup'), slopePopup = document.getElementById('slope-popup');
    const feedback = document.getElementById('feedback'), explanationPanel = document.getElementById('explanation-panel');
    const actionButtons = document.getElementById('action-buttons'), drawResetBtn = document.getElementById('draw-reset-btn'), replayBtn = document.getElementById('replay-btn'), knowWhyBtn = document.getElementById('know-why-btn'), continueBtn = document.getElementById('continue-btn'), nextBtn = document.getElementById('next-btn');

    // --- Game State & Config ---
    const TOTAL_QUESTIONS = 5;
    let gameState = { stage: 1, score: 0, currentProblem: null, userPoints: [], questionsCompleted: 0, isAnimating: false, totalSeconds: 0, timerInterval: null, isTimerRunning: false };
    let gameQuestions = [];
    
    const questionBank = {
        group1: [ { type: 'equation', m: 2, b: 1, displayM: {n: 2, d: 1} }, { type: 'equation', m: 1, b: -5, displayM: {n: 1, d: 1} }, { type: 'equation', m: -2, b: 4, displayM: {n: -2, d: 1} }, { type: 'equation', m: -3, b: -1, displayM: {n: -3, d: 1} } ],
        group2: [ { type: 'equation', m: 0.5, b: 2, displayM: { n: 1, d: 2 } }, { type: 'equation', m: -1/3, b: 1, displayM: { n: -1, d: 3 } }, { type: 'equation', m: 0.75, b: -2, displayM: { n: 3, d: 4 } } ],
        group3: [ { type: 'equation', m: 0, b: 3, displayM: {n: 0, d: 1} }, { type: 'equation', m: 4, b: 0, displayM: {n: 4, d: 1} }, { type: 'equation', m: -2, b: 0, displayM: {n: -2, d: 1} } ],
        group4: [ { type: 'unarranged', original: 'ص - ٢س = ٥', m: 2, b: 5, displayM: {n: 2, d: 1} }, { type: 'unarranged', original: '٣س + ص = ٧', m: -3, b: 7, displayM: {n: -3, d: 1} }, { type: 'unarranged', original: '٢ص = ٤س + ٦', m: 2, b: 3, displayM: {n: 2, d: 1} }, { type: 'unarranged', original: '٦س + ٣ص = ٩', m: -2, b: 3, displayM: {n: -2, d: 1} } ],
        group5: [ { type: 'word', text: 'لدى سالم ٤ ريالات ويوفر ريالين كل يوم.', m: 2, b: 4, displayM: {n: 2, d: 1} }, { type: 'word', text: 'كان ارتفاع الماء في خزان ٨ أمتار، وينقص بمقدار متر واحد كل ساعة.', m: -1, b: 8, displayM: {n: -1, d: 1} }, { type: 'word', text: 'تكلفة استئجار دراجة ٣ ريالات، يضاف إليها ريال واحد لكل ساعة.', m: 1, b: 3, displayM: {n: 1, d: 1} } ]
    };

    let animState = { reqId: null, startTime: null, duration: 800, step: 'intercept' };
    const RISE_COLOR = '#fb923c', RUN_COLOR = '#4ade80', INTERCEPT_COLOR = '#0ea5e9';

    // --- Utility & Setup ---
    const toArabicNumerals = (numStr) => String(numStr).replace(/[0-9-]/g, d => '٠١٢٣٤٥٦٧٨٩-'[d === '-' ? 10 : parseInt(d)]);
    let canvasSize, gridSize, unit, maxGridValue = 10;
    const setupCanvas = () => { canvas.width = stage2CanvasContainer.clientWidth; canvas.height = canvas.width; canvasSize = canvas.width; gridSize = canvasSize; unit = gridSize / (2 * maxGridValue); drawGrid(); };
    window.addEventListener('resize', setupCanvas);

    // --- Timer Functions ---
    const formatTime = (totalSeconds) => {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const paddedSeconds = String(seconds).padStart(2, '0');
        const paddedMinutes = String(minutes).padStart(2, '0');
        return `${toArabicNumerals(paddedMinutes)}:${toArabicNumerals(paddedSeconds)}`;
    };
    const startTimer = () => { 
        if (!gameState.isTimerRunning) { 
            gameState.isTimerRunning = true; 
            gameState.timerInterval = setInterval(() => { 
                gameState.totalSeconds++; 
                timerDisplay.textContent = formatTime(gameState.totalSeconds);
            }, 1000); 
        } 
    };
    const stopTimer = () => { 
        gameState.isTimerRunning = false; 
        clearInterval(gameState.timerInterval); 
        timerDisplay.textContent = formatTime(gameState.totalSeconds);
    };

    // --- Drawing & Animation ---
    function drawGrid() { maxGridValue = 10; unit = gridSize / (2 * maxGridValue); ctx.clearRect(0, 0, canvasSize, canvasSize); ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1; const origin = toCanvasCoord(0, 0); for (let i = -maxGridValue; i <= maxGridValue; i++) { let pos = toCanvasCoord(i, 0).x; ctx.beginPath(); ctx.moveTo(pos, 0); ctx.lineTo(pos, gridSize); ctx.stroke(); pos = toCanvasCoord(0, i).y; ctx.beginPath(); ctx.moveTo(0, pos); ctx.lineTo(gridSize, pos); ctx.stroke(); } ctx.strokeStyle = '#475569'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, origin.y); ctx.lineTo(gridSize, origin.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, gridSize); ctx.stroke(); ctx.fillStyle = '#64748b'; ctx.font = `${Math.max(10, canvasSize/40)}px Cairo`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; const step = 2; for (let i = -maxGridValue; i <= maxGridValue; i++) { if (i !== 0 && i % step === 0) { ctx.fillText(toArabicNumerals(i), toCanvasCoord(i, 0).x, origin.y + 15); ctx.fillText(toArabicNumerals(i), origin.x - 15, toCanvasCoord(0, i).y); } } }
    const toCanvasCoord = (x, y) => ({ x: (x * unit) + (gridSize / 2), y: (-y * unit) + (gridSize / 2) });
    const fromCanvasCoord = (canvX, canvY) => ({ x: Math.round((canvX - gridSize / 2) / unit), y: Math.round(-(canvY - gridSize / 2) / unit) });
    function drawPoint(point, color = '#0284c7', size = 5) { /* ... (unchanged) ... */ const { x, y } = toCanvasCoord(point.x, point.y); ctx.beginPath(); ctx.fillStyle = color; ctx.arc(x, y, size, 0, 2 * Math.PI); ctx.fill(); }
    function drawErrorX(point, color = '#ef4444', size = 6) { /* ... (unchanged) ... */ const { x, y } = toCanvasCoord(point.x, point.y); ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.moveTo(x - size, y - size); ctx.lineTo(x + size, y + size); ctx.moveTo(x + size, y - size); ctx.lineTo(x - size, y + size); ctx.stroke(); }
    function drawFinalLine(color = '#0ea5e9', width = 3) { /* ... (unchanged) ... */ const { m, b } = gameState.currentProblem; const { x: sx, y: sy } = toCanvasCoord(-maxGridValue, m * -maxGridValue + b); const { x: ex, y: ey } = toCanvasCoord(maxGridValue, m * maxGridValue + b); ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke(); }
    function animateCorrectDrawing() { gameState.isAnimating = true; replayBtn.classList.add('hidden'); nextBtn.classList.add('hidden'); continueBtn.classList.add('hidden'); const { b, displayM } = gameState.currentProblem; const { n: rise, d: run } = displayM; animState = { reqId: null, startTime: null, step: 'showInterceptText', duration: 1500, interceptPt: {x: 0, y: b}, finalPt: {x: run, y: b + rise} }; requestAnimationFrame(animationLoop); }
    function populateSlopePopup(numeratorColor, denominatorColor) { const { displayM } = gameState.currentProblem; const numText = toArabicNumerals(displayM.n); const denText = toArabicNumerals(displayM.d); slopePopup.innerHTML = `<span class="text-slate-700">الميل =</span><div class="fraction"><span class="numerator" style="color: ${numeratorColor};">${numText}</span><span class="denominator" style="color: ${denominatorColor};">${denText}</span></div>`; }
    function animationLoop(timestamp) { if (!animState.startTime) animState.startTime = timestamp; const elapsed = timestamp - animState.startTime; let p = Math.min(elapsed / animState.duration, 1); drawGrid(); if (gameState.userPoints.length > 0) { gameState.userPoints.forEach(pt => drawErrorX(pt)); } const { interceptPt, finalPt } = animState; const { n: rise, d: run } = gameState.currentProblem.displayM; const i_c = toCanvasCoord(interceptPt.x, interceptPt.y); interceptPopup.classList.add('hidden'); slopePopup.classList.add('hidden'); switch (animState.step) { case 'showInterceptText': interceptPopup.classList.remove('hidden'); interceptPopup.textContent = `ب = ${toArabicNumerals(interceptPt.y)}`; drawPoint({x: 0, y: 0}, INTERCEPT_COLOR, 7); if (p >= 1) { animState.step = 'animateInterceptPoint'; animState.startTime = timestamp; animState.duration = 1000; } break; case 'animateInterceptPoint': interceptPopup.classList.remove('hidden'); interceptPopup.textContent = `ب = ${toArabicNumerals(interceptPt.y)}`; const currentY = interceptPt.y * p; drawPoint({x: 0, y: currentY}, INTERCEPT_COLOR, 7); if (p >= 1) { animState.step = 'showSlopeText'; animState.startTime = timestamp; animState.duration = 2000; } break; case 'showSlopeText': drawPoint(interceptPt, INTERCEPT_COLOR, 7); slopePopup.classList.remove('hidden'); populateSlopePopup(RISE_COLOR, '#64748b'); if (p >= 1) { animState.step = 'animateRise'; animState.startTime = timestamp; animState.duration = 1500; } break; case 'animateRise': drawPoint(interceptPt, INTERCEPT_COLOR, 7); slopePopup.classList.remove('hidden'); populateSlopePopup(RISE_COLOR, '#64748b'); const riseEndY = interceptPt.y + rise * p; const r_c_end = toCanvasCoord(interceptPt.x, riseEndY); ctx.beginPath(); ctx.strokeStyle = RISE_COLOR; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.moveTo(i_c.x, i_c.y); ctx.lineTo(r_c_end.x, r_c_end.y); ctx.stroke(); ctx.setLineDash([]); drawPoint({x: interceptPt.x, y: riseEndY}, RISE_COLOR, 7); if (p >= 1) { animState.step = 'animateRun'; animState.startTime = timestamp; animState.duration = 1500; } break; case 'animateRun': drawPoint(interceptPt, INTERCEPT_COLOR, 7); slopePopup.classList.remove('hidden'); populateSlopePopup('#64748b', RUN_COLOR); const riseEndPt = {x: interceptPt.x, y: interceptPt.y + rise}; const r_c_end_static = toCanvasCoord(riseEndPt.x, riseEndPt.y); ctx.beginPath(); ctx.strokeStyle = RISE_COLOR; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.moveTo(i_c.x, i_c.y); ctx.lineTo(r_c_end_static.x, r_c_end_static.y); ctx.stroke(); const runEndX = interceptPt.x + run * p; const run_c_end = toCanvasCoord(runEndX, riseEndPt.y); ctx.strokeStyle = RUN_COLOR; ctx.moveTo(r_c_end_static.x, r_c_end_static.y); ctx.lineTo(run_c_end.x, run_c_end.y); ctx.stroke(); ctx.setLineDash([]); drawPoint({x: runEndX, y: riseEndPt.y}, RUN_COLOR, 7); if (p >= 1) { animState.step = 'drawLine'; animState.startTime = timestamp; animState.duration = 800; } break; case 'drawLine': drawPoint(interceptPt, INTERCEPT_COLOR); drawPoint(finalPt, RUN_COLOR); drawFinalLine('#10b981'); if (p >= 1) { animState.step = 'done'; } break; } if (animState.step !== 'done') { requestAnimationFrame(animationLoop); } else { gameState.isAnimating = false; nextBtn.classList.remove('hidden'); replayBtn.classList.remove('hidden'); interceptPopup.classList.add('hidden'); slopePopup.classList.add('hidden'); } }
    
    // --- Game Logic ---
    function updateScoreDisplay() { scoreDisplay.textContent = `الدرجة: ${toArabicNumerals(gameState.score)} / ${toArabicNumerals(TOTAL_QUESTIONS * 2)}`; }
    function formatValue(val, display) { const createSpan = (content) => { const span = document.createElement('span'); span.innerHTML = content; return span; }; if (display && display.d !== 1) { const sign = display.n < 0 ? '-' : ''; const fractionHTML = `<div class="fraction"><span class="numerator">${toArabicNumerals(Math.abs(display.n))}</span><span class="denominator">${toArabicNumerals(display.d)}</span></div>`; return createSpan(sign + fractionHTML); } return createSpan(toArabicNumerals(val)); }
    function buildEquationHTML(data) { const container = document.createElement('div'); container.className = 'inline-flex items-center choice-equation'; const createSpan = (text) => { const span = document.createElement('span'); span.textContent = text; return span; }; container.appendChild(createSpan('ص')); container.appendChild(createSpan('=')); let hasContent = false; if (data.m !== 0) { const slopeContainer = document.createElement('div'); slopeContainer.className = 'inline-flex items-center'; if (data.m === 1) {} else if (data.m === -1) { slopeContainer.appendChild(createSpan('-')); } else { slopeContainer.appendChild(formatValue(data.m, data.displayM)); } slopeContainer.appendChild(createSpan('س')); container.appendChild(slopeContainer); hasContent = true; } if (data.b !== 0) { if (hasContent) { container.appendChild(createSpan(data.b > 0 ? '+' : '-')); } else if (data.b < 0) { container.appendChild(createSpan('-')); } container.appendChild(createSpan(toArabicNumerals(Math.abs(data.b)))); hasContent = true; } if (!hasContent) { container.appendChild(createSpan(toArabicNumerals(0))); } return container; }
    
    function generateChoices(correct) { const choices = [{ ...correct, isCorrect: true }]; const added = new Set([`${correct.m},${correct.b}`]); const distractors = [ { m: -correct.m, b: correct.b, displayM: correct.displayM ? {n: -correct.displayM.n, d: correct.displayM.d} : undefined }, { m: correct.m, b: -correct.b, displayM: correct.displayM }, { m: correct.b, b: correct.m }, { m: -correct.m, b: -correct.b, displayM: correct.displayM ? {n: -correct.displayM.n, d: correct.displayM.d} : undefined } ].sort(() => Math.random() - 0.5); for (const d of distractors) { if (choices.length >= 4) break; if (!added.has(`${d.m},${d.b}`)) { const choice = {...d}; if(Math.abs(choice.m) < 1 && Math.abs(choice.m) > 0 && !choice.displayM){} else { choices.push({ ...choice, isCorrect: false }); added.add(`${d.m},${d.b}`); } } } while(choices.length < 4) { const randM = Math.floor(Math.random() * 5) - 2; const randB = Math.floor(Math.random() * 5) - 2; if(!added.has(`${randM},${randB}`)) { choices.push({m: randM, b: randB, isCorrect: false}); added.add(`${randM},${randB}`); } } return choices.sort(() => Math.random() - 0.5); }
    
    function populateChoices(choices) {
        choiceBtns.forEach((btn, i) => {
            const c = choices[i]; btn.innerHTML = ''; 
            if (gameState.currentProblem.type === 'word' || gameState.currentProblem.type === 'unarranged') { btn.appendChild(buildEquationHTML(c)); } 
            else { const mFormatted = formatValue(c.m, c.displayM); const bFormatted = formatValue(c.b, undefined); btn.innerHTML = `م&nbsp;=&nbsp;<span class="font-bold">${mFormatted.innerHTML}</span>&nbsp;،&nbsp;ب&nbsp;=&nbsp;<span class="font-bold">${bFormatted.innerHTML}</span>`; }
            btn.onclick = (e) => handleChoiceClick(e.currentTarget, c.isCorrect); btn.disabled = false; btn.className = 'choice-btn text-sm sm:text-base bg-white border-2 border-slate-300 p-2 rounded-lg hover:bg-sky-100 hover:border-sky-400 transition';
        });
    }

    function handleChoiceClick(btn, isCorrect) { stopTimer(); choiceBtns.forEach(b => b.disabled = true); btn.className = btn.className.replace(/border-slate-300|bg-white|hover:bg-sky-100|hover:border-sky-400/g, isCorrect ? 'border-emerald-500 bg-emerald-100' : 'border-red-500 bg-red-100'); if (isCorrect) { showFeedback('أحسنت! إجابة صحيحة.', 'success'); gameState.score++; updateScoreDisplay(); continueBtn.classList.remove('hidden'); } else { showFeedback('إجابة خاطئة.', 'error'); knowWhyBtn.classList.remove('hidden'); continueBtn.classList.remove('hidden'); } }
    function checkStage2() { stopTimer(); if(gameState.isAnimating) return; const { m, b } = gameState.currentProblem; const [p1, p2] = gameState.userPoints; const onIntercept = (p1.x === 0 && p1.y === b) || (p2.x === 0 && p2.y === b); const p1OnLine = Math.abs(p1.y - (m * p1.x + b)) < 0.01; const p2OnLine = Math.abs(p2.y - (m * p2.x + b)) < 0.01; if (onIntercept && p1OnLine && p2OnLine) { showFeedback('رائع! رسم صحيح.', 'success'); gameState.score++; updateScoreDisplay(); drawFinalLine('#10b981'); nextBtn.classList.remove('hidden'); drawResetBtn.classList.add('hidden'); } else { showFeedback('الرسم غير دقيق، شاهد الشرح.', 'error'); drawResetBtn.classList.add('hidden'); drawGrid(); gameState.userPoints.forEach(pt => drawErrorX(pt)); setTimeout(animateCorrectDrawing, 500); } }
    
    function generateGameQuestions() {
        const groups = Object.values(questionBank);
        gameQuestions = groups.map(group => {
            const randomIndex = Math.floor(Math.random() * group.length);
            return group[randomIndex];
        });
    }

    function resetForNewProblem() {
        if (gameState.questionsCompleted >= TOTAL_QUESTIONS) { endGame(); return; }
        gameState.currentProblem = gameQuestions[gameState.questionsCompleted];
        const { type, original } = gameState.currentProblem;
        gameState.stage = (type === 'word' || type === 'unarranged') ? 3 : 1; // Group word and unarranged together for display logic
        gameState.userPoints = []; feedback.textContent = '';
        questionCounter.textContent = `السؤال ${toArabicNumerals(gameState.questionsCompleted + 1)} / ${toArabicNumerals(TOTAL_QUESTIONS)}`;
        
        if (type === 'word') {
            wordProblemDisplay.textContent = gameState.currentProblem.text;
            equationDisplay.innerHTML = '';
        } else if (type === 'unarranged') {
            equationDisplay.innerHTML = `<span>${original.replace(/(\d)/g, (match) => toArabicNumerals(match))}</span>`;
            wordProblemDisplay.textContent = '';
        } else {
            const equationContainer = buildEquationHTML(gameState.currentProblem);
            equationDisplay.innerHTML = equationContainer.innerHTML;
            wordProblemDisplay.textContent = '';
        }
        
        const choices = generateChoices(gameState.currentProblem);
        populateChoices(choices); updateUIForStage();
        startTimer();
    }
    function updateUIForStage() { 
        actionButtons.classList.remove('hidden'); nextBtn.classList.add('hidden'); drawResetBtn.classList.add('hidden'); knowWhyBtn.classList.add('hidden'); replayBtn.classList.add('hidden'); continueBtn.classList.add('hidden'); explanationPanel.classList.add('hidden');
        const isStage1Type = gameState.stage !== 2;
        stageTitle.textContent = isStage1Type ? 'المرحلة 1: أوجد الميل والمقطع' : 'المرحلة 2: ارسم المستقيم';
        if(gameState.currentProblem.type === 'word') {
             instruction.textContent = '١. استنتج المعادلة من النص التالي:';
        } else if (gameState.currentProblem.type === 'unarranged') {
            instruction.textContent = '١. رتب المعادلة ثم اختر الإجابة الصحيحة:';
        } else {
            instruction.textContent = 'من المعادلة التالية:';
        }
        
        wordProblemDisplay.classList.toggle('hidden', gameState.currentProblem.type !== 'word'); 
        equationDisplay.classList.toggle('hidden', gameState.currentProblem.type === 'word');
        stage1Choices.classList.toggle('hidden', !isStage1Type); stage2CanvasContainer.classList.toggle('hidden', isStage1Type);
        if (!isStage1Type) { drawResetBtn.classList.remove('hidden'); setupCanvas(); startTimer(); }
    }
    function endGame() {
        stopTimer();
        gameContainer.classList.add('hidden');
        startScreen.classList.remove('hidden');

        startTitle.textContent = 'انتهت اللعبة!';
        document.getElementById('welcomeMessage').classList.add('hidden');
        authorInfo.classList.add('hidden');
        
        startBtn.textContent = 'العب مرة أخرى';
        
        if (window.saveAndFinishGame) {
            window.saveAndFinishGame(gameState.score, gameState.totalSeconds);
        }
    }
    const showFeedback = (msg, type) => { /* ... (unchanged) ... */ feedback.textContent = msg; feedback.className = `h-5 text-center text-sm font-bold ${type === 'success' ? 'text-emerald-600' : 'text-red-500'}`; };
    const resetDrawing = () => { if(gameState.isAnimating) return; gameState.userPoints = []; drawGrid(); feedback.textContent = ''; };

    // --- Event Listeners ---
    startBtn.addEventListener('click', () => { 
        const startQuestion = 0;
        gameState = { stage: 1, score: 0, currentProblem: null, userPoints: [], questionsCompleted: startQuestion, isAnimating: false, totalSeconds: 0, timerInterval: null, isTimerRunning: false }; 
        generateGameQuestions();
        updateScoreDisplay(); 
        timerDisplay.textContent = formatTime(0);
        document.getElementById('welcomeMessage').classList.remove('hidden');
        authorInfo.classList.remove('hidden');
        document.getElementById('final-result-display').innerHTML = '';
        document.getElementById('leaderboard-container').innerHTML = '';
        document.getElementById('finish-game-wrapper').style.display = 'none';
        startBtn.textContent = 'ابدأ اللعبة';
        startScreen.classList.add('hidden'); 
        gameContainer.classList.remove('hidden'); 
        resetForNewProblem(); 
    });
    nextBtn.addEventListener('click', () => { gameState.questionsCompleted++; resetForNewProblem(); });
    continueBtn.addEventListener('click', () => { feedback.textContent = ''; gameState.stage = 2; updateUIForStage(); });
    drawResetBtn.addEventListener('click', resetDrawing);
    replayBtn.addEventListener('click', animateCorrectDrawing);
    knowWhyBtn.addEventListener('click', () => {
        const { m, b, displayM, type, original } = gameState.currentProblem;
        if (type === 'word') {
             explanationPanel.innerHTML = `من النص: <br/><b>نقطة البداية (ب)</b> هي القيمة الأولية أو الثابتة. <br/><b>معدل التغيير (م)</b> هو القيمة التي تزيد أو تنقص بشكل متكرر. <br/>الحل الصحيح: ب = ${toArabicNumerals(b)}، م = ${toArabicNumerals(m)}`;
        } else if (type === 'unarranged') {
            const arrangedEq = buildEquationHTML(gameState.currentProblem);
            explanationPanel.innerHTML = `المعادلة الأصلية: ${original.replace(/(\d)/g, (match) => toArabicNumerals(match))}<br/>بعد الترتيب تصبح:<br/>${arrangedEq.innerHTML}<br/>إذن الميل = ${toArabicNumerals(m)}، والمقطع = ${toArabicNumerals(b)}`;
        }
        else {
             const mFormatted = formatValue(m, displayM);
             const bFormatted = formatValue(b, undefined);
             explanationPanel.innerHTML = `الحل الصحيح هو: <br/> الميل (م) هو معامل س = <b>${mFormatted.innerHTML}</b> <br/> المقطع الصادي (ب) هو العدد الثابت = <b>${bFormatted.innerHTML}</b>`;
        }
        explanationPanel.classList.remove('hidden');
    });
    canvas.addEventListener('click', (event) => {
        if (gameState.userPoints.length >= 2 || gameState.isAnimating) return;
        const rect = canvas.getBoundingClientRect(); const point = fromCanvasCoord(event.clientX - rect.left, event.clientY - rect.top);
        gameState.userPoints.push(point); drawGrid(); gameState.userPoints.forEach(p => drawPoint(p));
        if (gameState.userPoints.length === 2) checkStage2();
    });
</script>

<script>
// --- START OF CONNECTION & LEADERBOARD ENGINE ---
(function() {
    // --- CONFIGURATION (عدّل هذه الإعدادات لكل لعبة) ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const GAME_ID = 'g3_1_2';         // مثال: 'g1_1_1'
    const GAME_MAX_POINTS = 10;                     // أقصى نقاط في اللعبة
    const PLATFORM_MAX_GRADE = 5;                   // الدرجة النهائية في المنصة
    const METRIC_TYPE = 'time';                     // نوع المعيار: 'time', 'stars', 'errors'
    const METRIC_LABEL = 'الوقت (ثواني)';           // اسم المعيار للعرض في الجدول

    // --- Read URL Parameters ---
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const classId = urlParams.get('classId');
    const studentName = urlParams.get('studentName');

    let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

    // --- CORE FUNCTIONS ---

    // 1. الدالة الرئيسية التي تستدعيها عند انتهاء اللعبة
    window.saveAndFinishGame = function(points, metricValue) {
        const finalPoints = parseFloat(points) || 0;
        const finalMetric = parseFloat(metricValue) || 0;
        const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
        const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

        const resultDisplay = document.getElementById('final-result-display');
        if (resultDisplay) {
            resultDisplay.innerHTML = `
                <p class="text-gray-700">النقاط: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                <p class="text-blue-600">الدرجة في المنصة: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
            `;
        }

        if (studentId && classId) {
            const params = new URLSearchParams({
                action: 'saveGrade',
                studentId: studentId,
                classId: classId,
                itemId: GAME_ID,
                grade: finalGrade.toFixed(2),
                metricValue: Math.round(finalMetric).toString()
            });
            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(result => console.log('Save result:', result.status))
                .catch(err => console.error("Save Error:", err))
                .finally(fetchAndShowLeaderboard);
        } else {
            console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
            fetchAndShowLeaderboard();
        }
    }

    // 2. دالة جلب وعرض سجل الأبطال
    function fetchAndShowLeaderboard() {
        const loader = document.getElementById('leaderboard-loader');
        const container = document.getElementById('leaderboard-container');
        if (!loader || !container) return;
        
        if (!classId) {
            console.log("No classId found, skipping leaderboard for visitor.");
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">سجل الأبطال متاح للطلاب المسجلين فقط.</p>`;
            showFinishButton();
            return;
        }

        loader.style.display = 'block';
        container.innerHTML = '';

        const params = new URLSearchParams({
            action: 'getLeaderboard',
            gameId: GAME_ID,
            metricType: METRIC_TYPE,
            classId: classId
        });

        fetch(`${SCRIPT_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success' && response.data) {
                    displayLeaderboard(response.data);
                } else {
                    throw new Error(response.message || 'Failed to load leaderboard data.');
                }
            })
            .catch(err => {
                console.error("Leaderboard Error:", err);
                container.innerHTML = `<p class="text-center text-red-500">حدث خطأ في تحميل سجل الأبطال.</p>`;
            })
            .finally(() => {
                loader.style.display = 'none';
                showFinishButton();
            });
    }
    
    // 3. دالة بناء جدول سجل الأبطال
    function displayLeaderboard(data) {
        const container = document.getElementById('leaderboard-container');
        if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">لا توجد نتائج بعد. كن أول الأبطال!</p>`;
            return;
        }

        let tableHTML = `
            <div class="mt-6 border-t pt-4">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">🏆 سجل الأبطال 🏆</h3>
                <table class="min-w-full bg-white shadow-md rounded-lg">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="text-center py-2 px-3">الترتيب</th>
                            <th class="text-right py-2 px-3">اسم الطالب</th>
                            <th class="text-center py-2 px-3">الدرجة</th>
                            <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">`;

        data.forEach((player, index) => {
            const rank = index + 1;
            let rankDisplay = rank;
            if (rank === 1) rankDisplay = '🥇';
            if (rank === 2) rankDisplay = '🥈';
            if (rank === 3) rankDisplay = '🥉';

            const isCurrentUser = (currentUser && player.name === currentUser.name);
            const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

            tableHTML += `
                <tr class="${rowClass}">
                    <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                    <td class="text-right py-2 px-3">${player.name}</td>
                    <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                    <td class="text-center py-2 px-3">${player.metricValue}</td>
                </tr>`;
        });

        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    // 4. إظهار زر الإنهاء
    function showFinishButton() {
        const finishWrapper = document.getElementById('finish-game-wrapper');
        if (finishWrapper) {
            finishWrapper.style.display = 'block';
        }
    }

    // 5. التعامل مع زر الإنهاء وتخصيص رسالة الترحيب
    document.addEventListener('DOMContentLoaded', () => {
        // Personalize welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (studentName && welcomeMessage) {
            welcomeMessage.innerHTML = `أهلاً بك يا <span class="font-bold text-yellow-300">${studentName}</span>! انطلق في رحلتك عبر الجبال الغامضة، وحل الألغاز الرياضية لتجاوز العقبات والوصول إلى القمة. كل إجابة صحيحة تقربك من هدفك!`;
        }

        const finishBtn = document.getElementById('finish-game-btn');
        if (finishBtn) {
            finishBtn.addEventListener('click', () => {
                window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
            });
        }
    });
})();
// --- END OF CONNECTION & LEADERBOARD ENGINE ---
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- متغيرات التصميم --- */
        :root {
            --primary: #2563eb;         
            --primary-dark: #1e40af;    
            --primary-light: #eff6ff;   
            --gradient-start: #3b82f6;
            --gradient-end: #1d4ed8;
            --bg-color: #f3f4f6;
            --header-height-mobile: 65px;
            --header-height-desktop: 80px;
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: #1f2937;
            min-height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            margin: 0;
            transition: background-color 0.5s ease;
        }

        .text-theme { color: var(--primary); }
        .bg-theme-light { background-color: var(--primary-light); }
        .border-theme { border-color: var(--primary); }
        
        /* --- الهيدر الرئيسي للمنصة (تحديث: شفافية وزخرفة) --- */
        .app-header {
            padding: 0 1rem; 
            display: grid;
            grid-template-columns: 1fr auto 1fr; 
            align-items: flex-start;
            /* التحديث: خلفية شفافة مع تمويه */
            background: rgba(255, 255, 255, 0.90); /* تقليل الشفافية قليلاً لزيادة وضوح الأيقونات */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            z-index: 50; 
            flex-shrink: 0;
            height: var(--header-height-mobile);
            position: sticky;
            top: 0;
            overflow: hidden; /* لضمان عدم خروج الزخرفة */
        }
        @media (min-width: 768px) { 
            .app-header { height: var(--header-height-desktop); padding: 0 2rem; align-items: center; } 
        }
        
        /* طبقة الزخرفة الخلفية للهيدر - تحسين الوضوح */
        .header-bg-decoration {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        
        .header-bg-icon {
            position: absolute;
            color: var(--primary);
            opacity: 0.12; /* زيادة الشفافية لتصبح أكثر وضوحاً */
            font-size: 1.8rem;
            transform: rotate(-15deg);
            transition: all 0.5s ease;
        }
        
        /* تنويع أحجام وشفافية الأيقونات */
        .icon-lg { font-size: 2.5rem; opacity: 0.08; }
        .icon-md { font-size: 1.5rem; opacity: 0.15; }
        .icon-sm { font-size: 1rem; opacity: 0.2; }
        
        .header-right-group, .header-center-group, .header-left-group {
            position: relative;
            z-index: 10; /* لضمان ظهور المحتوى فوق الزخرفة */
        }

        .header-right-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 12px; }
        @media (min-width: 768px) { .header-right-group { margin-top: 0; } }

        .user-info { 
            display: flex; align-items: center; gap: 0.5rem; 
            font-weight: 800; color: #4b5563; font-size: 0.85rem; 
            cursor: pointer; transition: opacity 0.2s;
            background: rgba(241, 245, 249, 0.9); /* زيادة التباين للخلفية */
            padding: 4px 10px 4px 4px; border-radius: 99px;
            border: 1px solid rgba(203, 213, 225, 0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .user-info:active { opacity: 0.7; }
        
        .user-name-text { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }
        @media (min-width: 768px) { .user-name-text { max-width: 200px; font-size: 0.95rem; } }

        .user-avatar { 
            width: 32px; height: 32px; font-size: 0.9rem;
            border-radius: 50%; background: var(--primary); color: white; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-center-group { display: flex; justify-content: center; }
        .header-title-badge {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.6rem 1.5rem 0.8rem 1.5rem;
            border-radius: 0 0 1.2rem 1.2rem; 
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            text-align: center; z-index: 45; min-width: 140px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        @media (min-width: 768px) { .header-title-badge { padding: 0.8rem 3rem 1.2rem 3rem; border-radius: 0 0 2rem 2rem; min-width: 300px; } }

        .app-title-main { font-size: 0.85rem; font-weight: 900; letter-spacing: -0.5px; line-height: 1.2; text-shadow: 0 2px 2px rgba(0,0,0,0.1); }
        .app-subtitle { font-size: 0.6rem; font-weight: 600; opacity: 0.9; margin-top: 2px; color: #dbeafe; }
        @media (min-width: 768px) { .app-title-main { font-size: 1.4rem; } .app-subtitle { font-size: 0.8rem; margin-top: 4px; } }

        .header-left-group { display: flex; align-items: center; justify-content: flex-end; gap: 0.6rem; margin-top: 12px; }
        @media (min-width: 768px) { .header-left-group { margin-top: 0; } }

        .logout-btn {
            width: 36px; height: 36px; border-radius: 50%; background: #fee2e2; color: #ef4444; 
            border: 1px solid #fecaca; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; font-size: 0.9rem; flex-shrink: 0;
        }
        .score-badge { 
            background: #fffbeb; color: #b45309; padding: 0.3rem 0.7rem; border-radius: 99px; 
            font-size: 0.85rem; font-weight: 800; border: 1px solid #fcd34d; 
            display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 4px rgba(251, 191, 36, 0.1); 
        }

        /* --- تصميم الفولدر --- */
        .folder-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            padding: 0.5rem 0.8rem; max-width: 1000px; width: 100%; margin: 0 auto;
            position: relative; margin-top: 15px; margin-bottom: 20px;
        }
        @media (min-width: 768px) { .folder-container { padding: 1rem 2rem; margin-top: 20px; } }

        .chapter-tabs-scroll { display: flex; gap: 0.3rem; overflow-x: auto; padding-bottom: 0; scrollbar-width: none; margin-bottom: -1px; z-index: 10; padding-right: 0.2rem; padding-left: 0.2rem; flex-shrink: 0; }
        .chapter-tabs-scroll::-webkit-scrollbar { display: none; }
        .chapter-tab { background: #e2e8f0; color: #64748b; padding: 0.5rem 1rem; border-radius: 0.8rem 0.8rem 0 0; font-weight: 700; font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.3s; position: relative; top: 3px; border: 1px solid transparent; opacity: 0.8; }
        .chapter-tab.active { background: white; color: var(--primary); top: 0; padding-top: 0.7rem; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05); z-index: 12; opacity: 1; }
        
        .folder-body { background: white; border-radius: 1.5rem; box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 5; border: 1px solid #e5e7eb; height: auto; min-height: 500px; }
        @media (min-width: 768px) { .folder-body { border-radius: 2rem; } }

        .card-banner { background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); height: 110px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: white; overflow: hidden; transition: background 0.5s ease; }
        @media (min-width: 768px) { .card-banner { height: 140px; } }
        
        .banner-bg-num { position: absolute; bottom: -15px; left: 10px; font-family: sans-serif; font-weight: 900; font-size: 5rem; color: rgba(255,255,255,0.15); line-height: 1; pointer-events: none; z-index: 1; }
        .banner-watermark-right { position: absolute; right: -10px; bottom: -20px; font-size: 6rem; color: rgba(255,255,255,0.12); transform: rotate(-15deg); pointer-events: none; z-index: 1; }
        .math-pattern-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 0; background-image: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 25%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 25%); }
        .icon-circle { background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 0.2rem; backdrop-filter: blur(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 5; }
        .banner-title { font-size: 1.25rem; font-weight: 800; position: relative; z-index: 5; text-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0; }
        .banner-icon { font-size: 1.2rem; }

        /* تبويبات الدروس */
        .lesson-tabs-container { background: #fff; padding: 0.6rem 0.8rem; border-bottom: 1px solid #f1f5f9; overflow-x: auto; white-space: nowrap; scrollbar-width: none; flex-shrink: 0; display: flex; align-items: center; gap: 0.6rem; }
        .lesson-tabs-container::-webkit-scrollbar { display: none; }
        
        .lesson-tab { 
            display: inline-flex; align-items: center; justify-content: center; 
            padding: 0.6rem 1.2rem; border-radius: 12px; font-size: 0.8rem; font-weight: 800; 
            color: #64748b; cursor: pointer; transition: all 0.3s; 
            border: 2px solid #e2e8f0; 
            background: #f8fafc;
            position: relative; overflow: hidden; 
            min-width: 90px;
        }
        .lesson-tab:hover { background: #f1f5f9; transform: translateY(-1px); border-color: #cbd5e1; }
        
        /* Active State */
        .lesson-tab.active { 
            background: var(--primary-light); 
            color: var(--primary); 
            border-color: var(--primary) !important; 
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1); 
            z-index: 5;
        }
        
        /* Locked State */
        .lesson-tab.locked { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; }
        
        /* Active AND Locked (When clicking a locked lesson) */
        .lesson-tab.active.locked {
            border-color: var(--primary) !important; /* Force Blue Border */
            background: #eff6ff; 
            color: var(--primary);
            opacity: 0.8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15); /* Add shadow to indicate selection */
        }

        .content-area { overflow: visible; padding: 1rem; display: flex; flex-direction: column; background: white; min-height: 400px; }
        @media (min-width: 768px) { .content-area { padding: 2rem; } }

        .lesson-main-btn {
            display: flex; flex-direction: column; justify-content: space-between; 
            width: 100%; padding: 0.8rem 1rem;
            background: white; border: 2px solid var(--primary-light); border-radius: 1rem; 
            text-align: right; text-decoration: none; box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s; margin-bottom: 0; position: relative; overflow: hidden; 
            height: 190px; flex-shrink: 0;
        }
        @media (min-width: 768px) { .lesson-main-btn { padding: 1.5rem 2rem; border-radius: 1.5rem; height: 240px; } }
        .lesson-main-btn.locked { background: #f8fafc !important; border-color: #e2e8f0 !important; cursor: pointer; opacity: 1; } 
        
        .lesson-btn-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); position: relative; z-index: 10; }
        @media (min-width: 768px) { .lesson-btn-title { font-size: 1.4rem; } }

        .games-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-top: 0; }
        @media (min-width: 768px) { .games-grid { gap: 1.5rem; } }

        .game-sm-btn {
            background: white; border: 1px solid #e5e7eb; padding: 0.8rem; border-radius: 0.8rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.3rem;
            cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            text-align: center; position: relative; overflow: hidden; 
            height: 155px; 
        }
        @media (min-width: 768px) { .game-sm-btn { padding: 1rem; border-radius: 1.5rem; gap: 0.6rem; height: 200px; } }
        .game-sm-btn:active { transform: scale(0.96); }
        .game-sm-btn i.game-icon { font-size: 1.3rem; color: var(--primary); opacity: 0.8; margin-bottom: 1px; position: relative; z-index: 10; }
        .game-sm-btn span { font-size: 0.9rem; font-weight: 700; color: #4b5563; position: relative; z-index: 10; line-height: 1.2; }
        @media (min-width: 768px) { .game-sm-btn i.game-icon { font-size: 1.8rem; margin-bottom: 4px; } .game-sm-btn span { font-size: 1rem; } }

        .score-pill { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 99px; font-size: 0.7rem; font-weight: 800; white-space: nowrap; position: relative; z-index: 10; }
        @media (min-width: 768px) { .score-pill { padding: 3px 12px; font-size: 0.8rem; } }
        .score-pill.full { background: linear-gradient(135deg, #fef9c3, #fef3c7); color: #b45309; border: 1px solid #fcd34d; }
        .score-pill.partial { background: #fff7ed; color: #c2410c; border: 1px solid #fdba74; }
        .score-pill.empty { background: #f9fafb; color: #9ca3af; border: 1px solid #e5e7eb; }

        .progress-section { margin-bottom: 0; background: #fafafa; padding: 0.8rem; border-radius: 0.8rem; border: 1px solid #f3f4f6; flex-shrink: 0; margin-top: 1rem; }
        @media (min-width: 768px) { .progress-section { padding: 1rem; border-radius: 1rem; } }
        .progress-bar-bg { height: 8px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-bottom: 0.4rem; }
        .progress-bar-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-text { font-size: 0.75rem; color: #64748b; font-weight: 700; display: flex; justify-content: space-between; }

        .bottom-info-bar { 
            background: white; border-top: 1px solid #f1f5f9; min-height: 50px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-shrink: 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); 
            z-index: 40; position: relative; padding: 0 1rem; 
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 10px));
            padding-top: 5px;
            margin-top: auto; 
        }
        @media (min-width: 768px) { .bottom-info-bar { border-top: none; padding-top: 10px; padding-bottom: 10px; } }
        
        .bottom-stat-btn { display: flex; flex-direction: column; align-items: center; gap: 2px; background: none; border: none; color: #94a3b8; font-weight: 700; font-size: 0.65rem; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: 0.2s; width: 70px; z-index: 45; }
        @media (min-width: 768px) { .bottom-stat-btn { font-size: 0.75rem; width: 90px; } }
        .bottom-stat-btn i { font-size: 1.2rem; color: #cbd5e1; margin-bottom: 2px; transition: 0.2s; }
        .bottom-stat-btn:hover i { color: var(--primary); transform: translateY(-2px); }
        .bottom-stat-btn:hover { color: var(--primary); }

        .footer-teacher-badge {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            background: white; border: 1px solid #e2e8f0; border-bottom: none;
            border-radius: 1.5rem 1.5rem 0 0; padding: 0.6rem 2rem 0.8rem 2rem;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); text-align: center;
            z-index: 42; min-width: 180px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: calc(10px + env(safe-area-inset-bottom, 5px));
        }
        @media (min-width: 768px) { .footer-teacher-badge { padding: 0.8rem 3rem 1rem 3rem; min-width: 250px; margin-bottom: 0; } }
        .footer-label { font-size: 0.6rem; color: #94a3b8; font-weight: 700; margin-bottom: 2px; }
        .footer-name { font-size: 0.75rem; font-weight: 800; color: var(--primary); }
        @media (min-width: 768px) { .footer-label { font-size: 0.7rem; } .footer-name { font-size: 0.9rem; } }

        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #login-view { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }

        /* Lesson View - Full Screen Iframe Style */
        #lesson-view {
            background-color: white; /* تأكد من أن الخلفية بيضاء أو مناسبة */
        }
        
        .fullscreen-iframe-container {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1;
        }

        /* Modal - نافذة منبثقة بنسبة 80% */
        .fullscreen-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(5px); 
        }
        
        .modal-content { 
            background: white; 
            width: 95%; height: 95%; /* للجوال */
            display: flex; /* هام: Flex لترتيب الشريط والإطار تحت بعض */
            flex-direction: column; 
            overflow: hidden; position: relative;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (min-width: 768px) { 
            .modal-content { 
                width: 80%; height: 80%; /* الحجم 80% للكمبيوتر */
                border-radius: 2rem;
            } 
        }

        /* تعديل الشريط العلوي ليكون كتلة مستقلة (ليس عائماً) لتجنب التداخل */
        .modal-header { 
            position: relative; /* تغيير من absolute إلى relative */
            width: 100%;
            padding: 0 0.8rem; display: flex; justify-content: space-between; align-items: center; 
            background: #f8fafc; /* خلفية صلبة */
            border-bottom: 1px solid #e2e8f0; 
            height: 32px; /* ارتفاع صغير */
            flex-shrink: 0; /* منع التقلص */
            z-index: 50; 
        }
        
        .modal-actions { display: flex; gap: 0.3rem; }
        
        /* تعديل الأزرار لتكون صغيرة جداً */
        .modal-btn {
            width: 22px; height: 22px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; cursor: pointer; border: none; font-size: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .close-btn { background: #fee2e2; color: #ef4444; }
        .close-btn:hover { background: #fecaca; transform: scale(1.05); }
        
        .minimize-btn { background: #e2e8f0; color: #64748b; }
        .minimize-btn:hover { background: #cbd5e1; transform: scale(1.05); }

        .expand-btn { background: #dbeafe; color: #2563eb; }
        .expand-btn:hover { background: #bfdbfe; transform: scale(1.05); }

        /* Fullscreen state override - إجبار التمدد عند التكبير */
        .modal-content.is-fullscreen {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
        }

        /* تعديل iframe ليملأ المساحة المتبقية فقط */
        #game-iframe {
            width: 100%; 
            flex-grow: 1; /* يملأ المساحة المتبقية */
            height: auto; 
            display: block; 
            border: none; 
            background-color: white;
            position: relative; 
            z-index: 1; 
        }

        /* Minimized Game Bar (شريط اللعبة المصغرة) */
        #minimized-game-bar {
            position: fixed; bottom: 20px; left: 20px; 
            background: white; border-radius: 99px;
            padding: 0.5rem 1.5rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 1rem;
            z-index: 210; border: 1px solid #e2e8f0;
            transform: translateY(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        #minimized-game-bar:hover { transform: translateY(-3px); }
        
        #minimized-game-bar.hidden {
            display: none !important;
        }

        .saving-loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .watermark-icon-glow { text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff, 1px -1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff, -1px 1px #fff; opacity: 0.35; pointer-events: none; z-index: 0; }
        
        .bg-gradient-gold { background: linear-gradient(135deg, #fffbeb 0%, #ffffff 70%, #ffffff 100%) !important; border-color: #fde68a !important; }
        .bg-gradient-orange { background: linear-gradient(135deg, #fff7ed 0%, #ffffff 70%, #ffffff 100%) !important; border-color: #fed7aa !important; }
        .bg-gradient-red { background: linear-gradient(135deg, #fef2f2 0%, #ffffff 70%, #ffffff 100%) !important; border-color: #fecaca !important; }
    </style>
</head>
<body>

    <!-- 1. واجهة تسجيل الدخول -->
    <div id="login-view">
        <div class="mb-8 text-center">
            <div class="w-24 h-24 bg-blue-50 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl border border-blue-100">
                <i class="fas fa-shapes text-5xl text-blue-600"></i>
            </div>
            <h1 class="text-2xl md:text-3xl font-black text-gray-800 mb-2">منصة الرياضيات التفاعلية</h1>
            <p class="text-sm md:text-base text-gray-500 font-medium">تصميم وإعداد الأستاذ عبد العزيز خالد العبلان</p>
        </div>
        <form id="login-form" class="w-full max-w-sm space-y-5">
            <div>
                <input type="text" id="login-id" placeholder="رقم الهوية" class="w-full p-4 text-center text-xl font-bold bg-gray-50 border-2 border-gray-100 rounded-2xl focus:outline-none focus:border-blue-500 focus:bg-white transition placeholder-gray-300" required>
            </div>
            <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition text-lg">
                دخول الطالب <i class="fas fa-arrow-left mr-2"></i>
            </button>
        </form>
        <button id="visitor-btn" class="mt-8 text-gray-400 font-bold hover:text-blue-600 transition text-sm py-2 px-4 rounded-lg hover:bg-gray-50">تصفح كزائر</button>
        <div id="login-error" class="hidden mt-4 text-red-500 bg-red-50 p-3 rounded-xl w-full text-center text-sm font-bold border border-red-100"></div>
    </div>

    <!-- 2. واجهة التطبيق الرئيسية (Dashboard) -->
    <div id="app-container" class="hidden flex flex-col h-full">
        <!-- Header -->
        <header class="app-header">
            <!-- Background Decoration Pattern -->
            <div class="header-bg-decoration">
                <!-- زيادة الأيقونات وتنوعها -->
                <i class="fas fa-square-root-alt header-bg-icon icon-lg" style="top: 10%; left: 8%;"></i>
                <i class="fas fa-divide header-bg-icon icon-md" style="bottom: 15%; right: 18%; font-size: 1.2rem;"></i>
                <i class="fas fa-percent header-bg-icon icon-md" style="top: 25%; right: 5%;"></i>
                <i class="fas fa-plus header-bg-icon icon-lg" style="bottom: 10%; left: 25%;"></i>
                <i class="fas fa-calculator header-bg-icon icon-lg" style="top: 40%; left: 55%;"></i>
                <i class="fas fa-shapes header-bg-icon icon-md" style="top: 15%; right: 35%;"></i>
                
                <!-- أيقونات إضافية لزيادة الكثافة -->
                <i class="fas fa-equals header-bg-icon icon-sm" style="top: 60%; right: 12%;"></i>
                <i class="fas fa-less-than-equal header-bg-icon icon-sm" style="bottom: 30%; left: 40%;"></i>
                <i class="fas fa-infinity header-bg-icon icon-md" style="top: 5%; left: 45%;"></i>
                <i class="fas fa-superscript header-bg-icon icon-sm" style="top: 50%; right: 50%;"></i>
                <i class="fas fa-vector-square header-bg-icon icon-sm" style="bottom: 5%; right: 8%;"></i>
                <i class="fas fa-chart-pie header-bg-icon icon-md" style="top: 10%; left: 75%;"></i>
            </div>

            <div class="header-right-group">
                <div class="user-info">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <span id="header-name" class="user-name-text">زائر</span>
                </div>
            </div>
            <div class="header-center-group">
                <div class="header-title-badge">
                    <h1 class="app-title-main">منصة الرياضيات</h1>
                    <span class="app-subtitle">التفاعلية</span>
                </div>
            </div>
            <div class="header-left-group">
                <div class="score-badge">
                    <i class="fas fa-star text-yellow-500"></i> <span id="header-score">0</span>
                </div>
                <button class="logout-btn" onclick="logout()" title="تسجيل الخروج">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="folder-container">
            <div class="chapter-tabs-scroll" id="chapter-tabs"></div>
            <div class="folder-body">
                <div class="card-banner" id="main-banner">
                    <div class="math-pattern-overlay">
                        <i class="fas fa-square-root-variable math-deco-icon" style="top: 10%; left: 10%; font-size: 1.5rem; opacity: 0.2;"></i>
                        <i class="fas fa-percent math-deco-icon" style="bottom: 20%; left: 20%; font-size: 1rem; opacity: 0.15;"></i>
                        <i class="fas fa-divide math-deco-icon" style="top: 20%; right: 20%; font-size: 1.2rem; opacity: 0.15;"></i>
                        <i class="fas fa-plus math-deco-icon" style="bottom: 10%; right: 10%; font-size: 1.5rem; opacity: 0.2;"></i>
                    </div>
                    <i class="fas fa-graduation-cap banner-watermark-right" id="banner-watermark-el"></i>
                    <span class="banner-bg-num" id="banner-bg-num">6</span>
                    <div class="icon-circle">
                        <i class="fas fa-graduation-cap banner-icon" id="banner-icon-el"></i>
                    </div>
                    <h2 class="banner-title" id="banner-title">كثيرات الحدود</h2>
                </div>
                <div class="lesson-tabs-container" id="lesson-tabs"></div>
                <div class="content-area" id="content-area"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bottom-info-bar">
            <button class="bottom-stat-btn"><i class="fas fa-user-chart"></i><span>الخاصة</span></button>
            <div class="footer-teacher-badge">
                <span class="footer-label">تصميم وإعداد</span>
                <span class="footer-name">أ. عبد العزيز خالد العبلان</span>
            </div>
            <button class="bottom-stat-btn"><i class="fas fa-trophy"></i><span>العامة</span></button>
        </div>
    </div>

    <!-- 3. واجهة الدرس المدمجة (Lesson View) -->
    <div id="lesson-view" class="hidden flex flex-col h-full bg-white fixed inset-0 z-50">
        
        <!-- Locked Content View (يظهر فقط إذا الدرس مغلق) -->
        <div id="locked-view" class="hidden container mx-auto max-w-md p-8 text-center mt-10">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-lock text-4xl text-gray-400"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-700 mb-2">عذراً، هذا الدرس مغلق</h2>
            <p class="text-gray-500 mb-6">لم يحن موعد فتح هذا الدرس بعد أو تم إغلاقه من قبل الإدارة.</p>
            <div class="bg-blue-50 text-blue-700 px-6 py-3 rounded-xl inline-block font-bold border border-blue-100">
                <i class="fas fa-calendar-alt ml-2"></i> الحالة: <span id="unlock-date-display">...</span>
            </div>
            <button onclick="closeLesson()" class="mt-8 text-gray-400 font-bold block w-full hover:text-gray-600">العودة للقائمة</button>
        </div>

        <!-- Lesson Content (Open) - تم التعديل ليتم الفتح في رابط خارجي بدلاً من iframe -->
        <div id="open-view" class="hidden w-full h-full relative">
             <!-- تم إخفاء الـ iframe لأنه سيتم التوجيه لصفحة جديدة -->
        </div>

    </div>

    <!-- 4. مودال اللعبة (المشترك - تم التحديث ليكون نافذة منبثقة) -->
    <div id="modal-game" class="fullscreen-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <!-- تم تصغير حجم العنوان -->
                <span id="modal-game-title" class="font-bold text-gray-700 text-xs">اللعبة</span>
                <div class="modal-actions">
                    <button onclick="minimizeGame()" class="modal-btn minimize-btn" title="تصغير">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button onclick="toggleFullscreen()" class="modal-btn expand-btn" title="تكبير/تصغير">
                        <i class="fas fa-expand" id="fullscreen-icon"></i>
                    </button>
                    <button onclick="closeGameModal()" class="modal-btn close-btn" title="إغلاق">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <iframe id="game-iframe" src="" class="flex-grow w-full border-none bg-gray-50"></iframe>
        </div>
    </div>

    <!-- شريط اللعبة المصغرة (يظهر عند التصغير) -->
    <div id="minimized-game-bar" class="hidden" onclick="restoreGame()">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
            <i class="fas fa-gamepad"></i>
        </div>
        <div class="flex flex-col">
            <span class="text-xs text-gray-400 font-bold">لعبة قيد التشغيل</span>
            <span id="minimized-game-title" class="text-sm font-bold text-gray-800">اسم اللعبة</span>
        </div>
        <button class="ml-2 text-gray-400 hover:text-blue-600">
            <i class="fas fa-expand-alt"></i>
        </button>
    </div>

    <script>
        // *** رابط السكربت الخاص بك ***
        const API_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        
        // *** الرابط الأساسي للملفات ***
        const BASE_LESSON_URL = "https://ablan-math.github.io/lessons/";
        const BASE_GAME_URL = "https://ablan-math.github.io/games/";

        // --- بيانات المنهج ---
        const curriculumIndex = {
            'c6': { 
                id: 'c6', tabTitle: "الفصل ٦", chapterNum: "6", chapterName: "كثيرات الحدود",
                theme: { color: '#2563eb', light: '#eff6ff', dark: '#1e40af', gradientStart: '#3b82f6', gradientEnd: '#1d4ed8', icon: 'fa-graduation-cap' },
                lessons: [
                    { id: 'c6_l1', title: 'ضرب وحيدات الحد', maxScore: 10, games: [ { id: 'g6_1_1', title: 'قوة الأسس', maxScore: 5 }, { id: 'g6_1_2', title: 'تحدي الضرببب', maxScore: 5 } ]},
                    { id: 'c6_l2', title: 'قسمة وحيدات الحد', maxScore: 10, games: [ { id: 'g6_2_1', title: 'تبسيط الكسور', maxScore: 5 }, { id: 'g6_2_2', title: 'لعبة القسمة', maxScore: 5 } ]},
                    { id: 'c6_l3', title: 'كثيرات الحدود', maxScore: 10, games: [ { id: 'g6_3_1', title: 'تصنيف الحدود', maxScore: 5 }, { id: 'g6_3_2', title: 'الدرجة والمعامل', maxScore: 5 } ]},
                    { id: 'c6_l4', title: 'جمع كثيرات الحدود', maxScore: 10, games: [ { id: 'g6_4_1', title: 'ميزان الجمع', maxScore: 5 }, { id: 'g6_4_2', title: 'سباق الطرح', maxScore: 5 } ]},
                    { id: 'c6_l5', title: 'ضرب وحيدة حد', maxScore: 10, games: [ { id: 'g6_5_1', title: 'التوزيع السريع', maxScore: 5 }, { id: 'g6_5_2', title: 'مفكوك الأقواس', maxScore: 5 } ]},
                    { id: 'c6_l6', title: 'ضرب كثيرات الحدود', maxScore: 10, games: [ { id: 'g6_6_1', title: 'ضرب الأقواس', maxScore: 5 }, { id: 'g6_6_2', title: 'المساحات الجبرية', maxScore: 5 } ]},
                    { id: 'c6_l7', title: 'حالات خاصة', maxScore: 10, games: [ { id: 'g6_7_1', title: 'الفرق بين مربعين', maxScore: 5 }, { id: 'g6_7_2', title: 'المربع الكامل', maxScore: 5 } ]},
                ]
            },
            'c7': {
                id: 'c7', tabTitle: "الفصل ٧", chapterNum: "7", chapterName: "التحليل",
                theme: { color: '#9333ea', light: '#faf5ff', dark: '#6b21a8', gradientStart: '#a855f7', gradientEnd: '#7e22ce', icon: 'fa-puzzle-piece' },
                lessons: [
                    { id: 'c7_l1', title: 'تحليل وحيدات الحد', maxScore: 10, games: [ { id: 'g7_1_1', title: 'القاسم المشترك', maxScore: 5 }, { id: 'g7_1_2', title: 'تفكيك الأعداد', maxScore: 5 } ]},
                    { id: 'c7_l2', title: 'خاصية التوزيع', maxScore: 10, games: [ { id: 'g7_2_1', title: 'عامل مشترك', maxScore: 5 }, { id: 'g7_2_2', title: 'تجميع الحدود', maxScore: 5 } ]},
                    { id: 'c7_l3', title: 'المعادلات س² + ب س', maxScore: 10, games: [ { id: 'g7_3_1', title: 'لغز العددين', maxScore: 5 }, { id: 'g7_3_2', title: 'تحليل الثلاثي', maxScore: 5 } ]},
                    { id: 'c7_l4', title: 'المعادلات أ س² + ب س', maxScore: 10, games: [ { id: 'g7_4_1', title: 'المقص الذهبي', maxScore: 5 }, { id: 'g7_4_2', title: 'تحدي المعاملات', maxScore: 5 } ]},
                    { id: 'c7_l5', title: 'الفرق بين مربعين', maxScore: 10, games: [ { id: 'g7_5_1', title: 'جذور ومربعات', maxScore: 5 }, { id: 'g7_5_2', title: 'حلل واربط', maxScore: 5 } ]},
                    { id: 'c7_l6', title: 'المربعات الكاملة', maxScore: 10, games: [ { id: 'g7_6_1', title: 'اكتشاف المربع', maxScore: 5 }, { id: 'g7_6_2', title: 'الجذر المكرر', maxScore: 5 } ]},
                ]
            },
            'c8': { 
                id: 'c8', tabTitle: "الفصل ٨", chapterNum: "8", chapterName: "الدوال التربيعية",
                theme: { color: '#059669', light: '#ecfdf5', dark: '#065f46', gradientStart: '#10b981', gradientEnd: '#047857', icon: 'fa-bezier-curve' },
                lessons: [
                    { id: 'c8_l1', title: 'التمثيل البياني', maxScore: 10, games: [ { id: 'g8_1_1', title: 'القطع المكافئ', maxScore: 5 }, { id: 'g8_1_2', title: 'الرأس والمحور', maxScore: 5 } ]},
                    { id: 'c8_l2', title: 'حل المعادلات بيانياً', maxScore: 10, games: [ { id: 'g8_2_1', title: 'نقاط التقاطع', maxScore: 5 }, { id: 'g8_2_2', title: 'صيد الجذور', maxScore: 5 } ]},
                    { id: 'c8_l3', title: 'إكمال المربع', maxScore: 10, games: [ { id: 'g8_3_1', title: 'أكمل النمط', maxScore: 5 }, { id: 'g8_3_2', title: 'لغز المربع', maxScore: 5 } ]},
                    { id: 'c8_l4', title: 'القانون العام', maxScore: 10, games: [ { id: 'g8_4_1', title: 'القانون العام', maxScore: 5 }, { id: 'g8_4_2', title: 'المميز الذكي', maxScore: 5 } ]},
                ]
            },
            'c9': { 
                id: 'c9', tabTitle: "الفصل ٩", chapterNum: "9", chapterName: "المعادلات الجذرية",
                theme: { color: '#d97706', light: '#fffbeb', dark: '#92400e', gradientStart: '#f59e0b', gradientEnd: '#b45309', icon: 'fa-bolt' },
                lessons: [
                    { id: 'c9_l1', title: 'تبسيط العبارات', maxScore: 10, games: [ { id: 'g9_1_1', title: 'تفكيك الجذور', maxScore: 5 }, { id: 'g9_1_2', title: 'مرافق الجذر', maxScore: 5 } ]},
                    { id: 'c9_l2', title: 'العمليات الجذرية', maxScore: 10, games: [ { id: 'g9_2_1', title: 'جمع الجذور', maxScore: 5 }, { id: 'g9_2_2', title: 'ضرب الجذور', maxScore: 5 } ]},
                    { id: 'c9_l3', title: 'المعادلات الجذرية', maxScore: 10, games: [ { id: 'g9_3_1', title: 'تخلص من الجذر', maxScore: 5 }, { id: 'g9_3_2', title: 'الحل الدخيل', maxScore: 5 } ]},
                    { id: 'c9_l4', title: 'نظرية فيثاغورس', maxScore: 10, games: [ { id: 'g9_4_1', title: 'مثلث قائم', maxScore: 5 }, { id: 'g9_4_2', title: 'الوتر المفقود', maxScore: 5 } ]},
                    { id: 'c9_l5', title: 'المسافة ونقطة المنتصف', maxScore: 10, games: [ { id: 'g9_5_1', title: 'رحلة المسافة', maxScore: 5 }, { id: 'g9_5_2', title: 'نقطة المنتصف', maxScore: 5 } ]},
                    { id: 'c9_l6', title: 'المثلثات المتشابهة', maxScore: 10, games: [ { id: 'g9_6_1', title: 'نسب التشابه', maxScore: 5 }, { id: 'g9_6_2', title: 'الظل والارتفاع', maxScore: 5 } ]},
                    { id: 'c9_l7', title: 'النسب المثلثية', maxScore: 10, games: [ { id: 'g9_7_1', title: 'الجيب والجتا', maxScore: 5 }, { id: 'g9_7_2', title: 'حساب الزوايا', maxScore: 5 } ]},
                ]
            },
            'c10': { 
                id: 'c10', tabTitle: "الفصل ١٠", chapterNum: "10", chapterName: "الإحصاء",
                theme: { color: '#be123c', light: '#fff1f2', dark: '#881337', gradientStart: '#e11d48', gradientEnd: '#9f1239', icon: 'fa-chart-pie' },
                lessons: [
                    { id: 'c10_l1', title: 'تصميم دراسة مسحية', maxScore: 10, games: [ { id: 'g10_1_1', title: 'أنواع العينات', maxScore: 5 }, { id: 'g10_1_2', title: 'متحيزة أم لا', maxScore: 5 } ]},
                    { id: 'c10_l2', title: 'تحليل النتائج', maxScore: 10, games: [ { id: 'g10_2_1', title: 'قراءة البيانات', maxScore: 5 }, { id: 'g10_2_2', title: 'الاستنتاج الصحيح', maxScore: 5 } ]},
                    { id: 'c10_l3', title: 'إحصائيات العينة', maxScore: 10, games: [ { id: 'g10_3_1', title: 'العينة والمجتمع', maxScore: 5 }, { id: 'g10_3_2', title: 'الانحراف المعياري', maxScore: 5 } ]},
                    { id: 'c10_l4', title: 'التباديل والتوافيق', maxScore: 10, games: [ { id: 'g10_4_1', title: 'ترتيب العناصر', maxScore: 5 }, { id: 'g10_4_2', title: 'اختيار المجموعة', maxScore: 5 } ]},
                    { id: 'c10_l5', title: 'الاحتمالات المركبة', maxScore: 10, games: [ { id: 'g10_5_1', title: 'مستقلة وغير مستقلة', maxScore: 5 }, { id: 'g10_5_2', title: 'عجلة الحظ', maxScore: 5 } ]},
                ]
            }
        };

        let currentChapterKey = 'c6';
        let currentLessonIndex = 0;
        let currentUser = null;
        let activeLessonId = null;
        let activeGameId = null;
        let gameOrigin = 'dashboard';

        function applyChapterTheme(themeConfig) {
            const root = document.documentElement;
            root.style.setProperty('--primary', themeConfig.color);
            root.style.setProperty('--primary-light', themeConfig.light);
            root.style.setProperty('--primary-dark', themeConfig.dark);
            root.style.setProperty('--gradient-start', themeConfig.gradientStart);
            root.style.setProperty('--gradient-end', themeConfig.gradientEnd);
        }

        // --- Dashboard Render ---
        function renderInterface() {
            const cTabsContainer = document.getElementById('chapter-tabs');
            cTabsContainer.innerHTML = '';
            Object.keys(curriculumIndex).forEach(key => {
                const chapter = curriculumIndex[key];
                const btn = document.createElement('button');
                btn.className = `chapter-tab ${key === currentChapterKey ? 'active' : ''}`;
                if (key === currentChapterKey) btn.style.color = chapter.theme.color;
                btn.textContent = chapter.tabTitle;
                btn.onclick = () => switchChapter(key);
                cTabsContainer.appendChild(btn);
            });
            renderCurrentChapter();
            updateHeader();
        }

        function switchChapter(key) {
            currentChapterKey = key;
            currentLessonIndex = 0;
            renderInterface();
        }

        // دالة قوية لتحليل التاريخ بكل الصيغ المحتملة (DD/MM/YYYY أو YYYY-MM-DD أو ISO)
        function parseUnlockDate(dateInput) {
            if (!dateInput) return null;
            let dateObj = null;

            // 1. تجربة التاريخ القياسي (YYYY-MM-DD)
            let attempt = new Date(dateInput);
            if (!isNaN(attempt.getTime())) {
                dateObj = attempt;
            } 
            // 2. تجربة الصيغة الشائعة في جوجل شيت (DD/MM/YYYY)
            else if (typeof dateInput === 'string' && dateInput.includes('/')) {
                const parts = dateInput.split('/');
                if (parts.length === 3) {
                    // parts[0]=Day, parts[1]=Month, parts[2]=Year
                    // ملاحظة: الشهر يبدأ من 0 في جافاسكريبت
                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            // 3. تجربة صيغة (DD-MM-YYYY)
            else if (typeof dateInput === 'string' && dateInput.includes('-')) {
                const parts = dateInput.split('-');
                if (parts.length === 3 && parts[0].length === 2) { // إذا كان الجزء الأول يوم وليس سنة
                      dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            
            if (dateObj && !isNaN(dateObj.getTime())) {
                dateObj.setHours(0,0,0,0); // تصفير الوقت للمقارنة باليوم فقط
                return dateObj;
            }
            return null;
        }

        function checkLessonLockStatus(lesson, index, chapter) {
            // الوصول لبيانات الدرس المحدثة من الطالب
            const userLessonData = currentUser && currentUser.lessons ? currentUser.lessons[lesson.id] : null;
            
            // إذا لم تتوفر بيانات، الدرس مفتوح افتراضياً
            if (!userLessonData) return { isLocked: false };

            // 1. التحقق من الحالة الإدارية (adminStatus)
            // إذا كان "مغلق" أو "closed"، يتم القفل فوراً
            if (userLessonData.adminStatus === 'closed' || userLessonData.adminStatus === 'مغلق') {
                return { isLocked: true, reason: 'admin', date: 'مغلق من الإدارة' };
            }

            // 2. التحقق من تاريخ الفتح (openDate أو date أو unlockDate)
            // استخدام الدالة الجديدة المرنة لتحليل التاريخ
            let dateToCheck = userLessonData.openDate || userLessonData.date || userLessonData.unlockDate;
            
            if (dateToCheck) {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // تصفير الوقت

                const openDate = parseUnlockDate(dateToCheck);
                
                // إذا كان التاريخ صالحاً، واليوم قبل تاريخ الفتح -> قفل
                if (openDate && today < openDate) {
                    // تحويل التاريخ لنص عربي للقراءة
                    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
                    return { isLocked: true, reason: 'date', date: openDate.toLocaleDateString('ar-SA', options) };
                }
            }

            return { isLocked: false };
        }

        function renderCurrentChapter() {
            const chapter = curriculumIndex[currentChapterKey];
            applyChapterTheme(chapter.theme);
            document.getElementById('banner-title').textContent = chapter.chapterName;
            document.getElementById('banner-bg-num').textContent = chapter.chapterNum;
            document.getElementById('banner-icon-el').className = `fas ${chapter.theme.icon} banner-icon`;
            document.getElementById('banner-watermark-el').className = `fas ${chapter.theme.icon} banner-watermark-right`;

            const lTabsContainer = document.getElementById('lesson-tabs');
            lTabsContainer.innerHTML = '';
            
            chapter.lessons.forEach((lesson, index) => {
                const span = document.createElement('span');
                const lockStatus = checkLessonLockStatus(lesson, index, chapter);
                
                // Keep active logic, append locked logic
                span.className = `lesson-tab ${index === currentLessonIndex ? 'active' : ''} ${lockStatus.isLocked ? 'locked' : ''}`;
                
                // Logic for Tab Icon (Total Score)
                let bgIcon = '';
                
                // Calculate Total Score for this specific lesson loop
                let lessonTotalEarned = 0;
                let lessonTotalMax = lesson.maxScore; // Base Lesson Score
                
                // Add Lesson Score
                const lData = currentUser?.lessons?.[lesson.id];
                const hasLessonScore = (lData && lData.grade !== undefined && lData.grade !== null);
                if (hasLessonScore) {
                    lessonTotalEarned += parseFloat(lData.grade);
                }
                
                // Add Games Scores
                let hasAnyGameScore = false;
                lesson.games.forEach(g => {
                    lessonTotalMax += g.maxScore;
                    const gData = currentUser?.games?.[g.id];
                    if (gData && gData.grade !== undefined && gData.grade !== null) {
                        lessonTotalEarned += parseFloat(gData.grade);
                        hasAnyGameScore = true;
                    }
                });
                
                const isStarted = hasLessonScore || hasAnyGameScore;

                if (isStarted) {
                    if (lessonTotalEarned >= lessonTotalMax) {
                        // Full Mark (20/20) -> Trophy
                        bgIcon = `<i class="fas fa-trophy absolute -bottom-1 -right-1 text-4xl text-yellow-500/35 transform -rotate-12 pointer-events-none"></i>`;
                    } else if (lessonTotalEarned >= (lessonTotalMax / 2)) {
                        // Pass (>= 10/20) -> Star
                        bgIcon = `<i class="fas fa-star absolute -bottom-1 -right-1 text-4xl text-orange-500/35 transform -rotate-12 pointer-events-none"></i>`;
                    } else {
                        // Fail (< 10/20) -> Redo
                        bgIcon = `<i class="fas fa-redo absolute -bottom-1 -right-1 text-4xl text-red-500/30 transform -rotate-12 pointer-events-none"></i>`;
                    }
                } else {
                    // Not Started -> Book (Only if not locked)
                    if (!lockStatus.isLocked) {
                        bgIcon = `<i class="fas fa-book-open absolute -bottom-1 -right-1 text-3xl text-gray-400/20 transform -rotate-12 pointer-events-none"></i>`;
                    }
                }
                
                // Only show small lock icon if locked
                let lockIcon = lockStatus.isLocked ? '<i class="fas fa-lock ml-1 text-xs"></i>' : '';
                
                span.innerHTML = `${bgIcon}<span class="relative z-10 flex items-center gap-1">${lockIcon} درس ${index + 1}</span>`;
                
                span.onclick = () => { currentLessonIndex = index; renderCurrentChapter(); };
                lTabsContainer.appendChild(span);
            });
            renderLessonDetails();
        }

        // Helper to format grade text
        function formatGradeText(grade, max) {
            if (grade === undefined || grade === null) return `<i class="fas fa-circle text-gray-300 text-[0.6rem]"></i> لم يبدأ`;
            return `${grade}/${max}`;
        }

        function renderLessonDetails() {
            const container = document.getElementById('content-area');
            const chapter = curriculumIndex[currentChapterKey];
            const lesson = chapter.lessons[currentLessonIndex];
            const lockStatus = checkLessonLockStatus(lesson, currentLessonIndex, chapter);

            const lGradeRaw = currentUser?.lessons?.[lesson.id]?.grade;
            const lGrade = (lGradeRaw !== undefined && lGradeRaw !== null) ? parseFloat(lGradeRaw) : 0;
            const isStarted = (lGradeRaw !== undefined && lGradeRaw !== null);

            let lessonBgIcon = '';
            let lessonBgClass = '';
            let totalPoints = lGrade;
            let maxTotalPoints = lesson.maxScore;
            
            // Background Logic Update
            if (isStarted) {
                if (lGrade >= lesson.maxScore) {
                    // درجة كاملة: ذهبي + كأس
                    lessonBgClass = 'bg-gradient-gold';
                    lessonBgIcon = '<i class="fas fa-trophy absolute -bottom-10 -left-6 text-yellow-500/20 transform -rotate-[15deg] text-[10rem]"></i>';
                } else if (lGrade >= 5) {
                    // 5 أو أكثر: برتقالي + نجمة
                    lessonBgClass = 'bg-gradient-orange';
                    lessonBgIcon = '<i class="fas fa-star absolute -bottom-10 -left-6 text-orange-500/20 transform -rotate-[15deg] text-[10rem]"></i>';
                } else {
                    // أقل من 5 (تشمل الصفر): أحمر + إعادة
                    lessonBgClass = 'bg-gradient-red';
                    lessonBgIcon = '<i class="fas fa-redo absolute -bottom-10 -left-6 text-red-500/20 transform -rotate-[15deg] text-[10rem]"></i>';
                }
            } else {
                // لم يبدأ: أزرق + كتاب
                lessonBgClass = 'bg-theme-light border-blue-200'; 
                lessonBgIcon = '<i class="fas fa-book-open absolute -bottom-10 -left-6 text-blue-200 transform -rotate-[15deg] text-[10rem]"></i>';
            }

            // Locked Style & Logic
            let lockedDateText = '';
            if (lockStatus.isLocked) {
                lessonBgClass = 'bg-gray-50 border-gray-200'; // Override to gray if locked
                // Big Lock Icon for Locked Lessons
                lessonBgIcon = '<i class="fas fa-lock absolute -bottom-10 -left-6 text-gray-200 transform -rotate-[15deg] text-[10rem]"></i>';
                
                if (lockStatus.date && lockStatus.reason === 'date') {
                    lockedDateText = `<div class="text-xs text-blue-500 mt-1 font-bold bg-blue-50 px-2 py-1 rounded inline-block"><i class="far fa-clock"></i> يفتح في: ${lockStatus.date}</div>`;
                } else {
                    lockedDateText = `<div class="text-xs text-gray-400 mt-1 font-bold"><i class="fas fa-lock"></i> ${lockStatus.reason === 'admin' ? 'مغلق من الإدارة' : 'مغلق'}</div>`;
                }
            }

            const gamesHtml = lesson.games.map(g => {
                const gGradeRaw = currentUser?.games?.[g.id]?.grade;
                const gGrade = (gGradeRaw !== undefined && gGradeRaw !== null) ? parseFloat(gGradeRaw) : 0;
                const gIsStarted = (gGradeRaw !== undefined && gGradeRaw !== null);
                if(gIsStarted) totalPoints += gGrade;
                maxTotalPoints += g.maxScore;

                let gClass = '';
                let gIcon = '';
                let largeBgIcon = '';
                let badgeClass = 'empty';

                if(gIsStarted) {
                    if (gGrade >= g.maxScore) {
                        // درجة كاملة في اللعبة
                        largeBgIcon = '<i class="fas fa-trophy watermark-icon-glow absolute -bottom-6 -left-4 text-amber-500 transform -rotate-12 pointer-events-none z-0 opacity-20" style="font-size: 6rem;"></i>';
                        gIcon = '<i class="fas fa-check-circle text-green-500 absolute top-2 right-2 z-10"></i>';
                        gClass = 'bg-gradient-gold';
                        badgeClass = 'full';
                    } else if (gGrade >= (g.maxScore / 2)) {
                        // ناجح (نصف الدرجة أو أكثر)
                        largeBgIcon = '<i class="fas fa-star watermark-icon-glow absolute -bottom-6 -left-4 text-orange-500 transform -rotate-12 pointer-events-none z-0 opacity-20" style="font-size: 6rem;"></i>';
                        gClass = 'bg-gradient-orange';
                        badgeClass = 'partial';
                    } else {
                        // راسب (أقل من النصف)
                        largeBgIcon = '<i class="fas fa-redo watermark-icon-glow absolute -bottom-6 -left-4 text-red-500 transform -rotate-12 pointer-events-none z-0 opacity-20" style="font-size: 6rem;"></i>';
                        gClass = 'bg-gradient-red';
                        badgeClass = 'partial'; // أو يمكن عمل كلاس جديد للراسب
                    }
                } else {
                    // Not started or Locked
                    if (lockStatus.isLocked) {
                          // Locked Game
                          gIcon = '<i class="fas fa-lock text-gray-400 absolute top-2 right-2 z-10 text-lg"></i>';
                          largeBgIcon = '<i class="fas fa-lock watermark-icon-glow absolute -bottom-6 -left-4 text-gray-300 transform -rotate-12 pointer-events-none z-0 opacity-40" style="font-size: 6rem;"></i>';
                          gClass = 'bg-gray-50 border-gray-200';
                    } else {
                          // Not Started (Ready)
                          largeBgIcon = '<i class="fas fa-gamepad watermark-icon-glow absolute -bottom-6 -left-4 text-blue-100 transform -rotate-12 pointer-events-none z-0 opacity-40" style="font-size: 6rem;"></i>';
                          gClass = 'bg-white border-blue-100'; 
                    }
                }
                
                return `
                <div class="game-sm-btn ${gClass}" onclick="openGameInDashboard('${g.id}', '${g.title}')">
                    ${largeBgIcon}${gIcon}
                    <i class="fas fa-gamepad game-icon text-theme"></i>
                    <span class="relative z-10">${g.title}</span>
                    <div class="score-pill ${badgeClass} mt-auto relative z-10">${formatGradeText(gGradeRaw, g.maxScore)}</div>
                </div>
                `;
            }).join('');

            let progress = (totalPoints / maxTotalPoints) * 100;
            if (isNaN(progress)) progress = 0;
            const lessonBadgeText = formatGradeText(lGradeRaw, lesson.maxScore);
            // تحديث لون الشارة بناءً على الدرجة أيضاً
            let lessonBadgeClass = 'empty';
            if (isStarted) {
                if (lGrade >= lesson.maxScore) lessonBadgeClass = 'full';
                else if (lGrade >= 5) lessonBadgeClass = 'partial';
                else lessonBadgeClass = 'partial'; // أو نمط أحمر لو أردت
            }

            // Force Blue Border override on the Main Lesson Card if NOT started AND NOT Locked
            let cardStyleOverride = '';
            if (!isStarted && !lockStatus.isLocked) {
                cardStyleOverride = 'border-color: var(--primary-light); border-width: 2px;';
            }

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6 mb-4 md:mb-0 items-stretch flex-grow h-full">
                    <div class="w-full md:w-[45%] flex flex-col flex-shrink-0">
                        <div class="lesson-main-btn ${lessonBgClass} group" style="${cardStyleOverride}" onclick="openLesson('${lesson.id}')">
                            ${lessonBgIcon}
                            <div class="flex justify-between items-start w-full relative z-10">
                                <span class="block text-xs font-bold bg-white/60 px-3 py-1 rounded-full text-gray-500 backdrop-blur-sm">الدرس الحالي</span>
                                <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-theme group-hover:scale-110 transition"><i class="fas fa-play ml-1 text-xl"></i></div>
                            </div>
                            <div class="mt-auto mb-4 relative z-10">
                                <h2 class="lesson-btn-title block mb-3 leading-tight text-xl md:text-2xl font-black text-gray-800">${lesson.title}</h2>
                                ${lockedDateText}
                                <div class="score-pill ${lessonBadgeClass} inline-flex mt-2">${lessonBadgeText}</div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-[55%] flex flex-col h-full justify-between">
                        <div class="flex-grow flex flex-col justify-end pb-3 min-h-[30px]">
                            <h3 class="flex items-center gap-2 font-bold text-gray-500 text-sm px-1"><i class="fas fa-shapes text-theme"></i> الأنشطة والألعاب</h3>
                        </div>
                        <div class="games-grid w-full flex-shrink-0">${gamesHtml}</div>
                    </div>
                </div>
                <div class="progress-section mt-6 md:mt-auto">
                    <div class="progress-text mb-2"><span>التقدم في الدرس</span><span class="text-theme">${Math.round(progress)}%</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${progress}%"></div></div>
                    <div class="text-xs text-gray-400 mt-1 flex justify-between"><span>النقاط: ${totalPoints}</span><span>الحد الأقصى: ${maxTotalPoints}</span></div>
                </div>
            `;
        }

        function updateHeader() {
            if(!currentUser) return;
            document.getElementById('header-name').textContent = currentUser.name.split(' ')[0];
            let total = 0;
            if(currentUser.lessons) Object.values(currentUser.lessons).forEach(v => total += (v.grade || 0));
            if(currentUser.games) Object.values(currentUser.games).forEach(v => total += (v.grade || 0));
            document.getElementById('header-score').textContent = total;
        }

        // --- Logic: Lesson View & Game Navigation ---
        
        // دالة مساعدة لتحويل الأرقام الإنجليزية للعربية
        function toArabicNumerals(str) {
            return str.replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
        }

        function openLesson(lessonId) {
            activeLessonId = lessonId;
            const chapter = curriculumIndex[currentChapterKey];
            const lesson = chapter.lessons.find(l => l.id === lessonId);
            const index = chapter.lessons.indexOf(lesson);
            if(!lesson) return;

            // Check lock status
            const lockStatus = checkLessonLockStatus(lesson, index, chapter);

            if (lockStatus.isLocked) {
                // Show Locked View inside dashboard overlay
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('lesson-view').classList.remove('hidden');
                
                // Show Locked Content
                document.getElementById('locked-view').classList.remove('hidden');
                document.getElementById('open-view').classList.add('hidden');
                
                const dateDisplay = document.getElementById('unlock-date-display');
                if (lockStatus.date) {
                    dateDisplay.textContent = lockStatus.date;
                } else {
                    dateDisplay.textContent = "غير محدد";
                }
                return;
            }

            // --- إذا كان الدرس مفتوحاً: التوجيه لصفحة الدرس مباشرة ---
            
            // Calculate total score first
            let totalScore = 0;
            if(currentUser.lessons) Object.values(currentUser.lessons).forEach(v => totalScore += (v.grade || 0));
            if(currentUser.games) Object.values(currentUser.games).forEach(v => totalScore += (v.grade || 0));

            // تحديد بيانات الطالب (مع معالجة حالة الزائر)
            const studentId = currentUser.id || 'visitor';
            const classId = currentUser.classIdentifier || 'visitor';
            // ترميز الاسم لضمان عدم حدوث مشاكل في الرابط
            const studentName = encodeURIComponent(currentUser.name || 'زائر');

            // إضافة طابع زمني (timestamp) لمنع المتصفح من حفظ نسخة قديمة من الصفحة (Caching)
            const timestamp = new Date().getTime();

            // إضافة درجات الدرس الحالية لسرعة التحميل
            const currentLessonScore = currentUser?.lessons?.[lesson.id]?.grade || 0;
            const currentLessonMax = lesson.maxScore;

            // بناء الرابط الأساسي مع كافة البيانات
            let lessonUrl = `${BASE_LESSON_URL}${lessonId}.html?studentId=${studentId}&name=${studentName}&classId=${classId}&totalScore=${totalScore}&lessonScore=${currentLessonScore}&lessonMax=${currentLessonMax}&v=${timestamp}`;
            
            // إضافة معلومات درجات الألعاب للرابط
            lesson.games.forEach((game, idx) => {
                const gameScore = currentUser?.games?.[game.id]?.grade || 0;
                const gameMax = game.maxScore || 5;
                lessonUrl += `&g${idx+1}_title=${encodeURIComponent(game.title)}`;
                lessonUrl += `&g${idx+1}_id=${game.id}`;
                lessonUrl += `&g${idx+1}_score=${gameScore}`;
                lessonUrl += `&g${idx+1}_max=${gameMax}`;
            });

            console.log("Redirecting to Lesson URL:", lessonUrl);
            
            // *** التوجيه المباشر للصفحة ***
            window.location.href = lessonUrl;
        }

        function closeLesson() {
            document.getElementById('lesson-view').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            activeLessonId = null;
            // Update data in background
            updateData(); 
        }

        function openGameInDashboard(gameId, title) {
            gameOrigin = 'dashboard';
            openGameModal(gameId, title);
        }

        function openGameInLesson(gameId, title) {
            gameOrigin = 'lesson';
            openGameModal(gameId, title);
        }

        function openGameModal(gameId, title) {
            activeGameId = gameId;
            document.getElementById('modal-game-title').textContent = title;
            
            const studentId = currentUser?.id || 'visitor';
            const classId = currentUser?.classIdentifier || 'visitor';
            // إضافة الاسم
            const studentName = encodeURIComponent(currentUser?.name || 'زائر');
            
            // البحث عن درجة اللعبة الحالية والقصوى
            let gameScore = currentUser?.games?.[gameId]?.grade || 0;
            let maxScore = 5; // القيمة الافتراضية
            
            // البحث عن بيانات اللعبة في المنهج للحصول على الدرجة القصوى الصحيحة
            let gameFound = false;
            for (const chKey in curriculumIndex) {
                if(gameFound) break;
                const chapter = curriculumIndex[chKey];
                for (const lesson of chapter.lessons) {
                     const foundGame = lesson.games.find(g => g.id === gameId);
                     if (foundGame) {
                         maxScore = foundGame.maxScore;
                         gameFound = true;
                         break;
                     }
                }
            }
            
            // حساب المجموع الكلي (اختياري للإرسال)
            let totalScore = 0;
            if(currentUser?.lessons) Object.values(currentUser.lessons).forEach(v => totalScore += (v.grade || 0));
            if(currentUser?.games) Object.values(currentUser.games).forEach(v => totalScore += (v.grade || 0));

            // إضافة طابع زمني
            const timestamp = new Date().getTime();

            // بناء الرابط الكامل مع كافة البيانات لتسريع التحميل
            const gameUrl = `${BASE_GAME_URL}${gameId}.html?studentId=${studentId}&classId=${classId}&name=${studentName}&score=${gameScore}&maxScore=${maxScore}&totalScore=${totalScore}&v=${timestamp}`;
            
            document.getElementById('game-iframe').src = gameUrl;
            document.getElementById('modal-game').classList.remove('hidden');
            
            // Reset minimization
            document.getElementById('minimized-game-bar').classList.add('hidden');
        }

        // Logic to minimize game
        function minimizeGame() {
            document.getElementById('modal-game').classList.add('hidden');
            
            // Update bar info
            document.getElementById('minimized-game-title').textContent = document.getElementById('modal-game-title').textContent;
            
            // Show bar with animation
            const bar = document.getElementById('minimized-game-bar');
            bar.classList.remove('hidden');
        }

        // Logic to restore game
        function restoreGame() {
            document.getElementById('minimized-game-bar').classList.add('hidden');
            document.getElementById('modal-game').classList.remove('hidden');
        }

        // Logic to toggle fullscreen for game modal
        function toggleFullscreen() {
            const modalContent = document.querySelector('#modal-game .modal-content');
            const icon = document.getElementById('fullscreen-icon');
            
            modalContent.classList.toggle('is-fullscreen');
            
            if (modalContent.classList.contains('is-fullscreen')) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }

        function closeGameModal() {
            document.getElementById('modal-game').classList.add('hidden');
            document.getElementById('minimized-game-bar').classList.add('hidden');
            document.getElementById('game-iframe').src = '';
            
            // Reset fullscreen state
            const modalContent = document.querySelector('#modal-game .modal-content');
            modalContent.classList.remove('is-fullscreen');
            const icon = document.getElementById('fullscreen-icon');
            if(icon) {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }

            activeGameId = null;
            // Return logic
            if (gameOrigin === 'lesson') {
                updateData(true); // true = stay in lesson
            } else {
                updateData(); // Refresh dashboard
            }
        }

        function switchLessonTab(tabId) {
            // Not used in simplified lesson view
        }
        
        // Listen for closeLesson message from iframe
        window.addEventListener('message', function(event) {
            if (event.data === 'closeLesson') {
                closeLesson();
            }
        });

        // This function is called by the iframe game when finished
        window.closeGameModal = closeGameModal;
        window.updateData = updateData;

        // --- Data Handling ---
        function updateData(stayInLesson = false) {
            if(!currentUser || currentUser.id === 'visitor') return;
            
            // إضافة طابع زمني (cache busting)
            const timestamp = new Date().getTime();
            fetch(`${API_URL}?action=getStudentData&studentId=${currentUser.id}&classId=${currentUser.classIdentifier}&t=${timestamp}`)
            .then(r=>r.json()).then(d=>{ 
                if(d.status==='success'){ 
                    currentUser=d.data; 
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                    if (!stayInLesson) renderInterface(); 
                }
            });
        }

        function submitQuiz(score) {
            // Quiz logic moved to iframe content, this function is kept if needed for legacy/dashboard games
            const btn = document.querySelector('#quiz-container button'); 
            if (btn) {
                document.getElementById('quiz-container').classList.add('opacity-50');
            }
            
            if(currentUser && currentUser.id !== 'visitor') {
                fetch(`${API_URL}?action=saveScore&studentId=${currentUser.id}&classId=${currentUser.classIdentifier}&type=lesson&itemId=${activeLessonId}&score=${score}`)
                .then(r => r.json())
                .then(d => {
                    // Logic handled inside iframe usually
                    if (d.status === 'success') {
                         updateData(true);
                    }
                });
            } else {
                alert('زائر: لا يمكن الحفظ');
            }
        }

        // --- Auth ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value;
            const btn = document.getElementById('login-submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
            
            // إضافة cache busting هنا أيضاً
            const timestamp = new Date().getTime();
            fetch(`${API_URL}?action=findStudentById&studentId=${id}&t=${timestamp}`)
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'success' && d.data.found) {
                        return fetch(`${API_URL}?action=getStudentData&studentId=${d.data.id}&classId=${d.data.classIdentifier}&t=${timestamp}`);
                    } else {
                        throw new Error('رقم الهوية غير صحيح أو الطالب غير مسجل');
                    }
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'success') {
                        currentUser = d.data;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        initApp();
                    }
                })
                .catch(err => {
                    document.getElementById('login-error').textContent = err.message;
                    document.getElementById('login-error').classList.remove('hidden');
                    btn.innerHTML = originalText;
                });
        });

        document.getElementById('visitor-btn').addEventListener('click', () => {
            currentUser = { id: 'visitor', classIdentifier: 'visitor', name: 'زائر', lessons: {}, games: {} };
            initApp();
        });

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function initApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').classList.remove('hidden');
            renderInterface();
        }

        const stored = localStorage.getItem('currentUser');
        if(stored) {
            currentUser = JSON.parse(stored);
            updateData();
            initApp();
        }
    </script>
</body>
</html>

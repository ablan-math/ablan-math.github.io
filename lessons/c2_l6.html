<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٢-٦: المتتابعات الحسابية | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .math-eq {
            color: #4338ca; /* indigo-700 */
            font-weight: bold;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .explanation-step { 
            padding-right: 12px; 
            margin-bottom: 1rem; 
            border-right: 3px solid #1d4ed8; 
            transition: opacity 0.5s ease-in-out; 
        }
        .explanation-step:last-child {
            margin-bottom: 0;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2em;
            line-height: 1.2em;
        }
        .fraction > span { display: block; padding: 0 0.2em; }
        .fraction > span:last-child { border-top: 2px solid currentColor; }
        .nav-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .sequence-box {
            display: inline-block;
            width: 50px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            margin: 0 5px;
            font-size: 1.25rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .diff-arrow {
            position: relative;
            top: -15px;
            margin: 0 -5px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .diff-arrow.plus { color: #16a34a; }
        .diff-arrow.minus { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٢-٦: المتتابعات الحسابية</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفاهيم الأساسية</h2>
                    <div class="p-6 bg-blue-50 rounded-lg space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">المتتابعة الحسابية</h3>
                            <p>التعبير اللفظي: المتتابعة الحسابية نمط عددي يزيد أو ينقص بمقدار ثابت يُسمى <span class="vocab-term">أساس المتتابعة</span> (د).</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">الحد النوني في متتابعة حسابية</h3>
                            <p>يُعبّر عن الحد النوني (أ<sub class="font-bold">ن</sub>) لمتتابعة حسابية حدها الأول (أ<sub class="font-bold">١</sub>)، وأساسها (د) بالصيغة التالية، حيث (ن) عدد صحيح موجب.</p>
                             <div class="mt-4 p-4 bg-white rounded-lg border">
                                 <p class="text-lg text-center font-bold">صيغة الحد النوني</p>
                                 <p class="text-center my-2 p-3 bg-indigo-50 rounded-md text-xl math-eq">
                                    أ<sub class="font-bold">ن</sub> = أ<sub class="font-bold">١</sub> + (ن - ١) د
                                 </p>
                             </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: تمييز المتتابعات</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <p>هل المتتابعات التالية حسابية أم لا؟ اتبع الخطوات التفاعلية لمعرفة ذلك.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 1: متتابعة حسابية</h3>
                                <div class="text-center my-4">
                                    <span id="seq-box-1" class="sequence-box">٥</span>
                                    <span id="diff-1" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-2" class="sequence-box">١١</span>
                                    <span id="diff-2" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-3" class="sequence-box">١٧</span>
                                    <span id="diff-3" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-4" class="sequence-box">٢٣</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[150px]">
                                    <div id="identify-explanation-1" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <button id="identify-anim-back-1" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                    <span class="text-sm font-bold text-gray-600">الخطوة <span id="identify-step-counter-1">0</span> / 4</span>
                                    <button id="identify-anim-next-1" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                </div>
                            </div>
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 2: ليست حسابية</h3>
                                <div class="text-center my-4">
                                    <span id="seq-box-2-1" class="sequence-box">١</span>
                                    <span id="diff-2-1" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-2-2" class="sequence-box">٢</span>
                                    <span id="diff-2-2" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-2-3" class="sequence-box">٤</span>
                                    <span id="diff-2-3" class="diff-arrow plus">&nbsp;</span>
                                    <span id="seq-box-2-4" class="sequence-box">٧</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[150px]">
                                    <div id="identify-explanation-2" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <button id="identify-anim-back-2" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                    <span class="text-sm font-bold text-gray-600">الخطوة <span id="identify-step-counter-2">0</span> / 4</span>
                                    <button id="identify-anim-next-2" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🔍 ثالثاً: إيجاد الحدود التالية (تفاعلي)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                         <p>أوجد الحدود التالية في المتتابعات الحسابية التالية.</p>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 1: أساس موجب</h3>
                                <div class="text-center my-4 flex justify-center items-center flex-wrap">
                                    <span id="next-term-box-1" class="sequence-box">٢</span>
                                    <span id="next-term-diff-1" class="diff-arrow plus">&nbsp;</span>
                                    <span id="next-term-box-2" class="sequence-box">٥</span>
                                    <span id="next-term-diff-2" class="diff-arrow plus">&nbsp;</span>
                                    <span id="next-term-box-3" class="sequence-box">٨</span>
                                    <span id="next-term-diff-3" class="diff-arrow plus">&nbsp;</span>
                                    <span id="next-term-box-4" class="sequence-box">١١</span>
                                    <span id="next-term-diff-4" class="diff-arrow plus">&nbsp;</span>
                                    <span id="next-term-box-5" class="sequence-box text-gray-400">?</span>
                                    <span id="next-term-diff-5" class="diff-arrow plus">&nbsp;</span>
                                    <span id="next-term-box-6" class="sequence-box text-gray-400">?</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[120px]">
                                    <div id="next-term-explanation-1" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <button id="next-term-back-1" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                    <span class="text-sm font-bold text-gray-600">الخطوة <span id="next-term-counter-1">0</span> / 4</span>
                                    <button id="next-term-next-1" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                </div>
                            </div>
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 2: أساس سالب</h3>
                                <div class="text-center my-4 flex justify-center items-center flex-wrap">
                                    <span id="next-term-2-box-1" class="sequence-box">٢٠</span>
                                    <span id="next-term-2-diff-1" class="diff-arrow minus">&nbsp;</span>
                                    <span id="next-term-2-box-2" class="sequence-box">١٥</span>
                                    <span id="next-term-2-diff-2" class="diff-arrow minus">&nbsp;</span>
                                    <span id="next-term-2-box-3" class="sequence-box">١٠</span>
                                    <span id="next-term-2-diff-3" class="diff-arrow minus">&nbsp;</span>
                                    <span id="next-term-2-box-4" class="sequence-box">٥</span>
                                    <span id="next-term-2-diff-4" class="diff-arrow minus">&nbsp;</span>
                                    <span id="next-term-2-box-5" class="sequence-box text-gray-400">?</span>
                                     <span id="next-term-2-diff-5" class="diff-arrow minus">&nbsp;</span>
                                    <span id="next-term-2-box-6" class="sequence-box text-gray-400">?</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[120px]">
                                    <div id="next-term-explanation-2" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <button id="next-term-back-2" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                    <span class="text-sm font-bold text-gray-600">الخطوة <span id="next-term-counter-2">0</span> / 4</span>
                                    <button id="next-term-next-2" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                </div>
                            </div>
                         </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 رابعاً: كتابة معادلة الحد النوني (طريقتان)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                         <p>اكتب معادلة الحد النوني للمتتابعة الحسابية: ٣، ١٠، ١٧، ٢٤، ...</p>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">الطريقة الرسمية (بالصيغة)</h3>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[280px]">
                                   <div id="nth-term-formal-explanation" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="nth-term-formal-back" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="nth-term-formal-counter">0</span> / 5</span>
                                   <button id="nth-term-formal-next" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">الطريقة الذهنية (السريعة)</h3>
                                <div class="text-center my-4">
                                    <span id="mental-seq-box-1" class="sequence-box">٣</span>
                                    <span id="mental-diff-1" class="diff-arrow plus">&nbsp;</span>
                                    <span id="mental-seq-box-2" class="sequence-box">١٠</span>
                                    <span id="mental-diff-2" class="diff-arrow plus">&nbsp;</span>
                                    <span id="mental-seq-box-3" class="sequence-box">١٧</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[200px]">
                                   <div id="nth-term-mental-explanation" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="nth-term-mental-back" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="nth-term-mental-counter">0</span> / 3</span>
                                   <button id="nth-term-mental-next" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                         </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">⚙️ خامساً: تطبيقات على الحد النوني (تفاعلي)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 1: إيجاد قيمة حد</h3>
                                <p class="text-center text-gray-700">أوجد الحد العاشر في المتتابعة: ٤، ٩، ١٤، ...</p>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[280px] mt-4">
                                   <div id="find-value-explanation" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="find-value-back" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="find-value-counter">0</span> / 6</span>
                                   <button id="find-value-next" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2 text-lg">مثال 2: إيجاد ترتيب حد</h3>
                                <p class="text-center text-gray-700">ما ترتيب الحد الذي قيمته ٣٨ في المتتابعة: ٨، ١١، ١٤، ...؟</p>
                                <div class="bg-gray-50 p-4 rounded-lg border min-h-[280px] mt-4">
                                   <div id="find-rank-explanation" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="find-rank-back" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="find-rank-counter">0</span> / 6</span>
                                   <button id="find-rank-next" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                         </div>
                    </div>
                </section>

                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ سادساً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // === دوال مشتركة للمنصة ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function initializeQuiz(lessonId, questions, studentData) { currentQuestions = questions; const quizForm = document.getElementById('quizForm'); if (!quizForm) return; if (questions.length === 0) { quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; return; } let attemptsLeft; if (studentData) { const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 }; attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts; } else { attemptsLeft = 1; } const attemptsCounter = document.getElementById('attempts-counter'); if (attemptsCounter) { attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; } const quizHtml = questions.map((q, index) => { const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); return `<div class="p-4 border-2 border-gray-200 rounded-lg bg-white"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div>`; }).join(''); quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; questions.forEach((q, index) => { const explainBtn = document.getElementById(`explain-btn-${index}`); if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index)); }); if (attemptsLeft <= 0) { const submitBtn = quizForm.querySelector('#submit-quiz-btn'); submitBtn.disabled = true; submitBtn.textContent = 'لا توجد محاولات متبقية'; submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400'); } quizForm.onsubmit = (e) => { e.preventDefault(); let score = 0; questions.forEach((q, index) => { const userAnswer = e.target.elements[`q${index}`]?.value; const feedbackEl = document.getElementById(`feedback-q${index}`); if (userAnswer === q.correct) { score++; feedbackEl.textContent = '✔ إجابة صحيحة!'; feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; } else { feedbackEl.textContent = `❌ إجابة خاطئة.`; feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; } document.getElementById(`explain-btn-${index}`).classList.remove('hidden');}); const finalGrade = Math.round((score / questions.length) * 10); const resultsDiv = document.getElementById('quiz-results'); resultsDiv.classList.remove('hidden'); document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; if (studentData) { saveGrade(lessonId, finalGrade, studentData.id); if (attemptsLeft - 1 > 0) { document.getElementById('retake-quiz-btn').classList.remove('hidden'); } } else { document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; } e.target.querySelector('#submit-quiz-btn').disabled = true; }; }
    function saveGrade(lessonId, grade, studentId) { if (!studentId) return; const saveStatus = document.getElementById('save-status'); saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&lessonId=${lessonId}&grade=${grade}`; fetch(url) .then(res => res.json()) .then(result => { if (result.status === 'success') { saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; const studentData = JSON.parse(localStorage.getItem('currentStudent')); if (!studentData.lessons) studentData.lessons = {}; if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; } else { studentData.lessons[lessonId].attempts++; } localStorage.setItem('currentStudent', JSON.stringify(studentData)); } else { throw new Error(result.message); } }) .catch(error => { saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; console.error("Save Grade Error:", error); }); }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { const originalQuestion = questionBank.find(q => q.text === currentQuestions[questionIndex].text); const originalIndex = questionBank.indexOf(originalQuestion); let explanationHTML = currentQuestions[questionIndex].explanation; explanationHTML = explanationHTML.replace(/q[0-9]/g, `q${originalIndex}`); explanationText.innerHTML = explanationHTML; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }
    window.toggleSolution = function(questionId, view) { const formalDiv = document.getElementById(`formal-solution-${questionId}`); const mentalDiv = document.getElementById(`mental-solution-${questionId}`); if (view === 'mental') { formalDiv.style.display = 'none'; mentalDiv.style.display = 'block'; } else { formalDiv.style.display = 'block'; mentalDiv.style.display = 'none'; } }
    
    // === مشغل الكود الخاص بالدرس ===
    const LESSON_ID = 'c2_l6'; 
    const questionBank = [
        { type: 'mcq', level: '⭐', topic: 'concept', text: 'ما هو الاسم الذي يطلق على المقدار الثابت الذي يضاف لكل حد في المتتابعة الحسابية؟', options: [ { display: 'الحد الأول', value: 'A' }, { display: 'الحد النوني', value: 'B' }, { display: 'الأساس', value: 'C' }, { display: 'المتغير', value: 'D' } ], correct: 'C', explanation: '<p>يُسمى المقدار الثابت الذي يضاف (أو يطرح) في المتتابعة الحسابية بـ "الأساس" ويرمز له بالرمز (د).</p>' },
        { type: 'mcq', level: '⭐⭐', topic: 'identify', text: 'أي من المتتابعات التالية تُعد متتابعة حسابية؟', options: [ { display: '١، ٢، ٤، ٨، ...', value: 'A' }, { display: '١٠، ٧، ٤، ١، ...', value: 'B' }, { display: '١، -١، ٢، -٢، ...', value: 'C' }, { display: '١، ٤، ٩، ١٦، ...', value: 'D' } ], correct: 'B', explanation: '<p>المتتابعة (ب) هي الحسابية لأن الفرق بين كل حدين متتاليين ثابت ويساوي -٣. (٧-١٠ = -٣، ٤-٧ = -٣).</p>' },
        { type: 'mcq', level: '⭐⭐', topic: 'find-difference', text: 'ما أساس المتتابعة الحسابية: -٥، -١، ٣، ٧، ...؟', options: [ { display: '-٤', value: 'A' }, { display: '٤', value: 'B' }, { display: '٥', value: 'C' }, { display: '-٥', value: 'D' } ], correct: 'B', explanation: '<p>لإيجاد الأساس، نطرح أي حد من الذي يسبقه. على سبيل المثال: (-١) - (-٥) = -١ + ٥ = ٤.</p>' },
        { type: 'mcq', level: '⭐⭐', topic: 'next-term', text: 'أوجد الحد التالي في المتتابعة الحسابية: ٢، ٩، ١٦، ٢٣، ...', options: [ { display: '٢٩', value: 'A' }, { display: '٣٠', value: 'B' }, { display: '٧', value: 'C' }, { display: '٣١', value: 'D' } ], correct: 'B', explanation: '<p>أولاً، نوجد الأساس: ٩ - ٢ = ٧. ثم نضيف الأساس إلى الحد الأخير: ٢٣ + ٧ = ٣٠.</p>' },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'nth-term-formula', text: 'ما معادلة الحد النوني للمتتابعة: ٤، ٩، ١٤، ١٩، ...؟', options: [ { display: 'أ<sub class="font-bold">ن</sub> = ٤ن + ٥', value: 'A' }, { display: 'أ<sub class="font-bold">ن</sub> = ٥ن + ٤', value: 'B' }, { display: 'أ<sub class="font-bold">ن</sub> = ٥ن - ١', value: 'C' }, { display: 'أ<sub class="font-bold">ن</sub> = ٤ن - ١', value: 'D' } ], correct: 'C', explanation: '<p>الحد الأول أ<sub class="font-bold">١</sub> = ٤ والأساس د = ٩ - ٤ = ٥. نطبق الصيغة: أ<sub class="font-bold">ن</sub> = أ<sub class="font-bold">١</sub> + (ن - ١)د = ٤ + (ن - ١)٥ = ٤ + ٥ن - ٥ = ٥ن - ١.</p>' },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'find-term', text: 'استخدم المعادلة أ<sub class="font-bold">ن</sub> = ٣ن - ٨ لإيجاد الحد العاشر في المتتابعة.', options: [ { display: '٢٢', value: 'A' }, { display: '٣٠', value: 'B' }, { display: '٣٨', value: 'C' }, { display: '١٥', value: 'D' } ], correct: 'A', explanation: '<p>لإيجاد الحد العاشر، نعوض عن ن بـ ١٠ في المعادلة: أ<sub class="font-bold">١٠</sub> = ٣(١٠) - ٨ = ٣٠ - ٨ = ٢٢.</p>' },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'find-rank', text: 'ما ترتيب الحد الذي قيمته (٥٥) في المتتابعة الحسابية: ١٠، ١٥، ٢٠، ...؟', options: [ { display: 'الحد العاشر', value: 'A' }, { display: 'الحد التاسع', value: 'B' }, { display: 'الحد الحادي عشر', value: 'C' }, { display: 'الحد الخامس', value: 'D' } ], correct: 'A', 
          explanation: `
            <div id="explanation-wrapper-q0">
                <div id="formal-solution-q0">
                    <div class="space-y-3 text-right">
                        <p><strong>1. تحديد المعطيات:</strong></p>
                        <ul class="list-disc pr-6">
                            <li>الحد المطلوب (أ<sub class="font-bold">ن</sub>): <span class="math-eq text-red-600">٥٥</span></li>
                            <li>الحد الأول (أ<sub class="font-bold">١</sub>): <span class="math-eq text-green-600">١٠</span></li>
                            <li>الأساس (د): <span class="math-eq text-blue-600">١٥ - ١٠ = ٥</span></li>
                        </ul>
                        <p><strong>2. كتابة الصيغة والتعويض:</strong></p>
                        <p class="math-eq text-center bg-gray-100 p-2 rounded-md">أ<sub class="font-bold">ن</sub> = أ<sub class="font-bold">١</sub> + (ن - ١) د</p>
                        <p class="math-eq text-center"><span class="text-red-600">٥٥</span> = <span class="text-green-600">١٠</span> + (ن - ١) <span class="text-blue-600">٥</span></p>
                        <p><strong>3. حل المعادلة لإيجاد (ن):</strong></p>
                        <div class="text-center space-y-2">
                            <p class="math-eq">٤٥ = (ن - ١) × ٥</p>
                            <div><p class="math-eq">٩ = ن - ١</p><p class="text-xs text-gray-500 italic">(بقسمة الطرفين على ٥)</p></div>
                            <div><p class="math-eq"><span class="p-1 bg-green-100 rounded-md">ن = ١٠</span></p><p class="text-xs text-gray-500 italic">(بإضافة ١ للطرفين)</p></div>
                        </div>
                    </div>
                    <button onclick="window.toggleSolution('q0', 'mental')" class="mt-4 w-full bg-purple-100 text-purple-700 font-bold py-2 px-4 rounded-lg hover:bg-purple-200">عرض الحل الذهني</button>
                </div>
                <div id="mental-solution-q0" style="display: none;">
                     <div class="space-y-3 text-right">
                        <p><strong>1. إيجاد معادلة الحد النوني (ذهنياً):</strong></p>
                        <ul class="list-disc pr-6">
                            <li>الأساس (د) = <span class="math-eq text-blue-600">٥</span>. إذن المعادلة تبدأ بـ <span class="math-eq">٥ن</span>.</li>
                            <li>الحد الأول <span class="math-eq text-green-600">١٠</span>. الفرق عن الأساس: <span class="math-eq">١٠ - ٥ = ٥</span>.</li>
                            <li>المعادلة هي: <span class="math-eq bg-gray-100 p-1 rounded-md">أ<sub class="font-bold">ن</sub> = ٥ن + ٥</span>.</li>
                        </ul>
                        <p><strong>2. مساواة المعادلة بقيمة الحد المطلوب:</strong></p>
                        <p class="math-eq text-center">٥ن + ٥ = <span class="text-red-600">٥٥</span></p>
                        <p><strong>3. حل المعادلة لإيجاد (ن):</strong></p>
                        <div class="text-center space-y-2">
                            <p class="math-eq">٥ن = ٥٥ - ٥</p>
                            <p class="math-eq">٥ن = ٥٠</p>
                            <div><p class="math-eq"><span class="p-1 bg-green-100 rounded-md">ن = ١٠</span></p><p class="text-xs text-gray-500 italic">(بقسمة الطرفين على ٥)</p></div>
                        </div>
                    </div>
                    <button onclick="window.toggleSolution('q0', 'formal')" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">العودة للحل الرسمي</button>
                </div>
            </div>` },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'find-rank', text: 'ما ترتيب الحد الذي قيمته (٢) في المتتابعة الحسابية: ٢٦، ٢٣، ٢٠، ...؟', options: [ { display: 'الحد الثامن', value: 'A' }, { display: 'الحد التاسع', value: 'B' }, { display: 'الحد السابع', value: 'C' }, { display: 'الحد العاشر', value: 'D' } ], correct: 'B', 
          explanation: `
            <div id="explanation-wrapper-q1">
                 <div id="formal-solution-q1">
                    <div class="space-y-3 text-right">
                        <p><strong>1. تحديد المعطيات:</strong></p>
                        <ul class="list-disc pr-6">
                            <li>الحد المطلوب (أ<sub class="font-bold">ن</sub>): <span class="math-eq text-red-600">٢</span></li>
                            <li>الحد الأول (أ<sub class="font-bold">١</sub>): <span class="math-eq text-green-600">٢٦</span></li>
                            <li>الأساس (د): <span class="math-eq text-blue-600">٢٣ - ٢٦ = -٣</span></li>
                        </ul>
                        <p><strong>2. كتابة الصيغة والتعويض:</strong></p>
                        <p class="math-eq text-center bg-gray-100 p-2 rounded-md">أ<sub class="font-bold">ن</sub> = أ<sub class="font-bold">١</sub> + (ن - ١) د</p>
                        <p class="math-eq text-center"><span class="text-red-600">٢</span> = <span class="text-green-600">٢٦</span> + (ن - ١) (<span class="text-blue-600">-٣</span>)</p>
                        <p><strong>3. حل المعادلة لإيجاد (ن):</strong></p>
                        <div class="text-center space-y-2">
                            <p class="math-eq">-٢٤ = (ن - ١) × -٣</p>
                            <div><p class="math-eq">٨ = ن - ١</p><p class="text-xs text-gray-500 italic">(بقسمة الطرفين على -٣)</p></div>
                            <div><p class="math-eq"><span class="p-1 bg-green-100 rounded-md">ن = ٩</span></p><p class="text-xs text-gray-500 italic">(بإضافة ١ للطرفين)</p></div>
                        </div>
                    </div>
                    <button onclick="window.toggleSolution('q1', 'mental')" class="mt-4 w-full bg-purple-100 text-purple-700 font-bold py-2 px-4 rounded-lg hover:bg-purple-200">عرض الحل الذهني</button>
                </div>
                <div id="mental-solution-q1" style="display: none;">
                     <div class="space-y-3 text-right">
                        <p><strong>1. إيجاد معادلة الحد النوني (ذهنياً):</strong></p>
                        <ul class="list-disc pr-6">
                            <li>الأساس (د) = <span class="math-eq text-blue-600">-٣</span>. إذن المعادلة تبدأ بـ <span class="math-eq">-٣ن</span>.</li>
                            <li>الحد الأول <span class="math-eq text-green-600">٢٦</span>. الفرق عن الأساس: <span class="math-eq">٢٦ - (-٣) = ٢٩</span>.</li>
                            <li>المعادلة هي: <span class="math-eq bg-gray-100 p-1 rounded-md">أ<sub class="font-bold">ن</sub> = -٣ن + ٢٩</span>.</li>
                        </ul>
                        <p><strong>2. مساواة المعادلة بقيمة الحد المطلوب:</strong></p>
                        <p class="math-eq text-center">-٣ن + ٢٩ = <span class="text-red-600">٢</span></p>
                        <p><strong>3. حل المعادلة لإيجاد (ن):</strong></p>
                        <div class="text-center space-y-2">
                            <p class="math-eq">-٣ن = ٢ - ٢٩</p>
                            <p class="math-eq">-٣ن = -٢٧</p>
                            <div><p class="math-eq"><span class="p-1 bg-green-100 rounded-md">ن = ٩</span></p><p class="text-xs text-gray-500 italic">(بقسمة الطرفين على -٣)</p></div>
                        </div>
                    </div>
                    <button onclick="window.toggleSolution('q1', 'formal')" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">العودة للحل الرسمي</button>
                </div>
            </div>` },
        { type: 'mcq', level: '⭐⭐', topic: 'identify', text: 'أي من المتتابعات التالية ليست حسابية؟', options: [ { display: '١، ٢، ٣، ٤', value: 'A' }, { display: '٥، ١٠، ١٥، ٢٠', value: 'B' }, { display: '٢، ٤، ٨، ١٦', value: 'C' }, { display: '٥٠، ٤٠، ٣٠، ٢٠', value: 'D' } ], correct: 'C', explanation: '<p>المتتابعة (ج) ليست حسابية لأن الفرق بين حدودها غير ثابت (هندسية، تضرب في ٢ كل مرة).</p>' },
        { type: 'mcq', level: '⭐⭐', topic: 'next-term', text: 'أوجد الحدود الثلاثة التالية في المتتابعة: -٨، -٦، -٤، ...', options: [ { display: '-٢، ٠، ٢', value: 'A' }, { display: '-٦، -٨، -١٠', value: 'B' }, { display: '٠، ٢، ٤', value: 'C' }, { display: '-٢، ١، ٣', value: 'D' } ], correct: 'A', explanation: '<p>الأساس هو (-٦) - (-٨) = ٢. الحدود التالية هي -٤+٢=-٢، -٢+٢=٠، ٠+٢=٢.</p>' },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'nth-term-formula', text: 'ما معادلة الحد النوني للمتتابعة: ١٣، ٨، ٣، -٢، ...؟', options: [ { display: 'أ<sub class="font-bold">ن</sub> = -٥ن + ١٨', value: 'A' }, { display: 'أ<sub class="font-bold">ن</sub> = ٥ن + ٨', value: 'B' }, { display: 'أ<sub class="font-bold">ن</sub> = ١٣ن - ٥', value: 'C' }, { display: 'أ<sub class="font-bold">ن</sub> = -٥ن - ١٨', value: 'D' } ], correct: 'A', explanation: '<p>الحد الأول ١٣ والأساس -٥. باستخدام الطريقة الذهنية: المعادلة تبدأ بـ -٥ن. للوصول من -٥ إلى ١٣ (الحد الأول)، نحتاج لإضافة ١٨. إذن المعادلة هي أ<sub class="font-bold">ن</sub> = -٥ن + ١٨.</p>' },
        { type: 'mcq', level: '⭐⭐⭐', topic: 'find-term', text: 'ما هو الحد العشرون في المتتابعة التي حدها الأول ٥ وأساسها ٣؟', options: [ { display: '٦٠', value: 'A' }, { display: '٦٢', value: 'B' }, { display: '٦٥', value: 'C' }, { display: '٥٩', value: 'D' } ], correct: 'B', explanation: `<p>نستخدم الصيغة أ<sub class="font-bold">ن</sub> = أ<sub class="font-bold">١</sub> + (ن-١)د. نعوض بالقيم: أ<sub class="font-bold">٢٠</sub> = ٥ + (٢٠-١) × ٣ = ٥ + (١٩ × ٣) = ٥ + ٥٧ = ٦٢.</p>` }
    ];

    function generateQuiz() {
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        const questionCount = Math.min(shuffled.length, 5);
        return shuffled.slice(0, questionCount);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- الكود الخاص بالأمثلة التفاعلية القديمة ---
        function createInteractiveSection(config) {
            let currentStep = 0;
            const renderStep = (step) => {
                if(config.stepCounter) config.stepCounter.textContent = step;
                let cumulativeHTML = '';
                if (step === 0) { cumulativeHTML = config.stepsContent[0].text; } else { for (let i = 1; i <= step; i++) { cumulativeHTML += `<div class="explanation-step">${config.stepsContent[i].text}</div>`; } }
                if(config.explanationDiv) config.explanationDiv.innerHTML = cumulativeHTML;
                if (config.customRender) { config.customRender(step); }
                if(config.backBtn) config.backBtn.disabled = (step === 0);
                if(config.nextBtn) config.nextBtn.textContent = (step === config.totalSteps) ? 'إعادة' : 'التالي';
            };
            if(config.nextBtn) config.nextBtn.addEventListener('click', () => { currentStep = (currentStep < config.totalSteps) ? currentStep + 1 : 0; renderStep(currentStep); });
            if(config.backBtn) config.backBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; renderStep(currentStep); } });
            renderStep(0);
        }
        createInteractiveSection({ nextBtn: document.getElementById('identify-anim-next-1'), backBtn: document.getElementById('identify-anim-back-1'), stepCounter: document.getElementById('identify-step-counter-1'), explanationDiv: document.getElementById('identify-explanation-1'), totalSteps: 4, stepsContent: [ { text: "نتحقق من أن الفرق بين كل حدين متتاليين ثابت." }, { text: "<strong>1. الفرق بين الحد الثاني والأول:</strong><br><span class='math-eq'>١١ - ٥ = ٦</span>" }, { text: "<strong>2. الفرق بين الحد الثالث والثاني:</strong><br><span class='math-eq'>١٧ - ١١ = ٦</span>" }, { text: "<strong>3. الفرق بين الحد الرابع والثالث:</strong><br><span class='math-eq'>٢٣ - ١٧ = ٦</span>" }, { text: `<strong>4. النتيجة:</strong> بما أن الفرق ثابت ويساوي ٦، فالمتتابعة <span class="font-bold text-green-600">حسابية</span> وأساسها (د) هو ٦.` } ], customRender: (step) => { for(let i=1; i<=3; i++) { document.getElementById(`diff-${i}`).style.opacity = '0'; document.getElementById(`diff-${i}`).innerHTML = '&nbsp;'; } for(let i=1; i<=4; i++) { document.getElementById(`seq-box-${i}`).classList.remove('bg-blue-100'); } if (step >= 1) { document.getElementById('seq-box-1').classList.add('bg-blue-100'); document.getElementById('seq-box-2').classList.add('bg-blue-100'); const diff1 = document.getElementById('diff-1'); diff1.innerHTML = '+٦'; diff1.style.opacity = '1'; } if (step >= 2) { document.getElementById('seq-box-3').classList.add('bg-blue-100'); const diff2 = document.getElementById('diff-2'); diff2.innerHTML = '+٦'; diff2.style.opacity = '1'; } if (step >= 3) { document.getElementById('seq-box-4').classList.add('bg-blue-100'); const diff3 = document.getElementById('diff-3'); diff3.innerHTML = '+٦'; diff3.style.opacity = '1'; } } });
        createInteractiveSection({ nextBtn: document.getElementById('identify-anim-next-2'), backBtn: document.getElementById('identify-anim-back-2'), stepCounter: document.getElementById('identify-step-counter-2'), explanationDiv: document.getElementById('identify-explanation-2'), totalSteps: 4, stepsContent: [ { text: "نتحقق من أن الفرق بين كل حدين متتاليين ثابت." }, { text: "<strong>1. الفرق بين الحد الثاني والأول:</strong><br><span class='math-eq'>٢ - ١ = ١</span>" }, { text: "<strong>2. الفرق بين الحد الثالث والثاني:</strong><br><span class='math-eq'>٤ - ٢ = ٢</span>" }, { text: "<strong>3. الفرق بين الحد الرابع والثالث:</strong><br><span class='math-eq'>٧ - ٤ = ٣</span>" }, { text: `<strong>4. النتيجة:</strong> بما أن الفرق <span class="font-bold text-red-600">غير ثابت</span>، فالمتتابعة <span class="font-bold text-red-600">ليست حسابية</span>.` } ], customRender: (step) => { const diffs = ['+١', '+٢', '+٣']; for(let i=1; i<=3; i++) { document.getElementById(`diff-2-${i}`).style.opacity = '0'; document.getElementById(`diff-2-${i}`).innerHTML = '&nbsp;'; } for(let i=1; i<=4; i++) { document.getElementById(`seq-box-2-${i}`).classList.remove('bg-blue-100'); } if (step >= 1) { document.getElementById('seq-box-2-1').classList.add('bg-blue-100'); document.getElementById('seq-box-2-2').classList.add('bg-blue-100'); const diff1 = document.getElementById('diff-2-1'); diff1.innerHTML = diffs[0]; diff1.style.opacity = '1'; } if (step >= 2) { document.getElementById('seq-box-2-3').classList.add('bg-blue-100'); const diff2 = document.getElementById('diff-2-2'); diff2.innerHTML = diffs[1]; diff2.style.opacity = '1'; } if (step >= 3) { document.getElementById('seq-box-2-4').classList.add('bg-blue-100'); const diff3 = document.getElementById('diff-2-3'); diff3.innerHTML = diffs[2]; diff3.style.opacity = '1'; } } });
        createInteractiveSection({ nextBtn: document.getElementById('next-term-next-1'), backBtn: document.getElementById('next-term-back-1'), stepCounter: document.getElementById('next-term-counter-1'), explanationDiv: document.getElementById('next-term-explanation-1'), totalSteps: 4, stepsContent: [ { text: "نكتشف النمط (الأساس) أولاً ثم نطبقه لإيجاد الحدود التالية." }, { text: "<strong>1. نوجد الفرق بين الحدين الأولين:</strong><br><span class='math-eq'>٥ - ٢ = ٣</span>. الأساس هو +٣." }, { text: "<strong>2. نستخدم الأساس لإيجاد الحد الخامس:</strong><br><span class='math-eq'>١١ + ٣ = ١٤</span>." }, { text: "<strong>3. نكرر العملية لإيجاد الحد السادس:</strong><br><span class='math-eq'>١٤ + ٣ = ١٧</span>." }, { text: "<strong>4. الحدود التالية هي ١٤ و ١٧.</strong>" } ], customRender: (step) => { for(let i = 1; i <= 5; i++) { if(document.getElementById(`next-term-diff-${i}`)) document.getElementById(`next-term-diff-${i}`).style.opacity = '0'; if(document.getElementById(`next-term-box-${i}`)) document.getElementById(`next-term-box-${i}`).classList.remove('bg-blue-100', 'bg-green-100'); } document.getElementById('next-term-box-5').textContent = '?'; document.getElementById('next-term-box-5').classList.add('text-gray-400'); document.getElementById('next-term-box-6').textContent = '?'; document.getElementById('next-term-box-6').classList.add('text-gray-400'); if (step >= 1) { document.getElementById('next-term-box-1').classList.add('bg-blue-100'); document.getElementById('next-term-box-2').classList.add('bg-blue-100'); document.getElementById('next-term-diff-1').innerHTML = '+٣'; document.getElementById('next-term-diff-1').style.opacity = '1'; } if (step >= 2) { document.getElementById('next-term-box-4').classList.add('bg-blue-100'); document.getElementById('next-term-diff-4').innerHTML = '+٣'; document.getElementById('next-term-diff-4').style.opacity = '1'; const box5 = document.getElementById('next-term-box-5'); box5.textContent = '١٤'; box5.classList.remove('text-gray-400'); box5.classList.add('bg-green-100'); } if (step >= 3) { document.getElementById('next-term-box-5').classList.add('bg-blue-100'); document.getElementById('next-term-diff-5').innerHTML = '+٣'; document.getElementById('next-term-diff-5').style.opacity = '1'; const box6 = document.getElementById('next-term-box-6'); box6.textContent = '١٧'; box6.classList.remove('text-gray-400'); box6.classList.add('bg-green-100'); } } });
        createInteractiveSection({ nextBtn: document.getElementById('next-term-next-2'), backBtn: document.getElementById('next-term-back-2'), stepCounter: document.getElementById('next-term-counter-2'), explanationDiv: document.getElementById('next-term-explanation-2'), totalSteps: 4, stepsContent: [ { text: "نكتشف النمط (الأساس) أولاً ثم نطبقه لإيجاد الحدود التالية." }, { text: "<strong>1. نوجد الفرق بين الحدين الأولين:</strong><br><span class='math-eq'>١٥ - ٢٠ = -٥</span>. الأساس هو -٥." }, { text: "<strong>2. نستخدم الأساس لإيجاد الحد الخامس:</strong><br><span class='math-eq'>٥ + (-٥) = ٠</span>." }, { text: "<strong>3. نكرر العملية لإيجاد الحد السادس:</strong><br><span class='math-eq'>٠ + (-٥) = -٥</span>." }, { text: "<strong>4. الحدود التالية هي ٠ و -٥.</strong>" } ], customRender: (step) => { for(let i = 1; i <= 5; i++) { if(document.getElementById(`next-term-2-diff-${i}`)) document.getElementById(`next-term-2-diff-${i}`).style.opacity = '0'; if(document.getElementById(`next-term-2-box-${i}`)) document.getElementById(`next-term-2-box-${i}`).classList.remove('bg-blue-100', 'bg-green-100'); } document.getElementById('next-term-2-box-5').textContent = '?'; document.getElementById('next-term-2-box-5').classList.add('text-gray-400'); document.getElementById('next-term-2-box-6').textContent = '?'; document.getElementById('next-term-2-box-6').classList.add('text-gray-400'); if (step >= 1) { document.getElementById('next-term-2-box-1').classList.add('bg-blue-100'); document.getElementById('next-term-2-box-2').classList.add('bg-blue-100'); document.getElementById('next-term-2-diff-1').innerHTML = '-٥'; document.getElementById('next-term-2-diff-1').style.opacity = '1'; } if (step >= 2) { document.getElementById('next-term-2-box-4').classList.add('bg-blue-100'); document.getElementById('next-term-2-diff-4').innerHTML = '-٥'; document.getElementById('next-term-2-diff-4').style.opacity = '1'; const box5 = document.getElementById('next-term-2-box-5'); box5.textContent = '٠'; box5.classList.remove('text-gray-400'); box5.classList.add('bg-green-100'); } if (step >= 3) { document.getElementById('next-term-2-box-5').classList.add('bg-blue-100'); document.getElementById('next-term-2-diff-5').innerHTML = '-٥'; document.getElementById('next-term-2-diff-5').style.opacity = '1'; const box6 = document.getElementById('next-term-2-box-6'); box6.textContent = '-٥'; box6.classList.remove('text-gray-400'); box6.classList.add('bg-green-100'); } } });
        createInteractiveSection({ nextBtn: document.getElementById('nth-term-formal-next'), backBtn: document.getElementById('nth-term-formal-back'), stepCounter: document.getElementById('nth-term-formal-counter'), explanationDiv: document.getElementById('nth-term-formal-explanation'), totalSteps: 5, stepsContent: [ { text: "نستخدم الصيغة العامة ونعوض فيها بالقيم." }, { text: "<strong>1. نبدأ بصيغة الحد النوني:</strong><br><span class='math-eq text-center mt-2 block'>أ<sub class='font-bold'>ن</sub> = أ<sub class='font-bold'>١</sub> + (ن - ١) د</span>" }, { text: "<strong>2. نحدد الحد الأول (أ<sub class='font-bold'>١</sub>) والأساس (د):</strong><br>الحد الأول <span class='math-eq'>أ<sub class='font-bold'>١</sub> = ٣</span>.<br>الأساس <span class='math-eq'>د = ١٠ - ٣ = ٧</span>." }, { text: "<strong>3. نعوض بالقيم في الصيغة:</strong><br><span class='math-eq text-center mt-2 block'>أ<sub class='font-bold'>ن</sub> = <span class='text-red-600'>٣</span> + (ن - ١) × <span class='text-green-600'>٧</span></span>" }, { text: "<strong>4. نستخدم خاصية التوزيع:</strong><br><span class='math-eq text-center mt-2 block'>أ<sub class='font-bold'>ن</sub> = ٣ + ٧ن - ٧</span>" }, { text: "<strong>5. نجمع الحدود المتشابهة:</strong><br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md'>أ<sub class='font-bold'>ن</sub> = ٧ن - ٤</span>" } ] });
        createInteractiveSection({ nextBtn: document.getElementById('nth-term-mental-next'), backBtn: document.getElementById('nth-term-mental-back'), stepCounter: document.getElementById('nth-term-mental-counter'), explanationDiv: document.getElementById('nth-term-mental-explanation'), totalSteps: 3, stepsContent: [ { text: "هذه طريقة سريعة لإيجاد المعادلة مباشرة." }, { text: "<strong>1. نوجد الأساس (د):</strong><br><span class='math-eq'>١٠ - ٣ = ٧</span>.<br>إذن، الحد النوني يبدأ بـ <span class='math-eq text-xl'>٧ن</span>." }, { text: "<strong>2. نقارن بالحد الأول:</strong><br>الحد الأول الفعلي هو <span class='math-eq text-red-600 text-xl'>٣</span>. الفرق عن الأساس هو <span class='math-eq'>٣ - ٧ = -٤</span>." }, { text: "<strong>3. نكتب المعادلة النهائية:</strong><br>نضيف الفرق الذي أوجدناه إلى الحد النوني الابتدائي.<br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md text-xl'>أ<sub class='font-bold'>ن</sub> = ٧ن - ٤</span>" } ], customRender: (step) => { const diffs = [document.getElementById('mental-diff-1'), document.getElementById('mental-diff-2')]; const boxes = [document.getElementById('mental-seq-box-1'), document.getElementById('mental-seq-box-2'), document.getElementById('mental-seq-box-3')]; diffs.forEach(d => { d.style.opacity = '0'; d.innerHTML = '&nbsp;'; }); boxes.forEach(b => b.classList.remove('bg-blue-100', 'border-red-500', 'scale-110')); if (step === 1) { diffs.forEach(d => { d.innerHTML = '+٧'; d.style.opacity = '1'; }); } if (step === 2) { boxes[0].classList.add('border-red-500', 'scale-110'); } } });
        createInteractiveSection({ nextBtn: document.getElementById('find-value-next'), backBtn: document.getElementById('find-value-back'), stepCounter: document.getElementById('find-value-counter'), explanationDiv: document.getElementById('find-value-explanation'), totalSteps: 6, stepsContent: [ { text: "نحدد المعطيات ثم نعوض في صيغة الحد النوني." }, { text: "<strong>1. تحديد المعطيات:</strong><br>أ<sub class='font-bold'>١</sub> = ٤، د = ٥، ن = ١٠." }, { text: "<strong>2. كتابة الصيغة:</strong><br><span class='math-eq'>أ<sub class='font-bold'>ن</sub> = أ<sub class='font-bold'>١</sub> + (ن - ١) د</span>" }, { text: "<strong>3. التعويض بالقيم:</strong><br><span class='math-eq'>أ<sub class='font-bold'>١٠</sub> = ٤ + (١٠ - ١) × ٥</span>" }, { text: "<strong>4. تبسيط القوس:</strong><br><span class='math-eq'>أ<sub class='font-bold'>١٠</sub> = ٤ + (٩) × ٥</span>" }, { text: "<strong>5. الضرب:</strong><br><span class='math-eq'>أ<sub class='font-bold'>١٠</sub> = ٤ + ٤٥</span>" }, { text: "<strong>6. الجمع والحل النهائي:</strong><br><span class='math-eq p-2 bg-green-100 rounded-md'>أ<sub class='font-bold'>١٠</sub> = ٤٩</span>" } ] });
        createInteractiveSection({ nextBtn: document.getElementById('find-rank-next'), backBtn: document.getElementById('find-rank-back'), stepCounter: document.getElementById('find-rank-counter'), explanationDiv: document.getElementById('find-rank-explanation'), totalSteps: 6, stepsContent: [ { text: "نحدد المعطيات ثم نعوض في الصيغة ونحل المعادلة." }, { text: "<strong>1. تحديد المعطيات:</strong><br>أ<sub class='font-bold'>ن</sub> = ٣٨، أ<sub class='font-bold'>١</sub> = ٨، د = ٣." }, { text: "<strong>2. كتابة الصيغة:</strong><br><span class='math-eq'>أ<sub class='font-bold'>ن</sub> = أ<sub class='font-bold'>١</sub> + (ن - ١) د</span>" }, { text: "<strong>3. التعويض بالقيم:</strong><br><span class='math-eq'>٣٨ = ٨ + (ن - ١) × ٣</span>" }, { text: "<strong>4. طرح ٨ من الطرفين:</strong><br><span class='math-eq'>٣٠ = (ن - ١) × ٣</span>" }, { text: "<strong>5. قسمة الطرفين على ٣:</strong><br><span class='math-eq'>١٠ = ن - ١</span>" }, { text: "<strong>6. إضافة ١ للطرفين والحل النهائي:</strong><br><span class='math-eq p-2 bg-green-100 rounded-md'>١١ = ن</span>" } ] });

        // --- الكود الخاص بالمنصة ---
        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
    });
    </script>
</body>
</html>

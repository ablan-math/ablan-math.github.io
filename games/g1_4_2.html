<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‡Ù…Ø© ØªØ³Ù„Ù‚ Ù‚Ù…Ø© Ø§Ù„Ø¬Ø¨Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Changa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(to top, #6b7280, #bfdbfe);
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .title-font { font-family: 'Changa', sans-serif; }

        .game-card {
            background: rgba(255, 255, 255, 0.75);
            border: 2px solid #4b5563;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }

        #question-card {
            background: transparent;
            border: none;
            box-shadow: none;
            backdrop-filter: none;
        }
        #question-text {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(75, 85, 99, 0.2);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #1f2937;
            font-weight: 700;
            text-shadow: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #question-card .title-font {
            color: #4b5563;
            text-shadow: 0px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        #quiz-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px;
        }

        #mountain-display-container {
            position: absolute;
            top: 45%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 450px;
            height: auto;
            z-index: 0;
        }
        #question-area-wrapper {
             position: absolute;
             bottom: 5%;
             left: 50%;
             transform: translateX(-50%);
             width: 95%;
             max-width: 450px;
             z-index: 10;
        }
        .mountain-path-part {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 4px;
            stroke-dasharray: 8;
            transition: all 0.6s ease-in-out;
            opacity: 0.8;
        }
        .mountain-path-part.revealed {
            stroke: #f59e0b;
            stroke-width: 5px;
            stroke-dasharray: 0;
            opacity: 1;
            animation: reveal-path 0.5s ease-out;
            filter: drop-shadow(0 0 4px #f59e0b);
        }
        .stage-dot {
            fill: rgba(75, 85, 99, 0.5);
            stroke: #f9fafb;
            stroke-width: 1.5px;
            transition: all 0.5s ease;
        }
        .stage-dot.lit {
            fill: #f59e0b;
            filter: drop-shadow(0 0 5px #f59e0b);
            transform: scale(1.2);
        }
        @keyframes reveal-path {
            from { opacity: 0; transform: scaleX(0); }
            to { opacity: 1; transform: scaleX(1); }
        }

        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        #error-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, transparent 30%, rgba(239, 68, 68, 0.4) 100%);
            z-index: 2000; pointer-events: none; opacity: 0; transition: opacity 0.2s ease-out;
        }
        #error-overlay.active { opacity: 1; animation: screen-shake 0.4s ease-in-out; }

        .option-btn {  
            background-color: rgba(229, 231, 235, 0.8);  
            border: 2px solid #6b7280; color: #374151; transition: all 0.2s ease;
        }
        .option-btn:hover:not(:disabled) {  
            background-color: #4b5563; border-color: #1f2937; color: white;
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .option-btn.correct { background-color: #10b981 !important; border-color: #10b981 !important; color: white !important; }
        .option-btn.incorrect { background-color: #ef4444 !important; border-color: #ef4444 !important; color: white !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .attempt-icon { color: #4b5563; text-shadow: 0 0 5px #d1d5db; transition: all 0.5s ease; font-size: 1.7rem; }
        .attempt-icon.lost { color: #9ca3af; text-shadow: none; transform: scale(0.8); opacity: 0.5; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-card { background: rgba(255, 255, 255, 0.95); color: #1f2937; }
        .fraction-container { display: inline-flex; align-items: center; justify-content: center; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 0.3em; font-size: 1.2em; }
        .numerator { padding: 0 0.4em; border-bottom: 2px solid currentColor; }
        .denominator { padding: 0 0.4em; }

        #finish-game-wrapper, #finish-game-wrapper-failure { display: none; }
        #leaderboard-loader, #leaderboard-loader-failure {
            border: 4px solid #9ca3af; border-top: 4px solid #374151;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #leaderboard-container, #leaderboard-container-failure {
            max-height: 25vh; overflow-y: auto; padding-left: 10px; padding-right: 5px;
        }
        #leaderboard-container::-webkit-scrollbar, #leaderboard-container-failure::-webkit-scrollbar { width: 8px; }
        #leaderboard-container::-webkit-scrollbar-track, #leaderboard-container-failure::-webkit-scrollbar-track { background: rgba(156, 163, 175, 0.2); border-radius: 4px; }
        #leaderboard-container::-webkit-scrollbar-thumb, #leaderboard-container-failure::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 4px; }
        #leaderboard-container::-webkit-scrollbar-thumb:hover, #leaderboard-container-failure::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    </style>
</head>
<body>
    
    <div id="error-overlay"></div>

    <div id="welcome-screen" class="w-full max-w-2xl mx-auto p-4">
        <div class="game-card rounded-lg p-4 md:p-6 text-center">
            <h1 class="text-2xl md:text-4xl font-bold title-font text-gray-800">[ ØªØ³Ù„Ù€Ù€Ù‚ Ù‚Ù…Ù€Ù€Ø© Ø§Ù„Ø¬Ø¨Ù€Ù€Ù„ ]</h1>
            <p id="welcomeMessage" class="text-base md:text-xl mt-3 text-gray-700">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…ØªØ³Ù„Ù‚ Ø§Ù„Ø¬Ø±ÙŠØ¡. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ³Ù„Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø´Ø§Ù‡Ù‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ù…ØªÙ‡ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø­Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø§Ù„ØªÙŠ Ø³ØªÙˆØ§Ø¬Ù‡Ùƒ.</p>
            <p class="text-sm md:text-base mt-2 text-gray-600 font-bold">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø³ØªØ®ØªØ¨Ø± Ù…Ù‡Ø§Ø±ØªÙƒ ÙÙŠ "Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ± ÙÙŠ Ø·Ø±ÙÙŠÙ‡Ø§".</p>
            
            <div class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 rounded-r-lg flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-700 flex-shrink-0"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                <p class="text-sm md:text-base text-yellow-800 font-semibold">Ù†ØµÙŠØ­Ø©: Ø¬Ù‡Ù‘Ø² ÙˆØ±Ù‚Ø© ÙˆÙ‚Ù„Ù…Ù‹Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª!</p>
            </div>

            <button onclick="initializeGame()" class="option-btn text-gray-800 font-bold py-2 px-8 rounded-lg text-xl md:text-2xl mt-6 animate-pulse hover:animate-none">> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ù„Ù‚</button>
            <footer class="mt-6 text-xs text-gray-500">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</footer>
        </div>
    </div>

    <div id="quiz-container" class="w-full flex-col justify-start hidden h-full">
        <header class="text-center mb-1 px-2">
            <h1 class="text-xl md:text-3xl title-font tracking-widest text-gray-800">[ Ø®Ø±ÙŠØ·Ù€Ù€Ø© Ø§Ù„ØªØ³Ù€Ù€Ù„Ù‚ ]</h1>
             <p class="text-sm md:text-base text-gray-600">Ø­Ù„ Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª Ù„Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ Ø§Ù„Ù‚Ù…Ø©</p>
        </header>
        
        <div id="top-stats-container" class="flex justify-between items-center w-full px-4 my-2">
            <div id="attempts-container" class="flex items-center gap-2">
                <span class="title-font text-sm text-gray-600 font-bold">Ù…Ø­Ø§ÙˆÙ„Ø§Øª:</span>
                <div id="power-cells-display" class="flex gap-1"></div>
            </div>
            <div id="timer-container" class="title-font text-lg md:text-xl">Ø§Ù„ÙˆÙ‚Øª: <span id="question-timer">00:00</span></div>
        </div>

        <div id="mountain-display-container">
            <!-- SVG of the mountain to be climbed will be injected here -->
        </div>
        
        <div id="question-area-wrapper">
            <div id="question-card" class="p-3 md:p-6">
                <div class="mb-2 flex flex-col items-center justify-center min-h-[6rem]">
                    <p class="title-font text-xs text-gray-600 mb-1">> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...</p>
                    <div id="question-text" class="text-lg md:text-xl font-bold text-center"></div>
                </div>
                <div id="options-grid" class="grid grid-cols-2 gap-2 mt-4"></div>
            </div>

            <div id="feedback-card" class="game-card rounded-lg p-4 text-center hidden">
                <h2 id="feedback-text" class="text-3xl font-bold mb-3"></h2>
                <button id="solution-button" onclick="showSolution()" class="option-btn text-gray-800 font-bold py-2 px-5 rounded-lg text-base">> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ù„</button>
            </div>
        </div>

        <div id="success-card" class="game-card rounded-lg p-4 text-center hidden">
            <h2 class="text-xl md:text-2xl font-bold text-green-600 mb-1 title-font">[ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù…Ø©! ]</h2>
            <p class="text-lg md:text-xl mb-2">Ù…Ù…ØªØ§Ø²! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!</p>
            <p id="final-password" class="text-3xl md:text-4xl font-bold text-gray-800 mb-4 title-font tracking-widest"></p>
            <div id="final-result-display" class="my-3 text-base"></div>
            <div id="leaderboard-loader" style="display: none;"></div>
            <div id="leaderboard-container"></div>
            <div id="finish-game-wrapper" class="mt-4">
                <button id="finish-game-btn" class="option-btn font-bold py-2 px-6 rounded-lg text-lg bg-blue-600 border-blue-600 text-white hover:bg-blue-700">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</button>
            </div>
        </div>
        <div id="failure-card" class="game-card border-red-500 rounded-lg p-4 text-center hidden">
            <h2 class="text-2xl md:text-3xl font-bold text-red-500 mb-1 title-font">[ ÙØ´Ù„ Ø§Ù„ØªØ³Ù„Ù‚ ]</h2>
            <p class="text-lg md:text-xl mb-4">ÙØ´Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©!</p>
            <div id="final-result-display-failure" class="my-3 text-base"></div>
            <div id="leaderboard-loader-failure" style="display: none;"></div>
            <div id="leaderboard-container-failure"></div>
            <div id="finish-game-wrapper-failure" class="mt-4">
                 <button id="finish-game-btn-failure" class="option-btn font-bold py-2 px-6 rounded-lg text-lg bg-blue-600 border-blue-600 text-white hover:bg-blue-700">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</button>
            </div>
        </div>
    </div>

    <div id="solution-modal" class="modal-overlay hidden">
        <div class="modal-card game-card rounded-lg p-6 text-right w-11/12 max-w-lg relative">
            <button onclick="hideSolution()" class="absolute top-2 left-3 text-3xl text-red-500 hover:text-red-400">&times;</button>
            <div id="solution-content">
                <h3 class="text-lg text-yellow-600 border-b border-yellow-600/50 pb-2 mb-3">Ø§Ù„Ø³Ø¤Ø§Ù„:</h3><p id="solution-q" class="mb-4"></p>
                <h3 class="text-lg text-blue-600 border-b border-blue-600/50 pb-2 mb-3">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©:</h3><div id="solution-eq" class="mb-4 text-center title-font text-2xl"></div>
                <h3 class="text-lg text-green-600 border-b border-green-600/50 pb-2 mb-3">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</h3><div id="solution-steps" class="whitespace-pre-wrap text-center"></div>
            </div>
        </div>
    </div>


    <script>
        // --- GAME LOGIC ---
        const allQuestions = [
            // Bank 1: Ù…Ø³Ø§Ø¦Ù„ Ù‡Ù†Ø¯Ø³ÙŠØ©
            [
                { question: "Ù…Ø³ØªØ·ÙŠÙ„ ÙˆÙ…Ø±Ø¨Ø¹ Ù„Ù‡Ù…Ø§ Ù†ÙØ³ Ø§Ù„Ù…Ø­ÙŠØ·. Ø·ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù¡Ù  Ø³Ù… ÙˆØ¹Ø±Ø¶Ù‡ (Ø³) Ø³Ù…. Ø·ÙˆÙ„ Ø¶Ù„Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ (Ø³+Ù¢) Ø³Ù…. Ù…Ø§ Ù‚ÙŠÙ…Ø© Ø³ØŸ", options: ["Ù¦", "Ù¤", "Ù¨", "Ù¡Ù¢"], answer: "Ù¦", solution: { equation: `Ù¢(Ù¡Ù  + Ø³) = Ù¤(Ø³ + Ù¢)`, steps: `Ù†ÙˆØ²Ø¹: Ù¢Ù  + Ù¢Ø³ = Ù¤Ø³ + Ù¨<br>Ù†Ø·Ø±Ø­ Ù¢Ø³: Ù¢Ù  = Ù¢Ø³ + Ù¨<br>Ù†Ø·Ø±Ø­ Ù¨: Ù¡Ù¢ = Ù¢Ø³<br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù¢: Ø³ = Ù¦` } },
                { question: "Ù…Ø«Ù„Ø« Ù…ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¶Ù„Ø¹ÙŠÙ†ØŒ Ø·ÙˆÙ„ Ø£Ø­Ø¯ Ø§Ù„Ø¶Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ† (Ù¢Ø³ + Ù¥) Ø³Ù… ÙˆØ·ÙˆÙ„ Ø§Ù„Ø¶Ù„Ø¹ Ø§Ù„Ø«Ø§Ù„Ø« (Ø³) Ø³Ù…. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙŠØ·Ù‡ Ù£Ù¥ Ø³Ù…ØŒ ÙÙ…Ø§ Ù‚ÙŠÙ…Ø© Ø³ØŸ", options: ["Ù¥", "Ù§", "Ù¡Ù ", "Ù£"], answer: "Ù¥", solution: { equation: `(Ù¢Ø³ + Ù¥) + (Ù¢Ø³ + Ù¥) + Ø³ = Ù£Ù¥`, steps: `Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯: Ù¥Ø³ + Ù¡Ù  = Ù£Ù¥<br>Ù†Ø·Ø±Ø­ Ù¡Ù : Ù¥Ø³ = Ù¢Ù¥<br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù¥: Ø³ = Ù¥` } },
                { question: "Ù…Ø±Ø¨Ø¹ Ø·ÙˆÙ„ Ø¶Ù„Ø¹Ù‡ (Ù£Ø³ - Ù¡). ÙˆÙ…Ø³ØªØ·ÙŠÙ„ Ø¨Ø¹Ø¯Ø§Ù‡ (Ø³) Ùˆ (Ù¤Ø³). Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙŠØ·Ù‡Ù…Ø§ Ù…ØªØ³Ø§ÙˆÙŠÙ‹Ø§ØŒ ÙÙ…Ø§ Ù‚ÙŠÙ…Ø© Ø³ØŸ", options: ["Ù¢", "Ù£", "Ù¤", "Ù¡"], answer: "Ù¢", solution: { equation: `Ù¤(Ù£Ø³ - Ù¡) = Ù¢(Ø³ + Ù¤Ø³)`, steps: `Ù†ÙˆØ²Ø¹ ÙˆÙ†Ø¨Ø³Ø·: Ù¡Ù¢Ø³ - Ù¤ = Ù¢(Ù¥Ø³)<br>Ù¡Ù¢Ø³ - Ù¤ = Ù¡Ù Ø³<br>Ù†Ø·Ø±Ø­ Ù¡Ù Ø³ ÙˆÙ†Ø¶ÙŠÙ Ù¤: Ù¢Ø³ = Ù¤<br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù¢: Ø³ = Ù¢` } }
            ],
            // Bank 2: Ù…Ø³Ø§Ø¦Ù„ Ø£Ø¹Ø¯Ø§Ø¯ Ù…ØªØªØ§Ù„ÙŠØ© (Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯)
            [
                { question: "Ø¹Ø¯Ø¯Ø§Ù† Ø²ÙˆØ¬ÙŠØ§Ù† Ù…ØªØªØ§Ù„ÙŠØ§Ù†ØŒ ÙŠÙ‚Ù„ Ø£Ø±Ø¨Ø¹Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ØµØºØ±Ù‡Ù…Ø§ Ø¹Ù† Ù…Ø«Ù„ÙŠ Ø£ÙƒØ¨Ø±Ù‡Ù…Ø§ Ø¨Ù…Ù‚Ø¯Ø§Ø± Ù¡Ù¢. ÙÙ…Ø§ Ø§Ù„Ø¹Ø¯Ø¯Ø§Ù†ØŸ", options: ["-Ù¤ Ùˆ -Ù¢", "Ù¤ Ùˆ Ù¦", "Ù¡Ù  Ùˆ Ù¡Ù¢", "-Ù¦ Ùˆ -Ù¤"], answer: "-Ù¤ Ùˆ -Ù¢", solution: { equation: `Ù¢(Ù† + Ù¢) - Ù¤Ù† = Ù¡Ù¢`, steps: `Ù†ÙØ±Ø¶ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù†ØŒ Ù†+Ù¢<br>Ù¢Ù† + Ù¤ - Ù¤Ù† = Ù¡Ù¢<br>Ù†Ø¨Ø³Ø·: -Ù¢Ù† + Ù¤ = Ù¡Ù¢<br>Ù†Ø·Ø±Ø­ Ù¤: -Ù¢Ù† = Ù¨<br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ -Ù¢: Ù† = -Ù¤<br>Ø§Ù„Ø¹Ø¯Ø¯Ø§Ù† Ù‡Ù…Ø§ -Ù¤ Ùˆ -Ù¢` } },
                { question: "Ø«Ù„Ø§Ø«Ø© Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© ÙØ±Ø¯ÙŠØ© Ù…ØªØªØ§Ù„ÙŠØ© Ù…Ø¬Ù…ÙˆØ¹Ù‡Ø§ Ù¥Ù§. ÙÙ…Ø§ Ù‡ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ØŸ", options: ["Ù¡Ù§ØŒ Ù¡Ù©ØŒ Ù¢Ù¡", "Ù¡Ù¥ØŒ Ù¡Ù§ØŒ Ù¡Ù©", "Ù¡Ù©ØŒ Ù¢Ù¡ØŒ Ù¢Ù£", "Ù¡Ù£ØŒ Ù¡Ù¥ØŒ Ù¡Ù§"], answer: "Ù¡Ù§ØŒ Ù¡Ù©ØŒ Ù¢Ù¡", solution: { equation: `Ù† + (Ù† + Ù¢) + (Ù† + Ù¤) = Ù¥Ù§`, steps: `Ù†ÙØ±Ø¶ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù†ØŒ Ù†+Ù¢ØŒ Ù†+Ù¤<br>Ù†Ø¬Ù…Ø¹: Ù£Ù† + Ù¦ = Ù¥Ù§<br>Ù†Ø·Ø±Ø­ Ù¦: Ù£Ù† = Ù¥Ù¡<br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù£: Ù† = Ù¡Ù§<br>Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù‡ÙŠ Ù¡Ù§ØŒ Ù¡Ù©ØŒ Ù¢Ù¡` } },
                { question: "Ø¹Ø¯Ø¯Ø§Ù† Ø²ÙˆØ¬ÙŠØ§Ù† Ù…ØªØªØ§Ù„ÙŠØ§Ù†ØŒ Ù…Ø¬Ù…ÙˆØ¹ Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ØµØºØ±Ù‡Ù…Ø§ ÙˆÙ…Ø«Ù„ÙŠ Ø£ÙƒØ¨Ø±Ù‡Ù…Ø§ ÙŠØ³Ø§ÙˆÙŠ Ù¨Ù¤. ÙÙ…Ø§ Ø§Ù„Ø¹Ø¯Ø¯Ø§Ù†ØŸ", options: ["Ù¡Ù¦ Ùˆ Ù¡Ù¨", "Ù¡Ù¤ Ùˆ Ù¡Ù¦", "Ù¡Ù¨ Ùˆ Ù¢Ù ", "Ù¡Ù¢ Ùˆ Ù¡Ù¤"], answer: "Ù¡Ù¦ Ùˆ Ù¡Ù¨", solution: { equation: `Ù£Ù† + Ù¢(Ù† + Ù¢) = Ù¨Ù¤`, steps: `Ù†ÙØ±Ø¶ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù†ØŒ Ù†+Ù¢<br>Ù£Ù† + Ù¢Ù† + Ù¤ = Ù¨Ù¤<br>Ù†Ø¬Ù…Ø¹: Ù¥Ù† + Ù¤ = Ù¨Ù¤<br>Ù†Ø·Ø±Ø­ Ù¤: Ù¥Ù† = Ù¨Ù <br>Ù†Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù¥: Ù† = Ù¡Ù¦<br>Ø§Ù„Ø¹Ø¯Ø¯Ø§Ù† Ù‡Ù…Ø§ Ù¡Ù¦ Ùˆ Ù¡Ù¨` } }
            ],
            // Bank 3: Ù…Ø³Ø§Ø¦Ù„ Ø£Ø¹Ø¯Ø§Ø¯ Ù…ØªØªØ§Ù„ÙŠØ© (ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©)
            [
                { question: "Ø¹Ø¯Ø¯Ø§Ù† ÙØ±Ø¯ÙŠØ§Ù† Ù…ØªØªØ§Ù„ÙŠØ§Ù†ØŒ ÙŠÙ‚Ù„ Ù…Ø«Ù„ÙŠ Ø£ØµØºØ±Ù‡Ù…Ø§ Ø¹Ù† Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ÙƒØ¨Ø±Ù‡Ù…Ø§ Ø¨Ù…Ù‚Ø¯Ø§Ø± Ù©. Ø£ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø©ØŸ (Ù†: Ø£ØµØºØ± Ø¹Ø¯Ø¯)", options: ["Ù¢Ù† = Ù£(Ù† + Ù¢) - Ù©", "Ù£Ù† = Ù¢(Ù† + Ù¢) + Ù©", "Ù¢Ù† = Ù£Ù† + Ù¢ - Ù©", "Ù¢Ù† = Ù£(Ù† + Ù¢) + Ù©"], answer: "Ù¢Ù† = Ù£(Ù† + Ù¢) - Ù©", solution: { equation: `Ù¢Ù† = Ù£(Ù† + Ù¢) - Ù©`, steps: `Ø§Ù„Ø£ØµØºØ± = Ù†<br>Ø§Ù„Ø£ÙƒØ¨Ø± = Ù† + Ù¢<br>Ù…Ø«Ù„ÙŠ Ø§Ù„Ø£ØµØºØ± = Ù¢Ù†<br>Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø£ÙƒØ¨Ø± = Ù£(Ù†+Ù¢)<br>Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ù¢Ù† = Ù£(Ù† + Ù¢) - Ù©` } },
                { question: "Ø¹Ø¯Ø¯Ø§Ù† Ø²ÙˆØ¬ÙŠØ§Ù† Ù…ØªØªØ§Ù„ÙŠØ§Ù†ØŒ ÙŠÙ‚Ù„ Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ÙƒØ¨Ø±Ù‡Ù…Ø§ Ø¹Ù† Ø³Ø¨Ø¹Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ØµØºØ±Ù‡Ù…Ø§ Ø¨Ù…Ù‚Ø¯Ø§Ø± Ù¤. Ø£ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø©ØŸ (Ù†: Ø£ØµØºØ± Ø¹Ø¯Ø¯)", options: ["Ù¥(Ù† + Ù¢) = Ù§Ù† - Ù¤", "Ù¥(Ù† + Ù¢) = Ù§Ù† + Ù¤", "Ù¥Ù† = Ù§(Ù† + Ù¢) - Ù¤", "Ù§Ù† = Ù¥(Ù† + Ù¢) - Ù¤"], answer: "Ù¥(Ù† + Ù¢) = Ù§Ù† - Ù¤", solution: { equation: `Ù¥(Ù† + Ù¢) = Ù§Ù† - Ù¤`, steps: `Ø§Ù„Ø£ØµØºØ± = Ù†<br>Ø§Ù„Ø£ÙƒØ¨Ø± = Ù† + Ù¢<br>Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø£ÙƒØ¨Ø± = Ù¥(Ù†+Ù¢)<br>Ø³Ø¨Ø¹Ø© Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø£ØµØºØ± = Ù§Ù†<br>Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ù¥(Ù† + Ù¢) = Ù§Ù† - Ù¤` } },
                { question: "Ø¹Ø¯Ø¯Ø§Ù† Ù…ØªØªØ§Ù„ÙŠØ§Ù†ØŒ Ù…Ø¬Ù…ÙˆØ¹ Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ØµØºØ±Ù‡Ù…Ø§ Ù…Ø¹ Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø£ÙƒØ¨Ø±Ù‡Ù…Ø§ ÙŠØ³Ø§ÙˆÙŠ Ù§Ù§. Ø£ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø©ØŸ (Ù†: Ø£ØµØºØ± Ø¹Ø¯Ø¯)", options: ["Ù£Ù† + Ù¥(Ù† + Ù¡) = Ù§Ù§", "Ù¥Ù† + Ù£(Ù† + Ù¡) = Ù§Ù§", "Ù£Ù† + Ù¥Ù† + Ù¡ = Ù§Ù§", "Ù£Ù† + Ù¥(Ù† - Ù¡) = Ù§Ù§"], answer: "Ù£Ù† + Ù¥(Ù† + Ù¡) = Ù§Ù§", solution: { equation: `Ù£Ù† + Ù¥(Ù† + Ù¡) = Ù§Ù§`, steps: `Ø§Ù„Ø£ØµØºØ± = Ù†<br>Ø§Ù„Ø£ÙƒØ¨Ø± = Ù† + Ù¡<br>Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø£ØµØºØ± = Ù£Ù†<br>Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø£ÙƒØ¨Ø± = Ù¥(Ù†+Ù¡)<br>Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ù£Ù† + Ù¥(Ù† + Ù¡) = Ù§Ù§` } }
            ],
             // Bank 4: Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø¹Ù…Ø§Ø±
            [
                { question: "Ø¹Ù…Ø± Ø£Ø­Ù…Ø¯ ÙŠØ²ÙŠØ¯ Ù¦ Ø³Ù†ÙˆØ§Øª Ø¹Ù† Ø¹Ù…Ø± Ø£Ø®ÙŠÙ‡ Ø¹Ù„ÙŠ. Ø¨Ø¹Ø¯ Ù¤ Ø³Ù†ÙˆØ§Øª Ø³ÙŠØµØ¨Ø­ Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ø±ÙŠÙ‡Ù…Ø§ Ù¤Ù  Ø³Ù†Ø©. ÙÙ…Ø§ Ø¹Ù…Ø± ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§ Ø§Ù„Ø¢Ù†ØŸ", options: ["Ø¹Ù„ÙŠ Ù¡Ù£ØŒ Ø£Ø­Ù…Ø¯ Ù¡Ù©", "Ø¹Ù„ÙŠ Ù¡Ù ØŒ Ø£Ø­Ù…Ø¯ Ù¡Ù¦", "Ø¹Ù„ÙŠ Ù¡Ù¥ØŒ Ø£Ø­Ù…Ø¯ Ù¢Ù¡", "Ø¹Ù„ÙŠ Ù¡Ù¤ØŒ Ø£Ø­Ù…Ø¯ Ù¢Ù "], answer: "Ø¹Ù„ÙŠ Ù¡Ù£ØŒ Ø£Ø­Ù…Ø¯ Ù¡Ù©", solution: { equation: `(Ø³ + Ù¤) + (Ø³ + Ù¦ + Ù¤) = Ù¤Ù `, steps: `Ø¹Ù…Ø± Ø¹Ù„ÙŠ = Ø³ØŒ Ø¹Ù…Ø± Ø£Ø­Ù…Ø¯ = Ø³+Ù¦<br>Ø¨Ø¹Ø¯ Ù¤ Ø³Ù†ÙˆØ§Øª: (Ø³+Ù¤) + (Ø³+Ù¡Ù ) = Ù¤Ù <br>Ù¢Ø³ + Ù¡Ù¤ = Ù¤Ù <br>Ù¢Ø³ = Ù¢Ù¦<br>Ø³ = Ù¡Ù£<br>Ø¹Ù„ÙŠ Ù¡Ù£ØŒ Ø£Ø­Ù…Ø¯ Ù¡Ù©` } },
                { question: "Ø¹Ù…Ø± Ø£Ø¨ ÙŠØ³Ø§ÙˆÙŠ Ø«Ù„Ø§Ø«Ø© Ø£Ù…Ø«Ø§Ù„ Ø¹Ù…Ø± Ø§Ø¨Ù†Ù‡. Ù‚Ø¨Ù„ Ù¡Ù  Ø³Ù†ÙˆØ§ØªØŒ ÙƒØ§Ù† Ø¹Ù…Ø± Ø§Ù„Ø£Ø¨ Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø¹Ù…Ø± Ø§Ø¨Ù†Ù‡. ÙÙ…Ø§ Ø¹Ù…Ø± ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§ Ø§Ù„Ø¢Ù†ØŸ", options: ["Ø§Ù„Ø§Ø¨Ù† Ù¢Ù ØŒ Ø§Ù„Ø£Ø¨ Ù¦Ù ", "Ø§Ù„Ø§Ø¨Ù† Ù¡Ù¥ØŒ Ø§Ù„Ø£Ø¨ Ù¤Ù¥", "Ø§Ù„Ø§Ø¨Ù† Ù¡Ù ØŒ Ø§Ù„Ø£Ø¨ Ù£Ù ", "Ø§Ù„Ø§Ø¨Ù† Ù¢Ù¥ØŒ Ø§Ù„Ø£Ø¨ Ù§Ù¥"], answer: "Ø§Ù„Ø§Ø¨Ù† Ù¢Ù ØŒ Ø§Ù„Ø£Ø¨ Ù¦Ù ", solution: { equation: `Ù£Ø³ - Ù¡Ù  = Ù¥(Ø³ - Ù¡Ù )`, steps: `Ø¹Ù…Ø± Ø§Ù„Ø§Ø¨Ù†=Ø³ØŒ Ø§Ù„Ø£Ø¨=Ù£Ø³<br>Ù‚Ø¨Ù„ Ù¡Ù  Ø³Ù†ÙˆØ§Øª: Ù£Ø³-Ù¡Ù  = Ù¥(Ø³-Ù¡Ù )<br>Ù£Ø³ - Ù¡Ù  = Ù¥Ø³ - Ù¥Ù <br>Ù¤Ù  = Ù¢Ø³<br>Ø³ = Ù¢Ù <br>Ø§Ù„Ø§Ø¨Ù† Ù¢Ù ØŒ Ø§Ù„Ø£Ø¨ Ù¦Ù ` } },
                { question: "Ø³Ø§Ø±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø£Ø®ØªÙ‡Ø§ Ù†ÙˆØ±Ø© Ø¨Ù€ Ù¤ Ø³Ù†ÙˆØ§Øª. Ø¨Ø¹Ø¯ Ù¦ Ø³Ù†ÙˆØ§ØªØŒ Ø³ÙŠØµØ¨Ø­ Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ù…Ø±ÙŠÙ‡Ù…Ø§ Ù£Ù¤ Ø³Ù†Ø©. ÙÙ…Ø§ Ø¹Ù…Ø±Ù‡Ù…Ø§ Ø§Ù„Ø¢Ù†ØŸ", options: ["Ù†ÙˆØ±Ø© Ù©ØŒ Ø³Ø§Ø±Ø© Ù¡Ù£", "Ù†ÙˆØ±Ø© Ù¨ØŒ Ø³Ø§Ø±Ø© Ù¡Ù¢", "Ù†ÙˆØ±Ø© Ù¡Ù ØŒ Ø³Ø§Ø±Ø© Ù¡Ù¤", "Ù†ÙˆØ±Ø© Ù§ØŒ Ø³Ø§Ø±Ø© Ù¡Ù¡"], answer: "Ù†ÙˆØ±Ø© Ù©ØŒ Ø³Ø§Ø±Ø© Ù¡Ù£", solution: { equation: `(Ø³ + Ù¦) + (Ø³ + Ù¤ + Ù¦) = Ù£Ù¤`, steps: `Ø¹Ù…Ø± Ù†ÙˆØ±Ø© = Ø³ØŒ Ø³Ø§Ø±Ø© = Ø³+Ù¤<br>Ø¨Ø¹Ø¯ Ù¦ Ø³Ù†ÙˆØ§Øª: (Ø³+Ù¦) + (Ø³+Ù¡Ù ) = Ù£Ù¤<br>Ù¢Ø³ + Ù¡Ù¦ = Ù£Ù¤<br>Ù¢Ø³ = Ù¡Ù¨<br>Ø³ = Ù©<br>Ù†ÙˆØ±Ø© Ù©ØŒ Ø³Ø§Ø±Ø© Ù¡Ù£` } }
            ],
            // Bank 5: Ù…Ø³Ø§Ø¦Ù„ Ù„ÙØ¸ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø©
            [
                { question: "Ø¥Ø°Ø§ Ø£Ø¶ÙŠÙ Ø§Ù„Ø¹Ø¯Ø¯ Ù§ Ø¥Ù„Ù‰ Ø®Ù…Ø³Ø© Ø£Ù…Ø«Ø§Ù„ Ø¹Ø¯Ø¯ Ù…Ø§ØŒ ÙƒØ§Ù† Ø§Ù„Ù†Ø§ØªØ¬ Ù¤Ù¢. ÙÙ…Ø§ Ù‡Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ØŸ", options: ["Ù§", "Ù¥", "Ù©", "Ù¨"], answer: "Ù§", solution: { equation: `Ù¥Ø³ + Ù§ = Ù¤Ù¢`, steps: `Ù†ÙØ±Ø¶ Ø§Ù„Ø¹Ø¯Ø¯ Ø³<br>Ù¥Ø³ + Ù§ = Ù¤Ù¢<br>Ù¥Ø³ = Ù£Ù¥<br>Ø³ = Ù§` } },
                { question: "Ù…Ø¬Ù…ÙˆØ¹ Ø«Ù„Ø§Ø«Ø© Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© Ù…ØªØªØ§Ù„ÙŠØ© Ù‡Ùˆ Ù©Ù¦. Ù…Ø§ Ù‡Ùˆ Ø£ØµØºØ± Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ØŸ", options: ["Ù£Ù¡", "Ù£Ù¢", "Ù£Ù ", "Ù£Ù£"], answer: "Ù£Ù¡", solution: { equation: `Ù† + (Ù† + Ù¡) + (Ù† + Ù¢) = Ù©Ù¦`, steps: `Ù†ÙØ±Ø¶ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù†ØŒ Ù†+Ù¡ØŒ Ù†+Ù¢<br>Ù£Ù† + Ù£ = Ù©Ù¦<br>Ù£Ù† = Ù©Ù£<br>Ù† = Ù£Ù¡` } },
                { question: "Ø§Ø´ØªØ±Ù‰ Ø®Ø§Ù„Ø¯ ÙƒØªØ§Ø¨Ù‹Ø§ ÙˆØ¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø© Ø¨Ù…Ø¨Ù„Øº Ù§Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø«Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ø¶Ø¹Ù Ø«Ù…Ù† Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©ØŒ ÙÙ…Ø§ Ø«Ù…Ù† ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§ØŸ", options: ["Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù¢Ù¥ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¥Ù ", "Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù£Ù ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¤Ù¥", "Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù¢Ù ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¥Ù¥", "Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù£Ù¥ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¤Ù "], answer: "Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù¢Ù¥ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¥Ù ", solution: { equation: `Ø³ + Ù¢Ø³ = Ù§Ù¥`, steps: `Ø«Ù…Ù† Ø§Ù„Ø­Ø§Ø³Ø¨Ø© = Ø³ØŒ Ø§Ù„ÙƒØªØ§Ø¨ = Ù¢Ø³<br>Ø³ + Ù¢Ø³ = Ù§Ù¥<br>Ù£Ø³ = Ù§Ù¥<br>Ø³ = Ù¢Ù¥<br>Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù¢Ù¥ØŒ Ø§Ù„ÙƒØªØ§Ø¨ Ù¥Ù ` } }
            ]
        ];
        const mountainCodename = "Ø§Ù„Ù€Ù‚Ù€Ù…Ù€Ø©";
        const MAX_ATTEMPTS = 3;

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizContainer = document.getElementById('quiz-container');
        const questionCard = document.getElementById('question-card');
        const feedbackCard = document.getElementById('feedback-card');
        const feedbackText = document.getElementById('feedback-text');
        const successCard = document.getElementById('success-card');
        const failureCard = document.getElementById('failure-card');
        const questionText = document.getElementById('question-text');
        const optionsGrid = document.getElementById('options-grid');
        const mountainDisplayContainer = document.getElementById('mountain-display-container');
        const finalPassword = document.getElementById('final-password');
        const powerCellsDisplay = document.getElementById('power-cells-display');
        const solutionModal = document.getElementById('solution-modal');
        const questionTimerDisplay = document.getElementById('question-timer');
        const errorOverlay = document.getElementById('error-overlay');

        let gameQuestionGroups = [], currentQuestionIndex = 0, subQuestionAttempt = 0, mistakesLeft = MAX_ATTEMPTS;
        let totalGameTimeStart, questionTimerInterval, feedbackTimeout;

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        function initializeGame() {
            gameQuestionGroups = allQuestions.map(group => shuffleArray([...group]));
            shuffleArray(gameQuestionGroups);
            
            welcomeScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden'); quizContainer.classList.add('flex');
            currentQuestionIndex = 0; subQuestionAttempt = 0; mistakesLeft = MAX_ATTEMPTS;
            totalGameTimeStart = Date.now();
            if (questionTimerInterval) clearInterval(questionTimerInterval);
            clearTimeout(feedbackTimeout);
            
            successCard.classList.add('hidden'); failureCard.classList.add('hidden');
            feedbackCard.classList.add('hidden'); questionCard.classList.remove('hidden');
            document.getElementById('top-stats-container').classList.remove('hidden');
            document.getElementById('mountain-display-container').classList.remove('hidden');
            document.querySelector('#quiz-container header').classList.remove('hidden');
            document.getElementById('question-area-wrapper').classList.remove('hidden');
            quizContainer.classList.add('justify-start');
            quizContainer.classList.remove('justify-center');
            
            updateAttemptsDisplay();
            setupMountainGraphic();
            document.querySelectorAll('.stage-dot').forEach(dot => dot.classList.remove('lit'));
            showQuestion();
        }

        function setupMountainGraphic() {
            mountainDisplayContainer.innerHTML = `
                <svg viewBox="0 0 400 250" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="mountainGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#6b4629;stop-opacity:1" /> 
                            <stop offset="60%" style="stop-color:#926c47;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M 20 250 L 200 40 L 280 150 L 320 120 L 380 250 Z" fill="url(#mountainGradient)" filter="drop-shadow(3px 5px 2px rgb(0 0 0 / 0.2))" />
                    <g transform="translate(200, 22)">
                        <line x1="0" y1="0" x2="0" y2="18" stroke="#374151" stroke-width="2.5"/>
                        <polygon points="0,0 18,6 0,12" fill="#ef4444"/>
                    </g>
                    <!-- Path Segments -->
                    <g id="part-0" class="mountain-path-part"><path d="M 40 240 C 80 210, 120 220, 150 190" /></g>
                    <g id="part-1" class="mountain-path-part"><path d="M 150 190 C 180 160, 230 170, 260 145" /></g>
                    <g id="part-2" class="mountain-path-part"><path d="M 260 145 C 290 120, 250 110, 240 90" /></g>
                    <g id="part-3" class="mountain-path-part"><path d="M 240 90 C 230 70, 190 80, 200 60" /></g>
                    <g id="part-4" class="mountain-path-part"><path d="M 200 60 C 210 50, 205 45, 200 40" /></g>
                    <!-- Stage Markers -->
                    <g class="stage-markers">
                        <circle id="stage-dot-0" class="stage-dot" cx="100" cy="215" r="5" />
                        <circle id="stage-dot-1" class="stage-dot" cx="205" cy="165" r="5" />
                        <circle id="stage-dot-2" class="stage-dot" cx="250" cy="115" r="5" />
                        <circle id="stage-dot-3" class="stage-dot" cx="215" cy="75" r="5" />
                        <circle id="stage-dot-4" class="stage-dot" cx="200" cy="50" r="5" />
                    </g>
                </svg>
            `;
        }
        
        function updateAttemptsDisplay() {
            powerCellsDisplay.innerHTML = '';
            for(let i = 0; i < MAX_ATTEMPTS; i++) {
                const powerCell = document.createElement('span');  
                powerCell.innerHTML = 'ğŸ§—';
                powerCell.classList.add('attempt-icon');
                if (i >= mistakesLeft) { powerCell.classList.add('lost'); }
                powerCellsDisplay.appendChild(powerCell);
            }
        }

        function showQuestion() {
            if (questionTimerInterval) clearInterval(questionTimerInterval);
            const questionTimeStart = Date.now();
            questionTimerInterval = setInterval(() => {
                const secondsPassed = Math.floor((Date.now() - questionTimeStart) / 1000);
                const minutes = Math.floor(secondsPassed / 60).toString().padStart(2, '0');
                const seconds = (secondsPassed % 60).toString().padStart(2, '0');
                questionTimerDisplay.textContent = `${minutes}:${seconds}`;
            }, 1000);

            optionsGrid.innerHTML = '';  
            const currentQuestion = gameQuestionGroups[currentQuestionIndex][subQuestionAttempt];
            
            questionText.innerHTML = currentQuestion.question;  

            const shuffledOptions = shuffleArray([...currentQuestion.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button'); button.innerHTML = option;
                button.classList.add('option-btn', 'w-full', 'p-2', 'rounded-lg', 'text-lg', 'font-bold');
                button.onclick = () => selectAnswer(button, option);
                optionsGrid.appendChild(button);
            });
        }
        
        function lightUpStageDot(index) {
            const dot = document.getElementById(`stage-dot-${index}`);
            if (dot) {
                dot.classList.add('lit');
            }
        }

        function advanceToNextStep(isCorrect) {
            feedbackCard.classList.add('hidden');
            if (isCorrect) {
                currentQuestionIndex++; subQuestionAttempt = 0;
                if (currentQuestionIndex >= gameQuestionGroups.length) {
                    showEndScreen(true);
                } else {
                    questionCard.classList.remove('hidden'); showQuestion();
                }
            } else {
                if (mistakesLeft <= 0) { showEndScreen(false); return; }
                subQuestionAttempt++;
                if (subQuestionAttempt >= gameQuestionGroups[currentQuestionIndex].length) {
                    showEndScreen(false);
                } else {
                    questionCard.classList.remove('hidden'); showQuestion();
                }
            }
        }
        
        function selectAnswer(button, selectedOption) {
            if (questionTimerInterval) clearInterval(questionTimerInterval);
            optionsGrid.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const currentQuestion = gameQuestionGroups[currentQuestionIndex][subQuestionAttempt];
            const isCorrect = selectedOption === currentQuestion.answer;
            
            questionCard.classList.add('hidden'); feedbackCard.classList.remove('hidden');

            if (isCorrect) {
                feedbackText.textContent = 'Ø£Ø­Ø³Ù†Øª!';
                feedbackText.classList.remove('text-red-500'); feedbackText.classList.add('text-green-500');
                revealMountainPathPart(currentQuestionIndex);
                lightUpStageDot(currentQuestionIndex);
                feedbackTimeout = setTimeout(() => advanceToNextStep(true), 2000);
            } else {
                feedbackText.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!';
                feedbackText.classList.remove('text-green-500'); feedbackText.classList.add('text-red-500');
                mistakesLeft--;
                updateAttemptsDisplay();
                
                errorOverlay.classList.add('active');
                setTimeout(() => { errorOverlay.classList.remove('active'); }, 400);

                feedbackTimeout = setTimeout(() => advanceToNextStep(false), 2000);
            }
        }

        function revealMountainPathPart(index) {
            const part = document.getElementById(`part-${index}`);
            if(part) {  part.classList.add('revealed'); }
        }
        
        function showEndScreen(isSuccess) {
            document.getElementById('top-stats-container').classList.add('hidden');
            document.getElementById('mountain-display-container').classList.add('hidden');
            document.querySelector('#quiz-container header').classList.add('hidden');
            document.getElementById('question-area-wrapper').classList.add('hidden');
            feedbackCard.classList.add('hidden');
            questionCard.classList.add('hidden');
            
            if (questionTimerInterval) clearInterval(questionTimerInterval);
            const totalTimeInSeconds = Math.round((Date.now() - totalGameTimeStart) / 1000);
            
            const baseScore = currentQuestionIndex;
            const penalty = (MAX_ATTEMPTS - mistakesLeft) * 0.5;
            const finalScore = Math.max(0, baseScore - penalty);

            if (isSuccess) {
                successCard.classList.remove('hidden');
                finalPassword.textContent = mountainCodename;
            } else {
                failureCard.classList.remove('hidden');
            }
            
            quizContainer.classList.remove('justify-start');
            quizContainer.classList.add('justify-center');

            if (window.saveAndFinishGame) {
                window.saveAndFinishGame(finalScore, totalTimeInSeconds);
            }
        }

        function showSolution() {
            clearTimeout(feedbackTimeout);
            const currentQuestion = gameQuestionGroups[currentQuestionIndex][subQuestionAttempt];
            document.getElementById('solution-q').innerHTML = currentQuestion.question;
            document.getElementById('solution-eq').innerHTML = currentQuestion.solution.equation;
            document.getElementById('solution-steps').innerHTML = currentQuestion.solution.steps;
            solutionModal.classList.remove('hidden');
        }

        function hideSolution() {
            solutionModal.classList.add('hidden');
            const lastAnswerWasCorrect = feedbackText.textContent === 'Ø£Ø­Ø³Ù†Øª!';
            advanceToNextStep(lastAnswerWasCorrect);
        }

    </script>
    <script>
        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
(function() {
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const GAME_ID = 'g1_4_2'; // New unique ID for the mountain game with new questions
    const GAME_MAX_POINTS = 5;
    const PLATFORM_MAX_GRADE = 5;
    const METRIC_TYPE = 'time';
    const METRIC_LABEL = 'Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ)';

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const classId = urlParams.get('classId');
    const studentName = urlParams.get('studentName');
    let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

    window.saveAndFinishGame = function(points, metricValue) {
        const finalPoints = parseFloat(points) || 0;
        const finalMetric = parseFloat(metricValue) || 0;
        const finalGrade = finalPoints;

        const successCardVisible = !document.getElementById('success-card').classList.contains('hidden');
        const resultDisplayId = successCardVisible ? 'final-result-display' : 'final-result-display-failure';
        const resultDisplay = document.getElementById(resultDisplayId);
        
        if (resultDisplay) {
            resultDisplay.innerHTML = `
                <p class="text-gray-600">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span class="font-bold text-2xl text-gray-800">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                <p class="text-gray-600">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <span class="font-bold text-xl text-gray-800">${finalMetric} Ø«Ø§Ù†ÙŠØ©</span></p>
            `;
        }

        if (studentId && classId) {
            const params = new URLSearchParams({
                action: 'saveGrade', studentId, classId, itemId: GAME_ID,
                grade: finalGrade.toFixed(2), metricValue: Math.round(finalMetric).toString()
            });
            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json()).then(result => console.log('Save result:', result.status))
                .catch(err => console.error("Save Error:", err)).finally(fetchAndShowLeaderboard);
        } else {
            console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
            fetchAndShowLeaderboard();
        }
    }

    function fetchAndShowLeaderboard() {
        const successCardVisible = !document.getElementById('success-card').classList.contains('hidden');
        const loaderId = successCardVisible ? 'leaderboard-loader' : 'leaderboard-loader-failure';
        const containerId = successCardVisible ? 'leaderboard-container' : 'leaderboard-container-failure';
        const loader = document.getElementById(loaderId);
        const container = document.getElementById(containerId);

        if (!loader || !container) return;
        if (!classId) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
            showFinishButton();
            return;
        }

        loader.style.display = 'block'; container.innerHTML = '';
        const params = new URLSearchParams({ action: 'getLeaderboard', gameId: GAME_ID, metricType: METRIC_TYPE, classId: classId });
        fetch(`${SCRIPT_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success' && response.data) {
                    displayLeaderboard(response.data, container);
                } else { throw new Error(response.message || 'Failed to load leaderboard data.'); }
            })
            .catch(err => {
                console.error("Leaderboard Error:", err);
                container.innerHTML = `<p class="text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
            })
            .finally(() => { loader.style.display = 'none'; showFinishButton(); });
    }
    
    function displayLeaderboard(data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
            return;
        }

        let tableHTML = `
            <div class="mt-6 border-t border-gray-400 pt-4">
                <h3 class="text-2xl font-bold text-center text-gray-700 mb-4">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                <table class="min-w-full rounded-lg">
                    <thead style="background-color: rgba(209, 213, 219, 0.4);">
                        <tr>
                            <th class="text-center py-2 px-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                            <th class="text-right py-2 px-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th class="text-center py-2 px-3">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                        </tr>
                    </thead>
                    <tbody>`;

        data.forEach((player, index) => {
            const rank = index + 1;
            let rankDisplay = rank;
            if (rank === 1) rankDisplay = 'ğŸ¥‡'; if (rank === 2) rankDisplay = 'ğŸ¥ˆ'; if (rank === 3) rankDisplay = 'ğŸ¥‰';
            const isCurrentUser = (currentUser && player.name === currentUser.name);
            const rowClass = isCurrentUser ? 'bg-blue-200/50 font-bold' : (index % 2 === 0 ? 'bg-gray-200/50' : 'bg-gray-200/30');
            tableHTML += `<tr class="${rowClass}"><td class="text-center py-2 px-3 text-xl">${rankDisplay}</td><td class="text-right py-2 px-3">${player.name}</td><td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td><td class="text-center py-2 px-3">${player.metricValue}</td></tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    function showFinishButton() {
        const successCardVisible = !document.getElementById('success-card').classList.contains('hidden');
        const wrapperId = successCardVisible ? 'finish-game-wrapper' : 'finish-game-wrapper-failure';
        const finishWrapper = document.getElementById(wrapperId);
        if (finishWrapper) { finishWrapper.style.display = 'block'; }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (studentName && welcomeMessage) {
            welcomeMessage.innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…ØªØ³Ù„Ù‚ Ø§Ù„Ø¬Ø±ÙŠØ¡ <span class="font-bold text-gray-700">${studentName}</span>. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ³Ù„Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø´Ø§Ù‡Ù‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ù…ØªÙ‡ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø­Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø§Ù„ØªÙŠ Ø³ØªÙˆØ§Ø¬Ù‡Ùƒ.`;
        }
        const finishBtns = document.querySelectorAll('#finish-game-btn, #finish-game-btn-failure');
        if (finishBtns) {
            finishBtns.forEach(btn => {
                btn.addEventListener('click', () => { window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*'); });
            });
        }
    });
})();
// --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>

</body>
</html>


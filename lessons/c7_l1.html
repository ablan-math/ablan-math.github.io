<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- SYSTEM COMPLIANCE LOG: GameModal_ThemeColor_Match=YES -->
    <title>Ù§-Ù¡ ØªØ­Ù„ÙŠÙ„ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        const themeColor = {
            gradient: 'from-purple-600 to-purple-800', 
            icon: 'fa-puzzle-piece', 
            text: 'text-purple-600',
            bg: 'bg-purple-50',
            hex: '#9333ea',
            chapterNum: '7' 
        };
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Math Styling */
        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #581c87; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        @media (min-width: 768px) { .math-eq { font-size: 1.1em; padding: 4px 12px; } }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .var-blue { color: #2563eb; } .op-purple { color: #9333ea; font-weight: 800; }
        
        /* Fix for superscripts (Exponents) */
        .tiny-sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.6em; margin-right: 1px; line-height: 0; font-family: 'Cairo', sans-serif; }
        .fix-pos { display: inline-flex; flex-direction: row; align-items: baseline; gap: 1px; direction: rtl; }
        
        /* UI Components */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item span { margin-top: 2px; text-align: center; line-height: 1.1; max-width: 60px; }
        .nav-item.active { color: #9333ea; font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: #9333ea; border-radius: 4px 4px 0 0; }
        @media (min-width: 768px) { .nav-item { font-size: 0.8rem; } .nav-item svg, .nav-item i { font-size: 1.4rem; margin-bottom: 4px; } .nav-item span { max-width: none; } }
        
        /* Interactive & Quiz */
        .step-box { border-right: 3px solid #9333ea; background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } .step-interactive.active { display: block; opacity: 1; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; }
        input[type="radio"]:checked + .option-label { border-color: #9333ea; background-color: #f3e8ff; color: #9333ea; font-weight: bold; box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.2); }
        
        /* Results & Cards */
        .result-card-base { position: relative; overflow: hidden; padding: 1.5rem !important; transition: all 0.3s ease; }
        .result-card-trophy { background-color: #fffbeb; border-color: #fcd34d; } 
        .result-card-star { background-color: #fff7ed; border-color: #fdba74; } 
        .result-card-retry { background-color: #fef2f2; border-color: #fca5a5; } 
        
        /* Game Cards Styling */
        .gold-card { background: linear-gradient(135deg, #fffbeb 0%, #fff 100%); border: 2px solid #fcd34d !important; }
        .orange-card { background: linear-gradient(135deg, #fff7ed 0%, #fff 100%); border: 2px solid #fdba74 !important; }
        .red-card { background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); border: 2px solid #fca5a5 !important; }
        .normal-card { background: white; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Loading */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #9333ea; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Footer Credits */
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 80px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }
        .lesson-footer strong { color: #6b7280; }
        
        /* Vertical Flow Helpers */
        .v-step { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; width: 100%; }
        .v-arrow { color: #9ca3af; margin: 4px 0; font-size: 1.2rem; }
        .v-highlight-circle { border: 2px solid #f59e0b; border-radius: 50%; padding: 2px 6px; display: inline-block; background-color: #fef3c7; }
        
        /* Gallery New Styles (Strip) */
        .strip-container { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 10px 0; }
        .strip-item { font-size: 1.3rem; font-weight: bold; color: #4b5563; opacity: 0.3; transform: scale(0.9); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; padding: 8px 12px; border-radius: 8px; white-space: nowrap; }
        .strip-item:hover { opacity: 0.6; background-color: #f3f4f6; }
        .strip-item.active { opacity: 1; transform: scale(1.15); color: #9333ea; background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; }
        
        /* Mini Tree Styles */
        .mini-tree-container { display: flex; flex-direction: column; align-items: center; padding: 10px; min-height: 220px; }
        .mini-node-root, .mini-node-child { width: 36px; height: 36px; border-radius: 50%; background: white; border: 2px solid #d8b4fe; color: #7e22ce; font-weight: bold; font-size: 0.9rem; display: flex; justify-content: center; align-items: center; z-index: 5; transition: all 0.3s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mini-node-leaf { width: 32px; height: 32px; border-radius: 50%; background: #dcfce7; border: 2px solid #16a34a; color: #166534; font-weight: bold; font-size: 0.9rem; display: flex; justify-content: center; align-items: center; position: relative; z-index: 5; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mini-node-leaf::after { content: 'âœ“'; position: absolute; bottom: -6px; right: -6px; font-size: 10px; color: white; background: #16a34a; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid white; }
        .mini-branch-container { display: flex; justify-content: center; gap: 20px; margin-top: 4px; position: relative; width: 100%; }
        .branch-lines { width: 80%; height: 15px; border-left: 2px solid #cbd5e1; border-right: 2px solid #cbd5e1; border-top: 2px solid #cbd5e1; margin-bottom: -2px; margin-top: 0px; border-radius: 10px 10px 0 0; opacity: 0; transition: opacity 0.5s; }
        .branch-lines.visible { opacity: 1; }
        .tree-step { opacity: 0; transform: translateY(-10px); transition: all 0.5s ease-out; display: none; }
        .tree-step.visible { opacity: 1; transform: translateY(0); display: flex; }
        .method-btn { font-size: 0.75rem; padding: 4px 12px; border-radius: 9999px; border: 1px solid #e9d5ff; background-color: #faf5ff; color: #6b21a8; transition: all 0.2s; }
        .method-btn:hover { background-color: #f3e8ff; border-color: #d8b4fe; }
        .method-btn.selected { background-color: #9333ea; color: white; border-color: #9333ea; box-shadow: 0 2px 5px rgba(147, 51, 234, 0.3); }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Styles for GCF Visual Step */
        .factor-item { display: inline-block; padding: 4px 8px; border-radius: 50%; border: 2px solid transparent; transition: all 0.5s ease; margin: 0 2px; font-weight: bold; }
        .factor-item.active-common { border-color: #f59e0b; background-color: #fef3c7; transform: scale(1.2); color: #d97706; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
        .visual-step-highlight { animation: pulseHighlight 1s infinite alternate; }
        @keyframes pulseHighlight { from { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); } to { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); } }

        /* Enhanced Gallery Nav Buttons */
        .gallery-nav-btn { background: #f3e8ff; color: #9333ea; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s; border: 2px solid #d8b4fe; cursor: pointer; box-shadow: 0 2px 4px rgba(147, 51, 234, 0.1); }
        .gallery-nav-btn:hover:not(:disabled) { background: #9333ea; color: white; border-color: #9333ea; transform: scale(1.1); box-shadow: 0 4px 8px rgba(147, 51, 234, 0.3); }
        .gallery-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; box-shadow: none; }
        
        .explanation-panel { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Game Modal Styles */
        #game-modal { z-index: 9999; transition: opacity 0.3s; }
        #game-frame-container { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-default-size { width: 90%; height: 80%; max-width: 1200px; border-radius: 1rem; position: relative; }
        @media (min-width: 768px) { .modal-default-size { width: 85%; height: 85%; } }
        #game-frame-container.fullscreen { width: 100vw !important; height: 100vh !important; max-width: none !important; border-radius: 0 !important; top: 0; left: 0; margin: 0; }
        #game-frame-container.minimized { position: absolute !important; bottom: 0 !important; left: 10px !important; right: auto !important; top: auto !important; width: 260px !important; height: 48px !important; border-radius: 12px 12px 0 0 !important; box-shadow: 0 -4px 10px rgba(0,0,0,0.2) !important; overflow: hidden !important; transform: none !important; }
        #game-frame-container.minimized iframe { display: none; }
        
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative bg-gradient-to-r from-purple-600 to-purple-800">
        <!-- Math Pattern Background -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden select-none">
            <i id="header-bg-icon" class="fas fa-puzzle-piece absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <span id="chapter-num-bg" class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">7</span>
            <!-- Scattered Math Symbols -->
            <i class="fas fa-cubes absolute top-4 left-1/4 text-xl text-white opacity-10"></i>
            <i class="fas fa-times absolute bottom-8 left-1/3 text-2xl text-white opacity-10"></i>
            <i class="fas fa-equals absolute top-1/3 right-1/4 text-xl text-white opacity-10"></i>
        </div>
        
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas fa-puzzle-piece text-lg md:text-2xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">Ù§-Ù¡</span>
                        <span>ØªØ­Ù„ÙŠÙ„ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> 
                            <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>

            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> <span id="student-name">Ø²Ø§Ø¦Ø±</span>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-purple-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>Ø±Ø¬ÙˆØ¹</span>
                </a>
            </div>
        </div>
    </header>
    
    <script>
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                const name = params.get('name'); 
                if (name) {
                    const nameEl = document.getElementById('student-name');
                    if (nameEl) nameEl.textContent = name;
                }
            } catch(e) {}
        })();
    </script>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- LEARN 1: Analysis/Factoring -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-yellow-100 text-yellow-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-yellow-200 shadow-sm">Ù¡</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù… Ù„ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯</h2>
            </div>
            
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-yellow-400"></div>
                <h3 class="font-bold text-lg text-purple-800 mb-2">Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</h3>
                <p class="text-gray-600 leading-relaxed text-sm md:text-lg mb-4">ØªÙƒÙˆÙ† ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø§Ù„ØªØ§Ù…Ø© Ø¥Ø°Ø§ ÙƒÙØªØ¨Øª Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ <strong>Ø£Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠØ©</strong> ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø¨Ø£Ø³ <strong>ÙˆØ§Ø­Ø¯</strong>.</p>
                <div class="bg-purple-50 text-purple-800 text-xs md:text-sm p-3 rounded-lg border border-purple-100 flex gap-2 items-center">
                    <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                    <span><strong>Ù…Ø«Ø§Ù„:</strong> <span class="math-eq">-Ù¢Ù  Ø³<sup class="tiny-sup">Ù£</sup></span> = -Ù¡ Ã— Ù¢ Ã— Ù¢ Ã— Ù¥ Ã— Ø³ Ã— Ø³ Ã— Ø³</span>
                </div>
            </div>

            <!-- App 1: Factoring Gallery -->
            <div id="gallery-container-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-green-50 mb-6 group-container">
                <div class="flex items-center justify-between mb-4 pb-2 border-b border-green-100">
                    <h3 class="font-bold text-green-800 text-sm md:text-lg flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i> ØªØ·Ø¨ÙŠÙ‚ Ù¡: Ù‡Ù„ Ù‡ÙŠ Ù…Ø­Ù„Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ØŸ</h3>
                    <div class="flex gap-2">
                        <button class="gallery-nav-btn prev-btn" disabled><i class="fas fa-chevron-right"></i></button>
                        <span class="text-xs font-bold text-gray-400 flex items-center counter">Ù¡ / Ù¥</span>
                        <button class="gallery-nav-btn next-btn"><i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>
                <div class="strip-container">
                    <div class="strip-item active" data-index="0"><span class="math-eq">Ù¢ Ã— Ø³ Ã— Øµ</span></div>
                    <div class="strip-item" data-index="1"><span class="math-eq">Ù¤ Ã— Ø³</span></div>
                    <div class="strip-item" data-index="2"><span class="math-eq">Ù£ Ã— Ø³<sup class="tiny-sup">Ù¢</sup></span></div>
                    <div class="strip-item" data-index="3"><span class="math-eq">-Ù¡ Ã— Ù§ Ã— Ù„</span></div>
                    <div class="strip-item" data-index="4"><span class="math-eq">Ù¡Ù£ Ø³ Øµ</span></div>
                </div>
                <div class="explanation-area min-h-[100px]"></div>
            </div>

            <!-- NEW: Tree Interactive App (App 2: Step-by-Step & Multi-Method) -->
            <div id="tree-app-container" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6">
                <!-- ... existing app 2 content ... -->
                <div class="flex items-center justify-between mb-4 border-b border-purple-100 pb-2">
                    <h3 class="font-bold text-purple-800 text-sm md:text-lg flex items-center gap-2">
                        <i class="fas fa-project-diagram"></i> ØªØ·Ø¨ÙŠÙ‚ Ù¢: Ø·Ø±Ù‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø¬Ø±ÙŠ
                    </h3>
                    <button onclick="resetAllTrees()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg text-gray-600 transition flex items-center gap-1"><i class="fas fa-redo text-[10px]"></i> ØªØµÙÙŠØ±</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    
                    <!-- Number 24 Container -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 relative overflow-hidden" id="container-24">
                        <!-- ... content for 24 ... -->
                        <div class="flex justify-between items-center mb-3">
                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-md">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù¢Ù¤</span>
                            <div class="flex gap-2" id="methods-24">
                                <button onclick="selectMethod(24, 'A')" class="method-btn" id="btn-24-A">Ø·Ø±ÙŠÙ‚Ø© Ù¡</button>
                                <button onclick="selectMethod(24, 'B')" class="method-btn" id="btn-24-B">Ø·Ø±ÙŠÙ‚Ø© Ù¢</button>
                            </div>
                        </div>
                        <div class="mini-tree-container bg-white rounded-lg border border-gray-100 shadow-inner relative">
                            <div id="placeholder-24" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
                            <div id="tree-24-A" class="hidden w-full flex-col items-center">
                                <div class="mini-node-root">Ù¢Ù¤</div>
                                <div class="branch-lines tree-step step-1"></div>
                                <div class="mini-branch-container tree-step step-1">
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù¤</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù¢</div></div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù¦</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù£</div></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tree-24-B" class="hidden w-full flex-col items-center">
                                <div class="mini-node-root">Ù¢Ù¤</div>
                                <div class="branch-lines tree-step step-1"></div>
                                <div class="mini-branch-container tree-step step-1">
                                    <div class="flex flex-col items-center"><div class="mini-node-leaf">Ù£</div></div>
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù¨</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1">
                                            <div class="mini-node-leaf">Ù¢</div>
                                            <div class="flex flex-col items-center">
                                                <div class="mini-node-child">Ù¤</div>
                                                <div class="branch-lines tree-step step-3" style="width:50%"></div>
                                                <div class="mini-branch-container tree-step step-3 gap-1"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù¢</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between items-center h-8">
                            <span id="status-24" class="text-xs font-bold text-gray-500">...</span>
                            <button id="next-24" onclick="nextStep(24)" class="hidden bg-purple-600 text-white text-xs px-4 py-1.5 rounded-lg shadow hover:bg-purple-700 transition animate-bounce">Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© <i class="fas fa-chevron-down mr-1"></i></button>
                            <div id="final-24" class="hidden text-xs font-bold text-green-700 bg-green-100 px-3 py-1.5 rounded-lg border border-green-200">Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ù£</div>
                        </div>
                    </div>

                    <!-- Number 81 Container -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 relative overflow-hidden" id="container-81">
                        <!-- ... content for 81 ... -->
                        <div class="flex justify-between items-center mb-3">
                            <span class="bg-pink-100 text-pink-800 text-xs font-bold px-2 py-1 rounded-md">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù¨Ù¡</span>
                            <div class="flex gap-2" id="methods-81">
                                <button onclick="selectMethod(81, 'A')" class="method-btn" id="btn-81-A">Ø·Ø±ÙŠÙ‚Ø© Ù¡</button>
                                <button onclick="selectMethod(81, 'B')" class="method-btn" id="btn-81-B">Ø·Ø±ÙŠÙ‚Ø© Ù¢</button>
                            </div>
                        </div>
                        <div class="mini-tree-container bg-white rounded-lg border border-gray-100 shadow-inner relative">
                            <div id="placeholder-81" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
                            <div id="tree-81-A" class="hidden w-full flex-col items-center">
                                <div class="mini-node-root">Ù¨Ù¡</div>
                                <div class="branch-lines tree-step step-1"></div>
                                <div class="mini-branch-container tree-step step-1">
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù©</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1"><div class="mini-node-leaf">Ù£</div><div class="mini-node-leaf">Ù£</div></div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù©</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1"><div class="mini-node-leaf">Ù£</div><div class="mini-node-leaf">Ù£</div></div>
                                    </div>
                                </div>
                            </div>
                            <div id="tree-81-B" class="hidden w-full flex-col items-center">
                                <div class="mini-node-root">Ù¨Ù¡</div>
                                <div class="branch-lines tree-step step-1"></div>
                                <div class="mini-branch-container tree-step step-1">
                                    <div class="flex flex-col items-center"><div class="mini-node-leaf">Ù£</div></div>
                                    <div class="flex flex-col items-center">
                                        <div class="mini-node-child">Ù¢Ù§</div>
                                        <div class="branch-lines tree-step step-2" style="width:50%"></div>
                                        <div class="mini-branch-container tree-step step-2 gap-1">
                                            <div class="mini-node-leaf">Ù£</div>
                                            <div class="flex flex-col items-center">
                                                <div class="mini-node-child">Ù©</div>
                                                <div class="branch-lines tree-step step-3" style="width:50%"></div>
                                                <div class="mini-branch-container tree-step step-3 gap-1"><div class="mini-node-leaf">Ù£</div><div class="mini-node-leaf">Ù£</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between items-center h-8">
                            <span id="status-81" class="text-xs font-bold text-gray-500">...</span>
                            <button id="next-81" onclick="nextStep(81)" class="hidden bg-purple-600 text-white text-xs px-4 py-1.5 rounded-lg shadow hover:bg-purple-700 transition animate-bounce">Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© <i class="fas fa-chevron-down mr-1"></i></button>
                            <div id="final-81" class="hidden text-xs font-bold text-green-700 bg-green-100 px-3 py-1.5 rounded-lg border border-green-200">Ù£ Ã— Ù£ Ã— Ù£ Ã— Ù£</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                
                <!-- App 3 (Formerly Ex4): Simple Factoring (32 x^2 y^3) - RIGHT SIDE -->
                <div id="ex4-container" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-indigo-50 mb-6"> 
                    <div class="flex items-center justify-between mb-2"><h3 class="font-bold text-indigo-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù£: ØªØ­Ù„ÙŠÙ„ Ù£Ù¢</h3><span class="text-[10px] md:text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-bold">ØªÙ…Ù‡ÙŠØ¯</span></div>
                    
                    <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                        <div class="text-center mb-4 pb-2 border-b border-gray-200">
                            <p class="font-bold text-gray-700">Ø§Ù„Ø³Ø¤Ø§Ù„: Ø­Ù„Ù„ ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ØªØ§Ù…Ø§Ù‹:</p>
                            <p class="text-xl md:text-2xl font-bold text-blue-700 mt-2 dir-ltr"><span class="math-eq">Ù£Ù¢ Ø³<sup class="tiny-sup">Ù¢</sup> Øµ<sup class="tiny-sup">Ù£</sup></span></p>
                        </div>

                        <div id="ex4-placeholder" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„" Ù„Ù„Ø¨Ø¯Ø¡</div>
                        
                        <!-- Step 1: Tree for 32 -->
                        <div id="ex4-step-1" class="hidden step-box">
                            <h4 class="font-bold text-xs md:text-sm text-indigo-600 mb-1 text-center">Ø®Ø·ÙˆØ© Ù¡: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù£Ù¢ Ø´Ø¬Ø±ÙŠØ§Ù‹</h4>
                            <div class="mini-tree-container" style="min-height: 220px;">
                                <div class="mini-node-root">Ù£Ù¢</div>
                                <div id="ex4-branches" class="hidden w-full flex-col items-center">
                                    <div class="branch-lines tree-step step-1 visible" style="width:50%; opacity:1"></div>
                                    <div class="mini-branch-container tree-step step-1 visible">
                                        <div class="flex flex-col items-center">
                                            <div class="mini-node-child">Ù¤</div>
                                            <div class="branch-lines tree-step step-2 visible" style="width:50%; opacity:1"></div>
                                            <div class="mini-branch-container tree-step step-2 gap-1 visible"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù¢</div></div>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="mini-node-child">Ù¨</div>
                                            <div class="branch-lines tree-step step-2 visible" style="width:50%; opacity:1"></div>
                                            <div class="mini-branch-container tree-step step-2 gap-1 visible">
                                                <div class="mini-node-leaf">Ù¢</div>
                                                <div class="flex flex-col items-center">
                                                    <div class="mini-node-child">Ù¤</div>
                                                    <div class="branch-lines tree-step step-3 visible" style="width:50%; opacity:1"></div>
                                                    <div class="mini-branch-container tree-step step-3 gap-1 visible"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù¢</div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p id="ex4-prime-msg" class="hidden text-xs text-center text-gray-500 mt-2">Ù£Ù¢ = Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ù¢</p>
                        </div>

                        <!-- Step 2: Final Result -->
                        <div id="ex4-step-2" class="hidden step-box border-green-500 bg-green-50">
                            <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù…</h4>
                            <div class="text-center py-4">
                                <p class="text-sm md:text-lg font-bold leading-loose dir-rtl">
                                    <span class="text-red-600 bg-red-50 px-1 rounded border border-red-100">Ù¢Ã—Ù¢Ã—Ù¢Ã—Ù¢Ã—Ù¢</span> Ã— 
                                    <span class="text-green-600 bg-green-100 px-1 rounded border border-green-200">Ø³ Ã— Ø³</span> Ã— 
                                    <span class="text-blue-600 bg-blue-50 px-1 rounded border border-blue-100">Øµ Ã— Øµ Ã— Øµ</span>
                                </p>
                            </div>
                            <div class="mt-3 bg-white p-2 rounded border border-green-200 text-xs text-center text-green-700 font-bold">
                                Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ù¢ Ã— Ø³ Ã— Ø³ Ã— Øµ Ã— Øµ Ã— Øµ
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <button id="ex4-reset-btn" onclick="ex4Reset()" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                        <div class="flex-grow"></div>
                        <button id="ex4-next-btn" onclick="ex4Next()" class="hidden px-6 py-1.5 bg-indigo-600 text-white rounded-lg font-bold shadow-md hover:bg-indigo-700">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        <button id="ex4-analyze-btn" onclick="ex4Analyze()" class="px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 animate-bounce">ØªØ­Ù„ÙŠÙ„</button>
                    </div>
                </div>

                <!-- App 4 (Formerly App 3): Interactive Factoring 62 - LEFT SIDE -->
                <div id="app3-container" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6"> 
                    <div class="flex items-center justify-between mb-2"><h3 class="font-bold text-purple-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¤: ØªØ­Ù„ÙŠÙ„ Ù¦Ù¢</h3><span class="text-[10px] md:text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-bold">Ø®Ø·ÙˆØ§Øª</span></div>
                    <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                        <div class="text-center mb-4 pb-2 border-b border-gray-200">
                            <p class="font-bold text-gray-700">Ø§Ù„Ø³Ø¤Ø§Ù„: Ø­Ù„Ù„ ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ØªØ§Ù…Ø§Ù‹:</p>
                            <p class="text-xl md:text-2xl font-bold text-blue-700 mt-2 dir-ltr"><span class="math-eq">Ù¦Ù¢ Ø³<sup class="tiny-sup">Ù¤</sup> Øµ<sup class="tiny-sup">Ù£</sup></span></p>
                        </div>
                        <div id="app3-placeholder" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„" Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø­Ù„</div>
                        <div id="app3-step-1" class="hidden step-box">
                            <h4 class="font-bold text-xs md:text-sm text-purple-600 mb-1 text-center">Ø®Ø·ÙˆØ© Ù¡: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù¦Ù¢ Ø´Ø¬Ø±ÙŠØ§Ù‹</h4>
                            <div class="mini-tree-container">
                                <div class="mini-node-root">Ù¦Ù¢</div>
                                <div id="app3-branches" class="hidden w-full flex-col items-center">
                                    <div class="branch-lines visible" style="width:50%; opacity:1"></div>
                                    <div class="mini-branch-container" style="gap:24px"><div class="mini-node-leaf">Ù¢</div><div class="mini-node-leaf">Ù£Ù¡</div></div>
                                </div>
                            </div>
                            <p id="app3-prime-msg" class="hidden text-xs text-center text-gray-500 mt-2">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ <span class="text-red-600 font-bold">Ù¢</span> Ùˆ <span class="text-red-600 font-bold">Ù£Ù¡</span> Ù‡ÙŠ Ø£Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„ÙŠØ©.</p>
                        </div>
                        <div id="app3-step-2" class="hidden step-box border-green-500 bg-green-50">
                            <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù…</h4>
                            <div class="text-center py-4">
                                <p class="text-sm md:text-lg font-bold leading-loose dir-rtl">
                                    <span class="text-red-600 bg-red-50 px-1 rounded border border-red-100">Ù¢ Ã— Ù£Ù¡</span> Ã— 
                                    <span class="text-green-600 bg-green-100 px-1 rounded border border-green-200">Ø³ Ã— Ø³ Ã— Ø³ Ã— Ø³</span> Ã— 
                                    <span class="text-blue-600 bg-blue-50 px-1 rounded border border-blue-100">Øµ Ã— Øµ Ã— Øµ</span>
                                </p>
                            </div>
                            <div class="mt-3 bg-white p-2 rounded border border-green-200 text-xs text-center text-green-700 font-bold">
                                Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ù¢ Ã— Ù£Ù¡ Ã— Ø³ Ã— Ø³ Ã— Ø³ Ã— Ø³ Ã— Øµ Ã— Øµ Ã— Øµ
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <button id="app3-reset-btn" onclick="app3Reset()" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                        <div class="flex-grow"></div>
                        <button id="app3-next-btn" onclick="app3Next()" class="hidden px-6 py-1.5 bg-purple-600 text-white rounded-lg font-bold shadow-md hover:bg-purple-700">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        <button id="app3-analyze-btn" onclick="app3Analyze()" class="px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 animate-bounce">ØªØ­Ù„ÙŠÙ„</button>
                    </div>
                </div>
            </div>
            
            <button onclick="switchTab('learn2')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2 mt-4 mb-4"><span>Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù‚Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ÙƒØ¨Ø± (Ù‚.Ù….Ø£)</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- LEARN 2: GCF (Ù‚.Ù….Ø£) -->
        <div id="tab-learn2" class="tab-content hidden">
            <!-- ... GCF content ... -->
            <div class="flex items-center gap-2 mb-4"><span class="bg-purple-100 text-purple-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-purple-200 shadow-sm">Ù¢</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø§Ù„Ù‚Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ÙƒØ¨Ø± (Ù‚.Ù….Ø£)</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden"><div class="absolute top-0 right-0 w-1 h-full bg-purple-500"></div><p class="text-gray-600 text-sm md:text-lg mb-3">Ù‡Ùˆ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ ÙŠÙƒÙˆÙ† Ù‚Ø§Ø³Ù…Ø§Ù‹ Ù„ÙƒÙ„ ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯ØŒ ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† Ø¶Ø±Ø¨ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©.</p></div>
            <div id="gcf-app1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6"> 
                <div class="flex items-center justify-between mb-2"><h3 class="font-bold text-purple-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¢-Ù¡: Ø£ÙˆØ¬Ø¯ Ù‚.Ù….Ø£ Ù„Ù„Ø­Ø¯ÙŠÙ† <span class="math-eq">Ù¡Ù¢Ø£<sup class="tiny-sup">Ù¢</sup> Ø¨<sup class="tiny-sup">Ù¢</sup></span> ØŒ <span class="math-eq">Ù¡Ù¨Ø£ Ø¨<sup class="tiny-sup">Ù£</sup></span></h3></div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div id="gcf-placeholder-app1" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„Ø¨Ø¯Ø¡</div>
                    <div id="gcf-steps-wrapper-app1">
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-1-app1"><h4 class="font-bold text-xs text-purple-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆÙ„:</h4><p class="text-sm md:text-base text-center leading-loose">Ù¡Ù¢Ø£<sup class="tiny-sup">Ù¢</sup>Ø¨<sup class="tiny-sup">Ù¢</sup> = <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="3">Ù£</span> Ã— <span class="factor-item t1-a" data-val="a">Ø£</span> Ã— <span class="factor-item t1-a" data-val="a">Ø£</span> Ã— <span class="factor-item t1-b" data-val="b">Ø¨</span> Ã— <span class="factor-item t1-b" data-val="b">Ø¨</span></p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-2-app1"><h4 class="font-bold text-xs text-purple-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ:</h4><p class="text-sm md:text-base text-center leading-loose">Ù¡Ù¨Ø£Ø¨<sup class="tiny-sup">Ù£</sup> = <span class="factor-item t2-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-a" data-val="a">Ø£</span> Ã— <span class="factor-item t2-b" data-val="b">Ø¨</span> Ã— <span class="factor-item t2-b" data-val="b">Ø¨</span> Ã— <span class="factor-item t2-b" data-val="b">Ø¨</span></p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-3-msg-app1"><p class="text-xs font-bold text-yellow-700">ğŸ” Ù„Ø§Ø­Ø¸ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø§Ù„Ù…Ø­Ø§Ø·Ø© Ø¨Ø¯ÙˆØ§Ø¦Ø±)</p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-purple-50 rounded border border-purple-200" id="gcf-step-4-app1"><h4 class="font-bold text-xs text-purple-600 mb-1">Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</h4><p class="text-sm text-center font-bold">Ù¢ Ã— Ù£ Ã— Ø£ Ã— Ø¨ Ã— Ø¨</p></div>
                        <div class="step-gcf hidden p-2 bg-green-50 rounded border border-green-500" id="gcf-step-5-app1"><h4 class="font-bold text-xs text-green-600 mb-1">Ù‚.Ù….Ø£ Ù‡Ùˆ:</h4><p class="text-lg text-center font-bold text-green-700"><span class="math-eq">Ù¦Ø£ Ø¨<sup class="tiny-sup">Ù¢</sup></span></p></div>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button id="gcf-reset-btn-app1" onclick="gcfReset('app1')" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                    <div class="flex-grow"></div>
                    <button id="gcf-next-btn-app1" onclick="gcfNext('app1')" class="px-6 py-1.5 bg-purple-600 text-white rounded-lg font-bold shadow-md hover:bg-purple-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button id="gcf-highlight-btn-app1" onclick="gcfHighlight('app1')" class="hidden px-6 py-1.5 bg-yellow-500 text-white rounded-lg font-bold shadow-md hover:bg-yellow-600 transition animate-pulse">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</button>
                </div>
            </div>
            <div id="gcf-app2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6"> 
                <div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¢-Ù¢: Ø£ÙˆØ¬Ø¯ Ù‚.Ù….Ø£ Ù„Ù„Ø­Ø¯ÙˆØ¯ <span class="math-eq">Ù¦Ø³<sup class="tiny-sup">Ù¢</sup>Øµ</span> ØŒ <span class="math-eq">Ù¡Ù¥Ø³ Øµ<sup class="tiny-sup">Ù¢</sup></span> ØŒ <span class="math-eq">Ù©Ø³ Øµ</span></h3></div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div id="gcf-placeholder-app2" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„Ø¨Ø¯Ø¡</div>
                    <div id="gcf-steps-wrapper-app2">
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-1-app2"><h4 class="font-bold text-xs text-blue-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆÙ„:</h4><p class="text-sm md:text-base text-center leading-loose">Ù¦Ø³<sup class="tiny-sup">Ù¢</sup>Øµ = <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="3">Ù£</span> Ã— <span class="factor-item t1-x" data-val="x">Ø³</span> Ã— <span class="factor-item t1-x" data-val="x">Ø³</span> Ã— <span class="factor-item t1-y" data-val="y">Øµ</span></p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-2-app2"><h4 class="font-bold text-xs text-blue-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ:</h4><p class="text-sm md:text-base text-center leading-loose">Ù¡Ù¥Ø³ Øµ<sup class="tiny-sup">Ù¢</sup> = <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-n" data-val="5">Ù¥</span> Ã— <span class="factor-item t2-x" data-val="x">Ø³</span> Ã— <span class="factor-item t2-y" data-val="y">Øµ</span> Ã— <span class="factor-item t2-y" data-val="y">Øµ</span></p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-3-app2"><h4 class="font-bold text-xs text-blue-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«:</h4><p class="text-sm md:text-base text-center leading-loose">Ù©Ø³ Øµ = <span class="factor-item t3-n" data-val="3">Ù£</span> Ã— <span class="factor-item t3-n" data-val="3">Ù£</span> Ã— <span class="factor-item t3-x" data-val="x">Ø³</span> Ã— <span class="factor-item t3-y" data-val="y">Øµ</span></p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-4-msg-app2"><p class="text-xs font-bold text-yellow-700">ğŸ” Ù„Ø§Ø­Ø¸ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø§Ù„Ù…Ø­Ø§Ø·Ø© Ø¨Ø¯ÙˆØ§Ø¦Ø±)</p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-blue-50 rounded border border-blue-200" id="gcf-step-5-app2"><h4 class="font-bold text-xs text-blue-600 mb-1">Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</h4><p class="text-sm text-center font-bold">Ù£ Ã— Ø³ Ã— Øµ</p></div>
                        <div class="step-gcf hidden p-2 bg-green-50 rounded border border-green-500" id="gcf-step-6-app2"><h4 class="font-bold text-xs text-green-600 mb-1">Ù‚.Ù….Ø£ Ù‡Ùˆ:</h4><p class="text-lg text-center font-bold text-green-700"><span class="math-eq">Ù£Ø³ Øµ</span></p></div>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button id="gcf-reset-btn-app2" onclick="gcfReset('app2')" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                    <div class="flex-grow"></div>
                    <button id="gcf-next-btn-app2" onclick="gcfNext('app2')" class="px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button id="gcf-highlight-btn-app2" onclick="gcfHighlight('app2')" class="hidden px-6 py-1.5 bg-yellow-500 text-white rounded-lg font-bold shadow-md hover:bg-yellow-600 transition animate-pulse">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</button>
                </div>
            </div>
            <button onclick="switchTab('learn3')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2 mt-4 mb-4"><span>Ø§Ù„ØªØ§Ù„ÙŠ: Ø£Ù…Ø«Ù„Ø© Ù…Ù† ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- LEARN 3: Real Life Application -->
        <div id="tab-learn3" class="tab-content hidden">
            <!-- ... Real life content ... -->
            <div class="flex items-center gap-2 mb-4"><span class="bg-green-100 text-green-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-green-200 shadow-sm">Ù£</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">Ù…Ù† ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©</h2></div>
            <div id="gcf-real2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-orange-50 mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-start mb-4 border-b border-orange-100 pb-3">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-xl flex-shrink-0"><i class="fas fa-gift"></i></div>
                    <div><h3 class="font-bold text-lg mb-1">ØªØ·Ø¨ÙŠÙ‚ Ù£-Ù¡: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</h3><p class="text-sm text-gray-600 leading-relaxed">ÙŠØ±ÙŠØ¯ Ù…ØªØ¬Ø± ØªÙˆØ²ÙŠØ¹ <strong>Ù£Ù </strong> Ù‚Ø·Ø¹Ø© Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© Ùˆ <strong>Ù¤Ù¥</strong> Ù‚Ø·Ø¹Ø© Ø­Ù„ÙˆÙ‰ ÙÙŠ Ø£ÙƒÙŠØ§Ø³ Ù‡Ø¯Ø§ÙŠØ§ Ù…ØªÙ…Ø§Ø«Ù„Ø© Ø¨Ø­ÙŠØ« ØªØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„Ø£ÙƒÙŠØ§Ø³ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† ÙƒÙ„ Ù†ÙˆØ¹. Ù…Ø§ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£ÙƒÙŠØ§Ø³ ÙŠÙ…ÙƒÙ† ØªØ¬Ù‡ÙŠØ²Ù‡ØŸ</p></div>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div id="gcf-placeholder-real2" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>
                    <div id="gcf-steps-wrapper-real2">
                         <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-1-real2"><p class="text-xs font-bold text-yellow-700 mb-1">ğŸ’¡ Ø§Ù„ÙÙƒØ±Ø©:</p><p class="text-xs text-yellow-800">Ù†ÙˆØ¬Ø¯ Ù‚.Ù….Ø£ Ù„Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù£Ù  Ùˆ Ù¤Ù¥ Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙŠØ§Ø³.</p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-2-real2"><h4 class="font-bold text-xs text-orange-600 mb-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:</h4><p class="text-sm text-center leading-loose">Ù£Ù  = <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="3">Ù£</span> Ã— <span class="factor-item t1-n" data-val="5">Ù¥</span></p><p class="text-sm text-center leading-loose">Ù¤Ù¥ = <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-n" data-val="5">Ù¥</span></p></div>
                         <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-3-msg-real2"><p class="text-xs font-bold text-yellow-700">ğŸ” Ù„Ø§Ø­Ø¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</p></div>
                        <div class="step-gcf hidden p-2 bg-orange-50 rounded border border-orange-500" id="gcf-step-4-real2"><h4 class="font-bold text-xs text-orange-600 mb-1">Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ø£ÙƒÙŠØ§Ø³ (Ù‚.Ù….Ø£):</h4><p class="text-lg text-center font-bold text-orange-700"><span class="math-eq">Ù¡Ù¥ ÙƒÙŠØ³</span></p><div class="mt-3 bg-white p-2 rounded border border-orange-100 text-xs text-gray-600"><p class="font-bold mb-1">ğŸ¬ Ù…Ø­ØªÙˆÙŠØ§Øª ÙƒÙ„ ÙƒÙŠØ³:</p><p class="mb-1">Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©: Ù£Ù  Ã· Ù¡Ù¥ = <strong>Ù¢ Ù‚Ø·Ø¹Ø©</strong>.</p><p>Ø­Ù„ÙˆÙ‰: Ù¤Ù¥ Ã· Ù¡Ù¥ = <strong>Ù£ Ù‚Ø·Ø¹</strong>.</p></div></div>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button id="gcf-reset-btn-real2" onclick="gcfReset('real2')" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                    <div class="flex-grow"></div>
                    <button id="gcf-next-btn-real2" onclick="gcfNext('real2')" class="px-6 py-1.5 bg-orange-500 text-white rounded-lg font-bold shadow-md hover:bg-orange-600 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button id="gcf-highlight-btn-real2" onclick="gcfHighlight('real2')" class="hidden px-6 py-1.5 bg-yellow-500 text-white rounded-lg font-bold shadow-md hover:bg-yellow-600 transition animate-pulse">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</button>
                </div>
            </div>
            <div id="gcf-real1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-green-50 mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-start mb-4 border-b border-green-100 pb-3">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl flex-shrink-0"><i class="fas fa-seedling"></i></div>
                    <div><h3 class="font-bold text-lg mb-1">ØªØ·Ø¨ÙŠÙ‚ Ù£-Ù¢: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø¯Ø§Ø¦Ù‚</h3><p class="text-sm text-gray-600 leading-relaxed">Ù„Ø¯Ù‰ Ù…Ø²Ø§Ø±Ø¹ Ø­ÙˆØ¶ÙŠÙ† Ù„Ù„Ø²Ø±Ø§Ø¹Ø©ØŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø£ÙˆÙ„ <strong>Ù¢Ù¤</strong> Ù…ØªØ± Ù…Ø±Ø¨Ø¹ ÙˆÙ…Ø³Ø§Ø­Ø© Ø§Ù„Ø«Ø§Ù†ÙŠ <strong>Ù£Ù¦</strong> Ù…ØªØ± Ù…Ø±Ø¨Ø¹. ÙŠØ±ÙŠØ¯ ØªÙ‚Ø³ÙŠÙ…Ù‡Ù…Ø§ Ø¥Ù„Ù‰ Ø´Ø±Ø§Ø¦Ø­ Ø¹Ø±Ø¶ÙŠØ© Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨Ø£ÙƒØ¨Ø± Ø¹Ø±Ø¶ Ù…Ù…ÙƒÙ†. Ø£ÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶.</p></div>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div id="gcf-placeholder-real1" class="text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ù„Ø¨Ø¯Ø¡</div>
                    <div id="gcf-steps-wrapper-real1">
                        <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-1-real1"><p class="text-xs font-bold text-yellow-700 mb-1"><i class="fas fa-lightbulb"></i> Ø§Ù„ÙÙƒØ±Ø©:</p><p class="text-xs text-yellow-800">Ù†Ø¨Ø­Ø« Ø¹Ù† "Ø£ÙƒØ¨Ø±" Ù‚Ø§Ø³Ù… "Ù…Ø´ØªØ±Ùƒ" Ù„Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù¢Ù¤ Ùˆ Ù£Ù¦.</p></div>
                        <div class="step-gcf hidden mb-3 p-2 bg-white rounded border border-gray-200" id="gcf-step-2-real1"><h4 class="font-bold text-xs text-green-600 mb-1">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª:</h4><p class="text-sm text-center leading-loose">Ù¢Ù¤ = <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t1-n" data-val="3">Ù£</span></p><p class="text-sm text-center leading-loose">Ù£Ù¦ = <span class="factor-item t2-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t2-n" data-val="2">Ù¢</span> Ã— <span class="factor-item t2-n" data-val="3">Ù£</span> Ã— <span class="factor-item t2-n" data-val="3">Ù£</span></p></div>
                         <div class="step-gcf hidden mb-3 p-2 bg-yellow-50 rounded border border-yellow-200 text-center" id="gcf-step-3-msg-real1"><p class="text-xs font-bold text-yellow-700">ğŸ” Ù„Ø§Ø­Ø¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</p></div>
                        <div class="step-gcf hidden p-2 bg-green-50 rounded border border-green-500" id="gcf-step-5-real1"><h4 class="font-bold text-xs text-green-600 mb-1">Ø£ÙƒØ¨Ø± Ø¹Ø±Ø¶ Ù…Ø´ØªØ±Ùƒ (Ù‚.Ù….Ø£):</h4><p class="text-lg text-center font-bold text-green-700"><span class="math-eq">Ù¡Ù¢ Ù…ØªØ±</span></p><div class="mt-3 bg-white p-2 rounded border border-green-100 text-xs text-gray-600"><p class="font-bold mb-1">ğŸ’¡ Ø§Ù„ØªÙØ³ÙŠØ±:</p><p class="mb-1">Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø£ÙˆÙ„ (Ù¢Ù¤Ù…Â²): ÙŠÙ‚Ø³Ù… Ø¥Ù„Ù‰ <strong>Ù¢</strong> Ø´Ø±ÙŠØ­Ø© (Ù¢Ù¤ Ã· Ù¡Ù¢).</p><p>Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù£Ù¦Ù…Â²): ÙŠÙ‚Ø³Ù… Ø¥Ù„Ù‰ <strong>Ù£</strong> Ø´Ø±Ø§Ø¦Ø­ (Ù£Ù¦ Ã· Ù¡Ù¢).</p></div></div>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button id="gcf-reset-btn-real1" onclick="gcfReset('real1')" class="hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fas fa-redo text-xs"></i></button>
                    <div class="flex-grow"></div>
                    <button id="gcf-next-btn-real1" onclick="gcfNext('real1')" class="px-6 py-1.5 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button id="gcf-highlight-btn-real1" onclick="gcfHighlight('real1')" class="hidden px-6 py-1.5 bg-yellow-500 text-white rounded-lg font-bold shadow-md hover:bg-yellow-600 transition animate-pulse">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</button>
                </div>
            </div>
            <div class="mt-4 text-center mb-8"><button onclick="switchTab('quiz')" class="bg-purple-600 text-white px-8 py-3 md:py-4 rounded-full text-sm md:text-lg font-bold shadow-lg hover:bg-purple-700 transition flex items-center justify-center gap-2 mx-auto w-full max-w-xs animate-bounce"><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</span><i data-lucide="arrow-left"></i></button></div>
        </div>

        <div id="tab-quiz" class="tab-content hidden">
             <!-- ... quiz content ... -->
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…</h2><p class="text-xs md:text-sm text-gray-500">Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ùˆ Ù‚.Ù….Ø£</p></div>
                    <div class="text-center"><div id="loading-attempts" class="hidden"><div class="loader w-4 h-4"></div></div><div id="attempts-display" class="flex flex-col items-center"><span class="block text-xl md:text-2xl font-bold text-purple-600" id="attempts-count">-</span><div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span></div><span id="sync-status" class="w-2 h-2 rounded-full bg-gray-300 mt-1" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„"></span></div><div id="timer-top-container" class="hidden mt-1"><span class="block text-xs font-bold text-red-500 font-mono" id="timer-display-top">00:00:00</span></div></div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto">
                    <div class="result-content">
                        <p class="text-sm text-gray-600 font-bold mb-1">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p>
                        <p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p>
                        <div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div>
                        <div class="mt-4"><div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block"><span class="block text-lg font-bold text-red-600 font-mono tracking-wider" id="timer-display-bottom">00:00:00</span></div></div>
                    </div>
                </div>
                
                <!-- GAMES SECTION -->
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"></div>
                </div>
            </div>
        </div>
        
        <footer class="lesson-footer"><p>ØªØµÙ…ÙŠÙ… ÙˆØ¥Ø¹Ø¯Ø§Ø¯: <strong>Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</strong></p><p class="mt-1 opacity-70">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</p></footer>
        <div class="h-20"></div>
    </main>

    <!-- ... existing nav and modals ... -->
    <nav class="bottom-nav" id="bottom-nav-container"></nav>
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 transform transition-transform duration-300 shadow-2xl"><div class="flex justify-between mb-4 items-center"><div class="flex items-center gap-2" style="color: var(--theme-hex)"><i id="modal-icon" data-lucide="info" class="w-5 h-5"></i><h3 id="modal-title" class="font-bold text-lg">ØªÙˆØ¶ÙŠØ­</h3></div><button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div></div></div>

    <!-- Game Modal Structure -->
    <div id="game-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div id="game-frame-container" class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col relative modal-default-size border border-gray-600">
            <!-- Game Header -->
            <div class="text-white p-3 flex justify-between items-center shadow-md select-none h-12 shrink-0" style="background-color: var(--theme-hex)">
                <div class="flex items-center gap-2">
                    <i class="fas fa-gamepad text-yellow-400"></i>
                    <span id="game-modal-title" class="font-bold text-sm md:text-base truncate max-w-[200px]">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleMinimize()" class="hover:bg-gray-700 p-1.5 rounded text-gray-300 hover:text-white transition" title="ØªØµØºÙŠØ± (Minimize)">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button onclick="toggleMaximize()" class="hover:bg-gray-700 p-1.5 rounded text-gray-300 hover:text-white transition" title="ØªÙƒØ¨ÙŠØ±/Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Toggle Fullscreen)">
                        <i id="max-icon" class="fas fa-expand"></i>
                    </button>
                    <button onclick="closeGameModal()" class="hover:bg-red-600 p-1.5 rounded text-red-300 hover:text-white transition bg-red-900/20 ml-2" title="Ø¥ØºÙ„Ø§Ù‚">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Iframe -->
            <iframe id="game-iframe" src="" class="w-full h-full bg-gray-100 border-none"></iframe>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        const LESSON_KEY = 'c7_l1'; 
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let timerInterval;

        const tabs = [
            { id: 'learn1', icon: 'search', label: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„' },
            { id: 'learn2', icon: 'puzzle', label: 'Ù‚.Ù….Ø£' },
            { id: 'learn3', icon: 'sun', label: 'Ø§Ù„Ø­ÙŠØ§Ø©' },
            { id: 'quiz', icon: 'clipboard-check', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' }
        ];

        const galleryData1 = [
            { content: '<span class="math-eq">Ù¢ Ã— Ø³ Ã— Øµ</span>', analysis: 'Ø§Ù„Ø¹Ø¯Ø¯ Ù¢ Ø£ÙˆÙ„ÙŠØŒ ÙˆØ§Ù„Ø£Ø³Ø³ Ù¡. ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­Ù„Ù„.', result: 'Ù†Ø¹Ù…ØŒ Ù…Ø­Ù„Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹' },
            { content: '<span class="math-eq">Ù¤ Ã— Ø³</span>', analysis: 'Ø§Ù„Ø¹Ø¯Ø¯ Ù¤ Ù„ÙŠØ³ Ø£ÙˆÙ„ÙŠØ§Ù‹ (ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„Ù‡ Ù„Ù€ Ù¢Ã—Ù¢).', result: 'Ù„Ø§ØŒ Ù„ÙŠØ³Øª Ù…Ø­Ù„Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹' },
            { content: '<span class="math-eq">Ù£ Ã— Ø³<sup class="tiny-sup">Ù¢</sup></span>', analysis: 'Ø§Ù„Ø£Ø³ Ù¢ ÙŠØ¹Ù†ÙŠ Ø³ Ù…ÙƒØ±Ø±Ø© (Ø³ Ã— Ø³)ØŒ Ù„Ø°Ø§ Ù„Ù… ØªØ­Ù„Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.', result: 'Ù„Ø§ØŒ Ù„ÙŠØ³Øª Ù…Ø­Ù„Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹' },
            { content: '<span class="math-eq">-Ù¡ Ã— Ù§ Ã— Ù„</span>', analysis: 'Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ù„Ø¨Ø© ØªØ¹Ø§Ù…Ù„ ÙƒÙ€ -Ù¡ØŒ ÙˆØ§Ù„Ù€ Ù§ Ø£ÙˆÙ„ÙŠØŒ ÙˆØ§Ù„Ø£Ø³ Ù¡.', result: 'Ù†Ø¹Ù…ØŒ Ù…Ø­Ù„Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹' },
            { content: '<span class="math-eq">Ù¡Ù£ Ø³ Øµ</span>', analysis: 'Ø§Ù„Ø¹Ø¯Ø¯ Ù¡Ù£ Ø£ÙˆÙ„ÙŠ (Ù„Ø§ ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¥Ù„Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡ ÙˆØ§Ù„ÙˆØ§Ø­Ø¯)ØŒ ÙˆØ§Ù„Ø£Ø³Ø³ Ù¡. Ø¥Ø°Ù† Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø£ÙƒØ«Ø±.', result: 'Ù†Ø¹Ù…ØŒ Ù…Ø­Ù„Ù„Ø© (ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯ Ø£ÙˆÙ„ÙŠØ©)' }
        ];

        // UPDATED QUESTION BANK WITH VERTICAL & HIGHLIGHTED EXPLANATIONS
        const questionBank = [
             { 
                 id: 101, type: 'learn1', t: 'Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ù¢Ù  ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ØªØ§Ù…Ø§Ù‹:', 
                 o: [{t:'<span class="math-eq">Ù¢ Ã— Ù¡Ù </span>', v:'a'}, {t:'<span class="math-eq">Ù¤ Ã— Ù¥</span>', v:'b'}, {t:'<span class="math-eq">Ù¢ Ã— Ù¢ Ã— Ù¥</span>', v:'c'}, {t:'<span class="math-eq">Ù¡ Ã— Ù¢Ù </span>', v:'d'}], c:'c', 
                 e:'<div class="v-step text-sm"><span class="math-eq bg-white">Ù¢Ù </span><i class="fas fa-arrow-down v-arrow"></i><span class="math-eq bg-white">Ù¤ Ã— Ù¥</span><i class="fas fa-arrow-down v-arrow"></i><span class="math-eq bg-green-50 text-green-700 font-bold border border-green-200 p-1">Ù¢ Ã— Ù¢ Ã— Ù¥</span><p class="text-[10px] text-gray-500 mt-1">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ <span class="text-red-500 font-bold">Ø£ÙˆÙ„ÙŠØ©</span>.</p></div>', 
                 smart:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø£Ø¹Ø¯Ø§Ø¯Ø§Ù‹ Ø£ÙˆÙ„ÙŠØ© ÙÙ‚Ø·.' 
             },
             { 
                 id: 102, type: 'learn1', t: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù… Ù„Ù€ <span class="math-eq">Ù¡Ù¢ Ø³<sup class="tiny-sup">Ù¢</sup></span> Ù‡Ùˆ:', 
                 o: [{t:'<span class="math-eq">Ù£ Ã— Ù¤ Ã— Ø³ Ã— Ø³</span>', v:'a'}, {t:'<span class="math-eq">Ù¢ Ã— Ù¢ Ã— Ù£ Ã— Ø³ Ã— Ø³</span>', v:'b'}, {t:'<span class="math-eq">Ù¢ Ã— Ù¦ Ã— Ø³ Ã— Ø³</span>', v:'c'}, {t:'<span class="math-eq">Ù¡Ù¢ Ã— Ø³ Ã— Ø³</span>', v:'d'}], c:'b', 
                 e:'<div class="v-step text-sm"><div class="flex gap-4 items-start"><div class="v-step"><span class="text-xs font-bold text-blue-600">Ù¡Ù¢</span><i class="fas fa-arrow-down v-arrow"></i><span class="math-eq p-1 border border-blue-100 bg-blue-50">Ù¢Ã—Ù¢Ã—Ù£</span></div><div class="v-step"><span class="text-xs font-bold text-purple-600">Ø³Â²</span><i class="fas fa-arrow-down v-arrow"></i><span class="math-eq p-1 border border-purple-100 bg-purple-50">Ø³Ã—Ø³</span></div></div><div class="mt-2 text-center text-xs bg-gray-50 p-1 rounded">Ø§Ù„Ù†Ø§ØªØ¬: Ù¢Ã—Ù¢Ã—Ù£Ã—Ø³Ã—Ø³</div></div>', 
                 smart:'Ù¡Ù¢ â† Ù¢ØŒ Ù¢ØŒ Ù£. Ø³Â² â† Ø³ØŒ Ø³.' 
             },
             { 
                 id: 103, type: 'learn1', t: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù… Ù„Ù€ <span class="math-eq">-Ù¡Ù¤ Ø³<sup class="tiny-sup">Ù£</sup></span> Ù‡Ùˆ:', 
                 o: [{t:'<span class="math-eq">-Ù¡ Ã— Ù¢ Ã— Ù§ Ã— Ø³ Ã— Ø³ Ã— Ø³</span>', v:'a'}, {t:'<span class="math-eq">-Ù¡ Ã— Ù¡Ù¤ Ã— Ø³ Ã— Ø³ Ã— Ø³</span>', v:'b'}, {t:'<span class="math-eq">Ù¢ Ã— Ù§ Ã— Ø³ Ã— Ø³ Ã— Ø³</span>', v:'c'}, {t:'<span class="math-eq">-Ù¡Ù¤ Ã— Ø³<sup class="tiny-sup">Ù£</sup></span>', v:'d'}], c:'a', 
                 e:'<div class="v-step text-sm"><div class="bg-gray-50 p-2 rounded mb-1 text-center w-full"><span class="text-red-600 font-bold">-</span> ØªØ¹Ù†ÙŠ <span class="math-eq bg-white">-Ù¡</span></div><div class="bg-gray-50 p-2 rounded mb-1 text-center w-full">Ù¡Ù¤ = <span class="math-eq bg-white">Ù¢Ã—Ù§</span></div><div class="bg-gray-50 p-2 rounded text-center w-full">Ø³Â³ = <span class="math-eq bg-white">Ø³Ã—Ø³Ã—Ø³</span></div></div>', 
                 smart:'Ø§Ø¨Ø­Ø« Ø¹Ù† -Ù¡ ÙˆØ§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ù¢ Ùˆ Ù§).' 
             },
             { 
                 id: 201, type: 'learn2', t: 'Ø£ÙˆØ¬Ø¯ Ù‚.Ù….Ø£ Ù„Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù¡Ù¢ Ùˆ Ù¢Ù :', 
                 o: [{t:'Ù¢', v:'a'}, {t:'Ù¤', v:'b'}, {t:'Ù¦', v:'c'}, {t:'Ù¡Ù ', v:'d'}], c:'b', 
                 e:'<div class="v-step text-sm w-full"><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¡Ù¢ = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—Ù£</div><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¢Ù  = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—Ù¥</div><div class="text-center mt-2"><span class="text-xs text-gray-500">Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</span><br><span class="math-eq bg-green-50 border-green-300 text-green-800 font-bold p-1">Ù¢ Ã— Ù¢ = Ù¤</span></div></div>', 
                 smart:'Ø£ÙƒØ¨Ø± Ø±Ù‚Ù… ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø§Ø«Ù†Ø§Ù† Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„ÙŠÙ‡.' 
             },
             { 
                 id: 202, type: 'learn2', t: 'Ù‚.Ù….Ø£ Ù„Ù„Ø­Ø¯ÙŠÙ† <span class="math-eq">Ù£Ø³<sup class="tiny-sup">Ù¢</sup></span> Ùˆ <span class="math-eq">Ù©Ø³</span> Ù‡Ùˆ:', 
                 o: [{t:'<span class="math-eq">Ù£Ø³</span>', v:'a'}, {t:'<span class="math-eq">Ù£Ø³<sup class="tiny-sup">Ù¢</sup></span>', v:'b'}, {t:'<span class="math-eq">Ù©Ø³</span>', v:'c'}, {t:'<span class="math-eq">Ø³</span>', v:'d'}], c:'a', 
                 e:'<div class="v-step text-sm w-full"><div class="flex justify-between w-full mb-2"><div class="text-center w-1/2 bg-gray-50 p-1 rounded mx-1">Ù£Ø³Â²<br><span class="v-highlight-circle text-sm">Ù£</span> Ã— <span class="v-highlight-circle text-sm">Ø³</span> Ã— Ø³</div><div class="text-center w-1/2 bg-gray-50 p-1 rounded mx-1">Ù©Ø³<br>Ù£Ã—<span class="v-highlight-circle text-sm">Ù£</span> Ã— <span class="v-highlight-circle text-sm">Ø³</span></div></div><div class="math-eq bg-green-50 border-green-300 text-green-800 font-bold p-1">Ù£ Ã— Ø³ = Ù£Ø³</div></div>', 
                 smart:'Ø®Ø° Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ± ÙˆØ§Ù„Ø£Ø³ Ø§Ù„Ø£ØµØºØ±.' 
             },
             { 
                 id: 203, type: 'learn2', t: 'Ù‚.Ù….Ø£ Ù„Ù„Ø­Ø¯ÙˆØ¯ <span class="math-eq">Ù¤Ø£ Ø¨</span> ØŒ <span class="math-eq">Ù¢Ø£</span> ØŒ <span class="math-eq">Ù¨Ø¨</span>', 
                 o: [{t:'<span class="math-eq">Ù¢Ø£</span>', v:'a'}, {t:'<span class="math-eq">Ù¢</span>', v:'b'}, {t:'<span class="math-eq">Ù¢Ø¨</span>', v:'c'}, {t:'<span class="math-eq">Ù¤</span>', v:'d'}], c:'b', 
                 e:'<div class="v-step text-sm w-full"><div class="bg-red-50 p-2 rounded mb-2 w-full text-center border border-red-100"><p class="font-bold text-red-600 mb-1">Ù‡Ù„ Ø§Ù„Ø­Ø±Ù Ù…ÙƒØ±Ø± ÙÙŠ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ</p><p class="text-xs">Ø§Ù„Ø£ÙˆÙ„ (Ø£ Ø¨)ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø£)ØŒ Ø§Ù„Ø«Ø§Ù„Ø« (Ø¨)</p><p class="font-bold text-red-700">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±Ù Ù…Ø´ØªØ±Ùƒ!</p></div><div class="bg-green-50 p-2 rounded w-full text-center border border-green-100"><p class="font-bold text-green-600 mb-1">Ø§Ù„Ø£Ø±Ù‚Ø§Ù…:</p><p class="text-xs">Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ù¤ØŒ Ù¢ØŒ Ù¨ Ù‡Ùˆ <span class="math-eq">Ù¢</span></p></div></div>', 
                 smart:'Ø§Ù„Ø­Ø±Ù Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠÙ‡Ù… ÙƒÙ„Ù‡Ù….' 
             },
             { 
                 id: 301, type: 'learn3', t: 'Ø£Ø±Ø§Ø¯ Ù†Ø¬Ø§Ø± Ù‚Øµ Ù„ÙˆØ­ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø´Ø¨ Ø·ÙˆÙ„Ù‡Ù…Ø§ Ù¢Ù¤ Ø³Ù… Ùˆ Ù£Ù¦ Ø³Ù… Ø¥Ù„Ù‰ Ù‚Ø·Ø¹ Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨Ø£ÙƒØ¨Ø± Ø·ÙˆÙ„ Ù…Ù…ÙƒÙ†. Ù…Ø§ Ù‡Ùˆ Ù‡Ø°Ø§ Ø§Ù„Ø·ÙˆÙ„ØŸ', 
                 o: [{t:'Ù¦ Ø³Ù…', v:'a'}, {t:'Ù¨ Ø³Ù…', v:'b'}, {t:'Ù¡Ù¢ Ø³Ù…', v:'c'}, {t:'Ù¤ Ø³Ù…', v:'d'}], c:'c', 
                 e:'<div class="v-step text-sm w-full"><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¢Ù¤ = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—Ù¢Ã—<span class="v-highlight-circle text-blue-600">Ù£</span></div><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù£Ù¦ = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù£</span>Ã—Ù£</div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800 p-1">Ù¢ Ã— Ù¢ Ã— Ù£ = Ù¡Ù¢</div></div>', 
                 smart:'Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ ÙŠÙ‚Ø³Ù… Ù¢Ù¤ Ùˆ Ù£Ù¦ Ù…Ø¹Ø§Ù‹.' 
             },
             { 
                 id: 302, type: 'learn3', t: 'Ù…Ø¹ Ù…Ø²Ø§Ø±Ø¹ Ù¡Ù¢ ØªÙØ§Ø­Ø© Ùˆ Ù¡Ù¨ Ø¨Ø±ØªÙ‚Ø§Ù„Ø©. ÙŠØ±ÙŠØ¯ ØªÙˆØ²ÙŠØ¹Ù‡Ø§ ÙÙŠ Ø£Ø·Ø¨Ø§Ù‚ Ù…ØªÙ…Ø§Ø«Ù„Ø©. Ù…Ø§ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø·Ø¨Ø§Ù‚ ÙŠÙ…ÙƒÙ† ØªÙƒÙˆÙŠÙ†Ù‡ØŸ', 
                 o: [{t:'Ù£', v:'a'}, {t:'Ù¦', v:'b'}, {t:'Ù©', v:'c'}, {t:'Ù¢', v:'d'}], c:'b', 
                 e:'<div class="v-step text-sm w-full"><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¡Ù¢ = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—Ù¢Ã—<span class="v-highlight-circle text-blue-600">Ù£</span></div><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¡Ù¨ = <span class="v-highlight-circle text-blue-600">Ù¢</span>Ã—<span class="v-highlight-circle text-blue-600">Ù£</span>Ã—Ù£</div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800 p-1">Ù¢ Ã— Ù£ = Ù¦</div></div>', 
                 smart:'Ù¡Ù¢ Ùˆ Ù¡Ù¨ ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù¦.' 
             },
             { 
                 id: 303, type: 'learn3', t: 'ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ Ø¨Ù‡ Ù¡Ù¥ Ø·Ø§Ù„Ø¨Ø§Ù‹ Ùˆ Ù¢Ù  Ø·Ø§Ù„Ø¨Ø©. ÙŠØ±Ø§Ø¯ ØªÙ‚Ø³ÙŠÙ…Ù‡Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ³Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø¬Ù†Ø³ÙŠÙ†. Ù…Ø§ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŸ', 
                 o: [{t:'Ù¥', v:'a'}, {t:'Ù¡Ù ', v:'b'}, {t:'Ù£', v:'c'}, {t:'Ù¤', v:'d'}], c:'a', 
                 e:'<div class="v-step text-sm w-full"><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¡Ù¥ = Ù£Ã—<span class="v-highlight-circle text-blue-600">Ù¥</span></div><div class="bg-white border border-gray-200 p-2 rounded mb-1 w-full text-center">Ù¢Ù  = Ù¢Ã—Ù¢Ã—<span class="v-highlight-circle text-blue-600">Ù¥</span></div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800 p-1">Ù¥</div></div>', 
                 smart:'Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø±Ø¨ Ù‡Ùˆ Ù¥.' 
             },
             {
                 id: 401, type: 'challenge1', t: 'Ø§ÙƒØªØ´Ù Ø§Ù„Ø®Ø·Ø£: Ø­Ù„Ù„ Ø·Ø§Ù„Ø¨ <span class="math-eq">Ù¡Ù¨Ø³</span> Ø¹Ù„Ù‰ Ø£Ù†Ù‡Ø§ <span class="math-eq">Ù© Ã— Ù¢ Ã— Ø³</span>. Ù…Ø§ Ø§Ù„Ø®Ø·Ø£ØŸ', 
                 o: [{t:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø£', v:'a'}, {t:'Ù© Ø¹Ø¯Ø¯ ØºÙŠØ± Ø£ÙˆÙ„ÙŠ', v:'b'}, {t:'Ù¢ Ø¹Ø¯Ø¯ ØºÙŠØ± Ø£ÙˆÙ„ÙŠ', v:'c'}, {t:'Ù†Ø³ÙŠ ØªØ­Ù„ÙŠÙ„ Ø³', v:'d'}], c: 'b', 
                 e: '<div class="v-step text-sm"><span class="math-eq bg-red-50 text-red-600">Ù©</span><i class="fas fa-arrow-down v-arrow"></i><span class="text-xs">Ù„ÙŠØ³Øª Ø£ÙˆÙ„ÙŠØ©</span><i class="fas fa-arrow-down v-arrow"></i><span class="math-eq bg-green-50 text-green-600">Ù£ Ã— Ù£</span></div>', 
                 smart: 'Ù‡Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£ÙˆÙ„ÙŠØ©ØŸ Ù© Ù„ÙŠØ³Øª ÙƒØ°Ù„Ùƒ.'
             },
             {
                 id: 402, type: 'challenge1', t: 'Ø£ÙˆØ¬Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯: <span class="math-eq">Ù¡Ù Ø³<sup class="tiny-sup">Ù¢</sup></span> = Ù¢ Ã— Ø³ Ã— ...', 
                 o: [{t:'Ù¥', v:'a'}, {t:'Ù¥Ø³', v:'b'}, {t:'Ù¡Ù ', v:'c'}, {t:'Ø³', v:'d'}], c: 'b', 
                 e: '<div class="v-step text-sm"><div class="dir-ltr text-center">10xÂ² Ã· 2x</div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800">5x</div></div>', 
                 smart: 'Ù…Ø§Ø°Ø§ ØªØ¶Ø±Ø¨ ÙÙŠ Ù¢Ø³ Ù„ÙŠØ¹Ø·ÙŠÙƒ Ù¡Ù Ø³Â²ØŸ'
             },
             {
                 id: 403, type: 'challenge1', t: 'Ø£ÙŠ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØµØ­ÙŠØ­Ø©ØŸ', 
                 o: [{t:'Ù‚.Ù….Ø£ Ù„Ù€ Ø³Â² Ùˆ Ø³Â³ Ù‡Ùˆ Ø³Â³', v:'a'}, {t:'Ù‚.Ù….Ø£ Ù„Ù€ Ø³Â² Ùˆ Ø³Â³ Ù‡Ùˆ Ø³Â²', v:'b'}, {t:'Ù‚.Ù….Ø£ Ù„Ù€ Ø³Â² Ùˆ Ø³Â³ Ù‡Ùˆ Ø³', v:'c'}, {t:'Ù‚.Ù….Ø£ Ù„Ù€ Ø³Â² Ùˆ Ø³Â³ Ù‡Ùˆ Ù¡', v:'d'}], c: 'b', 
                 e: '<div class="v-step text-sm"><p>Ù‚Ø§Ø¹Ø¯Ø©:</p><div class="bg-gray-50 p-2 rounded">Ù†Ø£Ø®Ø° Ø§Ù„Ù…ØªØºÙŠØ± Ø°Ùˆ Ø§Ù„Ø£Ø³ <span class="text-red-600 font-bold">Ø§Ù„Ø£ØµØºØ±</span></div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800">Ø³Â²</div></div>', 
                 smart: 'Ø§Ù„Ø£Ø³ Ø§Ù„Ø£ØµØºØ± Ù‡Ùˆ Ø§Ù„Ù…Ø´ØªØ±Ùƒ.'
             },
             {
                 id: 501, type: 'challenge2', t: 'Ù…Ø³ØªØ·ÙŠÙ„ Ù…Ø³Ø§Ø­ØªÙ‡ <span class="math-eq">Ù¢Ù¤Ø³<sup class="tiny-sup">Ù¢</sup></span> ÙˆØ¹Ø±Ø¶Ù‡ <span class="math-eq">Ù¦Ø³</span>. Ù…Ø§ Ø·ÙˆÙ„Ù‡ØŸ', 
                 o: [{t:'Ù¤', v:'a'}, {t:'Ù¤Ø³', v:'b'}, {t:'Ù¡Ù¨Ø³', v:'c'}, {t:'Ù£Ø³', v:'d'}], c: 'b', 
                 e: '<div class="v-step text-sm"><p>Ø§Ù„Ø·ÙˆÙ„ = Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ã· Ø§Ù„Ø¹Ø±Ø¶</p><div class="dir-ltr text-center font-mono bg-gray-50 p-1 rounded">24xÂ² / 6x</div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800">4x</div></div>', 
                 smart: 'Ø§Ù‚Ø³Ù… Ù¢Ù¤ Ø¹Ù„Ù‰ Ù¦ØŒ ÙˆØ§Ù‚Ø³Ù… Ø³Â² Ø¹Ù„Ù‰ Ø³.'
             },
             {
                 id: 502, type: 'challenge2', t: 'Ù…Ø§ Ù‡Ùˆ Ù‚.Ù….Ø£ Ù„Ù„Ø­Ø¯ÙŠÙ† <span class="math-eq">Ø£<sup class="tiny-sup">Ù¢</sup>Ø¨</span> Ùˆ <span class="math-eq">Ø£ Ø¨<sup class="tiny-sup">Ù¢</sup></span>ØŸ', 
                 o: [{t:'Ø£ Ø¨', v:'a'}, {t:'Ø£Â² Ø¨Â²', v:'b'}, {t:'Ø£', v:'c'}, {t:'Ø¨', v:'d'}], c: 'a', 
                 e: '<div class="v-step text-sm"><div class="flex gap-2 w-full justify-center"><div class="bg-gray-50 p-1 rounded">Ø£Ù„Ù: Ø£Â¹</div><div class="bg-gray-50 p-1 rounded">Ø¨Ø§Ø¡: Ø¨Â¹</div></div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-green-50 border-green-300 text-green-800">Ø£ Ø¨</div></div>', 
                 smart: 'Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ±.'
             },
             {
                 id: 503, type: 'challenge2', t: 'Ø£ÙŠ Ø§Ù„Ø²ÙˆØ¬ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† "Ø£ÙˆÙ„ÙŠØ§Ù† ÙÙŠÙ…Ø§ Ø¨ÙŠÙ†Ù‡Ù…Ø§" (Ù‚.Ù….Ø£ Ù„Ù‡Ù…Ø§ Ù‡Ùˆ Ù¡)ØŸ', 
                 o: [{t:'Ù¨ Ùˆ Ù¡Ù ', v:'a'}, {t:'Ù© Ùˆ Ù¡Ù¢', v:'b'}, {t:'Ù¨ Ùˆ Ù©', v:'c'}, {t:'Ù¦ Ùˆ Ù¡Ù¥', v:'d'}], c: 'c', 
                 e: '<div class="v-step text-sm"><div class="bg-gray-50 p-1 rounded w-full">Ù¨ = Ù¢Ã—Ù¢Ã—Ù¢</div><div class="bg-gray-50 p-1 rounded w-full">Ù© = Ù£Ã—Ù£</div><i class="fas fa-arrow-down v-arrow"></i><div class="math-eq bg-red-50 border-red-300 text-red-800">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±Ùƒ</div></div>', 
                 smart: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø¯ÙŠÙ† Ù„Ø§ ÙŠÙ‚Ø¨Ù„Ø§Ù† Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù….'
             }
        ];

        // Tree Logic
        const treeState = { 24: { currentStep: 0, maxSteps: 0, activeTree: null }, 81: { currentStep: 0, maxSteps: 0, activeTree: null } };

        function selectMethod(num, method) {
            document.getElementById(`placeholder-${num}`).classList.add('hidden');
            document.getElementById(`tree-${num}-A`).classList.remove('flex');
            document.getElementById(`tree-${num}-A`).classList.add('hidden');
            document.getElementById(`tree-${num}-B`).classList.remove('flex');
            document.getElementById(`tree-${num}-B`).classList.add('hidden');
            document.getElementById(`btn-${num}-A`).classList.remove('selected');
            document.getElementById(`btn-${num}-B`).classList.remove('selected');
            document.getElementById(`btn-${num}-${method}`).classList.add('selected');
            const treeId = `tree-${num}-${method}`;
            const treeEl = document.getElementById(treeId);
            treeEl.classList.remove('hidden');
            treeEl.classList.add('flex');
            const steps = treeEl.querySelectorAll('.tree-step');
            steps.forEach(s => {
                s.classList.remove('visible');
                if(s.classList.contains('branch-lines')) s.classList.remove('visible'); 
            });
            let max = 0;
            steps.forEach(s => {
                const match = s.className.match(/step-(\d+)/);
                if(match) max = Math.max(max, parseInt(match[1]));
            });
            treeState[num] = { currentStep: 0, maxSteps: max, activeTree: treeId };
            const nextBtn = document.getElementById(`next-${num}`);
            nextBtn.textContent = "Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©";
            nextBtn.onclick = () => nextStep(num);
            nextBtn.classList.remove('hidden');
            document.getElementById(`final-${num}`).classList.add('hidden');
            document.getElementById(`status-${num}`).textContent = "Ø§Ø¶ØºØ· Ø§Ù„ØªØ§Ù„ÙŠ...";
        }

        function nextStep(num) {
            const state = treeState[num];
            if (!state.activeTree) return;
            state.currentStep++;
            const currentClass = `step-${state.currentStep}`;
            const treeEl = document.getElementById(state.activeTree);
            const targets = treeEl.querySelectorAll(`.${currentClass}`);
            targets.forEach(t => t.classList.add('visible'));
            if (state.currentStep >= state.maxSteps) {
                const nextBtn = document.getElementById(`next-${num}`);
                nextBtn.textContent = "Ø¥Ø¹Ø§Ø¯Ø©";
                nextBtn.onclick = () => resetMethod(num);
                document.getElementById(`final-${num}`).classList.remove('hidden');
                document.getElementById(`final-${num}`).classList.add('animate-pulse');
                document.getElementById(`status-${num}`).textContent = "Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„!";
            } else {
                document.getElementById(`status-${num}`).textContent = `Ø®Ø·ÙˆØ© ${convertToArabic(state.currentStep)} Ù…Ù† ${convertToArabic(state.maxSteps)}`;
            }
        }

        function resetMethod(num) {
            const state = treeState[num];
            if (!state.activeTree) return;
            const method = state.activeTree.split('-')[2];
            selectMethod(num, method);
        }

        function resetAllTrees() {
            [24, 81].forEach(num => {
                document.getElementById(`placeholder-${num}`).classList.remove('hidden');
                document.getElementById(`tree-${num}-A`).classList.add('hidden');
                document.getElementById(`tree-${num}-B`).classList.add('hidden');
                document.getElementById(`btn-${num}-A`).classList.remove('selected');
                document.getElementById(`btn-${num}-B`).classList.remove('selected');
                document.getElementById(`next-${num}`).classList.add('hidden');
                document.getElementById(`final-${num}`).classList.add('hidden');
                document.getElementById(`status-${num}`).textContent = "...";
                treeState[num] = { currentStep: 0, maxSteps: 0, activeTree: null };
            });
        }

        const gcfState = { 'app1': 0, 'app2': 0, 'real1': 0, 'real2': 0, 'app3': 0, 'ex4': 0 };

        // APP 4 (62) - FIXED LOGIC
        function app3Next() {
            const step = gcfState['app3'];
            if (step === 0) {
                document.getElementById('app3-placeholder').classList.add('hidden');
                document.getElementById('app3-step-1').classList.remove('hidden');
                document.getElementById('app3-next-btn').classList.add('hidden');
                document.getElementById('app3-analyze-btn').classList.remove('hidden');
                // No increment here, wait for analyze button
            } else if (step === 1) { 
                document.getElementById('app3-step-2').classList.remove('hidden');
                document.getElementById('app3-next-btn').classList.add('hidden');
                document.getElementById('app3-reset-btn').classList.remove('hidden');
                gcfState['app3']++; 
            }
        }

        function app3Analyze() {
            document.getElementById('app3-placeholder').classList.add('hidden');
            document.getElementById('app3-step-1').classList.remove('hidden');
            document.getElementById('app3-branches').classList.remove('hidden');
            document.getElementById('app3-branches').classList.add('flex'); 
            document.getElementById('app3-prime-msg').classList.remove('hidden');
            document.getElementById('app3-analyze-btn').classList.add('hidden');
            document.getElementById('app3-next-btn').classList.remove('hidden');
            gcfState['app3'] = 1; // Now ready for next step
        }

        function app3Reset() {
            gcfState['app3'] = 0;
            document.getElementById('app3-placeholder').classList.remove('hidden');
            document.getElementById('app3-step-1').classList.add('hidden');
            document.getElementById('app3-branches').classList.add('hidden');
            document.getElementById('app3-branches').classList.remove('flex');
            document.getElementById('app3-prime-msg').classList.add('hidden');
            document.getElementById('app3-step-2').classList.add('hidden');
            document.getElementById('app3-next-btn').classList.remove('hidden'); 
            document.getElementById('app3-reset-btn').classList.add('hidden');
            document.getElementById('app3-analyze-btn').classList.add('hidden');
        }

        // APP 3 (32)
        function ex4Next() {
            const step = gcfState['ex4'];
            if (step === 0) { } else if (step === 1) { 
                document.getElementById('ex4-step-2').classList.remove('hidden');
                document.getElementById('ex4-next-btn').classList.add('hidden');
                document.getElementById('ex4-reset-btn').classList.remove('hidden');
                gcfState['ex4']++;
            }
        }

        function ex4Analyze() {
            document.getElementById('ex4-placeholder').classList.add('hidden');
            document.getElementById('ex4-step-1').classList.remove('hidden');
            document.getElementById('ex4-branches').classList.remove('hidden');
            document.getElementById('ex4-branches').classList.add('flex');
            document.getElementById('ex4-prime-msg').classList.remove('hidden');
            document.getElementById('ex4-analyze-btn').classList.add('hidden');
            document.getElementById('ex4-next-btn').classList.remove('hidden');
            gcfState['ex4'] = 1; 
        }

        function ex4Reset() {
            gcfState['ex4'] = 0;
            document.getElementById('ex4-placeholder').classList.remove('hidden');
            document.getElementById('ex4-step-1').classList.add('hidden');
            document.getElementById('ex4-branches').classList.add('hidden');
            document.getElementById('ex4-branches').classList.remove('flex');
            document.getElementById('ex4-prime-msg').classList.add('hidden');
            document.getElementById('ex4-step-2').classList.add('hidden');
            document.getElementById('ex4-next-btn').classList.add('hidden');
            document.getElementById('ex4-analyze-btn').classList.remove('hidden');
            document.getElementById('ex4-reset-btn').classList.add('hidden');
        }

        function gcfNext(appId) {
             const step = gcfState[appId];
             // Logic for Real-life apps & GCF apps
             if (appId.startsWith('real')) {
                 if (step === 0) {
                    document.getElementById(`gcf-placeholder-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-step-1-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                 } else if (step === 1) {
                    document.getElementById(`gcf-step-2-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                 } else if (step === 2) { 
                    if(appId === 'real1') document.getElementById(`gcf-step-3-msg-${appId}`).classList.remove('hidden');
                    else document.getElementById(`gcf-step-3-msg-${appId}`).classList.remove('hidden'); 
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-highlight-btn-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                 } else if (step === 4) { 
                    if (appId === 'real1') {
                        document.getElementById(`gcf-step-5-${appId}`).classList.remove('hidden');
                    } else {
                        document.getElementById(`gcf-step-4-${appId}`).classList.remove('hidden');
                    }
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-reset-btn-${appId}`).classList.remove('hidden');
                 }
            } else if (appId === 'app2') { // 3 terms
                if (step === 0) {
                    document.getElementById(`gcf-placeholder-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-step-1-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 1) {
                    document.getElementById(`gcf-step-2-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 2) {
                    document.getElementById(`gcf-step-3-${appId}`).classList.remove('hidden');
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-highlight-btn-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 4) {
                    document.getElementById(`gcf-step-5-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 5) {
                    document.getElementById(`gcf-step-6-${appId}`).classList.remove('hidden');
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-reset-btn-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                }
            } else { // Generic
                if (step === 0) {
                    document.getElementById(`gcf-placeholder-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-step-1-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 1) {
                    document.getElementById(`gcf-step-2-${appId}`).classList.remove('hidden');
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-highlight-btn-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 3) {
                    document.getElementById(`gcf-step-4-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                } else if (step === 4) {
                    document.getElementById(`gcf-step-5-${appId}`).classList.remove('hidden');
                    document.getElementById(`gcf-next-btn-${appId}`).classList.add('hidden');
                    document.getElementById(`gcf-reset-btn-${appId}`).classList.remove('hidden');
                    gcfState[appId]++;
                }
            }
        }

        function gcfHighlight(appId) {
            document.getElementById(`gcf-highlight-btn-${appId}`).classList.add('hidden');
            
            if (appId === 'real1') {
                document.getElementById(`gcf-step-3-msg-${appId}`).classList.remove('hidden');
            } else if (appId === 'real2') {
                document.getElementById(`gcf-step-3-msg-${appId}`).classList.remove('hidden');
            } else if (appId === 'app2') {
                 document.getElementById(`gcf-step-4-msg-${appId}`).classList.remove('hidden');
            } else {
                document.getElementById(`gcf-step-3-msg-${appId}`).classList.remove('hidden');
            }
            
            let t1Selector, t2Selector, t3Selector, pairs = [];
            
            if (appId === 'app1') {
                t1Selector = `#gcf-step-1-${appId} .factor-item`;
                t2Selector = `#gcf-step-2-${appId} .factor-item`;
                pairs = [{t1:0,t2:0}, {t1:2,t2:1}, {t1:3,t2:3}, {t1:5,t2:4}, {t1:6,t2:5}]; 
            } else if (appId === 'app2') {
                const stepContainer1 = document.getElementById(`gcf-step-1-${appId}`);
                const stepContainer2 = document.getElementById(`gcf-step-2-${appId}`);
                const stepContainer3 = document.getElementById(`gcf-step-3-${appId}`);
                
                if (stepContainer1 && stepContainer2 && stepContainer3) {
                     const t1 = stepContainer1.querySelectorAll('.factor-item'); 
                     const t2 = stepContainer2.querySelectorAll('.factor-item'); 
                     const t3 = stepContainer3.querySelectorAll('.factor-item');
                     
                     if(t1[1]) t1[1].classList.add('active-common', 'visual-step-highlight'); 
                     if(t2[0]) t2[0].classList.add('active-common', 'visual-step-highlight'); 
                     if(t3[0]) t3[0].classList.add('active-common', 'visual-step-highlight'); 
                     
                     if(t1[2]) t1[2].classList.add('active-common', 'visual-step-highlight'); 
                     if(t2[2]) t2[2].classList.add('active-common', 'visual-step-highlight'); 
                     if(t3[2]) t3[2].classList.add('active-common', 'visual-step-highlight'); 
                     
                     if(t1[4]) t1[4].classList.add('active-common', 'visual-step-highlight'); 
                     if(t2[3]) t2[3].classList.add('active-common', 'visual-step-highlight'); 
                     if(t3[3]) t3[3].classList.add('active-common', 'visual-step-highlight'); 
                }
                document.getElementById(`gcf-next-btn-${appId}`).classList.remove('hidden');
                gcfState[appId] = 4;
                return;
            } else if (appId === 'real1') {
                const stepContainer = document.getElementById(`gcf-step-2-${appId}`);
                if (stepContainer) {
                    const t1 = stepContainer.querySelectorAll('.factor-item[class*="t1"]');
                    const t2 = stepContainer.querySelectorAll('.factor-item[class*="t2"]');
                    if(t1[0]) t1[0].classList.add('active-common', 'visual-step-highlight');
                    if(t2[0]) t2[0].classList.add('active-common', 'visual-step-highlight');
                    if(t1[1]) t1[1].classList.add('active-common', 'visual-step-highlight');
                    if(t2[1]) t2[1].classList.add('active-common', 'visual-step-highlight');
                    if(t1[3]) t1[3].classList.add('active-common', 'visual-step-highlight');
                    if(t2[2]) t2[2].classList.add('active-common', 'visual-step-highlight');
                }
                document.getElementById(`gcf-next-btn-${appId}`).classList.remove('hidden');
                gcfState[appId] = 4; 
                return;
            } else if (appId === 'real2') {
                 const stepContainer = document.getElementById(`gcf-step-2-${appId}`);
                 if (stepContainer) {
                     const t1 = stepContainer.querySelectorAll('.factor-item[class*="t1"]'); 
                     const t2 = stepContainer.querySelectorAll('.factor-item[class*="t2"]'); 
                     if(t1[1]) t1[1].classList.add('active-common', 'visual-step-highlight'); 
                     if(t2[0]) t2[0].classList.add('active-common', 'visual-step-highlight'); 
                     if(t1[2]) t1[2].classList.add('active-common', 'visual-step-highlight'); 
                     if(t2[2]) t2[2].classList.add('active-common', 'visual-step-highlight'); 
                 }
                 document.getElementById(`gcf-next-btn-${appId}`).classList.remove('hidden');
                 gcfState[appId] = 4;
                 return;
            }

            if (t1Selector) {
                const t1Nodes = document.querySelectorAll(t1Selector);
                const t2Nodes = document.querySelectorAll(t2Selector);
                pairs.forEach(pair => {
                    if(t1Nodes[pair.t1]) t1Nodes[pair.t1].classList.add('active-common', 'visual-step-highlight');
                    if(t2Nodes[pair.t2]) t2Nodes[pair.t2].classList.add('active-common', 'visual-step-highlight');
                });
            }

            document.getElementById(`gcf-next-btn-${appId}`).classList.remove('hidden');
            gcfState[appId] = 3; 
        }

        function gcfReset(appId) {
            gcfState[appId] = 0;
            document.getElementById(`gcf-placeholder-${appId}`).classList.remove('hidden');
            for(let i=1; i<=6; i++) {
                const el = document.getElementById(`gcf-step-${i}-${appId}`);
                if(el) el.classList.add('hidden');
                const msg = document.getElementById(`gcf-step-${i}-msg-${appId}`);
                if(msg) msg.classList.add('hidden');
            }
            if(appId === 'app2') {
                 const msg = document.getElementById(`gcf-step-4-msg-${appId}`);
                 if(msg) msg.classList.add('hidden');
            }
            
            const container = document.getElementById(appId.startsWith('real') ? `gcf-${appId}` : `gcf-${appId}`);
            if (container) {
                container.querySelectorAll('.factor-item').forEach(el => {
                    el.classList.remove('active-common', 'visual-step-highlight');
                });
            }
            document.getElementById(`gcf-next-btn-${appId}`).classList.remove('hidden');
            document.getElementById(`gcf-reset-btn-${appId}`).classList.add('hidden');
            document.getElementById(`gcf-highlight-btn-${appId}`).classList.add('hidden');
        }

        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabId}`);
            const navEl = document.getElementById(`nav-${tabId}`);
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') {
                if(document.getElementById('quizForm').innerHTML === '') { generateQuiz(); }
                renderDynamicGames(); 
                const sId = urlParams.get('studentId');
                if(sId && sId !== 'visitor') fetchStudentData();
            }
        }

        function initInteractive() {
            document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
                if (container.id === 'interactive-container-2-1') return; 
                
                const steps = container.querySelectorAll('.step-interactive');
                const placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                let current = -1;
                const update = () => {
                    if(!prevBtn) return;
                    prevBtn.disabled = current === -1;
                    if (current === -1) placeholder.classList.remove('hidden'); else placeholder.classList.add('hidden');
                    steps.forEach((s, i) => { if (i <= current) s.classList.add('active'); else s.classList.remove('active'); });
                    if (current >= steps.length - 1) { nextBtn.classList.add('hidden'); resetBtn.classList.remove('hidden'); } 
                    else { nextBtn.classList.remove('hidden'); resetBtn.classList.add('hidden'); }
                };
                if(nextBtn) nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
                if(prevBtn) prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
                update();
            });
        }
        
        function initGallery() {
            const setupGallery = (containerId, data, themeColorClass, resultColorClass) => {
                const container = document.getElementById(containerId);
                if(!container) return;
                const explanationArea = container.querySelector('.explanation-area');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const counter = container.querySelector('.counter');
                const items = container.querySelectorAll('.strip-item');
                let currentIndex = -1;
                const updateUI = (index) => {
                    currentIndex = index;
                    items.forEach((item, i) => {
                        if (i === index) { item.classList.add('active'); item.classList.remove('opacity-30', 'scale-90'); } 
                        else { item.classList.remove('active'); item.classList.add('opacity-30', 'scale-90'); }
                    });
                    const itemData = data[index];
                    explanationArea.innerHTML = `<div class="explanation-panel"><div class="step-box"><h4 class="font-bold text-xs ${themeColorClass} mb-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h4><p class="text-sm">${itemData.analysis}</p></div><div class="step-box ${resultColorClass} mt-2"><h4 class="font-bold text-xs mb-1">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</h4><p class="text-sm font-bold">${itemData.result}</p></div></div>`;
                    prevBtn.disabled = index === 0;
                    nextBtn.disabled = index === data.length - 1;
                    counter.textContent = convertToArabic(index + 1) + ' / ' + convertToArabic(data.length);
                };
                items.forEach((item, i) => { item.onclick = () => updateUI(i); });
                nextBtn.onclick = () => { if (currentIndex < data.length - 1) updateUI(currentIndex + 1); };
                prevBtn.onclick = () => { if (currentIndex > 0) updateUI(currentIndex - 1); };
                updateUI(0);
            };
            setupGallery('gallery-container-1', galleryData1, 'text-purple-600', 'border-green-500 bg-green-50 text-green-600');
        }
        
        async function saveScoreToBackend(lessonId, grade) {
            const sId = urlParams.get('studentId');
            const cId = urlParams.get('classId');
            const saveStatus = document.getElementById('save-status');
            if (!sId || !cId) { if(saveStatus) saveStatus.innerHTML = '<span class="text-yellow-600">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø²Ø§Ø¦Ø±)</span>'; return; }
            if(saveStatus) saveStatus.innerHTML = '<span class="text-purple-600"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©...</span>';
            const requestUrl = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            let success = false;
            for (let i = 0; i < 3; i++) {
                try { await fetch(requestUrl); success = true; break; } 
                catch (error) { await new Promise(r => setTimeout(r, 2000)); }
            }
            if (success) {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-green-600 font-bold">âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­!</span>';
                setTimeout(() => fetchStudentData(), 1000); 
            } else {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-red-600 font-bold">âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.</span>';
            }
        }
        
        async function fetchStudentData() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') return;
            const loadingEl = document.getElementById('loading-attempts');
            const displayEl = document.getElementById('attempts-display');
            if(loadingEl) loadingEl.classList.remove('hidden');
            if(displayEl) displayEl.classList.add('hidden');
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url);
                const jsonResponse = await response.json();
                if (jsonResponse.status === "success" && jsonResponse.data) {
                    let lessonData = { attempts: 0, allowed: true, waitTime: 0, grade: 0 };
                    if (jsonResponse.data.lessons && jsonResponse.data.lessons[LESSON_KEY]) {
                        lessonData = jsonResponse.data.lessons[LESSON_KEY];
                    }
                    const consumed = lessonData.attempts || 0;
                    const maxAttempts = 3; 
                    attemptsLeft = Math.max(0, maxAttempts - consumed);
                    if (attemptsLeft > 0) {
                        localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_${sId}`);
                        if (timerInterval) clearInterval(timerInterval);
                        document.getElementById('timer-top-container').classList.add('hidden');
                        document.getElementById('timer-bottom-container').classList.add('hidden');
                        const submitBtn = document.getElementById('quiz-action-btn');
                        if(submitBtn) {
                             submitBtn.disabled = false;
                             submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                             submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                             submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
                        }
                    } else {
                        attemptsLeft = 0;
                        if (lessonData.waitTime > 0) {
                            const unlockTime = Date.now() + lessonData.waitTime;
                            localStorage.setItem(`${NEXT_ATTEMPT_KEY}_${sId}`, unlockTime);
                            startTimer(unlockTime);
                        }
                    }
                    const scoreEl = document.getElementById('student-score');
                    const badge = document.getElementById('header-score-badge');
                    if (lessonData.grade > 0 && scoreEl) {
                        scoreEl.textContent = lessonData.grade;
                        if(badge) badge.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Sync Error:", error);
            } finally {
                updateAttemptsUI();
                if(loadingEl) loadingEl.classList.add('hidden');
                if(displayEl) displayEl.classList.remove('hidden');
            }
        }

        function renderDynamicGames() {
            const sId = urlParams.get('studentId') || 'visitor';
            const wrapper = document.getElementById('games-wrapper');
            if (wrapper) wrapper.classList.remove('hidden'); 
            
            const container = document.getElementById('dynamic-games-container');
            if (!container) return;
            container.innerHTML = '';
            
            const games = [
                { id: 'g7_1_1', title: 'Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„', maxDefault: 5 },
                { id: 'g7_1_2', title: 'ØµØ§Ø¦Ø¯ Ø§Ù„Ù‚Ø§Ø³Ù… (Ù‚.Ù….Ø£)', maxDefault: 5 }
            ];
            
            let hasGames = false;
            games.forEach((game, idx) => {
                const i = idx + 1;
                const title = urlParams.get(`g${i}_title`) || game.title;
                const id = urlParams.get(`g${i}_id`) || game.id;
                const scoreParam = urlParams.get(`g${i}_score`);
                const hasPlayed = scoreParam !== null && scoreParam.trim() !== ''; 
                const rawScore = hasPlayed ? (parseFloat(scoreParam) || 0) : 0;
                const max = parseInt(urlParams.get(`g${i}_max`)) || game.maxDefault;

                if (title && id) {
                    hasGames = true;
                    let cardClass = "normal-card";
                    let iconHtml = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg shadow-sm" style="background-color: var(--theme-hex)"><i class="fas fa-gamepad"></i></div>`;
                    let statusText = "Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡"; 
                    
                    if (hasPlayed && rawScore > 0) {
                        if (rawScore >= max) {
                             cardClass = "gold-card";
                             iconHtml = `<div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-trophy"></i></div>`;
                             statusText = "Ø£Ø­Ø³Ù†Øª! (Ø¯Ø±Ø¬Ø© ÙƒØ§Ù…Ù„Ø©)";
                        } else if (rawScore >= 2.5) { 
                             cardClass = "orange-card";
                             iconHtml = `<div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-star"></i></div>`;
                             statusText = `Ù†ØªÙŠØ¬ØªÙƒ: ${rawScore}/${max}`;
                        } else {
                             cardClass = "red-card";
                             iconHtml = `<div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-sync-alt"></i></div>`;
                             statusText = `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (${rawScore}/${max})`;
                        }
                    } else {
                          statusText = "Ù„Ø¹Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ©";
                    }

                    const gameUrl = `https://ablan-math.github.io/games/${id}.html?studentId=${sId}&classId=${urlParams.get('classId')}`;
                    const gameHtml = `
                    <div onclick="openGameModal('${gameUrl}', '${title}')" class="block group relative overflow-hidden rounded-xl p-4 hover:shadow-md transition-all duration-300 ${cardClass} cursor-pointer">
                        <div class="flex items-center gap-3">
                            ${iconHtml}
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm">${title}</h3>
                                <p class="text-[10px] text-gray-500 font-bold">${statusText}</p>
                            </div>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', gameHtml);
                }
            });
             if(hasGames && !document.getElementById('games-title')) {
                 container.insertAdjacentHTML('beforebegin', `<h2 id="games-title" class="col-span-1 md:col-span-2 text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> Ø§Ø³ØªÙ…ØªØ¹ ÙˆØªØ¹Ù„Ù…</h2>`);
            }
        }

        // --- GAME MODAL LOGIC ---
        function openGameModal(url, title) {
            const modal = document.getElementById('game-modal');
            const iframe = document.getElementById('game-iframe');
            const titleEl = document.getElementById('game-modal-title');
            
            if(modal && iframe) {
                iframe.src = url;
                if(titleEl) titleEl.textContent = title;
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeGameModal() {
            const modal = document.getElementById('game-modal');
            const iframe = document.getElementById('game-iframe');
            
            if(modal) {
                modal.classList.add('hidden');
                if(iframe) iframe.src = ''; 
                document.body.style.overflow = '';
            }
        }

        function toggleMaximize() {
            const frameContainer = document.getElementById('game-frame-container');
            const maxIcon = document.getElementById('max-icon');
            if (!frameContainer) return;
            if (frameContainer.classList.contains('minimized')) { frameContainer.classList.remove('minimized'); }

            if (frameContainer.classList.contains('fullscreen')) {
                frameContainer.classList.remove('fullscreen');
                frameContainer.classList.add('modal-default-size');
                if(maxIcon) maxIcon.className = 'fas fa-expand'; 
            } else {
                frameContainer.classList.add('fullscreen');
                frameContainer.classList.remove('modal-default-size');
                if(maxIcon) maxIcon.className = 'fas fa-compress'; 
            }
        }

        function toggleMinimize() {
            const frameContainer = document.getElementById('game-frame-container');
            if (!frameContainer) return;
            if (frameContainer.classList.contains('fullscreen')) {
                frameContainer.classList.remove('fullscreen');
                frameContainer.classList.add('modal-default-size'); 
            }
            if (frameContainer.classList.contains('minimized')) {
                frameContainer.classList.remove('minimized');
                document.body.style.overflow = 'hidden'; 
            } else {
                frameContainer.classList.add('minimized');
                document.body.style.overflow = ''; 
            }
        }

        function resizeGame(mode) {
            // Backward compatibility
            if (mode === 'max') {
                const frameContainer = document.getElementById('game-frame-container');
                if (frameContainer && !frameContainer.classList.contains('fullscreen')) { toggleMaximize(); }
            } else if (mode === 'min') {
                const frameContainer = document.getElementById('game-frame-container');
                if (frameContainer && frameContainer.classList.contains('fullscreen')) { toggleMaximize(); }
            }
        }

        function initAttempts() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.removeItem(`${ATTEMPTS_KEY}_visitor`);
                localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_visitor`);
                attemptsLeft = 1; 
                updateAttemptsUI();
            } else {
                attemptsLeft = 0; 
                updateAttemptsUI();
                fetchStudentData();
            }
        }
        
        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);
            const submitBtn = document.getElementById('quiz-action-btn');
            // If results are showing, do NOT touch the button text to avoid overwriting "Retake"
            const resultsVisible = document.getElementById('quiz-results') && !document.getElementById('quiz-results').classList.contains('hidden');
            
            if (resultsVisible) return; // Exit if in result mode

            if (submitBtn) {
                 if (attemptsLeft > 0) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    submitBtn.textContent = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø³ØªÙ†ÙØ°Ø©";
                }
            }
        }

        function startTimer(targetTime) {
             clearInterval(timerInterval);
             const tick = () => {
                const now = Date.now();
                const diff = targetTime - now;
                if (diff <= 0) {
                    clearInterval(timerInterval);
                    const sId = urlParams.get('studentId') || 'visitor';
                    if (sId === 'visitor') {
                          attemptsLeft = 1;
                          localStorage.setItem(`${ATTEMPTS_KEY}_visitor`, 1);
                          localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_visitor`);
                          updateAttemptsUI();
                    } else {
                        fetchStudentData(); 
                    }
                    return;
                }
                const hours = Math.floor((diff / (1000 * 60 * 60)));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const timeStr = `${hours}:${minutes}:${seconds}`; 
                const timeStrAr = timeStr.replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
                const topDisplay = document.getElementById('timer-display-top');
                const bottomDisplay = document.getElementById('timer-display-bottom');
                if(topDisplay) { topDisplay.textContent = timeStrAr; topDisplay.parentElement.classList.remove('hidden'); }
                if(bottomDisplay) bottomDisplay.textContent = timeStrAr;
            };
            timerInterval = setInterval(tick, 1000);
            tick();
        }

        function generateQuiz() { 
            const getQ = (type) => {
                const subset = questionBank.filter(q => q.type === type);
                if (subset.length === 0) return null;
                return subset[Math.floor(Math.random() * subset.length)];
            };
            const q1 = getQ('learn1');
            const q2 = getQ('learn2');
            const q3 = getQ('learn3');
            const q4 = getQ('challenge1'); 
            const q5 = getQ('challenge2'); 
            currentQuestions = [q1, q2, q3, q4, q5].filter(q => q !== null);
            renderQuiz(); 
        }

        function renderQuiz() {
            const quizForm = document.getElementById('quizForm');
            if(!quizForm) return;
            let html = '';
            const typeLabels = { 'learn1': 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù…', 'learn2': 'Ù‚.Ù….Ø£', 'learn3': 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª', 'challenge1': 'ØªØ­Ø¯ÙŠ: Ø§ÙƒØªØ´Ù Ø§Ù„Ø®Ø·Ø£', 'challenge2': 'ØªØ­Ø¯ÙŠ: ØªÙÙƒÙŠØ± Ø¹Ù„ÙŠØ§' };
            currentQuestions.forEach((q, i) => {
                html += `
                <div class="border border-gray-200 rounded-xl p-4 md:p-6 hover:border-purple-200 transition bg-white mb-6">
                    <div class="flex flex-col gap-2 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-[10px] md:text-xs font-bold">Ø³Ø¤Ø§Ù„ ${convertToArabic(i+1)}</span>
                            <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1"><i class="fas fa-tag text-xs"></i> ${typeLabels[q.type] || 'Ø¹Ø§Ù…'}</span>
                        </div>
                        <p class="font-bold text-gray-800 text-sm md:text-lg leading-6 mt-1">${q.t}</p>
                    </div>
                    <div class="options-grid">
                        ${q.o.map((opt, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${opt.v}" class="hidden"><label for="q${i}o${oi}" class="option-label text-sm md:text-base select-none shadow-sm">${opt.t}</label></div>`).join('')}
                    </div>
                    <div id="feedback-${i}" class="text-xs md:text-base font-bold mt-3 hidden p-3 rounded-lg"></div>
                    <div id="post-submit-actions-${i}" class="hidden flex flex-wrap gap-2 mt-3 items-center">
                         <button type="button" onclick="showExplain(${i})" class="text-xs md:text-sm bg-purple-50 text-purple-600 px-3 py-2 rounded-lg hover:bg-purple-100 flex items-center gap-1 transition"><i data-lucide="help-circle" class="w-3 h-3 md:w-4 md:h-4"></i> Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                         <button type="button" onclick="showSmart(${i})" class="text-xs md:text-sm bg-green-50 text-green-600 px-3 py-2 rounded-lg hover:bg-green-100 flex items-center gap-1 transition"><i data-lucide="lightbulb" class="w-3 h-3 md:w-4 md:h-4"></i> Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ</button>
                         <button type="button" onclick="switchTab('${q.type === 'challenge1' || q.type === 'challenge2' ? 'learn3' : q.type}')" class="text-xs md:text-sm border border-gray-200 text-gray-500 px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-1 transition mr-auto"><i data-lucide="book-open" class="w-3 h-3 md:w-4 md:h-4"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³</button>
                    </div>
                </div>`;
            });
            html += '<button type="submit" id="quiz-action-btn" class="w-full bg-purple-600 text-white font-bold py-3 md:py-4 rounded-xl text-sm md:text-lg shadow-lg hover:bg-purple-700 transition transform active:scale-95 mb-4 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400"><i class="fas fa-check-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>';
            quizForm.innerHTML = html;
            lucide.createIcons();
            quizForm.onsubmit = handleQuizSubmit;
        }

        async function handleQuizSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('quiz-action-btn');
            if (attemptsLeft <= 0) { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªÙ†ÙØ°Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ."); return; }
            attemptsLeft--;
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.setItem(`${ATTEMPTS_KEY}_visitor`, attemptsLeft);
                if (attemptsLeft === 0) {
                    localStorage.setItem(`${NEXT_ATTEMPT_KEY}_visitor`, Date.now() + COOLDOWN_MS);
                    startTimer(Date.now() + COOLDOWN_MS);
                }
            } else {
                localStorage.setItem(`${ATTEMPTS_KEY}_${sId}`, attemptsLeft);
                if (attemptsLeft === 0) {
                    localStorage.setItem(`${NEXT_ATTEMPT_KEY}_${sId}`, Date.now() + COOLDOWN_MS);
                    startTimer(Date.now() + COOLDOWN_MS);
                }
            }
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);

            let score = 0;
            submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ§Ù„Ø­ÙØ¸...";
            submitBtn.disabled = true;

            currentQuestions.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const feedback = document.getElementById(`feedback-${i}`);
                const actionArea = document.getElementById(`post-submit-actions-${i}`);
                if(actionArea) actionArea.classList.remove('hidden');

                if (selected) {
                    if (selected.value === q.c) {
                        score++;
                        feedback.innerHTML = 'âœ” Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!';
                        feedback.className = 'text-xs font-bold mt-3 text-green-700 bg-green-50 block p-3 rounded-lg border border-green-100';
                        feedback.classList.remove('hidden');
                    } else {
                        feedback.innerHTML = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©.';
                        feedback.className = 'text-xs font-bold mt-3 text-red-700 bg-red-50 block p-3 rounded-lg border border-red-100';
                        feedback.classList.remove('hidden');
                    }
                } else {
                    feedback.innerHTML = 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.';
                    feedback.className = 'text-xs font-bold mt-3 text-yellow-700 bg-yellow-50 block p-3 rounded-lg';
                    feedback.classList.remove('hidden');
                }
            });

            const finalScore = score * 2; 
            saveScoreToBackend(LESSON_KEY, finalScore);
            const resultCard = document.getElementById('quiz-results');
            resultCard.classList.remove('hidden', 'result-card-trophy', 'result-card-star', 'result-card-retry');
            
            if (finalScore > 8) {
                 resultCard.classList.add('result-card-trophy'); 
            } else if (finalScore >= 5) {
                 resultCard.classList.add('result-card-star'); 
            } else {
                 resultCard.classList.add('result-card-retry'); 
            }

            document.getElementById('quiz-score').textContent = `${convertToArabic(finalScore)} / Ù¡Ù `;
            const inputs = document.querySelectorAll('#quizForm input');
            inputs.forEach(i => i.disabled = true);
            
            // Force Update Button State for Retake
            submitBtn.type = "button"; 
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400');
            
            if (attemptsLeft > 0) {
                submitBtn.innerHTML = '<i class="fas fa-redo"></i> Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰';
                submitBtn.classList.add('bg-purple-600', 'text-white', 'hover:bg-purple-700', 'shadow-lg', 'transform', 'active:scale-95');
                submitBtn.disabled = false;
                submitBtn.onclick = resetQuizView; 
            } else {
                submitBtn.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª";
                submitBtn.classList.add('bg-gray-400', 'text-white', 'cursor-not-allowed');
                submitBtn.disabled = true;
                document.getElementById('timer-bottom-container').classList.remove('hidden');
            }
            renderDynamicGames();
        }

        function resetQuizView() {
            document.getElementById('quiz-results').classList.add('hidden');
            
            // Reset Button State Back to Submit
            const submitBtn = document.getElementById('quiz-action-btn');
            if(submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
                submitBtn.onclick = null; // Let the form handle submit
                submitBtn.type = "submit";
            }

            generateQuiz(); 
            fetchStudentData();
            document.getElementById('tab-quiz').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showExplain(i) { document.getElementById('modal-content').innerHTML = currentQuestions[i].e; document.getElementById('modal').classList.remove('hidden'); }
        function showSmart(i) { document.getElementById('modal-content').innerHTML = `<p class="font-bold text-purple-700">ğŸ’¡ Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ:</p>${currentQuestions[i].smart}`; document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-content').innerHTML = ''; document.getElementById('modal').classList.add('hidden'); }
        function hardReset() { localStorage.clear(); window.location.reload(); }

        // 6. INITIALIZATION WRAPPER
        function initPage() {
            const header = document.getElementById('main-header');
            if (header) {
                 header.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-purple-800');
                 document.getElementById('header-icon').className = 'fas fa-puzzle-piece text-lg md:text-2xl';
                 document.getElementById('header-bg-icon').className = 'fas fa-puzzle-piece absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12';
                 document.getElementById('chapter-num-bg').textContent = themeColor.chapterNum;
            }
            document.documentElement.style.setProperty('--theme-hex', themeColor.hex);

            const navContainer = document.getElementById('bottom-nav-container');
            if (navContainer) {
                let navHTML = '';
                tabs.forEach((tab, index) => {
                      navHTML += `
                      <div class="nav-item ${index === 0 ? 'active' : ''}" onclick="window.switchTab('${tab.id}')" id="nav-${tab.id}">
                          <i data-lucide="${tab.icon}"></i>
                          <span>${tab.label}</span>
                      </div>`;
                });
                navContainer.innerHTML = navHTML;
            }

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            
            initInteractive();
            initAttempts();
            initGallery();
        }

        // 7. EXPOSE TO WINDOW & START
        window.switchTab = switchTab;
        window.initInteractive = initInteractive;
        window.initAttempts = initAttempts;
        window.initGallery = initGallery;
        window.generateQuiz = generateQuiz;
        window.renderDynamicGames = renderDynamicGames;
        window.saveScoreToBackend = saveScoreToBackend;
        window.handleQuizSubmit = handleQuizSubmit;
        window.showExplain = showExplain;
        window.showSmart = showSmart;
        window.closeModal = closeModal;
        window.resetQuizView = resetQuizView;
        window.hardReset = hardReset;
        
        window.openGameModal = openGameModal;
        window.closeGameModal = closeGameModal;
        window.resizeGame = resizeGame; 
        window.toggleMaximize = toggleMaximize;
        window.toggleMinimize = toggleMinimize;
        
        window.selectMethod = selectMethod; 
        window.nextStep = nextStep; 
        window.resetAllTrees = resetAllTrees; 
        window.resetMethod = resetMethod; 
        
        window.gcfNext = gcfNext; 
        window.gcfHighlight = gcfHighlight;
        window.gcfReset = gcfReset;
        
        window.app3Next = app3Next;
        window.app3Analyze = app3Analyze;
        window.app3Reset = app3Reset;
        
        window.ex4Next = ex4Next;
        window.ex4Analyze = ex4Analyze;
        window.ex4Reset = ex4Reset;
        
        window.onload = initPage;

    </script>
</body>
</html>

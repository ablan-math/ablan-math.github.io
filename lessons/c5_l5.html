<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٥-٥: تطبيقات على النظام المكون من معادلتين خطيتين | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .math-eq { font-family: "Courier New", monospace; font-size: 1.2rem; font-weight: bold; padding: 4px 10px; border-radius: 6px; display: inline-block; vertical-align: middle; transition: all 0.3s ease-in-out; border: 1px solid; }
        .highlight-number {
            background-color: #fef9c3; /* yellow-100 */
            color: #b45309; /* amber-700 */
            padding: 1px 5px;
            border-radius: 4px;
            border: 1px solid #fde047; /* yellow-300 */
            font-weight: bold;
        }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback {
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-weight: bold;
            transition: opacity 0.5s ease-in-out;
        }
        .feedback.correct { background-color: #dcfce7; color: #16a34a; border-right: 4px solid #22c55e; }
        .feedback.incorrect { background-color: #fee2e2; color: #b91c1c; border-right: 4px solid #ef4444; }
        
        .temp-comment { min-height: 56px; /* To prevent layout shift */ }
        .visual-workspace { opacity: 0; transition: opacity 0.5s ease-in-out; }
        .visual-workspace.visible { opacity: 1; }
        
        .eq-color-1 { color: #1d4ed8; background-color: #dbeafe; border-color: #93c5fd; } /* Blue */
        .eq-color-2 { color: #15803d; background-color: #dcfce7; border-color: #86efac; } /* Green */
        .eq-color-3 { color: #7e22ce; background-color: #f3e8ff; border-color: #d8b4fe; } /* Purple for new/modified */
        .final-answer-box { background-color: #fef9c3; border-color: #fde047; color: #b45309; }
        
        .part-1 { color: #1d4ed8; font-weight: bold; } /* Blue part */
        .part-2 { color: #15803d; font-weight: bold; } /* Green part */

        .target-term {
            outline: 3px solid #ef4444; /* red-500 */
            box-shadow: 0 0 10px #f43f5e;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-purple-800">الدرس ٥-٥: تطبيقات على النظام المكون من معادلتين خطيتين</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: تحديد أفضل طريقة للحل</h2>
                    <div class="p-4 bg-purple-50 rounded-lg space-y-3">
                        <p>كأحد التطبيقات الهامة، يجب تحديد أفضل طريقة لحل النظام. الجدول أدناه يبين أفضل حالة لاستعمال كل طريقة:</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow">
                                <thead class="bg-purple-600 text-white">
                                    <tr>
                                        <th class="text-right p-3">الطريقة</th>
                                        <th class="text-right p-3">أفضل حالة لاستعمالها</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b"><td class="p-3 font-bold">التمثيل البياني</td><td class="p-3">لتقدير الحلول؛ فالتمثيل البياني لا يعطي في الغالب حلاً دقيقاً.</td></tr>
                                    <tr class="border-b bg-gray-50"><td class="p-3 font-bold">التعويض</td><td class="p-3">إذا كان معامل أحد المتغيرين في إحدى المعادلتين <span class="highlight-number">١</span> أو <span class="highlight-number">-١</span>.</td></tr>
                                    <tr class="border-b"><td class="p-3 font-bold">الحذف باستعمال الجمع</td><td class="p-3">إذا كان كل من معاملي أحد المتغيرين في المعادلتين معكوساً جمعياً للآخر.</td></tr>
                                    <tr class="border-b bg-gray-50"><td class="p-3 font-bold">الحذف باستعمال الطرح</td><td class="p-3">إذا كان معاملا أحد المتغيرين في المعادلتين متساويين.</td></tr>
                                    <tr class="bg-gray-50"><td class="p-3 font-bold">الحذف باستعمال الضرب</td><td class="p-3">إذا لم يكن أي من المعاملات (<span class="highlight-number">١</span>) أو (<span class="highlight-number">-١</span>)، وليس من السهل التخلص من أحد المتغيرين بجمع المعادلتين أو طرحهما.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: اختر الطريقة الأفضل</h2>
                    <div id="interactive-choice-container" class="p-6 bg-gray-50 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Interactive questions will be injected here by JavaScript -->
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🌍 ثالثاً: تطبيقات من واقع الحياة</h2>
                    <div id="real-life-apps-container" class="grid grid-cols-1 md:grid-cols-1 gap-8">
                        <!-- Real life examples injected here -->
                    </div>
                </section>
                
                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ رابعاً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>

            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <script>
    // --- SCRIPT GENERAL ---
    function getStudentFromStorage() { return null; }
    function buildHeader(studentData, lessonTitle = null) {
        const headerContainer = document.getElementById('main-header');
        if (!headerContainer) return;
        let titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-purple-800">منصة الرياضيات التفاعلية</h1></a>`;
        if (lessonTitle) {
            titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-purple-700 leading-tight">${lessonTitle}</h1></div>`;
        }
        headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}<p class="text-lg text-gray-600">زائر</p></div>`;
    }
    function buildFooter() {
        const footerContainer = document.getElementById('main-footer');
        if (!footerContainer) return;
        footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`;
    }
    function initializeQuiz(lessonId, questions, studentData) { 
        window.currentQuestions = questions; 
        const quizForm = document.getElementById('quizForm'); 
        if (!quizForm) return; 
        if (questions.length === 0) { 
            quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; 
            return; 
        } 
        let attemptsLeft = 1; 
        const attemptsCounter = document.getElementById('attempts-counter'); 
        if (attemptsCounter) { 
            attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; 
        } 
        const quizHtml = questions.map((q, index) => { 
            const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); 
            return `<div class="p-4 border-2 border-gray-200 rounded-lg"><p class="font-bold">${index + 1}. ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><div class="flex items-center space-x-4 space-x-reverse"><button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div></div>`; 
        }).join(''); 
        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; 
        questions.forEach((q, index) => { 
            const explainBtn = document.getElementById(`explain-btn-${index}`); 
            if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index)); 
        }); 
        quizForm.onsubmit = (e) => { 
            e.preventDefault(); 
            let score = 0; 
            questions.forEach((q, index) => { 
                const userAnswer = e.target.elements[`q${index}`]?.value; 
                const feedbackEl = document.getElementById(`feedback-q${index}`); 
                if (userAnswer === q.correct) { 
                    score++; 
                    feedbackEl.textContent = '✔ إجابة صحيحة!'; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; 
                } else { 
                    feedbackEl.textContent = `❌ إجابة خاطئة.`; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; 
                } 
                document.getElementById(`explain-btn-${index}`).classList.remove('hidden'); 
            }); 
            const finalGrade = Math.round((score / questions.length) * 10); 
            const resultsDiv = document.getElementById('quiz-results'); 
            resultsDiv.classList.remove('hidden'); 
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; 
            document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; 
            e.target.querySelector('#submit-quiz-btn').disabled = true; 
        }; 
    }
    function showExplanation(questionIndex) { 
        const modal = document.getElementById('explanationModal'); 
        const explanationText = document.getElementById('explanationText'); 
        if(modal && explanationText && window.currentQuestions[questionIndex] && window.currentQuestions[questionIndex].explanation) { 
            explanationText.innerHTML = window.currentQuestions[questionIndex].explanation; 
            modal.classList.remove('hidden'); 
        } 
    }
    function closeModal() { 
        document.getElementById('explanationModal').classList.add('hidden'); 
    }
    // --- END SCRIPT GENERAL ---

    document.addEventListener('DOMContentLoaded', () => {
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(null, lessonTitle);
        buildFooter();
        
        const LESSON_ID = 'c5_l5';
        
        // --- Interactive Choice Section ---
        const interactiveQuestions = [
            { system: 'ص = ٢س - ١<br>٣س + ٢ص = ٢٦', options: ['التعويض', 'الحذف بالجمع', 'الحذف بالضرب'], correct: 'التعويض', reason: 'لأن المعادلة الأولى محلولة بالنسبة للمتغير (ص)، مما يجعل التعويض مباشرةً في المعادلة الثانية سهلاً جداً.' },
            { system: '٥س - ٢ص = ٤<br>٢س + ٢ص = ١٠', options: ['التعويض', 'الحذف بالجمع', 'الحذف بالطرح'], correct: 'الحذف بالجمع', reason: 'لأن معاملي المتغير (ص) هما <span class="highlight-number">-٢</span> و <span class="highlight-number">٢</span>، وهما معكوسان جمعيان لبعضهما، مما يسمح بحذف (ص) مباشرة عند جمع المعادلتين.' },
            { system: '٤س + ٥ص = ١٢<br>٤س - ٣ص = -٤', options: ['الحذف بالجمع', 'الحذف بالطرح', 'الحذف بالضرب'], correct: 'الحذف بالطرح', reason: 'لأن معاملي المتغير (س) متساويان (<span class="highlight-number">٤</span>). طرح المعادلتين من بعضهما سيؤدي إلى حذف (س) مباشرة.' },
            { system: '٢س + ٣ص = ٧<br>٣س - ٤ص = ٢', options: ['التمثيل البياني', 'التعويض', 'الحذف بالضرب'], correct: 'الحذف بالضرب', reason: 'لأن لا يوجد أي معامل يساوي ١ أو -١ (للتعويض)، والمعاملات ليست متساوية أو متعاكسة. لذلك، نحتاج إلى ضرب إحدى المعادلتين أو كلتيهما للتمكن من الحذف.' }
        ];

        const choiceContainer = document.getElementById('interactive-choice-container');
        interactiveQuestions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'p-4 bg-white rounded-lg shadow flex flex-col';
            const systemHTML = `<div class="mb-4 p-3 bg-gray-100 rounded-lg text-center"><p class="font-semibold mb-2">حدد أفضل طريقة لحل النظام:</p><div class="inline-block text-left">${q.system.split('<br>').map(eq => `<p class="math-eq">${eq}</p>`).join('<br>')}</div></div>`;
            const optionsHTML = q.options.map(opt => `<button data-question="${index}" data-answer="${opt}" class="w-full text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">${opt}</button>`).join('');
            questionDiv.innerHTML = `<div class="flex-grow">${systemHTML}<div class="grid grid-cols-1 gap-3">${optionsHTML.replace(/md:grid-cols-3/g, '')}</div></div><div id="feedback-interactive-${index}" class="feedback hidden mt-auto"></div>`;
            choiceContainer.appendChild(questionDiv);
        });

        choiceContainer.addEventListener('click', (e) => {
            if (e.target.matches('button[data-question]')) {
                const questionIndex = e.target.getAttribute('data-question');
                const userAnswer = e.target.getAttribute('data-answer');
                const question = interactiveQuestions[questionIndex];
                const feedbackEl = document.getElementById(`feedback-interactive-${questionIndex}`);
                const buttons = choiceContainer.querySelectorAll(`button[data-question="${questionIndex}"]`);
                buttons.forEach(btn => btn.disabled = true);
                if (userAnswer === question.correct) {
                    e.target.classList.replace('bg-blue-500', 'bg-green-500');
                    feedbackEl.innerHTML = `<strong>صحيح!</strong> ${question.reason}`;
                    feedbackEl.className = 'feedback correct';
                } else {
                    e.target.classList.replace('bg-blue-500', 'bg-red-500');
                    const correctButton = choiceContainer.querySelector(`button[data-question="${questionIndex}"][data-answer="${question.correct}"]`);
                    correctButton.classList.replace('bg-blue-500', 'bg-green-500');
                    feedbackEl.innerHTML = `<strong>خطأ.</strong> الطريقة الأفضل هي <strong>${question.correct}</strong>. ${question.reason}`;
                    feedbackEl.className = 'feedback incorrect';
                }
                feedbackEl.classList.remove('hidden');
            }
        });
        
        // --- Real Life Apps Section ---
        const realLifeApps = [
            {
                id: 'shopping',
                title: '🛒 مثال: التسوق',
                problem: 'اشترى عبدالله ٤ كراسات و ٣ حقائب بمبلغ ١٨١ ريالاً، واشترى عبدالرحمن كراسة وحقيبتين بمبلغ ٩٤ ريالاً. ما ثمن كل من الكراسة والحقيبة؟',
                initialEq1: '٤ك + ٣ح = ١٨١',
                initialEq2: 'ك + ٢ح = ٩٤',
                steps: [
                    { comment: "نحدد المتغيرات: <br> ك = ثمن الكراسة، ح = ثمن الحقيبة" },
                    { comment: "نكتب المعادلات الأساسية من المسألة.", showInitial: true },
                    { comment: "أفضل طريقة هي <b>التعويض</b> لأن معامل (ك) في المعادلة الثانية هو ١.", highlight: 2 },
                    { comment: "نعيد ترتيب المعادلة الثانية لتصبح بدلالة (ك):", work_eq2: { text: 'ك = ٩٤ - ٢ح', class: 'eq-color-3' } },
                    { comment: "الآن نعوض قيمة (ك) الجديدة في المعادلة الأولى:", work_eq1: { text: `٤(<span class="part-2">٩٤ - ٢ح</span>) + ٣ح = ١٨١`, class: 'eq-color-1' } },
                    { comment: "نبسط المعادلة بفك الأقواس:", work_eq1: { text: '٣٧٦ - ٨ح + ٣ح = ١٨١', class: 'eq-color-3' } },
                    { comment: "نجمع الحدود المتشابهة ونحل لإيجاد (ح):", work_eq1: { text: '-٥ح = -١٩٥ ⟹ ح = ٣٩', class: 'final-answer-box' } },
                    { comment: "وجدنا أن ثمن الحقيبة ٣٩ ريالاً. نعوض هذه القيمة في المعادلة الثانية المرتبة لإيجاد (ك):", work_eq2: { text: `ك = ٩٤ - ٢(<span class="part-1">٣٩</span>)`, class: 'eq-color-2' } },
                    { comment: "إذن، ثمن الكراسة هو:", work_eq2: { text: 'ك = ١٦', class: 'final-answer-box' } },
                    { answer: 'ثمن الكراسة <span class="highlight-number">١٦</span> ريالاً، وثمن الحقيبة <span class="highlight-number">٣٩</span> ريالاً.' }
                ]
            },
            {
                id: 'recycling',
                title: '♻️ مثال: تدوير',
                problem: 'جمع محمد ٩ كجم بلاستيك و ٣٠ كجم ورق وباعها بمبلغ ٣٣ ريالاً. وجمع صالح ٩ كجم بلاستيك و ١١٥ كجم ورق وباعها بمبلغ ٥٠ ريالاً. ما سعر الكيلوجرام لكل مادة؟',
                initialEq1: '٩ب + ٣٠و = ٣٣',
                initialEq2: '٩ب + ١١٥و = ٥٠',
                steps: [
                    { comment: "نحدد المتغيرات: <br> ب = سعر كجم البلاستيك، و = سعر كجم الورق" },
                    { comment: "نكتب المعادلات الأساسية من المسألة.", showInitial: true },
                    { comment: "أفضل طريقة هي <b>الحذف بالطرح</b> لأن معاملي (ب) متساويان.", highlight: 'both' },
                    { comment: "نطرح المعادلة الأولى من الثانية:", line: true },
                    { comment: "توضيح عملية الطرح:", result: { text: `(<span class="part-2">٩ب + ١١٥و</span>) - (<span class="part-1">٩ب + ٣٠و</span>) = <span class="part-2">٥٠</span> - <span class="part-1">٣٣</span>` } },
                    { comment: "بعد التبسيط، نحصل على:", result: { text: '٨٥و = ١٧', class: 'eq-color-3' } },
                    { comment: "نحل لإيجاد (و):", result: { text: 'و = ٠.٢', class: 'final-answer-box' } },
                    { comment: "وجدنا أن سعر كجم الورق ٠.٢ ريال. نعوض هذه القيمة في المعادلة الأولى:", work_eq1: { text: `٩ب + ٣٠(<span class="part-2">٠.٢</span>) = ٣٣`, class: 'eq-color-1' } },
                    { comment: "نبسط ونحل لإيجاد (ب):", work_eq1: { text: '٩ب + ٦ = ٣٣ ⟹ ٩ب = ٢٧', class: 'eq-color-3' } },
                    { comment: "إذن، سعر كجم البلاستيك هو:", work_eq1: { text: 'ب = ٣', class: 'final-answer-box' } },
                    { answer: 'سعر كجم البلاستيك <span class="highlight-number">٣</span> ريالات، وسعر كجم الورق <span class="highlight-number">٠.٢</span> ريال (٢٠ هللة).' }
                ]
            }
        ];

        const appsContainer = document.getElementById('real-life-apps-container');
        appsContainer.innerHTML = ''; // Clear previous content
        realLifeApps.forEach(app => {
            const appDiv = document.createElement('div');
            appDiv.className = 'p-4 bg-white rounded-lg shadow';
            appDiv.innerHTML = `
                <p class="text-lg font-semibold mb-2">${app.title}</p>
                <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                    <p>${app.problem}</p>
                </div>
                <div id="visual-workspace-${app.id}" class="visual-workspace space-y-3 text-center min-h-[250px] flex flex-col justify-center items-center">
                    <!-- Initial equations will be shown here -->
                    <div id="initial-eqs-${app.id}" class="mb-4 opacity-0 transition-opacity duration-500">
                        <p class="math-eq eq-color-1">${app.initialEq1}</p><br>
                        <p class="math-eq eq-color-2">${app.initialEq2}</p>
                    </div>
                    <!-- Working area for steps -->
                    <div id="working-area-${app.id}" class="inline-flex flex-col items-center space-y-2 w-full">
                        <p id="work-eq1-${app.id}" class="math-eq opacity-0"></p>
                        <p id="work-eq2-${app.id}" class="math-eq opacity-0"></p>
                        <div class="flex items-center justify-center w-full">
                            <div class="flex flex-col items-center flex-1">
                                <div id="line-${app.id}" class="border-t-2 border-gray-700 my-2 opacity-0 transition-opacity w-full max-w-xs"></div>
                                <p id="result-${app.id}" class="math-eq opacity-0 w-full"></p>
                            </div>
                        </div>
                    </div>
                    <p id="temp-comment-${app.id}" class="temp-comment text-purple-700 font-semibold"></p>
                </div>
                <div class="flex justify-between mt-6">
                    <button data-example="${app.id}" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                    <div>
                        <button data-example="${app.id}" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                        <button data-example="${app.id}" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                    </div>
                </div>
            `;
            appsContainer.appendChild(appDiv);
        });
        
        const examples = {};
        realLifeApps.forEach(app => {
            const elCache = {
                workspace: document.getElementById(`visual-workspace-${app.id}`),
                initialEqs: document.getElementById(`initial-eqs-${app.id}`),
                initialEq1: document.querySelector(`#initial-eqs-${app.id} .eq-color-1`),
                initialEq2: document.querySelector(`#initial-eqs-${app.id} .eq-color-2`),
                work_eq1: document.getElementById(`work-eq1-${app.id}`),
                work_eq2: document.getElementById(`work-eq2-${app.id}`),
                line: document.getElementById(`line-${app.id}`),
                result: document.getElementById(`result-${app.id}`),
                comment: document.getElementById(`temp-comment-${app.id}`),
            };
            examples[app.id] = {
                totalSteps: app.steps.length - 1,
                currentIndex: -1,
                steps: app.steps,
                elements: elCache,
                nextBtn: document.querySelector(`button.next-btn[data-example="${app.id}"]`),
                prevBtn: document.querySelector(`button.prev-btn[data-example="${app.id}"]`),
                resetBtn: document.querySelector(`button.reset-btn[data-example="${app.id}"]`),
                runStep: function(index) { runStepGeneric(app.id, index); }
            };
            setupExample(examples[app.id]);
        });
        
        function setupExample(ex) {
            ex.nextBtn.addEventListener('click', () => {
                if (ex.currentIndex < ex.totalSteps) { ex.currentIndex++; ex.runStep(ex.currentIndex); }
            });
            ex.prevBtn.addEventListener('click', () => {
                if (ex.currentIndex > -1) { ex.currentIndex--; ex.runStep(ex.currentIndex); }
            });
            ex.resetBtn.addEventListener('click', () => {
                ex.currentIndex = -1; ex.runStep(ex.currentIndex);
            });
            ex.runStep(-1);
        }

        function updateButtons(ex) {
            ex.prevBtn.disabled = ex.currentIndex <= -1;
            ex.nextBtn.classList.toggle('hidden', ex.currentIndex >= ex.totalSteps);
            ex.resetBtn.classList.toggle('hidden', ex.currentIndex < ex.totalSteps);
        }

        function runStepGeneric(id, index) {
            const ex = examples[id];
            const els = ex.elements;
            
            // Reset state
            els.workspace.classList.remove('visible');
            els.initialEqs.style.opacity = '0';
            [els.initialEq1, els.initialEq2].forEach(el => el.classList.remove('target-term'));
            [els.work_eq1, els.work_eq2, els.result].forEach(el => {
                el.innerHTML = ''; el.style.opacity = '0'; el.className = 'math-eq opacity-0';
            });
            els.line.style.opacity = '0';
            els.comment.innerHTML = '';
            
            if (index > -1) els.workspace.classList.add('visible');
            
            // Apply states up to current index
            for (let i = 0; i <= index; i++) {
                const step = ex.steps[i];
                if (step.comment) els.comment.innerHTML = step.comment;
                if (step.showInitial) els.initialEqs.style.opacity = '1';
                if (step.highlight) {
                    if (step.highlight === 1 || step.highlight === 'both') els.initialEq1.classList.add('target-term');
                    if (step.highlight === 2 || step.highlight === 'both') els.initialEq2.classList.add('target-term');
                }
                if (step.work_eq1) { els.work_eq1.innerHTML = step.work_eq1.text; els.work_eq1.className = `math-eq ${step.work_eq1.class}`; els.work_eq1.style.opacity = '1'; }
                if (step.work_eq2) { els.work_eq2.innerHTML = step.work_eq2.text; els.work_eq2.className = `math-eq ${step.work_eq2.class}`; els.work_eq2.style.opacity = '1'; }
                if (step.line) els.line.style.opacity = '1';
                if (step.result) { els.result.innerHTML = step.result.text; els.result.className = `math-eq ${step.result.class || ''}`; els.result.style.opacity = '1'; }
                if (step.answer) { els.comment.innerHTML = `<div class="p-3 rounded-lg font-bold text-lg final-answer-box">${step.answer}</div>`; }
            }
            updateButtons(ex);
        }

        // --- Quiz Section ---
        const quizQuestions = generateQuiz();
        initializeQuiz(LESSON_ID, quizQuestions, null);
        
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    });

    function generateQuiz() {
        const questionBank = [
            { text: 'ما هي أفضل طريقة لحل النظام التالي؟<br><span class="math-eq">س = ٤ص + ٧</span><br><span class="math-eq">٢س - ٣ص = ٩</span>', options: [ { display: 'التمثيل البياني', value: 'a' }, { display: 'التعويض', value: 'b' }, { display: 'الحذف بالجمع', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], correct: 'b', explanation: 'التعويض هو الأفضل لأن المعادلة الأولى معطاة بدلالة (س)، مما يسهل تعويضها مباشرة في المعادلة الثانية.' },
            { text: 'حدد الطريقة الأنسب لحل النظام:<br><span class="math-eq">٤س + ٢ص = ١٤</span><br><span class="math-eq">٦س - ٢ص = ٦</span>', options: [ { display: 'التعويض', value: 'a' }, { display: 'الحذف بالطرح', value: 'b' }, { display: 'الحذف بالجمع', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], correct: 'c', explanation: 'الحذف بالجمع هو الأنسب لأن معاملي المتغير (ص) (+٢ و -٢) هما معكوسان جمعيان لبعضهما.' },
            { text: 'ما الطريقة التي ستستخدمها لحل النظام:<br><span class="math-eq">ص = ٣س - ٥</span><br><span class="math-eq">ص = -٢س + ١٥</span>', options: [ { display: 'التعويض أو التمثيل البياني', value: 'a' }, { display: 'الحذف بالجمع', value: 'b' }, { display: 'الحذف بالطرح', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], correct: 'a', explanation: 'بما أن كلتا المعادلتين محلولتان بالنسبة لـ(ص)، فالتعويض (بمساواة المعادلتين: ٣س - ٥ = -٢س + ١٥) هو خيار ممتاز. كذلك، صيغة الميل والمقطع تجعل التمثيل البياني سهلاً لتقدير الحل.' },
            { text: 'لحل النظام: <span class="math-eq">٥س + ٣ص = ١١</span> و <span class="math-eq">٢س + ٤ص = ١٢</span>، ما هي الطريقة الأكثر فعالية؟', options: [ { display: 'التعويض', value: 'a' }, { display: 'الحذف بالجمع', value: 'b' }, { display: 'الحذف بالطرح', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], correct: 'd', explanation: 'الحذف بالضرب هو الأكثر فعالية لأنه لا يوجد أي معامل يساوي ١ أو -١، والمعاملات ليست متساوية أو متعاكسة. ستحتاج إلى ضرب المعادلتين لجعل أحد المعاملات متعاكساً (مثلاً، ضرب الأولى في -٢ والثانية في ٥ لحذف س).' },
            { text: 'أي نظام من الأنظمة التالية هو الأنسب للحل بطريقة الحذف بالطرح؟', options: [ { display: '<span class="math-eq">س+ص=٥<br>س-ص=١</span>', value: 'a' }, { display: '<span class="math-eq">٢س+٣ص=٧<br>٢س-٥ص=١</span>', value: 'b' }, { display: '<span class="math-eq">ص=س+١<br>٢س+ص=٤</span>', value: 'c' }, { display: '<span class="math-eq">٣س+٢ص=٨<br>٢س+٣ص=٧</span>', value: 'd' } ], correct: 'b', explanation: 'النظام في الخيار (ب) هو الأنسب للحذف بالطرح لأن معاملي المتغير (س) متساويان (كلاهما ٢)، مما يسمح بحذفه مباشرة عند طرح المعادلتين.' }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 4); // Select 4 random questions
    }

    </script>
</body>
</html>

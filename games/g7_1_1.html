<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù‡Ù…Ø© Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø¥ØºØ§Ø«Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© - g7_1_1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 420px; background: white; border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; height: 95vh; max-height: 680px; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 10px; font-weight: 800; color: #64748b;
        }
        .btn-touch { min-height: 48px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.96); }
        
        .monomial-container { display: inline-flex; align-items: center; direction: rtl; gap: 0px; }
        .math-var { font-family: 'Cairo', sans-serif; font-weight: 900; color: #064e3b; font-size: 1.2em; line-height: 1; }
        .math-exp { 
            position: relative; top: -0.5em; font-size: 0.55em; font-weight: 900; 
            color: #10b981; margin-right: 1px; margin-left: 1px; line-height: 0; display: inline-block;
        }
        
        .screen { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 1rem; width: 100%; gap: 0.5rem; }
        .hidden { display: none !important; }

        .choices-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; width: 100%; }
        .choice-btn { border: 2px solid #e2e8f0; transition: all 0.2s; background: white; padding: 10px 2px; border-radius: 0.85rem; font-size: 0.95rem; font-weight: 900; }
        .choice-btn.correct { border-color: #10b981 !important; background-color: #f0fdf4 !important; color: #166534 !important; }
        .choice-btn.wrong { border-color: #ef4444 !important; background-color: #fef2f2 !important; color: #991b1b !important; }
        
        .leaderboard-modal { position: absolute; inset: 0; background: #ffffff; z-index: 200; display: flex; flex-direction: column; padding: 1rem; transition: all 0.3s; }
        .tab-btn { flex: 1; padding: 6px; font-size: 10px; font-weight: bold; border-radius: 6px; }
        .tab-active { background-color: #10b981; color: white; }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; }

        .feedback-overlay {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(2px);
            z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1.5rem;
        }
        .feedback-card { background: white; border-radius: 1.5rem; width: 100%; max-width: 320px; padding: 1.25rem; text-align: center; border: 3px solid #e2e8f0; }

        @keyframes truck-move { 0% { transform: translateX(3px); } 50% { transform: translateX(-3px); } 100% { transform: translateX(3px); } }
        .truck-anim { animation: truck-move 3s ease-in-out infinite; }
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .timer-badge { background: #fef3c7; color: #92400e; padding: 1px 6px; border-radius: 999px; font-size: 9px; font-weight: 900; border: 1px solid #fde68a; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-2 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-1.5 overflow-hidden">
                <i class="fas fa-hand-holding-heart text-emerald-500"></i>
                <span id="top-student-name" class="truncate font-black text-emerald-900">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..</span>
            </div>
            <div class="flex items-center gap-1.5 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-emerald-400"></i></span>
                <i class="fas fa-medal text-yellow-500 text-[9px]"></i>
                <span id="top-prev-score" class="text-[10px] text-emerald-700">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
        <div id="start-screen" class="screen text-center justify-center">
            <div class="mb-4">
                <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-emerald-50 shadow-sm">
                    <i class="fas fa-truck-fast text-emerald-600 text-3xl truck-anim"></i>
                </div>
                <h1 class="text-lg font-black text-emerald-900 leading-tight">Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù„Ùƒ Ø³Ù„Ù…Ø§Ù† Ù„Ù„Ø¥ØºØ§Ø«Ø©<br><span class="text-xs text-emerald-600 font-bold">Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ (Ù§ Ù‚ÙˆØ§ÙÙ„)</span></h1>
            </div>
            
            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 text-[10px] font-bold text-emerald-800 leading-relaxed text-right mb-4">
                Ø¨ØµÙØªÙƒ Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØŒ Ø§Ø­Ø³Ø¨ <span class="text-emerald-950 underline">Ù‚.Ù….Ø£</span> Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ù„Ù€ <span class="font-black text-emerald-900">Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ù‰</span> Ø¨Ø§Ù„Ø¹Ø¯Ù„ ÙˆØ§Ù„Ù…Ø³Ø§ÙˆØ§Ø©.
            </div>
            
            <div class="flex flex-row gap-2">
                <button onclick="goToBriefing(1)" class="btn-touch flex-[3] bg-emerald-600 text-white shadow-lg text-base hover:bg-emerald-700 transition-colors">
                    Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© <i class="fas fa-arrow-left mr-1.5 text-sm"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-emerald-600 border border-emerald-200 text-[9px] flex-col py-1">
                    <i class="fas fa-trophy text-yellow-500 text-lg mb-0.5"></i>
                    <span>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
            <p class="text-[9px] text-slate-400 font-bold uppercase mt-4 text-center">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠØ© -->
        <div id="briefing-1" class="screen hidden">
            <h2 class="text-base font-black text-emerald-900 mb-2 border-b pb-1 flex items-center">
                <i class="fas fa-boxes-stacked ml-2 text-emerald-600"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²
            </h2>
            <div class="space-y-2 flex-1 overflow-y-auto pr-1 text-right">
                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 flex items-center gap-3">
                    <span class="text-emerald-900 font-black text-xl">Ø·</span>
                    <span class="text-[9px] font-bold text-slate-600 leading-tight"><b>Ø·Ø§Ù‚Ù… Ø·Ø¨ÙŠ:</b> Ù…Ø¹ÙˆÙ†Ø§Øª ØµØ­ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©.</span>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex items-center gap-3">
                    <span class="text-blue-900 font-black text-xl">Ø³</span>
                    <span class="text-[9px] font-bold text-slate-600 leading-tight"><b>Ø³Ù„Ø© ØºØ°Ø§Ø¦ÙŠØ©:</b> ØªÙƒÙÙŠ Ù„Ø£Ø³Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.</span>
                </div>
                <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 flex items-center gap-3">
                    <span class="text-amber-700 font-black text-xl">Ø®</span>
                    <span class="text-[9px] font-bold text-slate-600 leading-tight"><b>Ø®ÙŠÙ…Ø© Ø¥ÙŠÙˆØ§Ø¡:</b> Ù…Ø¬Ù‡Ø²Ø© Ù„Ù„Ø³ÙƒÙ† Ø§Ù„Ù…Ø¤Ù‚Øª.</span>
                </div>
                <div class="bg-purple-50 p-3 rounded-xl border border-purple-100 flex items-center gap-3">
                    <span class="text-purple-900 font-black text-xl">Ø¨</span>
                    <span class="text-[9px] font-bold text-slate-600 leading-tight"><b>Ø¨Ø·Ø§Ù†ÙŠØ©:</b> Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø±Ø¯.</span>
                </div>
                <p class="text-[8px] font-black text-emerald-600 italic text-center mt-1">* Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (Ø·<span class="math-exp">Ù¢</span>) ØªØ¹Ù†ÙŠ Ø¹Ø¨ÙˆØ§Øª Ù…Ø¯Ù…Ø¬Ø©.</p>
            </div>
            <button onclick="goToBriefing(2)" class="btn-touch bg-emerald-600 text-white mt-2 shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left mr-1 text-sm"></i></button>
        </div>

        <div id="briefing-2" class="screen hidden">
            <h2 class="text-base font-black text-emerald-900 mb-2 border-b pb-1 flex items-center">
                <i class="fas fa-scale-balanced ml-2 text-blue-600"></i> Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø¹Ø¯Ø§Ù„Ø©
            </h2>
            <div class="space-y-3 flex-1 text-[10px] font-bold text-slate-600 leading-relaxed text-right">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                    <p class="text-blue-800 font-black underline mb-2">Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ù‚.Ù….Ø£):</p>
                    <p class="text-slate-700">ÙŠØ­Ø¯Ø¯ <b class="text-blue-900">Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ù‰</b> Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø§Øª Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ ÙØ§Ø¦Ø¶ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.</p>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <p class="text-slate-800 italic text-[9px] text-center"><i class="fas fa-stopwatch ml-1 text-amber-500"></i> Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² ØªØ±ÙØ¹ ØªØ±ØªÙŠØ¨Ùƒ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>
                </div>
            </div>
            <button onclick="startActualGame()" class="btn-touch bg-emerald-600 text-white mt-2 shadow-md">Ø§Ù†Ø·Ù„Ù‚ Ø¨Ø¨Ø±ÙƒØ© Ø§Ù„Ù„Ù‡ <i class="fas fa-shipping-fast mr-1 text-sm"></i></button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="game-screen" class="screen hidden bg-emerald-50/20">
            <div class="flex justify-between items-center bg-white p-2 rounded-xl border border-emerald-100 shadow-sm">
                <span class="text-[9px] font-black text-emerald-700 uppercase"><i class="fas fa-truck ml-1"></i> Ø§Ù„Ù‚Ø§ÙÙ„Ø© <span id="current-q">Ù¡</span> / Ù§</span>
                <div class="flex items-center gap-2">
                    <div class="timer-badge"><i class="fas fa-clock mr-1"></i> <span id="live-timer">Ù Ù </span> Ø«</div>
                    <div class="flex gap-0.5" id="stars-container"></div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border-2 border-emerald-100 text-center relative shadow-sm mt-1">
                <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-emerald-500 text-white text-[7px] px-3 py-0.5 rounded-full font-black shadow-sm uppercase">Ø£Ù…Ø± ØªÙˆØ²ÙŠØ¹ Ø¹Ø§Ø¬Ù„</div>
                <p class="text-[10px] font-bold text-slate-500 mb-3 mt-2 leading-tight px-1">Ø¨ØµÙØªÙƒ Ø§Ù„Ù‚Ø§Ø¦Ø¯ØŒ Ø§Ø­Ø³Ø¨ <span class="text-emerald-700 font-black underline">Ù‚.Ù….Ø£</span> Ù„ØªÙˆØ²ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø´Ø§Ø­Ù†ØªÙŠÙ† Ø¹Ù„Ù‰ <span class="text-emerald-700 font-black">Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ù‰</span>:</p>
                <div id="question-text" class="text-xl font-black text-emerald-900 flex flex-wrap justify-center gap-3 items-center min-h-[50px]"></div>
            </div>

            <div id="choices-grid" class="choices-grid mt-2"></div>
            <div class="mt-auto text-center"><p id="feedback-text" class="text-[9px] font-black text-slate-400">Ø­Ù„Ù„ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ Ø°Ù‡Ù†ÙŠØ§Ù‹ ÙˆØ§ÙƒØªØ´Ù Ù‚.Ù….Ø£..</p></div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
        <div id="feedback-popup" class="feedback-overlay hidden">
            <div class="feedback-card shadow-2xl" id="feedback-card-inner">
                <div id="feedback-icon" class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 border-4"></div>
                <h3 id="feedback-title" class="text-lg font-black mb-1"></h3>
                <div id="feedback-msg" class="text-[10px] font-bold text-slate-600 leading-relaxed mb-4 space-y-1 text-center"></div>
                <button onclick="nextQuestion()" class="btn-touch w-full bg-emerald-600 text-white text-base">Ù…ØªØ§Ø¨Ø¹Ø© <i class="fas fa-arrow-left mr-1.5 text-sm"></i></button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Modal) -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden">
            <div class="flex justify-between items-center mb-3 border-b pb-2">
                <h3 class="font-black text-slate-800 text-base"><i class="fas fa-medal text-yellow-500 ml-1.5"></i>Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„Ù‚Ø§Ø¯Ø©</h3>
                <button onclick="closeLeaderboardModal()" class="w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-1.5 mb-3">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-xl border border-slate-100 p-0.5 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><i class="fas fa-sync sync-loader text-emerald-500 text-2xl"></i></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø®ØªØ§Ù… -->
        <div id="result-screen" class="screen hidden text-center justify-center">
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-4"></div>
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 mb-4 shadow-sm">
                <i class="fas fa-award text-yellow-500 text-4xl mb-2 animate-bounce"></i>
                <p class="font-black text-emerald-900 text-[11px] italic leading-relaxed px-2">Ø¨ÙØ¶Ù„ Ø³Ø±Ø¹ØªÙƒ ÙˆØ¯Ù‚ØªÙƒ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©ØŒ ÙˆØµÙ„Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù…Ø³ØªØ­Ù‚ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø¹Ø¯Ù„ ÙˆØ§Ù„Ù…Ø³Ø§ÙˆØ§Ø©. Ù…Ù‡Ù…Ø© ÙˆØ·Ù†ÙŠØ© Ù†Ø§Ø¬Ø­Ø©!</p>
            </div>
            <div class="flex flex-col gap-1.5">
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white shadow-md text-sm">
                    <i class="fas fa-crown ml-1.5 text-xs"></i> Ø³Ø¬Ù„ Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©
                </button>
                <div class="flex gap-1.5">
                    <button onclick="location.reload()" class="btn-touch flex-1 bg-emerald-100 text-emerald-700 font-bold text-xs">Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <button id="finish-btn" class="btn-touch flex-1 bg-slate-900 text-white font-bold text-xs">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = 'g7_1_1';
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || "Ø¨Ø·Ù„ Ø§Ù„Ø¥ØºØ§Ø«Ø©");
        let score = 0, currentQuestionIdx = 0, startTime, questions = [], timerInterval;
        let currentLeaderboardMode = classId ? 'class' : 'global';

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

        const villageNames = ["Ø§Ù„Ø£ÙˆÙ„Ù‰", "Ø§Ù„Ø«Ø§Ù†ÙŠØ©", "Ø§Ù„Ø«Ø§Ù„Ø«Ø©", "Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", "Ø§Ù„Ø®Ø§Ù…Ø³Ø©", "Ø§Ù„Ø³Ø§Ø¯Ø³Ø©", "Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©"];
        const numToWord = (n) => ({ 
            1: "Ø·Ù‚Ù…", 2: "Ø·Ù‚Ù…ÙŠÙ†", 3: "Ø«Ù„Ø§Ø«Ø©", 4: "Ø£Ø±Ø¨Ø¹Ø©", 5: "Ø®Ù…Ø³Ø©", 6: "Ø³ØªØ©", 
            7: "Ø³Ø¨Ø¹Ø©", 8: "Ø«Ù…Ø§Ù†ÙŠØ©", 9: "ØªØ³Ø¹Ø©", 10: "Ø¹Ø´Ø±Ø©", 12: "Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±", 15: "Ø®Ù…Ø³Ø© Ø¹Ø´Ø±" 
        })[n] || toAr(n);

        const namesMap = { 'Ø·': "Ø·ÙˆØ§Ù‚Ù… Ø·Ø¨ÙŠØ©", 'Ø³': "Ø³Ù„Ø§Ù„ ØºØ°Ø§Ø¦ÙŠØ©", 'Ø®': "Ø®ÙŠØ§Ù… Ø¥ÙŠÙˆØ§Ø¡", 'Ø¨': "Ø¨Ø·Ø§Ù†ÙŠØ§Øª Ø´ØªÙˆÙŠØ©", 'Ù…': "ÙˆØ­Ø¯Ø§Øª Ù…ÙŠØ§Ù‡", 'Ùƒ': "Ø­Ù‚Ø§Ø¦Ø¨ ØªØ¹Ù„ÙŠÙ…ÙŠØ©" };

        const questionBank = [
            [ { c1: 15, v1: { 'Ø·': 1 }, c2: 10, v2: { 'Ø·': 2 } }, { c1: 12, v1: { 'Ø³': 1 }, c2: 8, v2: { 'Ø³': 2 } }, { c1: 20, v1: { 'Ø·': 2 }, c2: 25, v2: { 'Ø·': 1 } } ],
            [ { c1: 12, v1: { 'Ø³': 1, 'Ø·': 2 }, c2: 18, v2: { 'Ø³': 2, 'Ø·': 1 } }, { c1: 15, v1: { 'Ø³': 1, 'Ùƒ': 2 }, c2: 25, v2: { 'Ø³': 2, 'Ùƒ': 1 } }, { c1: 14, v1: { 'Ø·': 1, 'Ø®': 2 }, c2: 21, v2: { 'Ø·': 2, 'Ø®': 1 } } ],
            [ { c1: 20, v1: { 'Ø®': 2, 'Ø³': 1 }, c2: 30, v2: { 'Ø®': 3, 'Ø³': 2 } }, { c1: 12, v1: { 'Ø¨': 3, 'Ø³': 2 }, c2: 16, v2: { 'Ø¨': 2, 'Ø³': 4 } }, { c1: 18, v1: { 'Ù…': 2, 'Ùƒ': 3 }, c2: 27, v2: { 'Ù…': 4, 'Ùƒ': 2 } } ],
            [ { c1: 14, v1: { 'Ø¨': 3, 'Ø·': 1 }, c2: 21, v2: { 'Ø¨': 2, 'Ø·': 2 } }, { c1: 15, v1: { 'Ø³': 3, 'Ù…': 2 }, c2: 10, v2: { 'Ø³': 2, 'Ù…': 3 } }, { c1: 24, v1: { 'Ø®': 4, 'Ø¨': 2 }, c2: 16, v2: { 'Ø®': 2, 'Ø¨': 3 } } ],
            [ { c1: 16, v1: { 'Ù…': 2, 'Ø³': 1 }, c2: 24, v2: { 'Ù…': 3, 'Ø³': 1 } }, { c1: 12, v1: { 'Ùƒ': 2, 'Ø·': 1 }, c2: 18, v2: { 'Ùƒ': 1, 'Ø·': 2 } }, { c1: 20, v1: { 'Ø¨': 3, 'Ø®': 2 }, c2: 15, v2: { 'Ø¨': 2, 'Ø®': 3 } } ],
            [ { c1: 27, v1: { 'Ùƒ': 1, 'Ø³': 2 }, c2: 18, v2: { 'Ùƒ': 2, 'Ø³': 1 } }, { c1: 24, v1: { 'Ø·': 2, 'Ù…': 1 }, c2: 16, v2: { 'Ø·': 1, 'Ù…': 2 } }, { c1: 30, v1: { 'Ø®': 2, 'Ø³': 2 }, c2: 20, v2: { 'Ø®': 3, 'Ø³': 1 } } ],
            [ { c1: 24, v1: { 'Ø·': 2, 'Ø³': 2, 'Ø®': 1 }, c2: 36, v2: { 'Ø·': 1, 'Ø³': 3, 'Ø®': 2 } }, { c1: 30, v1: { 'Ø³': 2, 'Ø¨': 3, 'Ù…': 1 }, c2: 45, v2: { 'Ø³': 3, 'Ø¨': 2, 'Ù…': 2 } }, { c1: 18, v1: { 'Ù…': 2, 'Ùƒ': 2, 'Ø®': 3 }, c2: 27, v2: { 'Ù…': 1, 'Ùƒ': 3, 'Ø®': 2 } } ]
        ];

        function formatMonomial(coeff, vars_map) {
            let html = `<div class="monomial-container">`;
            let hasVars = Object.values(vars_map).some(v => v > 0);
            if (coeff !== 1 || !hasVars) html += `<span class="math-var">${toAr(coeff)}</span>`;
            for (let v in vars_map) {
                if (vars_map[v] > 0) {
                    html += `<span class="math-var">${v}</span>`;
                    if (vars_map[v] > 1) html += `<span class="math-exp">${toAr(vars_map[v])}</span>`;
                }
            }
            return html + `</div>`;
        }

        function getArabicDescription(coeff, vars_map, mathHtml) {
            let parts = Object.entries(vars_map).filter(([v,p]) => p > 0).map(([v]) => namesMap[v] || v);
            let temp = document.createElement('div'); temp.innerHTML = mathHtml;
            return `Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ <b>${numToWord(coeff)}</b> Ù…Ù† <b>${parts.join(' Ùˆ ')}</b> Ø¨Ù…Ù‚Ø¯Ø§Ø± (${temp.innerText.trim()})`;
        }

        window.goToBriefing = (step) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(`briefing-${step}`).classList.remove('hidden');
        };

        window.startActualGame = () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-screen').classList.remove('hidden');
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('live-timer').innerText = toAr(elapsed);
            }, 1000);
            questions = questionBank.map(pool => {
                const q = pool[Math.floor(Math.random() * pool.length)];
                const gCoeff = gcd(q.c1, q.c2);
                const gVars = {}; Object.keys(q.v1).forEach(v => { if(q.v2[v]) gVars[v] = Math.min(q.v1[v], q.v2[v]); });
                const correctHtml = formatMonomial(gCoeff, gVars);
                const options = [correctHtml, formatMonomial(gCoeff, { ...gVars, [Object.keys(gVars)[0] || 'Ø·']: (gVars[Object.keys(gVars)[0]] || 1) + 1 }), formatMonomial(gCoeff + 2, gVars), formatMonomial(1, gVars)].sort(() => Math.random() - 0.5);
                return { t1: formatMonomial(q.c1, q.v1), t2: formatMonomial(q.c2, q.v2), correct: correctHtml, options, gCoeff, gVars };
            });
            loadQuestion();
        };

        function loadQuestion() {
            const q = questions[currentQuestionIdx];
            document.getElementById('current-q').textContent = toAr(currentQuestionIdx + 1);
            document.getElementById('question-text').innerHTML = `${q.t1} <span class="text-emerald-200 mx-2 text-2xl font-light">ØŒ</span> ${q.t2}`;
            const grid = document.getElementById('choices-grid'); grid.innerHTML = "";
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "choice-btn btn-touch shadow-sm text-emerald-900";
                btn.innerHTML = opt; btn.onclick = () => checkAnswer(opt, btn); grid.appendChild(btn);
            });
        }

        function checkAnswer(selected, btn) {
            const q = questions[currentQuestionIdx];
            document.querySelectorAll('.choice-btn').forEach(b => b.onclick = null);
            const isCorrect = (selected === q.correct);
            const popup = document.getElementById('feedback-popup');
            const fullDesc = getArabicDescription(q.gCoeff, q.gVars, q.correct);

            if (isCorrect) {
                score++; btn.classList.add('correct');
                document.getElementById('feedback-title').innerText = "Ø¥Ù†Ø¬Ø§Ø² ØµØ­ÙŠØ­!";
                document.getElementById('feedback-title').className = "text-lg font-black mb-1 text-emerald-600";
                document.getElementById('feedback-icon').className = "w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-emerald-100 bg-emerald-50 text-emerald-600 text-2xl shadow-inner";
                document.getElementById('feedback-icon').innerHTML = '<i class="fas fa-check"></i>';
                document.getElementById('feedback-msg').innerHTML = `<p>${fullDesc}</p><p class="mt-1 text-slate-500">ØªÙ…Øª Ø®Ø¯Ù…Ø© Ø§Ù„Ù‚Ø±ÙŠØ© <b>${villageNames[currentQuestionIdx]}</b> Ø¨Ù†Ø¬Ø§Ø­.</p>`;
            } else {
                btn.classList.add('wrong');
                document.querySelectorAll('.choice-btn').forEach(b => { if (b.innerHTML === q.correct) b.classList.add('correct'); });
                document.getElementById('feedback-title').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹";
                document.getElementById('feedback-title').className = "text-lg font-black mb-1 text-red-600";
                document.getElementById('feedback-icon').className = "w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-red-100 bg-red-50 text-red-600 text-2xl shadow-inner";
                document.getElementById('feedback-icon').innerHTML = '<i class="fas fa-times"></i>';
                document.getElementById('feedback-msg').innerHTML = `<p class="text-red-500">Ù‚.Ù….Ø£ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ <b>(${q.correct})</b>.</p><p>ÙƒØ§Ù† ÙŠØ¬Ø¨ ØªÙˆØ²ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø³Ø§ÙˆØ§Ø©.</p>`;
            }
            setTimeout(() => popup.classList.remove('hidden'), 1800);
        }

        window.nextQuestion = () => {
            document.getElementById('feedback-popup').classList.add('hidden');
            currentQuestionIdx++; if (currentQuestionIdx < 7) loadQuestion(); else finalizeGame();
        };

        function finalizeGame() {
            clearInterval(timerInterval);
            const duration = Math.floor((Date.now() - startTime) / 1000);
            const grade = ((score/7)*5).toFixed(1);
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-white p-2 rounded-xl border border-emerald-100 flex flex-col items-center shadow-sm">
                    <span class="text-[8px] font-black text-emerald-500 uppercase mb-0.5">Ø§Ù„Ù†Ø¬Ø§Ø­</span><span class="text-xs font-black">${toAr(score)} / Ù§</span>
                </div>
                <div class="bg-emerald-600 p-2 rounded-xl flex flex-col items-center shadow-md">
                    <span class="text-[8px] font-black text-white/70 uppercase mb-0.5">Ø§Ù„Ø¯Ø±Ø¬Ø©</span><span class="text-lg font-black text-white">${toAr(grade)}</span>
                </div>
                <div class="bg-white p-2 rounded-xl border border-emerald-100 flex flex-col items-center shadow-sm">
                    <span class="text-[8px] font-black text-emerald-500 uppercase mb-0.5">Ø§Ù„Ø²Ù…Ù†</span><span class="text-xs font-black">${toAr(duration)} Ø«</span>
                </div>`;
            if (studentId && classId) saveScore(grade, duration);
        }

        async function saveScore(g, met) {
            try { await fetch(`${SCRIPT_URL}?action=saveScore&studentId=${studentId}&classId=${classId}&itemId=${GAME_ID}&score=${g}&metricValue=${met}&type=game`); } catch(e){}
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) modal.classList.remove('hidden');
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            fetch(`${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[9px]"><thead><tr class="text-slate-400 border-b"><th class="p-1">#</th><th class="p-1">Ø§Ù„Ù‚Ø§Ø¦Ø¯</th><th class="p-1">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody>`;
                    data.forEach((p, i) => {
                        const isMe = (studentId && String(p.name).trim() === String(studentName).trim());
                        h += `<tr class="${isMe ? 'rank-row-me' : ''} border-b border-slate-50"><td class="p-1.5">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td><td class="p-1.5 font-black">${p.name}</td><td class="p-1.5 text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))} <span class="text-[7px] text-slate-400 block">${toAr(p.metric || 0)} Ø«</span></td></tr>`;
                    });
                    document.getElementById('leaderboard-content').innerHTML = h + `</tbody></table>`;
                } else document.getElementById('leaderboard-content').innerHTML = `<p class="py-6 text-center text-xs italic">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª..</p>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (mode) => {
            currentLeaderboardMode = mode;
            document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            fetchAndShowLeaderboard(false);
        };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.add('hidden');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            if (!classId) document.getElementById('tab-class').style.display = 'none';
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
            if (studentId && classId) {
                document.getElementById('sync-icon').classList.remove('hidden'); 
                fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${classId}&itemId=${GAME_ID}`).then(r=>r.json()).then(res=>{
                    if(res.data && res.data.games[GAME_ID]) document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                }).finally(()=>document.getElementById('sync-icon').classList.add('hidden'));
            }
        });
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>درس تفاعلي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .hidden { display: none; }
        .tab-content { padding-bottom: 90px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Banner Style Matching Main Platform */
        .header-banner {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 0 0 2rem 2rem;
            box-shadow: 0 10px 30px -10px rgba(37, 99, 235, 0.4);
            position: relative;
            overflow: hidden;
        }
        .banner-bg-num { position: absolute; bottom: -10px; left: 10px; font-weight: 900; font-size: 6rem; color: rgba(255,255,255,0.1); line-height: 1; pointer-events: none; }
        
        .game-btn { transition: all 0.2s ease; active:scale-95; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 10px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.7rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px; font-weight: 600; }
        .nav-item.active { color: #2563eb; font-weight: 800; transform: translateY(-2px); }
        .nav-item.active i { color: #2563eb; }
        
        /* Loader */
        .saving-loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- الرأس بتصميم المنصة -->
    <header class="header-banner pt-4 pb-8 px-4 mb-6">
        <!-- رقم خلفي جمالي -->
        <span class="banner-bg-num" id="chapter-bg-num">6</span>
        
        <div class="flex justify-between items-start mb-4 relative z-10">
            <a href="index.html" class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold hover:bg-white/20 transition text-white border border-white/20">
                <i class="fas fa-arrow-right"></i> خروج
            </a>
            <div class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-white border border-white/20">
                <i class="fas fa-user"></i> <span id="student-name-display">زائر</span>
            </div>
        </div>

        <div class="text-center relative z-10">
            <div class="w-12 h-12 mx-auto bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center mb-2 border border-white/20 shadow-lg">
                <i class="fas fa-graduation-cap text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black mb-1" id="lesson-title-display">جاري التحميل...</h1>
            <p class="text-blue-200 text-sm font-bold" id="chapter-title-display">الوحدة...</p>
        </div>
    </header>

    <!-- المحتوى -->
    <main class="container mx-auto max-w-md p-4 mb-20 relative -top-10">
        
        <!-- أزرار الألعاب العائمة -->
        <div class="flex justify-center gap-3 mb-6">
            <button id="btn-game-1" class="game-btn bg-white border border-gray-100 p-3 rounded-2xl shadow-lg flex flex-col items-center w-28 h-24 justify-center group">
                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mb-1 group-hover:scale-110 transition"><i class="fas fa-gamepad"></i></div>
                <span class="text-xs font-bold text-gray-600 line-clamp-1" id="label-game-1">لعبة 1</span>
                <span class="text-[10px] text-gray-400 mt-1">ابدأ اللعب</span>
            </button>
            <button id="btn-game-2" class="game-btn bg-white border border-gray-100 p-3 rounded-2xl shadow-lg flex flex-col items-center w-28 h-24 justify-center group">
                <div class="w-8 h-8 rounded-full bg-violet-100 text-violet-600 flex items-center justify-center mb-1 group-hover:scale-110 transition"><i class="fas fa-puzzle-piece"></i></div>
                <span class="text-xs font-bold text-gray-600 line-clamp-1" id="label-game-2">لعبة 2</span>
                <span class="text-[10px] text-gray-400 mt-1">ابدأ اللعب</span>
            </button>
        </div>

        <!-- تبويب الشرح -->
        <div id="tab-learn" class="tab-content">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-4">
                <h2 class="font-bold text-lg mb-3 flex items-center gap-2 text-blue-700">
                    <i class="fas fa-book-open"></i> مقدمة
                </h2>
                <p class="text-gray-600 leading-relaxed text-sm">
                    مرحباً بك في درس <span id="lesson-name-text" class="font-bold">...</span>. 
                    استخدم الأزرار في الأسفل للتنقل بين الشرح والاختبار.
                </p>
            </div>
            
            <!-- محتوى تعليمي وهمي -->
            <div class="bg-blue-50 rounded-2xl p-5 border border-blue-100 mb-4">
                <h3 class="font-bold text-blue-800 text-sm mb-2">فكرة الدرس</h3>
                <p class="text-xs text-blue-700">أن تتعرف على المفهوم الأساسي وكيفية تطبيقه في حل المسائل.</p>
            </div>

            <button onclick="switchTab('quiz')" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-gray-900 transition">
                <span>انتقل للاختبار</span> <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <!-- تبويب الاختبار -->
        <div id="tab-quiz" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-3">
                    <h2 class="font-bold text-lg text-gray-800">اختبار سريع</h2>
                    <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">10 درجات</span>
                </div>
                
                <div id="quiz-container">
                    <p class="text-sm font-bold text-gray-700 mb-4">سؤال: ناتج ضرب س² × س³ هو؟</p>
                    <div class="space-y-2 mb-4">
                        <button onclick="submitQuiz(10)" class="w-full p-3 border rounded-xl text-right hover:bg-blue-50 hover:border-blue-200 transition font-bold text-gray-600">س⁵</button>
                        <button onclick="submitQuiz(5)" class="w-full p-3 border rounded-xl text-right hover:bg-blue-50 hover:border-blue-200 transition font-bold text-gray-600">س⁶</button>
                    </div>
                </div>

                <div id="quiz-result" class="hidden text-center py-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600 text-2xl animate-bounce">
                        <i class="fas fa-check"></i>
                    </div>
                    <p class="font-black text-gray-800 text-lg">أحسنت!</p>
                    <p class="text-gray-500 text-xs mb-4">تم حفظ الدرجة بنجاح</p>
                    <button onclick="location.reload()" class="text-blue-600 text-sm font-bold">إعادة المحاولة</button>
                </div>
            </div>
        </div>

    </main>

    <!-- الشريط السفلي -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('learn')" id="nav-learn">
            <i class="fas fa-book-open text-lg mb-1"></i>
            <span>الشرح</span>
        </div>
        <div class="nav-item" onclick="switchTab('quiz')" id="nav-quiz">
            <i class="fas fa-clipboard-check text-lg mb-1"></i>
            <span>الاختبار</span>
        </div>
    </nav>

    <!-- مودال اللعبة -->
    <div id="modal-game" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full h-[85%] rounded-3xl relative flex flex-col overflow-hidden shadow-2xl">
            <div class="bg-gray-50 p-3 flex justify-between items-center border-b border-gray-100">
                <span id="modal-game-title" class="font-bold text-sm text-gray-700 px-2">اللعبة</span>
                <button onclick="closeGameModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-grow flex flex-col items-center justify-center bg-gray-50 relative">
                <!-- هنا سيتم وضع Iframe اللعبة الحقيقي -->
                <i class="fas fa-gamepad text-6xl text-gray-200 mb-6"></i>
                <p class="mb-6 text-sm text-gray-400 font-bold">منطقة اللعبة (Iframe)</p>
                
                <!-- زر المحاكاة (للتجربة) -->
                <button onclick="finishGame(5)" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition flex items-center gap-2">
                    <i class="fas fa-check-circle"></i> محاكاة الفوز (5 نقاط)
                </button>
            </div>
        </div>
    </div>

    <script>
        // *** تم لصق الرابط الخاص بك هنا ***
        const API_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 

        // *** تكوين الدروس (الفصل الثاني) ***
        const lessonConfig = {
            'c6_l1': { chapter: 'الفصل ٦', title: 'ضرب وحيدات الحد', game1: {id: 'g6_1_1', title: 'قوة الأسس'}, game2: {id: 'g6_1_2', title: 'تحدي الضرب'} },
            'c6_l2': { chapter: 'الفصل ٦', title: 'قسمة وحيدات الحد', game1: {id: 'g6_2_1', title: 'تبسيط الكسور'}, game2: {id: 'g6_2_2', title: 'لعبة القسمة'} },
            'c6_l3': { chapter: 'الفصل ٦', title: 'كثيرات الحدود', game1: {id: 'g6_3_1', title: 'تصنيف الحدود'}, game2: {id: 'g6_3_2', title: 'درجة كثيرة الحدود'} }
        };

        // قراءة الرابط
        const params = new URLSearchParams(window.location.search);
        const studentId = params.get('studentId');
        const classId = params.get('classId'); // مهم جداً للسكربت الجديد
        const lessonId = params.get('lessonId') || 'c6_l1'; 
        const autoOpen = params.get('autoOpenGame');

        // متغيرات الحالة
        let currentConfig = lessonConfig[lessonId] || lessonConfig['c6_l1'];
        let activeGameId = null;

        window.onload = function() {
            // تحديث الواجهة
            document.getElementById('lesson-title-display').textContent = currentConfig.title;
            document.getElementById('lesson-name-text').textContent = currentConfig.title;
            document.getElementById('chapter-title-display').textContent = currentConfig.chapter;
            document.getElementById('label-game-1').textContent = currentConfig.game1.title;
            document.getElementById('label-game-2').textContent = currentConfig.game2.title;
            
            // تحديث الرقم الخلفي (رقم الفصل)
            const chapterNum = currentConfig.chapter.match(/\d+/)?.[0] || '6';
            document.getElementById('chapter-bg-num').textContent = chapterNum;

            // ربط الأزرار
            document.getElementById('btn-game-1').onclick = () => openGameModal(currentConfig.game1.id, currentConfig.game1.title);
            document.getElementById('btn-game-2').onclick = () => openGameModal(currentConfig.game2.id, currentConfig.game2.title);

            // جلب الاسم إذا كان الطالب مسجلاً
            if(studentId && studentId !== 'visitor') {
                // نحاول جلب الاسم من localStorage أولاً للسرعة
                const cachedUser = localStorage.getItem('currentUser');
                if(cachedUser) {
                    const u = JSON.parse(cachedUser);
                    if(u.id == studentId) document.getElementById('student-name-display').textContent = u.name.split(' ')[0];
                }
            } else {
                document.getElementById('student-name-display').textContent = 'زائر';
            }

            // فتح اللعبة تلقائياً
            if(autoOpen) {
                if(autoOpen === currentConfig.game1.id) openGameModal(currentConfig.game1.id, currentConfig.game1.title);
                if(autoOpen === currentConfig.game2.id) openGameModal(currentConfig.game2.id, currentConfig.game2.title);
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            window.scrollTo(0, 0);
        }

        function openGameModal(realGameId, title) {
            activeGameId = realGameId; 
            document.getElementById('modal-game-title').textContent = title;
            document.getElementById('modal-game').classList.remove('hidden');
        }

        function closeGameModal() {
            document.getElementById('modal-game').classList.add('hidden');
            activeGameId = null;
        }

        function finishGame(score) {
            if(!studentId || studentId === 'visitor') {
                alert('وضع زائر: لن يتم الحفظ.');
                closeGameModal();
                return;
            }

            const btn = document.querySelector('button[onclick*="finishGame"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="saving-loader"></span> جاري الحفظ...';
            btn.disabled = true;

            // إرسال classId مع الطلب (ضروري للسكربت الجديد)
            fetch(`${API_URL}?action=saveScore&studentId=${studentId}&classId=${classId}&type=game&itemId=${activeGameId}&score=${score}`)
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'success') {
                        closeGameModal();
                        // يمكن هنا إظهار رسالة نجاح صغيرة
                    } else {
                        alert('حدث خطأ أثناء الحفظ');
                    }
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        function submitQuiz(scoreVal) {
            // منطق وهمي للتحقق
            if(scoreVal === 10) { // الإجابة الصحيحة
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('quiz-result').classList.remove('hidden');
                
                if(studentId && studentId !== 'visitor') {
                    fetch(`${API_URL}?action=saveScore&studentId=${studentId}&classId=${classId}&type=lesson&itemId=${lessonId}&score=10`);
                }
            } else {
                alert('إجابة خاطئة، حاول مرة أخرى.');
            }
        }
    </script>
</body>
</html>

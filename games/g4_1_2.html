<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            touch-action: manipulation;
            overscroll-behavior-y: contain;
            position: relative;
            background-color: #1a202c; /* Ù„ÙˆÙ† Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¯Ø§ÙƒÙ† */
        }
        /* ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #1a202c; /* Ù„ÙˆÙ† Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¯Ø§ÙƒÙ† */
            background-image: url("https://ablan-math.github.io/img/g4/mhl.mlabs.jpg"); /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
            background-size: cover;
            background-position: center;
            z-index: -1;
            opacity: 1; 
            transition: opacity 0.5s ease-in-out;
        }

        .card-enter { animation: card-enter 0.5s ease-out forwards; }
        @keyframes card-enter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .feedback-correct {
            animation: feedback-pop 0.3s ease-in-out;
            background-color: #10B981;
            color: white;
        }
        .feedback-incorrect {
            animation: feedback-shake 0.5s ease-in-out;
            background-color: #EF4444;
            color: white;
        }
        @keyframes feedback-pop {
            0% { transform: scale(0.8); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes feedback-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        /* ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±Ø­ Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© */
        .modal-content { 
            animation: modal-pop 0.3s ease-out;
            background-color: rgb(255 255 255 / 0.95); /* Ø´Ø¨Ù‡ Ø´ÙØ§Ù */
            backdrop-filter: blur(4px); /* ØªØ£Ø«ÙŠØ± Ø¶Ø¨Ø§Ø¨ÙŠ */
        }
        @keyframes modal-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .transition-screen {
            animation: fadeIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .transition-screen > * {
            position: relative;
            z-index: 2;
        }
        #game-content {
            position: relative;
            overflow: hidden;
        }
 
        /* Custom Scrollbar for Leaderboard */
        .leaderboard-scroll {
            max-height: 180px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .leaderboard-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .leaderboard-scroll::-webkit-scrollbar-track {
            background: #e0f2fe;
            border-radius: 10px;
        }
        .leaderboard-scroll::-webkit-scrollbar-thumb {
            background-color: #0ea5e9;
            border-radius: 10px;
            border: 2px solid #e0f2fe;
        }
  
        /* ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¹Ø§Ø¯Ø© Ø£Ù„ÙˆØ§Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
        #start-screen h1, #start-screen .welcome-text {
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.5);
            color: #ffffff; 
        }
        .credits-text {
             color: #ffffff; 
             text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
        @keyframes pulse-text {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .pulse-animation {
            animation: pulse-text 2s infinite ease-in-out;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- Ø¥Ø¶Ø§ÙØ©: Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div class="text-white text-2xl font-bold animate-pulse">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ...</div>
        <div class="text-gray-400 text-sm mt-2">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>

    <!-- Start Screen -->
    <!-- ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ø¨Ø¯Ø¦ÙŠ -->
    <div id="start-screen" class="w-full max-w-sm mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-4 text-center card-enter flex flex-col justify-center items-center h-full py-6 hidden">
        <h1 class="text-4xl font-bold text-amber-800">Ù„Ø¹Ø¨Ø© Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
        <!-- ØªØ¹Ø¯ÙŠÙ„: Ø®Ù„ÙÙŠØ© ÙˆØ£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Øµ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
        <div id="welcomeMessage" class="text-base text-white mt-6 mb-8 bg-black/30 backdrop-blur-sm p-4 rounded-xl shadow-lg">
            <p class="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø³ØªÙˆØ§Ø¬Ù‡ 10 ØªØ­Ø¯ÙŠØ§ØªØŒ ÙƒÙ„ ØªØ­Ø¯Ù Ù…Ù† Ù…Ø±Ø­Ù„ØªÙŠÙ†. Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© ÙˆØ­Ù„Ù‡Ø§.</p>
        </div>
        
        <!-- ØªØ¹Ø¯ÙŠÙ„: Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø²Ø± Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
        <button onclick="startGame()" class="w-full bg-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-amber-700 focus:outline-none transition-all ring-2 ring-amber-300 backdrop-blur-sm">
            <span class="pulse-animation text-xl">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</span>
        </button>
        <p class="credits-text text-xs text-white/90 font-semibold mt-8 bg-black/30 p-2 rounded-lg">Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ‚Ø¯ÙŠÙ…: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
    </div>

    <!-- Game Container -->
    <!-- ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø®ÙØ§Ø¡ Ù…Ø¨Ø¯Ø¦ÙŠ -->
    <div id="game-container" class="w-full max-w-sm mx-auto bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-4 space-y-3 hidden">
        <div id="game-screen"></div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanation-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <!-- ØªØ¹Ø¯ÙŠÙ„: .modal-content Ø£ØµØ¨Ø­ Ø´Ø¨Ù‡ Ø´ÙØ§Ù Ù…Ù† Ø®Ù„Ø§Ù„ CSS -->
        <div class="rounded-lg p-5 w-full max-w-sm modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-amber-700">Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</h3>
                <button onclick="hideExplanation()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="explanation-content" class="space-y-2 text-sm text-gray-700 max-h-[75vh] overflow-y-auto pr-2"></div>
            <button onclick="hideExplanation()" class="mt-3 w-full bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // --- GAME LOGIC ---
        
        // --- Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        // ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ "Ù…Ø±Ø§Ø­Ù„"
        const allStages = [
          {
            levelTitle: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©",
            questions: [
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 1
              { 
                caseTitle: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© (Ø³Ù¡)", 
                part1: { 
                    question: "Ù†Ø§ØªØ¬ Ø·Ø±Ø­ Ù¥ Ù…Ù† Ø¹Ø¯Ø¯ Ù…Ø§ Ù‡Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù¡Ù¢. Ø§ÙƒØªØ¨ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù…Ù„Ø©.", 
                    answer: "Ø³ - Ù¥ â‰¥ Ù¡Ù¢",
                    options: ["Ø³ - Ù¥ â‰¥ Ù¡Ù¢", "Ø³ - Ù¥ > Ù¡Ù¢", "Ø³ + Ù¥ â‰¥ Ù¡Ù¢", "Ù¥ - Ø³ â‰¥ Ù¡Ù¢"]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù¥ â‰¥ Ù¡Ù¢</strong>. Ù…Ø§ Ù‡Ùˆ Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©ØŸ", 
                    answer: "Ø³ â‰¥ Ù¡Ù§",
                    options: ["Ø³ â‰¥ Ù¡Ù§", "Ø³ > Ù¡Ù§", "Ø³ â‰¥ Ù§", "Ø³ â‰¤ Ù¡Ù§"]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 2
              { 
                caseTitle: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© (Ø³Ù¢)", 
                part1: { 
                    question: "Ù…Ø¬Ù…ÙˆØ¹ Ø¹Ø¯Ø¯ Ùˆ Ù¨ Ø£ØµØºØ± Ù…Ù† Ù¢Ù . Ø§ÙƒØªØ¨ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù…Ù„Ø©.", 
                    answer: "Ø³ + Ù¨ < Ù¢Ù ",
                    options: ["Ø³ + Ù¨ â‰¤ Ù¢Ù ", "Ø³ + Ù¨ > Ù¢Ù ", "Ø³ - Ù¨ < Ù¢Ù ", "Ø³ + Ù¨ < Ù¢Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ + Ù¨ < Ù¢Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©ØŸ", 
                    answer: "Ø³ < Ù¡Ù¢",
                    options: ["Ø³ > Ù¡Ù¢", "Ø³ < Ù¡Ù¢", "Ø³ < Ù¢Ù¨", "Ø³ â‰¤ Ù¡2"]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 3
              { 
                caseTitle: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© (Ø³Ù£)", 
                part1: { 
                    question: "Ø¹Ø¯Ø¯ Ù…Ø§ Ù…Ø·Ø±ÙˆØ­Ø§Ù‹ Ù…Ù†Ù‡ Ù£ Ù‡Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒØ«Ø± Ù§. Ø§ÙƒØªØ¨ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©.", 
                    answer: "Ø³ - Ù£ â‰¤ Ù§",
                    options: ["Ø³ - Ù£ â‰¥ Ù§", "Ø³ - Ù£ < Ù§", "Ø³ + Ù£ â‰¤ Ù§", "Ø³ - Ù£ â‰¤ Ù§"]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù£ â‰¤ Ù§</strong>. Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ØŸ", 
                    answer: "Ø³ â‰¤ Ù¡Ù ",
                    options: ["Ø³ â‰¥ Ù¡Ù ", "Ø³ < Ù¡Ù ", "Ø³ â‰¤ Ù¡Ù ", "Ø³ â‰¤ Ù¤"]
                } 
              }
            ]
          },
          {
            levelTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†",
            questions: [
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 4
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø³Ù¤)", 
                part1: { 
                    question: "(Ø£Ù†Øª Ø²Ø¨ÙˆÙ†) Ù…Ø¹Ùƒ Ù¡Ù©Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹ ÙˆØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø·Ø§Ù„ Ø³Ø¹Ø±Ù‡ Ù§Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹ ÙˆÙ‚Ù…ÙŠØµ (Ø³). Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªØ¯ÙØ¹Ù‡ Ù„Ù„Ù‚Ù…ÙŠØµØŸ", 
                    answer: "Ø³ + Ù§Ù¥ â‰¤ Ù¡Ù©Ù¥",
                    options: ["Ø³ + Ù§Ù¥ â‰¥ Ù¡Ù©Ù¥", "Ø³ - Ù§Ù¥ â‰¤ Ù¡Ù©Ù¥", "Ø³ + Ù§Ù¥ â‰¤ Ù¡Ù©Ù¥", "Ø³ + Ù¡Ù©Ù¥ â‰¤ Ù§Ù¥"]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ + Ù§Ù¥ â‰¤ Ù¡Ù©Ù¥</strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚ØµÙ‰ Ø³Ø¹Ø± Ù„Ù„Ù‚Ù…ÙŠØµ (Ø³)ØŸ", 
                    answer: "Ø³ â‰¤ Ù¡Ù¢Ù ",
                    options: ["Ø³ â‰¥ Ù¡Ù¢Ù ", "Ø³ â‰¤ Ù¡Ù¢Ù ", "Ø³ â‰¤ Ù¢Ù§Ù ", "Ø³ < Ù¡Ù¢Ù "]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 5
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø³Ù¥)", 
                part1: { 
                    question: "(Ø£Ù†Øª Ø²Ø¨ÙˆÙ†) ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ù‡Ø¯ÙŠØ© Ù„ÙˆØ§Ù„Ø¯ØªÙƒ. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø¹Ø±Ù‡Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ù¥Ù  Ø±ÙŠØ§Ù„Ø§Ù‹. Ø¯ÙØ¹Øª (Ø³) Ø±ÙŠØ§Ù„Ø§Ù‹ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ Ø®ØµÙ… Ù¡Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠØŸ", 
                    answer: "Ø³ - Ù¡Ù¥ > Ù¥Ù ",
                    options: ["Ø³ - Ù¡Ù¥ < Ù¥Ù ", "Ø³ + Ù¡Ù¥ > Ù¥Ù ", "Ø³ - Ù¡Ù¥ > Ù¥Ù ", "Ø³ - Ù¡Ù¥ â‰¥ Ù¥Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù¡Ù¥ > Ù¥Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø£ØµÙ„ÙŠ (Ø³) Ù„Ù„Ù‡Ø¯ÙŠØ©ØŸ", 
                    answer: "Ø³ > Ù¦Ù¥",
                    options: ["Ø³ < Ù¦Ù¥", "Ø³ > Ù£Ù¥", "Ø³ â‰¥ Ù¦Ù¥", "Ø³ > Ù¦Ù¥"]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 6
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø³Ù¦)", 
                part1: { 
                    question: "(Ø£Ù†Øª Ø²Ø¨ÙˆÙ†) Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… Ø¨Ù‚ÙŠÙ…Ø© Ù¡Ù  Ø±ÙŠØ§Ù„Ø§Øª. Ø¨Ø¹Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø¹Ø± Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ (Ø³) Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù£Ù  Ø±ÙŠØ§Ù„Ø§Ù‹. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù„Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠØŸ", 
                    answer: "Ø³ - Ù¡Ù  â‰¥ Ù£Ù ",
                    options: ["Ø³ - Ù¡Ù  â‰¥ Ù£Ù ", "Ø³ + Ù¡Ù  â‰¥ Ù£Ù ", "Ø³ - Ù¡Ù  â‰¤ Ù£Ù ", "Ø³ - Ù¡Ù  > Ù£Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù¡Ù  â‰¥ Ù£Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø£ØµÙ„ÙŠ (Ø³)ØŸ", 
                    answer: "Ø³ â‰¥ Ù¤Ù ",
                    options: ["Ø³ â‰¤ Ù¤Ù ", "Ø³ â‰¥ Ù¢Ù ", "Ø³ > Ù¤Ù ", "Ø³ â‰¥ Ù¤Ù "]
                } 
              }
            ]
          },
          {
            levelTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±",
            questions: [
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 7
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø³Ù§)", 
                part1: { 
                    question: "(Ø£Ù†Øª ÙƒØ§Ø´ÙŠØ±) Ø²Ø¨ÙˆÙ† Ø§Ø´ØªØ±Ù‰ Ø¹Ù„Ø¨Ø© Ø¹ØµÙŠØ± (Ø³) ÙˆØ®Ø¨Ø²Ø§Ù‹ Ø¨Ù€ Ù¥ Ø±ÙŠØ§Ù„Ø§Øª. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø´ØªØ±ÙŠØ§ØªÙ‡ Ø£Ù‚Ù„ Ù…Ù† Ù¢Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹ Ù„ÙŠØ³ØªØ¹Ù…Ù„ Ù‚Ø³ÙŠÙ…Ø©. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©ØŸ", 
                    answer: "Ø³ + Ù¥ < Ù¢Ù¥",
                    options: ["Ø³ + Ù¥ > Ù¢Ù¥", "Ø³ - Ù¥ < Ù¢Ù¥", "Ø³ + Ù¥ < Ù¢Ù¥", "Ø³ + Ù¥ â‰¤ Ù¢Ù¥"]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ + Ù¥ < Ù¢Ù¥</strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚ØµÙ‰ Ø³Ø¹Ø± (Ø³) Ù„Ù„Ø¹ØµÙŠØ±ØŸ", 
                    answer: "Ø³ < Ù¢Ù ",
                    options: ["Ø³ < Ù¢Ù ", "Ø³ > Ù¢Ù ", "Ø³ < Ù£Ù ", "Ø³ â‰¤ Ù¢Ù "]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 8
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø³Ù¨)", 
                part1: { 
                    question: "(Ø£Ù†Øª ÙƒØ§Ø´ÙŠØ±) Ø²Ø¨ÙˆÙ† Ø£Ø¹Ø·Ø§Ùƒ Ù…Ø¨Ù„Øº (Ø³) Ø±ÙŠØ§Ù„Ø§Ù‹. Ø³Ø¹Ø± Ø§Ù„Ø£ØºØ±Ø§Ø¶ Ù¤Ù¥ Ø±ÙŠØ§Ù„Ø§Ù‹ØŒ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù¡Ù  Ø±ÙŠØ§Ù„Ø§Øª. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©ØŸ", 
                    answer: "Ø³ - Ù¤Ù¥ â‰¥ Ù¡Ù ",
                    options: ["Ø³ - Ù¤Ù¥ â‰¤ Ù¡Ù ", "Ø³ + Ù¤Ù¥ â‰¥ Ù¡Ù ", "Ø³ - Ù¤Ù¥ â‰¥ Ù¡Ù ", "Ù¤Ù¥ - Ø³ â‰¥ Ù¡Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù¤Ù¥ â‰¥ Ù¡Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº (Ø³) Ø£Ø¹Ø·Ø§Ùƒ Ø¥ÙŠØ§Ù‡ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ", 
                    answer: "Ø³ â‰¥ Ù¥Ù¥",
                    options: ["Ø³ â‰¤ Ù¥Ù¥", "Ø³ â‰¥ Ù¥Ù¥", "Ø³ > Ù¥Ù¥", "Ø³ â‰¥ Ù£Ù¥"]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 9
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø³Ù©)", 
                part1: { 
                    question: "(Ø£Ù†Øª ÙƒØ§Ø´ÙŠØ±) ØªØ±ÙŠØ¯ Ø³Ø§Ø±Ø© Ø£Ù† ØªØ¯Ø®Ø± Ù¥Ù Ù  Ø±ÙŠØ§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„. Ù„Ø¯ÙŠÙ‡Ø§ Ø§Ù„Ø¢Ù† (Ø³) Ø±ÙŠØ§Ù„Ø§Ù‹ØŒ ÙˆØ£Ø¶Ø§ÙØª Ù„Ù‡Ø§ Ù¢Ù¦Ù  Ø±ÙŠØ§Ù„Ø§Ù‹. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ Ø§Ù„Ù…ÙˆÙ‚ÙØŸ", 
                    answer: "Ø³ + Ù¢Ù¦Ù  â‰¥ Ù¥Ù Ù ",
                    options: ["Ø³ - Ù¢Ù¦Ù  â‰¥ Ù¥Ù Ù ", "Ø³ + Ù¢Ù¦Ù  â‰¤ Ù¥Ù Ù ", "Ø³ + Ù¢Ù¦Ù  > Ù¥Ù Ù ", "Ø³ + Ù¢Ù¦Ù  â‰¥ Ù¥Ù Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ + Ù¢Ù¦Ù  â‰¥ Ù¥Ù Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº (Ø³) ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡Ø§ØŸ", 
                    answer: "Ø³ â‰¥ Ù¢Ù¤Ù ",
                    options: ["Ø³ â‰¥ Ù§Ù¦Ù ", "Ø³ â‰¤ Ù¢Ù¤Ù ", "Ø³ â‰¥ Ù¢Ù¤Ù ", "Ø³ > Ù¢Ù¤Ù "]
                } 
              },
              // Ø§Ù„Ø³Ø¤Ø§Ù„ 10
              { 
                caseTitle: "Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø³Ù¡Ù )", 
                part1: { 
                    question: "(Ø£Ù†Øª ÙƒØ§Ø´ÙŠØ±) Ø²Ø¨ÙˆÙ† ÙŠØ´ØªØ±ÙŠ ØºØ±Ø¶Ø§Ù‹ (Ø³). Ù„Ø¯ÙŠÙ‡ Ù‚Ø³ÙŠÙ…Ø© Ø®ØµÙ… Ù¢Ù  Ø±ÙŠØ§Ù„Ø§Ù‹. Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¯ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ù¦Ù  Ø±ÙŠØ§Ù„Ø§Ù‹. Ù…Ø§ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©ØŸ", 
                    answer: "Ø³ - Ù¢Ù  > Ù¦Ù ",
                    options: ["Ø³ - Ù¢Ù  < Ù¦Ù ", "Ø³ + Ù¢Ù  > Ù¦Ù ", "Ø³ - Ù¢Ù  > Ù¦Ù ", "Ø³ - Ù¢Ù  â‰¥ Ù¦Ù "]
                }, 
                part2: { 
                    question: "Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ù‡ÙŠ: <strong>Ø³ - Ù¢Ù  > Ù¦Ù </strong>. Ù…Ø§ Ù‡Ùˆ Ø£Ù‚Ù„ Ø³Ø¹Ø± (Ø³) Ù„Ù„ØºØ±Ø¶ØŸ", 
                    answer: "Ø³ > Ù¨Ù ",
                    options: ["Ø³ < Ù¨Ù ", "Ø³ > Ù¤Ù ", "Ø³ â‰¥ Ù¨Ù ", "Ø³ > Ù¨Ù "]
                } 
              }
            ]
          }
        ];
        // --- Ù†Ù‡Ø§ÙŠØ© Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---


        const startScreenEl = document.getElementById('start-screen');
        const gameContainerEl = document.getElementById('game-container');
        const gameScreenEl = document.getElementById('game-screen');
        const explanationModalEl = document.getElementById('explanation-modal');
        const explanationContentEl = document.getElementById('explanation-content');
        
        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let currentGameLevelIndex = 0; // <!-- Ø¥Ø¶Ø§ÙØ©: Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let currentStage = 1;
        let score = 0;
        let answered = false;
        
        let timerInterval = null;
        let questionStartTime = 0;
        let totalElapsedTime = 0;

        // Ø¯Ø§Ù„Ø© Ù„Ø®Ù„Ø· ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function toArabicNumerals(numStr) {
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return String(numStr).replace(/[0-9.-]/g, (char) => {
                if (char === '.') return 'Ù«';
                if (char === '-') return '-';
                return arabicNumerals[parseInt(char)];
            });
        }
        
        function startTimer() {
            clearInterval(timerInterval);
            questionStartTime = Date.now();
            const timerDisplayEl = document.getElementById('timer-display');
            
            const updateTimerDisplay = () => {
                const timerEl = document.getElementById('timer-display');
                if (timerEl) {
                    const currentSessionTime = Date.now() - questionStartTime;
                    const displayTimeInSeconds = Math.floor((totalElapsedTime + currentSessionTime) / 1000);
                    timerEl.textContent = toArabicNumerals(displayTimeInSeconds);
                }
            };
            
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            if (questionStartTime > 0) {
                totalElapsedTime += Date.now() - questionStartTime;
                questionStartTime = 0;
            }
            const timerEl = document.getElementById('timer-display');
            if (timerEl) {
                const displayTimeInSeconds = Math.floor(totalElapsedTime / 1000);
                 timerEl.textContent = toArabicNumerals(displayTimeInSeconds);
            }
        }
        
        function startGame() {
            document.body.classList.add('game-started');
            
            // ØªÙ… ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            currentGameLevelIndex = 0;
            score = 0;
            totalElapsedTime = 0;
            startScreenEl.classList.add('hidden');
            gameContainerEl.classList.remove('hidden');
            
            loadLevel(); // <!-- ØªØºÙŠÙŠØ±: Ù†Ø¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        }
        
        // <!-- ØªØºÙŠÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£ØµØ¨Ø­Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø­Ù„ -->
        function showLevelTransitionScreen() {
            const levelData = allStages[currentGameLevelIndex];
            let levelName = "";
            if(currentGameLevelIndex === 0) levelName = "Ø§Ù„Ø£ÙˆÙ„Ù‰";
            else if(currentGameLevelIndex === 1) levelName = "Ø§Ù„Ø«Ø§Ù†ÙŠØ©";
            else levelName = "Ø§Ù„Ø«Ø§Ù„Ø«Ø©";

            gameScreenEl.innerHTML = `
                <div class="transition-screen text-center flex flex-col justify-center items-center min-h-[350px] bg-gradient-to-br from-amber-600 to-yellow-500 rounded-2xl p-6 shadow-lg space-y-4">
                    <h2 class="text-white text-2xl font-bold drop-shadow-md">Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${levelName} Ù…Ù† ${toArabicNumerals(allStages.length)}</h2>
                    <p class="text-white/90 text-xl mt-2 font-medium drop-shadow-md">${levelData.levelTitle}</p>
                    <button onclick="loadQuestion()" class="mt-6 bg-black/20 text-white font-bold py-2 px-10 rounded-lg shadow-md hover:bg-black/30 backdrop-blur-sm transition-all ring-2 ring-white/50">
                        Ø§Ø¨Ø¯Ø£
                    </button>
                </div>
            `;
        }

        // <!-- Ø¥Ø¶Ø§ÙØ©: Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© -->
        function loadLevel() {
            const levelData = allStages[currentGameLevelIndex];
            // Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© *Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©* ÙÙ‚Ø·
            gameQuestions = shuffleArray(levelData.questions.slice());
            currentQuestionIndex = 0;
            currentStage = 1;
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
            showLevelTransitionScreen();
        }

        function loadQuestion() {
            answered = false;
            const question = gameQuestions[currentQuestionIndex];
            
            gameScreenEl.innerHTML = `<div id="game-content" class="space-y-2 card-enter"></div>`;
            const gameContentEl = document.getElementById('game-content');

            gameContentEl.innerHTML = `
                <div id="game-header" class="flex justify-between items-center text-base font-bold p-2 bg-sky-100 rounded-lg shadow-inner z-10 relative">
                    <div class="text-cyan-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score-display">Ù </span></div>
                    <div class="text-red-600">Ø§Ù„ÙˆÙ‚Øª: <span id="timer-display">Ù </span> Ø«</div>
                </div>
                
                <!-- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø³Ø¤Ø§Ù„ -->
                <div id="question-header" class="flex justify-between items-center mt-1 mb-2">
                    <div class="bg-amber-600 text-white text-sm font-bold px-3 py-1 rounded-full shadow">
                        ${allStages[currentGameLevelIndex].levelTitle}
                    </div>
                    <div class="text-gray-600 text-sm font-bold bg-gray-200 px-3 py-1 rounded-full shadow-inner">
                        Ø§Ù„Ø³Ø¤Ø§Ù„ ${toArabicNumerals(currentQuestionIndex + 1)} / ${toArabicNumerals(gameQuestions.length)}
                    </div>
                </div>
                 <!-- ØªÙ… Ø­Ø°Ù Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù„Ø£Ù†Ù‡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                <div id="question-area" class="bg-sky-50/70 border border-sky-200 rounded-lg p-3 text-center z-10 relative">
                     <p class="font-bold text-cyan-800">Ø§Ù„Ø¬Ø²Ø¡ ${toArabicNumerals(currentStage)} Ù…Ù† Ù¢</p>
                     <p class="text-base font-semibold text-gray-900 mt-1" id="question-text"></p>
                </div>
                
                <div id="options-container" class="grid grid-cols-2 gap-2 z-10 relative"></div>
                <div id="feedback" class="text-center font-bold p-2 rounded-lg text-sm hidden my-1 z-10 relative"></div>
                <div id="action-buttons" class="hidden flex justify-center items-center gap-2 z-10 relative"></div>`;
            
            document.getElementById('score-display').textContent = toArabicNumerals(score);
            const timerEl = document.getElementById('timer-display');
            if (timerEl) {
                 timerEl.textContent = toArabicNumerals(Math.floor(totalElapsedTime / 1000));
            }

            const questionTextEl = document.getElementById('question-text');
            const optionsContainerEl = document.getElementById('options-container');

            let part;
            if (currentStage === 1) {
                part = question.part1;
            } else {
                part = question.part2;
            }

            questionTextEl.innerHTML = part.question;
            
            // Ø®Ù„Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‚Ø¨Ù„ Ø¹Ø±Ø¶Ù‡Ø§
            const options = shuffleArray(part.options.slice());
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = "w-full bg-amber-600 text-white font-bold p-2 rounded-lg shadow-md hover:bg-amber-700 focus:outline-none flex items-center justify-center min-h-[50px] text-base text-center";
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                button.innerHTML = option;
                button.onclick = () => checkAnswer(option);
                optionsContainerEl.appendChild(button);
            });

            startTimer();
        }

        function checkAnswer(selectedValue) {
            if (answered) return;
            stopTimer();
            answered = true;
            
            const question = gameQuestions[currentQuestionIndex];
            const feedbackEl = document.getElementById('feedback');
            const actionButtonsEl = document.getElementById('action-buttons');
            let isCorrect = false;

            document.getElementById('options-container').style.display = 'none';
            feedbackEl.classList.remove('hidden');
            actionButtonsEl.classList.remove('hidden');

            let correctAnswer;
            if (currentStage === 1) {
                correctAnswer = question.part1.answer;
                isCorrect = (selectedValue === correctAnswer);
                if (isCorrect) {
                    feedbackEl.textContent = "Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø© ØµØ­ÙŠØ­Ø©.";
                } else {
                    feedbackEl.innerHTML = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswer}`;
                }
                actionButtonsEl.innerHTML = `<button onclick="goToNextStage()" class="w-1/2 bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-700 text-sm">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                                             <button onclick="showExplanation()" class="w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 text-sm">Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ</button>`;

            } else {
                correctAnswer = question.part2.answer;
                isCorrect = (selectedValue == correctAnswer);
                if (isCorrect) {
                    feedbackEl.textContent = "Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ØªØ§Ø²Ø©! Ø§Ù„Ø­Ù„ Ø¯Ù‚ÙŠÙ‚.";
                } else {
                    feedbackEl.innerHTML = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswer}`;
                }
                
                // <!-- ØªØºÙŠÙŠØ±: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£Ùˆ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© -->
                const isLastQuestionInLevel = (currentQuestionIndex === gameQuestions.length - 1);
                const isLastLevel = (currentGameLevelIndex === allStages.length - 1);

                let buttonText = "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ";
                if (isLastQuestionInLevel && !isLastLevel) {
                    buttonText = "Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
                } else if (isLastQuestionInLevel && isLastLevel) {
                    buttonText = "Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
                }

                actionButtonsEl.innerHTML = `<button onclick="nextQuestion()" class="w-1/2 bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-700 text-sm">${buttonText}</button>
                                             <button onclick="showExplanation()" class="w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 text-sm">Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ</button>`;
            }

            if(isCorrect) {
                score++;
                document.getElementById('score-display').textContent = toArabicNumerals(score);
                feedbackEl.classList.add('feedback-correct');
            } else {
                feedbackEl.classList.add('feedback-incorrect');
            }
        }
        
        function goToNextStage() {
            currentStage = 2;
            loadQuestion();
        }

        function nextQuestion() {
            hideExplanation();
            currentQuestionIndex++;
            
            // <!-- ØªØºÙŠÙŠØ±: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¨Ù‚ÙŠØ© *ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø­Ù„Ø©* -->
            if (currentQuestionIndex < gameQuestions.length) {
                currentStage = 1;
                loadQuestion(); // <!-- ØªØºÙŠÙŠØ±: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù†ØªÙ‚Ø§Ù„
            } else {
                // <!-- ØªØºÙŠÙŠØ±: Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© -->
                currentGameLevelIndex++;
                if (currentGameLevelIndex < allStages.length) {
                    loadLevel(); // <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø§Ù„ØªÙŠ Ø³ØªØ¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù†ØªÙ‚Ø§Ù„)
                } else {
                    endGame(); // <!-- Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ØŒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                }
            }
        }

        function endGame() {
            const finalTimeInSeconds = Math.round(totalElapsedTime / 1000);
             gameScreenEl.innerHTML = `
                <div class="text-center space-y-3 card-enter p-4">
                 <h1 class="text-2xl font-bold text-amber-700">Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h1>
                 <p class="text-base">Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª.</p>
                 
                 <div id="final-result-display" class="bg-gray-100/80 p-3 my-2 rounded-lg shadow-inner">
                 </div>

                 <div id="leaderboard-loader" style="display: none;"></div>
                 <div id="leaderboard-container"></div>
                 
                 <div id="finish-game-wrapper" style="display: none;" class="space-y-2">
                      <button id="finish-game-btn" class="w-full bg-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-amber-700">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©
                      </button>
                 </div>
                 <button onclick="window.location.reload()" class="w-full bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-gray-600 mt-2">
                   Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
                 </button>
                </div>`;
            if(window.saveAndFinishGame) {
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙˆÙ‚Øª
                window.saveAndFinishGame(score, finalTimeInSeconds);
            }
        }
        
        function showExplanation() {
            const q = gameQuestions[currentQuestionIndex];
            
            // ØªÙ… ØªØ¨Ø³ÙŠØ· Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙˆØ­Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
            if (currentStage === 1) {
                explanationContentEl.innerHTML = `
                    <div class="border-r-4 border-amber-500 pr-3 mb-2 space-y-1">
                        <p><span class="font-bold">Ø§Ù„Ø³Ø¤Ø§Ù„:</span> ${q.part1.question}</p>
                    </div>
                    <div class="border-r-4 border-green-500 pr-3">
                        <p class="font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©):</p>
                        <p class="text-center text-lg font-bold bg-green-100 p-2 rounded">${q.part1.answer}</p>
                    </div>`;
            } else {
                 explanationContentEl.innerHTML = `
                    <div class="border-r-4 border-amber-500 pr-3 mb-2 space-y-1">
                        <p><span class="font-bold">Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø©:</span> ${q.part1.answer}</p>
                        <p><span class="font-bold">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span> ${q.part2.question.replace(/<[^>]*>/g, '')}</p>
                    </div>
                    <div class="border-r-4 border-green-500 pr-3">
                        <p class="font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø§Ù„Ø­Ù„):</p>
                        <p class="text-center text-lg font-bold bg-green-100 p-2 rounded">${q.part2.answer}</p>
                    </div>`;
            }
            
            explanationModalEl.classList.remove('hidden');
        }

        function hideExplanation() {
            explanationModalEl.classList.add('hidden');
        }
    </script>

    <script>
    // --- START OF CONNECTION & LEADERBOARD ENGINE ---
    (function() {
        // --- CONFIGURATION (Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù„Ø¹Ø¨Ø©) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const GAME_ID = 'g4_1_2'; // ØªÙ… ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù„Ø¹Ø¨Ø©
        const GAME_MAX_POINTS = 20; // 10 Ø£Ø³Ø¦Ù„Ø© * Ù…Ø±Ø­Ù„ØªÙŠÙ† = 20 Ù†Ù‚Ø·Ø©
        const PLATFORM_MAX_GRADE = 5;
        const METRIC_TYPE = 'time';
        const METRIC_LABEL = 'Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ)';

        // --- Read URL Parameters ---
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const classId = urlParams.get('classId');
        const studentName = urlParams.get('studentName');

        let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

        // --- CORE FUNCTIONS ---

        // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        window.saveAndFinishGame = function(points, metricValue) {
            const finalPoints = parseFloat(points) || 0;
            const finalMetric = parseFloat(metricValue) || 0;
            const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
            const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

            const resultDisplay = document.getElementById('final-result-display');
            if (resultDisplay) {
                resultDisplay.innerHTML = `
                    <div class="flex justify-around text-center">
                        <div>
                            <p class="text-sm">Ø§Ù„Ù†Ù‚Ø§Ø·:</p>
                            <p class="text-2xl font-bold text-amber-600 my-1">${toArabicNumerals(finalPoints)}<span class="text-lg text-gray-600">/${toArabicNumerals(maxPoints)}</span></p>
                        </div>
                        <div>
                            <p class="text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª:</p>
                            <p class="text-2xl font-bold text-red-600 my-1">${toArabicNumerals(finalMetric)} <span class="text-sm">Ø«</span></p>
                        </div>
                    </div>
                    <p class="text-blue-600 mt-3 text-center border-t pt-2">Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                `;
            }

            if (studentId && classId) {
                const params = new URLSearchParams({
                    action: 'saveGrade',
                    studentId: studentId,
                    classId: classId,
                    itemId: GAME_ID,
                    grade: finalGrade.toFixed(2),
                    metricValue: Math.round(finalMetric).toString()
                });
                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(result => console.log('Save result:', result.status))
                    .catch(err => console.error("Save Error:", err))
                    .finally(fetchAndShowLeaderboard);
            } else {
                console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                fetchAndShowLeaderboard();
            }
        }

        // 2. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
        function fetchAndShowLeaderboard() {
            const loader = document.getElementById('leaderboard-loader');
            const container = document.getElementById('leaderboard-container');
            if (!loader || !container) return;
            
            if (!classId) {
                console.log("No classId found, skipping leaderboard for visitor.");
                container.innerHTML = `<p class="text-center text-gray-500 mt-4 text-sm">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
                showFinishButton();
                return;
            }

            loader.style.display = 'block';
            container.innerHTML = '';

            const params = new URLSearchParams({
                action: 'getLeaderboard',
                gameId: GAME_ID,
                metricType: METRIC_TYPE,
                classId: classId
            });

            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        displayLeaderboard(response.data);
                    } else {
                        throw new Error(response.message || 'Failed to load leaderboard data.');
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    container.innerHTML = `<p class="text-center text-red-500 text-sm">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
                })
                .finally(() => {
                    loader.style.display = 'none';
                    showFinishButton();
                });
        }
        
        // 3. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
        function displayLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
                return;
            }

            let tableHTML = `
                <div class="mt-4 border-t pt-2">
                    <h3 class="text-xl font-bold text-center text-gray-800 mb-2">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                    <div class="leaderboard-scroll">
                        <table class="min-w-full bg-white shadow-md rounded-lg text-sm">
                            <thead class="bg-gray-800 text-white sticky top-0">
                                <tr>
                                    <th class="text-center py-1 px-2">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th class="text-right py-1 px-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th class="text-center py-1 px-2">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th class="text-center py-1 px-2">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;

            data.forEach((player, index) => {
                const rank = index + 1;
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = 'ğŸ¥‡';
                if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                if (rank === 3) rankDisplay = 'ğŸ¥‰';

                const isCurrentUser = (currentUser && player.name === currentUser.name);
                const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center py-1 px-2 text-lg">${rankDisplay}</td>
                        <td class="text-right py-1 px-2">${player.name}</td>
                        <td class="text-center py-1 px-2">${player.grade.toFixed(1)}</td>
                        <td class="text-center py-1 px-2">${player.metricValue}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table></div></div>`;
            container.innerHTML = tableHTML;
        }

        // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
        function showFinishButton() {
            const finishWrapper = document.getElementById('finish-game-wrapper');
            if (finishWrapper) {
                finishWrapper.style.display = 'block';
            }
        }

        // 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ®ØµÙŠØµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- NEW PRELOADER LOGIC ---
            const loadingScreen = document.getElementById('loading-screen');
            const startScreen = document.getElementById('start-screen');
            const bgImage = new Image();
            const imageUrl = "https://ablan-math.github.io/img/g4/mhl.mlabs.jpg";
            
            bgImage.onload = function() {
                // Image is loaded
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (startScreen) startScreen.classList.remove('hidden');
            };
            
            bgImage.onerror = function() {
                // Image failed to load, just start the game
                console.error("Background image failed to load.");
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (startScreen) startScreen.classList.remove('hidden');
            };
            
            bgImage.src = imageUrl;
            // --- END PRELOADER LOGIC ---

            const welcomeMessageEl = document.getElementById('welcomeMessage');
            if (studentName && welcomeMessageEl) {
                welcomeMessageEl.innerHTML = `<p class="welcome-text">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ <span class="font-bold text-cyan-300">${studentName}</span>! Ù„Ø¯ÙŠÙƒ 10 ØªØ­Ø¯ÙŠØ§ØªØŒ ÙƒÙ„ ØªØ­Ø¯Ù Ù…Ù† Ù…Ø±Ø­Ù„ØªÙŠÙ†. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</p>`;
            }
            document.body.addEventListener('click', function(event) {
                if (event.target && event.target.id === 'finish-game-btn') {
                    window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                }
            });
        });
    })();
    </script>
</body>
</html>




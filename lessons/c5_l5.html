<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٥-٥: تطبيقات على النظام المكون من معادلتين خطيتين | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .math-eq { font-family: "Courier New", monospace; font-size: 1.2rem; font-weight: bold; padding: 4px 10px; border-radius: 6px; display: inline-block; vertical-align: middle; transition: all 0.3s ease-in-out; border: 1px solid; }
        .highlight-number {
            background-color: #fef9c3; /* yellow-100 */
            color: #b45309; /* amber-700 */
            padding: 1px 5px;
            border-radius: 4px;
            border: 1px solid #fde047; /* yellow-300 */
            font-weight: bold;
        }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback {
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-weight: bold;
            transition: opacity 0.5s ease-in-out;
        }
        .feedback.correct { background-color: #dcfce7; color: #16a34a; border-right: 4px solid #22c55e; }
        .feedback.incorrect { background-color: #fee2e2; color: #b91c1c; border-right: 4px solid #ef4444; }
        
        .eq-color-1 { color: #1d4ed8; background-color: #dbeafe; border-color: #93c5fd; } /* Blue */
        .eq-color-2 { color: #15803d; background-color: #dcfce7; border-color: #86efac; } /* Green */
        .eq-color-3 { color: #7e22ce; background-color: #f3e8ff; border-color: #d8b4fe; } /* Purple for new/modified */
        .final-answer-box { background-color: #fef9c3; border-color: #fde047; color: #b45309; }
        
        .part-1 { color: #1d4ed8; font-weight: bold; } /* Blue part */
        .part-2 { color: #15803d; font-weight: bold; } /* Green part */

        .step-box { 
            border-right: 4px solid #1d4ed8; 
            transition: opacity 0.5s, transform 0.5s;
            opacity: 1;
            transform: translateX(0);
        }
        .target-term {
            outline: 3px solid #ef4444; /* red-500 */
            box-shadow: 0 0 10px #f43f5e;
            border-radius: 4px;
            transition: all 0.3s ease-in-out;
        }
        .comment-box {
            min-height: 50px;
        }
        .sign-change {
            color: #dc2626; /* red-600 */
            font-weight: bold;
        }
        .fraction { display: inline-flex; flex-direction: column; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > .frac-bar { border-top: 2px solid currentColor; }
        .option-label .math-eq {
            font-family: 'Cairo', sans-serif;
            font-size: 1.25rem; 
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٥-٥: تطبيقات على النظام المكون من معادلتين خطيتين</h1>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفهوم الأساسي</h2>
                    <div class="p-4 bg-blue-50 rounded-lg space-y-3">
                        <p>تعلمت سابقاً خمس طرائق لحل أنظمة المعادلات الخطية. الجدول أدناه يبين أفضل حالة لاستعمال كل منها:</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="text-right p-3">الطريقة</th>
                                        <th class="text-right p-3">أفضل حالة لاستعمالها</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b"><td class="p-3 font-bold">التمثيل البياني</td><td class="p-3">لتقدير الحلول؛ فالتمثيل البياني لا يعطي في الغالب حلاً دقيقاً.</td></tr>
                                    <tr class="border-b bg-gray-50"><td class="p-3 font-bold">التعويض</td><td class="p-3">إذا كان معامل أحد المتغيرين في إحدى المعادلتين <span class="highlight-number">١</span> أو <span class="highlight-number">-١</span>.</td></tr>
                                    <tr class="border-b"><td class="p-3 font-bold">الحذف باستعمال الجمع</td><td class="p-3">إذا كان كل من معاملي أحد المتغيرين في المعادلتين معكوساً جمعياً للآخر.</td></tr>
                                    <tr class="border-b bg-gray-50"><td class="p-3 font-bold">الحذف باستعمال الطرح</td><td class="p-3">إذا كان معاملا أحد المتغيرين في المعادلتين متساويين.</td></tr>
                                    <tr class="bg-gray-50"><td class="p-3 font-bold">الحذف باستعمال الضرب</td><td class="p-3">إذا لم يكن أي من المعاملات (<span class="highlight-number">١</span>) أو (<span class="highlight-number">-١</span>)، وليس من السهل التخلص من أحد المتغيرين بجمع المعادلتين أو طرحهما.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: اختر الطريقة الأفضل</h2>
                    <div id="interactive-choice-container" class="p-6 bg-gray-50 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Interactive questions will be injected here by JavaScript -->
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🌍 ثالثاً: تطبيقات من واقع الحياة</h2>
                    <div id="real-life-apps-container" class="space-y-8">
                        <!-- Real life examples injected here -->
                    </div>
                </section>
                
                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ رابعاً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>

            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <div id="smartExplanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full border-t-4 border-purple-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">🧠 الحل الذكي</h3>
                <button id="closeSmartModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="smartExplanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <script>
    // --- SCRIPT GENERAL ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 

    function getStudentFromStorage() {
        const studentDataString = localStorage.getItem('currentStudent');
        if (studentDataString) {
            try {
                return JSON.parse(studentDataString);
            } catch (e) {
                console.error("Error parsing student data from localStorage:", e);
                return null;
            }
        }
        return null;
    }

    function buildHeader(studentData, lessonTitle = null) {
        const headerContainer = document.getElementById('main-header');
        if (!headerContainer) return;
        let titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`;
        if (lessonTitle) {
            titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-blue-700 leading-tight">${lessonTitle}</h1></div>`;
        }
        const studentName = studentData ? `أهلاً، ${studentData.name}` : 'زائر';
        const userInfoHtml = `<div class="text-left"><p class="text-lg text-gray-600">${studentName}</p><a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a></div>`;
        headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`;
    }
    function buildFooter() {
        const footerContainer = document.getElementById('main-footer');
        if (!footerContainer) return;
        footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`;
    }
    function initializeQuiz(lessonId, questions, studentData) { 
        window.currentQuestions = questions; 
        const quizForm = document.getElementById('quizForm'); 
        if (!quizForm) return; 
        if (questions.length === 0) { 
            quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; 
            return; 
        } 
        let attemptsLeft = MAX_ATTEMPTS; 
        if (studentData && studentData.lessons && studentData.lessons[lessonId]) {
            attemptsLeft = MAX_ATTEMPTS - studentData.lessons[lessonId].attempts;
        } else if (studentData) {
            attemptsLeft = MAX_ATTEMPTS;
        } else {
            attemptsLeft = 1;
        }

        const attemptsCounter = document.getElementById('attempts-counter'); 
        if (attemptsCounter) { 
            attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; 
        } 
        
        questions.forEach(q => {
            q.correctAnswer = q.options.find(opt => opt.isCorrect).value;
        });

        const quizHtml = questions.map((q, index) => {
            const shuffledOptions = [...q.options].sort(() => 0.5 - Math.random());
            const optionsHTML = shuffledOptions.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); 
            const smartButtonHTML = q.smartExplanation ? `<button type="button" id="smart-explain-btn-${index}" class="hidden mt-2 text-xs text-purple-600 hover:underline font-semibold">🧠 الحل الذكي</button>` : '';
            return `<div class="p-4 border-2 border-gray-200 rounded-lg"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><div class="flex items-center space-x-4 space-x-reverse">${smartButtonHTML}<button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div></div>`; 
        }).join(''); 
        
        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; 
        
        if (attemptsLeft <= 0) {
            const submitBtn = quizForm.querySelector('#submit-quiz-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'لا توجد محاولات متبقية';
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400');
        }
        
        questions.forEach((q, index) => { 
            const explainBtn = document.getElementById(`explain-btn-${index}`); 
            if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index)); 
            if (q.smartExplanation) {
                const smartExplainBtn = document.getElementById(`smart-explain-btn-${index}`);
                if(smartExplainBtn) smartExplainBtn.addEventListener('click', () => showSmartExplanation(index));
            }
        }); 
        
        quizForm.onsubmit = (e) => { 
            e.preventDefault(); 
            let score = 0; 
            questions.forEach((q, index) => { 
                const userAnswer = e.target.elements[`q${index}`]?.value; 
                const feedbackEl = document.getElementById(`feedback-q${index}`); 
                if (userAnswer === q.correctAnswer) { 
                    score++; 
                    feedbackEl.textContent = '✔ إجابة صحيحة!'; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; 
                } else { 
                    feedbackEl.textContent = `❌ إجابة خاطئة.`; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; 
                } 
                document.getElementById(`explain-btn-${index}`).classList.remove('hidden'); 
                if (q.smartExplanation) {
                    document.getElementById(`smart-explain-btn-${index}`).classList.remove('hidden');
                }
            }); 
            const finalGrade = Math.round((score / questions.length) * 10); 
            const resultsDiv = document.getElementById('quiz-results'); 
            resultsDiv.classList.remove('hidden'); 
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; 
            if (studentData) {
                saveGrade(lessonId, finalGrade, studentData.id, studentData.classId); 
                if (attemptsLeft - 1 > 0) {
                    document.getElementById('retake-quiz-btn').classList.remove('hidden');
                }
            } else {
                document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول من المنصة لحفظ تقدمك.';
            }
            e.target.querySelector('#submit-quiz-btn').disabled = true; 
        }; 
    }

    function saveGrade(lessonId, grade, studentId, classId) {
        const saveStatus = document.getElementById('save-status');
        if (!studentId || !classId) {
            saveStatus.textContent = 'خطأ: لا يمكن حفظ النتيجة. بيانات الطالب أو الفصل غير موجودة.';
            console.error("Student ID or Class ID is missing.");
            return;
        }
        saveStatus.textContent = 'جارٍ حفظ نتيجتك...';
        const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&classId=${classId}&lessonId=${lessonId}&grade=${grade}`;
        fetch(url)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح!';
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.';
                console.error("Save Grade Error:", error);
            });
    }

    function showExplanation(questionIndex) { 
        const modal = document.getElementById('explanationModal'); 
        const explanationText = document.getElementById('explanationText'); 
        if(modal && explanationText && window.currentQuestions[questionIndex] && window.currentQuestions[questionIndex].explanation) { 
            explanationText.innerHTML = window.currentQuestions[questionIndex].explanation; 
            modal.classList.remove('hidden'); 
        } 
    }
    function closeModal() { 
        document.getElementById('explanationModal').classList.add('hidden'); 
    }
    function showSmartExplanation(questionIndex) {
        const modal = document.getElementById('smartExplanationModal');
        const explanationText = document.getElementById('smartExplanationText');
        if(modal && explanationText && window.currentQuestions[questionIndex] && window.currentQuestions[questionIndex].smartExplanation) {
            explanationText.innerHTML = window.currentQuestions[questionIndex].smartExplanation;
            modal.classList.remove('hidden');
        }
    }
    function closeSmartModal() {
        document.getElementById('smartExplanationModal').classList.add('hidden');
    }
    // --- END SCRIPT GENERAL ---

    document.addEventListener('DOMContentLoaded', () => {
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        
        const studentData = getStudentFromStorage();

        buildHeader(studentData, lessonTitle);
        buildFooter();
        
        const LESSON_ID = 'c5_l5';
        
        // --- Interactive Choice Section ---
        const interactiveQuestions = [
            { system: 'ص = ٢س - ١<br>٣س + ٢ص = ٢٦', options: ['التعويض', 'الحذف بالجمع', 'الحذف بالضرب'], correct: 'التعويض', reason: 'لأن المعادلة الأولى محلولة بالنسبة للمتغير (ص)، مما يجعل التعويض مباشرةً في المعادلة الثانية سهلاً جداً.' },
            { system: '٥س - ٢ص = ٤<br>٢س + ٢ص = ١٠', options: ['التعويض', 'الحذف بالجمع', 'الحذف بالطرح'], correct: 'الحذف بالجمع', reason: 'لأن معاملي المتغير (ص) هما <span class="highlight-number">-٢</span> و <span class="highlight-number">٢</span>، وهما معكوسان جمعيان لبعضهما، مما يسمح بحذف (ص) مباشرة عند جمع المعادلتين.' },
            { system: '٤س + ٥ص = ١٢<br>٤س - ٣ص = -٤', options: ['الحذف بالجمع', 'الحذف بالطرح', 'الحذف بالضرب'], correct: 'الحذف بالطرح', reason: 'لأن معاملي المتغير (س) متساويان (<span class="highlight-number">٤</span>). طرح المعادلتين من بعضهما سيؤدي إلى حذف (س) مباشرة.' },
            { system: '٢س + ٣ص = ٧<br>٣س - ٤ص = ٢', options: ['التمثيل البياني', 'التعويض', 'الحذف بالضرب'], correct: 'الحذف بالضرب', reason: 'لأن لا يوجد أي معامل يساوي ١ أو -١ (للتعويض)، والمعاملات ليست متساوية أو متعاكسة. لذلك، نحتاج إلى ضرب إحدى المعادلتين أو كلتيهما للتمكن من الحذف.' }
        ];

        const choiceContainer = document.getElementById('interactive-choice-container');
        if (choiceContainer) {
            interactiveQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 bg-white rounded-lg shadow flex flex-col';
                const systemHTML = `<div class="mb-4 p-3 bg-gray-100 rounded-lg text-center"><p class="font-semibold mb-2">حدد أفضل طريقة لحل النظام:</p><div class="inline-block text-left">${q.system.split('<br>').map((eq, i) => `<p class="math-eq eq-color-${i + 1}">${eq}</p>`).join('<br>')}</div></div>`;
                const optionsHTML = q.options.map(opt => `<button data-question="${index}" data-answer="${opt}" class="w-full text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">${opt}</button>`).join('');
                questionDiv.innerHTML = `<div class="flex-grow">${systemHTML}<div class="grid grid-cols-1 gap-3">${optionsHTML.replace(/md:grid-cols-3/g, '')}</div></div><div id="feedback-interactive-${index}" class="feedback hidden mt-auto"></div>`;
                choiceContainer.appendChild(questionDiv);
            });

            choiceContainer.addEventListener('click', (e) => {
                if (e.target.matches('button[data-question]')) {
                    const questionIndex = e.target.getAttribute('data-question');
                    const userAnswer = e.target.getAttribute('data-answer');
                    const question = interactiveQuestions[questionIndex];
                    const feedbackEl = document.getElementById(`feedback-interactive-${questionIndex}`);
                    const buttons = choiceContainer.querySelectorAll(`button[data-question="${questionIndex}"]`);
                    buttons.forEach(btn => btn.disabled = true);
                    if (userAnswer === question.correct) {
                        e.target.classList.replace('bg-blue-500', 'bg-green-500');
                        feedbackEl.innerHTML = `<strong>صحيح!</strong> ${question.reason}`;
                        feedbackEl.className = 'feedback correct';
                    } else {
                        e.target.classList.replace('bg-blue-500', 'bg-red-500');
                        const correctButton = choiceContainer.querySelector(`button[data-question="${questionIndex}"][data-answer="${question.correct}"]`);
                        correctButton.classList.replace('bg-blue-500', 'bg-green-500');
                        feedbackEl.innerHTML = `<strong>خطأ.</strong> الطريقة الأفضل هي <strong>${question.correct}</strong>. ${question.reason}`;
                        feedbackEl.className = 'feedback incorrect';
                    }
                    feedbackEl.classList.remove('hidden');
                }
            });
        }
        
        // --- Real Life Apps Section ---
        const realLifeApps = [
            {
                id: 'shopping',
                title: '🛒 مثال: التسوق',
                problem: 'اشترى عبدالله <span class="highlight-number">٤</span> كراسات و <span class="highlight-number">٣</span> حقائب بمبلغ <span class="highlight-number">١٨١</span> ريالاً، واشترى عبدالرحمن كراسة و<span class="highlight-number">٢</span> حقيبتين بمبلغ <span class="highlight-number">٩٤</span> ريالاً. ما ثمن كل من الكراسة والحقيبة؟',
                totalSteps: 7
            },
            {
                id: 'recycling',
                title: '♻️ مثال: تدوير',
                problem: 'جمع محمد <span class="highlight-number">٩</span> كجم بلاستيك و <span class="highlight-number">٣٠</span> كجم ورق وباعها بمبلغ <span class="highlight-number">٣٣</span> ريالاً. وجمع صالح <span class="highlight-number">٩</span> كجم بلاستيك و <span class="highlight-number">١١٥</span> كجم ورق وباعها بمبلغ <span class="highlight-number">٥٠</span> ريالاً. ما سعر الكيلوجرام لكل مادة؟',
                totalSteps: 8 
            }
        ];

        const appsContainer = document.getElementById('real-life-apps-container');
        appsContainer.innerHTML = ''; // Clear previous content
        realLifeApps.forEach(app => {
            const appDiv = document.createElement('div');
            appDiv.className = 'p-6 bg-white rounded-lg shadow-lg';
            appDiv.innerHTML = `
                <h3 class="text-xl font-bold mb-3 text-blue-800">${app.title}</h3>
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <p>${app.problem}</p>
                </div>
                <div id="solution-container-${app.id}" class="space-y-4 mt-4">
                    <!-- Steps will be dynamically inserted here -->
                </div>
                <div class="flex justify-between mt-6">
                    <button data-example="${app.id}" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                    <div>
                        <button data-example="${app.id}" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                        <button data-example="${app.id}" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                    </div>
                </div>
            `;
            appsContainer.appendChild(appDiv);
        });
        
        const examples = {};

        function updateButtons(exampleId, index) {
            const ex = examples[exampleId];
            ex.prevBtn.disabled = index <= -1;
            ex.nextBtn.classList.toggle('hidden', index >= ex.totalSteps);
            ex.resetBtn.classList.toggle('hidden', index < ex.totalSteps);
        }

        // --- Step Runner for Shopping Example ---
        window.runStep_shopping = (index) => {
            const container = examples.shopping.container;
            container.innerHTML = ''; 

            let eq1HTML = `<p class="math-eq eq-color-1">٤ك + ٣ح = ١٨١</p>`;
            let eq2HTML = `<p class="math-eq eq-color-2">ك + ٢ح = ٩٤</p>`;
            let commentHTML = `<div class="comment-box"></div>`;
            let solutionHTML = '';

            if (index >= 1) {
                eq2HTML = `<p class="math-eq eq-color-2 target-term">ك + ٢ح = ٩٤</p>`;
                commentHTML = `<div class="comment-box"><p class="text-purple-800 font-semibold">أفضل طريقة هي <b>التعويض</b> لأن معامل (ك) هو <span class="highlight-number">١</span>.</p></div>`;
            }
            if (index >= 2) {
                commentHTML = `<div class="comment-box"><p class="text-purple-800 font-semibold">نجعل المعادلة بدلالة (ك):</p></div>`;
            }
            if (index >= 3) {
                eq2HTML = `<p class="math-eq eq-color-3">ك = ٩٤ - ٢ح</p>`;
                commentHTML = `<div class="comment-box"></div>`;
            }
            if (index >= 4) {
                 solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box mt-4"><p class="text-purple-800 font-semibold">الخطوة التالية: نعوض قيمة (ك) في المعادلة الأولى:</p><div class="text-center my-2"><div><p class="math-eq eq-color-1">٤(<span class="part-2">٩٤ - ٢ح</span>) + ٣ح = ١٨١</p></div></div></div>`;
            }
            if (index >= 5) {
                solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box"><p class="text-purple-800 font-semibold">نحل لإيجاد (ح):</p><div class="text-center my-2 flex flex-col items-center space-y-2"><div><p class="math-eq eq-color-3">٣٧٦ - ٨ح + ٣ح = ١٨١</p></div><div><p class="math-eq final-answer-box">-٥ح = -١٩٥ ⟸ ح = ٣٩</p></div></div></div>`;
            }
            if (index >= 6) {
                 solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box"><p class="text-purple-800 font-semibold">الآن نجد (ك):</p><div class="text-center my-2 flex flex-col items-center space-y-2"><div><p class="math-eq eq-color-2">ك = ٩٤ - ٢(<span class="part-1">٣٩</span>)</p></div><div><p class="math-eq final-answer-box">ك = ١٦</p></div></div></div>`;
            }
            if (index >= 7) {
                solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box"><div class="mt-2 p-3 rounded-lg font-bold text-lg final-answer-box text-center">الحل: ثمن الكراسة <span class="highlight-number">١٦</span> ريالاً، وثمن الحقيبة <span class="highlight-number">٣٩</span> ريالاً.</div></div>`;
            }

            if (index >= 0) {
                container.innerHTML = `
                    <div class="p-3 bg-gray-100 rounded-lg step-box">
                        <p class="text-purple-800 font-semibold">١. نحدد المتغيرات و نكتب المعادلات:</p>
                        <div class="my-3 text-center">
                            <p>ك = ثمن الكراسة، ح = ثمن الحقيبة</p>
                            ${eq1HTML}<br>
                            <div class="flex items-center justify-center space-x-4 space-x-reverse mt-2">
                                ${eq2HTML}
                                ${commentHTML}
                            </div>
                        </div>
                    </div>
                    ${solutionHTML}
                `;
            } else {
                container.innerHTML = `<p class="text-center text-gray-500">اضغط "التالي" لبدء خطوات الحل</p>`;
            }
            updateButtons('shopping', index);
        };

        // --- Step Runner for Recycling Example ---
        window.runStep_recycling = (index) => {
            const container = examples.recycling.container;
            container.innerHTML = '';

            let eq1HTML = `<p class="math-eq eq-color-1">٩ب + ٣٠و = ٣٣</p>`;
            let eq2HTML = `<p class="math-eq eq-color-2">٩ب + ١١٥و = ٥٠</p>`;
            let commentHTML = `<div class="comment-box"></div>`;
            let lineHTML = '';
            let resultHTML = '';
            let solutionHTML = '';
            
            if (index >= 1) {
                eq1HTML = `<p class="math-eq eq-color-1"><span class="target-term">٩ب</span> + ٣٠و = ٣٣</p>`;
                eq2HTML = `<p class="math-eq eq-color-2"><span class="target-term">٩ب</span> + ١١٥و = ٥٠</p>`;
                commentHTML = `<div class="comment-box"><p class="text-purple-800 font-semibold">أفضل طريقة هي <b class="text-red-600">الحذف بالطرح</b> لأن معاملي (ب) متساويان.</p></div>`;
            }
            if (index >= 2) {
                eq2HTML = `<div class="flex items-center space-x-2 space-x-reverse"><span class="text-red-600 font-bold text-2xl">ــ</span><p class="math-eq eq-color-2">٩ب + ١١٥و = ٥٠</p></div>`;
                commentHTML = `<div class="comment-box"></div>`;
            }
            if (index >= 3) {
                eq2HTML = `<p class="math-eq eq-color-3"><span class="sign-change">-</span>٩ب <span class="sign-change">-</span> ١١٥و = <span class="sign-change">-</span>٥٠</p>`;
                lineHTML = `<div class="border-t-2 border-gray-700 my-2 w-full max-w-xs"></div>`;
            }
            if (index >= 4) {
                 resultHTML = `<div class="text-center my-2"><p class="math-eq eq-color-3">٠ب - ٨٥و = -١٧</p></div>`;
            }
            if (index >= 5) {
                resultHTML += `<div class="text-center my-2"><p class="math-eq eq-color-3">-٨٥و = -١٧</p></div>`;
            }
            if (index >= 6) {
                resultHTML += `<div class="text-center my-2"><p class="math-eq final-answer-box">و = ٠.٢</p></div>`;
            }
            if (index >= 7) {
                solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box mt-4"><p class="text-purple-800 font-semibold">نعوض قيمة (و) في المعادلة الأولى ونجد (ب):</p><div class="text-center my-2 flex flex-col items-center space-y-2"><div><p class="math-eq eq-color-1">٩ب + ٣٠(<span class="part-2">٠.٢</span>) = ٣٣</p></div><div><p class="math-eq eq-color-3">٩ب + ٦ = ٣٣ ⟸ ٩ب = ٢٧</p></div><div><p class="math-eq final-answer-box">ب = ٣</p></div></div></div>`;
            }
            if (index >= 8) {
                solutionHTML += `<div class="p-3 bg-gray-100 rounded-lg step-box"><div class="mt-2 p-3 rounded-lg font-bold text-lg final-answer-box text-center">الحل: سعر كجم البلاستيك <span class="highlight-number">٣</span> ريالات، وسعر كجم الورق <span class="highlight-number">٠.٢</span> ريال (<span class="highlight-number">٢٠</span> هللة).</div></div>`;
            }


            if (index >= 0) {
                 container.innerHTML = `
                    <div class="p-3 bg-gray-100 rounded-lg step-box">
                        <div class="my-3 text-center flex flex-col items-center space-y-2">
                            ${eq1HTML}
                            ${eq2HTML}
                            ${lineHTML}
                            ${resultHTML}
                        </div>
                        ${commentHTML}
                    </div>
                    ${solutionHTML}
                `;
            } else {
                 container.innerHTML = `<p class="text-center text-gray-500">اضغط "التالي" لبدء خطوات الحل</p>`;
            }
            updateButtons('recycling', index);
        };

        realLifeApps.forEach(app => {
            examples[app.id] = {
                id: app.id,
                totalSteps: app.totalSteps,
                currentIndex: -1,
                container: document.getElementById(`solution-container-${app.id}`),
                nextBtn: document.querySelector(`button.next-btn[data-example="${app.id}"]`),
                prevBtn: document.querySelector(`button.prev-btn[data-example="${app.id}"]`),
                resetBtn: document.querySelector(`button.reset-btn[data-example="${app.id}"]`),
            };
            
            const ex = examples[app.id];
            ex.nextBtn.addEventListener('click', () => {
                if (ex.currentIndex < ex.totalSteps) { ex.currentIndex++; window[`runStep_${ex.id}`](ex.currentIndex); }
            });
            ex.prevBtn.addEventListener('click', () => {
                if (ex.currentIndex > -1) { ex.currentIndex--; window[`runStep_${ex.id}`](ex.currentIndex); }
            });
            ex.resetBtn.addEventListener('click', () => {
                ex.currentIndex = -1; window[`runStep_${ex.id}`](ex.currentIndex);
            });
            window[`runStep_${ex.id}`](-1); // Initial call
        });


        // --- Quiz Section ---
        const quizQuestions = generateQuiz();
        initializeQuiz(LESSON_ID, quizQuestions, studentData); 
        
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('closeSmartModalBtn').addEventListener('click', closeSmartModal);
    });

    function generateQuiz() {
        const questionBank = [
            { level: '⭐', text: 'ما هي أفضل طريقة لحل النظام التالي؟<br><span class="math-eq">س = ٤ص + ٧</span><br><span class="math-eq">٢س - ٣ص = ٩</span>', options: [ { display: 'التمثيل البياني', value: 'a' }, { display: 'التعويض', value: 'b', isCorrect: true }, { display: 'الحذف بالجمع', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], explanation: 'التعويض هو الأفضل لأن المعادلة الأولى معطاة بدلالة (س)، مما يسهل تعويضها مباشرة في المعادلة الثانية.' },
            { level: '⭐', text: 'حدد الطريقة الأنسب لحل النظام:<br><span class="math-eq">٤س + ٢ص = ١٤</span><br><span class="math-eq">٦س - ٢ص = ٦</span>', options: [ { display: 'التعويض', value: 'a' }, { display: 'الحذف بالطرح', value: 'b' }, { display: 'الحذف بالجمع', value: 'c', isCorrect: true }, { display: 'الحذف بالضرب', value: 'd' } ], explanation: 'الحذف بالجمع هو الأنسب لأن معاملي المتغير (ص) (+٢ و -٢) هما معكوسان جمعيان لبعضهما.' },
            { level: '⭐', text: 'ما الطريقة التي ستستخدمها لحل النظام:<br><span class="math-eq">ص = ٣س - ٥</span><br><span class="math-eq">ص = -٢س + ١٥</span>', options: [ { display: 'التعويض أو التمثيل البياني', value: 'a', isCorrect: true }, { display: 'الحذف بالجمع', value: 'b' }, { display: 'الحذف بالطرح', value: 'c' }, { display: 'الحذف بالضرب', value: 'd' } ], explanation: 'بما أن كلتا المعادلتين محلولتان بالنسبة لـ(ص)، فالتعويض (بمساواة المعادلتين: ٣س - ٥ = -٢س + ١٥) هو خيار ممتاز. كذلك، صيغة الميل والمقطع تجعل التمثيل البياني سهلاً لتقدير الحل.' },
            { level: '⭐⭐', text: 'لحل النظام: <span class="math-eq">٥س + ٣ص = ١١</span> و <span class="math-eq">٢س + ٤ص = ١٢</span>، ما هي الطريقة الأكثر فعالية؟', options: [ { display: 'التعويض', value: 'a' }, { display: 'الحذف بالجمع', value: 'b' }, { display: 'الحذف بالطرح', value: 'c' }, { display: 'الحذف بالضرب', value: 'd', isCorrect: true } ], explanation: 'الحذف بالضرب هو الأكثر فعالية لأنه لا يوجد أي معامل يساوي ١ أو -١، والمعاملات ليست متساوية أو متعاكسة. ستحتاج إلى ضرب المعادلتين لجعل أحد المعاملات متعاكساً (مثلاً، ضرب الأولى في -٢ والثانية في ٥ لحذف س).' },
            { level: '⭐', text: 'أي نظام من الأنظمة التالية هو الأنسب للحل بطريقة الحذف بالطرح؟', options: [ { display: '<span class="math-eq">س+ص=٥<br>س-ص=١</span>', value: 'a' }, { display: '<span class="math-eq">٢س+٣ص=٧<br>٢س-٥ص=١</span>', value: 'b', isCorrect: true }, { display: '<span class="math-eq">ص=س+١<br>٢س+ص=٤</span>', value: 'c' }, { display: '<span class="math-eq">٣س+٢ص=٨<br>٢س+٣ص=٧</span>', value: 'd' } ], explanation: 'النظام في الخيار (ب) هو الأنسب للحذف بالطرح لأن معاملي المتغير (س) متساويان (كلاهما ٢)، مما يسمح بحذفه مباشرة عند طرح المعادلتين.' },
            { level: '⭐', text: 'مجموع عددين <span class="highlight-number">١٥</span> والفرق بينهما <span class="highlight-number">٣</span>. ما هما العددان؟', options: [ { display: '<span class="math-eq">(٩, ٦)</span>', value: 'a', isCorrect: true }, { display: '<span class="math-eq">(١٠, ٥)</span>', value: 'b' }, { display: '<span class="math-eq">(٨, ٧)</span>', value: 'c' }, { display: '<span class="math-eq">(١٢, ٣)</span>', value: 'd' } ], explanation: 'نفرض العددين س، ص. س+ص=<span class="highlight-number">١٥</span> و س-ص=<span class="highlight-number">٣</span>. باستخدام الحذف بالجمع، <span class="highlight-number">٢</span>س=<span class="highlight-number">١٨</span> إذن س=<span class="highlight-number">٩</span>. بالتعويض، <span class="highlight-number">٩</span>+ص=<span class="highlight-number">١٥</span> إذن ص=<span class="highlight-number">٦</span>.', smartExplanation: 'ابحث عن خيارين مجموعهما <span class="highlight-number">١٥</span>. الخياران (أ) و (ب) و (ج) يحققون ذلك. الآن ابحث عن خيارين الفرق بينهما <span class="highlight-number">٣</span>. فقط الخيار (أ) (<span class="highlight-number">٩</span>-<span class="highlight-number">٦</span>=<span class="highlight-number">٣</span>) يحقق ذلك.' },
            { level: '⭐⭐', text: 'ما هو حل النظام: <span class="math-eq">س + ص = ٥</span> و <span class="math-eq">٢س + ٢ص = ١٢</span>؟', options: [ { display: '<span class="math-eq">(٢, ٣)</span>', value: 'a' }, { display: 'لا يوجد حل', value: 'b', isCorrect: true }, { display: 'عدد لا نهائي من الحلول', value: 'c' }, { display: '<span class="math-eq">(٠, ٥)</span>', value: 'd' } ], explanation: 'بضرب المعادلة الأولى في <span class="highlight-number">-٢</span>، نحصل على <span class="math-eq">-٢س - ٢ص = -١٠</span>. بجمعها مع المعادلة الثانية (<span class="math-eq">٢س + ٢ص = ١٢</span>)، نحصل على <span class="math-eq">٠ = ٢</span>، وهي عبارة خاطئة. لذا لا يوجد حل.', smartExplanation: 'لاحظ أن المعادلة الثانية هي ضعف المعادلة الأولى في الطرف الأيمن (<span class="math-eq">٢س+٢ص</span>)، ولكن الطرف الأيسر (<span class="highlight-number">١٢</span>) ليس ضعف الطرف الأيسر للمعادلة الأولى (<span class="highlight-number">٥</span>). هذا التناقض يعني أن الخطين متوازيان ولا يتقاطعان، أي لا يوجد حل.' },
            { level: '⭐⭐', text: 'حل النظام:<br><span class="math-eq">٣س + ٢ص = ١٦</span><br><span class="math-eq">٢س + ٣ص = ١٤</span>', options: [ { display: '<span class="math-eq">(٤, ٢)</span>', value: 'a', isCorrect: true }, { display: '<span class="math-eq">(٢, ٥)</span>', value: 'b' }, { display: '<span class="math-eq">(٥, ٠.٥)</span>', value: 'c' }, { display: '<span class="math-eq">(-٤, ١٤)</span>', value: 'd' } ], explanation: 'باستخدام الحذف بالضرب (نضرب الأولى في <span class="highlight-number">٢</span> والثانية في <span class="highlight-number">-٣</span>): <span class="math-eq">٦س+٤ص=٣٢</span> و <span class="math-eq">-٦س-٩ص=-٤٢</span>. بالجمع: <span class="math-eq">-٥ص=-١٠</span> إذن ص=<span class="highlight-number">٢</span>. بالتعويض: <span class="math-eq">٣س+٢(٢)=١٦</span> إذن <span class="math-eq">٣س=١٢</span> ومنها س=<span class="highlight-number">٤</span>.' },
            { level: '⭐⭐⭐', text: 'مع أحمد ومحمد معاً <span class="highlight-number">١٥٠</span> ريالاً. إذا كان ما مع أحمد يساوي ضعف ما مع محمد زائد <span class="highlight-number">٣٠</span> ريالاً. فكم مع كل منهما؟', options: [ { display: 'أحمد ١٠٠، محمد ٥٠', value: 'a' }, { display: 'أحمد ٩٠، محمد ٦٠', value: 'b' }, { display: 'أحمد ١٢٠، محمد ٣٠', value: 'c' }, { display: 'أحمد ١١٠، محمد ٤٠', value: 'd', isCorrect: true } ], explanation: 'نفرض ما مع أحمد (أ) وما مع محمد (م). <span class="math-eq">أ+م=١٥٠</span> و <span class="math-eq">أ=٢م+٣٠</span>. بالتعويض: <span class="math-eq">(٢م+٣٠)+م=١٥٠</span> ⟸ <span class="math-eq">٣م=١٢٠</span> ⟸ م=<span class="highlight-number">٤٠</span>. إذن أ=<span class="highlight-number">١٥٠</span>-<span class="highlight-number">٤٠</span>=<span class="highlight-number">١١٠</span>.' },
            { level: '⭐', text: 'حل النظام:<br><span class="math-eq">ص = ٥س - ١</span><br><span class="math-eq">ص = ٢س + ٨</span>', options: [ { display: '<span class="math-eq">(٣, ١٤)</span>', value: 'a', isCorrect: true }, { display: '<span class="math-eq">(٢, ٩)</span>', value: 'b' }, { display: '<span class="math-eq">(١, ٤)</span>', value: 'c' }, { display: '<span class="math-eq">(٤, ١٩)</span>', value: 'd' } ], explanation: 'بما أن ص=ص، إذن <span class="math-eq">٥س-١=٢س+٨</span>. <span class="math-eq">٣س=٩</span> ⟸ س=<span class="highlight-number">٣</span>. بالتعويض: ص=<span class="math-eq">٥(٣)-١=١٤</span>.' },
            { level: '⭐⭐', text: 'حل النظام:<br><span class="math-eq">٧س - ٤ص = ١٠</span><br><span class="math-eq">-٧س + ٥ص = -٩</span>', options: [ { display: `(<span class="fraction"><span>١٠</span><span class="frac-bar"></span><span>٧</span></span>, ٠)`, value: 'a' }, { display: '<span class="math-eq">(٠, -٢.٥)</span>', value: 'b' }, { display: '<span class="math-eq">(٢, ١)</span>', value: 'c', isCorrect: true }, { display: '<span class="math-eq">(٥, ٦.٢٥)</span>', value: 'd' } ], explanation: 'باستخدام الحذف بالجمع مباشرة: ص=<span class="highlight-number">١</span>. بالتعويض في المعادلة الأولى: <span class="math-eq">٧س-٤(١)=١٠</span> ⟸ <span class="math-eq">٧س=١٤</span> ⟸ س=<span class="highlight-number">٢</span>. الحل هو (<span class="highlight-number">٢</span>, <span class="highlight-number">١</span>).' },
            { level: '⭐⭐', text: 'ما هو حل النظام: <span class="math-eq">٤س - ٢ص = ٨</span> و <span class="math-eq">ص = ٢س - ٤</span>؟', options: [ { display: 'حل وحيد', value: 'a' }, { display: 'لا يوجد حل', value: 'b' }, { display: 'عدد لا نهائي من الحلول', value: 'c', isCorrect: true }, { display: '(٢, ٠)', value: 'd' } ], explanation: 'بإعادة ترتيب المعادلة الثانية: <span class="math-eq">٢ص=٤س-٨</span> ⟸ <span class="math-eq">٢ص-٤س=-٨</span>. المعادلة الأولى هي <span class="math-eq">٤س-٢ص=٨</span>. المعادلتان متكافئتان. يوجد عدد لا نهائي من الحلول.', smartExplanation: 'لاحظ أن المعادلة الثانية (<span class="math-eq">ص = ٢س - ٤</span>) إذا ضربتها في <span class="highlight-number">-٢</span> تحصل على <span class="math-eq">-٢ص = -٤س + ٨</span>، وهي نفسها المعادلة الأولى. بما أن المعادلتين هما نفس الخط، فإنه يوجد عدد لا نهائي من الحلول.' }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 5); // Select 5 random questions
    }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٣-٢: كتابة المعادلات بصيغة الميل والمقطع | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        
        .math-eq {
            font-family: "Courier New", monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 2px 8px;
            border-radius: 6px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .fraction { display: inline-flex; flex-direction: column; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > span:last-child { border-top: 2px solid #4338ca; }

        /* أنماط مضافة من الدرس القديم لضمان عمل الأمثلة */
        .nav-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .explanation-step { 
            padding-right: 12px; 
            margin-bottom: 1rem; 
            border-right: 3px solid #1d4ed8; 
            transition: opacity 0.5s ease-in-out; 
        }
        .explanation-step:last-child { margin-bottom: 0; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٣-٢: كتابة المعادلات بصيغة الميل والمقطع</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفاهيم الأساسية</h2>
                    <div class="p-6 bg-blue-50 rounded-lg space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">كتابة معادلة مستقيم بمعرفة ميله ونقطة يمر بها</h3>
                            <p>إذا عُلم ميل المستقيم (م) ونقطة يمر بها (س₁, ص₁)، يمكننا كتابة معادلته بصيغة الميل والمقطع <span class="math-eq">ص = م س + ب</span> باتباع الخطوات التالية:</p>
                            <div class="mt-4 space-y-4">
                                <div class="bg-white p-3 rounded-lg border">
                                    <p><strong>الخطوة 1:</strong> عوض بالميل (م) وإحداثيات النقطة (س₁، ص₁) في المعادلة <span class="math-eq">ص = م س + ب</span>.</p>
                                     <p><strong>الخطوة 2:</strong> حل المعادلة لإيجاد قيمة المقطع الصادي (ب).</p>
                                     <p><strong>الخطوة 3:</strong> اكتب المعادلة النهائية بتعويض الميل (م) والمقطع الصادي (ب).</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">كتابة معادلة مستقيم بمعرفة نقطتين يمر بهما</h3>
                            <p>إذا عُلمت نقطتان يمر بهما المستقيم، يمكننا كتابة معادلته باتباع الخطوات التالية:</p>
                             <div class="mt-4 p-4 bg-white rounded-lg border space-y-2">
                                 <p><strong>الخطوة 1:</strong> أوجد ميل المستقيم (م) باستخدام النقطتين وصيغة الميل.</p>
                                 <p class="text-center my-2 p-3 bg-indigo-50 rounded-md text-xl math-eq">
                                     م = <span class="fraction"><span>ص₂ - ص₁</span><span>س₂ - س₁</span></span>
                                 </p>
                                 <p><strong>الخطوة 2:</strong> اختر إحدى النقطتين، ثم اتبع نفس خطوات الطريقة السابقة لإيجاد المقطع الصادي (ب) وكتابة المعادلة.</p>
                             </div>
                        </div>
                         <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">مفردات جديدة: التنبؤ الخطي</h3>
                            <p>يُستخدم <span class="vocab-term">التنبؤ الخطي</span> لعمل تنبؤات حول قيم تقع خارج نطاق مجموعة البيانات المتوفرة. وذلك عن طريق إيجاد معادلة الخط المستقيم التي تمثل العلاقة بين متغيرين، ثم استخدام هذه المعادلة لتقدير قيمة مجهولة.</p>
                        </div>
                    </div>
                </section>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: أمثلة تفاعلية</h2>
                    
                    <!-- أمثلة: إيجاد المعادلة من ميل ونقطة -->
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4 mb-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">النوع الأول: إيجاد المعادلة من ميل ونقطة</h3>
                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- المثال الأول (أ) -->
                            <div class="flex-1">
                                <p class="mb-2"><b>مثال ١ (أ):</b> اكتب معادلة المستقيم الذي ميله <span class="text-red-600 font-bold">٤</span> ويمر بالنقطة (<span class="text-red-600 font-bold">٢</span>، <span class="text-blue-600 font-bold">٥</span>).</p>
                                <div class="border p-4 rounded-lg bg-white h-full flex flex-col">
                                    <div class="bg-gray-100 p-4 rounded-lg border flex-grow">
                                        <div id="interactive-explanation-1a" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-1a" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-1a">0</span> / 3</span>
                                        <button id="interactive-next-1a" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>

                            <!-- المثال الأول (ب) -->
                            <div class="flex-1">
                                <p class="mb-2"><b>مثال ١ (ب):</b> اكتب معادلة المستقيم الذي ميله <span class="text-red-600 font-bold">-٢</span> ويمر بالنقطة (<span class="text-red-600 font-bold">-١</span>، <span class="text-blue-600 font-bold">٦</span>).</p>
                                <div class="border p-4 rounded-lg bg-white h-full flex flex-col">
                                    <div class="bg-gray-100 p-4 rounded-lg border flex-grow">
                                        <div id="interactive-explanation-1b" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-1b" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-1b">0</span> / 3</span>
                                        <button id="interactive-next-1b" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- أمثلة: إيجاد المعادلة من نقطتين -->
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4 mb-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">النوع الثاني: إيجاد المعادلة من نقطتين</h3>
                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- المثال الثاني (أ) -->
                             <div class="flex-1">
                                <p class="mb-2"><b>مثال ٢ (أ):</b> اكتب معادلة المستقيم المار بالنقطتين (<span class="text-red-600 font-bold">١</span>، <span class="text-blue-600 font-bold">٢</span>) و (<span class="text-red-600 font-bold">٣</span>، <span class="text-blue-600 font-bold">٨</span>).</p>
                                <div class="border p-4 rounded-lg bg-white h-full flex flex-col">
                                    <div class="bg-gray-100 p-4 rounded-lg border flex-grow">
                                        <div id="interactive-explanation-2a" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-2a" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-2a">0</span> / 3</span>
                                        <button id="interactive-next-2a" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- المثال الثاني (ب) -->
                            <div class="flex-1">
                                <p class="mb-2"><b>مثال ٢ (ب):</b> اكتب معادلة المستقيم المار بالنقطتين (<span class="text-red-600 font-bold">٢</span>، <span class="text-blue-600 font-bold">٥</span>) و (<span class="text-red-600 font-bold">٤</span>، <span class="text-blue-600 font-bold">١</span>).</p>
                                <div class="border p-4 rounded-lg bg-white h-full flex flex-col">
                                    <div class="bg-gray-100 p-4 rounded-lg border flex-grow">
                                        <div id="interactive-explanation-2b" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-2b" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-2b">0</span> / 3</span>
                                        <button id="interactive-next-2b" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- مثال: التنبؤ الخطي -->
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">النوع الثالث: التنبؤ الخطي</h3>
                         <div class="flex flex-col md:flex-row gap-6">
                            <!-- المثال الثالث (أ) - تم التبديل -->
                            <div class="flex-1">
                                <p class="mb-2"><b>مثال ٣ (أ):</b> يدفع علي اشتراكاً في نادٍ رياضي. بعد <span class="text-red-600 font-bold">شهرين</span>، كان مجموع ما دفعه <span class="text-blue-600 font-bold">300 ريال</span>. بعد <span class="text-red-600 font-bold">5 أشهر</span>، كان المجموع <span class="text-blue-600 font-bold">600 ريال</span>. كم سيدفع بعد <span class="text-red-600 font-bold">8 أشهر</span>؟</p>
                                <div class="border p-4 rounded-lg bg-white h-full">
                                    <div class="bg-gray-100 p-4 rounded-lg border min-h-[210px]">
                                        <div id="interactive-explanation-3a" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-3a" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-3a">0</span> / 4</span>
                                        <button id="interactive-next-3a" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>
                            <!-- المثال الثالث (ب) - تم التبديل -->
                            <div class="flex-1">
                                <p class="mb-2"><b>مثال ٣ (ب):</b> يتقاضى طلال أجرة أسبوعية قدرها <span class="text-blue-600 font-bold">٣٥١ ريالاً</span>. فإذا عمل <span class="text-red-600 font-bold">٥ ساعات</span> إضافية وتقاضى <span class="text-blue-600 font-bold">٤١٦ ريالاً</span>، اكتب معادلة خطية لإيجاد أجرته. ثم تنبأ بأجرته إذا عمل <span class="text-red-600 font-bold">٨ ساعات</span> إضافية.</p>
                                <div class="border p-4 rounded-lg bg-white h-full">
                                    <div class="bg-gray-100 p-4 rounded-lg border min-h-[210px]">
                                        <div id="interactive-explanation-3b" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                        <button id="interactive-back-3b" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                        <span class="text-sm font-bold text-gray-600">الخطوة <span id="interactive-step-counter-3b">0</span> / 5</span>
                                        <button id="interactive-next-3b" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ رابعاً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto space-y-2"></div>
        </div>
    </div>
    <script>
    // ===================================================================
    // ⚙️ دوال مشتركة وأنظمة المنصة (لا تقم بتعديل هذا الجزء)
    // ===================================================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function initializeQuiz(lessonId, questions, studentData) { currentQuestions = questions; const quizForm = document.getElementById('quizForm'); if (!quizForm) return; if (questions.length === 0) { quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; return; } let attemptsLeft; if (studentData) { const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 }; attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts; } else { attemptsLeft = 1; } const attemptsCounter = document.getElementById('attempts-counter'); if (attemptsCounter) { attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; } const quizHtml = questions.map((q, index) => { const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); return `<div class="p-4 border-2 border-gray-200 rounded-lg"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-container-${index}" class="mt-2"></div></div>`; }).join(''); quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; if (attemptsLeft <= 0) { const submitBtn = quizForm.querySelector('#submit-quiz-btn'); submitBtn.disabled = true; submitBtn.textContent = 'لا توجد محاولات متبقية'; submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400'); } quizForm.onsubmit = (e) => { e.preventDefault(); let score = 0; questions.forEach((q, index) => { const userAnswer = e.target.elements[`q${index}`]?.value; const feedbackContainer = document.getElementById(`feedback-container-${index}`); feedbackContainer.innerHTML = ''; feedbackContainer.className = 'mt-2 flex flex-col items-start gap-1'; const feedbackEl = document.createElement('div'); if (userAnswer === q.correct) { score++; feedbackEl.textContent = '✔ إجابة صحيحة!'; feedbackEl.className = 'text-sm font-bold text-green-600'; } else { feedbackEl.textContent = `❌ إجابة خاطئة.`; feedbackEl.className = 'text-sm font-bold text-red-600'; } feedbackContainer.appendChild(feedbackEl); const explanationContainer = document.createElement('div'); explanationContainer.className = 'flex items-center gap-4'; const detailedBtn = document.createElement('button'); detailedBtn.type = 'button'; detailedBtn.textContent = 'اعرف لماذا؟'; detailedBtn.className = 'text-xs text-blue-600 hover:underline'; detailedBtn.onclick = () => showExplanation(index, 'detailed'); if (q.smartExplanation) { const smartBtn = document.createElement('button'); smartBtn.type = 'button'; smartBtn.innerHTML = '🧠 الحل الذكي'; smartBtn.className = 'text-xs text-purple-600 hover:underline font-bold'; smartBtn.onclick = () => showExplanation(index, 'smart'); explanationContainer.appendChild(smartBtn); } explanationContainer.appendChild(detailedBtn); feedbackContainer.appendChild(explanationContainer); }); const finalGrade = Math.round((score / questions.length) * 10); const resultsDiv = document.getElementById('quiz-results'); resultsDiv.classList.remove('hidden'); document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; if (studentData) { saveGrade(lessonId, finalGrade, studentData.id); if (attemptsLeft - 1 > 0) { document.getElementById('retake-quiz-btn').classList.remove('hidden'); } } else { document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; } e.target.querySelector('#submit-quiz-btn').disabled = true; }; }
    function saveGrade(lessonId, grade, studentId) { if (!studentId) return; const saveStatus = document.getElementById('save-status'); saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&lessonId=${lessonId}&grade=${grade}`; fetch(url) .then(res => res.json()) .then(result => { if (result.status === 'success') { saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; const studentData = JSON.parse(localStorage.getItem('currentStudent')); if (!studentData.lessons) studentData.lessons = {}; if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; } else { studentData.lessons[lessonId].attempts++; } localStorage.setItem('currentStudent', JSON.stringify(studentData)); } else { throw new Error(result.message); } }) .catch(error => { saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; console.error("Save Grade Error:", error); }); }
    function showExplanation(questionIndex, type) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex]) { const explanationContent = (type === 'smart' && currentQuestions[questionIndex].smartExplanation) ? currentQuestions[questionIndex].smartExplanation : currentQuestions[questionIndex].explanation; explanationText.innerHTML = explanationContent; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }
    
    // ===================================================================
    // ✏️ محتوى الدرس المحدد (هنا تبدأ التعديلات)
    // ===================================================================
    const LESSON_ID = 'c3_l2'; 
    
    function generateQuiz() {
        const questionBank = [
                { 
                    type: 'mcq',
                    level: '⭐',
                    text: 'ما معادلة المستقيم الذي ميله <span class="text-red-600 font-bold">٣</span> ويمر بالنقطة (<span class="text-red-600 font-bold">٢</span>، <span class="text-blue-600 font-bold">١</span>)؟',
                    options: [ 
                        { display: 'ص = ٣س - ٥', value: 'A' }, 
                        { display: 'ص = ٣س + ١', value: 'B' }, 
                        { display: 'ص = ٢س + ٣', value: 'C' }, 
                        { display: 'ص = س + ٣', value: 'D' }
                    ], 
                    correct: 'A',
                    explanation: `<p><b>الطريقة التفصيلية:</b></p>
                                 <p><b>الخطوة 1: التعويض بالميل والنقطة</b></p>
                                 <p>نعوض الميل <span class="math-eq">م=٣</span> والنقطة (<span class="text-red-600">٢</span>، <span class="text-blue-600">١</span>) في المعادلة.</p>
                                 <p class="text-center"><span class="math-eq"><span class="text-blue-600">١</span> = ٣(<span class="text-red-600">٢</span>) + ب</span></p>
                                 <p><b>الخطوة 2: إيجاد المقطع (ب)</b></p>
                                 <p><span class="math-eq">١ = ٦ + ب</span></p>
                                 <p>بطرح ٦ من الطرفين، نجد أن <span class="math-eq">ب = -٥</span>.</p>
                                 <p><b>الخطوة 3: كتابة المعادلة النهائية</b></p>
                                 <p>الآن نعوض الميل <span class="math-eq">م=٣</span> والمقطع <span class="math-eq">ب=-٥</span>.</p>
                                 <p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٣س - ٥</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. استبعاد الخيارات:</b> الميل المعطى هو <span class="math-eq">٣</span>. هذا يعني أن الإجابة يجب أن تكون إما الخيار الأول أو الثاني. نستبعد الخيارات الأخرى.</p>
                                     <p><b>2. التحقق بالتعويض:</b> نجرب النقطة (<span class="text-red-600">٢</span>، <span class="text-blue-600">١</span>) في الخيار الأول: <span class="math-eq">ص = ٣س - ٥</span>.</p>
                                     <p class="text-center"><span class="math-eq"><span class="text-blue-600">١</span> = ٣(<span class="text-red-600">٢</span>) - ٥</span></p>
                                     <p class="text-center"><span class="math-eq">١ = ٦ - ٥</span></p>
                                     <p class="text-center"><span class="math-eq">١ = ١</span> (صحيحة)</p>
                                     <p>بما أن النقطة تحقق المعادلة، فهذه هي الإجابة الصحيحة.</p>`
                },
                { 
                    type: 'mcq', 
                    level: '⭐⭐', 
                    text: 'ما معادلة المستقيم المار بالنقطتين (<span class="text-red-600 font-bold">١</span>، <span class="text-blue-600 font-bold">٦</span>) و (<span class="text-red-600 font-bold">٣</span>، <span class="text-blue-600 font-bold">١٠</span>)؟', 
                    options: [ 
                        { display: 'ص = س + ٥', value: 'A' }, 
                        { display: 'ص = ٢س + ٤', value: 'B' }, 
                        { display: 'ص = -٢س + ٨', value: 'C' }, 
                        { display: 'ص = ٤س + ٢', value: 'D' }
                    ], 
                    correct: 'B', 
                    explanation: `<p><b>الخطوة 1: إيجاد الميل (م)</b></p>
                                  <p>نستخدم النقطتين (<span class="text-red-600">١</span>، <span class="text-blue-600">٦</span>) و (<span class="text-red-600">٣</span>، <span class="text-blue-600">١٠</span>).</p>
                                  <p class="text-center"><span class="math-eq">م = <span class="fraction"><span>١٠ - ٦</span><span>٣ - ١</span></span> = <span class="fraction"><span>٤</span><span>٢</span></span> = ٢</span></p>
                                  <p><b>الخطوة 2: إيجاد المقطع (ب)</b></p>
                                  <p>نستخدم الميل <span class="math-eq">م=٢</span> وإحدى النقاط، مثلاً (<span class="text-red-600">١</span>، <span class="text-blue-600">٦</span>)، ونعوض في <span class="math-eq">ص = م س + ب</span>.</p>
                                  <p><span class="math-eq"><span class="text-blue-600">٦</span> = ٢(<span class="text-red-600">١</span>) + ب</span></p>
                                  <p><span class="math-eq">٦ = ٢ + ب</span> &larr; <span class="math-eq">ب = ٤</span></p>
                                  <p><b>الخطوة 3: كتابة المعادلة النهائية</b></p>
                                  <p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٢س + ٤</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. حساب الميل ذهنياً:</b> فرق الصادات هو <span class="math-eq">١٠ - ٦ = ٤</span>. فرق السينات هو <span class="math-eq">٣ - ١ = ٢</span>.</p>
                                     <p>إذن الميل <span class="math-eq">م = <span class="fraction"><span>٤</span><span>٢</span></span> = ٢</span>.</p>
                                     <p><b>2. البحث في الخيارات:</b> نبحث عن الخيار الذي يحتوي على ميل يساوي <span class="math-eq">٢</span>.</p>
                                     <p>الخيار الوحيد الذي يحقق هذا الشرط هو <span class="math-eq">ص = ٢س + ٤</span>، لذلك هو الإجابة الصحيحة دون الحاجة لحساب المقطع (ب).</p>`
                },
                { 
                    type: 'mcq', 
                    level: '⭐⭐⭐', 
                    text: 'إذا كانت تكلفة استئجار سيارة ليوم واحد هي <span class="text-blue-600 font-bold">٩٠ ريالاً</span>، بالإضافة إلى <span class="text-red-600 font-bold">ريالين</span> لكل كيلومتر مقطوع. ما المعادلة التي تمثل التكلفة (ص) لقطع (س) كيلومتر؟', 
                    options: [ 
                        { display: 'ص = ٩٠س + ٢', value: 'A' }, 
                        { display: 'ص = ٢س + ٩٠', value: 'B' }, 
                        { display: 'ص = ٩٢س', value: 'C' }, 
                        { display: 'ص = ٢س - ٩٠', value: 'D' }
                    ], 
                    correct: 'B', 
                    explanation: `<p><b>الخطوة 1: تحديد المقطع الصادي (ب)</b></p>
                                  <p>المقطع (ب) هو التكلفة الأولية أو الثابتة، وهي هنا ٩٠ ريالاً. إذن <span class="math-eq">ب = ٩٠</span>.</p>
                                  <p><b>الخطوة 2: تحديد الميل (م)</b></p>
                                  <p>الميل (م) هو معدل التغير، وهو هنا ريالان لكل كيلومتر. إذن <span class="math-eq">م = ٢</span>.</p>
                                  <p><b>الخطوة 3: كتابة المعادلة النهائية</b></p>
                                  <p>نعوض (م) و (ب) في صيغة <span class="math-eq">ص = م س + ب</span>.</p>
                                  <p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٢س + ٩٠</span></p>`
                },
                {
                    type: 'mcq',
                    level: '⭐',
                    text: 'ما معادلة المستقيم الذي ميله <span class="text-red-600 font-bold">-١</span> ويمر بالنقطة (<span class="text-red-600 font-bold">٥</span>، <span class="text-blue-600 font-bold">-٢</span>)؟',
                    options: [
                        { display: 'ص = -س + ٣', value: 'A' },
                        { display: 'ص = -س - ٧', value: 'B' },
                        { display: 'ص = س - ٧', value: 'C' },
                        { display: 'ص = ٥س - ٢', value: 'D' }
                    ],
                    correct: 'A',
                    explanation: `<p><b>الخطوة 1: التعويض بالميل والنقطة</b></p><p>نعوض الميل <span class="math-eq">م=-١</span> والنقطة (<span class="text-red-600">٥</span>، <span class="text-blue-600">-٢</span>) في المعادلة <span class="math-eq">ص = م س + ب</span>.</p><p class="text-center"><span class="math-eq"><span class="text-blue-600">-٢</span> = -١(<span class="text-red-600">٥</span>) + ب</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p><span class="math-eq">-٢ = -٥ + ب</span></p><p>بإضافة ٥ للطرفين، نجد أن <span class="math-eq">ب = ٣</span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = -س + ٣</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. استبعاد الخيارات:</b> الميل المعطى هو <span class="math-eq">-١</span>. هذا يحصر الإجابة بين الخيارين الأول والثاني.</p>
                                     <p><b>2. التحقق بالتعويض:</b> نجرب النقطة (<span class="text-red-600">٥</span>، <span class="text-blue-600">-٢</span>) في الخيار الأول: <span class="math-eq">ص = -س + ٣</span>.</p>
                                     <p class="text-center"><span class="math-eq"><span class="text-blue-600">-٢</span> = -(<span class="text-red-600">٥</span>) + ٣</span></p>
                                     <p class="text-center"><span class="math-eq">-٢ = -٥ + ٣</span></p>
                                     <p class="text-center"><span class="math-eq">-٢ = -٢</span> (صحيحة)</p>
                                     <p>بما أن النقطة تحقق المعادلة، فهذه هي الإجابة الصحيحة.</p>`
                },
                {
                    type: 'mcq',
                    level: '⭐',
                    text: 'ما معادلة المستقيم الذي ميله <span class="fraction"><span>١</span><span>٢</span></span> ويمر بالنقطة (<span class="text-red-600 font-bold">٤</span>، <span class="text-blue-600 font-bold">١</span>)؟',
                    options: [
                        { display: 'ص = ٢س - ٧', value: 'A' },
                        { display: 'ص = <span class="fraction"><span>١</span><span>٢</span></span>س + ١', value: 'B' },
                        { display: 'ص = <span class="fraction"><span>١</span><span>٢</span></span>س - ١', value: 'C' },
                        { display: 'ص = ٤س + ١', value: 'D' }
                    ],
                    correct: 'C',
                    explanation: `<p><b>الخطوة 1: التعويض بالميل والنقطة</b></p><p>نعوض الميل <span class="math-eq">م = <span class="fraction"><span>١</span><span>٢</span></span></span> والنقطة (<span class="text-red-600">٤</span>، <span class="text-blue-600">١</span>) في المعادلة <span class="math-eq">ص = م س + ب</span>.</p><p class="text-center"><span class="math-eq"><span class="text-blue-600">١</span> = <span class="fraction"><span>١</span><span>٢</span></span>(<span class="text-red-600">٤</span>) + ب</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p><span class="math-eq">١ = ٢ + ب</span></p><p>بطرح ٢ من الطرفين، نجد أن <span class="math-eq">ب = -١</span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = <span class="fraction"><span>١</span><span>٢</span></span>س - ١</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. استبعاد الخيارات:</b> الميل المعطى هو <span class="math-eq"><span class="fraction"><span>١</span><span>٢</span></span></span>. هذا يحصر الإجابة بين الخيارين الثاني والثالث.</p>
                                     <p><b>2. التحقق بالتعويض:</b> نجرب النقطة (<span class="text-red-600">٤</span>، <span class="text-blue-600">١</span>) في الخيار الثالث: <span class="math-eq">ص = <span class="fraction"><span>١</span><span>٢</span></span>س - ١</span>.</p>
                                     <p class="text-center"><span class="math-eq"><span class="text-blue-600">١</span> = <span class="fraction"><span>١</span><span>٢</span></span>(<span class="text-red-600">٤</span>) - ١</span></p>
                                     <p class="text-center"><span class="math-eq">١ = ٢ - ١</span></p>
                                     <p class="text-center"><span class="math-eq">١ = ١</span> (صحيحة)</p>
                                     <p>بما أن النقطة تحقق المعادلة، فهذه هي الإجابة الصحيحة.</p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    text: 'ما معادلة المستقيم المار بنقطة الأصل (<span class="text-red-600 font-bold">٠</span>، <span class="text-blue-600 font-bold">٠</span>) والنقطة (<span class="text-red-600 font-bold">٢</span>، <span class="text-blue-600 font-bold">٦</span>)؟',
                    options: [
                        { display: 'ص = ٦س + ٢', value: 'A' },
                        { display: 'ص = ٣س', value: 'B' },
                        { display: 'ص = ٢س + ٦', value: 'C' },
                        { display: 'ص = -٣س', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: `<p><b>الخطوة 1: إيجاد الميل (م)</b></p><p>نستخدم النقطتين (<span class="text-red-600">٠</span>، <span class="text-blue-600">٠</span>) و (<span class="text-red-600">٢</span>، <span class="text-blue-600">٦</span>).</p><p class="text-center"><span class="math-eq">م = <span class="fraction"><span>٦ - ٠</span><span>٢ - ٠</span></span> = <span class="fraction"><span>٦</span><span>٢</span></span> = ٣</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p>بما أن المستقيم يمر بنقطة الأصل، فإن المقطع الصادي <span class="math-eq">ب = ٠</span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٣س</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. استبعاد الخيارات:</b> بما أن المستقيم يمر بنقطة الأصل (<span class="math-eq">٠، ٠</span>)، يجب أن يكون المقطع الصادي (ب) يساوي صفراً. هذا يستبعد الخيارات التي تحتوي على <span class="math-eq">+ ب</span>.</p>
                                     <p>الخيارات المتبقية هي <span class="math-eq">ص = ٣س</span> و <span class="math-eq">ص = -٣س</span>.</p>
                                     <p><b>2. التحقق بالتعويض:</b> نجرب النقطة الثانية (<span class="text-red-600">٢</span>، <span class="text-blue-600">٦</span>) في الخيار <span class="math-eq">ص = ٣س</span>.</p>
                                     <p class="text-center"><span class="math-eq"><span class="text-blue-600">٦</span> = ٣(<span class="text-red-600">٢</span>)</span></p>
                                     <p class="text-center"><span class="math-eq">٦ = ٦</span> (صحيحة)</p>
                                     <p>إذن هذه هي الإجابة الصحيحة.</p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    text: 'ما معادلة المستقيم المار بالنقطتين (<span class="text-red-600 font-bold">-٢</span>، <span class="text-blue-600 font-bold">٤</span>) و (<span class="text-red-600 font-bold">١</span>، <span class="text-blue-600 font-bold">-٢</span>)؟',
                    options: [
                        { display: 'ص = ٢س + ٨', value: 'A' },
                        { display: 'ص = -٢س - ٨', value: 'B' },
                        { display: 'ص = -٢س', value: 'C' },
                        { display: 'ص = -<span class="fraction"><span>١</span><span>٢</span></span>س + ٣', value: 'D' }
                    ],
                    correct: 'C',
                    explanation: `<p><b>الخطوة 1: إيجاد الميل (م)</b></p><p>نستخدم النقطتين (<span class="text-red-600">-٢</span>، <span class="text-blue-600">٤</span>) و (<span class="text-red-600">١</span>، <span class="text-blue-600">-٢</span>).</p><p class="text-center"><span class="math-eq">م = <span class="fraction"><span>-٢ - ٤</span><span>١ - (-٢)</span></span> = <span class="fraction"><span>-٦</span><span>٣</span></span> = -٢</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p>نستخدم الميل <span class="math-eq">م=-٢</span> والنقطة (<span class="text-red-600">١</span>، <span class="text-blue-600">-٢</span>).</p><p class="text-center"><span class="math-eq"><span class="text-blue-600">-٢</span> = -٢(<span class="text-red-600">١</span>) + ب</span></p><p><span class="math-eq">-٢ = -٢ + ب</span> &larr; <span class="math-eq">ب = ٠</span></p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = -٢س</span></p>`,
                    smartExplanation: `<p><b>🧠 طريقة سريعة (حل ذكي):</b></p>
                                     <p><b>1. حساب الميل ذهنياً:</b> فرق الصادات هو <span class="math-eq">-٢ - ٤ = -٦</span>. فرق السينات هو <span class="math-eq">١ - (-٢) = ٣</span>.</p>
                                     <p>إذن الميل <span class="math-eq">م = <span class="fraction"><span>-٦</span><span>٣</span></span> = -٢</span>.</p>
                                     <p><b>2. البحث في الخيارات:</b> نبحث عن الخيار الذي ميله <span class="math-eq">-٢</span>. الخيارات (B) و (C) تحقق ذلك.</p>
                                     <p><b>3. التحقق بالتعويض:</b> نجرب النقطة (<span class="text-red-600">١</span>، <span class="text-blue-600">-٢</span>) في الخيار (C): <span class="math-eq">ص = -٢س</span>.</p>
                                     <p class="text-center"><span class="math-eq"><span class="text-blue-600">-٢</span> = -٢(<span class="text-red-600">١</span>)</span></p>
                                     <p class="text-center"><span class="math-eq">-٢ = -٢</span> (صحيحة)</p>
                                     <p>إذن الخيار (C) هو الإجابة الصحيحة.</p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    text: 'ما معادلة المستقيم المار بالنقطتين (<span class="text-red-600 font-bold">-٤</span>، <span class="text-blue-600 font-bold">٢</span>) و (<span class="text-red-600 font-bold">١</span>، <span class="text-blue-600 font-bold">٧</span>)؟',
                    options: [
                        { display: 'ص = س + ٦', value: 'A' },
                        { display: 'ص = س - ٦', value: 'B' },
                        { display: 'ص = -س + ٢', value: 'C' },
                        { display: 'ص = ٥س + ٢٢', value: 'D' }
                    ],
                    correct: 'A',
                    explanation: `<p><b>الخطوة 1: إيجاد الميل (م)</b></p><p>نستخدم النقطتين (<span class="text-red-600">-٤</span>، <span class="text-blue-600">٢</span>) و (<span class="text-red-600">١</span>، <span class="text-blue-600">٧</span>).</p><p class="text-center"><span class="math-eq">م = <span class="fraction"><span>٧ - ٢</span><span>١ - (-٤)</span></span> = <span class="fraction"><span>٥</span><span>٥</span></span> = ١</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p>نستخدم الميل <span class="math-eq">م=١</span> والنقطة (<span class="text-red-600">١</span>، <span class="text-blue-600">٧</span>).</p><p class="text-center"><span class="math-eq"><span class="text-blue-600">٧</span> = ١(<span class="text-red-600">١</span>) + ب</span></p><p><span class="math-eq">٧ = ١ + ب</span> &larr; <span class="math-eq">ب = ٦</span></p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = س + ٦</span></p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    text: 'باقة جوال تكلفتها الشهرية الثابتة <span class="text-blue-600 font-bold">٥٠ ريالاً</span>، بالإضافة إلى <span class="text-red-600 font-bold">نصف ريال</span> لكل دقيقة اتصال إضافية. ما المعادلة التي تمثل التكلفة (ص) لـ (س) دقيقة إضافية؟',
                    options: [
                        { display: 'ص = ٥٠س + <span class="fraction"><span>١</span><span>٢</span></span>', value: 'A' },
                        { display: 'ص = <span class="fraction"><span>١</span><span>٢</span></span>س + ٥٠', value: 'B' },
                        { display: 'ص = ٥٠<span class="fraction"><span>١</span><span>٢</span></span>س', value: 'C' },
                        { display: 'ص = ٥٠س', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: `<p><b>الخطوة 1: تحديد المقطع الصادي (ب)</b></p><p>المقطع (ب) هو التكلفة الثابتة، وهي هنا ٥٠ ريالاً. إذن <span class="math-eq">ب = ٥٠</span>.</p><p><b>الخطوة 2: تحديد الميل (م)</b></p><p>الميل (م) هو تكلفة الدقيقة الإضافية، وهو هنا نصف ريال. إذن <span class="math-eq">م = <span class="fraction"><span>١</span><span>٢</span></span></span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = <span class="fraction"><span>١</span><span>٢</span></span>س + ٥٠</span></p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    text: 'طول نبتة <span class="text-blue-600 font-bold">١٠ سم</span>، وتنمو بمعدل <span class="text-red-600 font-bold">٢ سم</span> كل أسبوع. ما المعادلة التي تمثل طولها (ص) بعد (س) أسبوع؟',
                    options: [
                        { display: 'ص = ١٠س + ٢', value: 'A' },
                        { display: 'ص = ١٢س', value: 'B' },
                        { display: 'ص = ٢س + ١٠', value: 'C' },
                        { display: 'ص = ٢س - ١٠', value: 'D' }
                    ],
                    correct: 'C',
                    explanation: `<p><b>الخطوة 1: تحديد المقطع الصادي (ب)</b></p><p>المقطع (ب) هو الطول الابتدائي للنبتة، وهو هنا ١٠ سم. إذن <span class="math-eq">ب = ١٠</span>.</p><p><b>الخطوة 2: تحديد الميل (م)</b></p><p>الميل (م) هو معدل النمو، وهو هنا ٢ سم لكل أسبوع. إذن <span class="math-eq">م = ٢</span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٢س + ١٠</span></p>`
                },
                 {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    text: 'بعد <span class="text-red-600 font-bold">ساعة</span> من بدء رحلة، قطعت سيارة مسافة <span class="text-blue-600 font-bold">٨٠ كم</span>. وبعد <span class="text-red-600 font-bold">٣ ساعات</span>، قطعت <span class="text-blue-600 font-bold">٢٤٠ كم</span>. افترض أن السرعة ثابتة، ما المعادلة التي تربط المسافة (ص) بالزمن (س)؟',
                    options: [
                        { display: 'ص = ٨٠س', value: 'A' },
                        { display: 'ص = ١٦٠س - ٨٠', value: 'B' },
                        { display: 'ص = ٨٠س + ٨٠', value: 'C' },
                        { display: 'ص = ٢٤٠س', value: 'D' }
                    ],
                    correct: 'A',
                    explanation: `<p><b>الخطوة 1: إيجاد الميل (م)</b></p><p>لدينا نقطتان: (<span class="text-red-600">١</span>، <span class="text-blue-600">٨٠</span>) و (<span class="text-red-600">٣</span>، <span class="text-blue-600">٢٤٠</span>). الميل هنا يمثل السرعة.</p><p class="text-center"><span class="math-eq">م = <span class="fraction"><span>٢٤٠ - ٨٠</span><span>٣ - ١</span></span> = <span class="fraction"><span>١٦٠</span><span>٢</span></span> = ٨٠</span></p><p><b>الخطوة 2: إيجاد المقطع (ب)</b></p><p>نستخدم الميل <span class="math-eq">م=٨٠</span> والنقطة (<span class="text-red-600">١</span>، <span class="text-blue-600">٨٠</span>).</p><p class="text-center"><span class="math-eq"><span class="text-blue-600">٨٠</span> = ٨٠(<span class="text-red-600">١</span>) + ب</span></p><p><span class="math-eq">٨٠ = ٨٠ + ب</span> &larr; <span class="math-eq">ب = ٠</span></p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ٨٠س</span></p>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    text: 'مكتبة عامة تحتوي على <span class="text-blue-600 font-bold">٢٠٠٠ كتاب</span>. وتخطط المكتبة لشراء <span class="text-red-600 font-bold">١٥٠ كتاباً</span> جديداً كل عام. ما المعادلة التي تمثل عدد الكتب (ص) بعد (س) سنة؟',
                    options: [
                        { display: 'ص = ٢٠٠٠س + ١٥٠', value: 'A' },
                        { display: 'ص = ١٥٠س - ٢٠٠٠', value: 'B' },
                        { display: 'ص = ٢١٥٠س', value: 'C' },
                        { display: 'ص = ١٥٠س + ٢٠٠٠', value: 'D' }
                    ],
                    correct: 'D',
                    explanation: `<p><b>الخطوة 1: تحديد المقطع الصادي (ب)</b></p><p>المقطع (ب) هو العدد الابتدائي للكتب، وهو هنا ٢٠٠٠ كتاب. إذن <span class="math-eq">ب = ٢٠٠٠</span>.</p><p><b>الخطوة 2: تحديد الميل (م)</b></p><p>الميل (م) هو معدل الزيادة السنوي، وهو هنا ١٥٠ كتاباً. إذن <span class="math-eq">م = ١٥٠</span>.</p><p><b>الخطوة 3: كتابة المعادلة النهائية</b></p><p class="text-center p-2 bg-green-100 rounded-md"><span class="math-eq">ص = ١٥٠س + ٢٠٠٠</span></p>`
                }
            ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        const questionCount = Math.min(shuffled.length, 5);
        return shuffled.slice(0, questionCount);
    }

    // ===================================================================
    // ⚙️ مشغل الكود (لا تقم بتعديل هذا الجزء)
    // ===================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Code from OLD lesson for interactive examples ---
        const configs = {
            "1a": {
                totalSteps: 3, 
                stepsContent: [
                    { text: "نبدأ بصيغة الميل والمقطع: <span class='math-eq'>ص = م س + ب</span>." },
                    { text: `<strong>1. نعوض بالمعطيات:</strong><br>الميل <span class='math-eq'>م = ٤</span>، والنقطة (<span class="text-red-600">٢</span>، <span class="text-blue-600">٥</span>).<br><span class='math-eq'><span class="text-blue-600">٥</span> = ٤(<span class="text-red-600">٢</span>) + ب</span>` },
                    { text: "<strong>2. نحل المعادلة لإيجاد (ب):</strong><br><span class='math-eq'>٥ = ٨ + ب</span><br>بطرح ٨ من الطرفين، نجد أن:<br><span class='math-eq'>ب = -٣</span>" },
                    { text: `<strong>3. نكتب المعادلة النهائية:</strong><br>الآن بعد أن عرفنا أن <span class='math-eq'>م = ٤</span> و <span class='math-eq'>ب = -٣</span>، نكتب المعادلة النهائية:<br><div class="text-center mt-2 p-2 bg-green-100 rounded-md"><span class='math-eq'>ص = ٤س - ٣</span></div>` }
                ]
            },
            "1b": {
                totalSteps: 3,
                stepsContent: [
                    { text: "نبدأ بصيغة الميل والمقطع: <span class='math-eq'>ص = م س + ب</span>." },
                    { text: `<strong>1. نعوض بالمعطيات:</strong><br>الميل <span class='math-eq'>م = -٢</span>، والنقطة (<span class="text-red-600">-١</span>، <span class="text-blue-600">٦</span>).<br><span class='math-eq'><span class="text-blue-600">٦</span> = -٢(<span class="text-red-600">-١</span>) + ب</span>` },
                    { text: "<strong>2. نحل المعادلة لإيجاد (ب):</strong><br><span class='math-eq'>٦ = ٢ + ب</span><br>بطرح ٢ من الطرفين، نجد أن:<br><span class='math-eq'>ب = ٤</span>" },
                    { text: `<strong>3. نكتب المعادلة النهائية:</strong><br>وجدنا أن <span class='math-eq'>م = -٢</span> و <span class='math-eq'>ب = ٤</span>. إذن المعادلة هي:<br><div class="text-center mt-2 p-2 bg-green-100 rounded-md"><span class='math-eq'>ص = -٢س + ٤</span></div>` }
                ]
            },
            "2a": {
                totalSteps: 3, 
                stepsContent: [
                    { text: "لدينا نقطتان، لذلك سنقوم بثلاث خطوات بسيطة للوصول للحل." },
                    { text: `<strong>الخطوة 1: نجد الميل (م)</strong><br>نستخدم النقطتين (<span class="text-red-600">١</span>، <span class="text-blue-600">٢</span>) و (<span class="text-red-600">٣</span>، <span class="text-blue-600">٨</span>).<br><span class='math-eq'>م = <span class="fraction"><span>فرق الصادات</span><span>فرق السينات</span></span> = <span class="fraction"><span><span class="text-blue-600">٨</span> - <span class="text-blue-600">٢</span></span><span><span class="text-red-600">٣</span> - <span class="text-red-600">١</span></span></span> = <span class="fraction"><span>٦</span><span>٢</span></span> = ٣</span>` },
                    { text: `<strong>الخطوة 2: نجد المقطع (ب)</strong><br>الآن نعرف أن <span class='math-eq'>م = ٣</span>. نستخدم النقطة (<span class="text-red-600">١</span>، <span class="text-blue-600">٢</span>) ونعوض في <span class='math-eq'>ص = م س + ب</span>.<br><span class='math-eq'><span class="text-blue-600">٢</span> = ٣(<span class="text-red-600">١</span>) + ب</span><br><span class='math-eq'>٢ = ٣ + ب</span>  &larr;  <span class='math-eq'>ب = -١</span>` },
                    { text: `<strong>الخطوة 3: نكتب المعادلة النهائية</strong><br>وجدنا أن <span class='math-eq'>م = ٣</span> و <span class='math-eq'>ب = -١</span>. إذن المعادلة هي:<br><div class="text-center mt-2 p-2 bg-green-100 rounded-md"><span class='math-eq'>ص = ٣س - ١</span></div>` }
                ]
            },
            "2b": {
                totalSteps: 3,
                stepsContent: [
                    { text: "لدينا نقطتان، لذلك سنقوم بثلاث خطوات بسيطة للوصول للحل." },
                    { text: `<strong>الخطوة 1: نجد الميل (م)</strong><br>نستخدم النقطتين (<span class="text-red-600">٢</span>، <span class="text-blue-600">٥</span>) و (<span class="text-red-600">٤</span>، <span class="text-blue-600">١</span>).<br><span class='math-eq'>م = <span class="fraction"><span>فرق الصادات</span><span>فرق السينات</span></span> = <span class="fraction"><span><span class="text-blue-600">١</span> - <span class="text-blue-600">٥</span></span><span><span class="text-red-600">٤</span> - <span class="text-red-600">٢</span></span></span> = <span class="fraction"><span>-٤</span><span>٢</span></span> = -٢</span>` },
                    { text: `<strong>الخطوة 2: نجد المقطع (ب)</strong><br>الآن نعرف أن <span class='math-eq'>م = -٢</span>. نستخدم النقطة (<span class="text-red-600">٢</span>، <span class="text-blue-600">٥</span>) ونعوض في <span class='math-eq'>ص = م س + ب</span>.<br><span class='math-eq'><span class="text-blue-600">٥</span> = -٢(<span class="text-red-600">٢</span>) + ب</span><br><span class='math-eq'>٥ = -٤ + ب</span>  &larr;  <span class='math-eq'>ب = ٩</span>` },
                    { text: `<strong>الخطوة 3: نكتب المعادلة النهائية</strong><br>وجدنا أن <span class='math-eq'>م = -٢</span> و <span class='math-eq'>ب = ٩</span>. إذن المعادلة هي:<br><div class="text-center mt-2 p-2 bg-green-100 rounded-md"><span class='math-eq'>ص = -٢س + ٩</span></div>` }
                ]
            },
            "3a": {
                totalSteps: 4,
                stepsContent: [
                    { text: "لحل هذه المسألة، علينا أولاً إيجاد معادلة الخط المستقيم التي تمثل تكلفة الاشتراك." },
                    { text: `<strong>الخطوة 1: نحدد النقطتين</strong><br>نعتبر عدد الأشهر هو (س) والتكلفة هي (ص).<br>النقطة الأولى: بعد شهرين (س=٢) كانت التكلفة ٣٠٠ ريال &larr; (<span class="text-red-600">٢</span>، <span class="text-blue-600">٣٠٠</span>).<br>النقطة الثانية: بعد ٥ أشهر (س=٥) كانت التكلفة ٦٠٠ ريال &larr; (<span class="text-red-600">٥</span>، <span class="text-blue-600">٦٠٠</span>).` },
                    { text: `<strong>الخطوة 2: نجد الميل (م)</strong><br>الميل يمثل التكلفة الشهرية.<br><span class='math-eq'>م = <span class="fraction"><span>٦٠٠ - ٣٠٠</span><span>٥ - ٢</span></span> = <span class="fraction"><span>٣٠٠</span><span>٣</span></span> = ١٠٠</span> ريال لكل شهر.` },
                    { text: `<strong>الخطوة 3: نجد المعادلة</strong><br>نستخدم الميل <span class='math-eq'>م = ١٠٠</span> والنقطة (<span class="text-red-600">٢</span>، <span class="text-blue-600">٣٠٠</span>) لإيجاد (ب) (رسوم التسجيل الأولية).<br><span class='math-eq'>٣٠٠ = ١٠٠(٢) + ب</span>  &larr;  <span class='math-eq'>٣٠٠ = ٢٠٠ + ب</span>  &larr;  <span class='math-eq'>ب = ١٠٠</span>.<br>إذن المعادلة هي: <span class='math-eq'>ص = ١٠٠س + ١٠٠</span>.` },
                    { text: `<strong>الخطوة 4: نتنبأ بالتكلفة بعد ٨ أشهر</strong><br>نعوض <span class='math-eq'>س = ٨</span> في المعادلة.<br><span class='math-eq'>ص = ١٠٠(٨) + ١٠٠</span><br><span class='math-eq'>ص = ٨٠٠ + ١٠٠ = ٩٠٠</span><br><div class="text-center mt-2 p-2 bg-green-100 rounded-md">إذن، سيكون علي قد دفع ٩٠٠ ريال بعد ٨ أشهر.</div>` }
                ]
            },
            "3b": {
                totalSteps: 5,
                stepsContent: [
                    { text: "لإيجاد المعادلة والتنبؤ بالأجرة، علينا أولاً تحديد الميل (م) والمقطع الصادي (ب)." },
                    { text: `<strong>الخطوة 1: نحدد نقطتين من المسألة</strong><br>نعتبر عدد الساعات الإضافية هو (س) والأجرة الإجمالية هي (ص).<br>الراتب الأساسي (عند س=٠ ساعات) هو ٣٥١ ريال &larr; النقطة (<span class="text-red-600">٠</span>، <span class="text-blue-600">٣٥١</span>).<br>بعد ٥ ساعات إضافية، الأجرة ٤١٦ ريال &larr; النقطة (<span class="text-red-600">٥</span>، <span class="text-blue-600">٤١٦</span>).` },
                    { text: `<strong>الخطوة 2: نجد الميل (م)</strong><br>الميل هو الأجرة لكل ساعة إضافية.<br><span class='math-eq'>م = <span class="fraction"><span>٤١٦ - ٣٥١</span><span>٥ - ٠</span></span> = <span class="fraction"><span>٦٥</span><span>٥</span></span> = ١٣</span>` },
                    { text: `<strong>الخطوة 3: نجد المقطع (ب)</strong><br>نعوض الميل <span class='math-eq'>م = ١٣</span> والنقطة الأسهل (<span class='math-eq'>(٠، ٣٥١)</span>) في المعادلة <span class='math-eq'>ص = م س + ب</span>.<br><span class='math-eq'><span class="text-blue-600">٣٥١</span> = ١٣(<span class="text-red-600">٠</span>) + ب</span><br><span class='math-eq'>٣٥١ = ٠ + ب</span> &larr; <span class='math-eq'>ب = ٣٥١</span>` },
                    { text: `<strong>الخطوة 4: نكتب المعادلة</strong><br>الميل (م) = ١٣ والمقطع (ب) = ٣٥١.<br>إذن المعادلة هي:<br><div class="text-center mt-2 p-2 bg-blue-100 rounded-md"><span class='math-eq'>ص = ١٣س + ٣٥١</span></div>` },
                    { text: `<strong>الخطوة 5: نتنبأ بالأجرة لـ ٨ ساعات</strong><br>نعوض س = ٨ في المعادلة.<br><span class='math-eq'>ص = ١٣(٨) + ٣٥١</span><br><span class='math-eq'>ص = ١٠٤ + ٣٥١ = ٤٥٥</span><br><div class="text-center mt-2 p-2 bg-green-100 rounded-md">إذن، ستكون أجرته ٤٥٥ ريالاً.</div>` }
                ]
            }
        };

        function createInteractiveSection(config) {
            let currentStep = 0;
            const renderStep = (step) => {
                if(config.stepCounter) config.stepCounter.textContent = step;
                
                let cumulativeHTML = '';
                if (config.stepsContent.length > 0) {
                    if(config.stepsContent[0]) {
                        cumulativeHTML = `<div class="explanation-step" style="opacity:1; border: none; padding-right: 0;">${config.stepsContent[0].text}</div>`;
                    }
                    for (let i = 1; i <= step; i++) {
                        if(config.stepsContent[i]) {
                            cumulativeHTML += `<div class="explanation-step" style="opacity:1;">${config.stepsContent[i].text}</div>`;
                        }
                    }
                }
                if(config.explanationDiv) config.explanationDiv.innerHTML = cumulativeHTML;
                
                if(config.backBtn) config.backBtn.disabled = (step === 0);
                if(config.nextBtn) config.nextBtn.textContent = (step === config.totalSteps) ? 'إعادة' : 'التالي';
            };
            
            if(config.nextBtn) config.nextBtn.addEventListener('click', () => {
                currentStep = (currentStep < config.totalSteps) ? currentStep + 1 : 0;
                renderStep(currentStep);
            });
            
            if(config.backBtn) config.backBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    renderStep(currentStep);
                }
            });
            
            renderStep(0);
        }

        function initOldExamples() {
            Object.keys(configs).forEach(key => {
                createInteractiveSection({
                    nextBtn: document.getElementById(`interactive-next-${key}`),
                    backBtn: document.getElementById(`interactive-back-${key}`),
                    stepCounter: document.getElementById(`interactive-step-counter-${key}`),
                    explanationDiv: document.getElementById(`interactive-explanation-${key}`),
                    ...configs[key]
                });
            });
        }
        // --- END: Code from OLD lesson ---

        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();
        
        // Initialize OLD examples
        initOldExamples();

        // Initialize NEW quiz
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
    });
    </script>
</body>
</html>

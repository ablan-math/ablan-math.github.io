<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>مغامرة سفينة الكنز</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for a nice Arabic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply the Cairo font to the body */
        body, html {
            font-family: 'Cairo', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        /* Custom styling for the canvas for better interaction */
        canvas {
            cursor: crosshair;
            touch-action: none; /* Disable panning on touch devices */
            width: 100%;
            height: auto;
            display: block;
        }
        /* Make game screen take full height */
        #game-screen, .canvas-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* Center canvas horizontally */
        }
        /* FIX: Correct transition handling for screens */
        .screen {
            transition: opacity 0.5s ease-in-out;
            opacity: 0; /* Screens are invisible by default */
        }
        /* Tailwind's 'hidden' class will set display: none */
    </style>
</head>
<body class="bg-blue-50">

    <div id="app-container" class="w-full h-full p-2 flex flex-col">

        <!-- ============== START SCREEN ============== -->
        <div id="start-screen" class="screen hidden text-center p-2 sm:p-4">
            <header class="my-6 md:my-8">
                <h1 class="text-3xl md:text-5xl font-bold text-blue-800">🏴‍☠️ مغامرة سفينة الكنز 🏴‍☠️</h1>
                <p id="welcomeMessage" class="text-base md:text-lg text-gray-600 mt-4 px-4">
                    انطلق في رحلتك عبر البحار الغامضة، وحل ألغاز الإحداثيات للوصول إلى الكنوز المخفية. كل إجابة صحيحة تقربك من هدفك!
                </p>
            </header>
            
            <div class="my-8 md:my-12">
                <button id="start-game-button" class="bg-yellow-500 text-yellow-900 font-bold text-xl md:text-2xl py-3 px-6 md:py-4 md:px-8 rounded-xl hover:bg-yellow-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-400 shadow-lg">
                    ابدأ المغامرة!
                </button>
            </div>

            <div class="mt-12 md:mt-16 bg-white p-4 rounded-xl shadow-md border max-w-md mx-auto">
                <h2 class="text-lg md:text-xl font-bold text-blue-900">آخر نتيجة محفوظة</h2>
                <p id="saved-score-display" class="text-2xl md:text-3xl font-bold text-red-600 mt-2">
                    لم تلعب بعد
                </p>
                <p class="text-sm text-gray-500 mt-1">(النتيجة تحفظ في متصفحك)</p>
            </div>
        </div>

        <!-- ============== GAME SCREEN ============== -->
        <div id="game-screen" class="screen hidden relative">
             <!-- Canvas Container -->
            <div class="canvas-container bg-white rounded-xl shadow-lg overflow-hidden border-4 border-blue-300 w-full">
                <canvas id="game-canvas"></canvas>
            </div>
            
            <!-- Top Info Bar Overlay -->
            <div class="absolute top-4 left-1/2 -translate-x-1/2 w-11/12 max-w-sm flex justify-between items-center bg-gray-900 bg-opacity-60 text-white p-2 rounded-xl text-sm sm:text-base pointer-events-none">
                <div class="flex items-center gap-2">
                    <span>⏳</span>
                    <span id="timer">٠</span>
                </div>
                <div id="target-coords" class="text-lg sm:text-xl font-bold">(-,-)</div>
            </div>

            <!-- Treasure Number Prompt Overlay -->
            <div id="treasure-prompt-overlay" class="absolute inset-0 flex justify-center items-center bg-black bg-opacity-70 text-white text-4xl font-bold pointer-events-none transition-opacity duration-500 opacity-0">
                <!-- Content set by JS -->
            </div>
            
            <!-- Message Box Overlay -->
            <div id="message-box-overlay" class="absolute inset-x-0 bottom-4 mx-auto w-11/12 md:w-1/2 transition-opacity duration-500 opacity-0 pointer-events-none">
                 <div id="message-box" class="p-3 rounded-lg text-center font-bold text-md shadow-xl">
                    <!-- Messages will appear here -->
                </div>
            </div>
        </div>

        <!-- ============== RESULT SCREEN ============== -->
        <div id="result-screen" class="screen hidden text-center p-2 sm:p-4">
             <header class="my-6 md:my-8">
                <h1 class="text-3xl md:text-5xl font-bold text-green-800">🎉 انتهت المغامرة! 🎉</h1>
                <p class="text-base md:text-lg text-gray-600 mt-4">
                    هذه هي نتيجتك النهائية.
                </p>
            </header>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl border-2 border-green-300 max-w-2xl mx-auto">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">النتيجة النهائية</h2>
                
                <div id="final-result-display" class="text-center text-xl mt-4"></div>

                <div id="leaderboard-loader" style="display: none;" class="text-center mt-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                    <p>جاري تحميل سجل الأبطال...</p>
                </div>

                <div id="leaderboard-container" class="mt-4"></div>

            </div>

            <div id="finish-game-wrapper" style="display: none;" class="my-8 md:my-12 flex justify-center items-center gap-4">
                <button id="play-again-button" class="bg-blue-600 text-white font-bold text-xl md:text-2xl py-3 px-6 md:py-4 md:px-8 rounded-xl hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-400 shadow-lg">
                    العب مرة أخرى
                </button>
                <button id="finish-game-btn" class="bg-green-600 text-white font-bold text-xl md:text-2xl py-3 px-6 md:py-4 md:px-8 rounded-xl hover:bg-green-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400 shadow-lg">
                    إنهاء
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Screen Elements ---
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const resultScreen = document.getElementById('result-screen');

            // --- Button Elements ---
            const startGameButton = document.getElementById('start-game-button');
            const playAgainButton = document.getElementById('play-again-button');

            // --- Display Elements ---
            const savedScoreDisplay = document.getElementById('saved-score-display');
            const timerDisplay = document.getElementById('timer');

            // --- Game Elements ---
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const targetCoordsEl = document.getElementById('target-coords');
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            const messageBox = document.getElementById('message-box');
            const treasurePromptOverlay = document.getElementById('treasure-prompt-overlay');

            // --- Game State Variables ---
            const gridSize = 24;
            const numGridLines = 7;
            let origin = {};
            let treasures = [];
            let foundTreasures = [];
            let currentTarget = null;
            let score = 0;
            let timerInterval = null;
            let gameStartTime = 0;
            let elapsedSeconds = 0;
            let messageTimeout = null;
            const totalTreasures = 10;
            let attemptsMade = 0;
            let lastWrongGuess = null;
            let wronglyAnsweredTreasures = [];
            let isAnimating = false;

            const ship = {
                x: 0, y: 0, targetX: 0, targetY: 0,
                movingAxis: 'none', speed: 0.1
            };

            const possibleLocations = [
                {x: 3, y: 5}, {x: -4, y: -6}, {x: 6, y: -2}, {x: -6, y: 6}, 
                {x: 5, y: 5}, {x: -3, y: -3}, {x: -5, y: 2}, {x: 4, y: -4}, 
                {x: -2, y: 6}, {x: 1, y: -5}, {x: -6, y: -1}, {x: 2, y: 2}, 
                {x: -1, y: 6}, {x: 6, y: 1}, {x: 4, y: -6}, {x: -5, y: -5},
                {x: 0, y: -6}, {x: 6, y: 0}, {x: 0, y: 4}, {x: -3, y: 0},
                {x: 0, y: 6}, {x: -6, y: 0}, {x: 0, y: -5}, {x: 4, y: 0}
            ];

            // --- Helper Functions ---
            
            function switchScreen(fromScreen, toScreen) {
                if(fromScreen && fromScreen.style.opacity === "0") return; // Prevent double transition

                if (fromScreen) {
                    fromScreen.style.opacity = 0;
                    setTimeout(() => {
                        fromScreen.classList.add('hidden');
                        toScreen.classList.remove('hidden');
                        setTimeout(() => {
                            toScreen.style.opacity = 1;
                        }, 20);
                    }, 500);
                } else {
                    toScreen.classList.remove('hidden');
                    setTimeout(() => {
                        toScreen.style.opacity = 1;
                    }, 20);
                }
            }

            function toArabicNumerals(num) {
                const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                return String(num).replace(/[0-9.-]/g, d => {
                    if (d === '-') return '-';
                    if (d === '.') return ',';
                    return arabicNumerals[parseInt(d)];
                });
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            function loadSavedScore() {
                const savedScore = localStorage.getItem('treasureHuntScore');
                if (savedScore !== null) {
                    savedScoreDisplay.textContent = `${toArabicNumerals(parseFloat(savedScore).toFixed(1))} / ${toArabicNumerals(5)}`;
                } else {
                    savedScoreDisplay.textContent = 'لم تلعب بعد';
                }
            }

            // --- Timer Functions ---
            function startTimer() {
                stopTimer();
                gameStartTime = Date.now();
                timerInterval = setInterval(updateTimerDisplay, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function updateTimerDisplay() {
                elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
                timerDisplay.textContent = toArabicNumerals(elapsedSeconds);
            }

            // --- Game Flow ---
            function initGame() {
                score = 0;
                attemptsMade = 0;
                foundTreasures = [];
                lastWrongGuess = null;
                wronglyAnsweredTreasures = [];
                isAnimating = false;
                ship.x = 0; ship.y = 0; ship.movingAxis = 'none';
                
                const zeroAxisLocations = possibleLocations.filter(loc => loc.x === 0 || loc.y === 0);
                const standardLocations = possibleLocations.filter(loc => loc.x !== 0 && loc.y !== 0);

                shuffleArray(standardLocations);
                shuffleArray(zeroAxisLocations);

                const firstSeven = standardLocations.slice(0, 7);
                const lastThree = zeroAxisLocations.slice(0, 3);
                
                treasures = [...firstSeven, ...lastThree];
                
                setupCanvas();
                setNextTarget();
                
                timerDisplay.textContent = toArabicNumerals(0);
                startTimer();
                switchScreen(startScreen, gameScreen);
            }

            function setNextTarget() {
                lastWrongGuess = null;
                if (attemptsMade < totalTreasures) {
                    currentTarget = treasures[attemptsMade];
                    showTreasurePrompt(`الكنز رقم: ${toArabicNumerals(attemptsMade + 1)}`);
                    updateUI();
                } else {
                    endGame();
                }
            }

            function endGame() {
                stopTimer();
                currentTarget = null;
                ship.movingAxis = 'none';
                isAnimating = true;

                saveAndFinishGame(score, elapsedSeconds);
                
                switchScreen(gameScreen, resultScreen);
            }

            // --- UI Update Functions ---
            function updateUI() {
                if (currentTarget) {
                    const arabicX = toArabicNumerals(currentTarget.x);
                    const arabicY = toArabicNumerals(currentTarget.y);
                    targetCoordsEl.textContent = `(${arabicX}, ${arabicY})`;
                }
            }

            function showTreasurePrompt(text) {
                treasurePromptOverlay.textContent = text;
                treasurePromptOverlay.style.opacity = 1;
                setTimeout(() => {
                    treasurePromptOverlay.style.opacity = 0;
                }, 1500);
            }

            function showMessage(text, type) {
                if (messageTimeout) clearTimeout(messageTimeout);

                messageBox.innerHTML = text;
                messageBox.className = 'p-3 rounded-lg text-center font-bold text-md shadow-xl';
                
                if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }

                messageBoxOverlay.style.opacity = 1;

                messageTimeout = setTimeout(() => {
                    messageBoxOverlay.style.opacity = 0;
                }, 2500);
            }

            // --- Canvas Drawing Functions ---
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#a8d8f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawLand();
                drawGrid();
                drawWronglyAnsweredHints();
                drawFoundTreasures();
                if (lastWrongGuess) drawWrongGuessMarker();
                if (ship.movingAxis !== 'none' || (isAnimating && !currentTarget)) {
                    drawShip();
                }
            }
            
            function drawLand() {
                ctx.fillStyle = '#f5e1a8';
                ctx.strokeStyle = '#d4b97a';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height * 0.7);
                ctx.bezierCurveTo(canvas.width * 0.2, canvas.height * 0.9, canvas.width * 0.3, canvas.height * 0.5, canvas.width * 0.5, canvas.height * 0.6);
                ctx.bezierCurveTo(canvas.width * 0.7, canvas.height * 0.7, canvas.width * 0.8, canvas.height * 0.3, canvas.width, canvas.height * 0.4);
                ctx.lineTo(canvas.width, canvas.height);
                ctx.lineTo(0, canvas.height);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            function drawGrid() {
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 1;
                ctx.font = `${gridSize * 0.4}px Cairo`;
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                for (let i = -(numGridLines - 1); i <= (numGridLines - 1); i++) {
                    if (i === 0) continue;
                    const x = origin.x + i * gridSize;
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
                    ctx.fillText(toArabicNumerals(i), x, origin.y + gridSize * 0.6);
                    
                    const y = origin.y + i * gridSize;
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
                    ctx.fillText(toArabicNumerals(-i), origin.x - gridSize * 0.7, y);
                }
                
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.lineWidth = 2;
                ctx.font = `bold ${gridSize * 0.7}px Cairo`;
                
                ctx.beginPath(); ctx.moveTo(0, origin.y); ctx.lineTo(canvas.width, origin.y); ctx.stroke();
                ctx.fillText('س', canvas.width - gridSize * 0.8, origin.y - gridSize * 0.8);

                ctx.beginPath(); ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, canvas.height); ctx.stroke();
                ctx.fillText('ص', origin.x + gridSize * 0.8, gridSize * 0.8);
            }
            
            function drawFoundTreasures() {
                ctx.globalAlpha = 1.0;
                ctx.font = `${gridSize}px sans-serif`;
                foundTreasures.forEach(t => {
                    const pixelPos = gridToPixel(t.x, t.y);
                    ctx.fillText('💎', pixelPos.x, pixelPos.y);
                });
            }

            function drawWrongGuessMarker() {
                const pixelPos = gridToPixel(lastWrongGuess.x, lastWrongGuess.y);
                ctx.font = `${gridSize}px sans-serif`;
                ctx.fillText('❌', pixelPos.x, pixelPos.y);
            }

            function drawWronglyAnsweredHints() {
                ctx.globalAlpha = 0.4;
                ctx.font = `${gridSize}px sans-serif`;
                wronglyAnsweredTreasures.forEach(t => {
                    const pixelPos = gridToPixel(t.x, t.y);
                    ctx.fillText('💎', pixelPos.x, pixelPos.y);
                });
                ctx.globalAlpha = 1.0;
            }

            function drawShip() {
                const pixelPos = gridToPixel(ship.x, ship.y);
                ctx.font = `${gridSize * 1.2}px sans-serif`;
                ctx.save();
                ctx.translate(pixelPos.x, pixelPos.y);
                if (ship.movingAxis === 'x') {
                    if (ship.targetX < ship.x) ctx.scale(-1, 1);
                } else if (ship.movingAxis === 'y') {
                    ctx.rotate(ship.targetY > ship.y ? Math.PI / 2 : -Math.PI / 2);
                }
                ctx.fillText('🏴‍☠️', 0, 0);
                ctx.restore();
            }

            function pixelToGrid(pixelX, pixelY) {
                const gridX = Math.round((pixelX - origin.x) / gridSize);
                const gridY = Math.round((origin.y - pixelY) / gridSize);
                return { x: gridX, y: gridY };
            }

            function gridToPixel(gridX, gridY) {
                const pixelX = origin.x + gridX * gridSize;
                const pixelY = origin.y - gridY * gridSize;
                return { x: pixelX, y: pixelY };
            }

            // --- Event Handlers & Game Loop ---
            function handleCanvasClick(event) {
                if (!currentTarget || isAnimating) return;
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (event.clientX - rect.left) * scaleX;
                const mouseY = (event.clientY - rect.top) * scaleY;
                const clickedGridPos = pixelToGrid(mouseX, mouseY);

                isAnimating = true;
                ship.targetX = currentTarget.x;
                ship.targetY = currentTarget.y;
                ship.movingAxis = 'x';
                
                const isCorrect = clickedGridPos.x === currentTarget.x && clickedGridPos.y === currentTarget.y;

                if (isCorrect) {
                    showMessage('إجابة صحيحة! 💎', 'success');
                    score++;
                } else {
                    showMessage(`خطأ! لقد اخترت (${toArabicNumerals(clickedGridPos.x)}, ${toArabicNumerals(clickedGridPos.y)}).`, 'error');
                    lastWrongGuess = clickedGridPos;
                }
                
                gameLoop(isCorrect);
            }

            function gameLoop(isCorrect) {
                if (ship.movingAxis === 'x') {
                    if (Math.abs(ship.targetX - ship.x) < ship.speed) {
                        ship.x = ship.targetX;
                        ship.movingAxis = 'y';
                    } else {
                        ship.x += Math.sign(ship.targetX - ship.x) * ship.speed;
                    }
                } else if (ship.movingAxis === 'y') {
                     if (Math.abs(ship.targetY - ship.y) < ship.speed) {
                        ship.y = ship.targetY;
                        ship.movingAxis = 'none';
                    } else {
                        ship.y += Math.sign(ship.targetY - ship.y) * ship.speed;
                    }
                }

                draw();

                if (ship.movingAxis !== 'none') {
                    requestAnimationFrame(() => gameLoop(isCorrect));
                } else {
                    if (isCorrect) {
                        foundTreasures.push(currentTarget);
                    } else {
                        wronglyAnsweredTreasures.push(currentTarget);
                    }
                    draw();
                    
                    setTimeout(() => {
                        attemptsMade++;
                        ship.x = 0; ship.y = 0;
                        setNextTarget();
                        if(currentTarget) isAnimating = false;
                    }, 1500);
                }
            }
            
            function setupCanvas() {
                const container = canvas.parentElement;
                if (!container) return;
                
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                const size = Math.min(containerWidth, containerHeight) * 0.95; // Use 95% of space to ensure it fits

                const effectiveSize = (numGridLines * 2) * gridSize;
                
                canvas.width = effectiveSize;
                canvas.height = effectiveSize;

                canvas.style.width = `${size}px`;
                canvas.style.height = `${size}px`;

                origin = { x: canvas.width / 2, y: canvas.height / 2 };
                draw();
            }

            // --- Initializer ---
            function initializeApp() {
                startGameButton.addEventListener('click', initGame);
                playAgainButton.addEventListener('click', () => {
                    loadSavedScore();
                    switchScreen(resultScreen, startScreen);
                });

                canvas.addEventListener('click', handleCanvasClick);
                
                const observer = new ResizeObserver(() => {
                    window.requestAnimationFrame(() => {
                        if (canvas.parentElement) {
                            setupCanvas();
                        }
                    });
                });
                if (canvas.parentElement) {
                    observer.observe(canvas.parentElement);
                }
                
                loadSavedScore();
                switchScreen(null, startScreen);
            }

            initializeApp();
        });
    </script>
    
    <script>
    // --- START OF CONNECTION & LEADERBOARD ENGINE ---
    (function() {
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const GAME_ID = 'g1_1_1';
        const GAME_MAX_POINTS = 10;
        const PLATFORM_MAX_GRADE = 5;
        const METRIC_TYPE = 'time';
        const METRIC_LABEL = 'الوقت (ثواني)';

        // --- Read URL Parameters ---
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const classId = urlParams.get('classId');
        const studentName = urlParams.get('studentName');

        let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

        // --- CORE FUNCTIONS ---
        function toArabicNumerals(num) {
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).replace(/[0-9.-]/g, d => {
                if (d === '-') return '-';
                if (d === '.') return ',';
                return arabicNumerals[parseInt(d)];
            });
        }

        window.saveAndFinishGame = function(points, metricValue) {
            const finalPoints = parseFloat(points) || 0;
            const finalMetric = parseFloat(metricValue) || 0;
            const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
            const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

            const resultDisplay = document.getElementById('final-result-display');
            if (resultDisplay) {
                resultDisplay.innerHTML = `
                    <p class="text-gray-700">الكنوز: <span class="font-bold text-xl">${toArabicNumerals(finalPoints)} / ${toArabicNumerals(maxPoints)}</span></p>
                    <p class="text-blue-600">الدرجة: <span class="font-bold text-2xl">${toArabicNumerals(finalGrade.toFixed(1))} / ${toArabicNumerals(PLATFORM_MAX_GRADE)}</span></p>
                `;
            }
             localStorage.setItem('treasureHuntScore', finalGrade.toFixed(1));

            if (studentId && classId) {
                const params = new URLSearchParams({
                    action: 'saveGrade',
                    studentId: studentId,
                    classId: classId,
                    itemId: GAME_ID,
                    grade: finalGrade.toFixed(2),
                    metricValue: Math.round(finalMetric).toString()
                });
                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(result => console.log('Save result:', result.status))
                    .catch(err => console.error("Save Error:", err))
                    .finally(fetchAndShowLeaderboard);
            } else {
                console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                fetchAndShowLeaderboard();
            }
        }

        function fetchAndShowLeaderboard() {
            const loader = document.getElementById('leaderboard-loader');
            const container = document.getElementById('leaderboard-container');
            if (!loader || !container) return;
            
            if (!classId || !studentId) {
                console.log("No classId or studentId found, skipping leaderboard.");
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">سجل الأبطال متاح للطلاب المسجلين فقط.</p>`;
                showFinishButton();
                return;
            }

            loader.style.display = 'block';
            container.innerHTML = '';

            const params = new URLSearchParams({
                action: 'getLeaderboard',
                gameId: GAME_ID,
                metricType: METRIC_TYPE,
                classId: classId,
                studentId: studentId 
            });

            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        displayLeaderboard(response.data);
                    } else {
                        throw new Error(response.message || 'Failed to load leaderboard data.');
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    container.innerHTML = `<p class="text-center text-red-500">حدث خطأ في تحميل سجل الأبطال.</p>`;
                })
                .finally(() => {
                    loader.style.display = 'none';
                    showFinishButton();
                });
        }
        
        function displayLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">لا توجد نتائج بعد. كن أول الأبطال!</p>`;
                return;
            }
            let tableHTML = `
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">🏆 سجل الأبطال 🏆</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white shadow-md rounded-lg">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="text-center py-2 px-3">الترتيب</th>
                                    <th class="text-right py-2 px-3">اسم الطالب</th>
                                    <th class="text-center py-2 px-3">الدرجة</th>
                                    <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;
            data.forEach((player, index) => {
                const rank = index + 1;
                let rankDisplay = toArabicNumerals(rank);
                if (rank === 1) rankDisplay = '🥇';
                if (rank === 2) rankDisplay = '🥈';
                if (rank === 3) rankDisplay = '🥉';
                const isCurrentUser = (currentUser && player.name === currentUser.name);
                const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white');
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                        <td class="text-right py-2 px-3">${player.name}</td>
                        <td class="text-center py-2 px-3">${toArabicNumerals(player.grade.toFixed(1))}</td>
                        <td class="text-center py-2 px-3">${toArabicNumerals(player.metricValue)}</td>
                    </tr>`;
            });
            tableHTML += `</tbody></table></div></div>`;
            container.innerHTML = tableHTML;
        }

        function showFinishButton() {
            const finishWrapper = document.getElementById('finish-game-wrapper');
            if (finishWrapper) {
                finishWrapper.style.display = 'flex';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (studentName && welcomeMessage) {
                welcomeMessage.innerHTML = `أهلاً بك يا <span class="font-bold text-yellow-500">${studentName}</span>! انطلق في رحلتك عبر البحار الغامضة، وحل ألغاز الإحداثيات للوصول إلى الكنوز المخفية. كل إجابة صحيحة تقربك من هدفك!`;
            }
            const finishBtn = document.getElementById('finish-game-btn');
            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                });
            }
        });
    })();
    // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>
</body>
</html>


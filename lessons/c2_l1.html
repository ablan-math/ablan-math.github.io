<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฏุฑุณ ูข-ูก: ุงูุนูุงูุงุช | ููุตุฉ ุงูุฑูุงุถูุงุช ุงูุชูุงุนููุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .step-box { border-right: 4px solid #1d4ed8; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        input[type="radio"]:disabled + .option-label { cursor: not-allowed; background-color: #f3f4f6; }
        input[type="radio"]:disabled:checked + .option-label { background-color: #dbeafe; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .math-eq {
            font-family: "Courier New", monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 2px 8px;
            border-radius: 6px;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Interactive Example Styles */
        .interactive-table input { width: 100%; text-align: center; border: 1px solid #d1d5db; border-radius: 4px; }
        .interactive-table input.correct { border-color: #16a34a; background-color: #f0fdf4; }
        .interactive-table input.incorrect { border-color: #dc2626; background-color: #fef2f2; }
        .graph-target-point { cursor: pointer; fill: transparent; }
        .graph-user-point { transition: opacity 0.3s; }
        .mapping-source, .mapping-target { cursor: pointer; }
        .mapping-source.selected { font-weight: bold; fill: #2563eb; }
        
        /* Glowing Text Effect */
        .glow-blue {
            color: #2563eb; /* blue-600 */
            text-shadow: 0 0 8px #60a5fa, 0 0 12px #60a5fa;
            transition: all 0.3s ease-in-out;
        }
        .glow-green {
            color: #16a34a; /* green-600 */
            text-shadow: 0 0 8px #4ade80, 0 0 12px #4ade80;
            transition: all 0.3s ease-in-out;
        }
        .analysis-text-item {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">ุงูุฏุฑุณ ูข-ูก: ุงูุนูุงูุงุช</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; ุงูุนูุฏุฉ ุฅูู ุงูููุฑุณ</a>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ก ุฃููุงู: ุงูููููู ุงูุฃุณุงุณู</h2>
                    <div class="p-4 bg-blue-50 rounded-lg space-y-3">
                        <p>ูู ุงูุฑูุงุถูุงุชุ <span class="vocab-term">ุงูุนูุงูุฉ</span> ูู ุฃู ูุฌููุนุฉ ูู ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ. ูููู ุชูุซูู ุงูุนูุงูุฉ ุจุนุฏุฉ ุทุฑู: ุฌุฏููุ ุชูุซูู ุจูุงููุ ุฃู ูุฎุทุท ุณููู.</p>
                        <p>ูู ุฒูุฌ ูุฑุชุจ ูุชููู ูู <span class="vocab-term">ุฅุญุฏุงุซู ุณููู</span> ู <span class="vocab-term">ุฅุญุฏุงุซู ุตุงุฏู</span>. ูุฌููุนุฉ ุงูุฅุญุฏุงุซูุงุช ุงูุณูููุฉ ุชุณูู <span class="vocab-term">ุงููุฌุงู</span>ุ ููุฌููุนุฉ ุงูุฅุญุฏุงุซูุงุช ุงูุตุงุฏูุฉ ุชุณูู <span class="vocab-term">ุงููุฏู</span>.</p>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ฏ ุซุงููุงู: ุชูุซูู ุงูุนูุงูุฉ</h2>
                     <div class="p-6 bg-gray-50 rounded-lg">
                        <p class="text-lg font-semibold mb-4">ูุซุงู: ูุซู ุงูุนูุงูุฉ <span class="math-eq">{ (ูขุ ูฅ)ุ (-ูขุ ูฃ)ุ (ูฅุ -ูข)ุ (-ูกุ -ูข) }</span> ุจูุงููุงูุ ูุจุฌุฏููุ ูุจูุฎุทุท ุณููู. ุซู ุญุฏุฏ ุงููุฌุงู ูุงููุฏู.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div>
                                <h4 class="font-bold mb-2">ุฌุฏูู</h4>
                                <table class="w-full border text-center rounded-lg overflow-hidden"><thead class="bg-gray-200"><tr class="border-b"><th class="p-2">ุณ</th><th class="p-2">ุต</th></tr></thead><tbody><tr class="border-b"><td>ูข</td><td>ูฅ</td></tr><tr class="border-b"><td>-ูข</td><td>ูฃ</td></tr><tr class="border-b"><td>ูฅ</td><td>-ูข</td></tr><tr><td>-ูก</td><td>-ูข</td></tr></tbody></table>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">ุชูุซูู ุจูุงูู</h4>
                                <!-- Note: SVG y-axis is inverted (0 is at the top). So (x, y) is plotted at (x, -y) -->
                                <div class="p-2 bg-white border rounded-lg"><svg viewBox="-6 -6 12 12" class="w-full h-48"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -5 5 V -5 M -4 5 V -5 M -3 5 V -5 M -2 5 V -5 M -1 5 V -5 M 1 5 V -5 M 2 5 V -5 M 3 5 V -5 M 4 5 V -5 M 5 5 V -5" /><path d="M -5 5 H 5 M -5 4 H 5 M -5 3 H 5 M -5 2 H 5 M -5 1 H 5 M -5 -1 H 5 M -5 -2 H 5 M -5 -3 H 5 M -5 -4 H 5 M -5 -5 H 5" /></g><line x1="-5.5" y1="0" x2="5.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-5.5" x2="0" y2="5.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="2" cy="-5" r="0.2" fill="#ef4444"/><circle cx="-2" cy="-3" r="0.2" fill="#ef4444"/><circle cx="5" cy="2" r="0.2" fill="#ef4444"/><circle cx="-1" cy="2" r="0.2" fill="#ef4444"/></svg></div>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">ูุฎุทุท ุณููู</h4>
                                <div class="p-2 bg-white border rounded-lg"><svg viewBox="0 0 100 100" class="w-full h-48"><defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="18" font-size="8" font-weight="bold" text-anchor="middle">ุงููุฌุงู</text><text x="80" y="35" font-size="8" text-anchor="middle">ูข</text><text x="80" y="50" font-size="8" text-anchor="middle">-ูข</text><text x="80" y="65" font-size="8" text-anchor="middle">ูฅ</text><text x="80" y="80" font-size="8" text-anchor="middle">-ูก</text><rect x="5" y="15" width="30" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="28" font-size="8" font-weight="bold" text-anchor="middle">ุงููุฏู</text><text x="20" y="45" font-size="8" text-anchor="middle">ูฅ</text><text x="20" y="60" font-size="8" text-anchor="middle">ูฃ</text><text x="20" y="75" font-size="8" text-anchor="middle">-ูข</text><path d="M 65 35 Q 50 40 35 45" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 50 Q 50 55 35 60" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 65 Q 50 70 35 75" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 80 Q 50 78 35 75" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /></svg></div>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-green-100 rounded-lg text-center">
                            <p><span class="vocab-term">ุงููุฌุงู</span> ูู ูุฌููุนุฉ ููู ุณ: <span class="math-eq">{ูขุ -ูขุ ูฅุ -ูก}</span></p>
                            <p><span class="vocab-term">ุงููุฏู</span> ูู ูุฌููุนุฉ ููู ุต: <span class="math-eq">{ูฅุ ูฃุ -ูข}</span> (ุจุฏูู ุชูุฑุงุฑ)</p>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">โ๏ธ ูุซุงู ุชูุงุนูู: ุฃููู ุงูุชูุซููุงุช</h2>
                     <div id="interactive-example-container" class="p-6 bg-gray-50 rounded-lg">
                         <p class="text-lg font-semibold mb-4">ุงููููุฉ: ุฃููู ุชูุซููุงุช ุงูุนูุงูุฉ <span class="math-eq">{ (ูขุ ู)ุ (-ูขุ ูฃ)ุ (ูฅุ -ูข)ุ (-ูกุ -ูข) }</span></p>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                             <div>
                                 <h4 class="font-bold mb-2">ูก. ุฃููู ุงูุฌุฏูู</h4>
                                 <table class="w-full border text-center rounded-lg overflow-hidden interactive-table"><thead class="bg-gray-200"><tr class="border-b"><th class="p-2">ุณ</th><th class="p-2">ุต</th></tr></thead><tbody><tr class="border-b"><td>ูข</td><td>ู</td></tr><tr class="border-b"><td>-ูข</td><td>ูฃ</td></tr><tr class="border-b"><td><input type="number" id="interactive-s1" data-correct="5"></td><td><input type="number" id="interactive-p1" data-correct="-2"></td></tr><tr><td><input type="number" id="interactive-s2" data-correct="-1"></td><td><input type="number" id="interactive-p2" data-correct="-2"></td></tr></tbody></table>
                             </div>
                             <div>
                                 <h4 class="font-bold mb-2">ูข. ุฃุถู ุงูููุงุท</h4>
                                 <!-- Note: SVG y-axis is inverted. Points to add are (5, -2) and (-1, -2). They are plotted at cy="2" -->
                                 <div class="p-2 bg-white border rounded-lg"><svg id="interactive-graph" viewBox="-6 -6 12 12" class="w-full h-48"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -5 5 V -5 M -4 5 V -5 M -3 5 V -5 M -2 5 V -5 M -1 5 V -5 M 1 5 V -5 M 2 5 V -5 M 3 5 V -5 M 4 5 V -5 M 5 5 V -5" /><path d="M -5 5 H 5 M -5 4 H 5 M -5 3 H 5 M -5 2 H 5 M -5 1 H 5 M -5 -1 H 5 M -5 -2 H 5 M -5 -3 H 5 M -5 -4 H 5 M -5 -5 H 5" /></g><line x1="-5.5" y1="0" x2="5.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-5.5" x2="0" y2="5.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="2" cy="0" r="0.2" fill="#16a34a"/><circle cx="-2" cy="-3" r="0.2" fill="#16a34a"/><circle id="user-point-1" cx="5" cy="2" r="0.2" fill="#ef4444" class="graph-user-point" opacity="0"/><circle id="user-point-2" cx="-1" cy="2" r="0.2" fill="#ef4444" class="graph-user-point" opacity="0"/><circle data-point-id="user-point-1" cx="5" cy="2" r="0.5" class="graph-target-point"/><circle data-point-id="user-point-2" cx="-1" cy="2" r="0.5" class="graph-target-point"/></svg></div>
                             </div>
                             <div>
                                 <h4 class="font-bold mb-2">ูฃ. ุงุฑุณู ุงูุฃุณูู</h4>
                                 <div class="p-2 bg-white border rounded-lg"><svg id="interactive-mapping" viewBox="0 0 100 100" class="w-full h-48"><defs><marker id="arrow-interactive" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="18" font-size="8" font-weight="bold" text-anchor="middle">ุงููุฌุงู</text><text class="mapping-source" data-value="2" x="80" y="35" font-size="8" text-anchor="middle">ูข</text><text class="mapping-source" data-value="-2" x="80" y="50" font-size="8" text-anchor="middle">-ูข</text><text class="mapping-source" data-value="5" x="80" y="65" font-size="8" text-anchor="middle">ูฅ</text><text class="mapping-source" data-value="-1" x="80" y="80" font-size="8" text-anchor="middle">-ูก</text><rect x="5" y="15" width="30" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="28" font-size="8" font-weight="bold" text-anchor="middle">ุงููุฏู</text><text class="mapping-target" data-value="0" x="20" y="45" font-size="8" text-anchor="middle">ู</text><text class="mapping-target" data-value="3" x="20" y="60" font-size="8" text-anchor="middle">ูฃ</text><text class="mapping-target" data-value="-2" x="20" y="75" font-size="8" text-anchor="middle">-ูข</text><path d="M 65 35 Q 50 40 35 45" stroke="#16a34a" stroke-width="0.5" fill="none" marker-end="url(#arrow-interactive)" /><path d="M 65 50 Q 50 55 35 60" stroke="#16a34a" stroke-width="0.5" fill="none" marker-end="url(#arrow-interactive)" /><g id="user-arrows-container"></g></svg></div>
                             </div>
                         </div>
                         <div id="interactive-feedback" class="mt-4 text-center font-bold"></div>
                         <div class="mt-4 flex justify-center gap-4">
                             <button id="check-interactive-btn" class="bg-green-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-green-700">ุชุญูู ูู ุนููู</button>
                             <button id="show-solution-btn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">ุฃุธูุฑ ุงูุญู</button>
                         </div>
                     </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ฏ ุซุงูุซุงู: ุงููุชุบูุฑ ุงููุณุชูู ูุงููุชุบูุฑ ุงูุชุงุจุน</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <p class="text-lg font-semibold mb-4">ูู ุงูุนูุงูุฉุ ุงููุชุบูุฑ ุงูุฐู ูุญุฏุฏ ูููุฉ ุงููุฎุฑุฌุฉ ูุณูู <span class="vocab-term">ุงููุชุบูุฑ ุงููุณุชูู</span> (ุนุงุฏุฉ ุณ)ุ ุจูููุง ุงููุชุบูุฑ ุงูุฐู ุชุนุชูุฏ ูููุชู ุนูู ุงููุฏุฎูุฉ ูุณูู <span class="vocab-term">ุงููุชุบูุฑ ุงูุชุงุจุน</span> (ุนุงุฏุฉ ุต).</p>
                        
                        <div id="variables-examples-container" class="mt-4 border-t pt-4">
                            <div id="example-display" class="p-4 bg-white rounded-lg min-h-[150px] flex flex-col justify-center text-center">
                                <!-- Example content will be injected here by JS -->
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-example-btn" class="bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">&larr; ุงูุณุงุจู</button>
                                <span id="example-counter" class="text-sm font-bold text-gray-600"></span>
                                <div>
                                    <button id="next-example-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700">ุงูุชุงูู &rarr;</button>
                                    <button id="reset-vars-btn" class="hidden bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700">ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฃูุซูุฉ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ ุฑุงุจุนุงู: ุชุญููู ุงูุชูุซููุงุช ุงูุจูุงููุฉ</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div id="analysis-container">
                            <div class="flex flex-col md:flex-row items-center gap-6">
                                <div id="analysis-text-container" class="flex-1 min-h-[150px]">
                                    <!-- Analysis text will be injected here -->
                                </div>
                                <div class="w-full md:w-1/3">
                                    <svg id="analysis-graph" viewBox="0 0 100 100" class="w-full bg-white border rounded-lg p-2">
                                        <line x1="10" y1="5" x2="10" y2="90" stroke="black" stroke-width="1"/>
                                        <line x1="10" y1="90" x2="95" y2="90" stroke="black" stroke-width="1"/>
                                        <text id="analysis-graph-xlabel" x="50" y="98" text-anchor="middle" font-size="8"></text>
                                        <text id="analysis-graph-ylabel" x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)"></text>
                                        <g id="analysis-graph-base"></g>
                                        <g id="analysis-graph-segments"></g>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-analysis-btn" class="bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">&larr; ุงูุณุงุจู</button>
                                <span id="analysis-counter" class="text-sm font-bold text-gray-600"></span>
                                <div>
                                    <button id="next-analysis-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700">ุงูุชุงูู &rarr;</button>
                                    <button id="reset-analysis-btn" class="hidden bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700">ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฃูุซูุฉ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">โ๏ธ ุฎุงูุณุงู: ุญุงู ุฏูุฑู! ุงุฎุชุจุฑ ูููู</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">ูุชูุฌุชู ุงูููุงุฆูุฉ</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">๐ก ุดุฑุญ ุงูุฅุฌุงุจุฉ</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // --- COMMON VARIABLES & SETUP ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    const LESSON_ID = 'c1_l1';
    let currentQuestions = []; // For the quiz

    // --- COMMON FUNCTIONS ---
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">ููุตุฉ ุงูุฑูุงุถูุงุช ุงูุชูุงุนููุฉ</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">ููุตุฉ ุงูุฑูุงุถูุงุช ุงูุชูุงุนููุฉ</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">ุฃููุงูุ ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">ุฎุฑูุฌ</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">ุฒุงุฆุฑ</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">ยฉ 2024 ุฌููุน ุงูุญููู ูุญููุธุฉ | ุชุตููู ูุชุทููุฑ: ุฃ. ุนุจุฏุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู</p></div>`; }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { explanationText.innerHTML = currentQuestions[questionIndex].explanation; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }

    // --- SECTION: INTERACTIVE REPRESENTATIONS ---
    const interactiveSolution = {
        table: { 'interactive-s1': '5', 'interactive-p1': '-2', 'interactive-s2': '-1', 'interactive-p2': '-2' },
        points: ['user-point-1', 'user-point-2'],
        mapping: { '5': '-2', '-1': '-2' }
    };
    let selectedSource = null;
    const userArrows = {};

    function handleGraphClick(event) {
        const pointId = event.target.dataset.pointId;
        if (pointId) document.getElementById(pointId).style.opacity = '1';
    }

    function handleMappingClick(event) {
        const interactiveMappingSources = document.querySelectorAll('.mapping-source');
        const userArrowsContainer = document.getElementById('user-arrows-container');
        const element = event.target;
        if (element.classList.contains('mapping-source')) {
            interactiveMappingSources.forEach(src => src.classList.remove('selected'));
            element.classList.add('selected');
            selectedSource = element;
        } else if (element.classList.contains('mapping-target') && selectedSource) {
            const sourceValue = selectedSource.dataset.value;
            const targetValue = element.dataset.value;
            if (!userArrows[sourceValue]) {
                const sourceY = selectedSource.getAttribute('y');
                const targetY = element.getAttribute('y');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 65 ${sourceY} Q 50 ${(+sourceY + +targetY)/2} 35 ${targetY}`);
                path.setAttribute('stroke', '#ef4444');
                path.setAttribute('stroke-width', '0.5');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrow-interactive)');
                userArrowsContainer.appendChild(path);
                userArrows[sourceValue] = { target: targetValue, element: path };
            }
            selectedSource.classList.remove('selected');
            selectedSource = null;
        }
    }

    function checkInteractiveAnswers() {
        const interactiveFeedbackEl = document.getElementById('interactive-feedback');
        let correctCount = 0;
        const totalCount = Object.keys(interactiveSolution.table).length + interactiveSolution.points.length + Object.keys(interactiveSolution.mapping).length;
        Object.keys(interactiveSolution.table).forEach(id => {
            const input = document.getElementById(id);
            input.classList.remove('correct', 'incorrect');
            if (input.value === interactiveSolution.table[id]) {
                input.classList.add('correct');
                correctCount++;
            } else {
                input.classList.add('incorrect');
            }
        });
        interactiveSolution.points.forEach(pointId => {
            if (document.getElementById(pointId).style.opacity === '1') correctCount++;
        });
        Object.keys(interactiveSolution.mapping).forEach(sourceValue => {
            if (userArrows[sourceValue] && userArrows[sourceValue].target === interactiveSolution.mapping[sourceValue]) {
                userArrows[sourceValue].element.setAttribute('stroke', '#16a34a');
                correctCount++;
            } else if (userArrows[sourceValue]) {
                userArrows[sourceValue].element.setAttribute('stroke', '#dc2626');
            }
        });
        interactiveFeedbackEl.textContent = `ุฃุญุณูุช! ููุฏ ุฃุฌุจุช ุจุดูู ุตุญูุญ ุนูู ${correctCount} ูู ุฃุตู ${totalCount} ุฌุฒุกูุง.`;
    }

    function showInteractiveSolution() {
        const interactiveMappingSources = document.querySelectorAll('.mapping-source');
        const interactiveMappingTargets = document.querySelectorAll('.mapping-target');
        const userArrowsContainer = document.getElementById('user-arrows-container');
        const interactiveFeedbackEl = document.getElementById('interactive-feedback');

        Object.keys(interactiveSolution.table).forEach(id => {
            const input = document.getElementById(id);
            input.value = interactiveSolution.table[id];
            input.classList.remove('incorrect');
            input.classList.add('correct');
        });
        interactiveSolution.points.forEach(pointId => {
            document.getElementById(pointId).style.opacity = '1';
        });
        userArrowsContainer.innerHTML = '';
        const sourceElements = Array.from(interactiveMappingSources).reduce((acc, el) => ({...acc, [el.dataset.value]: el }), {});
        const targetElements = Array.from(interactiveMappingTargets).reduce((acc, el) => ({...acc, [el.dataset.value]: el }), {});
        Object.keys(interactiveSolution.mapping).forEach(sourceValue => {
            const targetValue = interactiveSolution.mapping[sourceValue];
            const sourceEl = sourceElements[sourceValue];
            const targetEl = targetElements[targetValue];
            if(sourceEl && targetEl) {
                const sourceY = sourceEl.getAttribute('y');
                const targetY = targetEl.getAttribute('y');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 65 ${sourceY} Q 50 ${(+sourceY + +targetY)/2} 35 ${targetY}`);
                path.setAttribute('stroke', '#16a34a');
                path.setAttribute('stroke-width', '0.5');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrow-interactive)');
                userArrowsContainer.appendChild(path);
            }
        });
        interactiveFeedbackEl.textContent = 'ูุฐู ูู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุงููุงููุฉ.';
    }

    // --- SECTION 2: INTERACTIVE VARIABLES ---
    const variablesExamples = [
        { scenario: 'ูู ุงูุนูุงูุฉ ุงูุชู ุชุฑุจุท ุฒูุงุฏุฉ ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุจุฒูุงุฏุฉ ุถุบุท ุงูููุงุก ุฏุงุฎู ุฅุทุงุฑ ุงูุณูุงุฑุฉ...', independent: { text: 'ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ', color: 'blue' }, dependent: { text: 'ุถุบุท ุงูููุงุก', color: 'green' }, explanation: 'ูุฃู ุถุบุท ุงูููุงุก ูุนุชูุฏ ุนูู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ.' },
        { scenario: 'ูุนูู ุฃุญูุฏ ูู ูุญู ุชุฌุงุฑู ููุชูุงุถู ุฃุฌุฑูุง ุนูู ูู ุณุงุนุฉ ุนูู...', independent: { text: 'ุนุฏุฏ ุณุงุนุงุช ุงูุนูู', color: 'blue' }, dependent: { text: 'ุงูุฃุฌุฑ ุงูุฅุฌูุงูู', color: 'green' }, explanation: 'ูุฃู ุงูุฃุฌุฑ ุงูุฅุฌูุงูู ูุนุชูุฏ ุนูู ุนุฏุฏ ุงูุณุงุนุงุช ุงูุชู ุนูููุง.' },
        { scenario: 'ุนูุฏูุง ุชููุฏ ุณูุงุฑุชู ููุฏุฉ ุณุงุนุฉุ ูุฅู ุงููุณุงูุฉ ุงูุชู ุชูุทุนูุง ุชุนุชูุฏ ุนูู ุณุฑุนุชู...', independent: { text: 'ุณุฑุนุฉ ุงูุณูุงุฑุฉ', color: 'blue' }, dependent: { text: 'ุงููุณุงูุฉ ุงูููุทูุนุฉ', color: 'green' }, explanation: 'ูุฃู ุงููุณุงูุฉ ุงูููุทูุนุฉ ุชุนุชูุฏ ุนูู ุงูุณุฑุนุฉ.' }
    ];
    let currentVarExampleIndex = 0;
    let currentVarStepIndex = 0;
    
    function renderVariableStep() {
        const varDisplay = document.getElementById('example-display');
        const varCounter = document.getElementById('example-counter');
        const varNextBtn = document.getElementById('next-example-btn');
        const varPrevBtn = document.getElementById('prev-example-btn');
        const varResetBtn = document.getElementById('reset-vars-btn');
        const example = variablesExamples[currentVarExampleIndex];
        let scenarioHTML = `<p class="text-xl mb-2">${example.scenario}</p>`;
        let independentHTML = (currentVarStepIndex >= 1) ? `<div class="mt-4 transition-opacity duration-500 opacity-100"><p>ุงููุชุบูุฑ ุงููุณุชูู ูู: <strong class="glow-${example.independent.color} font-bold">${example.independent.text}</strong></p></div>` : `<div class="mt-4 transition-opacity duration-500 opacity-0 min-h-[28px]"></div>`;
        let dependentHTML = (currentVarStepIndex >= 2) ? `<div class="mt-2 transition-opacity duration-500 opacity-100"><p>ุงููุชุบูุฑ ุงูุชุงุจุน ูู: <strong class="glow-${example.dependent.color} font-bold">${example.dependent.text}</strong></p><p class="text-sm text-gray-500 mt-1">(${example.explanation})</p></div>` : `<div class="mt-2 transition-opacity duration-500 opacity-0 min-h-[44px]"></div>`;
        varDisplay.innerHTML = scenarioHTML + independentHTML + dependentHTML;
        varCounter.textContent = `ูุซุงู ${currentVarExampleIndex + 1} ูู ${variablesExamples.length} (ุงูุฎุทูุฉ ${currentVarStepIndex + 1} ูู 3)`;
        varPrevBtn.disabled = (currentVarExampleIndex === 0 && currentVarStepIndex === 0);
        const isLastVarStep = (currentVarExampleIndex === variablesExamples.length - 1 && currentVarStepIndex === 2);
        varNextBtn.classList.toggle('hidden', isLastVarStep);
        varResetBtn.classList.toggle('hidden', !isLastVarStep);
    }

    function handleVarNext() {
        if (currentVarStepIndex < 2) {
            currentVarStepIndex++;
        } else if (currentVarExampleIndex < variablesExamples.length - 1) {
            currentVarExampleIndex++;
            currentVarStepIndex = 0;
        }
        renderVariableStep();
    }

    function handleVarPrev() {
        if (currentVarStepIndex > 0) {
            currentVarStepIndex--;
        } else if (currentVarExampleIndex > 0) {
            currentVarExampleIndex--;
            currentVarStepIndex = 2;
        }
        renderVariableStep();
    }

    function handleVarReset() {
        currentVarExampleIndex = 0;
        currentVarStepIndex = 0;
        renderVariableStep();
    }

    // --- SECTION 3: INTERACTIVE ANALYSIS ---
    const analysisExamples = [
        { title: "ูุซุงู ูก: ุฑููุจ ุงูุฏุฑุงุฌุฉ", xlabel: "ุงูุฒูู", ylabel: "ุงููุณุงูุฉ", steps: [ { path: "M 10 90 L 40 50", color: "#16a34a", text: "ุชุฒุฏุงุฏ ุงููุณุงูุฉ ุจุงุฒุฏูุงุฏ ุงูุฒููุ ููุง ูุนูู ุฃู ุณุนุฏูุง ูุงู ูุจุชุนุฏ." }, { path: "M 40 50 L 70 50", color: "#3b82f6", text: "ุฃุตุจุญ ุงูุฎุท ุฃููููุงุ ููุง ูุนูู ุฃู ุงูุฒูู ููุฑ ูููู ุงููุณุงูุฉ ุซุงุจุชุฉุ ุฃู ุฃู ุณุนุฏูุง ูุฏ ุชููู." }, { path: "M 70 50 L 100 20", color: "#16a34a", text: "ุซู ุชุงุจุน ุฑููุจ ุงูุฏุฑุงุฌุฉุ ูุงุฒุฏุงุฏุช ุงููุณุงูุฉ ูุฑุฉ ุฃุฎุฑู ูุน ุงุฒุฏูุงุฏ ุงูุฒูู." } ] },
        { title: "ูุซุงู ูข: ูุณุชูู ุงููุงุก ูู ุฎุฒุงู", xlabel: "ุงูุฒูู", ylabel: "ูุณุชูู ุงููุงุก", steps: [ { path: "M 10 30 L 40 50", color: "#f97316", text: "ูุชูุงูุต ูุณุชูู ุงููุงุก ุจูุนุฏู ุจุทูุกุ ููุง ูุนูู ุฃู ููุงู ุชุณุฑูุจูุง ุจุณูุทูุง." }, { path: "M 40 50 L 60 90", color: "#dc2626", text: "ุซู ุฒุงุฏ ูุนุฏู ุงูุชูุงูุต ุจุดูู ุญุงุฏุ ููุง ูุนูู ุฃู ุงูุตูุจูุฑ ููุชุญ ูุชูุฑูุบ ุงูุฎุฒุงู ุจุณุฑุนุฉ." }, { path: "M 60 90 L 100 60", color: "#16a34a", text: "ุฃุฎูุฑูุงุ ุจุฏุฃ ูุณุชูู ุงููุงุก ูู ุงูุชุฒุงูุฏุ ููุง ูุนูู ุฃูู ุจุฏุฃ ููุก ุงูุฎุฒุงู ูู ุฌุฏูุฏ." } ] }
    ];
    let currentAnalysisExample = 0;
    let currentAnalysisStep = 0;

    function renderAnalysisStep() {
        const analysisTextContainer = document.getElementById('analysis-text-container');
        const analysisGraphBase = document.getElementById('analysis-graph-base');
        const analysisGraphSegments = document.getElementById('analysis-graph-segments');
        const analysisCounter = document.getElementById('analysis-counter');
        const analysisNextBtn = document.getElementById('next-analysis-btn');
        const analysisPrevBtn = document.getElementById('prev-analysis-btn');
        const analysisResetBtn = document.getElementById('reset-analysis-btn');
        const analysisXLabel = document.getElementById('analysis-graph-xlabel');
        const analysisYLabel = document.getElementById('analysis-graph-ylabel');

        const example = analysisExamples[currentAnalysisExample];
        analysisXLabel.textContent = example.xlabel;
        analysisYLabel.textContent = example.ylabel;
        analysisGraphBase.innerHTML = '';
        example.steps.forEach(step => {
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', step.path.replace('M ', '').replace(/ L /g, ' '));
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', '#d1d5db');
            polyline.setAttribute('stroke-width', '3');
            analysisGraphBase.appendChild(polyline);
        });
        analysisGraphSegments.innerHTML = '';
        for (let i = 0; i <= currentAnalysisStep; i++) {
            const step = example.steps[i];
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', step.path.replace('M ', '').replace(/ L /g, ' '));
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', step.color);
            polyline.setAttribute('stroke-width', '3');
            analysisGraphSegments.appendChild(polyline);
        }
        analysisTextContainer.innerHTML = `<h4 class="font-bold mb-2">${example.title}</h4>`;
        for (let i = 0; i <= currentAnalysisStep; i++) {
            const step = example.steps[i];
            const p = document.createElement('p');
            p.className = 'analysis-text-item mb-2';
            p.style.color = step.color;
            p.style.fontWeight = '600';
            p.textContent = step.text;
            analysisTextContainer.appendChild(p);
        }
        analysisCounter.textContent = `ูุซุงู ${currentAnalysisExample + 1} ูู ${analysisExamples.length} (ุงูุฎุทูุฉ ${currentAnalysisStep + 1} ูู ${example.steps.length})`;
        analysisPrevBtn.disabled = currentAnalysisExample === 0 && currentAnalysisStep === 0;
        const isLastStep = currentAnalysisExample === analysisExamples.length - 1 && currentAnalysisStep === example.steps.length - 1;
        analysisNextBtn.classList.toggle('hidden', isLastStep);
        analysisResetBtn.classList.toggle('hidden', !isLastStep);
    }

    function handleAnalysisNext() {
        const example = analysisExamples[currentAnalysisExample];
        if (currentAnalysisStep < example.steps.length - 1) {
            currentAnalysisStep++;
        } else if (currentAnalysisExample < analysisExamples.length - 1) {
            currentAnalysisExample++;
            currentAnalysisStep = 0;
        }
        renderAnalysisStep();
    }

    function handleAnalysisPrev() {
        if (currentAnalysisStep > 0) {
            currentAnalysisStep--;
        } else if (currentAnalysisExample > 0) {
            currentAnalysisExample--;
            currentAnalysisStep = analysisExamples[currentAnalysisExample].steps.length - 1;
        }
        renderAnalysisStep();
    }

    function handleAnalysisReset() {
        currentAnalysisExample = 0;
        currentAnalysisStep = 0;
        renderAnalysisStep();
    }

    // --- SECTION 4: QUIZ ---
    function saveGrade(lessonId, grade, studentId) {
        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'ุฌุงุฑู ุญูุธ ูุชูุฌุชู...';
        console.log(`Attempting to save grade for student ${studentId} on lesson ${lessonId}. Grade: ${grade}`);
        // In a real application, this would be an API call to SCRIPT_URL.
        // For this demonstration, we'll simulate a successful save.
        setTimeout(() => {
            statusEl.textContent = `ุชู ุญูุธ ูุชูุฌุชู ุจูุฌุงุญ: ${grade} / 10`;
            statusEl.style.color = '#16a34a'; // Green color for success
        }, 1000);
    }
    
    function generateQuiz() { 
        const questionBank = [
            { type: 'mcq', level: 'โญ', topic: 'domain-range', text: 'ูุง ูู ูุฌุงู ุงูุนูุงูุฉ <span class="math-eq">{ (ูกุ ูข)ุ (ูฃุ ูค)ุ (ูกุ ูฅ) }</span>ุ', options: [ { display: '<span class="math-eq">{ูกุ ูฃ}</span>', value: '{1, 3}' }, { display: '<span class="math-eq">{ูขุ ูคุ ูฅ}</span>', value: '{2, 4, 5}' }, { display: '<span class="math-eq">{ูกุ ูขุ ูฃุ ูคุ ูฅ}</span>', value: '{1, 2, 3, 4, 5}' }, { display: '<span class="math-eq">{ูกุ ูฃุ ูก}</span>', value: '{1, 3, 1}' } ], correct: '{1, 3}', explanation: `<p class='mb-2'>ุงููุฌุงู ูู ูุฌููุนุฉ ูู ุงูุฅุญุฏุงุซูุงุช ุงูุณูููุฉ (ุงูุฃููู) ูู ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉุ ูุจุฏูู ุชูุฑุงุฑ.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ: (<b>ูก</b>ุ ูข)ุ (<b>ูฃ</b>ุ ูค)ุ (<b>ูก</b>ุ ูฅ)<br>ุงููุฌุงู = {ูกุ ูฃ}</p>` },
            { type: 'mcq', level: 'โญ', topic: 'domain-range', text: 'ูุง ูู ูุฏู ุงูุนูุงูุฉ <span class="math-eq">{ (ูุ ู)ุ (-ูกุ ูข)ุ (ูกุ ูข) }</span>ุ', options: [ { display: '<span class="math-eq">{ูุ -ูกุ ูก}</span>', value: '{0, -1, 1}' }, { display: '<span class="math-eq">{ูุ ูขุ ูข}</span>', value: '{0, 2, 2}' }, { display: '<span class="math-eq">{ูุ ูข}</span>', value: '{0, 2}' }, { display: '<span class="math-eq">{ู}</span>', value: '{0}' } ], correct: '{0, 2}', explanation: `<p class='mb-2'>ุงููุฏู ูู ูุฌููุนุฉ ูู ุงูุฅุญุฏุงุซูุงุช ุงูุตุงุฏูุฉ (ุงูุซุงููุฉ) ูู ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉุ ูุจุฏูู ุชูุฑุงุฑ.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ: (ูุ <b>ู</b>)ุ (-ูกุ <b>ูข</b>)ุ (ูกุ <b>ูข</b>)<br>ุงููุฏู = {ูุ ูข}</p>` },
            { type: 'mcq', level: 'โญโญ', topic: 'variables', text: 'ูู ุงูุนูุงูุฉ ุงูุชู ุชุฑุจุท ุนุฏุฏ ุณุงุนุงุช ุงูุฏุฑุงุณุฉ (ุณ) ุจุงูุฏุฑุฌุฉ ูู ุงูุงุฎุชุจุงุฑ (ุต)ุ ุฃู ูุชุบูุฑ ูู ุงูุชุงุจุนุ', options: [ { display: 'ุนุฏุฏ ุณุงุนุงุช ุงูุฏุฑุงุณุฉ', value: 's' }, { display: 'ุงูุฏุฑุฌุฉ ูู ุงูุงุฎุชุจุงุฑ', value: 'p' }, { display: 'ููุงููุง ูุณุชูู', value: 'both_ind' }, { display: 'ูุง ูููู ุงูุชุญุฏูุฏ', value: 'cannot' } ], correct: 'p', explanation: `<p class='mb-2'>ุงูุฏุฑุฌุฉ ุงูุชู ุชุญุตู ุนูููุง ูู ุงูุงุฎุชุจุงุฑ <strong class="text-green-600">ุชุนุชูุฏ</strong> ุนูู ุนุฏุฏ ุณุงุนุงุช ุฏุฑุงุณุชู. ูุฐููุ ุงูุฏุฑุฌุฉ (ุต) ูู ุงููุชุบูุฑ ุงูุชุงุจุน.</p>` },
            { type: 'graph_mcq', level: 'โญโญโญ', topic: 'analysis', text: 'ูุตู ุงูุชูุซูู ุงูุจูุงูู ุงููุฌุงูุฑ ุฑุญูุฉ ุดุฎุต ูุง. ุฃู ูู ุงูุชุงูู ูู ุงููุตู ุงูุตุญูุญ ููุฑุญูุฉุ', graph: `<svg viewBox="0 0 100 100" class="w-48 h-48 bg-white border rounded-lg p-2"><polyline points="10,80 40,40 60,40 100,80" fill="none" stroke="#ef4444" stroke-width="3" /><text x="50" y="98" text-anchor="middle" font-size="8">ุงูุฒูู</text><text x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)">ุงููุณุงูุฉ ูู ุงูููุฒู</text><line x1="10" y1="0" x2="10" y2="90" stroke="black" stroke-width="1"/><line x1="10" y1="90" x2="100" y2="90" stroke="black" stroke-width="1"/></svg>`, options: [ { display: 'ุณุงุฑ ุงูุดุฎุต ูุจุชุนุฏุงู ุนู ุงูููุฒูุ ุซู ุชูููุ ุซู ุฃููู ุงูุณูุฑ ูุจุชุนุฏุงู.', value: 'away-stop-away' }, { display: 'ุณุงุฑ ุงูุดุฎุต ูุจุชุนุฏุงู ุนู ุงูููุฒูุ ุซู ุชููู ููุชุฑุฉุ ุซู ุนุงุฏ ุจุงุชุฌุงู ุงูููุฒู.', value: 'away-stop-back' },{ display: 'ูุงู ุงูุดุฎุต ุนุงุฆุฏุงู ููููุฒูุ ุซู ุชูููุ ุซู ุฃููู ุงูุนูุฏุฉ.', value: 'back-stop-back' },{ display: 'ุณุงุฑ ุงูุดุฎุต ูุจุชุนุฏุงู ุซู ุนุงุฏ ุฅูู ุงูููุฒู ูุจุงุดุฑุฉ.', value: 'away-back' } ], correct: 'away-stop-back', explanation: `<p class='mb-2'>ููุญูู ุงูุฑุณู ุงูุจูุงูู (ุงููุณุงูุฉ ูู ุงูููุฒู ููุงุจู ุงูุฒูู):</p><ul class='list-disc pr-4 space-y-1'><li><b>ุงูุฌุฒุก ุงูุฃูู (ูุงุฆู ููุฃุนูู):</b> ุงููุณุงูุฉ ูู ุงูููุฒู ุชุฒุฏุงุฏ ูุน ูุฑูุฑ ุงูุฒููุ ููุง ูุนูู ุฃู ุงูุดุฎุต ูุณูุฑ ูุจุชุนุฏูุง.</li><li><b>ุงูุฌุฒุก ุงูุซุงูู (ุฃููู):</b> ููุฑ ุงูุฒูู ูููู ุงููุณุงูุฉ ุนู ุงูููุฒู ูุง ุชุชุบูุฑุ ููุง ูุนูู ุฃู ุงูุดุฎุต ูุฏ ุชููู.</li><li><b>ุงูุฌุฒุก ุงูุซุงูุซ (ูุงุฆู ููุฃุณูู):</b> ุงููุณุงูุฉ ูู ุงูููุฒู ุชูู ูุน ูุฑูุฑ ุงูุฒููุ ููุง ูุนูู ุฃู ุงูุดุฎุต ูุนูุฏ ุจุงุชุฌุงู ุงูููุฒู.</li></ul><p class='mt-2 p-2 bg-green-100 rounded-md'>ุฅุฐูุงุ ุงููุตู ุงูุตุญูุญ ูู: ุณุงุฑ ูุจุชุนุฏูุงุ ุชูููุ ุซู ุนุงุฏ.</p>` },
            { type: 'graph_mcq', level: 'โญโญ', topic: 'domain-range', text: 'ูู ุงูุชูุซูู ุงูุจูุงูู ุงููุฌุงูุฑุ ูุง ูู <strong>ูุฌุงู</strong> ุงูุนูุงูุฉุ', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-3" cy="-2" r="0.2" fill="#ef4444"/><circle cx="-1" cy="4" r="0.2" fill="#ef4444"/><circle cx="0" cy="-1" r="0.2" fill="#ef4444"/><circle cx="3" cy="-2" r="0.2" fill="#ef4444"/></svg>`, options: [ { display: '<span class="math-eq">{-ูฃ, -ูก, ู, ูฃ}</span>', value: '{-3, -1, 0, 3}' }, { display: '<span class="math-eq">{-ูข, -ูก, ูค}</span>', value: '{-2, -1, 4}' }, { display: '<span class="math-eq">{-ูค, -ูฃ, -ูก, ู, ูก, ูข, ูฃ}</span>', value: '{-4, -3, -1, 0, 1, 2, 3}' }, { display: '<span class="math-eq">{ูข, -ูค, ูก, ูข}</span>', value: '{2, -4, 1, 2}' } ], correct: '{-3, -1, 0, 3}', explanation: `<p class='mb-2'>ุงููุฌุงู ูู ูุฌููุนุฉ ููู <b>ุณ</b> ูุฌููุน ุงูููุงุท. ุจุงููุธุฑ ุฅูู ุงูุฑุณูุ ุงูููุงุท ูู (-ูฃ, -ูข)ุ (-ูก, ูค)ุ (ู, -ูก)ุ (ูฃ, -ูข). ุงูุฅุญุฏุงุซูุงุช ุงูุณูููุฉ ูู -ูฃุ -ูกุ ูุ ูฃ.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงููุฌุงู = {-ูฃ, -ูก, ู, ูฃ}</p>` },
            { type: 'graph_mcq', level: 'โญโญ', topic: 'domain-range', text: 'ูู ุงูุชูุซูู ุงูุจูุงูู ุงููุฌุงูุฑุ ูุง ูู <strong>ูุฏู</strong> ุงูุนูุงูุฉุ', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-4" cy="-2" r="0.2" fill="#3b82f6"/><circle cx="-2" cy="3" r="0.2" fill="#3b82f6"/><circle cx="1" cy="-2" r="0.2" fill="#3b82f6"/><circle cx="4" cy="1" r="0.2" fill="#3b82f6"/></svg>`, options: [ { display: '<span class="math-eq">{-ูฃ, -ูก, ูข}</span>', value: '{-3, -1, 2}' }, { display: '<span class="math-eq">{-ูค, -ูข, ูก, ูค}</span>', value: '{-4, -2, 1, 4}' }, { display: '<span class="math-eq">{ูข, -ูฃ, ูข, -ูก}</span>', value: '{2, -3, 2, -1}' }, { display: '<span class="math-eq">{-ูข, ูก, ูฃ}</span>', value: '{-2, 1, 3}' } ], correct: '{-3, -1, 2}', explanation: `<p class='mb-2'>ุงููุฏู ูู ูุฌููุนุฉ ููู <b>ุต</b> ูุฌููุน ุงูููุงุทุ ุจุฏูู ุชูุฑุงุฑ. ุจุงููุธุฑ ุฅูู ุงูุฑุณูุ ุงูููุงุท ูู (-ูค, ูข)ุ (-ูข, -ูฃ)ุ (ูก, ูข)ุ (ูค, -ูก). ุงูุฅุญุฏุงุซูุงุช ุงูุตุงุฏูุฉ ูู ูขุ -ูฃุ ูขุ -ูก.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงููุฏู (ูุฑุชุจุงู ูุจุฏูู ุชูุฑุงุฑ) = {-ูฃ, -ูก, ูข}</p>` },
            { type: 'mcq', level: 'โญ', topic: 'domain-range', text: 'ูุง ูู ูุฏู ุงูุนูุงูุฉ <span class="math-eq">{ (ูฅุ -ูก)ุ (ูุ -ูก)ุ (ูขุ ูค) }</span>ุ', options: [ { display: '<span class="math-eq">{ูฅ, ู, ูข}</span>', value: '{5, 0, 2}' }, { display: '<span class="math-eq">{-ูก, ูค}</span>', value: '{-1, 4}' }, { display: '<span class="math-eq">{-ูก, -ูก, ูค}</span>', value: '{-1, -1, 4}' }, { display: '<span class="math-eq">{ูฅ, -ูก, ู, ูข, ูค}</span>', value: '{5, -1, 0, 2, 4}' } ], correct: '{-1, 4}', explanation: `<p class='mb-2'>ุงููุฏู ูู ูุฌููุนุฉ ูู ุงูุฅุญุฏุงุซูุงุช ุงูุตุงุฏูุฉ (ุงูุซุงููุฉ) ูู ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉุ ูุจุฏูู ุชูุฑุงุฑ.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ: (ูฅุ <b>-ูก</b>)ุ (ูุ <b>-ูก</b>)ุ (ูขุ <b>ูค</b>)<br>ุงููุฏู = {-ูก, ูค}</p>` },
            { type: 'mcq', level: 'โญโญ', topic: 'variables', text: 'ุชูููุฉ ุชุนุจุฆุฉ ุงููููุฏ ุชุนุชูุฏ ุนูู ุนุฏุฏ ุงููุชุฑุงุช ุงูุชู ุชุดุชุฑููุง. ุฃู ูุชุบูุฑ ูู ุงููุณุชููุ', options: [ { display: 'ุชูููุฉ ุงููููุฏ', value: 'cost' }, { display: 'ุนุฏุฏ ุงููุชุฑุงุช', value: 'liters' }, { display: 'ููุงููุง ุชุงุจุน', value: 'both_dep' }, { display: 'ููุน ุงูุณูุงุฑุฉ', value: 'car_type' } ], correct: 'liters', explanation: `<p class='mb-2'>ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ <strong class="text-green-600">ุชุนุชูุฏ</strong> ุนูู ุนุฏุฏ ุงููุชุฑุงุช. ุฃูุช ุชุฎุชุงุฑ ุนุฏุฏ ุงููุชุฑุงุช ุฃููุงู (ุงููุชุบูุฑ ุงููุณุชูู)ุ ูุจูุงุกู ุนููู ุชูุญุณุจ ุงูุชูููุฉ (ุงููุชุบูุฑ ุงูุชุงุจุน).</p>` },
            { type: 'mcq', level: 'โญโญ', topic: 'variables', text: 'ุนูุฏ ุดุฑุงุก ุงูุชูุงุญ ูู ุงููุชุฌุฑุ ุชุนุชูุฏ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ ุนูู ุนุฏุฏ ููููุบุฑุงูุงุช ุงูุชูุงุญ ุงูุชู ุชุดุชุฑููุง. ุฃู ูุชุบูุฑ ูู ุงููุชุบูุฑ ุงููุณุชููุ', options: [ { display: 'ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ', value: 'cost' }, { display: 'ุนุฏุฏ ุงูููููุบุฑุงูุงุช', value: 'kg' }, { display: 'ููุน ุงูุชูุงุญ', value: 'type' }, { display: 'ุงุณู ุงููุชุฌุฑ', value: 'store' } ], correct: 'kg', explanation: `<p class='mb-2'>ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ <strong class="text-green-600">ุชุนุชูุฏ</strong> ุนูู ุงููููุฉ ุงูุชู ุชุดุชุฑููุง. ุฃูุช ุชุฎุชุงุฑ ุนุฏุฏ ุงูููููุบุฑุงูุงุช (ุงููุณุชูู) ุฃููุงูุ ูุจูุงุกู ุนููู ุชูุญุณุจ ุงูุชูููุฉ (ุงูุชุงุจุน).</p>` },
            { type: 'mcq', level: 'โญ', topic: 'domain-range', text: 'ูุง ูู ูุฌุงู ุงูุนูุงูุฉ <span class="math-eq">{ (-ูข, ู), (ูฃ, ูก), (ูค, ู) }</span>ุ', options: [ { display: '<span class="math-eq">{ู, ูก}</span>', value: '{0,1}' }, { display: '<span class="math-eq">{-ูข, ูฃ, ูค}</span>', value: '{-2,3,4}' }, { display: '<span class="math-eq">{ู, ูก, ู}</span>', value: '{0,1,0}' }, { display: '<span class="math-eq">{-ูข, ู, ูก, ูฃ, ูค}</span>', value: '{-2,0,1,3,4}' } ], correct: '{-2,3,4}', explanation: `<p class='mb-2'>ุงููุฌุงู ูู ูุฌููุนุฉ ูู ุงูุฅุญุฏุงุซูุงุช ุงูุณูููุฉ (ุงูุฃููู) ูู ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงูุฃุฒูุงุฌ ุงููุฑุชุจุฉ: (<b>-ูข</b>, ู), (<b>ูฃ</b>, ูก), (<b>ูค</b>, ู)<br>ุงููุฌุงู = {-ูข, ูฃ, ูค}</p>` },
            { type: 'graph_mcq', level: 'โญโญ', topic: 'domain-range', text: 'ูู ุงูุชูุซูู ุงูุจูุงูู ุงููุฌุงูุฑุ ูุง ูู <strong>ูุฏู</strong> ุงูุนูุงูุฉุ', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-3" cy="3" r="0.2" fill="#c026d3"/><circle cx="1" cy="1" r="0.2" fill="#c026d3"/><circle cx="4" cy="-2" r="0.2" fill="#c026d3"/></svg>`, options: [ { display: '<span class="math-eq">{-ูฃ, -ูก, ูข}</span>', value: '{-3, -1, 2}' }, { display: '<span class="math-eq">{-ูข, ูก, ูฃ}</span>', value: '{-2, 1, 3}' }, { display: '<span class="math-eq">{-ูฃ, ูก, ูค}</span>', value: '{-3, 1, 4}' }, { display: '<span class="math-eq">{-ูฃ, ูก}</span>', value: '{-3, 1}' } ], correct: '{-3, -1, 2}', explanation: `<p class='mb-2'>ุงููุฏู ูู ูุฌููุนุฉ ููู <b>ุต</b> ูุฌููุน ุงูููุงุทุ ุจุฏูู ุชูุฑุงุฑ. ุจุงููุธุฑ ุฅูู ุงูุฑุณูุ ุงูููุงุท ูู (-ูฃ, -ูฃ)ุ (ูก, -ูก)ุ (ูค, ูข). ุงูุฅุญุฏุงุซูุงุช ุงูุตุงุฏูุฉ ูู -ูฃุ -ูกุ ูข.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>ุงููุฏู (ูุฑุชุจุงู) = {-ูฃ, -ูก, ูข}</p>` },
            { type: 'graph_mcq', level: 'โญโญโญ', topic: 'analysis', text: 'ููุซู ุงูุฑุณู ุงูุจูุงูู ุงููุฌุงูุฑ ูุณุชูู ุงููุงุก ูู ุฎุฒุงู ุฃุซูุงุก ููุฆู. ุฃู ูุตู ูู ุงูุตุญูุญุ', graph: `<svg viewBox="0 0 100 100" class="w-48 h-48 bg-white border rounded-lg p-2"><polyline points="10,90 40,60 60,60 90,10" fill="none" stroke="#0891b2" stroke-width="3" /><text x="50" y="98" text-anchor="middle" font-size="8">ุงูุฒูู</text><text x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)">ูุณุชูู ุงููุงุก</text><line x1="10" y1="0" x2="10" y2="90" stroke="black" stroke-width="1"/><line x1="10" y1="90" x2="100" y2="90" stroke="black" stroke-width="1"/></svg>`, options: [ { display: 'ุจุฏุฃ ุงูููุก ุซู ุชููู ุซู ุงุณุชูุฑ ุจููุณ ุงููุนุฏู.', value: 'fill-stop-fill' }, { display: 'ุจุฏุฃ ุงูููุก ุจุณุฑุนุฉุ ุซู ุฃุจุทุฃุ ุซู ุชููู.', value: 'fast-slow-stop' }, { display: 'ุจุฏุฃ ุงูููุก ุจูุนุฏู ุซุงุจุชุ ุซู ุชููู ููุชุฑุฉุ ุซู ุงุณุชูุฑ ุจูุนุฏู ุฃุณุฑุน.', value: 'fill-stop-faster' }, { display: 'ูุงู ุงูุฎุฒุงู ููุฑุบ ุซู ุงูุชูุฃ.', value: 'empty-fill' } ], correct: 'fill-stop-faster', explanation: `<p class='mb-2'>ููุญูู ุงูุฑุณู ุงูุจูุงูู:</p><ul class='list-disc pr-4 space-y-1'><li><b>ุงูุฌุฒุก ุงูุฃูู (ูุงุฆู ููุฃุนูู):</b> ูุณุชูู ุงููุงุก ูุฑุชูุน ุจูุนุฏู ุซุงุจุช.</li><li><b>ุงูุฌุฒุก ุงูุซุงูู (ุฃููู):</b> ููุฑ ุงูุฒูู ููุณุชูู ุงููุงุก ูุง ูุชุบูุฑุ ููุง ูุนูู ุฃู ุงูููุก ุชููู.</li><li><b>ุงูุฌุฒุก ุงูุซุงูุซ (ุฃูุซุฑ ุงูุญุฏุงุฑูุง):</b> ูุณุชูู ุงููุงุก ูุฑุชูุน ูุฑุฉ ุฃุฎุฑู ูููู ุจุดูู ุฃุณุฑุน ูู ุงููุฑุฉ ุงูุฃููู.</li></ul><p class='mt-2 p-2 bg-green-100 rounded-md'>ุฅุฐูุงุ ุงููุตู ุงูุตุญูุญ ูู: ุจุฏุฃ ุงูููุกุ ุซู ุชูููุ ุซู ุงุณุชูุฑ ุจูุนุฏู ุฃุณุฑุน.</p>` }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random()); 
        const questionCount = Math.min(shuffled.length, 5); 
        return shuffled.slice(0, questionCount); 
    }
    
    function initializeQuiz(lessonId, questions, studentData) {
        currentQuestions = questions;
        const quizForm = document.getElementById('quizForm');
        if (!quizForm) return;
        if (questions.length === 0) {
            quizForm.innerHTML = `<p class="text-center text-gray-600">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุชุงุญุฉ ููุฐุง ุงูุฏุฑุณ ุญุงููุงู.</p>`;
            return;
        }
        let attemptsLeft;
        if (studentData) {
            const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 };
            attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts;
        } else {
            attemptsLeft = 1;
        }
        const attemptsCounter = document.getElementById('attempts-counter');
        if (attemptsCounter) {
            attemptsCounter.innerHTML = `ุงููุญุงููุงุช ุงููุชุจููุฉ: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`;
        }
        const quizHtml = questions.map((q, index) => {
            const optionsHTML = q.options.map((opt, optIndex) => {
                // **MODIFICATION**: Removed the graph from the option content for graph_mcq type.
                let content = opt.display;
                return `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${content}</label></div>`;
            }).join('');
            
            const questionText = q.type === 'graph_mcq' ? `<div class="flex flex-col md:flex-row items-center gap-4"><div class="flex-1"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p></div><div class="flex-shrink-0">${q.graph}</div></div>` : `<p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p>`;

            return `<div class="p-4 border-2 border-gray-200 rounded-lg">${questionText}<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">ุงุนุฑู ููุงุฐุงุ</button></div>`;
        }).join('');

        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">ุชุญูู ูู ุฅุฌุงุจุงุชู</button>`;
        
        questions.forEach((q, index) => {
            const explainBtn = document.getElementById(`explain-btn-${index}`);
            if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index));
        });
        if (attemptsLeft <= 0) {
            const submitBtn = quizForm.querySelector('#submit-quiz-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ูุง ุชูุฌุฏ ูุญุงููุงุช ูุชุจููุฉ';
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400');
        }
        quizForm.onsubmit = (e) => {
            e.preventDefault();
            let score = 0;
            questions.forEach((q, index) => {
                const userAnswer = e.target.elements[`q${index}`]?.value;
                const feedbackEl = document.getElementById(`feedback-q${index}`);
                if (userAnswer === q.correct) {
                    score++;
                    feedbackEl.textContent = 'โ ุฅุฌุงุจุฉ ุตุญูุญุฉ!';
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600';
                } else {
                    feedbackEl.textContent = `โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ.`;
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600';
                }
                document.getElementById(`explain-btn-${index}`).classList.remove('hidden');
            });
            const finalGrade = Math.round((score / questions.length) * 10);
            const resultsDiv = document.getElementById('quiz-results');
            resultsDiv.classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`;
            if (studentData) {
                saveGrade(lessonId, finalGrade, studentData.id);
                if (attemptsLeft - 1 > 0) {
                    document.getElementById('retake-quiz-btn').classList.remove('hidden');
                }
            } else {
                document.getElementById('save-status').textContent = 'ุชู ุนุฑุถ ูุชูุฌุชู. ุณุฌู ุงูุฏุฎูู ูุญูุธ ุชูุฏูู.';
            }
            e.target.querySelector('#submit-quiz-btn').disabled = true;
        };
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();

        // Attach listeners for interactive representations
        const interactiveCheckBtn = document.getElementById('check-interactive-btn');
        const interactiveSolutionBtn = document.getElementById('show-solution-btn');
        const interactiveGraph = document.getElementById('interactive-graph');
        const interactiveMapping = document.getElementById('interactive-mapping');

        if (interactiveCheckBtn) interactiveCheckBtn.addEventListener('click', checkInteractiveAnswers);
        if (interactiveSolutionBtn) interactiveSolutionBtn.addEventListener('click', showInteractiveSolution);
        if (interactiveGraph) interactiveGraph.addEventListener('click', handleGraphClick);
        if (interactiveMapping) interactiveMapping.addEventListener('click', handleMappingClick);

        // Attach listeners for interactive variables
        const varNextBtn = document.getElementById('next-example-btn');
        const varPrevBtn = document.getElementById('prev-example-btn');
        const varResetBtn = document.getElementById('reset-vars-btn');
        if(varNextBtn) varNextBtn.addEventListener('click', handleVarNext);
        if(varPrevBtn) varPrevBtn.addEventListener('click', handleVarPrev);
        if(varResetBtn) varResetBtn.addEventListener('click', handleVarReset);

        // Attach listeners for interactive analysis
        const analysisNextBtn = document.getElementById('next-analysis-btn');
        const analysisPrevBtn = document.getElementById('prev-analysis-btn');
        const analysisResetBtn = document.getElementById('reset-analysis-btn');
        if(analysisNextBtn) analysisNextBtn.addEventListener('click', handleAnalysisNext);
        if(analysisPrevBtn) analysisPrevBtn.addEventListener('click', handleAnalysisPrev);
        if(analysisResetBtn) analysisResetBtn.addEventListener('click', handleAnalysisReset);

        // Attach listeners for quiz
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
        
        // --- INITIALIZE DYNAMIC SECTIONS ---
        renderVariableStep();
        renderAnalysisStep();
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø¨Ø±ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</title>
    <!-- ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent; 
        }
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const GAME_ID = "g6_4_1";
        const TOTAL_MAX_POINTS = 20; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù…ÙƒÙ†Ø© (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: 7ØŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: 7ØŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: 6)

        const toAr = (n) => {
            if (n === null || n === undefined || n === "") return '';
            const arabicDigits = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
            return String(n).replace(/\d/g, d => arabicDigits[d]);
        };

        const Icon = ({ name, className = "w-3 h-3" }) => {
            const icons = {
                star: "fa-solid fa-star",
                sync: "fa-solid fa-sync fa-spin",
                times: "fa-solid fa-xmark",
                check: "fa-solid fa-check",
                crown: "fa-solid fa-crown",
                play: "fa-solid fa-play",
                clock: "fa-solid fa-clock",
                user: "fa-solid fa-user-graduate"
            };
            return <i className={`${icons[name] || ''} ${className}`}></i>;
        };

        const GoldenTrophy = ({ className = "w-12 h-12" }) => (
            <svg viewBox="0 0 100 100" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M30 20C30 10 40 10 50 10C60 10 70 10 70 20V40C70 60 60 70 50 70C40 70 30 60 30 40V20Z" fill="#FFD700"/>
                <path d="M30 30H20C15 30 15 45 20 45H30" stroke="#FFD700" strokeWidth="6" strokeLinecap="round"/>
                <path d="M70 30H80C85 30 85 45 80 45H70" stroke="#FFD700" strokeWidth="6" strokeLinecap="round"/>
                <path d="M50 70V85" stroke="#FFD700" strokeWidth="8" strokeLinecap="round"/>
                <path d="M35 85H65" stroke="#FFD700" strokeWidth="8" strokeLinecap="round"/>
                <circle cx="50" cy="35" r="8" fill="white" fillOpacity="0.3" />
            </svg>
        );

        const TermCard = ({ coeff, variable, exponent, isHeader = false }) => {
            if (coeff === 0 && variable && !isHeader) return null;
            const absCoeff = Math.abs(coeff);
            const showCoeff = (absCoeff !== 1 || !variable);
            return (
                <div className={`bg-white rounded-lg shadow-sm border border-slate-100 flex items-center justify-center relative ${isHeader ? 'px-3 py-2' : 'p-2'}`}>
                    <div className="flex items-center gap-0.5 relative" dir="rtl">
                        {coeff < 0 && <span className={`${isHeader ? 'text-2xl' : 'text-lg'} font-bold text-red-600 ml-0.5`}>âˆ’</span>}
                        {showCoeff && <span className={`${isHeader ? 'text-2xl' : 'text-lg'} font-black text-slate-800`}>{toAr(absCoeff)}</span>}
                        {variable && (
                            <div className="relative flex items-center">
                                <span className={`${isHeader ? 'text-2xl' : 'text-lg'} font-serif italic ${variable === 'Ø³' ? 'text-blue-700' : 'text-purple-700'}`}>{variable}</span>
                                {exponent > 1 && (
                                    <span className={`absolute ${isHeader ? '-top-2' : '-top-2'} -left-4 text-[12px] font-black bg-amber-400 text-amber-950 px-1 py-0 rounded shadow-sm z-10 border border-amber-500/20`}>
                                        {toAr(exponent)}
                                    </span>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [studentInfo, setStudentInfo] = useState({ id: null, classId: null, name: "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±", prevGrade: "Ù /Ù¥" });
            const [gameState, setGameState] = useState('start');
            const [level, setLevel] = useState(1);
            const [score, setScore] = useState(0);
            const [wrongCount, setWrongCount] = useState(0);
            const [questionsCount, setQuestionsCount] = useState(0);
            const [currentTarget, setCurrentTarget] = useState(null);
            const [options, setOptions] = useState([]);
            const [selectedIds, setSelectedIds] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [timer, setTimer] = useState(0);
            const [leaderboard, setLeaderboard] = useState({ visible: false, mode: 'global', data: [], loading: false });
            const timerRef = useRef(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const sId = params.get('studentId') || params.get('userId');
                const cId = params.get('classId');
                const sName = decodeURIComponent(params.get('name') || params.get('studentName') || "");
                if (sId && cId) {
                    setStudentInfo(prev => ({ ...prev, id: sId, classId: cId, name: sName || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ" }));
                    fetchCloudData(sId, cId);
                }
            }, []);

            const fetchCloudData = async (id, cid) => {
                setIsSyncing(true);
                try {
                    const url = `${SCRIPT_URL}?action=getStudentData&studentId=${id}&classId=${encodeURIComponent(cid)}&itemId=${GAME_ID}&t=${Date.now()}`;
                    const res = await fetch(url).then(r => r.json());
                    if (res.status === 'success' && res.data) {
                        setStudentInfo(prev => ({ ...prev, prevGrade: res.data.games?.[GAME_ID] ? `${toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1))}/Ù¥` : "Ù /Ù¥" }));
                    }
                } catch (e) {} finally { setIsSyncing(false); }
            };

            const generateProblem = useCallback((currLvl, qIdx) => {
                setFeedback(null);
                setSelectedIds([]);
                const levelPlan = [1, 1, 1, 2, 2];

                if (currLvl <= 2) {
                    const vars = currLvl === 1 ? ['Ø³'] : ['Ø³', 'Øµ'];
                    const tVar = vars[Math.floor(Math.random() * vars.length)];
                    const tExp = Math.floor(Math.random() * 3) + 1;
                    const tCoeff = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 5) + 2);
                    setCurrentTarget({ type: 'match', coeff: tCoeff, variable: tVar, exponent: tExp });

                    let opts = [];
                    const numCor = levelPlan[qIdx] || 1;
                    const used = new Set();
                    used.add(`${tCoeff}${tVar}${tExp}`);

                    let s1 = 0;
                    while (opts.length < numCor && s1 < 50) {
                        s1++;
                        let c = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 9) + 2);
                        if (!used.has(`${c}${tVar}${tExp}`)) {
                            used.add(`${c}${tVar}${tExp}`);
                            opts.push({ id: `c-${opts.length}-${Date.now()}`, coeff: c, variable: tVar, exponent: tExp, isCorrect: true });
                        }
                    }

                    let s2 = 0;
                    while (opts.length < 4 && s2 < 100) {
                        s2++;
                        let c = (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 9) + 2);
                        let v = vars[Math.floor(Math.random() * vars.length)];
                        let e = Math.floor(Math.random() * 3) + 1;
                        if (v === tVar && e === tExp) {
                            if (Math.random() > 0.5) v = (v === 'Ø³' ? 'Øµ' : 'Ø³');
                            else e = (e % 3) + 1;
                        }
                        if (!used.has(`${c}${v}${e}`)) {
                            used.add(`${c}${v}${e}`);
                            opts.push({ id: `w-${opts.length}-${Date.now()}`, coeff: c, variable: v, exponent: e, isCorrect: false });
                        }
                    }
                    setOptions(opts.sort(() => Math.random() - 0.5));
                } else {
                    const scs = [
                        { t: [{coeff: 5, v: 'Ø³', e: 1}, {op: '-', coeff: -2, v: 'Ø³', e: 1}], c: { id: 'cor', isCorrect: true, coeff: 3, variable: 'Ø³', exponent: 1 } },
                        { t: [{coeff: 3, v: 'Ø³', e: 2}, {op: '+', coeff: 2, v: 'Øµ', e: 1}], c: { id: 'cor', isCorrect: true, isSpecial: true, text: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¨Ø³ÙŠØ·' } },
                        { t: [{coeff: 2, v: 'Ø³', e: 3}, {op: '+', coeff: 4, v: 'Ø³', e: 3}, {op: '+', coeff: 3, v: 'Ø³', e: 3}], c: { id: 'cor', isCorrect: true, coeff: 9, variable: 'Ø³', exponent: 3 } },
                        { t: [{coeff: 4, v: 'Ø³', e: 2}, {op: '+', coeff: 2, v: 'Ø³', e: 2}, {op: '+', coeff: 2, v: 'Øµ', e: 1}], c: { id: 'cor', isCorrect: true, terms: [{coeff: 6, variable: 'Ø³', exponent: 2}, {coeff: 2, variable: 'Øµ', exponent: 1}] } },
                        { t: [{coeff: 5, v: 'Ø³', e: 3}, {op: '-', coeff: -3, v: 'Ø³', e: 2}, {op: '+', coeff: 3, v: 'Øµ', e: 1}], c: { id: 'cor', isCorrect: true, isSpecial: true, text: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¨Ø³ÙŠØ·' } },
                        { t: [{coeff: 6, v: 'Ø³', e: 2}, {op: '-', coeff: -6, v: 'Ø³', e: 2}], c: { id: 'cor', isCorrect: true, coeff: 0 } },
                    ];
                    const sc = scs[qIdx] || scs[0];
                    setCurrentTarget({ type: 'operation', terms: sc.t.map(x => ({...x, variable: x.v, exponent: x.e})) });
                    let o = [sc.c];
                    const usedLabels = new Set();
                    usedLabels.add(sc.c.isSpecial ? sc.c.text : "ans");
                    let s3 = 0;
                    while (o.length < 4 && s3 < 100) {
                        s3++;
                        let fake = { id: `f-${o.length}-${Date.now()}`, isCorrect: false };
                        if (o.length === 1 && !sc.c.isSpecial) { fake.isSpecial = true; fake.text = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¨Ø³ÙŠØ·'; }
                        else { fake.coeff = Math.floor(Math.random()*15)+1; fake.variable = 'Ø³'; fake.exponent = Math.floor(Math.random()*3)+1; }
                        let lbl = fake.isSpecial ? fake.text : `${fake.coeff}${fake.variable}`;
                        if (!usedLabels.has(lbl)) { usedLabels.add(lbl); o.push(fake); }
                    }
                    setOptions(o.sort(() => Math.random() - 0.5));
                }
            }, []);

            const startGame = () => {
                setGameState('playing'); setLevel(1); setScore(0); setWrongCount(0); setQuestionsCount(0); setTimer(0);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => setTimer(t => t + 1), 1000);
                generateProblem(1, 0);
            };

            const checkAnswers = () => {
                const correctIds = options.filter(o => o.isCorrect).map(o => o.id);
                const selCorrect = selectedIds.filter(id => correctIds.includes(id));
                const selWrong = selectedIds.filter(id => !correctIds.includes(id));
                let pts = 0;
                if (level <= 2) {
                    pts = Math.max(0, selCorrect.length - selWrong.length);
                } else { pts = (selCorrect.length === 1 && selWrong.length === 0) ? 1 : 0; }
                if (pts <= 0 && selectedIds.length > 0) setWrongCount(w => w + 1);
                setScore(s => s + pts);
                setFeedback(selCorrect.length === correctIds.length && selWrong.length === 0 ? 'correct' : 'reveal');
            };

            const handleNext = () => {
                const maxQ = level === 3 ? 6 : 5;
                if (questionsCount + 1 >= maxQ) {
                    if (level < 3) { setLevel(level + 1); setQuestionsCount(0); generateProblem(level + 1, 0); }
                    else { finishGame(); }
                } else { setQuestionsCount(questionsCount + 1); generateProblem(level, questionsCount + 1); }
            };

            const finishGame = () => {
                clearInterval(timerRef.current);
                setGameState('result');
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ù† 5 Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ù‚Ù
                const calculatedGrade = (score / TOTAL_MAX_POINTS) * 5;
                const grade = Math.min(5, calculatedGrade).toFixed(1);
                if (studentInfo.id) saveScoreCloud(grade, wrongCount);
            };

            const saveScoreCloud = async (g, m) => {
                const p = new URLSearchParams({ action: 'saveScore', studentId: studentInfo.id, classId: studentInfo.classId, itemId: GAME_ID, score: g, metricValue: m, type: 'game' });
                try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } catch (e) {}
            };

            const fetchLeaderboard = async (mode) => {
                setLeaderboard({ visible: true, mode, data: [], loading: true });
                const rid = mode === 'class' ? studentInfo.classId : 'all';
                try {
                    const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(rid)}&t=${Date.now()}`;
                    const res = await fetch(url).then(r => r.json());
                    setLeaderboard(prev => ({ ...prev, data: res.data || [], loading: false }));
                } catch (e) { setLeaderboard(prev => ({ ...prev, loading: false })); }
            };

            return (
                <div className="flex items-center justify-center min-h-screen p-4">
                    <div className="w-full max-w-[440px] bg-white rounded-3xl shadow-xl flex flex-col h-[480px] relative overflow-hidden border border-slate-100">
                        
                        <div className="bg-slate-50 border-b border-slate-200 px-3 py-1.5 flex justify-between items-center text-[10px] font-black text-slate-500">
                            <div className="flex items-center gap-1 truncate max-w-[60%]">
                                <Icon name="user" className="text-blue-500" />
                                <span className="truncate">{studentInfo.name}</span>
                            </div>
                            <div className="flex items-center gap-1 bg-white px-1.5 py-0.5 rounded-full border shadow-xs">
                                <Icon name="star" className="text-yellow-500" />
                                <span>{studentInfo.prevGrade}</span>
                            </div>
                        </div>

                        <main className="flex-1 p-4 flex flex-col overflow-hidden">
                            {gameState === 'start' && (
                                <div className="h-full flex flex-col items-center justify-center text-center space-y-6">
                                    <div className="bg-blue-600 p-6 rounded-3xl shadow-lg animate-bounce-subtle">
                                        <Icon name="crown" className="text-5xl text-white" />
                                    </div>
                                    <h1 className="text-2xl font-black text-slate-800 leading-tight">Ø§Ù„ØªÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø¨Ø±ÙŠØ©</h1>
                                    <p className="text-sm font-bold text-blue-700 bg-blue-50 p-3 rounded-xl">Ù†Ø§ÙØ³ Ø²Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¨Ø±ÙŠØ©!</p>
                                    <div className="flex flex-col gap-3 w-full max-w-[200px]">
                                        <button onClick={startGame} className="bg-blue-600 text-white shadow-md text-base font-black py-3 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-all">
                                            Ø¨Ø¯Ø¡ <Icon name="play" />
                                        </button>
                                        <button onClick={() => fetchLeaderboard('global')} className="bg-white text-slate-600 border border-slate-200 font-black py-2.5 rounded-xl text-xs flex items-center justify-center gap-1 active:scale-95 transition-all">
                                            <Icon name="crown" className="text-amber-500" /> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
                                        </button>
                                    </div>
                                </div>
                            )}

                            {gameState === 'playing' && currentTarget && (
                                <div className="flex flex-col h-full overflow-hidden">
                                    <div className="flex justify-between items-center text-[11px] font-black text-slate-400 mb-3">
                                        <span className="bg-blue-600 text-white px-3 py-1 rounded-full">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ {toAr(level)}</span>
                                        <div className="flex items-center gap-1"><Icon name="clock" /><span>{toAr(timer)} Ø«</span></div>
                                        <span>Ø§Ù„Ø³Ø¤Ø§Ù„ {toAr(questionsCount + 1)}/Ù¥</span>
                                    </div>
                                    <div className="w-full bg-[#1e293b] rounded-2xl p-6 shadow-md flex flex-col items-center relative shrink-0 mb-4 min-h-[120px] justify-center text-center">
                                        <div className="absolute -top-3 bg-amber-400 text-amber-950 text-[10px] font-black px-4 py-1 rounded-full border-2 border-white shadow-sm">{level === 3 ? 'Ø£ÙˆØ¬Ø¯ Ø§Ù„Ù†Ø§ØªØ¬' : 'Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡ Ù„Ù€'}</div>
                                        <div className="flex flex-wrap items-center justify-center gap-3 mt-2">
                                            {currentTarget.type === 'operation' ? currentTarget.terms.map((t, i) => (
                                                <React.Fragment key={i}>
                                                    {i > 0 && <span className="text-2xl font-black text-white">{t.op || '+'}</span>}
                                                    <TermCard coeff={Math.abs(t.coeff)} variable={t.variable} exponent={t.exponent} isHeader={true} />
                                                </React.Fragment>
                                            )) : <TermCard {...currentTarget} isHeader={true} />}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 overflow-y-auto flex-1 pb-2 custom-scrollbar">
                                        {options.map((opt) => (
                                            <button key={opt.id} disabled={feedback} onClick={() => setSelectedIds(prev => level === 3 ? [opt.id] : (prev.includes(opt.id) ? prev.filter(i=>i!==opt.id) : [...prev, opt.id]))}
                                                className={`min-h-[70px] rounded-xl border-2 flex items-center justify-center transition-all p-2 relative ${selectedIds.includes(opt.id) ? 'border-blue-500 bg-blue-50 scale-95' : 'border-slate-100 bg-white shadow-sm'} ${feedback && opt.isCorrect ? 'border-emerald-500 bg-emerald-50' : ''} ${feedback === 'reveal' && selectedIds.includes(opt.id) && !opt.isCorrect ? 'border-red-500 bg-red-50' : ''}`}
                                            >
                                                {opt.isSpecial ? (
                                                    <span className="text-xs font-black text-slate-700">{opt.text}</span>
                                                ) : opt.terms ? (
                                                    <div className="flex flex-wrap items-center justify-center gap-1">
                                                        {opt.terms.map((t, idx) => (
                                                            <React.Fragment key={idx}>
                                                                {idx > 0 && <span className="text-lg font-bold text-slate-400">{t.coeff >= 0 ? '+' : ''}</span>}
                                                                <div className="flex items-center relative">
                                                                    <span className="text-2xl font-black">{toAr(Math.abs(t.coeff))}</span>
                                                                    <span className="text-2xl italic font-serif text-blue-700">{t.variable}</span>
                                                                    {t.exponent > 1 && <span className="absolute -top-2.5 -left-3 text-[11px] font-black bg-amber-400 px-1 rounded shadow-xs">{toAr(t.exponent)}</span>}
                                                                </div>
                                                            </React.Fragment>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center relative">
                                                        {opt.coeff === 0 ? <span className="text-2xl font-black">{toAr(0)}</span> : (
                                                            <React.Fragment>
                                                                <span className="text-2xl font-black">{toAr(Math.abs(opt.coeff))}</span>
                                                                {opt.variable && <span className={`text-2xl italic font-serif ${opt.variable === 'Ø³' ? 'text-blue-700' : 'text-purple-700'}`}>{opt.variable}</span>}
                                                                {opt.exponent > 1 && <span className="absolute -top-3 -left-4 text-[12px] font-black bg-amber-400 text-amber-950 px-1 rounded shadow-xs border border-amber-500/10">{toAr(opt.exponent)}</span>}
                                                            </React.Fragment>
                                                        )}
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="mt-3 space-y-3">
                                        {feedback ? <button onClick={handleNext} className="w-full py-3.5 bg-blue-600 text-white rounded-xl font-black text-sm shadow-md active:scale-95 transition-all">Ø§Ù„ØªØ§Ù„ÙŠ</button> : <button onClick={checkAnswers} disabled={selectedIds.length === 0} className={`w-full py-3.5 rounded-xl font-black text-sm transition-all ${selectedIds.length === 0 ? 'bg-slate-100 text-slate-300' : 'bg-emerald-500 text-white shadow-md active:scale-95'}`}>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>}
                                        <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div className="bg-blue-600 h-full transition-all duration-700" style={{ width: `${((questionsCount + (feedback ? 1 : 0)) / (level === 3 ? 6 : 5)) * 100}%` }}></div></div>
                                    </div>
                                </div>
                            )}

                            {gameState === 'result' && (
                                <div className="h-full flex flex-col items-center justify-between text-center py-4 animate-in fade-in duration-500">
                                    <div className="flex flex-col items-center gap-2"><GoldenTrophy className="w-16 h-16" /><h2 className="text-lg font-black text-slate-800">Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ ÙŠØ§ Ø¨Ø·Ù„!</h2></div>
                                    <div className="grid grid-cols-3 gap-3 w-full items-center">
                                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ 20 */}
                                        <div className="bg-blue-50 p-3 rounded-xl flex flex-col items-center"><span className="text-[9px] font-black text-blue-400 uppercase">Ø§Ù„Ù†Ù‚Ø§Ø·</span><p className="text-sm font-black text-blue-900">{toAr(score)}/{toAr(TOTAL_MAX_POINTS)}</p></div>
                                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 5 */}
                                        <div className="bg-amber-50 p-4 rounded-[2rem] border-2 border-amber-200 shadow-md ring-4 ring-amber-50 flex flex-col items-center scale-110"><span className="text-[10px] font-black text-amber-600 uppercase">Ø§Ù„Ø¯Ø±Ø¬Ø©</span><p className="text-2xl font-black text-amber-900">{toAr(Math.min(5, (score / TOTAL_MAX_POINTS) * 5).toFixed(1))}</p></div>
                                        <div className="bg-purple-50 p-3 rounded-xl flex flex-col items-center"><span className="text-[9px] font-black text-purple-400 uppercase">Ø§Ù„ÙˆÙ‚Øª</span><p className="text-sm font-black text-purple-900">{toAr(timer)} Ø«</p></div>
                                    </div>
                                    <div className="bg-emerald-500 p-3 rounded-xl w-full flex items-center justify-center gap-2 shadow-sm"><Icon name="check" className="text-xs text-white" /><p className="font-black text-white text-xs">ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</p></div>
                                    <button onClick={() => fetchLeaderboard('global')} className="w-full bg-slate-800 text-white py-3 rounded-xl font-black text-xs flex items-center justify-center gap-2 active:scale-95 transition-all">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ <Icon name="crown" className="text-amber-400" /></button>
                                    <div className="flex w-full gap-3 pt-2"><button onClick={() => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*')} className="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-black text-xs active:scale-95 transition-all">Ø¥ØºÙ„Ø§Ù‚</button><button onClick={() => window.location.reload()} className="flex-1 bg-blue-100 text-blue-700 py-3 rounded-xl font-black text-xs active:scale-95 transition-all">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</button></div>
                                </div>
                            )}
                        </main>

                        {leaderboard.visible && (
                            <div className="absolute inset-0 bg-white z-[100] flex flex-col p-6 animate-in slide-in-from-bottom duration-300">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3"><h3 className="font-black text-slate-800 text-base flex items-center gap-2"><Icon name="crown" className="text-amber-500 text-lg" /> Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</h3><button onClick={() => setLeaderboard({ ...leaderboard, visible: false })} className="w-9 h-9 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 transition-colors"><Icon name="times" className="text-lg" /></button></div>
                                <div className="flex gap-2 mb-3 bg-slate-100 p-1.5 rounded-xl">{studentInfo.classId && <button onClick={() => fetchLeaderboard('class')} className={`flex-1 py-2 rounded-lg text-xs font-black ${leaderboard.mode === 'class' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>ÙØµÙ„ÙŠ</button>}<button onClick={() => fetchLeaderboard('global')} className={`flex-1 py-2 rounded-lg text-xs font-black ${leaderboard.mode === 'global' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Ø§Ù„Ø¹Ø§Ù…</button></div>
                                <div className="flex-1 overflow-y-auto bg-slate-50 rounded-xl p-3 relative custom-scrollbar">
                                    {leaderboard.loading ? <div className="absolute inset-0 flex items-center justify-center bg-white/60"><Icon name="sync" className="text-blue-500 text-2xl" /></div> : leaderboard.data.length > 0 ? (
                                        <table className="w-full text-right text-xs border-separate border-spacing-y-1.5">
                                            <thead><tr className="text-slate-400"><th className="p-2 text-center">#</th><th className="p-2">Ø§Ù„Ø¨Ø·Ù„</th><th className="p-2 text-center">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead>
                                            <tbody>{leaderboard.data.map((p, i) => (<tr key={i} className={`shadow-sm rounded-lg ${studentInfo.name === p.name ? 'bg-blue-600 text-white font-bold' : 'bg-white text-slate-600'}`}><td className="p-3 text-center rounded-r-lg w-10 font-black">{i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td><td className="p-3 truncate max-w-[120px]">{p.name}</td><td className="p-3 text-center rounded-l-lg font-black">{toAr(parseFloat(p.grade).toFixed(1))}</td></tr>))}</tbody>
                                        </table>
                                    ) : <div className="h-full flex items-center justify-center text-slate-400 text-xs italic">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

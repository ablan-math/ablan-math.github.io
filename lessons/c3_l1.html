<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٣-١: معادلة المستقيم بصيغة الميل والمقطع | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .math-eq {
            font-family: "Courier New", monospace; /* خط عريض ومتباعد */
            font-size: 1.2rem; /* تكبير حجم الخط */
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6; /* خلفية رمادية فاتحة */
            border: 1px solid #d1d5db; /* إطار خفيف */
            padding: 2px 8px; /* هوامش داخلية */
            border-radius: 6px; /* زوايا دائرية */
            display: inline-block;
            vertical-align: middle; /* محاذاة أفضل مع النص */
        }
        .explanation-step { 
            padding-right: 12px; 
            margin-bottom: 1rem; 
            border-right: 3px solid #1d4ed8; 
            transition: opacity 0.5s ease-in-out; 
        }
        .nav-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2em;
            line-height: 1.2em;
        }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > span:last-child { border-top: 2px solid #4338ca; }

        /* Styles for the interactive graph */
        .graph-container {
            position: relative;
            width: 360px;
            height: 360px;
            margin: 20px auto;
            border: 2px solid #9ca3af;
            background-color: #f9fafb;
        }
        .graph-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, #e5e7eb 1px, transparent 1px), 
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px; /* Each square is 20x20 pixels */
        }
        .graph-axis {
            position: absolute;
            background-color: #9ca3af;
        }
        .x-axis { width: 100%; height: 2px; top: 50%; }
        .y-axis { height: 100%; width: 2px; left: 50%; }
        .graph-line {
            position: absolute;
            background-color: #3b82f6;
            height: 3px;
            transform-origin: 0 0;
            transition: all 0.5s ease-in-out;
        }
        .graph-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease-in-out;
            opacity: 0;
            z-index: 10;
        }
        .graph-movement-line {
            position: absolute;
            border-color: #f59e0b; /* amber-500 */
            border-style: dashed;
            opacity: 0;
            z-index: 5;
        }
        .graph-movement-text {
            position: absolute;
            opacity: 0;
            z-index: 6;
            color: #d97706; /* amber-600 */
            font-weight: bold;
            font-size: 1.1rem;
            transform: translate(-50%, -50%);
        }
        /* --- Animation Delays for Graphing --- */
        .graph-rise, .graph-rise-text {
            transition: opacity 0.4s ease-in-out 0.3s;
        }
        .graph-run, .graph-run-text {
            transition: opacity 0.4s ease-in-out 1.2s;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-5xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٣-١: معادلة المستقيم بصيغة الميل والمقطع</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>

                <!-- المحتوى القديم يبدأ هنا -->

                <!-- Part 1: Basic Concepts -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفاهيم الأساسية</h2>
                    <div class="p-6 bg-blue-50 rounded-lg space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">صيغة الميل والمقطع</h3>
                            <p>التعبير اللفظي: يمكن كتابة معادلة أي خط مستقيم (غير رأسي) باستعمال ميله (م) والمقطع الصادي (ب) وهو الإحداثي الصادي لنقطة تقاطع المستقيم مع محور الصادات.</p>
                            <div class="mt-4 p-4 bg-white rounded-lg border">
                                 <p class="text-lg text-center font-bold">صيغة الميل والمقطع</p>
                                 <p class="text-center my-2 p-3 bg-indigo-50 rounded-md text-xl">
                                     <span class="math-eq" style="font-size: 1.5rem;">ص = م س + ب</span>
                                 </p>
                                 <div class="flex justify-around mt-2 text-center">
                                    <p><strong>م:</strong> الميل</p>
                                    <p><strong>ب:</strong> المقطع الصادي</p>
                                 </div>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white p-3 rounded-lg border text-center">
                                <p><strong>مثال ١:</strong> <span class="math-eq">ص = ٣س + ٢</span></p>
                                <p class="text-green-600 font-bold">الميل (م) = <span class="math-eq">٣</span></p>
                                <p class="text-blue-600 font-bold">المقطع (ب) = <span class="math-eq">٢</span></p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border text-center">
                                <p><strong>مثال ٢:</strong> <span class="math-eq">ص = -٢س + ١</span></p>
                                <p class="text-green-600 font-bold">الميل (م) = <span class="math-eq">-٢</span></p>
                                <p class="text-blue-600 font-bold">المقطع (ب) = <span class="math-eq">١</span></p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border text-center">
                                <p><strong>مثال ٣:</strong> <span class="math-eq">ص = <span class="fraction"><span>١</span><span>٢</span></span> س - ٣</span></p>
                                <p class="text-green-600 font-bold">الميل (م) = <span class="math-eq"><span class="fraction"><span>١</span><span>٢</span></span></span></p>
                                <p class="text-blue-600 font-bold">المقطع (ب) = <span class="math-eq">-٣</span></p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Part 2: Writing Equation from Slope and Intercept -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">✍️ ثانياً: كتابة المعادلة (تفاعلي)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Example 1 -->
                            <div class="border p-4 rounded-lg bg-white">
                                 <p class="text-center font-bold">مثال ١: اكتب معادلة المستقيم الذي ميله <span class="math-eq">-٣</span> ومقطعه الصادي <span class="math-eq">٥</span>.</p>
                                <div class="bg-gray-50 p-4 mt-2 rounded-lg border min-h-[250px]">
                                   <div id="write-eq-explanation-1" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="write-eq-back-1" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="write-eq-counter-1">0</span> / 4</span>
                                   <button id="write-eq-next-1" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                            <!-- Example 2 -->
                            <div class="border p-4 rounded-lg bg-white">
                                 <p class="text-center font-bold">مثال ٢: اكتب معادلة المستقيم الذي ميله <span class="math-eq">٤</span> ومقطعه الصادي <span class="math-eq">-٢</span>.</p>
                                <div class="bg-gray-50 p-4 mt-2 rounded-lg border min-h-[250px]">
                                   <div id="write-eq-explanation-2" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="write-eq-back-2" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="write-eq-counter-2">0</span> / 4</span>
                                   <button id="write-eq-next-2" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Part 3: Graphing an Equation -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📊 ثالثاً: تمثيل المعادلة بيانياً (تفاعلي)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-8">
                        <!-- Example 1 -->
                        <div class="border p-4 rounded-lg bg-white">
                            <h3 class="text-xl font-bold text-center mb-2">مثال ١: ميل موجب</h3>
                            <p class="text-center">مثل المعادلة <span class="math-eq">ص = <span class="fraction"><span>٢</span><span>٣</span></span>س - ١</span> بيانياً.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center mt-4">
                                <div class="border p-4 rounded-lg bg-white">
                                    <div class="bg-gray-50 p-4 rounded-lg border min-h-[340px]">
                                       <div id="graph-eq-explanation-1" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                       <button id="graph-eq-back-1" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                       <span class="text-sm font-bold text-gray-600">الخطوة <span id="graph-eq-counter-1">0</span> / 4</span>
                                       <button id="graph-eq-next-1" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                   </div>
                                </div>
                                <div class="graph-container">
                                    <div class="graph-grid"></div>
                                    <div class="graph-axis x-axis"></div>
                                    <div class="graph-axis y-axis"></div>
                                    <div id="graph-rise-line-1" class="graph-movement-line graph-rise"></div>
                                    <div id="graph-run-line-1" class="graph-movement-line graph-run"></div>
                                    <div id="graph-rise-text-1" class="graph-movement-text graph-rise-text"></div>
                                    <div id="graph-run-text-1" class="graph-movement-text graph-run-text"></div>
                                    <div id="graph-point-1-1" class="graph-point"></div>
                                    <div id="graph-point-1-2" class="graph-point"></div>
                                    <div id="graph-line-1" class="graph-line" style="width: 0; top: 0; left: 0;"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Example 2 -->
                        <div class="border p-4 rounded-lg bg-white">
                            <h3 class="text-xl font-bold text-center mb-2">مثال ٢: ميل سالب (أصعب)</h3>
                            <p class="text-center">مثل المعادلة <span class="math-eq">ص + <span class="fraction"><span>١</span><span>٤</span></span>س = ٢</span> بيانياً.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center mt-4">
                                <div class="border p-4 rounded-lg bg-white">
                                    <div class="bg-gray-50 p-4 rounded-lg border min-h-[340px]">
                                       <div id="graph-eq-explanation-2" class="text-right"></div>
                                    </div>
                                    <div class="mt-4 flex justify-between items-center">
                                       <button id="graph-eq-back-2" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                       <span class="text-sm font-bold text-gray-600">الخطوة <span id="graph-eq-counter-2">0</span> / 5</span>
                                       <button id="graph-eq-next-2" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                                   </div>
                                </div>
                                <div class="graph-container">
                                    <div class="graph-grid"></div>
                                    <div class="graph-axis x-axis"></div>
                                    <div class="graph-axis y-axis"></div>
                                    <div id="graph-rise-line-2" class="graph-movement-line graph-rise"></div>
                                    <div id="graph-run-line-2" class="graph-movement-line graph-run"></div>
                                    <div id="graph-rise-text-2" class="graph-movement-text graph-rise-text"></div>
                                    <div id="graph-run-text-2" class="graph-movement-text graph-run-text"></div>
                                    <div id="graph-point-2-1" class="graph-point"></div>
                                    <div id="graph-point-2-2" class="graph-point"></div>
                                    <div id="graph-line-2" class="graph-line" style="width: 0; top: 0; left: 0;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Part 4: Real-life Example -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🏢 رابعاً: من واقع الحياة</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Example 1 -->
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2">مثال ١: تكلفة ثابتة ومتغيرة</h3>
                                <p>لدى شركة سيارات أجرة رسم ثابت مقداره <span class="math-eq">٤</span> ريالات، يضاف إليه <span class="math-eq">٢</span> ريال لكل كيلومتر تقطعه السيارة. اكتب معادلة تمثل التكلفة (ص) لعدد (س) من الكيلومترات.</p>
                                 <div class="bg-gray-50 p-4 mt-2 rounded-lg border min-h-[220px]">
                                   <div id="life-eq-explanation-1" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="life-eq-back-1" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="life-eq-counter-1">0</span> / 3</span>
                                   <button id="life-eq-next-1" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                            <!-- Example 2 -->
                            <div class="border p-4 rounded-lg bg-white">
                                <h3 class="font-bold text-center mb-2">مثال ٢: قيمة ابتدائية وتناقص (أصعب)</h3>
                                <p>بطارية هاتف مشحونة بالكامل (<span class="math-eq">١٠٠٪</span>). إذا كانت تفقد <span class="math-eq">١٥٪</span> من شحنها كل ساعة من الاستخدام، اكتب معادلة تمثل النسبة المئوية المتبقية من الشحن (ص) بعد (س) ساعة.</p>
                                 <div class="bg-gray-50 p-4 mt-2 rounded-lg border min-h-[220px]">
                                   <div id="life-eq-explanation-2" class="text-right"></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                   <button id="life-eq-back-2" class="nav-btn bg-gray-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">رجوع</button>
                                   <span class="text-sm font-bold text-gray-600">الخطوة <span id="life-eq-counter-2">0</span> / 4</span>
                                   <button id="life-eq-next-2" class="nav-btn bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">التالي</button>
                               </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- المحتوى القديم ينتهي هنا -->

                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ خامساً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-6 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // ==================================================
    // دوال مشتركة للمنصة
    // ==================================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function initializeQuiz(lessonId, questions, studentData) { currentQuestions = questions; const quizForm = document.getElementById('quizForm'); if (!quizForm) return; if (questions.length === 0) { quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; return; } let attemptsLeft; if (studentData) { const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 }; attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts; } else { attemptsLeft = 1; } const attemptsCounter = document.getElementById('attempts-counter'); if (attemptsCounter) { attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; } const quizHtml = questions.map((q, index) => { const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); return `<div class="p-4 border-2 border-gray-200 rounded-lg"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div>`; }).join(''); quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; questions.forEach((q, index) => { const explainBtn = document.getElementById(`explain-btn-${index}`); if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index)); }); if (attemptsLeft <= 0) { const submitBtn = quizForm.querySelector('#submit-quiz-btn'); submitBtn.disabled = true; submitBtn.textContent = 'لا توجد محاولات متبقية'; submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400'); } quizForm.onsubmit = (e) => { e.preventDefault(); let score = 0; questions.forEach((q, index) => { const userAnswer = e.target.elements[`q${index}`]?.value; const feedbackEl = document.getElementById(`feedback-q${index}`); if (userAnswer === q.correct) { score++; feedbackEl.textContent = '✔ إجابة صحيحة!'; feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; } else { feedbackEl.textContent = `❌ إجابة خاطئة.`; feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; } document.getElementById(`explain-btn-${index}`).classList.remove('hidden');}); const finalGrade = Math.round((score / questions.length) * 10); const resultsDiv = document.getElementById('quiz-results'); resultsDiv.classList.remove('hidden'); document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; if (studentData) { saveGrade(lessonId, finalGrade, studentData.id); if (attemptsLeft - 1 > 0) { document.getElementById('retake-quiz-btn').classList.remove('hidden'); } } else { document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; } e.target.querySelector('#submit-quiz-btn').disabled = true; }; }
    function saveGrade(lessonId, grade, studentId) { if (!studentId) return; const saveStatus = document.getElementById('save-status'); saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&lessonId=${lessonId}&grade=${grade}`; fetch(url) .then(res => res.json()) .then(result => { if (result.status === 'success') { saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; const studentData = JSON.parse(localStorage.getItem('currentStudent')); if (!studentData.lessons) studentData.lessons = {}; if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; } else { studentData.lessons[lessonId].attempts++; } localStorage.setItem('currentStudent', JSON.stringify(studentData)); } else { throw new Error(result.message); } }) .catch(error => { saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; console.error("Save Grade Error:", error); }); }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { explanationText.innerHTML = currentQuestions[questionIndex].explanation; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }
    
    // ==================================================
    // مشغل الكود الخاص بالدرس
    // ==================================================
    
    // 1. تحديد المعرف الفريد للدرس
    const LESSON_ID = 'c3_l1'; 
    
    // 2. بنك الأسئلة الخاص بالدرس
    function generateQuiz() {
        const questionBank = [
            { type: 'mcq', level: '⭐', topic: 'identify', text: 'في المعادلة ص = ٥س - ٣، ما هو المقطع الصادي؟', options: [ { display: '٥', value: 'A' }, { display: 'س', value: 'B' }, { display: '-٣', value: 'C' }, { display: '٣', value: 'D' } ], correct: 'C', explanation: '<p>في صيغة الميل والمقطع (ص = م س + ب)، يمثل الرمز (ب) المقطع الصادي. في هذه المعادلة، ب = -٣.</p>' },
            { type: 'mcq', level: '⭐', topic: 'identify', text: 'في المعادلة ص = -س + ٧، ما هو الميل؟', options: [ { display: '١', value: 'A' }, { display: '-١', value: 'B' }, { display: '٧', value: 'C' }, { display: '-٧', value: 'D' } ], correct: 'B', explanation: '<p>في صيغة الميل والمقطع (ص = م س + ب)، يمثل الرمز (م) الميل. في هذه المعادلة، ص = (-١)س + ٧، إذن الميل م = -١.</p>' },
            { type: 'mcq', level: '⭐⭐', topic: 'write-equation', text: 'اكتب معادلة المستقيم الذي ميله ٢ ومقطعه الصادي -٤.', options: [ { display: 'ص = -٤س + ٢', value: 'A' }, { display: 'ص = ٢س - ٤', value: 'B' }, { display: 'ص = ٢س + ٤', value: 'C' }, { display: 'ص = ٤س - ٢', value: 'D' } ], correct: 'B', explanation: '<p>نعوض مباشرة في الصيغة ص = م س + ب. مع م = ٢ و ب = -٤، نحصل على ص = ٢س - ٤.</p>' },
            { type: 'mcq', level: '⭐⭐', topic: 'write-equation', text: 'ما هي معادلة المستقيم الذي ميله <span class="fraction"><span>١</span><span>٢</span></span> ومقطعه الصادي ٣؟', options: [ { display: 'ص = ٣س + <span class="fraction"><span>١</span><span>٢</span></span>', value: 'A' }, { display: 'ص = س + <span class="fraction"><span>٣</span><span>٢</span></span>', value: 'B' }, { display: 'ص = <span class="fraction"><span>١</span><span>٢</span></span> س + ٣', value: 'C' }, { display: 'ص = <span class="fraction"><span>١</span><span>٢</span></span> س - ٣', value: 'D' } ], correct: 'C', explanation: '<p>نعوض مباشرة في الصيغة ص = م س + ب. مع م = <span class="fraction"><span>١</span><span>٢</span></span> و ب = ٣، نحصل على ص = <span class="fraction"><span>١</span><span>٢</span></span> س + ٣.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'application', text: 'تبلغ تكلفة الاشتراك في نادٍ رياضي ١٠٠ ريال شهرياً، بالإضافة إلى ٥٠ ريالاً كرسم تسجيل لمرة واحدة. أي معادلة تمثل التكلفة (ص) لعدد (س) من الشهور؟', options: [ { display: 'ص = ٥٠س + ١٠٠', value: 'A' }, { display: 'ص = ١٠٠س + ٥٠', value: 'B' }, { display: 'ص = ١٥٠س', value: 'C' }, { display: 'ص = ٥٠س - ١٠٠', value: 'D' } ], correct: 'B', explanation: '<p>رسم التسجيل هو مبلغ ثابت يُدفع مرة واحدة، لذا فهو المقطع الصادي (ب = ٥٠). التكلفة الشهرية هي معدل التغير، لذا هي الميل (م = ١٠٠). المعادلة هي ص = ١٠٠س + ٥٠.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'graph-to-equation', text: 'مستقيم يمر بالنقطة (٠، ١) والنقطة (٢، ٥). ما هي معادلته؟', options: [ { display: 'ص = ٢س + ١', value: 'A' }, { display: 'ص = س + ٢', value: 'B' }, { display: 'ص = -٢س + ١', value: 'C' }, { display: 'ص = ٥س + ٢', value: 'D' } ], correct: 'A', explanation: '<p>أولاً، نحدد المقطع الصادي من النقطة (٠، ١)، إذن ب = ١. ثانياً، نحسب الميل: م = <span class="fraction"><span>٥-١</span><span>٢-٠</span></span> = <span class="fraction"><span>٤</span><span>٢</span></span> = ٢. إذن المعادلة هي ص = ٢س + ١.</p>' },
            { type: 'mcq', level: '⭐⭐', topic: 'write-equation', text: 'ما معادلة المستقيم الذي ميله ٤ ومقطعه الصادي -٢؟', options: [ { display: 'ص = ٤س - ٢', value: 'A' }, { display: 'ص = -٢س + ٤', value: 'B' }, { display: 'ص = ٤س + ٢', value: 'C' }, { display: 'ص = ٢س - ٤', value: 'D' } ], correct: 'A', explanation: '<p>بتطبيق صيغة الميل والمقطع ص = م س + ب، نعوض عن م بـ ٤ وعن ب بـ -٢ لنحصل على ص = ٤س - ٢.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'write-equation-rearranged', text: 'أي معادلة تمثل مستقيماً ميله -٢ ومقطعه الصادي ٣؟', options: [ { display: 'ص + ٢س = ٣', value: 'A' }, { display: 'ص - ٢س = ٣', value: 'B' }, { display: '٢ص + س = ٦', value: 'C' }, { display: 'ص + ٣ = -٢س', value: 'D' } ], correct: 'A', explanation: '<p>المعادلة هي ص = -٢س + ٣. بنقل -٢س إلى الطرف الآخر، تصبح المعادلة ص + ٢س = ٣.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'graph-to-equation', text: 'مستقيم مقطعه الصادي عند (٠، -١) وميله <span class="fraction"><span>٢</span><span>٣</span></span>. ما هي معادلته؟', options: [ { display: 'ص = <span class="fraction"><span>٢</span><span>٣</span></span>س - ١', value: 'A' }, { display: 'ص = <span class="fraction"><span>٣</span><span>٢</span></span>س - ١', value: 'B' }, { display: 'ص = -س + <span class="fraction"><span>٢</span><span>٣</span></span>', value: 'C' }, { display: 'ص = <span class="fraction"><span>٢</span><span>٣</span></span>س + ١', value: 'D' } ], correct: 'A', explanation: '<p>بما أن المقطع الصادي ب = -١ والميل م = <span class="fraction"><span>٢</span><span>٣</span></span>، فإن المعادلة هي ص = <span class="fraction"><span>٢</span><span>٣</span></span>س - ١.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'identify-from-rearranged', text: 'ما هو ميل المستقيم الذي معادلته ٣ص - ٦س = ٩؟', options: [ { display: '-٢', value: 'A' }, { display: '٦', value: 'B' }, { display: '٣', value: 'C' }, { display: '٢', value: 'D' } ], correct: 'D', explanation: '<p>يجب أولاً وضع المعادلة على صيغة الميل والمقطع (ص = م س + ب). ٣ص = ٦س + ٩. ثم نقسم على ٣: ص = ٢س + ٣. إذن الميل (م) هو ٢.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'application', text: 'باستخدام معادلة سيارة الأجرة ص = ٢س + ٤، ما تكلفة رحلة لمسافة ١٠ كيلومترات؟', options: [ { display: '٢٤ ريال', value: 'A' }, { display: '١٦ ريال', value: 'B' }, { display: '٢٠ ريال', value: 'C' }, { display: '١٤ ريال', value: 'D' } ], correct: 'A', explanation: '<p>نعوض عن س (المسافة) بـ ١٠ في المعادلة: ص = ٢(١٠) + ٤ = ٢٠ + ٤ = ٢٤ ريال.</p>' },
            { type: 'mcq', level: '⭐⭐⭐', topic: 'application', text: 'باستخدام معادلة البطارية ص = -١٥س + ١٠٠، كم ستكون نسبة الشحن بعد ٣ ساعات؟', options: [ { display: '٤٥٪', value: 'A' }, { display: '٥٥٪', value: 'B' }, { display: '٧٠٪', value: 'C' }, { display: '٨٥٪', value: 'D' } ], correct: 'B', explanation: '<p>نعوض عن س (الساعات) بـ ٣ في المعادلة: ص = -١٥(٣) + ١٠٠ = -٤٥ + ١٠٠ = ٥٥٪.</p>' }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        const questionCount = Math.min(shuffled.length, 5);
        return shuffled.slice(0, questionCount);
    }
    
    // 3. تشغيل الكود عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
        // --- دوال الأمثلة التفاعلية القديمة ---
        function createInteractiveSection(config) {
            let currentStep = 0;
            const renderStep = (step) => {
                if(config.stepCounter) config.stepCounter.textContent = step;
                let cumulativeHTML = '';
                if (step === 0) {
                    cumulativeHTML = `<div class="explanation-step" style="border-color: transparent;">${config.stepsContent[0].text}</div>`;
                } else {
                    for (let i = 1; i <= step; i++) {
                        cumulativeHTML += `<div class="explanation-step">${config.stepsContent[i].text}</div>`;
                    }
                }
                if(config.explanationDiv) config.explanationDiv.innerHTML = cumulativeHTML;
                if (config.customRender) {
                    config.customRender(step);
                }
                if(config.backBtn) config.backBtn.disabled = (step === 0);
                if(config.nextBtn) config.nextBtn.textContent = (step === config.totalSteps) ? 'إعادة' : 'التالي';
            };
            if(config.nextBtn) config.nextBtn.addEventListener('click', () => {
                currentStep = (currentStep < config.totalSteps) ? currentStep + 1 : 0;
                renderStep(currentStep);
            });
            if(config.backBtn) config.backBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    renderStep(currentStep);
                }
            });
            renderStep(0);
        }

        // استدعاءات الأمثلة التفاعلية القديمة
        createInteractiveSection({ nextBtn: document.getElementById('write-eq-next-1'), backBtn: document.getElementById('write-eq-back-1'), stepCounter: document.getElementById('write-eq-counter-1'), explanationDiv: document.getElementById('write-eq-explanation-1'), totalSteps: 4, stepsContent: [ { text: "نبدأ بكتابة الصيغة العامة لمعادلة المستقيم." }, { text: "<strong>1. الصيغة العامة:</strong><br><span class='math-eq text-center mt-2 block'>ص = م س + ب</span>" }, { text: "<strong>2. تحديد المعطيات:</strong><br>الميل <span class='math-eq'>م = -٣</span><br>المقطع الصادي <span class='math-eq'>ب = ٥</span>" }, { text: "<strong>3. نعوض بالقيم في الصيغة:</strong><br><span class='math-eq text-center mt-2 block'>ص = (-٣)س + (٥)</span>" }, { text: "<strong>4. المعادلة النهائية:</strong><br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md'>ص = -٣س + ٥</span>" } ] });
        createInteractiveSection({ nextBtn: document.getElementById('write-eq-next-2'), backBtn: document.getElementById('write-eq-back-2'), stepCounter: document.getElementById('write-eq-counter-2'), explanationDiv: document.getElementById('write-eq-explanation-2'), totalSteps: 4, stepsContent: [ { text: "نبدأ بكتابة الصيغة العامة لمعادلة المستقيم." }, { text: "<strong>1. الصيغة العامة:</strong><br><span class='math-eq text-center mt-2 block'>ص = م س + ب</span>" }, { text: "<strong>2. تحديد المعطيات:</strong><br>الميل <span class='math-eq'>م = ٤</span><br>المقطع الصادي <span class='math-eq'>ب = -٢</span>" }, { text: "<strong>3. نعوض بالقيم في الصيغة:</strong><br><span class='math-eq text-center mt-2 block'>ص = (٤)س + (-٢)</span>" }, { text: "<strong>4. المعادلة النهائية:</strong><br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md'>ص = ٤س - ٢</span>" } ] });
        createInteractiveSection({ nextBtn: document.getElementById('graph-eq-next-1'), backBtn: document.getElementById('graph-eq-back-1'), stepCounter: document.getElementById('graph-eq-counter-1'), explanationDiv: document.getElementById('graph-eq-explanation-1'), totalSteps: 4, stepsContent: [ { text: "لتمثيل المعادلة بيانياً، نحتاج إلى نقطتين على الأقل." }, { text: "<strong>1. نحدد المقطع الصادي (ب):</strong><br>من المعادلة، نجد أن <span class='math-eq'>ب = -١</span>. هذه هي النقطة الأولى (٠، -١)." }, { text: "<strong>2. نستخدم الميل (م) لإيجاد نقطة أخرى:</strong><br>الميل <span class='math-eq'>م = <span class='fraction'><span>٢</span><span>٣</span></span></span>. هذا يعني تحرك رأسي (بسط) وتحرك أفقي (مقام)." }, { text: "<strong>3. نبدأ من المقطع الصادي (٠، -١):</strong><br>نتحرك وحدتين للأعلى (لأن البسط ٢) و٣ وحدات لليمين (لأن المقام ٣) للوصول إلى النقطة الثانية (٣، ١)." }, { text: "<strong>4. نرسم خطاً مستقيماً يمر بالنقطتين.</strong>" } ], customRender: (step) => { const p1 = document.getElementById('graph-point-1-1'); const p2 = document.getElementById('graph-point-1-2'); const line = document.getElementById('graph-line-1'); const riseLine = document.getElementById('graph-rise-line-1'); const runLine = document.getElementById('graph-run-line-1'); const riseText = document.getElementById('graph-rise-text-1'); const runText = document.getElementById('graph-run-text-1'); const unit = 20; p1.style.opacity = '0'; p2.style.opacity = '0'; line.style.width = '0px'; riseLine.style.opacity = '0'; runLine.style.opacity = '0'; riseText.style.opacity = '0'; runText.style.opacity = '0'; if (step >= 1) { p1.style.opacity = '1'; p1.style.top = `calc(50% + ${1 * unit}px)`; p1.style.left = '50%'; } if (step >= 3) { riseLine.style.opacity = '1'; riseText.style.opacity = '1'; runLine.style.opacity = '1'; runText.style.opacity = '1'; riseLine.style.top = `calc(50% - ${1 * unit}px)`; riseLine.style.left = `50%`; riseLine.style.height = `${2 * unit}px`; riseLine.style.borderLeftWidth = '2px'; runLine.style.top = `calc(50% - ${1 * unit}px)`; runLine.style.left = `50%`; runLine.style.width = `${3 * unit}px`; runLine.style.borderTopWidth = '2px'; riseText.textContent = '+٢'; riseText.style.top = `calc(50%)`; riseText.style.left = `calc(50% - 20px)`; runText.textContent = '+٣'; runText.style.top = `calc(50% - ${1 * unit}px - 15px)`; runText.style.left = `calc(50% + ${1.5 * unit}px)`; p2.style.opacity = '1'; p2.style.top = `calc(50% - ${1 * unit}px)`; p2.style.left = `calc(50% + ${3 * unit}px)`; } if (step >= 4) { line.style.top = `calc(50% + ${1 * unit}px)`; line.style.left = '50%'; const rise = -2 * unit; const run = 3 * unit; const angle = Math.atan2(rise, run) * (180 / Math.PI); const length = Math.sqrt(rise*rise + run*run); line.style.transform = `rotate(${angle}deg) translate(-${length * 2}px, 0)`; line.style.width = `${length * 5}px`; } } });
        createInteractiveSection({ nextBtn: document.getElementById('graph-eq-next-2'), backBtn: document.getElementById('graph-eq-back-2'), stepCounter: document.getElementById('graph-eq-counter-2'), explanationDiv: document.getElementById('graph-eq-explanation-2'), totalSteps: 5, stepsContent: [ { text: "أولاً، يجب أن تكون المعادلة على صيغة الميل والمقطع (ص = م س + ب)." }, { text: "<strong>1. نعيد ترتيب المعادلة:</strong><br>ننقل <span class='math-eq'>+<span class='fraction'><span>١</span><span>٤</span></span>س</span> إلى الطرف الآخر بعكس إشارته.<br><span class='math-eq text-center mt-2 block p-2 bg-blue-100 rounded-md'>ص = -<span class='fraction'><span>١</span><span>٤</span></span>س + ٢</span>" }, { text: "<strong>2. نحدد المقطع الصادي (ب):</strong><br>الآن المعادلة على الصيغة الصحيحة. نجد أن <span class='math-eq'>ب = ٢</span>. هذه هي النقطة الأولى (٠، ٢)." }, { text: "<strong>3. نستخدم الميل (م) لإيجاد نقطة أخرى:</strong><br>الميل <span class='math-eq'>م = -<span class='fraction'><span>١</span><span>٤</span></span></span>. هذا يعني تحرك للأسفل ١ (بسط) ولليمين ٤ (مقام)." }, { text: "<strong>4. نمثل الحركة:</strong><br>بدءاً من (٠، ٢)، نتحرك للأسفل ١ ولليمين ٤ لنصل إلى النقطة (٤، ١)." }, { text: "<strong>5. نرسم الخط المستقيم</strong> الذي يمر بالنقطتين."} ], customRender: (step) => { const p1 = document.getElementById('graph-point-2-1'); const p2 = document.getElementById('graph-point-2-2'); const line = document.getElementById('graph-line-2'); const riseLine = document.getElementById('graph-rise-line-2'); const runLine = document.getElementById('graph-run-line-2'); const riseText = document.getElementById('graph-rise-text-2'); const runText = document.getElementById('graph-run-text-2'); const unit = 20; p1.style.opacity = '0'; p2.style.opacity = '0'; line.style.width = '0px'; riseLine.style.opacity = '0'; runLine.style.opacity = '0'; riseText.style.opacity = '0'; runText.style.opacity = '0'; if (step >= 2) { p1.style.opacity = '1'; p1.style.top = `calc(50% - ${2 * unit}px)`; p1.style.left = '50%'; } if (step >= 4) { riseLine.style.opacity = '1'; riseText.style.opacity = '1'; runLine.style.opacity = '1'; runText.style.opacity = '1'; riseLine.style.top = `calc(50% - ${2 * unit}px)`; riseLine.style.left = `50%`; riseLine.style.height = `${1 * unit}px`; riseLine.style.borderLeftWidth = '2px'; runLine.style.top = `calc(50% - ${1 * unit}px)`; runLine.style.left = `50%`; runLine.style.width = `${4 * unit}px`; runLine.style.borderTopWidth = '2px'; riseText.textContent = '-١'; riseText.style.top = `calc(50% - ${1.5 * unit}px)`; riseText.style.left = `calc(50% - 15px)`; runText.textContent = '+٤'; runText.style.top = `calc(50% - ${1 * unit}px - 15px)`; runText.style.left = `calc(50% + ${2 * unit}px)`; p2.style.opacity = '1'; p2.style.top = `calc(50% - ${1 * unit}px)`; p2.style.left = `calc(50% + ${4 * unit}px)`; } if (step >= 5) { line.style.top = `calc(50% - ${2 * unit}px)`; line.style.left = '50%'; const rise = 1 * unit; const run = 4 * unit; const angle = Math.atan2(rise, run) * (180 / Math.PI); const length = Math.sqrt(rise*rise + run*run); line.style.transform = `rotate(${angle}deg) translate(-${length * 1.5}px, 0)`; line.style.width = `${length * 4}px`; } } });
        createInteractiveSection({ nextBtn: document.getElementById('life-eq-next-1'), backBtn: document.getElementById('life-eq-back-1'), stepCounter: document.getElementById('life-eq-counter-1'), explanationDiv: document.getElementById('life-eq-explanation-1'), totalSteps: 3, stepsContent: [ { text: "نحلل المسألة لتحديد الميل والمقطع الصادي." }, { text: "<strong>1. نحدد المقطع الصادي (ب):</strong><br>هو القيمة الثابتة التي لا تتغير، وهي الرسم الثابت. إذن <span class='math-eq'>ب = ٤</span>." }, { text: "<strong>2. نحدد الميل (م):</strong><br>هو معدل التغير، أي التكلفة لكل كيلومتر. إذن <span class='math-eq'>م = ٢</span>." }, { text: "<strong>3. نكتب المعادلة بصيغة الميل والمقطع:</strong><br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md'>ص = ٢س + ٤</span>" } ] });
        createInteractiveSection({ nextBtn: document.getElementById('life-eq-next-2'), backBtn: document.getElementById('life-eq-back-2'), stepCounter: document.getElementById('life-eq-counter-2'), explanationDiv: document.getElementById('life-eq-explanation-2'), totalSteps: 4, stepsContent: [ { text: "نحلل المسألة لتحديد الميل والمقطع الصادي." }, { text: "<strong>1. نحدد المقطع الصادي (ب):</strong><br>هو القيمة الابتدائية، وهي نسبة شحن البطارية قبل الاستخدام. إذن <span class='math-eq'>ب = ١٠٠</span>." }, { text: "<strong>2. نحدد الميل (م):</strong><br>هو معدل التغير، أي مقدار النقصان في الشحن كل ساعة. بما أنه نقصان، فالميل سالب." }, { text: "<strong>3. قيمة الميل:</strong><br>تفقد البطارية ١٥٪ كل ساعة، إذن <span class='math-eq'>م = -١٥</span>." }, { text: "<strong>4. نكتب المعادلة بصيغة الميل والمقطع:</strong><br><span class='math-eq text-center mt-2 block p-2 bg-green-100 rounded-md'>ص = -١٥س + ١٠٠</span>" } ] });

        // --- تهيئة المنصة والامتحان ---
        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>٦-١ ضرب وحيدات الحد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- أيقونات Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- إعدادات الثيم (الفصل 6) - هوية المنصة -->
    <script>
        const themeColor = {
            gradient: 'from-blue-600 to-blue-800', 
            icon: 'fa-graduation-cap',
            text: 'text-blue-600',
            bg: 'bg-blue-50',
            hex: '#2563eb'
        };
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none; }
        .tab-content { padding-bottom: 90px; /* مساحة للشريط السفلي */ animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* تنسيق المعادلات - زيادة الحجم للشاشات الكبيرة */
        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        @media (min-width: 768px) {
            .math-eq { font-size: 1.1em; padding: 4px 12px; }
        }
        
        /* ألوان العناصر في الشرح */
        .num-red { color: #dc2626; } /* أحمر للأرقام */
        .var-green { color: #16a34a; } /* أخضر للسينات */
        .var-blue { color: #2563eb; } /* أزرق للصادات */
        
        .highlight-number { background-color: #fef9c3; color: #b45309; padding: 0 4px; border-radius: 3px; font-weight: bold; }
        
        /* تصغير الأسس وضبط مكانها */
        .tiny-sup { 
            font-size: 0.6em; 
            vertical-align: baseline; 
            position: relative; 
            top: -0.8em; 
            margin-right: 0;
            line-height: 0;
        }

        /* حاوية لإصلاح اتجاه الرقم والأس */
        .fix-pos {
            display: inline-flex;
            flex-direction: row; 
            align-items: baseline; 
            gap: 0px; 
        }

        /* تنسيق الكسور */
        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 4px; font-size: 0.9em; vertical-align: middle; }
        .fraction > span { padding: 0 2px; display: block; line-height: 1; }
        .fraction > .bar { border-top: 2px solid currentColor; height: 0; width: 100%; margin: 2px 0; }
        
        /* الشريط السفلي */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 10px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.65rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 2px; position: relative; }
        
        /* تحسين الشريط السفلي للديسك توب */
        @media (min-width: 768px) {
            .nav-item { font-size: 0.85rem; }
            .nav-item svg, .nav-item i { font-size: 1.5rem; margin-bottom: 6px; }
        }

        .nav-item.active { color: #2563eb; font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -8px; width: 20px; height: 4px; background: #2563eb; border-radius: 4px 4px 0 0; }
        .nav-item svg { width: 20px; height: 20px; margin-bottom: 2px; }

        /* التفاعلات */
        .step-box { border-right: 3px solid #2563eb; background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; }
        .step-interactive.active { display: block; opacity: 1; }
        
        /* أزرار الخيارات */
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .options-grid.single-col { grid-template-columns: 1fr; } 
        
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #eff6ff; color: #1e40af; font-weight: bold; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        
        /* رسائل الخطأ الخاصة */
        .error-hint { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        /* تنسيقات بطاقات الألعاب (هوية المنصة) */
        .gold-card { background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%); border: 2px solid #fcd34d !important; }
        .orange-card { background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%); border: 2px solid #fdba74 !important; }
        .normal-card { background: white; border: 2px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- الرأس الثابت (تصميم المنصة) -->
    <!-- تم إضافة container داخلي لضبط المحتوى في الوسط على الشاشات الكبيرة -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors">
        <div class="container mx-auto max-w-4xl flex justify-between items-center">
            <script>
                document.getElementById('main-header').className += ` bg-gradient-to-r ${themeColor.gradient}`;
            </script>

            <!-- يمين: معلومات الدرس -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i class="fas fa-graduation-cap text-lg md:text-2xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">منصة الرياضيات التفاعلية</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">٦-١</span>
                        <span>ضرب وحيدات الحد</span>
                    </h1>
                </div>
            </div>

            <!-- يسار: الطالب وزر الرجوع -->
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> <span id="student-name">زائر</span>
                </div>
                <a href="/" onclick="goBack(event)" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>رجوع</span>
                </a>
            </div>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <!-- تم تغيير max-w-md إلى max-w-4xl للتوسع في الديسكتوب، وإضافة md:p-8 للمسافات -->
    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-16 transition-all duration-300">
        
        <!-- ======================= تبويب 1: تعلم ١ (المفهوم) ======================= -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-yellow-100 text-yellow-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-yellow-200 shadow-sm">١</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">مفهوم وحيدة الحد</h2>
            </div>

            <!-- بطاقة الشرح -->
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-yellow-400"></div>
                <p class="text-gray-600 leading-relaxed text-sm md:text-lg mb-4">
                    هي عبارة رياضية قد تكون عدداً (<span class="highlight-number">١٠</span>)، أو متغيراً (<span class="math-eq">ف&zwnj;</span>)، أو حاصل ضربهما (<span class="math-eq">١٠ف&zwnj;</span>)، أو حاصل ضرب متغير في متغير (<span class="math-eq">س&zwnj;ص&zwnj;</span>) أو (<span class="math-eq">ف&zwnj;<sup>٢</sup></span>).
                </p>
                <div class="mb-4 bg-yellow-50 p-3 md:p-4 rounded-lg border border-yellow-100">
                    <p class="text-sm md:text-base text-gray-700 leading-7">
                        <strong>الثابت:</strong> هو وحيدة حد عبارة عن عدد حقيقي (مثل: <span class="highlight-number">٥</span>، <span class="highlight-number">-٣</span>، أو <span class="fraction text-yellow-800"><span>٣</span><span class="bar"></span><span>٤</span></span>).
                    </p>
                </div>
                <div class="bg-red-50 text-red-700 text-xs md:text-sm p-3 rounded-lg border border-red-100 flex gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                    <span><strong>انتبه:</strong> الجمع (+) والطرح (-) يمنع العبارة من أن تكون وحيدة حد.</span>
                </div>
            </div>

            <!-- تطبيق ١.١ -->
            <div id="interactive-container-1-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ١-١: هل <span class="math-eq">ف&zwnj; + ٢٤</span> وحيدة حد؟</h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: الفحص</h4>
                        <p class="text-sm md:text-lg">نبحث عن علامات الجمع أو الطرح. وجدنا <span class="highlight-number">+</span>.</p>
                    </div>
                    <div class="step-interactive step-box border-red-500 bg-red-50">
                        <h4 class="font-bold text-xs md:text-sm text-red-600 mb-1">النتيجة</h4>
                        <p class="text-sm md:text-lg">ليست وحيدة حد لوجود الجمع.</p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- تطبيق ١.٢ -->
            <div id="interactive-container-1-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ١-٢: هل <span class="fraction font-bold"><span>٣</span><span class="bar"></span><span>ن&zwnj;</span></span> وحيدة حد؟</h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للتحليل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: الفحص</h4>
                        <p class="text-sm md:text-lg">نلاحظ وجود متغير <span class="highlight-number">(ن)</span> في المقام.</p>
                    </div>
                    <div class="step-interactive step-box border-red-500 bg-red-50">
                        <h4 class="font-bold text-xs md:text-sm text-red-600 mb-1">النتيجة</h4>
                        <p class="text-sm md:text-lg">ليست وحيدة حد. (القسمة على متغير ممنوعة).</p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <button onclick="switchTab('learn2')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2">
                <span>انتقل للنقطة التالية: ضرب القوى</span>
                <i data-lucide="arrow-left" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
        </div>

        <!-- ======================= تبويب 2: تعلم ٢ (القاعدة) ======================= -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-blue-100 text-blue-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-blue-200 shadow-sm">٢</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">ضرب القوى</h2>
            </div>

            <!-- بطاقة الشرح -->
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-blue-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">لضرب قوتين لهما <strong>نفس الأساس</strong>، نجمع الأسس.</p>
                <div class="text-center py-3 md:py-6 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner">
                    <span class="math-eq text-xl md:text-3xl px-4 py-2 bg-white rounded shadow-sm">أ&zwnj;<sup class="tiny-sup">م&zwnj;</sup> · أ&zwnj;<sup class="tiny-sup">ن&zwnj;</sup> = أ&zwnj;<sup class="tiny-sup">م&zwnj;+ن&zwnj;</sup></span>
                </div>
                <p class="text-xs md:text-base text-center text-gray-500 mt-2">مثال: <span class="math-eq">س&zwnj;<sup>٣</sup> · س&zwnj;<sup>٢</sup> = س&zwnj;<sup>٥</sup></span></p>
            </div>

            <!-- تطبيق ٢.١ -->
            <div id="interactive-container-2-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٢-١: بسّط <span class="math-eq">(٢س&zwnj;<sup>٢</sup>)(٣س&zwnj;)</span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: المعاملات</h4>
                        <p class="text-sm md:text-lg"><span class="highlight-number">٢</span> × <span class="highlight-number">٣</span> = <span class="highlight-number">٦</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: الأسس</h4>
                        <p class="text-sm md:text-lg">س<sup>٢</sup> · س<sup>١</sup> &larr; نجمع: ٢+١ = ٣</p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج</h4>
                        <p class="text-sm md:text-lg font-bold"><span class="math-eq">٦س&zwnj;<sup>٣</sup></span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- تطبيق ٢.٢ -->
            <div id="interactive-container-2-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٢-٢: بسّط <span class="math-eq">(٤أ)(٢أ&zwnj;<sup>٣</sup>)</span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: المعاملات</h4>
                        <p class="text-sm md:text-lg"><span class="highlight-number">٤</span> × <span class="highlight-number">٢</span> = <span class="highlight-number">٨</span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: الأسس</h4>
                        <p class="text-sm md:text-lg">أ<sup>١</sup> · أ<sup>٣</sup> &larr; نجمع: ١+٣ = ٤</p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج</h4>
                        <p class="text-sm md:text-lg font-bold"><span class="math-eq">٨أ&zwnj;<sup>٤</sup></span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <button onclick="switchTab('learn3')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2">
                <span>انتقل للنقطة التالية: قوة القوة</span>
                <i data-lucide="arrow-left" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
        </div>

        <!-- ======================= تبويب 3: تعلم ٣ (قوة القوة) ======================= -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-purple-100 text-purple-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-purple-200 shadow-sm">٣</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">قوة القوة</h2>
            </div>

            <!-- بطاقة الشرح -->
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-purple-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">لإيجاد قوة القوة، <strong>نضرب الأسس</strong>.</p>
                <div class="text-center py-3 md:py-6 bg-purple-50 rounded-lg text-purple-900 mb-2 border border-purple-100 shadow-inner">
                    <span class="math-eq text-xl md:text-3xl px-4 py-2 bg-white rounded shadow-sm">(أ&zwnj;<sup class="tiny-sup">م&zwnj;</sup>)<sup class="tiny-sup">ن&zwnj;</sup> = أ&zwnj;<sup class="tiny-sup">م&zwnj;·ن&zwnj;</sup></span>
                </div>
                <p class="text-xs md:text-base text-center text-gray-500 mt-2">مثال: <span class="math-eq">(ب&zwnj;<sup>٣</sup>)<sup>٥</sup> = ب&zwnj;<sup>٣×٥</sup> = ب&zwnj;<sup>١٥</sup></span></p>
            </div>

            <!-- تطبيق ٣.١ -->
            <div id="interactive-container-3-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٣-١: بسّط <span class="math-eq">(ن&zwnj;<sup>٤</sup>)<sup>٧</sup></span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: تحديد الأسس</h4>
                        <p class="text-sm md:text-lg">الأس الداخلي (<span class="highlight-number">٤</span>) والأس الخارجي (<span class="highlight-number">٧</span>).</p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: ضرب الأسس</h4>
                        <p class="text-sm md:text-lg"><span class="highlight-number">٤</span> × <span class="highlight-number">٧</span> = <span class="highlight-number">٢٨</span></p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج</h4>
                        <p class="text-sm md:text-lg font-bold"><span class="math-eq">ن&zwnj;<sup>٢٨</sup></span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <button onclick="switchTab('learn4')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2">
                <span>انتقل للنقطة التالية: قوة حاصل الضرب</span>
                <i data-lucide="arrow-left" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
        </div>

        <!-- ======================= تبويب 4: تعلم ٤ (قوة حاصل الضرب) ======================= -->
        <div id="tab-learn4" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-red-100 text-red-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-red-200 shadow-sm">٤</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">قوة حاصل الضرب</h2>
            </div>

            <!-- بطاقة الشرح -->
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-red-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">لإيجاد قوة حاصل الضرب، أوجد <strong>قوة كل عامل</strong> ثم اضرب.</p>
                <div class="text-center py-3 md:py-6 bg-red-50 rounded-lg text-red-900 mb-2 border border-red-100 shadow-inner">
                    <span class="math-eq text-xl md:text-3xl px-4 py-2 bg-white rounded shadow-sm">(أب)<sup class="tiny-sup">ن&zwnj;</sup> = أ&zwnj;<sup class="tiny-sup">ن&zwnj;</sup> ب&zwnj;<sup class="tiny-sup">ن&zwnj;</sup></span>
                </div>
                <p class="text-xs md:text-base text-center text-gray-500 mt-2" dir="rtl">
                    مثال: 
                    <span class="math-eq">
                        (٢س&zwnj;ص&zwnj;)<sup class="tiny-sup">٣</sup> = 
                        <span class="fix-pos">٢<sup class="tiny-sup">٣</sup></span> 
                        س&zwnj;<sup class="tiny-sup">٣</sup> 
                        ص&zwnj;<sup class="tiny-sup">٣</sup> = 
                        ٨س&zwnj;<sup class="tiny-sup">٣</sup>ص&zwnj;<sup class="tiny-sup">٣</sup>
                    </span>
                </p>
            </div>

            <!-- تطبيق ٤.١ -->
            <div id="interactive-container-4-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٤-١: بسّط <span class="math-eq">(٣س&zwnj;<sup>٢</sup> ص&zwnj;)<sup>٢</sup></span></h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    
                    <!-- Step 1 -->
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس</h4>
                        <p class="text-sm md:text-lg mb-1">المعادلة: <span class="math-eq">(٣س&zwnj;<sup>٢</sup> ص&zwnj;)<sup>٢</sup></span></p>
                        <p class="text-sm md:text-lg">نوزع الأس ٢ على كل من ٣، س²، و ص:</p>
                        <p class="text-sm md:text-lg mt-2 text-center">
                            <span class="math-eq">
                                <span class="fix-pos"><span class="num-red font-bold">٣</span><sup class="tiny-sup num-red">٢</sup></span>
                                <span class="fix-pos"><span class="var-green font-bold">(س&zwnj;<sup>٢</sup>)</span><sup class="tiny-sup var-green">٢</sup></span> 
                                <span class="fix-pos"><span class="var-blue font-bold">ص&zwnj;</span><sup class="tiny-sup var-blue">٢</sup></span>
                            </span>
                        </p>
                    </div>

                    <!-- Step 2 -->
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: التبسيط</h4>
                        <p class="text-sm md:text-lg">
                            <span class="num-red font-bold">٩</span> 
                            <span class="var-green font-bold">س&zwnj;<sup>٤</sup></span> 
                            <span class="var-blue font-bold">ص&zwnj;<sup>٢</sup></span>
                        </p>
                        <p class="text-xs md:text-base text-gray-500 mt-1">(لا توجد متغيرات متشابهة للجمع)</p>
                    </div>

                    <!-- Step 3 (Result) -->
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج</h4>
                        <p class="text-sm md:text-lg font-bold"><span class="math-eq">
                            <span class="num-red">٩</span><span class="var-green">س&zwnj;<sup>٤</sup></span><span class="var-blue">ص&zwnj;<sup>٢</sup></span>
                        </span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- تطبيق ٤.٢ (مركب - جديد) -->
            <div id="interactive-container-4-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٤-٢ (مركب): بسّط <span class="math-eq">(٢س&zwnj;<sup>٢</sup>)<sup>٣</sup> · س&zwnj;</span></h3>
                    <span class="text-[10px] md:text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">تحدي</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس</h4>
                        <p class="text-sm md:text-lg"><span class="math-eq">
                            <span class="fix-pos"><span class="num-red font-bold">٢</span><sup class="tiny-sup num-red">٣</sup></span>
                            <span class="fix-pos">(<span class="var-green font-bold">س&zwnj;</span><sup class="tiny-sup var-green">٢</sup>)<sup class="tiny-sup">٣</sup></span> 
                            · <span class="var-green font-bold">س&zwnj;</span>
                        </span></p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: فك القوى</h4>
                        <p class="text-sm md:text-lg">
                            <span class="num-red font-bold">٨</span> 
                            <span class="var-green font-bold">س&zwnj;<sup>٦</sup></span> · 
                            <span class="var-green font-bold">س&zwnj;</span>
                        </p>
                    </div>
                    <div class="step-interactive step-box">
                        <h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٣: ضرب المتغيرات (جمع الأسس)</h4>
                        <p class="text-sm md:text-lg">
                            <span class="num-red font-bold">٨</span> 
                            <span class="var-green font-bold">س&zwnj;<sup>٧</sup></span>
                        </p>
                        <p class="text-xs md:text-base text-gray-500 mt-1">(جمعنا أس ٦ مع أس ١)</p>
                    </div>
                    <div class="step-interactive step-box border-green-500 bg-green-50">
                        <h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج</h4>
                        <p class="text-sm md:text-lg font-bold"><span class="math-eq">٨س&zwnj;<sup>٧</sup></span></p>
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full bg-gray-200 text-gray-600 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4 md:w-6 md:h-6"></i></button>
                    <button class="next-btn px-6 py-1.5 md:py-2 md:px-8 bg-blue-600 text-white rounded-lg text-sm md:text-base font-bold shadow-md">التالي</button>
                    <button class="reset-btn px-6 py-1.5 md:py-2 md:px-8 bg-purple-100 text-purple-700 rounded-lg text-sm md:text-base font-bold hidden">إعادة</button>
                </div>
            </div>

            <div class="mt-4 text-center">
                <button onclick="switchTab('quiz')" class="bg-green-600 text-white px-8 py-3 md:py-4 rounded-full text-sm md:text-lg font-bold shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2 mx-auto w-full max-w-xs animate-bounce">
                    <span>جاهز للاختبار؟</span>
                    <i data-lucide="arrow-left" class="w-4 h-4 md:w-5 md:h-5"></i>
                </button>
            </div>
        </div>

        <!-- ======================= تبويب 5: الاختبار ======================= -->
        <div id="tab-quiz" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div>
                        <h2 class="font-bold text-lg md:text-2xl text-gray-800">اختبار الفهم</h2>
                        <p class="text-xs md:text-sm text-gray-500">٥ أسئلة مختارة عشوائياً</p>
                    </div>
                    <!-- عداد المحاولات الجديد -->
                    <div class="text-center">
                        <div id="attempts-display">
                            <span class="block text-xl md:text-2xl font-bold text-purple-600" id="attempts-count">3</span>
                            <span class="text-[10px] md:text-xs text-gray-400">محاولات</span>
                        </div>
                        <div id="attempts-timer" class="hidden">
                            <span class="block text-sm md:text-base font-bold text-red-500 font-mono" id="timer-display">00:00:00</span>
                            <span class="text-[10px] md:text-xs text-gray-400">للمحاولة القادمة</span>
                        </div>
                    </div>
                </div>
                
                <form id="quizForm" class="space-y-6"></form>
                
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <div id="score-icon-container" class="mb-2"></div>
                    <p class="text-sm text-gray-500">الدرجة النهائية</p>
                    <p id="quiz-score" class="text-4xl font-bold text-blue-600 my-2 tracking-widest">-</p>
                    <button id="retake-quiz-btn" class="mt-4 px-6 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 transition">إعادة الاختبار (أسئلة جديدة)</button>
                    <p id="cooldown-msg" class="text-xs text-red-500 mt-2 hidden">نفذت المحاولات! انتظر المؤقت أعلاه.</p>

                    <!-- ************** هنا تظهر الألعاب فقط بعد الانتهاء ************** -->
                    <!-- تم تحسين الشبكة (Grid) لتكون أكثر اتساعاً على الشاشات الكبيرة -->
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mt-8 pt-6 border-t border-gray-200">
                        <!-- سيتم تعبئة الألعاب هنا بواسطة الجافاسكربت -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- شريط التنقل السفلي -->
    <!-- تم إضافة container داخلي لضبط الأيقونات في الوسط وعدم تباعدها كثيراً -->
    <nav class="bottom-nav">
        <div class="container mx-auto max-w-4xl flex justify-around w-full">
            <div class="nav-item active" onclick="switchTab('learn1')" id="nav-learn1">
                <i data-lucide="book-open"></i>
                <span>تعلم ١</span>
            </div>
            <div class="nav-item" onclick="switchTab('learn2')" id="nav-learn2">
                <i data-lucide="zap"></i>
                <span>تعلم ٢</span>
            </div>
            <div class="nav-item" onclick="switchTab('learn3')" id="nav-learn3">
                <i data-lucide="minimize-2"></i>
                <span>تعلم ٣</span>
            </div>
            <div class="nav-item" onclick="switchTab('learn4')" id="nav-learn4">
                <i data-lucide="maximize"></i>
                <span>تعلم ٤</span>
            </div>
            <div class="nav-item" onclick="switchTab('quiz')" id="nav-quiz">
                <i data-lucide="clipboard-check"></i>
                <span>اختبر</span>
            </div>
        </div>
    </nav>

    <!-- Modal for Explanation -->
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 transform transition-transform duration-300 shadow-2xl">
            <div class="flex justify-between mb-4 items-center">
                <div class="flex items-center gap-2 text-blue-600">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <h3 id="modal-title" class="font-bold text-lg">توضيح</h3>
                </div>
                <button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- Platform Logic (Student ID & Links) ---
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId') || 'visitor';
        const classId = urlParams.get('classId') || 'visitor';
        const studentName = urlParams.get('name') || 'زائر';
        
        document.getElementById('student-name').textContent = studentName;

        // --- Dynamic Games Logic (Inside Quiz Results) ---
        // سيتم استدعاء هذه الدالة عند إنهاء الاختبار وعرض النتيجة
        function renderDynamicGames() {
            const container = document.getElementById('dynamic-games-container');
            container.innerHTML = ''; // مسح المحتوى القديم

            // بيانات الألعاب الافتراضية للدرس (في حال لم يتم تمريرها في الرابط)
            // لضمان عمل الدرس بشكل مستقل
            const defaultGames = [
                { title: 'لعبة المطابقة', id: 'g6_1_1' },
                { title: 'حرب الفضاء', id: 'g6_1_2' }
            ];

            let hasGames = false;

            for (let i = 1; i <= 2; i++) {
                // جلب البيانات من الرابط أو استخدام الافتراضي
                let title = urlParams.get(`g${i}_title`) || defaultGames[i-1].title;
                let id = urlParams.get(`g${i}_id`) || defaultGames[i-1].id;
                let score = parseInt(urlParams.get(`g${i}_score`)) || 0;
                let max = parseInt(urlParams.get(`g${i}_max`)) || 5;

                // محاكاة قراءة الدرجة المحلية (لغرض التجربة فقط)
                const localScore = localStorage.getItem(`${id}_score`);
                if (localScore) score = parseInt(localScore);

                if (title && id) {
                    hasGames = true;
                    let cardClass = "normal-card";
                    let iconHtml = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg shadow-sm" style="background-color: var(--theme-color)"><i class="fas fa-gamepad"></i></div>`;
                    let btnText = "العب الآن";
                    let statusText = "تطبيق تفاعلي";
                    let btnClass = "bg-gray-50 text-gray-600 group-hover:bg-gray-100";

                    if (score >= max && max > 0) {
                        cardClass = "gold-card";
                        iconHtml = `<div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-trophy"></i></div>`;
                        btnText = "لعبت بامتياز";
                        statusText = "أحسنت! (درجة كاملة)";
                        btnClass = "bg-yellow-50 text-yellow-700";
                    } else if (score > 0) {
                        cardClass = "orange-card";
                        iconHtml = `<div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-star"></i></div>`;
                        btnText = "حاول مرة أخرى";
                        statusText = `نتيجتك: ${score}/${max}`;
                        btnClass = "bg-orange-50 text-orange-700";
                    }

                    const gameHtml = `
                    <a href="https://ablan-math.github.io/games/${id}.html?studentId=${studentId}&classId=${classId}" target="_blank" onclick="simulateGame('${id}')" class="block group relative overflow-hidden rounded-xl p-4 hover:shadow-md transition-all duration-300 ${cardClass} no-underline">
                        <div class="flex items-center gap-3">
                            ${iconHtml}
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm">${title}</h3>
                                <p class="text-[10px] text-gray-500 font-bold">${statusText}</p>
                            </div>
                            <div class="mr-auto">
                                <span class="${btnClass} text-[10px] font-bold px-3 py-1 rounded-full transition">${btnText}</span>
                            </div>
                        </div>
                    </a>`;
                    container.insertAdjacentHTML('beforeend', gameHtml);
                }
            }
            
            // إضافة عنوان للألعاب إذا وجدت
            if(hasGames && !document.getElementById('games-title')) {
                 const titleHTML = `
                 <h2 id="games-title" class="col-span-1 md:col-span-2 text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full">
                    <i class="fas fa-gamepad text-yellow-500"></i> استمتع وتعلم
                </h2>`;
                container.insertAdjacentHTML('afterbegin', titleHTML);
            }
        }
        
        function goBack(e) {
            e.preventDefault();
            try { 
                window.parent.postMessage('closeLesson', '*'); 
            } catch(e) {
                window.location.href = '/';
            }
        }

        // --- Tabs Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const tabEl = document.getElementById(`tab-${tabId}`);
            const navEl = document.getElementById(`nav-${tabId}`);
            
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            
            window.scrollTo(0,0);
            
            if(tabId === 'quiz' && document.getElementById('quizForm').innerHTML === '') {
                generateQuiz();
            }
        }

        // --- Interactive Logic ---
        document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
            const steps = container.querySelectorAll('.step-interactive');
            const placeholder = container.querySelector('.interactive-placeholder');
            const nextBtn = container.querySelector('.next-btn');
            const prevBtn = container.querySelector('.prev-btn');
            const resetBtn = container.querySelector('.reset-btn');
            let current = -1;

            const update = () => {
                prevBtn.disabled = current === -1;
                if (current === -1) placeholder.classList.remove('hidden'); else placeholder.classList.add('hidden');
                
                steps.forEach((s, i) => {
                    if (i <= current) s.classList.add('active'); else s.classList.remove('active');
                });

                if (current >= steps.length - 1) {
                    nextBtn.classList.add('hidden');
                    resetBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    resetBtn.classList.add('hidden');
                }
            };

            nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
            prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
            resetBtn.onclick = () => { current = -1; update(); };
            update();
        });

        // --- Question Bank & Quiz Logic ---
        const questionBank = [
            // --- Type 1: Monomials (Learn 1) ---
            { 
                id: 101, type: 'learn1', t: 'هل <span class="math-eq">٥س&zwnj;</span> وحيدة حد؟', 
                o: [
                    {t:'نعم', v:'a'}, 
                    {t:'لا', v:'b', msg:'تذكر: ضرب عدد في متغير يعتبر وحيدة حد.'}
                ], 
                c:'a', e:'<strong>نعم</strong>، لأنها حاصل ضرب عدد في متغير ولا يوجد جمع أو طرح.', link:'learn1' 
            },
            { 
                id: 103, type: 'learn1', t: 'أي العبارات التالية تعتبر وحيدة حد؟', 
                o: [
                    {t:'<span class="math-eq">ن&zwnj; - ٢</span>', v:'a', msg:'خطأ: وجود علامة الطرح يمنعها.'},
                    {t:'<span class="fraction"><span>٥</span><span class="bar"></span><span>س&zwnj;</span></span>', v:'b', msg:'خطأ: القسمة على متغير تعني وجوده في المقام.'},
                    {t:'<span class="math-eq">س&zwnj; + ص</span>', v:'c', msg:'خطأ: وجود علامة الجمع يمنعها.'},
                    {t:'<span class="math-eq">١٢</span>', v:'d'}
                ], 
                c:'d', e:'<strong>١٢</strong> هو عدد ثابت، وكل عدد ثابت يعتبر وحيدة حد.', link:'learn1' 
            },
            { 
                id: 104, type: 'learn1', t: 'هل <span class="fraction"><span>٥</span><span class="bar"></span><span>س&zwnj;</span></span> وحيدة حد؟', 
                o: [
                    {t:'نعم', v:'a', msg:'انتبه: المتغير (س) موجود في المقام، وهذا ممنوع.'}, 
                    {t:'لا', v:'b'}
                ], 
                c:'b', e:'<strong>لا</strong>، القسمة على متغير (س في المقام) تمنع كونها وحيدة حد.', link:'learn1' 
            },
            { 
                id: 106, type: 'learn1', t: 'أي العبارات ليست وحيدة حد؟', 
                o: [
                    {t:'<span class="math-eq">س&zwnj;<sup>٣</sup></span>', v:'a', msg:'هذه وحيدة حد صحيحة (متغير بأس موجب).'},
                    {t:'<span class="math-eq">٧</span>', v:'b', msg:'هذه وحيدة حد (عدد ثابت).'},
                    {t:'<span class="math-eq">٣س&zwnj; + ١</span>', v:'c'},
                    {t:'<span class="math-eq">-٤أ</span>', v:'d', msg:'هذه وحيدة حد (ضرب عدد في متغير).'}
                ], 
                c:'c', e:'<strong>٣س + ١</strong> ليست وحيدة حد لوجود علامة الجمع.', link:'learn1' 
            },

            // --- Type 2: Product of Powers (Learn 2) ---
            { 
                id: 201, type: 'learn2', t: 'ناتج <span class="math-eq">س&zwnj;<sup>٤</sup> · س&zwnj;<sup>٣</sup></span>', 
                o: [
                    {t:'<span class="math-eq">س&zwnj;<sup>٧</sup></span>', v:'a'},
                    {t:'<span class="math-eq">س&zwnj;<sup>١٢</sup></span>', v:'b', msg:'لقد ضربت الأسس (٤ × ٣) والقاعدة هي الجمع.'},
                    {t:'<span class="math-eq">٢س&zwnj;<sup>٧</sup></span>', v:'c', msg:'لا يوجد معامل (عدد) لتجمعه.'},
                    {t:'<span class="math-eq">س&zwnj;</span>', v:'d', msg:'هل قمت بالطرح؟ القاعدة هي جمع الأسس.'}
                ], 
                c:'a', 
                e:`<div class="text-right">
                      <p class="mb-1 font-bold text-gray-700">القاعدة: عند الضرب نجمع الأسس.</p>
                      <p class="text-center mb-1 text-lg"><span class="math-eq">س&zwnj;<sup><span class="text-green-600">٤</span></sup> · س&zwnj;<sup><span class="text-green-600">٣</span></sup></span></p>
                      <p class="text-center mb-1">الأس الجديد = <span class="text-green-600">٤</span> + <span class="text-green-600">٣</span> = <span class="text-green-600 font-bold">٧</span></p>
                      <p class="text-center font-bold text-blue-600 mt-2">الناتج: س&zwnj;<sup>٧</sup></p>
                    </div>`, 
                link:'learn2' 
            },
            { 
                id: 202, type: 'learn2', t: 'بسّط <span class="math-eq">(٢أ)(٣أ)</span>', 
                o: [
                    {t:'<span class="math-eq">٥أ</span>', v:'a', msg:'لقد جمعت المعاملات (٢+٣) بدلاً من ضربها.'},
                    {t:'<span class="math-eq">٦أ</span>', v:'b', msg:'لقد نسيت جمع أسس المتغير (أ).'},
                    {t:'<span class="math-eq">٥أ<sup>٢</sup></span>', v:'c', msg:'جمعت المعاملات (خطأ) وجمعت الأسس (صح). اضرب المعاملات!'},
                    {t:'<span class="math-eq">٦أ<sup>٢</sup></span>', v:'d'}
                ], 
                c:'d', 
                e:`<div class="text-right text-sm">
                      <ol class="list-decimal list-inside space-y-2">
                        <li>نضرب المعاملات (الأرقام): <span class="num-red font-bold">٢ × ٣ = ٦</span></li>
                        <li>نضرب المتغيرات (بجمع الأسس): <span class="var-green font-bold">أ<sup>١</sup> · أ<sup>١</sup> = أ<sup>٢</sup></span></li>
                      </ol>
                      <p class="text-center font-bold text-blue-600 mt-2 border-t pt-1">الناتج: ٦أ<sup>٢</sup></p>
                    </div>`, 
                link:'learn2' 
            },
            { 
                id: 203, type: 'learn2', t: 'ناتج <span class="math-eq">ن&zwnj; · ن&zwnj;<sup>٥</sup></span>', 
                o: [
                    {t:'<span class="math-eq">ن&zwnj;<sup>٦</sup></span>', v:'a'},
                    {t:'<span class="math-eq">ن&zwnj;<sup>٥</sup></span>', v:'b', msg:'نسيت أن (ن) الأولى لها أس مقداره ١.'},
                    {t:'<span class="math-eq">٢ن&zwnj;<sup>٥</sup></span>', v:'c', msg:'لا يوجد معامل ٢ لتضيفه.'},
                    {t:'<span class="math-eq">ن&zwnj;<sup>٤</sup></span>', v:'d', msg:'القاعدة هي الجمع وليست الطرح.'}
                ], 
                c:'a', 
                e:`<div class="text-right text-sm">
                      <p class="mb-1 text-gray-700">تذكر: <span class="math-eq">ن&zwnj;</span> تعني <span class="math-eq">ن&zwnj;<sup>١</sup></span></p>
                      <p class="text-center">نجمع الأسس: <span class="text-green-600 font-bold">١ + ٥ = ٦</span></p>
                      <p class="text-center font-bold text-blue-600 mt-1">الناتج: ن&zwnj;<sup>٦</sup></p>
                    </div>`, 
                link:'learn2' 
            },
            { 
                id: 205, type: 'learn2', t: 'حل <span class="math-eq">(٥)(٣س&zwnj;<sup>٢</sup>)</span>', 
                o: [
                    {t:'<span class="math-eq">٨س&zwnj;<sup>٢</sup></span>', v:'a', msg:'خطأ شائع: جمعت الأرقام (٥+٣) بدل ضربها.'},
                    {t:'<span class="math-eq">١٥س&zwnj;<sup>٢</sup></span>', v:'b'},
                    {t:'<span class="math-eq">١٥س&zwnj;</span>', v:'c', msg:'أين ذهب الأس؟ لا تحذفه.'},
                    {t:'<span class="math-eq">٥٣س&zwnj;<sup>٢</sup></span>', v:'d', msg:'وضعت الأرقام بجانب بعضها بدل ضربها.'}
                ], 
                c:'b', e:'نضرب العدد في المعامل: <span class="num-red font-bold">٥ × ٣ = ١٥</span>. ويبقى المتغير كما هو.', link:'learn2' 
            },

            // --- Type 3: Power of Power (Learn 3) ---
            { 
                id: 301, type: 'learn3', t: 'ناتج <span class="math-eq">(ب&zwnj;<sup>٣</sup>)<sup>٥</sup></span>', 
                o: [
                    {t:'<span class="math-eq">ب&zwnj;<sup>٨</sup></span>', v:'a', msg:'جمعت الأسس (٣+٥)! القاعدة هنا هي ضرب الأسس.'},
                    {t:'<span class="math-eq">ب&zwnj;<sup>١٥</sup></span>', v:'b'},
                    {t:'<span class="math-eq">ب&zwnj;<sup>٢</sup></span>', v:'c', msg:'طرحت الأسس (٥-٣)! اضرب الأسس.'},
                    {t:'<span class="math-eq">٣ب&zwnj;<sup>٥</sup></span>', v:'d', msg:'نزلت الأس كرقم! اضرب الأسس ببعضها.'}
                ], 
                c:'b', 
                e:`<div class="text-right">
                      <p class="mb-1 font-bold text-gray-700">قوة القوة: نضرب الأسس</p>
                      <p class="text-center mb-1 text-lg"><span class="math-eq">٣ × ٥ = ١٥</span></p>
                      <p class="text-center font-bold text-blue-600 mt-2">الناتج: ب&zwnj;<sup>١٥</sup></p>
                    </div>`, 
                link:'learn3' 
            },
            { 
                id: 302, type: 'learn3', t: 'بسّط <span class="math-eq"><span class="fix-pos">(٢<sup class="tiny-sup">٢</sup>)</span><sup class="tiny-sup">٢</sup></span>', 
                o: [
                    {t:'<span class="math-eq">٨</span>', v:'a', msg:'خطأ في الحساب.'},
                    {t:'<span class="math-eq">١٦</span>', v:'b'},
                    {t:'<span class="math-eq">٤</span>', v:'c', msg:'نسيت الأس الخارجي.'},
                    {t:'<span class="math-eq">٢</span>', v:'d', msg:'خطأ.'}
                ], 
                c:'b', 
                e:`<div class="text-right">
                      <p class="text-center mb-1">نضرب الأسس: ٢×٢ = ٤</p>
                      <p class="text-center mb-1">الأساس ٢ أس ٤</p>
                      <p class="text-center font-bold text-blue-600 mt-2"><span class="num-red font-bold">٢×٢×٢×٢ = ١٦</span></p>
                    </div>`, 
                link:'learn3' 
            },

            // --- Type 4: Power of Product (Learn 4) ---
            { 
                id: 401, type: 'learn4', t: 'ناتج <span class="math-eq">(٣س&zwnj;<sup>٣</sup>)<sup>٢</sup></span>', 
                o: [
                    {t:'<span class="math-eq">٣س&zwnj;<sup>٦</sup></span>', v:'a', msg:'نسيت تربيع المعامل (٣).'},
                    {t:'<span class="math-eq">٩س&zwnj;<sup>٥</sup></span>', v:'b', msg:'جمعت الأسس (٣+٢) بدل الضرب.'},
                    {t:'<span class="math-eq">٩س&zwnj;<sup>٦</sup></span>', v:'c'},
                    {t:'<span class="math-eq">٦س&zwnj;<sup>٦</sup></span>', v:'d', msg:'ضربت المعامل في الأس (٣×٢) بدل التربيعه (٣×٣).'}
                ], 
                c:'c', 
                e:`<div class="text-right text-sm">
                      <ol class="list-decimal list-inside space-y-2">
                        <li>نربع المعامل: <span class="num-red font-bold">٣<sup>٢</sup> = ٩</span></li>
                        <li>نضرب الأسس للمتغير: <span class="var-green font-bold">٣ × ٢ = ٦</span></li>
                      </ol>
                      <p class="text-center font-bold text-blue-600 mt-2">الناتج: ٩س&zwnj;<sup>٦</sup></p>
                    </div>`, 
                link:'learn4' 
            },
            { 
                id: 402, type: 'learn4', t: 'بسّط <span class="math-eq">(-٢ ص&zwnj;)<sup>٣</sup></span>', 
                o: [
                    {t:'<span class="math-eq">-٨ص&zwnj;<sup>٣</sup></span>', v:'a'},
                    {t:'<span class="math-eq">٨ص&zwnj;<sup>٣</sup></span>', v:'b', msg:'الأس الفردي (٣) يحافظ على الإشارة السالبة.'},
                    {t:'<span class="math-eq">-٦ص&zwnj;<sup>٣</sup></span>', v:'c', msg:'ضربت ٢×٣ بدل التكعيب (٢×٢×٢).'},
                    {t:'<span class="math-eq">-٢ص&zwnj;<sup>٣</sup></span>', v:'d', msg:'نسيت تكعيب المعامل -٢.'}
                ], 
                c:'a', 
                e:`<div class="text-right">
                      <p class="text-center mb-1">كعب العدد -٢: <span class="num-red font-bold">-٨</span></p>
                      <p class="text-center mb-1">كعب المتغير ص: <span class="var-blue font-bold">ص<sup>٣</sup></span></p>
                      <p class="text-center font-bold text-blue-600 mt-2">الناتج: -٨ص&zwnj;<sup>٣</sup></p>
                    </div>`, 
                link:'learn4' 
            },
            
            // --- New Complex Question (Step 3) ---
            { 
                id: 403, type: 'learn4', t: 'بسّط <span class="math-eq">(٢س&zwnj;<sup>٢</sup>)<sup>٣</sup> · س&zwnj;</span>', 
                o: [
                    {t:'<span class="math-eq">٨س&zwnj;<sup>٧</sup></span>', v:'a'},
                    {t:'<span class="math-eq">٦س&zwnj;<sup>٧</sup></span>', v:'b', msg:'ضربت ٢×٣ بدل التكعيب.'},
                    {t:'<span class="math-eq">٨س&zwnj;<sup>٦</sup></span>', v:'c', msg:'نسيت ضرب س الأخيرة (جمع أسها ١).'},
                    {t:'<span class="math-eq">٨س&zwnj;<sup>٥</sup></span>', v:'d', msg:'خطأ في جمع الأسس.'}
                ], 
                c:'a', 
                e:`<div class="text-right text-sm">
                      <ol class="list-decimal list-inside space-y-2">
                        <li>فك القوة: <span class="num-red font-bold"><span class="fix-pos">٢<sup class="tiny-sup">٣</sup></span>=٨</span> و <span class="var-green font-bold">(س<sup>٢</sup>)<sup>٣</sup>=س<sup>٦</sup></span></li>
                        <li>أصبحت: ٨س<sup>٦</sup> · س</li>
                        <li>ضرب المتشابهات (جمع الأسس): <span class="var-green font-bold">٦ + ١ = ٧</span></li>
                      </ol>
                      <p class="text-center font-bold text-blue-600 mt-2">الناتج: ٨س&zwnj;<sup>٧</sup></p>
                    </div>`, 
                link:'learn4' 
            },

            // --- Mixed ---
            { id: 501, type: 'mixed', t: 'مساحة مستطيل طوله <span class="math-eq">٢س&zwnj;<sup>٢</sup></span> وعرضه <span class="math-eq">٣س&zwnj;<sup>٣</sup></span>', o: [{t:'<span class="math-eq">٥س&zwnj;<sup>٥</sup></span>', v:'a', msg:'حسبت المحيط تقريباً (جمعت)! المساحة ضرب.'}, {t:'<span class="math-eq">٦س&zwnj;<sup>٦</sup></span>', v:'b', msg:'ضربت الأرقام (صح) ولكن ضربت الأسس (خطأ). نجمع الأسس.'}, {t:'<span class="math-eq">٦س&zwnj;<sup>٥</sup></span>', v:'c'}, {t:'<span class="math-eq">٥س&zwnj;<sup>٦</sup></span>', v:'d', msg:'جمعت الأرقام (خطأ) وضربت الأسس (خطأ).'}], c:'c', e:`<div class="text-right text-sm"><p class="mb-2 font-bold text-gray-700">القانون: المساحة = الطول × العرض</p><div class="mb-2 text-center bg-gray-50 p-2 rounded border"><span class="math-eq text-lg">(<span class="num-red">٢</span><span class="var-green">س&zwnj;<sup>٢</sup></span>) (<span class="num-red">٣</span><span class="var-green">س&zwnj;<sup>٣</sup></span>)</span></div><ol class="list-decimal list-inside space-y-2"><li><span class="font-bold text-gray-600">الأرقام:</span> نضرب <span class="num-red font-bold">٢ × ٣ = ٦</span></li><li><span class="font-bold text-gray-600">المتغيرات:</span> نجمع الأسس <span class="var-green font-bold">س&zwnj;<sup>٢+٣</sup> = س&zwnj;<sup>٥</sup></span></li></ol><div class="mt-3 text-center border-t pt-2"><span class="font-bold text-blue-600 text-lg">النتيجة: ٦س&zwnj;<sup>٥</sup></span></div></div>`, link:'learn2' },
            { id: 502, type: 'mixed', t: 'حجم مكعب طول ضلعه <span class="math-eq">س&zwnj;</span>', o: [{t:'<span class="math-eq">٣س&zwnj;</span>', v:'a', msg:'هذا محيط مثلث! الحجم ضرب الضلع في نفسه 3 مرات.'}, {t:'<span class="math-eq">س&zwnj;<sup>٣</sup></span>', v:'b'}, {t:'<span class="math-eq">س&zwnj;<sup>٢</sup></span>', v:'c', msg:'هذه مساحة مربع، وليست حجم مكعب.'}, {t:'<span class="math-eq">س&zwnj;+٣</span>', v:'d', msg:'الحجم ضرب وليس جمع.'}], c:'b', e:`<div class="text-right text-sm"><p class="mb-2 font-bold text-gray-700">القانون: الحجم = الضلع × الضلع × الضلع</p><p class="text-center mb-2"><span class="math-eq">س&zwnj;<sup>١</sup> · س&zwnj;<sup>١</sup> · س&zwnj;<sup>١</sup></span></p><p class="text-center">نجمع الأسس: <span class="var-green font-bold">١ + ١ + ١ = ٣</span></p><div class="mt-2 text-center border-t pt-1"><span class="font-bold text-blue-600">النتيجة: س&zwnj;<sup>٣</sup></span></div></div>`, link:'learn2' }
        ];

        let currentQuestions = [];
        
        // --- ATTEMPTS SYSTEM VARIABLES & LOGIC ---
        const ATTEMPTS_KEY = 'quiz_attempts_left';
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_time';
        const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours
        let attemptsLeft = 3;
        let timerInterval;

        function initAttempts() {
            const storedAttempts = localStorage.getItem(ATTEMPTS_KEY);
            const storedTime = localStorage.getItem(NEXT_ATTEMPT_KEY);
            const now = Date.now();

            if (storedAttempts === null) {
                attemptsLeft = 3;
                localStorage.setItem(ATTEMPTS_KEY, 3);
            } else {
                attemptsLeft = parseInt(storedAttempts);
            }

            if (attemptsLeft === 0 && storedTime) {
                const nextTime = parseInt(storedTime);
                if (now >= nextTime) {
                    attemptsLeft = 1;
                    localStorage.setItem(ATTEMPTS_KEY, 1);
                    localStorage.removeItem(NEXT_ATTEMPT_KEY);
                } else {
                    startTimer(nextTime);
                }
            }
            updateAttemptsUI();
        }

        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            const displayEl = document.getElementById('attempts-display');
            const timerEl = document.getElementById('attempts-timer');
            const quizForm = document.getElementById('quizForm');
            const retakeBtn = document.getElementById('retake-quiz-btn');
            const cooldownMsg = document.getElementById('cooldown-msg');

            countEl.textContent = convertToArabic(attemptsLeft);

            if (attemptsLeft > 0) {
                displayEl.classList.remove('hidden');
                timerEl.classList.add('hidden');
                if(cooldownMsg) cooldownMsg.classList.add('hidden');
                if(retakeBtn) {
                    retakeBtn.disabled = false;
                    retakeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    retakeBtn.textContent = 'إعادة الاختبار (أسئلة جديدة)';
                }
            } else {
                displayEl.classList.add('hidden');
                timerEl.classList.remove('hidden');
                if(cooldownMsg) cooldownMsg.classList.remove('hidden');
                if(retakeBtn) {
                    retakeBtn.disabled = true;
                    retakeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    retakeBtn.textContent = 'انتظر المؤقت...';
                }
            }
        }

        function startTimer(targetTime) {
            clearInterval(timerInterval);
            
            const tick = () => {
                const now = Date.now();
                const diff = targetTime - now;

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    attemptsLeft = 1;
                    localStorage.setItem(ATTEMPTS_KEY, 1);
                    localStorage.removeItem(NEXT_ATTEMPT_KEY);
                    updateAttemptsUI();
                    return;
                }

                const hours = Math.floor((diff / (1000 * 60 * 60)));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                const pad = (n) => n.toString().padStart(2, '0');
                const timeString = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
                document.getElementById('timer-display').textContent = convertToArabicStr(timeString);
            };

            tick();
            timerInterval = setInterval(tick, 1000);
        }

        function useAttempt() {
            if (attemptsLeft > 0) {
                attemptsLeft--;
                localStorage.setItem(ATTEMPTS_KEY, attemptsLeft);
                
                if (attemptsLeft === 0) {
                    const nextTime = Date.now() + COOLDOWN_MS;
                    localStorage.setItem(NEXT_ATTEMPT_KEY, nextTime);
                    startTimer(nextTime);
                }
                updateAttemptsUI();
                return true;
            }
            return false;
        }

        function convertToArabicStr(str) {
            return str.replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);
        }

        function generateQuiz() {
            const type1 = questionBank.filter(q => q.type === 'learn1');
            const type2 = questionBank.filter(q => q.type === 'learn2');
            const type3 = questionBank.filter(q => q.type === 'learn3');
            const type4 = questionBank.filter(q => q.type === 'learn4');
            const typeMixed = questionBank.filter(q => q.type === 'mixed');

            const selected = [
                ...shuffleArray(type1).slice(0, 1),
                ...shuffleArray(type2).slice(0, 1),
                ...shuffleArray(type3).slice(0, 1),
                ...shuffleArray(type4).slice(0, 1),
                ...shuffleArray(typeMixed).slice(0, 1)
            ];

            currentQuestions = shuffleArray(selected);
            renderQuiz();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderQuiz() {
            const quizForm = document.getElementById('quizForm');
            let quizHTML = '';
            
            currentQuestions.forEach((q, i) => {
                let typeLabel = '';
                if(q.type === 'learn1') typeLabel = 'تعلم ١';
                else if(q.type === 'learn2') typeLabel = 'تعلم ٢';
                else if(q.type === 'learn3') typeLabel = 'تعلم ٣';
                else if(q.type === 'learn4') typeLabel = 'تعلم ٤';
                else typeLabel = 'تطبيق';
                let gridClass = q.o.length > 2 ? 'options-grid' : 'options-grid single-col';

                quizHTML += `
                <div class="border border-gray-200 rounded-xl p-4 md:p-6 hover:border-blue-200 transition bg-white mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <p class="font-bold text-gray-800 text-sm md:text-lg flex-grow leading-6"><span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs md:text-sm ml-2">سؤال ${convertToArabic(i+1)}</span> ${q.t}</p>
                        <span class="text-[10px] md:text-xs text-gray-400 border px-1 rounded bg-gray-50 mr-2 whitespace-nowrap">${typeLabel}</span>
                    </div>
                    <div class="${gridClass}">
                        ${q.o.map((opt, oi) => `
                            <div>
                                <input type="radio" name="q${i}" id="q${i}o${oi}" value="${opt.v}" class="hidden">
                                <label for="q${i}o${oi}" class="option-label text-sm md:text-base select-none shadow-sm">${opt.t}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div id="feedback-${i}" class="text-xs md:text-base font-bold mt-3 hidden p-3 rounded-lg"></div>
                    
                    <div id="actions-${i}" class="hidden mt-3 flex gap-2">
                         <button type="button" onclick="showExplain(${i})" class="text-xs md:text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 flex items-center gap-1 transition">
                            <i data-lucide="help-circle" class="w-3 h-3 md:w-4 md:h-4"></i> لماذا؟
                        </button>
                        <button type="button" onclick="goToLearn('${q.link}')" class="text-xs md:text-sm bg-red-50 text-red-600 px-3 py-2 rounded-lg hover:bg-red-100 flex items-center gap-1 transition">
                            <i data-lucide="book-open" class="w-3 h-3 md:w-4 md:h-4"></i> راجع الدرس
                        </button>
                    </div>
                </div>`;
            });
            
            if (attemptsLeft > 0) {
                quizHTML += '<button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 md:py-4 rounded-xl text-sm md:text-lg shadow-lg hover:bg-blue-700 transition transform active:scale-95 mb-4">تحقق من الإجابات</button>';
            } else {
                quizHTML += '<div class="text-center p-3 bg-gray-100 rounded-xl text-gray-500 text-sm md:text-base font-bold">لا توجد محاولات متبقية. انتظر الوقت المحدد.</div>';
            }
            
            quizForm.innerHTML = quizHTML;
            lucide.createIcons();
            quizForm.onsubmit = handleQuizSubmit;
        }

        function handleQuizSubmit(e) {
            e.preventDefault();
            
            if (attemptsLeft <= 0) return;

            useAttempt();

            let score = 0;
            const quizForm = e.target;

            currentQuestions.forEach((q, i) => {
                const selectedInput = quizForm.querySelector(`input[name="q${i}"]:checked`);
                const feedback = document.getElementById(`feedback-${i}`);
                const actionsDiv = document.getElementById(`actions-${i}`);
                
                if (selectedInput) {
                    const selectedVal = selectedInput.value;
                    const selectedOptionData = q.o.find(opt => opt.v === selectedVal);

                    if (selectedVal === q.c) {
                        score++;
                        feedback.textContent = '✔ إجابة صحيحة! أحسنت.';
                        feedback.className = 'text-xs font-bold mt-3 text-green-700 bg-green-50 block p-3 rounded-lg border border-green-100';
                        actionsDiv.classList.add('hidden');
                    } else {
                        const specificError = selectedOptionData.msg ? ` ${selectedOptionData.msg}` : '';
                        feedback.textContent = `❌ إجابة خاطئة. ${specificError}`;
                        feedback.className = 'text-xs font-bold mt-3 text-red-700 bg-red-50 block p-3 rounded-lg border border-red-100 error-hint';
                        actionsDiv.classList.remove('hidden');
                    }
                } else {
                    feedback.textContent = '⚠️ لم تختر إجابة.';
                    feedback.className = 'text-xs font-bold mt-3 text-yellow-700 bg-yellow-50 block p-3 rounded-lg';
                }
            });
            
            const resultsDiv = document.getElementById('quiz-results');
            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            document.getElementById('quiz-score').textContent = `${convertToArabic(score)} / ${convertToArabic(currentQuestions.length)}`;
            
            const iconContainer = document.getElementById('score-icon-container');
            if(score === currentQuestions.length) {
                iconContainer.innerHTML = '<i class="fas fa-award w-12 h-12 text-5xl text-yellow-500 mx-auto block mb-2"></i>';
            } else if (score > 0) {
                iconContainer.innerHTML = '<i class="fas fa-thumbs-up w-12 h-12 text-5xl text-blue-500 mx-auto block mb-2"></i>';
            } else {
                iconContainer.innerHTML = '<i class="fas fa-sync w-12 h-12 text-5xl text-gray-400 mx-auto block mb-2"></i>';
            }
            lucide.createIcons();

            // Disable current form inputs
            const inputs = quizForm.querySelectorAll('input');
            inputs.forEach(input => input.disabled = true);
            const submitBtn = quizForm.querySelector('button[type="submit"]');
            if(submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // ************ تشغيل الألعاب الديناميكية الآن ************
            renderDynamicGames();
        }

        function goToLearn(tabId) {
            switchTab(tabId);
        }

        document.getElementById('retake-quiz-btn').onclick = () => {
            if (attemptsLeft > 0) {
                document.getElementById('quiz-results').classList.add('hidden');
                generateQuiz();
                window.scrollTo(0,0);
            }
        };

        // --- Utils ---
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]); }
        function showExplain(index) {
            const explanation = currentQuestions[index].e;
            document.getElementById('modal-content').innerHTML = explanation;
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        function simulateGame(id) {
            // محاكاة فقط (لن تؤثر في الإنتاج الحقيقي)
             if(!localStorage.getItem(id+'_score')) {
                // localStorage.setItem(id+'_score', Math.floor(Math.random() * 2) + 4);
            }
        }
        
        // Initial Logic
        initAttempts();
        generateQuiz();
    </script>
</body>
</html>

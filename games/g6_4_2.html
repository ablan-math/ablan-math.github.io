<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø­ØµÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - G6_4_2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --gold: #d4af37;
            --dark-brown: #1a120b; 
            --light-gold: #f3e5ab;
            --accent-gold: #ffd700;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            overflow: hidden; 
            touch-action: manipulation; 
            direction: rtl; 
            background-color: #0c0a09;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        
        .compact-card {
            width: 100%; height: 100%; max-width: 450px; max-height: 900px;
            background: var(--dark-brown); box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
            border: 2px solid var(--gold); display: flex; flex-direction: column; 
            position: relative; color: var(--light-gold); overflow: hidden;
        }

        @media (min-width: 640px) { .compact-card { height: 95vh; border-radius: 2.5rem; } }

        .top-info-bar {
            background: rgba(45, 34, 23, 1); border-bottom: 2px solid var(--gold); 
            padding: 1vh 4vw; display: flex; justify-content: space-between; 
            align-items: center; height: 7vh; min-height: 50px; z-index: 10;
        }

        .btn-gold {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #1a120b; font-weight: 800; border: 1px solid #5d4037;
            border-radius: 1rem; transition: all 0.2s; cursor: pointer;
            display: flex; align-items: center; justify-content: center; 
            height: 7vh; max-height: 60px; font-size: clamp(0.7rem, 2vh, 0.9rem); width: 100%;
            padding: 0 5px; text-align: center; position: relative;
        }
        .btn-gold:active { transform: scale(0.96); filter: brightness(1.2); }

        /* Ø§Ù„Ø£Ø³ ÙÙˆÙ‚ Ø§Ù„Ø³ÙŠÙ† ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØ¶ÙˆØ­ */
        .exponent { 
            display: inline-block;
            font-size: 0.6em;
            font-weight: 900; 
            color: #000 !important;
            background: var(--gold);
            padding: 0px 3px;
            border-radius: 2px;
            line-height: 1.1;
            position: relative;
            top: -0.85em;
            margin-right: -2px;
            pointer-events: none;
        }

        .math-box { 
            background: rgba(0, 0, 0, 0.75); border: 2px solid var(--gold); 
            border-radius: 1.5rem; display: flex; align-items: center;
            justify-content: center; flex-grow: 1; margin: 1vh 0; padding: 1vh 2vw;
            overflow: hidden;
            box-shadow: inset 0 0 25px rgba(0,0,0,0.6);
            position: relative;
        }

        .screen-container {
            display: flex; flex-direction: column; height: 93vh; 
            padding: 2vh 4vw; justify-content: space-between;
        }

        .math-content-wrapper {
            width: 100%;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 5px; 
        }

        .math-unit {
            display: inline-block; 
            white-space: nowrap;
            font-size: clamp(0.8rem, 4.2vw, 1.4rem); 
            font-weight: 900;
            color: var(--gold);
            line-height: 2.8; 
        }

        .math-operator {
            font-size: 1.1em;
            color: var(--accent-gold);
            font-weight: 900;
        }

        .door-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .door-solved {
            cursor: default !important;
            pointer-events: none;
            filter: brightness(0.7);
        }

        #leaderboard-modal {
            background-color: #1a120b; 
            z-index: 100;
            border: 2px solid var(--gold);
            box-shadow: 0 0 100px rgba(0,0,0,1);
        }

        .tab-btn {
            transition: 0.3s;
            background: rgba(0,0,0,0.4);
            color: var(--gold);
            border: 1px solid var(--gold);
        }
        .tab-btn.active {
            background: var(--gold);
            color: #1a120b;
            font-weight: 900;
        }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        svg text { font-family: 'Cairo', sans-serif; pointer-events: none; }
    </style>
</head>
<body>

    <div class="compact-card">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-gold text-[10px]"></i>
                <span id="top-student-name" class="truncate font-black text-[clamp(10px,2vh,14px)]">...</span>
            </div>
            <div class="flex items-center gap-2 bg-black/50 px-3 py-1 rounded-full border border-gold/30">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync animate-spin text-gold text-[10px]"></i></span>
                <i class="fas fa-star text-gold text-[10px]"></i>
                <span id="top-points-display" class="text-[clamp(10px,1.8vh,14px)] font-bold">Ù .Ù  / Ù¥</span>
            </div>
        </div>

        <div id="start-screen" class="screen-container">
            <div class="svg-container flex-grow flex items-center justify-center">
                <svg viewBox="0 0 200 180" fill="none" class="h-48 w-auto filter drop-shadow-2xl">
                    <ellipse cx="100" cy="160" rx="70" ry="10" fill="black" fill-opacity="0.3"/>
                    <rect x="50" y="80" width="100" height="70" fill="#4b3621" stroke="#d4af37" stroke-width="2"/>
                    <rect x="55" y="70" width="15" height="10" fill="#4b3621" stroke="#d4af37" stroke-width="2"/>
                    <rect x="80" y="70" width="15" height="10" fill="#4b3621" stroke="#d4af37" stroke-width="2"/>
                    <rect x="105" y="70" width="15" height="10" fill="#4b3621" stroke="#d4af37" stroke-width="2"/>
                    <rect x="130" y="70" width="15" height="10" fill="#4b3621" stroke="#d4af37" stroke-width="2"/>
                    <path d="M85 150 V115 Q100 100 115 115 V150 Z" fill="#2d1e12" stroke="#d4af37" stroke-width="2"/>
                    <circle cx="110" cy="130" r="2" fill="#d4af37"/>
                    <rect x="25" y="50" width="35" height="100" fill="#3d2b1f" stroke="#d4af37" stroke-width="2"/>
                    <path d="M25 50 L42.5 25 L60 50 H25Z" fill="#b8860b" stroke="#d4af37" stroke-width="2"/>
                    <rect x="35" y="70" width="5" height="10" fill="#1a120b"/>
                    <rect x="45" y="70" width="5" height="10" fill="#1a120b"/>
                    <rect x="140" y="50" width="35" height="100" fill="#3d2b1f" stroke="#d4af37" stroke-width="2"/>
                    <path d="M140 50 L157.5 25 L175 50 H140Z" fill="#b8860b" stroke="#d4af37" stroke-width="2"/>
                    <rect x="150" y="70" width="5" height="10" fill="#1a120b"/>
                    <rect x="160" y="70" width="5" height="10" fill="#1a120b"/>
                </svg>
            </div>
            <div class="text-center space-y-1">
                <h1 class="text-[clamp(1.5rem,4vh,2.2rem)] font-black text-yellow-500">Ø­ØµÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h1>
                <p class="text-[clamp(0.7rem,1.8vh,1rem)] font-bold text-yellow-200/60 uppercase">Ø¬Ù…Ø¹ ÙˆØ·Ø±Ø­ ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯</p>
            </div>
            <div class="bg-black/30 p-3 rounded-2xl border border-yellow-900/30 text-center text-xs font-bold leading-relaxed">
                Ø§Ù‚ØªØ­Ù… Ù¥ Ø£Ø¨ÙˆØ§Ø¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ†Ø² Ø§Ù„Ø­ØµÙ†. ÙƒÙ„ Ø¨Ø§Ø¨ Ù£ Ù†Ù‚Ø§Ø·. Ø§Ù„Ø®Ø·Ø£ ÙŠØ­Ø°Ù Ø®ÙŠØ§Ø±Ø§Ù‹.
            </div>
            <div class="space-y-3">
                <button onclick="startGame()" class="btn-gold shadow-lg">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµÙ† <i class="fas fa-door-open mr-3"></i></button>
                <button onclick="fetchAndShowLeaderboard(true)" class="w-full text-center text-gold font-bold text-xs"><i class="fas fa-trophy ml-1"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</button>
            </div>
            <p class="text-center text-[9px] text-yellow-900 font-bold uppercase py-2">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <div id="map-screen" class="hidden screen-container">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-[clamp(0.9rem,2.2vh,1.2rem)] font-black text-gold">Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø­ØµÙ†</h3>
                <div class="bg-yellow-600 text-black px-4 py-1 rounded-full font-black text-xs">
                    <span id="points-count">Ù </span> <i class="fas fa-star ml-1"></i>
                </div>
            </div>
            <div id="doors-grid" class="grid grid-cols-2 gap-3 flex-grow py-2"></div>
            <div class="border-t border-yellow-900/30 pt-3 text-center">
                <p class="text-yellow-900 font-black text-xs font-mono">Ø§Ù„Ø²Ù…Ù†: <span id="timer-val" class="text-gold">Ù Ù :Ù Ù </span></p>
            </div>
        </div>

        <div id="challenge-screen" class="hidden screen-container">
            <div class="flex justify-between items-center h-[5vh]">
                <button onclick="showMap()" class="text-xs font-bold text-yellow-700"><i class="fas fa-arrow-right ml-1"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
                <span id="room-title" class="text-xs font-black text-gold bg-black/40 px-3 py-1 rounded-full border border-gold/20">Ø§Ù„Ø¨Ø§Ø¨ Ù¡</span>
                <div id="room-potential-points" class="text-xs font-black text-gold bg-black/40 px-3 py-1 rounded-full border border-gold/20">Ù£ Ù†Ù‚Ø§Ø·</div>
            </div>
            <p id="question-text" class="text-center font-bold text-yellow-100 text-[clamp(0.8rem,1.9vh,0.95rem)] py-2"></p>
            <div class="math-box">
                <div id="visual-content" class="math-content-wrapper"></div>
            </div>
            <div id="options-grid" class="grid grid-cols-2 gap-2 h-[18vh]"></div>
        </div>

        <div id="result-screen" class="hidden screen-container justify-center">
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-6"></div>
            <div class="bg-yellow-600/10 p-6 rounded-3xl border border-yellow-600/30 text-center space-y-2">
                <i class="fas fa-crown text-gold text-5xl animate-bounce"></i>
                <p class="font-black text-yellow-100">ØªÙ… ÙØªØ­ ÙƒÙ†Ø² Ø§Ù„Ø­ØµÙ† Ø¨Ù†Ø¬Ø§Ø­!</p>
            </div>
            <div class="space-y-3 mt-6">
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-gold">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ <i class="fas fa-trophy mr-2"></i></button>
                <div class="flex gap-2">
                    <button onclick="location.reload()" class="btn-gold flex-1 bg-yellow-900/40 text-sm">Ø¥Ø¹Ø§Ø¯Ø©</button>
                    <button id="finish-btn" class="btn-gold flex-[2] text-sm">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-modal" class="hidden absolute inset-0 flex flex-col p-5">
            <div class="flex justify-between items-center mb-4 border-b border-gold/20 pb-3">
                <div class="flex items-center gap-2">
                    <i class="fas fa-trophy text-gold"></i>
                    <h3 class="font-black text-gold text-lg">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
                </div>
                <button onclick="closeLeaderboardModal()" class="w-10 h-10 rounded-full bg-yellow-900/60 text-gold flex items-center justify-center border border-gold/30"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="leaderboard-tabs" class="flex gap-2 mb-4">
                <button onclick="switchLeaderboardTab('class')" id="btn-tab-class" class="tab-btn flex-1 py-2 rounded-xl text-xs font-black">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchLeaderboardTab('global')" id="btn-tab-global" class="tab-btn flex-1 py-2 rounded-xl text-xs font-black active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>

            <div id="modal-body" class="flex-1 overflow-y-auto bg-black/40 rounded-2xl relative p-1 border border-gold/10">
                <div id="modal-loader" class="hidden absolute inset-0 flex items-center justify-center bg-black/80 z-10">
                    <div class="flex flex-col items-center gap-2">
                        <i class="fas fa-sync animate-spin text-3xl text-gold"></i>
                        <span class="text-xs text-gold font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                </div>
                <div id="leaderboard-content" class="p-1"></div>
            </div>
            <p class="text-center text-[10px] text-gold/40 pt-3">ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø«Ù… Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø£Ù‚Ù„</p>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = 'g6_4_2'; 
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || urlParams.get('userName') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        
        let timerSeconds = 0;
        let timerInterval = null;
        let solvedRooms = [false, false, false, false, false];
        let roomScores = [0, 0, 0, 0, 0];
        let currentAttempts = 0;
        let currentRoomIndex = -1;
        let currentOptions = [];
        let currentLeaderboardTab = 'global';

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

        const questionBank = [
            [ 
                { q: "Ø§Ø¬Ù…Ø¹ Ø«Ù†Ø§Ø¦ÙŠØªÙŠ Ø§Ù„Ø­Ø¯ Ù„ÙÙƒ Ø§Ù„Ø´ÙØ±Ø©:", visual: "(Ù¢Ø³ + Ù£) + (Ù¥Ø³ + Ù¤)", opts: ["Ù§Ø³ + Ù§", "Ù§Ø³ + Ù¡", "Ù¡Ù Ø³ + Ù§", "Ù§Ø³Â² + Ù§"], a: "Ù§Ø³ + Ù§" },
                { q: "Ø§Ø¬Ù…Ø¹ Ø«Ù†Ø§Ø¦ÙŠØªÙŠ Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©:", visual: "(Ù£Ø³ + Ù¥) + (Ù¢Ø³ + Ù¡)", opts: ["Ù¥Ø³ + Ù¦", "Ù¥Ø³ + Ù¤", "Ù¦Ø³ + Ù¥", "Ù¥Ø³Â² + Ù¦"], a: "Ù¥Ø³ + Ù¦" },
                { q: "Ø§Ø¬Ù…Ø¹ Ø«Ù†Ø§Ø¦ÙŠØªÙŠ Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©:", visual: "(Ù¤Ø³ + Ù§) + (Ø³ + Ù£)", opts: ["Ù¥Ø³ + Ù¡Ù ", "Ù¥Ø³ + Ù¤", "Ù¤Ø³ + Ù¡Ù ", "Ù¥Ø³Â² + Ù¡Ù "], a: "Ù¥Ø³ + Ù¡Ù " }
            ],
            [ 
                { q: "Ø¨Ø³Ø· Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø­ØµÙ†:", visual: "(Ù£Ø³Â² + Ù¤Ø³ + Ù¢) + (Ø³Â² - Ù¢) - (Ù¢Ø³Â² + Ø³)", opts: ["Ù¢Ø³Â² + Ù£Ø³", "Ù¢Ø³Â² + Ù¥Ø³", "Ù¤Ø³Â² + Ù£Ø³", "Ù¢Ø³Â² + Ù£Ø³ + Ù¤"], a: "Ù¢Ø³Â² + Ù£Ø³" },
                { q: "Ø¨Ø³Ø· Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ:", visual: "(Ù¥Ø³Â² + Ù¢Ø³) + (Ø³Â² - Ø³)", opts: ["Ù¦Ø³Â² + Ø³", "Ù¦Ø³Â² + Ù£Ø³", "Ù¤Ø³Â² + Ø³", "Ù¦Ø³Â² - Ø³"], a: "Ù¦Ø³Â² + Ø³" },
                { q: "Ø¨Ø³Ø· Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ:", visual: "(Ø³Â² + Ù¤) + (Ù¢Ø³Â² - Ù£)", opts: ["Ù£Ø³Â² + Ù¡", "Ù£Ø³Â² - Ù¡", "Ø³Â² + Ù¡", "Ù£Ø³Â² + Ù§"], a: "Ù£Ø³Â² + Ù¡" }
            ],
            [ 
                { q: "Ø£ÙˆØ¬Ø¯ Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ù…ÙˆØ¶Ø­:", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#d4af37" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù¡Ù£</text><text x="250" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù¢Ø³+Ù¤</text><text x="150" y="180" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù¥Ø³</text></svg>`, opts: ["Ù§Ø³ + Ù¡Ù§", "Ù¡Ù Ø³ + Ù¥", "Ù§Ø³ + Ù§", "Ù¡Ù£Ø³ + Ù¤"], a: "Ù§Ø³ + Ù¡Ù§" },
                { q: "Ø£ÙˆØ¬Ø¯ Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ù…ÙˆØ¶Ø­:", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#d4af37" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ø³+Ù¢</text><text x="250" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ø³+Ù¢</text><text x="150" y="180" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ø³+Ù¢</text></svg>`, opts: ["Ù£Ø³ + Ù¦", "Ù£Ø³ + Ù¢", "Ø³ + Ù¦", "Ù£Ø³Â² + Ù¦"], a: "Ù£Ø³ + Ù¦" },
                { q: "Ø£ÙˆØ¬Ø¯ Ù…Ø­ÙŠØ· Ø§Ù„Ù…Ø«Ù„Ø« Ø§Ù„Ù…ÙˆØ¶Ø­:", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#d4af37" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù¤Ø³</text><text x="250" y="100" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù£Ø³</text><text x="150" y="180" fill="#f3e5ab" font-size="20" font-weight="bold" text-anchor="middle">Ù¥Ø³</text></svg>`, opts: ["Ù¡Ù¢Ø³", "Ù¡Ù Ø³", "Ù§Ø³", "Ù¡Ù¢Ø³Â²"], a: "Ù¡Ù¢Ø³" }
            ],
            [ 
                { q: "Ø£ÙˆØ¬Ø¯ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø·ÙˆÙ„ÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø±ÙŠÙ†:", 
                  visual: `<div class="flex flex-col gap-1 items-center"><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø£</div><div class="text-lg">Ù¨Ø³ + Ù¡Ù¢</div><div class="h-px bg-gold/20 w-16 my-1"></div><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø¨</div><div class="text-lg">Ù£Ø³ + Ù¥</div></div>`, 
                  opts: ["Ù¥Ø³ + Ù§", "Ù¥Ø³ + Ù¡Ù§", "Ù¡Ù¡Ø³ + Ù¡Ù§", "Ù¥Ø³ - Ù§"], a: "Ù¥Ø³ + Ù§" },
                { q: "Ø£ÙˆØ¬Ø¯ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø·ÙˆÙ„ÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø±ÙŠÙ†:", 
                  visual: `<div class="flex flex-col gap-1 items-center"><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø£</div><div class="text-lg">Ù¡Ù Ø³ + Ù¤</div><div class="h-px bg-gold/20 w-16 my-1"></div><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø¨</div><div class="text-lg">Ù¢Ø³ + Ù¡</div></div>`, 
                  opts: ["Ù¨Ø³ + Ù£", "Ù¨Ø³ + Ù¥", "Ù¡Ù¢Ø³ + Ù¥", "Ù¨Ø³ - Ù£"], a: "Ù¨Ø³ + Ù£" },
                { q: "Ø£ÙˆØ¬Ø¯ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø·ÙˆÙ„ÙŠ Ø§Ù„Ø¬Ø¯Ø§Ø±ÙŠÙ†:", 
                  visual: `<div class="flex flex-col gap-1 items-center"><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø£</div><div class="text-lg">Ù¦Ø³ + Ù©</div><div class="h-px bg-gold/20 w-16 my-1"></div><div class="text-[10px] text-accent-gold">Ø§Ù„Ø¬Ø¯Ø§Ø± Ø¨</div><div class="text-lg">Ø³ + Ù£</div></div>`, 
                  opts: ["Ù¥Ø³ + Ù¦", "Ù¥Ø³ + Ù¡Ù¢", "Ù§Ø³ + Ù¡Ù¢", "Ù¥Ø³ - Ù¦"], a: "Ù¥Ø³ + Ù¦" }
            ],
            [ 
                { q: "ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒÙ†Ø²: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ÙŠØ· Ù¡Ù¡Ø³ + Ù¡Ù ØŒ Ø£ÙˆØ¬Ø¯ (ØŸ):", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#ffd700" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù¤Ø³</text><text x="250" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù¢Ø³+Ù¤</text><text x="150" y="180" fill="#ffd700" font-size="35" font-weight="black" text-anchor="middle">ØŸ</text></svg>`, opts: ["Ù¥Ø³ + Ù¦", "Ù§Ø³ + Ù©", "Ù¥Ø³ + Ù©", "Ø³ + Ù¦"], a: "Ù¥Ø³ + Ù¦" },
                { q: "ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒÙ†Ø²: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ÙŠØ· Ù©Ø³ + Ù¥ØŒ Ø£ÙˆØ¬Ø¯ (ØŸ):", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#ffd700" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù£Ø³+Ù¡</text><text x="250" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù£Ø³+Ù¡</text><text x="150" y="180" fill="#ffd700" font-size="35" font-weight="black" text-anchor="middle">ØŸ</text></svg>`, opts: ["Ù£Ø³ + Ù£", "Ù£Ø³ + Ù¥", "Ù¦Ø³ + Ù¢", "Ù£Ø³ + Ù¡"], a: "Ù£Ø³ + Ù£" },
                { q: "ØªØ­Ø¯ÙŠ Ø§Ù„ÙƒÙ†Ø²: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ÙŠØ· Ù¦Ø³ + Ù¨ØŒ Ø£ÙˆØ¬Ø¯ (ØŸ):", visual: `<svg viewBox="0 0 300 200" class="h-full w-full"><polygon points="150,40 250,150 50,150" fill="none" stroke="#ffd700" stroke-width="5"/><text x="50" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù¢Ø³</text><text x="250" y="100" fill="#f3e5ab" font-size="22" font-weight="bold" text-anchor="middle">Ù¢Ø³+Ù£</text><text x="150" y="180" fill="#ffd700" font-size="35" font-weight="black" text-anchor="middle">ØŸ</text></svg>`, opts: ["Ù¢Ø³ + Ù¥", "Ù¢Ø³ + Ù£", "Ù¤Ø³ + Ù¥", "Ù¢Ø³ - Ù¥"], a: "Ù¢Ø³ + Ù¥" }
            ]
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('top-student-name').textContent = studentName;
            
            if (!classId) {
                document.getElementById('btn-tab-class').style.display = 'none';
                currentLeaderboardTab = 'global';
            } else {
                currentLeaderboardTab = 'class';
                switchLeaderboardTab('class');
            }
            
            // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØµÙØ±
            fetchInitialCloudData();
            
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        // ÙˆØ¸ÙŠÙØ© "Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØµÙØ±" Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³Ø±Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        async function fetchInitialCloudData() {
            if (!studentId || !classId) return;
            
            document.getElementById('sync-icon').classList.remove('hidden');
            try {
                // Ø¥Ø¶Ø§ÙØ© t Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Cache Busting) Ù„Ø¶Ù…Ø§Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠØ©
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                
                if (res.status === 'success' && res.data) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ ÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹
                    if (res.data.name && res.data.name !== "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ") {
                        studentName = res.data.name;
                        document.getElementById('top-student-name').textContent = studentName;
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠ
                    if (res.data.games && res.data.games[GAME_ID]) {
                        const cloudGrade = parseFloat(res.data.games[GAME_ID].grade || 0).toFixed(1);
                        document.getElementById('top-points-display').textContent = toAr(cloudGrade) + " / Ù¥";
                    }
                }
            } catch (e) {
                console.error("Zero-second fetch failed:", e);
            } finally { 
                document.getElementById('sync-icon').classList.add('hidden'); 
            }
        }

        window.startGame = () => { 
            document.getElementById('start-screen').classList.add('hidden'); 
            showMap(); 
            if (!timerInterval) startTimer(); 
        };
        
        function startTimer() {
            timerInterval = setInterval(() => {
                timerSeconds++;
                const mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
                const secs = (timerSeconds % 60).toString().padStart(2, '0');
                document.getElementById('timer-val').innerText = `${toAr(mins)}:${toAr(secs)}`;
            }, 1000);
        }

        window.showMap = () => {
            document.getElementById('challenge-screen').classList.add('hidden');
            document.getElementById('map-screen').classList.remove('hidden');
            renderMap();
        };

        function renderMap() {
            const grid = document.getElementById('doors-grid');
            grid.innerHTML = '';
            solvedRooms.forEach((solved, i) => {
                const isLocked = i > 0 && !solvedRooms[i-1];
                const card = document.createElement('div');
                card.className = `door-card ${isLocked ? 'door-locked opacity-40 grayscale pointer-events-none' : (solved ? 'door-solved opacity-80 cursor-default' : 'door-active')} ${i === 4 ? 'col-span-2' : ''} p-2 rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border-2`;
                card.style.background = solved ? "linear-gradient(45deg, #1a2e1a, #2d4a2d)" : "linear-gradient(45deg, #3d2b1f, #5d4037)";
                card.style.borderColor = isLocked ? "#444" : (solved ? "#4ade80" : "var(--gold)");
                
                card.onclick = () => {
                    if (!isLocked && !solved) {
                        enterRoom(i);
                    }
                };

                card.innerHTML = `<span class="${i===4?'text-4xl':'text-2xl'}">${isLocked ? 'ğŸ”’' : (solved ? 'âœ…' : (i===4?'ğŸ‘‘':'ğŸšª'))}</span>
                                 <span class="text-[10px] font-black">${solved ? 'Ù†Ù‚Ø·: ' + toAr(roomScores[i]) : 'Ø§Ù„Ø¨Ø§Ø¨ ' + toAr(i+1)}</span>`;
                grid.appendChild(card);
            });
            const total = roomScores.reduce((a, b) => a + b, 0);
            document.getElementById('points-count').innerText = toAr(total);
            document.getElementById('top-points-display').innerText = toAr(((total/15)*5).toFixed(1)) + " / Ù¥";
        }

        function formatMath(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/Â²/g, `<span class="exponent">Ù¢</span>`);
        }

        function renderSmartEquation(text) {
            if (typeof text !== 'string') return text;
            const tokens = text.split(/(\(.*?\)|[+-])/g).filter(t => t && t.trim().length > 0);
            let html = '';
            tokens.forEach(token => {
                const t = token.trim();
                if (t === '+' || t === '-') {
                    html += `<span class="math-operator px-2">${t}</span>`;
                } else {
                    html += `<span class="math-unit">${formatMath(t)}</span>`;
                }
            });
            return html;
        }

        function enterRoom(i) {
            currentRoomIndex = i;
            currentAttempts = 0;
            const questions = questionBank[i];
            const randomIndex = Math.floor(Math.random() * questions.length);
            const data = questions[randomIndex];
            
            window.activeQuestion = data;
            currentOptions = [...data.opts].sort(() => Math.random() - 0.5);
            
            document.getElementById('map-screen').classList.add('hidden');
            document.getElementById('challenge-screen').classList.remove('hidden');
            document.getElementById('room-title').innerText = "Ø§Ù„Ø¨Ø§Ø¨ " + toAr(i+1);
            document.getElementById('question-text').innerText = data.q;
            
            const visualEl = document.getElementById('visual-content');
            if (data.visual.includes('<svg') || data.visual.includes('<div')) {
                visualEl.innerHTML = formatMath(data.visual);
            } else {
                visualEl.innerHTML = renderSmartEquation(data.visual);
            }
            updateOptionsUI();
        }

        function updateOptionsUI() {
            document.getElementById('room-potential-points').innerText = toAr(3 - currentAttempts) + " Ù†Ù‚Ø§Ø·";
            const optsGrid = document.getElementById('options-grid');
            optsGrid.innerHTML = '';
            currentOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "btn-gold bg-black/40 border-yellow-900/50";
                btn.innerHTML = formatMath(opt);
                btn.onclick = () => checkAnswer(opt, window.activeQuestion.a, btn);
                optsGrid.appendChild(btn);
            });
        }

        function checkAnswer(sel, cor, btn) {
            if (sel === cor) {
                roomScores[currentRoomIndex] = 3 - currentAttempts;
                solvedRooms[currentRoomIndex] = true;
                if (solvedRooms.every(r => r === true)) processFinalResults(); else showMap();
            } else {
                currentAttempts++;
                btn.classList.add('shake', 'border-red-500', 'opacity-50');
                btn.disabled = true;
                if (currentAttempts >= 3) {
                    roomScores[currentRoomIndex] = 0;
                    solvedRooms[currentRoomIndex] = true;
                    if (solvedRooms.every(r => r === true)) processFinalResults(); else showMap();
                } else {
                    currentOptions = currentOptions.filter(o => o !== sel);
                    setTimeout(updateOptionsUI, 400);
                }
            }
        }

        function processFinalResults() {
            clearInterval(timerInterval);
            const total = roomScores.reduce((a, b) => a + b, 0);
            const grade = (total / 15 * 5).toFixed(1);
            document.getElementById('challenge-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-yellow-900/20 p-2 rounded-xl border border-gold/20 text-center"><p class="text-[8px]">Ø§Ù„Ù†Ù‚Ø§Ø·</p><p class="text-sm font-black text-gold">${toAr(total)}/Ù¡Ù¥</p></div>
                <div class="bg-yellow-600/30 p-2 rounded-xl border border-gold text-center"><p class="text-[8px]">Ø§Ù„Ø¯Ø±Ø¬Ø©</p><p class="text-xl font-black text-white">${toAr(grade)}</p></div>
                <div class="bg-yellow-900/20 p-2 rounded-xl border border-gold/20 text-center"><p class="text-[8px]">Ø§Ù„ÙˆÙ‚Øª</p><p class="text-sm font-black text-gold">${toAr(timerSeconds)}Ø«</p></div>`;
            
            if (studentId && classId) saveScore(grade, timerSeconds);
            else fetchAndShowLeaderboard(false);
        }

        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } finally { fetchAndShowLeaderboard(false); }
        }

        window.switchLeaderboardTab = (tab) => {
            currentLeaderboardTab = tab;
            document.getElementById('btn-tab-class').classList.toggle('active', tab === 'class');
            document.getElementById('btn-tab-global').classList.toggle('active', tab === 'global');
            fetchAndShowLeaderboard(false);
        };

        window.fetchAndShowLeaderboard = function(isManual = false) {
            if (isManual) document.getElementById('leaderboard-modal').classList.remove('hidden');
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            const reqClassId = (currentLeaderboardTab === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            
            fetch(url).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[11px]"><thead class="bg-gold/10 text-gold"><tr><th class="p-2 text-center">#</th><th class="p-2">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody class="divide-y divide-gold/5">`;
                    data.forEach((p, i) => {
                        const isMe = studentId && String(p.name).trim() === String(studentName).trim();
                        h += `<tr class="${isMe ? 'bg-gold/15' : ''}">
                            <td class="p-3 text-center font-bold text-gold/60">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td>
                            <td class="p-3 font-bold ${isMe ? 'text-white' : 'text-gold/80'}">${p.name} ${isMe ? '<span class="text-[8px] bg-gold text-black px-1 rounded mx-1">Ø£Ù†Øª</span>' : ''}</td>
                            <td class="p-3 text-center text-gold font-black">${toAr(parseFloat(p.grade || 0).toFixed(1))}</td>
                        </tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else {
                    content.innerHTML = `<div class="py-16 text-center"><i class="fas fa-ghost text-4xl text-gold/20 mb-3 block"></i><p class="text-xs text-gold/40">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹..</p></div>`;
                }
            }).catch(() => {
                content.innerHTML = `<p class="py-10 text-center text-red-400 text-xs">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.add('hidden');
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٢-٤: حل المعادلات الخطية بيانياً | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .step-box { border-right: 4px solid #1d4ed8; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .highlight-change { color: #ef4444; font-weight: bold; }
        
        /* === تعديل الرموز الرياضية === */
        .math-eq {
            font-family: "Courier New", monospace; /* خط عريض ومتباعد */
            font-size: 1.1rem; /* تكبير حجم الخط */
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6; /* خلفية رمادية فاتحة */
            border: 1px solid #d1d5db; /* إطار خفيف */
            padding: 2px 8px; /* هوامش داخلية */
            border-radius: 6px; /* زوايا دائرية */
            display: inline-block;
            vertical-align: middle; /* محاذاة أفضل مع النص */
        }
        
        .fraction { display: inline-flex; flex-direction: column; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > .frac-bar { border-top: 2px solid #4338ca; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateY(10px); }
        .step-interactive.active { display: block; opacity: 1; transform: translateY(0); }
        .highlight-s { color: #2563eb; font-weight: bold; }
        .btn-disabled {
            background-color: #9ca3af !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٢-٤: حل المعادلات الخطية بيانياً</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                
                <!-- Section 1: Basic Concepts -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفاهيم الأساسية</h2>
                    <div class="p-6 bg-blue-50 rounded-lg space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">الدالة المولّدة (الأم) للدوال الخطية</h3>
                            <p>أبسط دالة خطية هي <span class="math-eq">د(س) = س</span>. وتُسمى <span class="vocab-term">الدالة المولدة (الأم)</span> لمجموعة الدوال الخطية.</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-blue-700 mb-2">المعادلة والدالة المرتبطة</h3>
                            <p><span class="vocab-term">المعادلة الخطية</span> هي جملة رياضية طرفاها متساويان. لحل المعادلة بيانياً، نحولها إلى <span class="vocab-term">دالة مرتبطة</span> عن طريق وضع جميع الحدود في طرف واحد واستبدال الصفر في الطرف الآخر بـ <span class="math-eq">د(س)</span>.</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border-l-4 border-blue-500">
                             <h3 class="text-xl font-semibold text-blue-700 mb-2">جذر المعادلة والحل البياني (مهم جداً)</h3>
                             <p>حل المعادلة يُسمى <span class="vocab-term">الجذر</span>، وهو نفسه <span class="vocab-term">صفر الدالة</span>.</p>
                             <p class="font-bold mt-2">الهدف الأساسي من هذا الدرس هو إيجاد الحل بيانياً. الحل البياني هو نقطة تقاطع التمثيل البياني مع محور السينات، وهي النقطة التي تكون عندها قيمة <span class="math-eq">ص = ٠</span>.</p>
                             <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                                <div>
                                    <h4 class="font-semibold">يوجد حل (جذر واحد)</h4>
                                    <svg viewBox="-5 -5 10 10" class="w-full h-40 bg-gray-50 border rounded-lg mt-2">
                                        <path d="M -5,1 L 5,1 M -5,2 L 5,2 M -5,3 L 5,3 M -5,4 L 5,4 M -5,-1 L 5,-1 M -5,-2 L 5,-2 M -5,-3 L 5,-3 M -5,-4 L 5,-4" stroke="#e5e7eb" stroke-width="0.15" />
                                        <path d="M 1,-5 L 1,5 M 2,-5 L 2,5 M 3,-5 L 3,5 M 4,-5 L 4,5 M -1,-5 L -1,5 M -2,-5 L -2,5 M -3,-5 L -3,5 M -4,-5 L -4,5" stroke="#e5e7eb" stroke-width="0.15" />
                                        <line x1="-5" y1="0" x2="5" y2="0" stroke="#9ca3af" stroke-width="0.2"/>
                                        <line x1="0" y1="-5" x2="0" y2="5" stroke="#9ca3af" stroke-width="0.2"/>
                                        <line x1="-1" y1="-4" x2="5" y2="2" stroke="#3b82f6" stroke-width="0.4"/>
                                        <circle cx="3" cy="0" r="0.3" fill="#16a34a" />
                                    </svg>
                                    <p class="mt-2 p-2 bg-green-100 rounded-md text-green-800 text-sm">يوجد حل عند <span class="math-eq">س = ٣</span> لأن الخط يقطع محور السينات.</p>
                                </div>
                                <div>
                                    <h4 class="font-semibold">لا يوجد حل حقيقي</h4>
                                    <svg viewBox="-5 -5 10 10" class="w-full h-40 bg-gray-50 border rounded-lg mt-2">
                                         <path d="M -5,1 L 5,1 M -5,2 L 5,2 M -5,3 L 5,3 M -5,4 L 5,4 M -5,-1 L 5,-1 M -5,-2 L 5,-2 M -5,-3 L 5,-3 M -5,-4 L 5,-4" stroke="#e5e7eb" stroke-width="0.15" />
                                        <path d="M 1,-5 L 1,5 M 2,-5 L 2,5 M 3,-5 L 3,5 M 4,-5 L 4,5 M -1,-5 L -1,5 M -2,-5 L -2,5 M -3,-5 L -3,5 M -4,-5 L -4,5" stroke="#e5e7eb" stroke-width="0.15" />
                                        <line x1="-5" y1="0" x2="5" y2="0" stroke="#9ca3af" stroke-width="0.2"/>
                                        <line x1="0" y1="-5" x2="0" y2="5" stroke="#9ca3af" stroke-width="0.2"/>
                                        <line x1="-5" y1="2" x2="5" y2="2" stroke="#ef4444" stroke-width="0.4"/>
                                    </svg>
                                    <p class="mt-2 p-2 bg-red-100 rounded-md text-red-800 text-sm">لا يوجد حل حقيقي لأن الخط لا يقطع محور السينات أبداً.</p>
                                </div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- NEW Section: Interactive Examples for Related Function -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">مثال: إيجاد الدالة المرتبطة</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Example 1 -->
                            <div id="interactive-container-3" class="p-4 bg-white rounded-lg shadow">
                                <p class="text-lg font-semibold mb-2">مثال ١: معادلة جاهزة</p>
                                <p class="mb-4 text-gray-700"><strong>المعادلة:</strong> <span class="math-eq">٣س - ١٢ = ٠</span></p>
                                <div class="steps-container space-y-4 min-h-[150px]">
                                    <div class="interactive-placeholder text-center text-gray-500 p-4">
                                        <p>اضغط "التالي" لإيجاد الدالة المرتبطة.</p>
                                    </div>
                                    <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                        <h4 class="font-bold">الخطوة 1:</h4>
                                        <p>بما أن الطرف الأيسر يساوي صفر، نستبدله مباشرة بـ <span class="math-eq">د(س)</span>.</p>
                                    </div>
                                    <div class="step-interactive p-4 bg-green-100 rounded-lg step-box border-green-600">
                                        <h4 class="font-bold">الدالة المرتبطة:</h4>
                                        <p class="text-center"><span class="math-eq">د(س) = ٣س - ١٢</span></p>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-6">
                                    <button data-example="3" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                    <div>
                                        <button data-example="3" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                        <button data-example="3" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Example 2 -->
                            <div id="interactive-container-4" class="p-4 bg-white rounded-lg shadow">
                                <p class="text-lg font-semibold mb-2">مثال ٢: معادلة تحتاج لترتيب</p>
                                <p class="mb-4 text-gray-700"><strong>المعادلة:</strong> <span class="math-eq">٤س + ٢ = ١٠</span></p>
                                <div class="steps-container space-y-4 min-h-[150px]">
                                    <div class="interactive-placeholder text-center text-gray-500 p-4">
                                        <p>اضغط "التالي" لإيجاد الدالة المرتبطة.</p>
                                    </div>
                                    <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                        <h4 class="font-bold">الخطوة 1:</h4>
                                        <p>يجب أن نجعل الطرف الأيسر يساوي صفر. نطرح ١٠ من كلا الطرفين.</p>
                                        <p class="text-center"><span class="math-eq">٤س + ٢ - ١٠ = ٠</span></p>
                                    </div>
                                    <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                        <h4 class="font-bold">الخطوة 2:</h4>
                                        <p>نبسط المعادلة.</p>
                                        <p class="text-center"><span class="math-eq">٤س - ٨ = ٠</span></p>
                                    </div>
                                    <div class="step-interactive p-4 bg-green-100 rounded-lg step-box border-green-600">
                                        <h4 class="font-bold">الدالة المرتبطة:</h4>
                                        <p class="text-center"><span class="math-eq">د(س) = ٤س - ٨</span></p>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-6">
                                    <button data-example="4" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                    <div>
                                        <button data-example="4" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                        <button data-example="4" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Solving the Equation -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: حل المعادلة <span class="math-eq">٢س - ٨ = ٠</span> جبرياً وبيانياً</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-8">
                        <div id="interactive-container-2" class="p-4 bg-white rounded-lg shadow">
                            <h3 class="font-bold text-xl mb-3 text-indigo-700">الطريقة الأولى: الحل الجبري (تفاعلي)</h3>
                            <div class="steps-container space-y-4 min-h-[150px]">
                                <div class="interactive-placeholder text-center text-gray-500 p-4">
                                    <p>اضغط "التالي" لبدء خطوات الحل الجبري</p>
                                </div>
                                <div class="step-interactive p-2">
                                    <p><strong>المعادلة الأصلية:</strong> <span class="math-eq">٢س - ٨ = ٠</span></p>
                                </div>
                                <div class="step-interactive p-2">
                                    <p><strong>الخطوة 1:</strong> نضيف ٨ إلى كلا الطرفين للتخلص من -٨.</p>
                                    <p class="text-center"><span class="math-eq">٢س = ٨</span></p>
                                </div>
                                <div class="step-interactive p-2 bg-green-100 rounded-lg">
                                    <p><strong>الخطوة 2:</strong> نقسم كلا الطرفين على ٢ لإيجاد قيمة س.</p>
                                    <p class="text-center"><strong class="text-green-800">الحل:</strong> <span class="math-eq">س = ٤</span></p>
                                </div>
                            </div>
                            <div class="flex justify-between mt-6">
                                <button data-example="2" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                <div>
                                    <button data-example="2" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                    <button data-example="2" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-xl mb-3 text-teal-700">الطريقة الثانية: الحل البياني (بشكل تفاعلي)</h3>
                            <div class="p-4 bg-teal-50 rounded-md mb-6">
                                <p>لحل المعادلة بيانياً، نحولها أولاً إلى دالة مرتبطة: <span class="math-eq">د(س) = ٢س - ٨</span>. ثم نبدأ بتمثيلها.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                                <div>
                                    <h4 class="font-bold text-lg mb-2">تكوين جدول</h4>
                                    <p class="mb-4 text-sm text-gray-600">اضغط على الأزرار لبناء الحل خطوة بخطوة.</p>
                                    <table class="w-full border-collapse border border-slate-400 text-center">
                                        <thead class="bg-blue-100">
                                            <tr>
                                                <th class="p-2 border border-slate-300 highlight-s">س</th>
                                                <th class="p-2 border border-slate-300">٢<span class="highlight-s">س</span> - ٨</th>
                                                <th class="p-2 border border-slate-300">(س, ص)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="interactive-table-body"></tbody>
                                    </table>
                                     <div class="mt-4 grid grid-cols-3 gap-2">
                                        <button id="prev-step-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors btn-disabled" disabled>السابق</button>
                                        <button id="next-step-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">التالي</button>
                                        <button id="reset-step-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">إعادة</button>
                                    </div>
                                    <div id="table-conclusion" class="hidden mt-2 p-2 bg-yellow-100 rounded-md text-yellow-800 text-center">
                                        <p>لاحظ في الجدول أن الحل هو <span class="math-eq">س = ٤</span> لأن قيمة <span class="math-eq">ص</span> المقابلة لها تساوي <span class="math-eq">٠</span>.</p>
                                    </div>
                                </div>
                                <div>
                                     <h4 class="font-bold text-lg mb-2">التمثيل البياني</h4>
                                     <svg id="interactive-graph" viewBox="-10 -10 20 20" class="w-full h-72 bg-white border rounded-lg"></svg>
                                     <div id="graph-conclusion" class="hidden mt-2 p-2 bg-green-100 rounded-md text-green-800 text-center">
                                        <p>الخط يقطع محور السينات عند النقطة <span class="math-eq">س = ٤</span>. هذا هو <span class="vocab-term">حل المعادلة</span>.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Real-life Example (Interactive) -->
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🥕 ثالثاً: مثال من واقع الحياة (تفاعلي)</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div id="interactive-container-1" class="p-4 bg-white rounded-lg shadow">
                            <p class="text-lg font-semibold mb-2">مثال: مشكلة الجزر</p>
                            <p class="mb-4 text-gray-700"><strong>المسألة:</strong> تمثل الدالة <span class="math-eq">و = ٦٠ - ٢ن</span> كتلة الجزر المتبقي بالكيلوجرام في محل أحمد بعد بيعه <span class="math-eq">ن</span> كيساً. أوجد صفر الدالة، ووضّح ما يعنيه في هذا السياق.</p>
                            
                            <div class="steps-container space-y-4 min-h-[200px]">
                                <div class="interactive-placeholder text-center text-gray-500 p-4">
                                    <p>اضغط "التالي" لبدء خطوات الحل</p>
                                </div>
                                
                                <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                    <h4 class="font-bold">الخطوة 1: فهم "صفر الدالة"</h4>
                                    <p>المطلوب هو إيجاد "صفر الدالة". هذا يعني أننا نريد أن نعرف متى تصبح كمية الجزر المتبقية (<span class="math-eq">و</span>) تساوي **صفرًا**. بمعنى آخر: كم كيساً (<span class="math-eq">ن</span>) يجب أن يبيع أحمد حتى ينتهي كل الجزر؟</p>
                                </div>
                                
                                <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                    <h4 class="font-bold">الخطوة 2: حل المعادلة</h4>
                                    <p>لأننا نريد معرفة متى تنتهي الكمية، فإننا نعوض عن الكتلة المتبقية (<span class="math-eq">و</span>) بالقيمة <span class="math-eq">٠</span> في المعادلة الأصلية:</p>
                                    <p class="text-center my-2 p-2 bg-white rounded-md text-xl math-eq">٠ = ٦٠ - ٢ن</p>
                                </div>

                                <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                    <h4 class="font-bold">ترتيب المعادلة</h4>
                                    <p>ننقل <span class="math-eq">-٢ن</span> للطرف الآخر فتتغير إشارتها.</p>
                                    <p class="text-center my-2 p-2 bg-white rounded-md text-xl math-eq">٢ن = ٦٠</p>
                                </div>

                                <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                    <h4 class="font-bold">إيجاد قيمة ن</h4>
                                    <p>لإيجاد قيمة <span class="math-eq">ن</span>، نقسم ٦٠ على ٢.</p>
                                    <p class="text-center my-2 p-2 bg-green-100 rounded-md text-2xl math-eq">ن = ٣٠</p>
                                </div>
                                
                                <div class="step-interactive p-4 bg-green-100 rounded-lg step-box border-green-600">
                                    <h4 class="font-bold">الخطوة الأخيرة: تفسير الحل</h4>
                                    <p>الحل هو <span class="math-eq">٣٠</span>. وهذا يعني أن أحمد يجب أن يبيع <strong>٣٠ كيساً</strong> حتى تنتهي كل كمية الجزر لديه.</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <button data-example="1" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                <div>
                                    <button data-example="1" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                    <button data-example="1" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Quiz -->
                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ رابعاً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // ===================================================================================
    // دوال مشتركة (لا تقم بتغيير هذا الجزء)
    // ===================================================================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function initializeQuiz(lessonId, questions, studentData) {
        currentQuestions = questions;
        const quizForm = document.getElementById('quizForm');
        if (!quizForm) return;
        if (questions.length === 0) {
            quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`;
            return;
        }
        let attemptsLeft;
        if (studentData) {
            const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 };
            attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts;
        } else {
            attemptsLeft = 1;
        }
        const attemptsCounter = document.getElementById('attempts-counter');
        if (attemptsCounter) {
            attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`;
        }
        const quizHtml = questions.map((q, index) => {
            const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join('');
            
            let questionContentHTML;
            if (q.text.includes('<table')) {
                const title = q.text.split('<div')[0];
                const tableHTML = q.text.substring(q.text.indexOf('<div'));
                questionContentHTML = `<p class="font-bold text-lg">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${title}</p>${tableHTML}`;
            } else if (q.graph) {
                questionContentHTML = `<p class="font-bold text-lg">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p>${q.graph}`;
            } else {
                questionContentHTML = `<p class="font-bold text-lg">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p>`;
            }

            return `<div class="p-4 border-2 border-gray-200 rounded-lg">${questionContentHTML}<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><button type="button" data-question-index="${index}" class="explain-btn hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div>`;
        }).join('');
        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`;
        if (attemptsLeft <= 0) {
            const submitBtn = quizForm.querySelector('#submit-quiz-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'لا توجد محاولات متبقية';
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400');
        }
        quizForm.onsubmit = (e) => {
            e.preventDefault();
            let score = 0;
            questions.forEach((q, index) => {
                const userAnswer = e.target.elements[`q${index}`]?.value;
                const feedbackEl = document.getElementById(`feedback-q${index}`);
                if (userAnswer === q.correct) {
                    score++;
                    feedbackEl.textContent = '✔ إجابة صحيحة!';
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600';
                } else {
                    feedbackEl.textContent = `❌ إجابة خاطئة.`;
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600';
                }
                quizForm.querySelector(`[data-question-index="${index}"]`).classList.remove('hidden');
            });
            const finalGrade = Math.round((score / questions.length) * 10);
            const resultsDiv = document.getElementById('quiz-results');
            resultsDiv.classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`;
            if (studentData) {
                saveGrade(lessonId, finalGrade, studentData.id);
                if (attemptsLeft - 1 > 0) {
                    document.getElementById('retake-quiz-btn').classList.remove('hidden');
                }
            } else {
                document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.';
            }
            e.target.querySelector('#submit-quiz-btn').disabled = true;
        };
    }
    function saveGrade(lessonId, grade, studentId) { if (!studentId) return; const saveStatus = document.getElementById('save-status'); saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&lessonId=${lessonId}&grade=${grade}`; fetch(url) .then(res => res.json()) .then(result => { if (result.status === 'success') { saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; const studentData = JSON.parse(localStorage.getItem('currentStudent')); if (!studentData.lessons) studentData.lessons = {}; if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; } else { studentData.lessons[lessonId].attempts++; } localStorage.setItem('currentStudent', JSON.stringify(studentData)); } else { throw new Error(result.message); } }) .catch(error => { saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; console.error("Save Grade Error:", error); }); }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { explanationText.innerHTML = currentQuestions[questionIndex].explanation; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }

    // ===================================================================================
    // مشغل الكود (لا تقم بتغيير هذا الجزء)
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // مشغل الأمثلة التفاعلية العامة
        const exampleContainers = document.querySelectorAll('[id^="interactive-container-"]');
        const state = {};
        exampleContainers.forEach(container => {
            const exampleId = container.id.split('-')[2];
            state[exampleId] = { currentIndex: -1, steps: container.querySelectorAll('.step-interactive'), placeholder: container.querySelector('.interactive-placeholder'), prevBtn: container.querySelector('.prev-btn'), nextBtn: container.querySelector('.next-btn'), resetBtn: container.querySelector('.reset-btn') };
            
            const updateButtons = () => {
                const isFirstStep = state[exampleId].currentIndex <= -1;
                const isLastStep = state[exampleId].currentIndex >= state[exampleId].steps.length - 1;
                state[exampleId].prevBtn.disabled = isFirstStep;
                state[exampleId].prevBtn.classList.toggle('btn-disabled', isFirstStep);
                
                if (isLastStep) {
                    state[exampleId].nextBtn.classList.add('hidden');
                    state[exampleId].resetBtn.classList.remove('hidden');
                } else {
                    state[exampleId].nextBtn.classList.remove('hidden');
                    state[exampleId].resetBtn.classList.add('hidden');
                }
            };
            
            const resetExample = () => {
                state[exampleId].steps.forEach(step => step.classList.remove('active'));
                state[exampleId].currentIndex = -1;
                if (state[exampleId].placeholder) {
                    state[exampleId].placeholder.classList.remove('hidden');
                }
                updateButtons();
            };

            state[exampleId].nextBtn.addEventListener('click', () => {
                if (state[exampleId].currentIndex < state[exampleId].steps.length - 1) {
                    if (state[exampleId].currentIndex === -1 && state[exampleId].placeholder) {
                        state[exampleId].placeholder.classList.add('hidden');
                    }
                    state[exampleId].currentIndex++;
                    state[exampleId].steps[state[exampleId].currentIndex].classList.add('active');
                    updateButtons();
                }
            });

            state[exampleId].prevBtn.addEventListener('click', () => {
                if (state[exampleId].currentIndex > -1) {
                    state[exampleId].steps[state[exampleId].currentIndex].classList.remove('active');
                    state[exampleId].currentIndex--;
                     if (state[exampleId].currentIndex === -1 && state[exampleId].placeholder) {
                        state[exampleId].placeholder.classList.remove('hidden');
                    }
                    updateButtons();
                }
            });

            if(state[exampleId].resetBtn) { state[exampleId].resetBtn.addEventListener('click', resetExample); }
            updateButtons();
        });

        // ===================================================================================
        // كود خاص بالدرس (هنا يتم وضع المحتوى المخصص)
        // ===================================================================================
        
        // 1. تحديد معرّف الدرس وبياناته
        const LESSON_ID = 'c2_l4_linear_equations'; 
        const LESSON_TITLE = "الدرس ٢-٤: حل المعادلات الخطية بيانياً";

        // 2. بنك الأسئلة الخاص بالدرس
        function generateQuiz() {
            const questionBank = [
                {
                    type: 'mcq', level: '⭐', topic: 'concept', text: 'ماذا يمثل "صفر الدالة" في الرسم البياني؟',
                    options: [
                        { display: 'المقطع الصادي', value: 'A' },
                        { display: 'المقطع السيني', value: 'B' },
                        { display: 'نقطة الأصل', value: 'C' },
                        { display: 'ميل الخط', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>صفر الدالة هو قيمة (س) التي تجعل قيمة الدالة (ص) تساوي صفرًا. على الرسم البياني، هذه هي النقطة التي يقطع فيها الخط محور السينات، وتُعرف بـ "المقطع السيني".</p>'
                },
                {
                    type: 'mcq', level: '⭐', topic: 'parent-function', text: 'ما هي الدالة المولدة (الأم) لجميع الدوال الخطية؟',
                    options: [
                        { display: '<span class="math-eq">د(س) = س²</span>', value: 'A' },
                        { display: '<span class="math-eq">د(س) = س</span>', value: 'B' },
                        { display: '<span class="math-eq">د(س) = |س|</span>', value: 'C' },
                        { display: '<span class="math-eq">د(س) = ١</span>', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>الدالة <span class="math-eq">د(س) = س</span> هي أبسط صورة للدالة الخطية وتعتبر الدالة الأم التي تُبنى عليها جميع الدوال الخطية الأخرى من خلال التحويلات (إزاحة، تمدد، انعكاس).</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐', topic: 'related-function', text: 'ما هي الدالة المرتبطة بالمعادلة <span class="math-eq">٥س = ٢٥</span>؟',
                    options: [
                        { display: '<span class="math-eq">د(س) = ٥س</span>', value: 'A' },
                        { display: '<span class="math-eq">د(س) = ٥س + ٢٥</span>', value: 'B' },
                        { display: '<span class="math-eq">د(س) = ٥س - ٢٥</span>', value: 'C' },
                        { display: '<span class="math-eq">د(س) = ٢٥</span>', value: 'D' }
                    ],
                    correct: 'C',
                    explanation: '<p>لإيجاد الدالة المرتبطة، يجب أولاً أن نجعل أحد طرفي المعادلة يساوي صفرًا. نطرح ٢٥ من الطرفين: <span class="math-eq">٥س - ٢٥ = ٠</span>. ثم نستبدل الصفر بـ <span class="math-eq">د(س)</span> لتصبح الدالة <span class="math-eq">د(س) = ٥س - ٢٥</span>.</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐', topic: 'graph-reading', text: 'من الرسم البياني، ما هو صفر الدالة؟',
                    graph: '<svg viewBox="-5 -5 10 10" class="w-full h-40 bg-white border rounded-lg mt-2"><path d="M -5,1 L 5,1 M -5,2 L 5,2 M -5,3 L 5,3 M -5,4 L 5,4 M -5,-1 L 5,-1 M -5,-2 L 5,-2 M -5,-3 L 5,-3 M -5,-4 L 5,-4" stroke="#d1d5db" stroke-width="0.15" /><path d="M 1,-5 L 1,5 M 2,-5 L 2,5 M 3,-5 L 3,5 M 4,-5 L 4,5 M -1,-5 L -1,5 M -2,-5 L -2,5 M -3,-5 L -3,5 M -4,-5 L -4,5" stroke="#d1d5db" stroke-width="0.15" /><line x1="-5" y1="0" x2="5" y2="0" stroke="#9ca3af" stroke-width="0.2" /><line x1="0" y1="-5" x2="0" y2="5" stroke="#9ca3af" stroke-width="0.2" /><line x1="0" y1="4" x2="4" y2="-4" stroke="#3b82f6" stroke-width="0.4" /><circle cx="2" cy="0" r="0.3" fill="#ef4444" /></svg>',
                    options: [
                        { display: '<span class="math-eq">س = ٠</span>', value: 'A' },
                        { display: '<span class="math-eq">س = ٢</span>', value: 'B' },
                        { display: '<span class="math-eq">س = -٢</span>', value: 'C' },
                        { display: '<span class="math-eq">س = ٤</span>', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>نبحث عن النقطة التي يقطع فيها الخط المستقيم محور السينات (المحور الأفقي). في هذا الرسم، يقطع الخط محور السينات عند النقطة التي تكون فيها <span class="math-eq">س = ٢</span>.</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐', topic: 'solve-equation', text: 'أوجد جذر المعادلة <span class="math-eq">١٠ - ٥س = ٠</span>.',
                    options: [
                        { display: '<span class="math-eq">٢</span>', value: 'A' },
                        { display: '<span class="math-eq">-٢</span>', value: 'B' },
                        { display: '<span class="math-eq">٠.٥</span>', value: 'C' },
                        { display: '<span class="math-eq">٥</span>', value: 'D' }
                    ],
                    correct: 'A',
                    explanation: '<p>لإيجاد الجذر، نحل المعادلة. <span class="math-eq">١٠ - ٥س = ٠</span>. نضيف ٥س للطرفين: <span class="math-eq">١٠ = ٥س</span>. ثم نقسم ١٠ على ٥ لنجد أن س = ٢.</p>'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    topic: 'table-estimation',
                    text: `ما التقدير الأفضل للمقطع السيني للدالة الخطية الممثلة في الجدول التالي؟
                            <div class="flex justify-center my-2">
                                <table class="w-1/2 text-center border">
                                    <thead class="bg-gray-200"><tr><th class="p-1 border">س</th><th class="p-1 border">ص</th></tr></thead>
                                    <tbody>
                                        <tr><td class="p-1 border">٠</td><td class="p-1 border">٥</td></tr>
                                        <tr><td class="p-1 border">١</td><td class="p-1 border">٣</td></tr>
                                        <tr><td class="p-1 border">٢</td><td class="p-1 border">١</td></tr>
                                        <tr><td class="p-1 border">٣</td><td class="p-1 border">-١</td></tr>
                                        <tr><td class="p-1 border">٤</td><td class="p-1 border">-٣</td></tr>
                                    </tbody>
                                </table>
                            </div>`,
                    options: [
                        { display: 'بين ٠ و ١', value: 'A' },
                        { display: 'بين ٢ و ٣', value: 'B' },
                        { display: 'بين ١ و ٢', value: 'C' },
                        { display: 'بين ٣ و ٤', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: `
                        <p class="mb-2">المقطع السيني (صفر الدالة) يحدث عندما تتغير إشارة (ص) من موجبة إلى سالبة. بالنظر إلى الجدول، نجد أن قيمة (ص) كانت ١ (موجبة) عندما كانت س = ٢، وأصبحت -١ (سالبة) عندما أصبحت س = ٣. لذلك، لا بد أن الخط قد قطع محور السينات في نقطة ما بين س=٢ و س=٣.</p>
                        <h4 class="font-bold mt-4 mb-2">توضيح مرئي:</h4>
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <svg id="animation-canvas" viewBox="-2 -6 8 12" class="w-full h-64 bg-white border rounded-lg"></svg>
                            <div class="mt-2 grid grid-cols-3 gap-2">
                                <button id="modal-prev-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">السابق</button>
                                <button id="modal-next-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">التالي</button>
                                <button id="modal-reset-btn" class="w-full bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">إعادة</button>
                            </div>
                        </div>
                    `
                },
                {
                    type: 'mcq', level: '⭐', topic: 'related-function', text: 'ما هي الدالة المرتبطة بالمعادلة <span class="math-eq">-٢س + ٧ = ٠</span>؟',
                    options: [
                        { display: '<span class="math-eq">د(س) = ٢س + ٧</span>', value: 'A' },
                        { display: '<span class="math-eq">د(س) = -٢س + ٧</span>', value: 'B' },
                        { display: '<span class="math-eq">د(س) = -٢س - ٧</span>', value: 'C' },
                        { display: '<span class="math-eq">د(س) = ٧</span>', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>بما أن أحد طرفي المعادلة يساوي صفرًا بالفعل، فإننا ببساطة نستبدل الصفر بـ <span class="math-eq">د(س)</span> للحصول على الدالة المرتبطة: <span class="math-eq">د(س) = -٢س + ٧</span>.</p>'
                },
                 {
                    type: 'mcq', level: '⭐⭐', topic: 'graph-reading', text: 'من الرسم البياني، ما هو صفر الدالة؟',
                    graph: '<svg viewBox="-5 -5 10 10" class="w-full h-40 bg-white border rounded-lg mt-2"><path d="M -5,1 L 5,1 M -5,2 L 5,2 M -5,3 L 5,3 M -5,4 L 5,4 M -5,-1 L 5,-1 M -5,-2 L 5,-2 M -5,-3 L 5,-3 M -5,-4 L 5,-4" stroke="#d1d5db" stroke-width="0.15" /><path d="M 1,-5 L 1,5 M 2,-5 L 2,5 M 3,-5 L 3,5 M 4,-5 L 4,5 M -1,-5 L -1,5 M -2,-5 L -2,5 M -3,-5 L -3,5 M -4,-5 L -4,5" stroke="#d1d5db" stroke-width="0.15" /><line x1="-5" y1="0" x2="5" y2="0" stroke="#9ca3af" stroke-width="0.2" /><line x1="0" y1="-5" x2="0" y2="5" stroke="#9ca3af" stroke-width="0.2" /><line x1="-5" y1="2" x2="1" y2="-4" stroke="#3b82f6" stroke-width="0.4" /><circle cx="-3" cy="0" r="0.3" fill="#ef4444" /></svg>',
                    options: [
                        { display: '<span class="math-eq">س = ٢</span>', value: 'A' },
                        { display: '<span class="math-eq">س = -٣</span>', value: 'B' },
                        { display: '<span class="math-eq">س = -١</span>', value: 'C' },
                        { display: '<span class="math-eq">س = ٠</span>', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>بالنظر إلى الرسم البياني، نجد أن الخط المستقيم يتقاطع مع محور السينات عند النقطة <span class="math-eq">س = -٣</span>. لذا، صفر هذه الدالة هو -٣.</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐⭐', topic: 'solve-equation', text: 'إذا كان صفر الدالة <span class="math-eq">د(س) = ك س - ١٢</span> هو ٤، فما قيمة الثابت (ك)؟',
                    options: [
                        { display: '<span class="math-eq">٣</span>', value: 'A' },
                        { display: '<span class="math-eq">-٣</span>', value: 'B' },
                        { display: '<span class="math-eq">٤</span>', value: 'C' },
                        { display: '<span class="math-eq">١٢</span>', value: 'D' }
                    ],
                    correct: 'A',
                    explanation: '<p>معنى أن صفر الدالة هو ٤، أنه عند <span class="math-eq">س = ٤</span>، تكون <span class="math-eq">د(س) = ٠</span>. نعوض في المعادلة: <span class="math-eq">٠ = ك(٤) - ١٢</span>. نضيف ١٢ للطرفين: <span class="math-eq">١٢ = ٤ك</span>. لإيجاد قيمة ك، نقسم ١٢ على ٤، فتكون قيمة ك = ٣.</p>'
                },
                {
                    type: 'mcq', level: '⭐', topic: 'concept', text: 'مرادف كلمة "جذر" المعادلة هو...',
                    options: [
                        { display: 'ميل الدالة', value: 'A' },
                        { display: 'صفر الدالة', value: 'B' },
                        { display: 'مدى الدالة', value: 'C' },
                        { display: 'مجال الدالة', value: 'D' }
                    ],
                    correct: 'B',
                    explanation: '<p>جذر المعادلة، وحل المعادلة، وصفر الدالة المرتبطة بها، كلها مصطلحات تشير إلى نفس القيمة، وهي المقطع السيني للرسم البياني.</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐', topic: 'solve-equation', text: 'حل المعادلة <span class="inline-flex flex-col text-center leading-tight align-middle"><span>س</span><span class="border-t border-current w-full"></span><span>٢</span></span> + ٥ = ٠ هو:',
                    options: [
                        { display: '<span class="math-eq">١٠</span>', value: 'A' },
                        { display: '<span class="math-eq">-٥</span>', value: 'B' },
                        { display: '<span class="math-eq">-٢.٥</span>', value: 'C' },
                        { display: '<span class="math-eq">-١٠</span>', value: 'D' }
                    ],
                    correct: 'D',
                    explanation: '<p>لحل المعادلة، نطرح ٥ من الطرفين: <span class="inline-flex flex-col text-center leading-tight align-middle"><span>س</span><span class="border-t border-current w-full"></span><span>٢</span></span> = -٥. ثم نضرب الطرفين في ٢ للتخلص من المقام: س = -١٠.</p>'
                },
                {
                    type: 'mcq', level: '⭐⭐⭐', topic: 'real-life', text: 'ينقص خزان ماء بمعدل ثابت. يمكن تمثيل كمية الماء (ل) باللتر بعد (ز) ساعة بالدالة <span class="math-eq">ل(ز) = ٥٠٠ - ٢٥ز</span>. ماذا يمثل صفر هذه الدالة؟',
                    options: [
                        { display: 'كمية الماء الأولية', value: 'A' },
                        { display: 'معدل النقصان في الساعة', value: 'B' },
                        { display: 'الوقت الذي يفرغ فيه الخزان', value: 'C' },
                        { display: 'نصف كمية الماء', value: 'D' }
                    ],
                    correct: 'C',
                    explanation: '<p>صفر الدالة هو قيمة (ز) التي تجعل كمية الماء (ل) تساوي صفرًا. في هذا السياق، هو يمثل الزمن اللازم حتى تصبح كمية الماء في الخزان صفرًا، أي الوقت الذي يفرغ فيه الخزان تمامًا.</p>'
                }
            ];
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            const questionCount = Math.min(shuffled.length, 5);
            return shuffled.slice(0, questionCount);
        }

        // 3. تشغيل وإعداد الدرس
        const student = getStudentFromStorage();
        buildHeader(student, LESSON_TITLE);
        buildFooter();
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        
        // 4. ربط الأحداث والأزرار
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
        
        // 5. كود مخصص للرسوم المتحركة في هذا الدرس
        // الرسوم المتحركة للجزء الثاني (الرئيسي)
        const nextStepBtn = document.getElementById('next-step-btn');
        const prevStepBtn = document.getElementById('prev-step-btn');
        const resetStepBtn = document.getElementById('reset-step-btn');
        const tableBody = document.getElementById('interactive-table-body');
        const graph = document.getElementById('interactive-graph');
        let animationStep = 0;
        const animationData = [
            { s: '٢', calc: '٢(<span class="highlight-s">٢</span>) - ٨ = -٤', res: '-٤', point: {x: 2, y: -4}, color: '#1d4ed8'},
            { s: '٤', calc: '٢(<span class="highlight-s">٤</span>) - ٨ = ٠', res: '٠', point: {x: 4, y: 0}, color: '#ef4444'},
            { s: '٥', calc: '٢(<span class="highlight-s">٥</span>) - ٨ = ٢', res: '٢', point: {x: 5, y: 2}, color: '#1d4ed8'}
        ];
        
        function drawGraphState(isAnimating = false) {
            initializeGraph();
            const graphConclusion = document.getElementById('graph-conclusion');
            graphConclusion.classList.add('hidden');
            const animationPromises = [];

            for (let i = 0; i < animationStep; i++) {
                const data = animationData[i];
                const px = data.point.x;
                const py = -data.point.y; 

                if (isAnimating && i === animationStep - 1) {
                    const promise = new Promise(resolve => {
                        const durationX = Math.abs(px) * 0.2;
                        const durationY = Math.abs(py) * 0.2;
                        
                        const pathX = createAnimatedPath(`M 0 0 H ${px}`, durationX);
                        graph.appendChild(pathX);
                        pathX.firstElementChild.beginElement();

                        setTimeout(() => {
                            const pathY = createAnimatedPath(`M ${px} 0 V ${py}`, durationY);
                            graph.appendChild(pathY);
                            pathY.firstElementChild.beginElement();

                            setTimeout(() => {
                                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                                circle.setAttribute('cx', px);
                                circle.setAttribute('cy', py);
                                circle.setAttribute('r', 0.3);
                                circle.setAttribute('fill', data.color);
                                graph.appendChild(circle);
                                resolve();
                            }, durationY * 1000);
                        }, durationX * 1000);
                    });
                    animationPromises.push(promise);
                } else {
                    const pathX = createStaticPath(`M 0 0 H ${px}`);
                    const pathY = createStaticPath(`M ${px} 0 V ${py}`);
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute('cx', px);
                    circle.setAttribute('cy', py);
                    circle.setAttribute('r', 0.3);
                    circle.setAttribute('fill', data.color);
                    graph.appendChild(pathX);
                    graph.appendChild(pathY);
                    graph.appendChild(circle);
                }
            }

            Promise.all(animationPromises).then(() => {
                if (animationStep === animationData.length) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute('x1', 1);
                    line.setAttribute('y1', 6);
                    line.setAttribute('x2', 6);
                    line.setAttribute('y2', -4);
                    line.setAttribute('stroke', '#3b82f6');
                    line.setAttribute('stroke-width', '0.4');
                    graph.insertBefore(line, graph.firstChild);
                    graphConclusion.classList.remove('hidden');
                }
            });
        }

        function createStaticPath(d) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute('d', d);
            path.setAttribute('stroke', '#a78bfa');
            path.setAttribute('stroke-width', '0.2');
            path.setAttribute('stroke-dasharray', '0.4 0.4');
            path.setAttribute('fill', 'none');
            return path;
        }

        function createAnimatedPath(d, dur) {
            const path = createStaticPath(d);
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;
            
            const animate = document.createElementNS("http://www.w3.org/2000/svg", "animate");
            animate.setAttribute('attributeName', 'stroke-dashoffset');
            animate.setAttribute('from', length);
            animate.setAttribute('to', '0');
            animate.setAttribute('dur', `${dur}s`);
            animate.setAttribute('fill', 'freeze');
            path.appendChild(animate);
            return path;
        }
        
        function updateTable() {
            tableBody.innerHTML = '';
             for (let i = 0; i < animationStep; i++) {
                const data = animationData[i];
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td class="border border-slate-300 p-2 align-middle text-center font-bold highlight-s">${data.s}</td>
                    <td class="border border-slate-300 p-2 align-middle text-center"><span class="math-eq">${data.calc}</span></td>
                    <td class="border border-slate-300 p-2 align-middle text-center"><span class="math-eq">(${data.s}, ${data.res})</span></td>
                `;
             }
        }

        function updateButtons() {
            const tableConclusion = document.getElementById('table-conclusion');
            prevStepBtn.disabled = animationStep === 0;
            nextStepBtn.disabled = animationStep === animationData.length;
            
            prevStepBtn.classList.toggle('btn-disabled', prevStepBtn.disabled);
            
            nextStepBtn.classList.toggle('btn-disabled', nextStepBtn.disabled);

            nextStepBtn.textContent = (animationStep === animationData.length) ? 'اكتمل الشرح' : 'التالي';
            
            if (animationStep >= 2) {
                tableConclusion.classList.remove('hidden');
            } else {
                tableConclusion.classList.add('hidden');
            }
        }

        function handleNextStep() {
            if (animationStep < animationData.length) {
                animationStep++;
                updateTable();
                drawGraphState(true);
                updateButtons();
            }
        }

        function handlePrevStep() {
            if (animationStep > 0) {
                animationStep--;
                updateTable();
                drawGraphState(false);
                updateButtons();
            }
        }

        function resetAnimation() {
            animationStep = 0;
            updateTable();
            initializeGraph();
            updateButtons();
        }

        function initializeGraph() {
            graph.innerHTML = '';
            let gridHtml = '';
            for(let i = -9; i <= 9; i++) {
                if (i === 0) continue;
                gridHtml += `<line x1="-10" y1="${i}" x2="10" y2="${i}" stroke="#d1d5db" stroke-width="0.15" />`;
                gridHtml += `<line x1="${i}" y1="-10" x2="${i}" y2="10" stroke="#d1d5db" stroke-width="0.15" />`;
            }
            gridHtml += '<line x1="-10" y1="0" x2="10" y2="0" stroke="#6b7280" stroke-width="0.2"/>';
            gridHtml += '<line x1="0" y1="-10" x2="0" y2="10" stroke="#6b7280" stroke-width="0.2"/>';
            gridHtml += '<text x="9.5" y="-0.5" font-size="0.8" fill="#374151" font-weight="bold">س</text>';
            gridHtml += '<text x="0.5" y="-9.5" font-size="0.8" fill="#374151" font-weight="bold">ص</text>';
            graph.innerHTML = gridHtml;
        }

        // الرسوم المتحركة لنافذة الشرح في الاختبار
        let modalAnimationStep = 0;
        const modalAnimationData = [ {x: 0, y: 5}, {x: 1, y: 3}, {x: 2, y: 1}, {x: 3, y: -1}, {x: 4, y: -3} ];

        function drawModalGraphState() {
            const svg = document.getElementById('animation-canvas');
            if (!svg) return;
            const scaleY = (y) => -y;
            svg.innerHTML = ''; 

            svg.innerHTML += '<path d="M -1,0 L 6,0 M 0,-6 L 0,6" stroke="#cccccc" stroke-width="0.08"/>';
            for(let i = -1; i <= 5; i++) { svg.innerHTML += '<line x1="'+i+'" y1="-6" x2="'+i+'" y2="6" stroke="#e5e7eb" stroke-width="0.05" />'; }
            for(let i = -5; i <= 5; i++) { svg.innerHTML += '<line x1="-1" y1="'+i+'" x2="6" y2="'+i+'" stroke="#e5e7eb" stroke-width="0.05" />'; }
            
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute('x', 2);
            rect.setAttribute('y', -6);
            rect.setAttribute('width', 1);
            rect.setAttribute('height', 12);
            rect.setAttribute('fill', 'rgba(250, 204, 21, 0.3)');
            svg.appendChild(rect);
            svg.innerHTML += '<text x="2.5" y="-5" font-size="0.5" text-anchor="middle" fill="#ca8a04">الحل هنا</text>';

            for (let i = 0; i < modalAnimationStep; i++) {
                const p = modalAnimationData[i];
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute('cx', p.x);
                circle.setAttribute('cy', scaleY(p.y));
                circle.setAttribute('r', '0.15');
                circle.setAttribute('fill', '#dc2626');
                svg.appendChild(circle);

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute('x', p.x + 0.2);
                text.setAttribute('y', scaleY(p.y) - 0.2);
                text.setAttribute('font-size', '0.4');
                text.textContent = `(${p.x},${p.y})`;
                svg.appendChild(text);
            }

            if (modalAnimationStep === modalAnimationData.length) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('x1', modalAnimationData[0].x);
                line.setAttribute('y1', scaleY(modalAnimationData[0].y));
                line.setAttribute('x2', modalAnimationData[4].x);
                line.setAttribute('y2', scaleY(modalAnimationData[4].y));
                line.setAttribute('stroke', '#3b82f6');
                line.setAttribute('stroke-width', '0.1');
                svg.insertBefore(line, svg.firstChild);
            }
        }

        function updateModalButtons() {
            const prevBtn = document.getElementById('modal-prev-btn');
            const nextBtn = document.getElementById('modal-next-btn');
            if (!prevBtn || !nextBtn) return;

            prevBtn.disabled = modalAnimationStep === 0;
            nextBtn.disabled = modalAnimationStep === modalAnimationData.length;
            prevBtn.classList.toggle('btn-disabled', prevBtn.disabled);
            nextBtn.classList.toggle('btn-disabled', nextBtn.disabled);
        }

        function handleModalNext() {
            if (modalAnimationStep < modalAnimationData.length) {
                modalAnimationStep++;
                drawModalGraphState();
                updateModalButtons();
            }
        }

        function handleModalPrev() {
            if (modalAnimationStep > 0) {
                modalAnimationStep--;
                drawModalGraphState();
                updateModalButtons();
            }
        }

        function resetModalAnimation() {
            modalAnimationStep = 0;
            drawModalGraphState();
            updateModalButtons();
        }

        // ربط الأحداث العامة
        document.querySelector('#quizForm').addEventListener('click', function(event) {
            if (event.target.classList.contains('explain-btn')) {
                const index = event.target.getAttribute('data-question-index');
                showExplanation(index);
                if (currentQuestions[index].topic === 'table-estimation') {
                    modalAnimationStep = 0; 
                    const nextBtn = document.getElementById('modal-next-btn');
                    const prevBtn = document.getElementById('modal-prev-btn');
                    const resetBtn = document.getElementById('modal-reset-btn');
                    
                    if(nextBtn && prevBtn && resetBtn) {
                        nextBtn.addEventListener('click', handleModalNext);
                        prevBtn.addEventListener('click', handleModalPrev);
                        resetBtn.addEventListener('click', resetModalAnimation);
                    }
                    drawModalGraphState();
                    updateModalButtons();
                }
            }
        });
        
        closeModalBtn.addEventListener('click', closeModal);
        nextStepBtn.addEventListener('click', handleNextStep);
        prevStepBtn.addEventListener('click', handlePrevStep);
        resetStepBtn.addEventListener('click', resetAnimation);
        
        // --- Initial Load ---
        initializeGraph();
    });
    </script>
</body>
</html>


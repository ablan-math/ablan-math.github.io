<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الرياضيات التفاعلية | أ.عبدالعزيز خالد العبلان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grade-display.passed { background-color: #dcfce7; color: #166534; }
        .grade-display.failed { background-color: #fee2e2; color: #991b1b; }
        #app-container, #login-view {
            flex-grow: 1;
        }
        #login-view { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #app-container {
             display: grid; 
             grid-template-rows: auto 1fr; /* Header and Main content */
        }
        .social-icon {
            transition: transform 0.2s ease-in-out;
        }
        .social-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- حاوية تسجيل الدخول (تظهر في البداية) -->
    <div id="login-view">
        <main class="container mx-auto px-6 py-8">
            <div class="max-w-md mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-blue-800 mb-4">منصة الرياضيات التفاعلية</h1>
                    <p class="text-lg text-gray-600 mb-2">للمعلم: عبدالعزيز خالد العبلان</p>
                    <hr class="my-6">
                    <h2 class="text-2xl font-bold mb-2">أهلاً بك</h2>
                    <p class="text-gray-600 mb-6">أدخل رقم هويتك للدخول كطالب مسجل</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <input type="text" id="login-id" placeholder="رقم الهوية / الإقامة" class="w-full text-center text-lg px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 text-lg flex justify-center items-center transition-colors">
                            <span id="login-submit-text">دخول</span>
                            <div id="login-loader" class="loader hidden"></div>
                        </button>
                    </form>
                    <div id="login-error" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"></div>
                    <div class="mt-8">
                        <p class="text-gray-600 mb-2">أو</p>
                        <button id="visitor-btn" class="font-bold text-gray-700 hover:underline">المتابعة كزائر</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- حاوية التطبيق الرئيسية (تكون مخفية في البداية) -->
    <div id="app-container" class="hidden">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto px-6 py-8">
            <div id="dashboard-section" class="hidden bg-blue-50 p-6 rounded-lg shadow-lg mb-12 border-l-4 border-blue-500">
                <h3 class="text-2xl font-bold text-center mb-6">لوحة التحكم</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-bold text-blue-700 mb-3">معلوماتك المسجلة</h4>
                        <div class="bg-white p-4 rounded-lg border space-y-2">
                            <p><strong>الاسم:</strong> <span id="display-name"></span></p>
                            <p><strong>رقم الهوية:</strong> <span id="display-id"></span></p>
                            <p><strong>الصف:</strong> <span id="display-class"></span></p>
                            <p><strong>رقم الجوال:</strong> <span id="display-phone"></span></p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-blue-700 mb-3">ملخص الدرجات</h4>
                        <div class="bg-white p-4 rounded-lg border space-y-2">
                            <p><strong>مجموع الفصل الأول:</strong> <span id="total-c1" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الثاني:</strong> <span id="total-c2" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الثالث:</strong> <span id="total-c3" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الرابع:</strong> <span id="total-c4" class="font-bold">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold text-center mb-6">فهرس الفصول الدراسية</h3>
                <div id="accordion-container" class="space-y-4"></div>
            </div>
        </main>
    </div>
    
    <!-- التذييل الآن خارج الحاويات ليكون ظاهراً دائماً -->
    <footer id="main-footer" class="bg-gray-200 py-4"></footer>

    <script>
    (function() { // *** تم إضافة هذا السطر لتغليف الكود ***

        // =================================================================
        // == 1. الإعدادات والبيانات الأساسية
        // =================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const MAX_ATTEMPTS = 3;

        // =================================================================
        // == 2. دوال إدارة الواجهات (Views)
        // =================================================================
        function showAppView(studentData) {
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            if (loginView && appContainer) {
                loginView.style.display = 'none';
                appContainer.style.display = 'grid';
            }
            buildHeader(studentData);
            if (typeof curriculumIndex !== 'undefined') {
                buildAccordion(curriculumIndex, studentData);
            }
            if (studentData) {
                showStudentDashboard(studentData);
            }
        }

        function showLoginView() {
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            if (loginView && appContainer) {
                appContainer.style.display = 'none';
                loginView.style.display = 'flex';
            }
        }

        // =================================================================
        // == 3. دوال المصادقة والبيانات
        // =================================================================
        function getStudentFromStorage() {
            const studentDataString = localStorage.getItem('currentStudent');
            if (studentDataString) {
                try {
                    return JSON.parse(studentDataString);
                } catch (e) {
                    console.error("Error parsing student data", e);
                    localStorage.removeItem('currentStudent');
                    return null;
                }
            }
            return null;
        }

        function handleLogin(studentId) {
            const loader = document.getElementById('login-loader');
            const errorDiv = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}`)
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        showAppView(result.data);
                    } else {
                        errorDiv.textContent = 'رقم الهوية غير مسجل.';
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error("Login Error:", err);
                    errorDiv.textContent = 'خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.';
                    errorDiv.classList.remove('hidden');
                })
                .finally(() => {
                    loader.classList.add('hidden');
                    submitBtn.disabled = false;
                });
        }

        // =================================================================
        // == 4. دوال بناء مكونات الواجهة (UI Builders)
        // =================================================================
        function buildHeader(studentData) {
            const headerContainer = document.getElementById('main-header');
            if (!headerContainer) return;
            let userInfoHtml = '';
            if (studentData) {
                userInfoHtml = `
                    <div class="flex items-center gap-4">
                        <span class="font-semibold">أهلاً، ${studentData.name}</span>
                        <button id="logout-btn" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</button>
                    </div>`;
            } else {
                userInfoHtml = `
                    <div class="flex items-center gap-4">
                        <p class="text-lg text-gray-600">زائر</p>
                        <button id="visitor-login-btn" class="bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700">تسجيل الدخول كطالب</button>
                    </div>`;
            }
            headerContainer.innerHTML = `
                <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <a href="index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>
                    ${userInfoHtml}
                </div>`;
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('currentStudent');
                    showLoginView();
                });
            }

            const visitorLoginBtn = document.getElementById('visitor-login-btn');
            if (visitorLoginBtn) {
                visitorLoginBtn.addEventListener('click', () => {
                    showLoginView();
                });
            }
        }

        function buildFooter() {
            const footerContainer = document.getElementById('main-footer');
            if (!footerContainer) return;
            const shareText = encodeURIComponent('أدعوك للاستفادة من منصة الرياضيات التفاعلية للمعلم عبدالعزيز العبلان:');
            const pageUrl = encodeURIComponent("https://ablan-math.github.io/index.html");

            footerContainer.innerHTML = `
                <div class="container mx-auto px-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    <p class="text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p>
                    <div class="flex items-center space-x-4" dir="ltr">
                        <!-- Snapchat Share -->
                        <a href="https://www.snapchat.com/share?url=${pageUrl}" target="_blank" aria-label="Share on Snapchat" class="social-icon">
                            <svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#FFFC00"/><path d="M12.0118 6.66667C8.68183 6.66667 6 9.3485 6 12.6785C6 14.8385 7.15233 16.7385 8.88233 17.8485C8.96233 17.9085 9.05233 17.9485 9.14233 17.9485C9.28233 17.9485 9.42233 17.8785 9.51233 17.7485C9.66233 17.5385 9.60233 17.2385 9.39233 17.0885C7.98233 16.1485 7 14.5085 7 12.6785C7 9.8985 9.22183 7.66667 12.0118 7.66667C14.7918 7.66667 17.0218 9.8985 17.0218 12.6785C17.0218 14.5085 16.0318 16.1485 14.6218 17.0885C14.4118 17.2385 14.3518 17.5385 14.5018 17.7485C14.5918 17.8785 14.7318 17.9485 14.8718 17.9485C14.9618 17.9485 15.0518 17.9085 15.1418 17.8485C16.8618 16.7385 18.0218 14.8385 18.0218 12.6785C18.0218 9.3485 15.3418 6.66667 12.0118 6.66667Z" fill="white"/></svg>
                        </a>
                        <!-- Telegram Share -->
                        <a href="https://t.me/share/url?url=${pageUrl}&text=${shareText}" target="_blank" aria-label="Share on Telegram" class="social-icon">
                            <svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#2AABEE"/><path d="m9.417 15.181-.397 5.584c.568 0 .814-.244 1.109-.537l2.663-2.545 5.518 4.041c1.012.564 1.725.267 1.998-.931L22.43 5.218c.347-1.61-1.2-2.127-2.299-1.594L4.543 11.177c-1.636.682-1.66 1.32.285 1.721l4.252 1.325 9.46-5.924c.448-.277.855-.136.524.162z" fill="#fff"/></svg>
                        </a>
                        <!-- X (Twitter) Share -->
                        <a href="https://twitter.com/intent/tweet?text=${shareText}&url=${pageUrl}" target="_blank" aria-label="Share on Twitter" class="social-icon">
                            <svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#000"/><path d="m10.215 13.584-6.328 7.163h1.416l5.59-6.328 4.35 6.328h6.92l-6.7-9.74 6.13-6.95h-1.416l-5.18 5.86-4.01-5.86h-6.92l7.07 10.28zm-.76-1.13-1.42-2.02-5.1-7.25h2.15l4.2 5.97 1.42 2.02 5.43 7.72h-2.15l-4.58-6.5z" fill="#fff"/></svg>
                        </a>
                        <!-- WhatsApp Share -->
                        <a href="https://api.whatsapp.com/send?text=${shareText}%20${pageUrl}" target="_blank" aria-label="Share on WhatsApp" class="social-icon">
                           <svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#25D366" d="M12 2C6.477 2 2 6.477 2 12c0 1.742.448 3.385 1.253 4.814L2 22l5.186-1.253A9.93 9.93 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z"/><path fill="#FFF" d="M17.23 14.25c-.21-.12-.83-.41-1-.47-.16-.07-.3-.07-.42.12-.12.2-.4.48-.48.57-.08.1-.16.1-.28 0-.12-.07-.5-.18-1.03-.63-.8-.7-1.33-1.56-1.48-1.82-.15-.26-.02-.4.07-.53.08-.12.18-.3.27-.4.1-.1.12-.18.18-.3.06-.12.03-.23 0-.33-.03-.1-.28-.68-.38-1-.1-.31-.2-.26-.28-.26-.08 0-.18 0-.28 0-.1 0-.26.04-.4.2-.13.16-.52.5-.52 1.22 0 .72.53 1.42.6 1.52.08.1.92 1.47 2.4 2.1.37.16.66.25.88.32.22.07.42.06.58.02.18-.04.58-.24.7-.47.12-.24.12-.44.08-.48-.03-.05-.1-.07-.2-.1z"/></svg>
                        </a>
                        <span class="text-gray-600 text-sm">:شاركنا</span>
                    </div>
                </div>`;
        }

        function buildAccordion(curriculumIndex, studentData) {
            const accordionContainer = document.getElementById('accordion-container');
            if (!accordionContainer) return;
            accordionContainer.innerHTML = '';
            const studentLessons = studentData ? studentData.lessons || {} : {};
            Object.keys(curriculumIndex).forEach(chapterKey => {
                const chapter = curriculumIndex[chapterKey];
                const lessonsHtml = chapter.lessons.map(lesson => {
                    const lessonGradeData = studentLessons[lesson.id];
                    let gradeHtml = '';
                    if (studentData) {
                        const grade = lessonGradeData ? lessonGradeData.grade : '-';
                        const gradeClass = grade >= 5 ? 'passed' : (grade === '-' ? '' : 'failed');
                        gradeHtml = `<span id="grade-${lesson.id}" class="grade-display ${gradeClass} text-sm font-bold px-2 py-1 rounded">${grade}</span>`;
                    }
                    return `
                        <li class="flex justify-between items-center">
                            <a href="lessons/${lesson.id}.html" target="_top" class="lesson-link text-gray-600 hover:text-indigo-600 text-right">${lesson.title}</a>
                            ${gradeHtml}
                        </li>`;
                }).join('');
                const chapterHtml = `
                    <div class="border border-gray-200 rounded-lg">
                        <button class="chapter-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                            <h4 class="text-xl font-bold text-blue-700">${chapter.title}</h4>
                            <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="lessons-list hidden p-4 border-t border-gray-200">
                            <ul class="space-y-3">${lessonsHtml}</ul>
                        </div>
                    </div>`;
                accordionContainer.innerHTML += chapterHtml;
            });
            document.querySelectorAll('.chapter-toggle').forEach(btn => {
                btn.onclick = () => {
                    btn.nextElementSibling.classList.toggle('hidden');
                    btn.querySelector('svg').classList.toggle('rotate-180');
                };
            });
        }

        function showStudentDashboard(studentData) {
            const dashboardSection = document.getElementById('dashboard-section');
            if (!dashboardSection) return;
            dashboardSection.classList.remove('hidden');
            ['name', 'id', 'class', 'phone'].forEach(key => {
                const el = document.getElementById(`display-${key}`);
                if (el) el.textContent = studentData[key] || '-';
            });
            const totals = { c1: 0, c2: 0, c3: 0, c4: 0 };
            if (studentData.lessons) {
                Object.keys(studentData.lessons).forEach(lessonId => {
                    const chapterKey = lessonId.substring(0, 2);
                    if (totals.hasOwnProperty(chapterKey)) {
                        totals[chapterKey] += studentData.lessons[lessonId].grade;
                    }
                });
            }
            Object.keys(totals).forEach(key => {
                const totalEl = document.getElementById(`total-${key}`);
                if (totalEl) totalEl.textContent = totals[key] || 0;
            });
        }
        
        // *** تم تحديث الفهرس ليشمل جميع الدروس ***
        const curriculumIndex = {
            'c1': { 
                title: "الفصل ١: المعادلات الخطية",
                lessons: [
                    { id: 'c1_l1', title: 'الدرس ١-١: المعادلات' },
                    { id: 'c1_l2', title: 'الدرس ١-٢: حل المعادلات ذات الخطوة الواحدة' },
                    { id: 'c1_l3', title: 'الدرس ١-٣: حل المعادلات المتعددة الخطوات' },
                    { id: 'c1_l4', title: 'الدرس ١-٤: حل المعادلات التي تحتوي متغيراً في طرفيها' },
                    { id: 'c1_l5', title: 'الدرس ١-٥: حل المعادلات التي تتضمن القيمة المطلقة' },
                ]
            },
            'c2': {
                title: "الفصل ٢: العلاقات والدوال الخطية",
                lessons: [
                    { id: 'c2_l1', title: 'الدرس ٢-١: العلاقات' },
                    { id: 'c2_l2', title: 'الدرس ٢-٢: الدوال' },
                    { id: 'c2_l3', title: 'الدرس ٢-٣: تمثيل المعادلات الخطية بيانياً' },
                    { id: 'c2_l4', title: 'الدرس ٢-٤: حل المعادلات الخطية بيانياً' },
                    { id: 'c2_l5', title: 'الدرس ٢-٥: معدل التغير والميل' },
                    { id: 'c2_l6', title: 'الدرس ٢-٦: المتتابعات الحسابية كدوال خطية' },
                ]
            },
            'c3': {
                title: "الفصل ٣: الدوال الخطية",
                lessons: [
                    { id: 'c3_l1', title: 'الدرس ٣-١: تمثيل المعادلات المكتوبة بصيغة الميل والمقطع بيانياً' },
                    { id: 'c3_l2', title: 'الدرس ٣-٢: كتابة المعادلات بصيغة الميل والمقطع' },
                    { id: 'c3_l3', title: 'الدرس ٣-٣: كتابة المعادلات بصيغة الميل ونقطة' },
                    { id: 'c3_l4', title: 'الدرس ٣-٤: المستقيمات المتوازية والمتعامدة' },
                ]
            },
            'c4': {
                title: "الفصل ٤: المتباينات الخطية",
                lessons: [
                    { id: 'c4_l1', title: 'الدرس ٤-١: حل المتباينات بالجمع أو بالطرح' },
                    { id: 'c4_l2', title: 'الدرس ٤-٢: حل المتباينات بالضرب أو بالقسمة' },
                    { id: 'c4_l3', title: 'الدرس ٤-٣: حل المتباينات المتعددة الخطوات' },
                    { id: 'c4_l4', title: 'الدرس ٤-٤: حل المتباينات المركبة' },
                    { id: 'c4_l5', title: 'الدرس ٤-٥: حل المتباينات التي تتضمن القيمة المطلقة' },
                ]
            }
        };

        // نقطة انطلاق التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            const student = getStudentFromStorage();
            if (student) {
                showAppView(student);
            } else {
                showLoginView();
            }
            
            // بناء التذييل دائماً عند تحميل الصفحة
            buildFooter();

            // ربط الأحداث الخاصة بواجهة تسجيل الدخول
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('login-id').value.trim();
                if (studentId) handleLogin(studentId);
            });

            const visitorBtn = document.getElementById('visitor-btn');
            visitorBtn.addEventListener('click', () => {
                localStorage.removeItem('currentStudent');
                showAppView(null); // عرض لوحة التحكم كزائر
            });
        });

    })(); // *** تم إضافة هذا السطر لتغليف الكود ***
    </script>
</body>
</html>

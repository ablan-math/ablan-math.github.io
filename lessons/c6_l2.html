<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- SYSTEM COMPLIANCE LOG: AnswerKeys_Randomized=YES | RetryButton_Verified=YES | InstantName_Active=YES -->
    <title>٦-٢ قسمة وحيدات الحد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        const themeColor = {
            gradient: 'from-blue-600 to-blue-800', 
            icon: 'fa-graduation-cap', 
            text: 'text-blue-600',
            bg: 'bg-blue-50',
            hex: '#2563eb',
            chapterNum: '6' 
        };
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Math Styling */
        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        @media (min-width: 768px) { .math-eq { font-size: 1.1em; padding: 4px 12px; } }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .var-blue { color: #2563eb; } .op-purple { color: #9333ea; font-weight: 800; }
        .highlight-number { background-color: #fef9c3; color: #b45309; padding: 0 4px; border-radius: 3px; font-weight: bold; }
        
        /* Fix for superscripts */
        .tiny-sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.6em; margin-right: 1px; line-height: 0; font-family: 'Cairo', sans-serif; }
        .fix-pos { display: inline-flex; flex-direction: row; align-items: baseline; gap: 1px; direction: rtl; }
        .force-ltr { direction: ltr; display: inline-block; }
        
        /* ZERO VISIBILITY FIX */
        .visible-zero { 
            font-weight: 900; 
            font-size: 1.2em; 
            display: inline-block;
            transform: scale(1.2); 
        }
        .tiny-sup .visible-zero {
            font-size: 1.4em; 
            vertical-align: -1px;
        }

        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 4px; font-size: 0.85em; vertical-align: middle; }
        .fraction > span { padding: 0 2px; display: block; line-height: 1; }
        .fraction > .bar { border-top: 2px solid currentColor; height: 0; width: 100%; margin: 2px 0; }
        
        /* Fix exponent position in denominator */
        .fraction > span:last-child .tiny-sup {
            top: -0.2em !important; 
        }
        
        /* UI Components */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item span { margin-top: 2px; text-align: center; line-height: 1.1; max-width: 60px; }
        .nav-item.active { color: #2563eb; font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: #2563eb; border-radius: 4px 4px 0 0; }
        @media (min-width: 768px) { .nav-item { font-size: 0.8rem; } .nav-item svg, .nav-item i { font-size: 1.4rem; margin-bottom: 4px; } .nav-item span { max-width: none; } }
        
        /* Interactive & Quiz */
        .step-box { border-right: 3px solid #2563eb; background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } .step-interactive.active { display: block; opacity: 1; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #eff6ff; color: #2563eb; font-weight: bold; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        .error-hint { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        /* Results & Cards */
        .result-card-base { position: relative; overflow: hidden; padding: 1.5rem !important; transition: all 0.3s ease; }
        .result-card-base::before { font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-size: 8rem; z-index: 0; pointer-events: none; }
        .result-card-trophy { background-color: #fffbeb; border-color: #fcd34d; } .result-card-trophy::before { content: '\f091'; color: rgba(250, 204, 21, 0.15); }
        .result-card-star { background-color: #fff7ed; border-color: #fdba74; } .result-card-star::before { content: '\f005'; color: rgba(251, 146, 60, 0.15); }
        .result-card-retry { background-color: #fef2f2; border-color: #fca5a5; } .result-card-retry::before { content: '\f01e'; color: rgba(248, 113, 113, 0.15); }
        .gold-card { background: linear-gradient(135deg, #fffbeb 0%, #fff 100%); border: 2px solid #fcd34d !important; }
        .orange-card { background: linear-gradient(135deg, #fff7ed 0%, #fff 100%); border: 2px solid #fdba74 !important; }
        .red-card { background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); border: 2px solid #fca5a5 !important; }
        .normal-card { background: white; border: 2px solid #e5e7eb; }
        
        /* Loading */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #2563eb; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Debug Panel */
        #debug-panel { position: fixed; bottom: 80px; left: 10px; width: 300px; background: rgba(0,0,0,0.9); color: #00ff00; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; z-index: 9999; direction: ltr; max-height: 200px; overflow-y: auto; display: none; }
        
        /* Footer Credits */
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 80px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }
        .lesson-footer strong { color: #6b7280; }
        
        /* Vertical Flow Helpers */
        .v-step { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
        .v-arrow { color: #9ca3af; margin: 4px 0; font-size: 1.2rem; }

        /* --- GAME MODAL STYLES --- */
        #game-modal-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        #game-modal-content {
            background: white;
            width: 90%;
            height: 85%;
            max-width: 1200px;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
            position: relative;
        }
        #game-modal-content.fullscreen {
            width: 100%;
            height: 100%;
            border-radius: 0;
            max-width: none;
        }
        #game-modal-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #game-frame {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            border: none;
            background: #f3f4f6;
        }
        
        /* Minimized Bar */
        #minimized-game-bar {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: white;
            border: 2px solid;
            border-radius: 50px;
            padding: 8px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9998;
            cursor: pointer;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            transition: transform 0.2s;
            animation: slideInUp 0.3s ease-out;
        }
        #minimized-game-bar:hover {
            transform: translateY(-2px);
        }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Smart Identity Logic: Phase 1 (Immediate Execution) -->
    <script>
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                const name = params.get('name');
                if (name) {
                    window.__studentName = name;
                }
            } catch(e) { console.error("Identity Error", e); }
        })();
    </script>

    <!-- Header -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative bg-gradient-to-r from-blue-600 to-blue-800">
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <!-- Main Theme Icon -->
            <i id="header-bg-icon" class="fas fa-graduation-cap absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <span id="chapter-num-bg" class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">6</span>
            
            <!-- Standard Mathematical Pattern (Static & Subtle) -->
            <i class="fas fa-plus absolute top-10 left-1/4 text-xl text-white opacity-10 transform rotate-12"></i>
            <i class="fas fa-minus absolute bottom-8 right-1/3 text-xl text-white opacity-10 transform -rotate-6"></i>
            <i class="fas fa-times absolute top-6 right-10 text-lg text-white opacity-10"></i>
            <i class="fas fa-divide absolute bottom-5 left-10 text-lg text-white opacity-10 transform rotate-45"></i>
            <i class="fas fa-percent absolute top-1/2 left-1/3 text-sm text-white opacity-5"></i>
            <i class="fas fa-plus absolute bottom-12 right-6 text-sm text-white opacity-5"></i>
        </div>
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas fa-graduation-cap text-lg md:text-2xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">منصة الرياضيات التفاعلية</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">٦-٢</span>
                        <span>قسمة وحيدات الحد</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> 
                            <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> 
                    <!-- Default text will be replaced immediately if name exists in URL -->
                    <span id="student-name">مرحبا بك</span>
                    <script>
                        if(window.__studentName) {
                            document.getElementById('student-name').textContent = window.__studentName;
                        }
                    </script>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>رجوع</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- TAB 1: Quotient of Powers -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4"><span class="bg-blue-100 text-blue-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-blue-200 shadow-sm">١</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">قسمة القوى</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition"><div class="absolute top-0 right-0 w-1 h-full bg-blue-500"></div><p class="text-gray-600 text-sm md:text-lg mb-3">لقسمة قوتين لهما <strong>نفس الأساس</strong>، اطرح أس المقام من أس البسط.</p><div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner"><span class="math-eq text-xl"><span class="fraction"><span>أ&zwnj;<sup class="tiny-sup">م</sup></span><span class="bar"></span><span>أ&zwnj;<sup class="tiny-sup">ن</sup></span></span> = أ&zwnj;<sup class="tiny-sup">م - ن</sup></span></div></div>
            
            <!-- App 1.1 -->
            <div id="interactive-container-1-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ١-١: بسّط <span class="fraction text-base"><span>س&zwnj;<sup class="tiny-sup">٧</sup></span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٣</sup></span></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: الأساس والأسس</h4><p class="text-sm md:text-lg mb-2 text-center">الأساس هو (<span class="var-green">س</span>). عند القسمة نطرح الأسس.</p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: طرح الأسس</h4><p class="text-sm md:text-lg font-bold text-center bg-gray-100 p-2 rounded"><span class="var-green">س&zwnj;<sup class="tiny-sup">٧ - ٣</sup></span></p></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="var-green">س&zwnj;<sup class="tiny-sup">٤</sup></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>
            
            <!-- App 1.2 -->
            <div id="interactive-container-1-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ١-٢: بسّط <span class="fraction text-base"><span>ك&zwnj;<sup class="tiny-sup">٧</sup> م&zwnj;<sup class="tiny-sup">١٠</sup> ب&zwnj;</span><span class="bar"></span><span>ك&zwnj;<sup class="tiny-sup">٥</sup> م&zwnj;<sup class="tiny-sup">٣</sup> ب&zwnj;</span></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: تجميع الحدود</h4><p class="text-sm md:text-lg mb-2 text-center">(<span class="fraction"><span>ك&zwnj;<sup class="tiny-sup">٧</sup></span><span class="bar"></span><span>ك&zwnj;<sup class="tiny-sup">٥</sup></span></span>)(<span class="fraction"><span>م&zwnj;<sup class="tiny-sup">١٠</sup></span><span class="bar"></span><span>م&zwnj;<sup class="tiny-sup">٣</sup></span></span>)(<span class="fraction"><span>ب&zwnj;<sup class="tiny-sup">١</sup></span><span class="bar"></span><span>ب&zwnj;<sup class="tiny-sup">١</sup></span></span>)</p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: طرح الأسس والاختصار</h4><p class="text-sm md:text-lg font-bold text-center bg-gray-100 p-2 rounded"><span class="var-green">ك&zwnj;<sup class="tiny-sup">٢</sup></span> <span class="var-blue">م&zwnj;<sup class="tiny-sup">٧</sup></span></p><div class="text-xs md:text-sm text-gray-700 bg-yellow-50 p-2 rounded border border-yellow-200 mt-2 text-center"><i class="fas fa-lightbulb text-yellow-500 ml-1"></i> لاحظ: ب ÷ ب = ١ (يتم اختصار المتغير ب من البسط والمقام).</div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="var-green">ك&zwnj;<sup class="tiny-sup">٢</sup></span> <span class="var-blue">م&zwnj;<sup class="tiny-sup">٧</sup></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>
            <button onclick="switchTab('learn2')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>التالي: قوة ناتج القسمة</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- TAB 2: Power of Quotient -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4"><span class="bg-purple-100 text-purple-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-purple-200 shadow-sm">٢</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">قوة ناتج القسمة</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition"><div class="absolute top-0 right-0 w-1 h-full bg-purple-500"></div><p class="text-gray-600 text-sm md:text-lg mb-3">لإيجاد قوة ناتج قسمة، <strong>وزع الأس</strong> على كل من البسط والمقام.</p><div class="text-center py-3 bg-purple-50 rounded-lg text-purple-900 mb-2 border border-purple-100 shadow-inner"><span class="math-eq text-xl">(<span class="fraction"><span>أ</span><span class="bar"></span><span>ب</span></span>)<sup class="tiny-sup">ن</sup> = <span class="fraction"><span>أ&zwnj;<sup class="tiny-sup">ن</sup></span><span class="bar"></span><span>ب&zwnj;<sup class="tiny-sup">ن</sup></span></span></span></div></div>
            
            <!-- App 2.1 -->
            <div id="interactive-container-2-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٢-١: بسّط <span class="math-eq">(<span class="fraction"><span>س&zwnj; ف&zwnj;</span><span class="bar"></span><span>ص&zwnj;</span></span>)<sup class="tiny-sup">٤</sup></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس ٤</h4><p class="text-sm md:text-lg text-center">نوزع الأس (٤) على كل متغير داخل القوس.</p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: التطبيق</h4><p class="text-sm md:text-lg font-bold text-center"><span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٤</sup> ف&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٤</sup></span></span></p></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٤</sup>ف&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٤</sup></span></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-blue-600 rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>
            
            <!-- App 2.2 -->
            <div id="interactive-container-2-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٢-٢: بسّط <span class="math-eq">(<span class="fraction"><span>٢ص&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٣د&zwnj;<sup class="tiny-sup">٣</sup></span></span>)<sup class="tiny-sup">٢</sup></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس ٢</h4><p class="text-sm md:text-lg text-center"><span class="fraction"><span><span class="fix-pos num-red">٢<sup class="tiny-sup">٢</sup></span> (ص&zwnj;<sup class="tiny-sup">٢</sup>)<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span><span class="fix-pos num-red">٣<sup class="tiny-sup">٢</sup></span> (د&zwnj;<sup class="tiny-sup">٣</sup>)<sup class="tiny-sup">٢</sup></span></span></p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: حساب القوى</h4><p class="text-sm md:text-lg font-bold text-center"><span class="fraction"><span>٤ ص&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>٩ د&zwnj;<sup class="tiny-sup">٦</sup></span></span></p></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>٤ص&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>٩د&zwnj;<sup class="tiny-sup">٦</sup></span></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>

            <!-- App 2.3 -->
            <div id="interactive-container-2-3" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٢-٣: بسّط <span class="math-eq">(<span class="fraction"><span>٢س&zwnj; ص&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٣س&zwnj; ص&zwnj;</span></span>)<sup class="tiny-sup">٣</sup></span></h3><span class="text-[10px] md:text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">تحدي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس ٣</h4><p class="text-sm md:text-lg text-center bg-gray-100 p-2 rounded"><span class="fraction"><span><span class="fix-pos num-red">٢<sup class="tiny-sup">٣</sup></span> س&zwnj;<sup class="tiny-sup">٣</sup> (ص&zwnj;<sup class="tiny-sup">٢</sup>)<sup class="tiny-sup">٣</sup></span><span class="bar"></span><span><span class="fix-pos num-red">٣<sup class="tiny-sup">٣</sup></span> س&zwnj;<sup class="tiny-sup">٣</sup> ص&zwnj;<sup class="tiny-sup">٣</sup></span></span></p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: فك القوى</h4><p class="text-sm md:text-lg font-bold text-center"><span class="fraction"><span>٨ س&zwnj;<sup class="tiny-sup">٣</sup> ص&zwnj;<sup class="tiny-sup">٦</sup></span><span class="bar"></span><span>٢٧ س&zwnj;<sup class="tiny-sup">٣</sup> ص&zwnj;<sup class="tiny-sup">٣</sup></span></span></p></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٣: التبسيط (طرح الأسس)</h4><div class="v-step"><p class="text-sm text-center">س³ ÷ س³ = ١ (يختفي)</p><p class="text-sm text-center">ص⁶ ÷ ص³ = ص³</p></div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>٨ص&zwnj;<sup class="tiny-sup">٣</sup></span><span class="bar"></span><span>٢٧</span></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>

            <button onclick="switchTab('learn3')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>التالي: الأس الصفري</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- TAB 3: Zero Exponent -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4"><span class="bg-teal-100 text-teal-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-teal-200 shadow-sm">٣</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">الأس الصفري</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition"><div class="absolute top-0 right-0 w-1 h-full bg-teal-500"></div><p class="text-gray-600 text-sm md:text-lg mb-3"><strong>القاعدة:</strong> أي عدد (غير الصفر) أس صفر = ١.</p><div class="text-center py-3 bg-teal-50 rounded-lg text-teal-900 mb-2 border border-teal-100 shadow-inner"><span class="math-eq text-lg">س&zwnj;<sup class="tiny-sup visible-zero">٠</sup> = <span class="visible-zero">١</span></span></div></div>
            
            <!-- App 3.1 (Updated: Proof of Zero Exponent) -->
            <div id="interactive-container-3-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٣-١: لماذا الناتج ١؟ <span class="math-eq">(<span class="fraction"><span>٢س&zwnj;</span><span class="bar"></span><span>ص&zwnj;</span></span>)<sup class="tiny-sup visible-zero">٠</sup></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" لمعرفة البرهان</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: توزيع الأس (صفر)</h4><div class="v-step"><p class="text-sm text-center">نوزع الأس صفر على جميع الحدود (الأعداد والمتغيرات).</p><p class="text-center font-bold math-eq"><span class="fraction"><span><span class="fix-pos">٢<sup class="tiny-sup visible-zero">٠</sup></span> س&zwnj;<sup class="tiny-sup visible-zero">٠</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup visible-zero">٠</sup></span></span></p></div></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: حساب قيم الحدود</h4><div class="v-step"><p class="text-sm text-center">بما أن أي مقدار أس صفر = ١، فإن:</p><p class="text-center font-bold math-eq"><span class="fraction"><span>١ · ١</span><span class="bar"></span><span>١</span></span></p></div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq visible-zero">١</span></p><div class="text-xs md:text-sm text-gray-700 bg-yellow-50 p-2 rounded border border-yellow-200 mt-2 text-center"><i class="fas fa-lightbulb text-yellow-500 ml-1"></i> <strong>ملاحظة:</strong> الخطوات السابقة للإقناع فقط. في الحل، إذا رأيت القوس كاملاً أس صفر، فالناتج ١ مباشرة!</div></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>
            
            <!-- App 3.2 (Restored) -->
            <div id="interactive-container-3-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٣-٢: بسّط <span class="math-eq">(<span class="fraction"><span>١٢م&zwnj;<sup class="tiny-sup">٨</sup>ن&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>ج&zwnj;<sup class="tiny-sup">٥</sup></span></span>)<sup class="tiny-sup visible-zero">٠</sup></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">الملاحظة الذكية:</h4><div class="v-step"><p class="text-sm md:text-xl text-center bg-gray-100 p-3 rounded font-bold w-full">القوس بالكامل مرفوع للأس <span class="num-red visible-zero">٠</span>.</p></div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq visible-zero">١</span></p><p class="text-xs text-center mt-2">لأن المقدار داخل القوس لا يساوي صفراً.</p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>
            <button onclick="switchTab('learn4')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>التالي: الأس السالب</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- TAB 4: Negative Exponent -->
        <div id="tab-learn4" class="tab-content hidden">
             <div class="flex items-center gap-2 mb-4"><span class="bg-red-100 text-red-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-red-200 shadow-sm">٤</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">الأس السالب</h2></div>
             <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition"><div class="absolute top-0 right-0 w-1 h-full bg-red-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3"><strong>القاعدة:</strong> للتخلص من الأس السالب، اقلب المقدار (البسط يصبح مقاماً والعكس).</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                     <div class="text-center py-3 bg-red-50 rounded-lg text-red-900 border border-red-100 shadow-inner">
                         <span class="block text-xs text-gray-500 mb-1">المقلوب</span>
                         <span class="math-eq text-lg">س&zwnj;<sup class="tiny-sup fix-pos">-٥</sup> = <span class="fraction"><span>١</span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٥</sup></span></span></span>
                     </div>
                     <div class="text-center py-3 bg-red-50 rounded-lg text-red-900 border border-red-100 shadow-inner">
                         <span class="block text-xs text-gray-500 mb-1">قلب الكسر</span>
                         <span class="math-eq text-lg">(<span class="fraction"><span>٢</span><span class="bar"></span><span>٣</span></span>)<sup class="tiny-sup fix-pos">-٢</sup> = (<span class="fraction"><span>٣</span><span class="bar"></span><span>٢</span></span>)<sup class="tiny-sup">٢</sup></span>
                     </div>
                     <div class="text-center py-3 bg-red-50 rounded-lg text-red-900 border border-red-100 shadow-inner">
                         <span class="block text-xs text-gray-500 mb-1">تبديل المواقع</span>
                         <span class="math-eq text-lg"><span class="fraction"><span>س&zwnj;<sup class="tiny-sup fix-pos">-ن</sup></span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup fix-pos">-م</sup></span></span> = <span class="fraction"><span>س&zwnj;<sup class="tiny-sup">م</sup></span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">ن</sup></span></span></span>
                     </div>
                </div>
             </div>
            
            <!-- App 4.1 -->
            <div id="interactive-container-4-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٤-١: بسّط <span class="math-eq"><span class="fraction"><span>م&zwnj;<sup class="tiny-sup fix-pos">-٤</sup></span><span class="bar"></span><span>م&zwnj;<sup class="tiny-sup fix-pos">-١</sup></span></span></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: تغيير الأماكن</h4><div class="v-step"><p class="text-sm md:text-lg text-center">ارفع <span class="text-red-600">م⁻¹</span> للبسط، وأنزل <span class="text-red-600">م⁻⁴</span> للمقام لتصبح الأسس موجبة.</p><p class="text-center font-bold math-eq"><span class="fraction"><span>م&zwnj;<sup class="tiny-sup">١</sup></span><span class="bar"></span><span>م&zwnj;<sup class="tiny-sup">٤</sup></span></span></p></div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي (بعد التبسيط)</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>١</span><span class="bar"></span><span>م&zwnj;<sup class="tiny-sup">٣</sup></span></span></span></p><p class="text-[10px] text-gray-500 text-center mt-1">(طرحنا ١ من ٤ في المقام)</p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>

            <!-- App 4.2 -->
            <div id="interactive-container-4-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٤-٢: بسّط <span class="math-eq">(<span class="fraction"><span>٣س&zwnj;</span><span class="bar"></span><span>٤ص&zwnj;</span></span>)<sup class="tiny-sup fix-pos">-٢</sup></span></h3><span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">تفاعلي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: قلب الكسر</h4><div class="v-step"><p class="text-sm md:text-lg text-center">نقلب الكسر كاملاً (البسط مقام والمقام بسط) ليصبح الأس موجباً.</p><p class="text-center font-bold math-eq">(<span class="fraction"><span>٤ص&zwnj;</span><span class="bar"></span><span>٣س&zwnj;</span></span>)<sup class="tiny-sup">٢</sup></p></div></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: توزيع التربيع</h4><p class="text-center font-bold math-eq"><span class="fraction"><span>١٦ ص&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٩ س&zwnj;<sup class="tiny-sup">٢</sup></span></span></p></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>١٦ص&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٩س&zwnj;<sup class="tiny-sup">٢</sup></span></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>

            <!-- App 4.3 -->
            <div id="interactive-container-4-3" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-blue-800 text-sm md:text-lg">تطبيق ٤-٣: بسّط <span class="fraction text-base"><span>ن&zwnj;<sup class="tiny-sup fix-pos">-٥</sup> ف&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>ر&zwnj;<sup class="tiny-sup fix-pos">-٢</sup></span></span></h3><span class="text-[10px] md:text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">تحدي</span></div><div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4"><div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">اضغط "التالي" للحل</div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ١: تحديد الأسس السالبة</h4><div class="v-step"><p class="text-sm md:text-lg text-center font-bold">ن&zwnj;<sup class="tiny-sup fix-pos">-٥</sup> (في البسط) ، ر&zwnj;<sup class="tiny-sup fix-pos">-٢</sup> (في المقام)</p></div></div><div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">خطوة ٢: تغيير الأماكن</h4><div class="v-step"><i class="fas fa-exchange-alt v-arrow"></i><p class="text-sm md:text-lg font-bold text-center w-full bg-yellow-50 p-2 rounded">أنزل <span class="text-red-600">ن</span> للمقام، وارفع <span class="text-red-600">ر</span> للبسط.</p><p class="text-sm text-gray-600">تتحول الإشارة للسالبة إلى موجبة.</p></div></div><div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">الناتج النهائي</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq"><span class="fraction"><span>ف&zwnj;<sup class="tiny-sup">٤</sup> ر&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>ن&zwnj;<sup class="tiny-sup">٥</sup></span></span></span></p></div></div><div class="flex justify-between"><button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">التالي</button><button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button></div></div>

            <div class="mt-4 text-center"><button onclick="switchTab('quiz')" class="bg-green-600 text-white px-8 py-3 md:py-4 rounded-full text-sm md:text-lg font-bold shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2 mx-auto w-full max-w-xs animate-bounce"><span>جاهز للاختبار؟</span><i data-lucide="arrow-left"></i></button></div>
        </div>

        <!-- QUIZ TAB -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">اختبار الفهم</h2><p class="text-xs md:text-sm text-gray-500">5 أسئلة مختارة بدقة</p></div>
                    <div class="text-center"><div id="loading-attempts" class="hidden"><div class="loader w-4 h-4"></div></div><div id="attempts-display" class="flex flex-col items-center"><span class="block text-xl md:text-2xl font-bold text-purple-600" id="attempts-count">-</span><div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>محاولات</span></div><span id="sync-status" class="w-2 h-2 rounded-full bg-gray-300 mt-1" title="حالة الاتصال"></span></div><div id="timer-top-container" class="hidden mt-1"><span class="block text-xs font-bold text-red-500 font-mono" id="timer-display-top">00:00:00</span></div></div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto">
                    <div class="result-content"><p class="text-sm text-gray-600 font-bold mb-1">الدرجة النهائية</p><p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p><div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div><div class="mt-4"><div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block"><span class="block text-lg font-bold text-red-600 font-mono tracking-wider" id="timer-display-bottom">00:00:00</span></div></div></div>
                </div>
                <!-- Game Container -->
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"></div>
                </div>
            </div>
        </div>
        
        <footer class="lesson-footer"><p>تصميم وإعداد: <strong>أ. عبدالعزيز خالد العبلان</strong></p><p class="mt-1 opacity-70">جميع الحقوق محفوظة © 2025</p></footer>
        <div class="h-20"></div>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 transform transition-transform duration-300 shadow-2xl"><div class="flex justify-between mb-4 items-center"><div class="flex items-center gap-2" style="color: var(--theme-hex)"><i id="modal-icon" data-lucide="info" class="w-5 h-5"></i><h3 id="modal-title" class="font-bold text-lg">توضيح</h3></div><button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div></div></div>

    <!-- Game Modal Structure -->
    <div id="game-modal-container">
        <div id="game-modal-content">
            <div id="game-modal-header" class="bg-gradient-to-r from-blue-600 to-blue-800">
                <div class="flex items-center gap-2">
                    <i class="fas fa-gamepad"></i>
                    <span id="game-modal-title" class="font-bold"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="minimizeGameModal()" class="p-1 hover:bg-white/20 rounded" title="تصغير"><i class="fas fa-minus"></i></button>
                    <button onclick="toggleGameFullscreen()" class="p-1 hover:bg-white/20 rounded" title="ملء الشاشة"><i class="fas fa-expand"></i></button>
                    <button onclick="closeGameModal()" class="p-1 hover:bg-red-500 rounded" title="إغلاق"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <iframe id="game-frame" src=""></iframe>
        </div>
    </div>

    <!-- Minimized Game Bar -->
    <div id="minimized-game-bar" onclick="restoreGameModal()" class="border-blue-600 text-blue-600">
        <i class="fas fa-gamepad"></i>
        <span id="minimized-game-title">اللعبة جارية...</span>
        <i class="fas fa-chevron-up"></i>
    </div>

    <div id="debug-panel" class="hidden"><div class="flex justify-between items-center mb-2 border-b border-green-700 pb-1"><span class="font-bold text-white">🛠️ تشخيص الاتصال</span><button onclick="document.getElementById('debug-panel').style.display='none'" class="text-red-400 hover:text-red-200 font-bold">x</button></div><div id="debug-content" class="space-y-1">Waiting...</div><button onclick="hardReset()" class="mt-2 w-full bg-red-700 text-white text-xs py-1 rounded hover:bg-red-600">تصفير الذاكرة وإعادة التحميل</button></div>
    <button onclick="document.getElementById('debug-panel').style.display='block'" class="fixed bottom-2 left-2 text-[10px] text-gray-300 hover:text-gray-500 opacity-50 z-50">🛠️ تشخيص</button>

    <script>
        // --- 1. GLOBAL VARIABLES & DATA ---
        const urlParams = new URLSearchParams(window.location.search);
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        const LESSON_KEY = 'c6_l2';
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let timerInterval;

        const tabs = [
            { id: 'learn1', icon: 'divide-circle', label: 'قسمة القوى' },
            { id: 'learn2', icon: 'layers', label: 'قوة القسمة' },
            { id: 'learn3', icon: 'circle', label: 'الأس الصفري' },
            { id: 'learn4', icon: 'arrow-down-up', label: 'الأس السالب' },
            { id: 'quiz', icon: 'clipboard-check', label: 'الاختبار' }
        ];

        // Question Bank
        const questionBank = [
             // Tab 1: Quotient of Powers
             { 
                 id: 201, 
                 type: 'learn1', 
                 t: 'بسّط العبارة: <span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٩</sup></span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٥</sup></span></span>', 
                 o: [{t:'<span class="math-eq">س&zwnj;<sup class="tiny-sup">١٤</sup></span>', v:'a'}, {t:'<span class="math-eq">س&zwnj;<sup class="tiny-sup">٤</sup></span>', v:'b'}, {t:'<span class="math-eq">س&zwnj;<sup class="tiny-sup">٤٥</sup></span>', v:'c'}, {t:'<span class="math-eq">١</span>', v:'d'}], 
                 c: 'b', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: طرح الأسس</h4><div class="v-step"><p class="text-sm">الأساس موحد (س)، نطرح أس المقام من البسط:</p><p class="text-lg font-bold text-center bg-gray-100 p-2 rounded w-full">٩ - ٥</p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج:</h4><div class="v-step"><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold">س&zwnj;<sup class="tiny-sup">٤</sup></p></div></div>', 
                 smart:'عند القسمة <strong>اطرح</strong> (اللي فوق ناقص اللي تحت).' 
             },
             { 
                 id: 202, 
                 type: 'learn1', 
                 t: 'ناتج <span class="fraction"><span>ص&zwnj;<sup class="tiny-sup">٥</sup></span><span class="bar"></span><span>ص&zwnj;</span></span> هو:', 
                 o: [{t:'<span class="math-eq">ص&zwnj;<sup class="tiny-sup">٤</sup></span>', v:'a'}, {t:'<span class="math-eq">ص&zwnj;<sup class="tiny-sup">٥</sup></span>', v:'b'}, {t:'<span class="math-eq">ص&zwnj;<sup class="tiny-sup">٤</sup></span>', v:'c'}, {t:'١', v:'d'}], 
                 c: 'c', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">تنبيه هام:</h4><div class="v-step"><p class="text-sm bg-yellow-50 p-2 rounded border border-yellow-200 w-full text-center">المتغير (ص) في المقام أسه ١ (مخفي).</p></div></div><div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">العملية:</h4><div class="v-step"><p class="text-lg font-bold">٥ - ١</p><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-green-700">ص&zwnj;<sup class="tiny-sup">٤</sup></p></div></div>', 
                 smart:'لا تنسَ <strong>الواحد المخفي</strong> في المقام.' 
             },
             { 
                 id: 203, 
                 type: 'learn1', 
                 t: 'بسّط <span class="fraction"><span>م&zwnj;<sup class="tiny-sup">٦</sup> ر&zwnj;<sup class="tiny-sup">٥</sup></span><span class="bar"></span><span>م&zwnj;<sup class="tiny-sup">٣</sup> ر&zwnj;<sup class="tiny-sup">٢</sup></span></span>', 
                 o: [{t:'<span class="math-eq">م&zwnj;<sup class="tiny-sup">٣</sup> ر&zwnj;<sup class="tiny-sup">٣</sup></span>', v:'a'}, {t:'<span class="math-eq">م&zwnj;<sup class="tiny-sup">٢</sup> ر&zwnj;<sup class="tiny-sup">٣</sup></span>', v:'b'}, {t:'<span class="math-eq">م&zwnj;<sup class="tiny-sup">٩</sup> ر&zwnj;<sup class="tiny-sup">٧</sup></span>', v:'c'}, {t:'<span class="math-eq">م&zwnj;<sup class="tiny-sup">٣</sup> ر&zwnj;<sup class="tiny-sup">٢</sup></span>', v:'d'}], 
                 c: 'a', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: فصل المتغيرات</h4><div class="v-step"><div class="flex gap-2 justify-center"><span class="bg-gray-100 p-1 rounded">م&zwnj;</span><span class="bg-gray-100 p-1 rounded">ر&zwnj;</span></div></div></div><div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ٢: الطرح لكل متغير</h4><div class="v-step"><p class="text-sm">م: ٦ - ٣ = <strong>٣</strong></p><p class="text-sm">ر: ٥ - ٢ = <strong>٣</strong></p></div></div><div class="step-box border-green-500 bg-green-50"><p class="text-lg font-bold text-center text-green-700">م&zwnj;<sup class="tiny-sup">٣</sup> ر&zwnj;<sup class="tiny-sup">٣</sup></p></div>', 
                 smart:'اطرح كل حرف مع شبيهه.' 
             },
             { 
                 id: 204, 
                 type: 'learn1', 
                 t: 'بسّط <span class="fraction"><span>ج&zwnj;<sup class="tiny-sup">٤</sup> د&zwnj;<sup class="tiny-sup">٤</sup></span><span class="bar"></span><span>ج&zwnj; د&zwnj;</span></span>', 
                 o: [{t:'<span class="math-eq">ج&zwnj;<sup class="tiny-sup">٣</sup> د&zwnj;<sup class="tiny-sup">٣</sup></span>', v:'a'}, {t:'<span class="math-eq">ج&zwnj;<sup class="tiny-sup">٤</sup> د&zwnj;<sup class="tiny-sup">٤</sup></span>', v:'b'}, {t:'<span class="math-eq">١</span>', v:'c'}, {t:'<span class="math-eq">ج&zwnj;<sup class="tiny-sup">٣</sup> د&zwnj;<sup class="tiny-sup">٣</sup></span>', v:'d'}], 
                 c: 'd', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">الطرح من ١:</h4><div class="v-step"><p class="text-sm text-center">المقام أسه ١ لكل متغير.</p><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-center">ج&zwnj;<sup class="tiny-sup">٤-١</sup> د&zwnj;<sup class="tiny-sup">٤-١</sup></p></div></div><div class="step-box border-green-500 bg-green-50"><p class="text-lg font-bold text-center text-green-700">ج&zwnj;<sup class="tiny-sup">٣</sup> د&zwnj;<sup class="tiny-sup">٣</sup></p></div>', 
                 smart:'نقص ١ من كل أس.' 
             },

             // Tab 2: Power of Quotient
             { 
                 id: 301, 
                 type: 'learn2', 
                 t: 'بسّط <span class="math-eq">(<span class="fraction"><span>٣</span><span class="bar"></span><span>٥</span></span>)<sup class="tiny-sup">٢</sup></span>', 
                 o: [{t:'<span class="fraction"><span>٩</span><span class="bar"></span><span>٢٥</span></span>', v:'a'}, {t:'<span class="fraction"><span>٦</span><span class="bar"></span><span>١٠</span></span>', v:'b'}, {t:'<span class="fraction"><span>٩</span><span class="bar"></span><span>٢٥</span></span>', v:'c'}, {t:'<span class="fraction"><span>٣</span><span class="bar"></span><span>٢٥</span></span>', v:'d'}], 
                 c: 'c', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-purple-600 mb-1">خطوة ١: توزيع الأس</h4><div class="v-step"><p class="text-lg font-bold text-center bg-gray-100 p-2 rounded"><span class="fraction"><span><span class="fix-pos">٣<sup class="tiny-sup">٢</sup></span></span><span class="bar"></span><span><span class="fix-pos">٥<sup class="tiny-sup">٢</sup></span></span></span></p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج:</h4><div class="v-step"><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-center"><span class="fraction"><span>٩</span><span class="bar"></span><span>٢٥</span></span></p></div></div>', 
                 smart:'ربع اللي فوق وربع اللي تحت.' 
             },
             { 
                 id: 302, 
                 type: 'learn2', 
                 t: 'بسّط <span class="math-eq">(<span class="fraction"><span>٢س&zwnj;</span><span class="bar"></span><span>٣</span></span>)<sup class="tiny-sup">٢</sup></span>', 
                 o: [{t:'<span class="fraction"><span>٤س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٩</span></span>', v:'a'}, {t:'<span class="fraction"><span>٤س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٩</span></span>', v:'b'}, {t:'<span class="fraction"><span>٤س&zwnj;</span><span class="bar"></span><span>٩</span></span>', v:'c'}, {t:'<span class="fraction"><span>٤س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٦</span></span>', v:'d'}], 
                 c: 'b', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: توزيع الأس</h4><div class="v-step"><p class="text-lg font-bold text-center"><span class="fraction"><span><span class="fix-pos">٢<sup class="tiny-sup">٢</sup></span> س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span><span class="fix-pos">٣<sup class="tiny-sup">٢</sup></span></span></span></p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج:</h4><div class="v-step"><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-center"><span class="fraction"><span>٤س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>٩</span></span></p></div></div>', 
                 smart:'لا تنسَ تربيع الرقم ٢ أيضاً!' 
             },
             { 
                 id: 303, 
                 type: 'learn2', 
                 t: 'بسّط <span class="math-eq">(<span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٢</sup></span><span class="bar"></span><span>ص&zwnj;</span></span>)<sup class="tiny-sup">٣</sup></span>', 
                 o: [{t:'<span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٦</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'a'}, {t:'<span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٥</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'b'}, {t:'<span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٦</sup></span><span class="bar"></span><span>ص&zwnj;</span></span>', v:'c'}, {t:'<span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٦</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'d'}], 
                 c: 'd', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: ضرب الأسس</h4><div class="v-step"><p class="text-sm">البسط: ٢ × ٣ = ٦</p><p class="text-sm">المقام: ١ × ٣ = ٣</p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج:</h4><div class="v-step"><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-center"><span class="fraction"><span>س&zwnj;<sup class="tiny-sup">٦</sup></span><span class="bar"></span><span>ص&zwnj;<sup class="tiny-sup">٣</sup></span></span></p></div></div>', 
                 smart:'اضرب الأس الداخلي في الخارجي.' 
             },
             
             // Tab 3: Zero Exponent
             { 
                 id: 401, 
                 type: 'learn3', 
                 t: 'قيمة <span class="fix-pos">٧<sup class="tiny-sup visible-zero">٠</sup></span> تساوي:', 
                 o: [{t:'١', v:'a'}, {t:'١', v:'b'}, {t:'٧', v:'c'}, {t:'غير معرف', v:'d'}], 
                 c: 'b', 
                 e: '<div class="step-box border-green-500 bg-green-50"><div class="v-step"><p class="text-sm font-bold text-center">أي مقدار (غير الصفر) أس صفر يساوي دائماً:</p><p class="text-2xl font-black text-green-700 mt-2 visible-zero">١</p></div></div>', 
                 smart:'شفت صفر فوق؟ الناتج <strong>واحد</strong>.' 
             },
             { 
                 id: 404, 
                 type: 'learn3', 
                 t: 'قيمة <span class="math-eq">(س&zwnj;<sup class="tiny-sup">٢</sup>ص&zwnj;<sup class="tiny-sup">٥</sup>)<sup class="tiny-sup visible-zero">٠</sup></span> تساوي:', 
                 o: [{t:'١', v:'a'}, {t:'٠', v:'b'}, {t:'س ص', v:'c'}, {t:'س²ص⁵', v:'d'}], 
                 c: 'a', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">تحليل:</h4><p class="text-sm text-center">بما أن الأس الخارجي هو (صفر)</p></div><div class="step-box border-green-500 bg-green-50"><div class="v-step"><i class="fas fa-arrow-down v-arrow"></i><p class="text-lg font-bold text-green-700 visible-zero">١</p></div></div>', 
                 smart:'لا تتعب نفسك بالحساب، الأس صفر.' 
             },

             // Tab 4: Negative Exponent
             { 
                 id: 402, 
                 type: 'learn4', 
                 t: 'بسّط <span class="math-eq">س&zwnj;<sup class="tiny-sup fix-pos">-٣</sup></span>', 
                 o: [{t:'<span class="fraction"><span>١</span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'a'}, {t:'<span class="math-eq">-٣س&zwnj;</span>', v:'b'}, {t:'<span class="fraction"><span>١</span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'c'}, {t:'<span class="fraction"><span>١</span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup fix-pos">-٣</sup></span></span>', v:'d'}], 
                 c: 'c', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-red-600 mb-1">الأس السالب:</h4><div class="v-step"><p class="text-sm bg-red-50 p-2 rounded w-full text-center">اقلب المقدار للتخلص من السالب.</p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج:</h4><div class="v-step"><i class="fas fa-exchange-alt v-arrow text-blue-500"></i><p class="text-lg font-bold text-center"><span class="fraction"><span>١</span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup">٣</sup></span></span></p></div></div>', 
                 smart:'اقلب الكسر يطير السالب.' 
             },
             { 
                 id: 403, 
                 type: 'learn4', 
                 t: 'بسّط <span class="fraction"><span>١</span><span class="bar"></span><span>ن&zwnj;<sup class="tiny-sup fix-pos">-٢</sup></span></span>', 
                 o: [{t:'<span class="math-eq">ن&zwnj;<sup class="tiny-sup">٢</sup></span>', v:'a'}, {t:'<span class="math-eq">ن&zwnj;<sup class="tiny-sup">٢</sup></span>', v:'b'}, {t:'<span class="math-eq">-٢ن</span>', v:'c'}, {t:'<span class="math-eq">ن&zwnj;<sup class="tiny-sup fix-pos">-٢</sup></span>', v:'d'}], 
                 c: 'b', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">الموقع:</h4><p class="text-sm text-center">الأس السالب في <span class="text-red-600 font-bold">المقام</span>.</p></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الحل:</h4><div class="v-step"><i class="fas fa-arrow-up v-arrow text-green-500"></i><p class="text-sm font-bold text-center">ارفعه للبسط ويصبح موجباً:</p><p class="text-lg font-bold text-center text-green-700">ن&zwnj;<sup class="tiny-sup">٢</sup></p></div></div>', 
                 smart:'السالب تحت؟ <strong>طلعه فوق</strong> يصير موجب.' 
             },

             // Mixed (Challenge Questions)
             { 
                 id: 501, 
                 type: 'mixed', 
                 t: 'تحدي ١: بسّط العبارة <span class="fraction"><span>٢س&zwnj;<sup class="tiny-sup">٥</sup> · س&zwnj;<sup class="tiny-sup">٣</sup></span><span class="bar"></span><span>س&zwnj;<sup class="tiny-sup fix-pos">-٤</sup></span></span>', 
                 o: [{t:'<span class="math-eq">٢س&zwnj;<sup class="tiny-sup">١٢</sup></span>', v:'a'}, {t:'<span class="math-eq">٢س&zwnj;<sup class="tiny-sup">٤</sup></span>', v:'b'}, {t:'<span class="math-eq">س&zwnj;<sup class="tiny-sup">١٢</sup></span>', v:'c'}, {t:'<span class="math-eq">٢س&zwnj;<sup class="tiny-sup">١٢</sup></span>', v:'d'}], 
                 c: 'd', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: تبسيط البسط (ضرب)</h4><div class="v-step"><p class="text-sm">عند الضرب نجمع الأسس:</p><p class="text-center font-bold">٢س&zwnj;<sup class="tiny-sup">٥+٣</sup> = ٢س&zwnj;<sup class="tiny-sup">٨</sup></p></div></div><div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ٢: القسمة على المقام</h4><div class="v-step"><p class="text-sm">نطرح أس المقام (-٤) من أس البسط (٨):</p><p class="text-center font-bold">٨ - (-٤) = ٨ + ٤ = ١٢</p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">الناتج النهائي:</h4><p class="text-lg font-bold text-center">٢س&zwnj;<sup class="tiny-sup">١٢</sup></p></div>', 
                 smart:'اجمع اللي فوق (٨) واطرح منهم اللي تحت (٨ - -٤).' 
             },
             { 
                 id: 502, 
                 type: 'mixed', 
                 t: 'تحدي ٢: بسّط <span class="math-eq">(<span class="fraction"><span>٤ص&zwnj;<sup class="tiny-sup">٣</sup></span><span class="bar"></span><span>٢ص&zwnj;</span></span>)<sup class="tiny-sup">٣</sup></span>', 
                 o: [{t:'<span class="math-eq">٨ص&zwnj;<sup class="tiny-sup">٦</sup></span>', v:'a'}, {t:'<span class="math-eq">٢ص&zwnj;<sup class="tiny-sup">٦</sup></span>', v:'b'}, {t:'<span class="math-eq">٨ص&zwnj;<sup class="tiny-sup">٩</sup></span>', v:'c'}, {t:'<span class="math-eq">٤ص&zwnj;<sup class="tiny-sup">٦</sup></span>', v:'d'}], 
                 c: 'a', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">خطوة ١: بسط ما داخل القوس أولاً</h4><div class="v-step"><p class="text-sm">الأعداد: ٤ ÷ ٢ = <strong>٢</strong></p><p class="text-sm">المتغيرات: ص³ ÷ ص¹ = <strong>ص²</strong></p><p class="text-center bg-gray-100 p-1 rounded font-bold">أصبحت العبارة: (٢ص²)<sup class="tiny-sup">٣</sup></p></div></div><div class="step-box"><h4 class="font-bold text-xs text-purple-600 mb-1">خطوة ٢: وزع الأس الخارجي</h4><div class="v-step"><p class="text-sm">٢ أس ٣ = <strong>٨</strong></p><p class="text-sm">ص² أس ٣ (ضرب) = <strong>ص⁶</strong></p></div></div><div class="step-box border-green-500 bg-green-50"><p class="text-lg font-bold text-center text-green-700">٨ص&zwnj;<sup class="tiny-sup">٦</sup></p></div>', 
                 smart:'اختصر جوا القوس أول (يطلع ٢ص²) بعدين كعبهم.' 
             },
             { 
                 id: 503, 
                 type: 'mixed', 
                 t: 'تحدي العمالقة: بسّط <span class="fraction"><span>(٦ك&zwnj;<sup class="tiny-sup">٢</sup>)(٢ك&zwnj;<sup class="tiny-sup fix-pos">-١</sup>)</span><span class="bar"></span><span>٣ك&zwnj;<sup class="tiny-sup">٤</sup></span></span>', 
                 o: [{t:'<span class="fraction"><span>٤</span><span class="bar"></span><span>ك&zwnj;<sup class="tiny-sup">٣</sup></span></span>', v:'a'}, {t:'<span class="math-eq">٤ك&zwnj;<sup class="tiny-sup">٣</sup></span>', v:'b'}, {t:'<span class="fraction"><span>٤ك&zwnj;</span><span class="bar"></span><span>٣</span></span>', v:'c'}, {t:'<span class="math-eq">١٢ك</span>', v:'d'}], 
                 c: 'c', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">١. تبسيط البسط (ضرب):</h4><div class="v-step"><p class="text-sm">الأعداد: ٦ × ٢ = ١٢</p><p class="text-sm">الأسس: ٢ + (-١) = ١ ← ك¹</p><p class="text-center font-bold bg-gray-100 p-1 rounded">البسط أصبح: ١٢ك</p></div></div><div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">٢. القسمة على المقام (٣ك⁴):</h4><div class="v-step"><p class="text-sm">١٢ ÷ ٣ = <strong>٤</strong></p><p class="text-sm">ك¹ ÷ ك⁴ = ك¹⁻⁴ = <strong>ك⁻³</strong></p></div></div><div class="step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs text-green-600 mb-1">٣. التخلص من الأس السالب:</h4><p class="text-lg font-bold text-center"><span class="fraction"><span>٤</span><span class="bar"></span><span>ك&zwnj;<sup class="tiny-sup">٣</sup></span></span></p></div>', 
                 smart:'اضرب اللي فوق (١٢ك)، اقسم على اللي تحت، نزل الأس السالب.' 
             }
        ];

        // --- (3) FUNCTION DEFINITIONS (Hoisted) ---
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabId}`);
            const navEl = document.getElementById(`nav-${tabId}`);
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') {
                if(document.getElementById('quizForm').innerHTML === '') { generateQuiz(); }
                renderDynamicGames(); 
                const sId = urlParams.get('studentId');
                if(sId && sId !== 'visitor') fetchStudentData();
            }
        }

        // --- NEW: Game Modal Functions ---
        function openGameModal(url) {
            const modal = document.getElementById('game-modal-container');
            const iframe = document.getElementById('game-frame');
            const titleSpan = document.getElementById('game-modal-title');
            const minimizedBar = document.getElementById('minimized-game-bar');
            
            // Set content
            iframe.src = url;
            titleSpan.textContent = "جاري التحميل..."; // Can be updated if game sends title
            
            // Apply theme color to header
            const header = document.getElementById('game-modal-header');
            header.className = `bg-gradient-to-r ${themeColor.gradient} text-white flex justify-between items-center p-3 shadow-md`;

            // Reset state
            modal.style.display = 'flex';
            minimizedBar.style.display = 'none';
            document.getElementById('game-modal-content').classList.remove('fullscreen');
        }

        function closeGameModal() {
            const modal = document.getElementById('game-modal-container');
            const iframe = document.getElementById('game-frame');
            const minimizedBar = document.getElementById('minimized-game-bar');
            
            modal.style.display = 'none';
            minimizedBar.style.display = 'none';
            iframe.src = ''; // Stop the game
        }

        function toggleGameFullscreen() {
            const content = document.getElementById('game-modal-content');
            content.classList.toggle('fullscreen');
        }

        function minimizeGameModal() {
            const modal = document.getElementById('game-modal-container');
            const minimizedBar = document.getElementById('minimized-game-bar');
            
            modal.style.display = 'none';
            minimizedBar.style.display = 'flex';
        }

        function restoreGameModal() {
            const modal = document.getElementById('game-modal-container');
            const minimizedBar = document.getElementById('minimized-game-bar');
            
            modal.style.display = 'flex';
            minimizedBar.style.display = 'none';
        }

        function initInteractive() {
            document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive');
                const placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                let current = -1;
                const update = () => {
                    if(!prevBtn) return;
                    prevBtn.disabled = current === -1;
                    if (current === -1) placeholder.classList.remove('hidden'); else placeholder.classList.add('hidden');
                    steps.forEach((s, i) => { if (i <= current) s.classList.add('active'); else s.classList.remove('active'); });
                    if (current >= steps.length - 1) { nextBtn.classList.add('hidden'); resetBtn.classList.remove('hidden'); } 
                    else { nextBtn.classList.remove('hidden'); resetBtn.classList.add('hidden'); }
                };
                if(nextBtn) nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
                if(prevBtn) prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
                update();
            });
        }
        
        async function saveScoreToBackend(lessonId, grade) {
            const sId = urlParams.get('studentId');
            const cId = urlParams.get('classId');
            const saveStatus = document.getElementById('save-status');
            if (!sId || !cId) { if(saveStatus) saveStatus.innerHTML = '<span class="text-yellow-600">تم تسجيل النتيجة محلياً (زائر)</span>'; return; }
            if(saveStatus) saveStatus.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> جارٍ حفظ النتيجة...</span>';
            const requestUrl = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            let success = false;
            for (let i = 0; i < 3; i++) {
                try { await fetch(requestUrl); success = true; break; } 
                catch (error) { await new Promise(r => setTimeout(r, 2000)); }
            }
            if (success) {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-green-600 font-bold">✔ تم حفظ النتيجة بنجاح!</span>';
                setTimeout(() => fetchStudentData(), 1000); 
            } else {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-red-600 font-bold">❌ تعذر الحفظ. تأكد من الاتصال.</span>';
            }
        }
        
        async function fetchStudentData() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') return;
            const loadingEl = document.getElementById('loading-attempts');
            const displayEl = document.getElementById('attempts-display');
            if(loadingEl) loadingEl.classList.remove('hidden');
            if(displayEl) displayEl.classList.add('hidden');
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url);
                const jsonResponse = await response.json();
                if (jsonResponse.status === "success" && jsonResponse.data) {
                    let lessonData = { attempts: 0, allowed: true, waitTime: 0, grade: 0 };
                    if (jsonResponse.data.lessons && jsonResponse.data.lessons[LESSON_KEY]) {
                        lessonData = jsonResponse.data.lessons[LESSON_KEY];
                    }
                    const consumed = lessonData.attempts || 0;
                    const maxAttempts = 3; 
                    attemptsLeft = Math.max(0, maxAttempts - consumed);
                    if (attemptsLeft > 0) {
                        localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_${sId}`);
                        if (timerInterval) clearInterval(timerInterval);
                        document.getElementById('timer-top-container').classList.add('hidden');
                        document.getElementById('timer-bottom-container').classList.add('hidden');
                        const submitBtn = document.getElementById('quiz-action-btn');
                        if(submitBtn) {
                             submitBtn.disabled = false;
                             submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                             submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                             submitBtn.textContent = "تحقق من الإجابات";
                        }
                    } else {
                        attemptsLeft = 0;
                        if (lessonData.waitTime > 0) {
                            const unlockTime = Date.now() + lessonData.waitTime;
                            localStorage.setItem(`${NEXT_ATTEMPT_KEY}_${sId}`, unlockTime);
                            startTimer(unlockTime);
                        }
                    }
                    const scoreEl = document.getElementById('student-score');
                    const badge = document.getElementById('header-score-badge');
                    if (lessonData.grade > 0 && scoreEl) {
                        scoreEl.textContent = lessonData.grade;
                        if(badge) badge.classList.remove('hidden');
                    }
                    if(jsonResponse.data.name) {
                        document.getElementById('student-name').textContent = jsonResponse.data.name;
                    }
                }
            } catch (error) {
                console.error("Sync Error:", error);
            } finally {
                updateAttemptsUI();
                if(loadingEl) loadingEl.classList.add('hidden');
                if(displayEl) displayEl.classList.remove('hidden');
            }
        }

        function renderDynamicGames() {
            const sId = urlParams.get('studentId') || 'visitor';
            const wrapper = document.getElementById('games-wrapper');
            if (wrapper) wrapper.classList.remove('hidden'); 
            
            const container = document.getElementById('dynamic-games-container');
            if (!container) return;
            container.innerHTML = '';
            
            const games = [
                { id: 'g6_2_1', title: 'لعبة الاختيار', maxDefault: 5 },
                { id: 'g6_2_2', title: 'سباق القوى', maxDefault: 5 }
            ];
            
            // Render games directly without strict checks to ensure they appear
            games.forEach((game, idx) => {
                const i = idx + 1;
                // Use defaults if url params missing
                const title = urlParams.get(`g${i}_title`) || game.title;
                const id = urlParams.get(`g${i}_id`) || game.id;
                const score = parseInt(urlParams.get(`g${i}_score`)) || 0;
                const max = parseInt(urlParams.get(`g${i}_max`)) || game.maxDefault;

                let cardClass = "normal-card";
                let iconHtml = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg shadow-sm" style="background-color: var(--theme-hex)"><i class="fas fa-gamepad"></i></div>`;
                let statusText = "تطبيق تفاعلي";
                
                if (score >= max && max > 0) {
                        cardClass = "gold-card";
                        iconHtml = `<div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-trophy"></i></div>`;
                        statusText = "أحسنت! (درجة كاملة)";
                } else if (score >= (max/2) && max > 0) {
                        cardClass = "orange-card";
                        iconHtml = `<div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-star"></i></div>`;
                        statusText = `نتيجتك: ${score}/${max}`;
                } else if (score >= 0 && urlParams.get(`g${i}_score`) !== null) {
                        cardClass = "red-card";
                        iconHtml = `<div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-lg shadow-sm"><i class="fas fa-redo"></i></div>`;
                        statusText = `حاول مرة أخرى: ${score}/${max}`;
                }

                // Updated onclick to open modal
                const gameUrl = `https://ablan-math.github.io/games/${id}.html?studentId=${sId}&classId=${urlParams.get('classId')}`;
                const gameHtml = `
                <div onclick="openGameModal('${gameUrl}', '${title}')" class="cursor-pointer block group relative overflow-hidden rounded-xl p-4 hover:shadow-md transition-all duration-300 ${cardClass}">
                    <div class="flex items-center gap-3">
                        ${iconHtml}
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">${title}</h3>
                            <p class="text-[10px] text-gray-500 font-bold">${statusText}</p>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', gameHtml);
            });
            
            // Always show the title if not present
            if(!document.getElementById('games-title')) {
                 container.insertAdjacentHTML('beforebegin', `<h2 id="games-title" class="col-span-1 md:col-span-2 text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> استمتع وتعلم</h2>`);
            }
        }

        function initAttempts() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.removeItem(`${ATTEMPTS_KEY}_visitor`);
                localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_visitor`);
                attemptsLeft = 1; 
                updateAttemptsUI();
            } else {
                attemptsLeft = 0; 
                updateAttemptsUI();
                fetchStudentData();
            }
        }
        
        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);

            const submitBtn = document.getElementById('quiz-action-btn');
            if (!submitBtn) return;

            const resultsVisible = document.getElementById('quiz-results') && !document.getElementById('quiz-results').classList.contains('hidden');

            if (resultsVisible) {
                // Result Mode
                if (attemptsLeft > 0) {
                    submitBtn.textContent = "إعادة الاختبار";
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg', 'transform', 'active:scale-95');
                    submitBtn.onclick = resetQuizView; // Ensure click handler is set for retry
                    submitBtn.type = "button";
                } else {
                    submitBtn.textContent = "انتهت المحاولات";
                    submitBtn.disabled = true;
                    submitBtn.classList.add('bg-gray-400', 'text-white', 'cursor-not-allowed');
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            } else {
                // Quiz Mode
                submitBtn.onclick = null; // Remove specific onclick to allow form submit (or handleQuizSubmit via form)
                // Actually, handleQuizSubmit is attached to form.onsubmit. The button might be type="submit".
                // In handleQuizSubmit, we change type to "button" for retry. Here we should reset.

                if (attemptsLeft > 0) {
                    submitBtn.textContent = "تحقق من الإجابات";
                    submitBtn.disabled = false;
                    submitBtn.type = "submit"; // Revert to submit for form handling
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    submitBtn.textContent = "المحاولات مستنفذة";
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            }
        }

        function startTimer(targetTime) {
             clearInterval(timerInterval);
             const tick = () => {
                const now = Date.now();
                const diff = targetTime - now;
                if (diff <= 0) {
                    clearInterval(timerInterval);
                    const sId = urlParams.get('studentId') || 'visitor';
                    if (sId === 'visitor') {
                         attemptsLeft = 1;
                         localStorage.setItem(`${ATTEMPTS_KEY}_visitor`, 1);
                         localStorage.removeItem(`${NEXT_ATTEMPT_KEY}_visitor`);
                         updateAttemptsUI();
                    } else {
                        fetchStudentData(); 
                    }
                    return;
                }
                const hours = Math.floor((diff / (1000 * 60 * 60)));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                const timeStr = `${hours}:${minutes}:${seconds}`; 
                const timeStrAr = timeStr.replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);
                const topDisplay = document.getElementById('timer-display-top');
                const bottomDisplay = document.getElementById('timer-display-bottom');
                if(topDisplay) { topDisplay.textContent = timeStrAr; topDisplay.parentElement.classList.remove('hidden'); }
                if(bottomDisplay) bottomDisplay.textContent = timeStrAr;
            };
            timerInterval = setInterval(tick, 1000);
            tick();
        }

        function generateQuiz() { 
            const getQ = (type) => {
                const subset = questionBank.filter(q => q.type === type);
                if (subset.length === 0) return null;
                return subset[Math.floor(Math.random() * subset.length)];
            };
            // 5 questions: 1 from each section + 1 mixed
            const q1 = getQ('learn1'); // Division
            const q2 = getQ('learn2'); // Power of Quotient
            const q3 = getQ('learn3'); // Zero
            const q4 = getQ('learn4'); // Negative
            let q5 = getQ('mixed'); 
            if(!q5) q5 = questionBank.find(q => q.type === 'mixed');
            
            // Filter out nulls just in case
            currentQuestions = [q1, q2, q3, q4, q5].filter(q => q !== null);
            renderQuiz(); 
        }

        function renderQuiz() {
            const quizForm = document.getElementById('quizForm');
            if(!quizForm) return;
            let html = '';
            const typeLabels = { 'learn1': 'قسمة القوى', 'learn2': 'قوة القسمة', 'learn3': 'الأس الصفري', 'learn4': 'الأس السالب', 'mixed': 'مسألة مدمجة' };
            currentQuestions.forEach((q, i) => {
                html += `
                <div class="border border-gray-200 rounded-xl p-4 md:p-6 hover:border-blue-200 transition bg-white mb-6">
                    <div class="flex flex-col gap-2 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] md:text-xs font-bold">سؤال ${convertToArabic(i+1)}</span>
                            <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1"><i class="fas fa-tag text-xs"></i> ${typeLabels[q.type] || 'عام'}</span>
                        </div>
                        <p class="font-bold text-gray-800 text-sm md:text-lg leading-6 mt-1">${q.t}</p>
                    </div>
                    <div class="options-grid">
                        ${q.o.map((opt, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${opt.v}" class="hidden"><label for="q${i}o${oi}" class="option-label text-sm md:text-base select-none shadow-sm">${opt.t}</label></div>`).join('')}
                    </div>
                    <div id="feedback-${i}" class="text-xs md:text-base font-bold mt-3 hidden p-3 rounded-lg"></div>
                    <div id="post-submit-actions-${i}" class="hidden flex flex-wrap gap-2 mt-3 items-center">
                         <button type="button" onclick="showExplain(${i})" class="text-xs md:text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 flex items-center gap-1 transition"><i data-lucide="help-circle" class="w-3 h-3 md:w-4 md:h-4"></i> لماذا؟</button>
                         <button type="button" onclick="showSmart(${i})" class="text-xs md:text-sm bg-purple-50 text-purple-600 px-3 py-2 rounded-lg hover:bg-purple-100 flex items-center gap-1 transition"><i data-lucide="lightbulb" class="w-3 h-3 md:w-4 md:h-4"></i> الحل الذكي</button>
                         <button type="button" onclick="switchTab('${q.type === 'mixed' ? 'learn4' : q.type}')" class="text-xs md:text-sm border border-gray-200 text-gray-500 px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-1 transition mr-auto"><i data-lucide="book-open" class="w-3 h-3 md:w-4 md:h-4"></i> مراجعة الدرس</button>
                    </div>
                </div>`;
            });
            html += '<button type="submit" id="quiz-action-btn" class="w-full bg-blue-600 text-white font-bold py-3 md:py-4 rounded-xl text-sm md:text-lg shadow-lg hover:bg-blue-700 transition transform active:scale-95 mb-4 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400">تحقق من الإجابات</button>';
            quizForm.innerHTML = html;
            lucide.createIcons();
            quizForm.onsubmit = handleQuizSubmit;
        }

        async function handleQuizSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('quiz-action-btn');
            if (attemptsLeft <= 0) { alert("عذراً، لقد استنفذت محاولاتك."); return; }
            attemptsLeft--;
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.setItem(`${ATTEMPTS_KEY}_visitor`, attemptsLeft);
                if (attemptsLeft === 0) {
                    localStorage.setItem(`${NEXT_ATTEMPT_KEY}_visitor`, Date.now() + COOLDOWN_MS);
                    startTimer(Date.now() + COOLDOWN_MS);
                }
            } else {
                localStorage.setItem(`${ATTEMPTS_KEY}_${sId}`, attemptsLeft);
                if (attemptsLeft === 0) {
                    localStorage.setItem(`${NEXT_ATTEMPT_KEY}_${sId}`, Date.now() + COOLDOWN_MS);
                    startTimer(Date.now() + COOLDOWN_MS);
                }
            }
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);

            let score = 0;
            if(submitBtn) {
                submitBtn.textContent = "جاري التصحيح والحفظ...";
                submitBtn.disabled = true;
            }

            currentQuestions.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const feedback = document.getElementById(`feedback-${i}`);
                const actionArea = document.getElementById(`post-submit-actions-${i}`);
                if(actionArea) actionArea.classList.remove('hidden');

                if (selected) {
                    if (selected.value === q.c) {
                        score++;
                        if(feedback) {
                            feedback.innerHTML = '✔ إجابة صحيحة!';
                            feedback.className = 'text-xs font-bold mt-3 text-green-700 bg-green-50 block p-3 rounded-lg border border-green-100';
                            feedback.classList.remove('hidden');
                        }
                    } else {
                        if(feedback) {
                            feedback.innerHTML = '❌ إجابة خاطئة.';
                            feedback.className = 'text-xs font-bold mt-3 text-red-700 bg-red-50 block p-3 rounded-lg border border-red-100';
                            feedback.classList.remove('hidden');
                        }
                    }
                } else {
                    if(feedback) {
                        feedback.innerHTML = '⚠️ لم يتم الاختيار.';
                        feedback.className = 'text-xs font-bold mt-3 text-yellow-700 bg-yellow-50 block p-3 rounded-lg';
                        feedback.classList.remove('hidden');
                    }
                }
            });

            const finalScore = score * 2; 
            saveScoreToBackend(LESSON_KEY, finalScore);
            const resultCard = document.getElementById('quiz-results');
            if(resultCard) {
                resultCard.classList.remove('hidden', 'result-card-trophy', 'result-card-star', 'result-card-retry');
                if (finalScore > 8) resultCard.classList.add('result-card-trophy');
                else if (finalScore >= 5) resultCard.classList.add('result-card-star');
                else resultCard.classList.add('result-card-retry');
            }
            
            const scoreDisplay = document.getElementById('quiz-score');
            if(scoreDisplay) {
                scoreDisplay.textContent = `${convertToArabic(finalScore)} / ١٠`;
            }
            
            const inputs = document.querySelectorAll('#quizForm input');
            inputs.forEach(i => i.disabled = true);
            
            // IMPORTANT: Hand over control to updateAttemptsUI after result calculation
            // We just ensure the button type is button for retry
            if(submitBtn) {
                submitBtn.type = "button"; 
            }
            // updateAttemptsUI will be called by fetchStudentData which is called by saveScoreToBackend
            // but for immediate UI response we can call it here or rely on the async flow
            // Since resultCard is now visible, updateAttemptsUI will set the correct "Retry" state
            // However, attemptsLeft was just decremented locally.
            updateAttemptsUI();

            renderDynamicGames();
        }

        function resetQuizView() {
            document.getElementById('quiz-results').classList.add('hidden');
            generateQuiz(); 
            fetchStudentData();
            document.getElementById('tab-quiz').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showExplain(i) { document.getElementById('modal-content').innerHTML = currentQuestions[i].e; document.getElementById('modal').classList.remove('hidden'); }
        function showSmart(i) { document.getElementById('modal-content').innerHTML = `<p class="font-bold text-purple-700">💡 الحل الذكي:</p>${currentQuestions[i].smart}`; document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function hardReset() { localStorage.clear(); window.location.reload(); }

        // 6. INITIALIZATION WRAPPER
        function initPage() {
            const header = document.getElementById('main-header');
            if (header) {
                 header.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-800');
                 document.getElementById('header-icon').className = 'fas fa-graduation-cap text-lg md:text-2xl';
                 document.getElementById('header-bg-icon').className = 'fas fa-graduation-cap absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12';
                 document.getElementById('chapter-num-bg').textContent = themeColor.chapterNum;
            }
            document.documentElement.style.setProperty('--theme-hex', themeColor.hex);

            const navContainer = document.getElementById('bottom-nav-container');
            if (navContainer) {
                let navHTML = '';
                tabs.forEach((tab, index) => {
                     navHTML += `
                     <div class="nav-item ${index === 0 ? 'active' : ''}" onclick="window.switchTab('${tab.id}')" id="nav-${tab.id}">
                         <i data-lucide="${tab.icon}"></i>
                         <span>${tab.label}</span>
                     </div>`;
                });
                navContainer.innerHTML = navHTML;
            }

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            
            initInteractive();
            initAttempts();
        }

        // 7. EXPOSE TO WINDOW & START
        window.switchTab = switchTab;
        window.initInteractive = initInteractive;
        window.initAttempts = initAttempts;
        window.generateQuiz = generateQuiz;
        window.renderDynamicGames = renderDynamicGames;
        window.saveScoreToBackend = saveScoreToBackend;
        window.handleQuizSubmit = handleQuizSubmit;
        window.showExplain = showExplain;
        window.showSmart = showSmart;
        window.closeModal = closeModal;
        window.resetQuizView = resetQuizView;
        window.hardReset = hardReset;
        
        window.onload = initPage;

    </script>
</body>
</html>

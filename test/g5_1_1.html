<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Cairo ÙƒØ®Ø· Ø£Ø³Ø§Ø³ÙŠ */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            overscroll-behavior: none;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… (ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹) */
        .equation-font {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.05rem; /* 17px (ÙƒØ§Ù† 1.1rem) */
            font-weight: 700;
            text-align: center;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (subscript) */
        sub {
            font-size: 0.75em;
            vertical-align: sub;
            line-height: 0;
            font-family: 'Courier New', Courier, monospace;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ© */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.2em;
            vertical-align: middle;
            position: relative;
            top: -0.3em;
        }
        .numerator {
            font-size: 0.85em;
            line-height: 1;
        }
        .denominator {
            font-size: 0.85em;
            border-top: 2px solid currentColor; /* Ø®Ø· Ø§Ù„ÙƒØ³Ø± */
            line-height: 1;
            padding-top: 2px;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø®ÙŠØ§Ø± (ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø®Ø·) */
        .choice-button {
            width: 100%;
            padding: 0.6rem 0.75rem; /* (ÙƒØ§Ù† 0.75rem 1rem) */
            background-color: #ffffff;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            font-size: 0.95rem; /* (ÙƒØ§Ù† 1rem) */
            font-weight: 600;
        }
        .choice-button:hover:not(:disabled) {
            background-color: #f9fafb; /* gray-50 */
            border-color: #6b7280; /* gray-500 */
        }
        .choice-button.selected {
            border-color: #2563eb; /* blue-600 */
            background-color: #dbeafe; /* blue-100 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* (ØªØ¹Ø¯ÙŠÙ„) ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ */
        .choice-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© */
        .choice-button.correct {
            border-color: #16a34a; /* green-600 */
            background-color: #dcfce7; /* green-100 */
        }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø© */
        .choice-button.incorrect {
            border-color: #dc2626; /* red-600 */
            background-color: #fee2e2; /* red-100 */
        }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù€ 3 Ø®ÙŠØ§Ø±Ø§Øª (Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¬ÙˆØ§Ù„ØŒ 3 Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ÙƒØ¨ÙŠØ±) */
        .choices-grid-3 {
            display: grid;
            grid-template-columns: 1fr; /* Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ù„Ø¬ÙˆØ§Ù„ */
            gap: 0.75rem; /* 12px */
        }

        @media (min-width: 640px) { /* sm */
            .choices-grid-3 {
                grid-template-columns: repeat(3, 1fr); /* 3 Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙƒØ¨Ø± */
                gap: 1rem; /* 16px */
            }
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        /* Ù…Ø²Ù„Ø§Ù‚ Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø±Ø­ */
        #solution-content {
            max-height: 50vh; /* ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ 50% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            overflow-y: auto; /* Ø¥Ø¶Ø§ÙØ© Ù…Ø²Ù„Ø§Ù‚ Ø¹Ù…ÙˆØ¯ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
            padding-left: 1rem; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù…Ø²Ù„Ø§Ù‚ ÙÙŠ ÙˆØ¶Ø¹ RTL */
            margin-left: -1rem; /* ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
        }

        /* Ù…Ø²Ù„Ø§Ù‚ Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ */
        .leaderboard-scroll-container {
            max-height: 40vh; /* ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ */
            overflow-y: auto; /* Ø¥Ø¶Ø§ÙØ© Ù…Ø²Ù„Ø§Ù‚ Ø¹Ù…ÙˆØ¯ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            margin-top: 1rem; /* mb-4 */
        }
         .leaderboard-scroll-container table {
             margin-bottom: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
         }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ØªÙŠÙ† ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ */
        .equations-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* 8px */
            min-height: 5rem; /* 80px */
            padding: 0.5rem;
        }
        @media (min-width: 400px) {
            .equations-box {
                flex-direction: row;
                gap: 1rem; /* 16px */
            }
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
        .level-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
        }
        .level-button.locked {
            background-color: #d1d5db; /* gray-300 */
            border-color: #9ca3af; /* gray-400 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
        }
        .level-button.unlocked {
            background-color: #ffffff; /* white */
            border-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-800 */
            cursor: pointer;
        }
        .level-button.unlocked:hover {
            background-color: #eff6ff; /* blue-50 */
            transform: translateY(-2px);
        }
        /* Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø¨ (ÙŠÙˆÙ…Ø¶) */
        .level-button.unlocked.glowing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .level-button.completed {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #15803d; /* green-700 */
            cursor: pointer;
        }
        .level-button.completed:hover {
            background-color: #f0fdf4; /* green-50 */
            transform: translateY(-2px);
        }

        .level-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
        }
        .level-score {
            font-size: 0.9rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            margin-top: 0.25rem; /* mt-1 */
        }
        .level-icon {
            font-size: 1.5rem; /* text-2xl */
        }
        .replay-icon {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        .level-button.completed:hover .replay-icon {
            color: #15803d; /* green-700 */
            opacity: 1;
        }
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙÙ„ */
        .lock-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-dvh flex items-center justify-center p-2 sm:p-4">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (ØªØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹) -->
    <div id="welcome-modal" class="modal-overlay show" style="z-index: 80;">
        <div class="modal-content text-center" style="width: 480px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-700 mb-4">
                Ù„Ø¹Ø¨Ø© Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª
            </h1>
            <p class="text-base text-gray-700 mb-4">
                Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø·Ù„! ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø³ØªØªØ¹Ù„Ù… ÙƒÙŠÙ ØªÙ…ÙŠØ² Ø¨ÙŠÙ† Ø£Ù†ÙˆØ§Ø¹ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ© Ø§Ù„Ø«Ù„Ø§Ø«Ø©.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†
            </p>
            <button id="show-levels-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
    <div id="level-select-modal" class="modal-overlay" style="z-index: 79;">
        <!-- (ØªØ¹Ø¯ÙŠÙ„) ØªÙ… ØªØµØºÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¥Ù„Ù‰ 380px -->
        <div class="modal-content" style="width: 380px;">
            
            <!-- (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„ÙƒØ£Ø³ -->
            <div class="flex items-center justify-between w-full mb-4 relative">
                <h3 class="text-2xl font-bold text-blue-700 text-center w-full">
                    Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰
                </h3>
                <!-- (Ø¬Ø¯ÙŠØ¯) Ø²Ø± Ø§Ù„ÙƒØ£Ø³ (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
                <button id="show-leaderboard-btn" title="Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center font-bold text-2xl transition hover:bg-yellow-200 hidden">
                    ğŸ†
                </button>
           </div>
            
            <div id="levels-container" class="space-y-4 mb-6">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
            </div>

            <!-- (ØªØ¹Ø¯ÙŠÙ„) Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø·Ø§Ø± Ø³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ -->
            <div id="quote-container" class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-center">
                <p id="motivational-quote" class="text-sm text-gray-600 font-medium">
                    <!-- Ø¹Ø¨Ø§Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ© -->
                </p>
            </div>
        </div>
    </div>


    <!-- Ø´Ø§Ø´Ø© Ø´Ø±Ø­ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© (info-modal) -->
    <div id="info-modal" class="modal-overlay" style="z-index: 60;"> 
        <div class="modal-content" style="width: 480px;"> 
            <h3 class="text-lg font-bold text-blue-700 mb-2 text-center">
                Ø´Ø±Ø­ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
            </h3>
            <p class="text-xs text-center text-gray-600 mb-3 px-1">Ø¹Ù†Ø¯ Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹Ø§Ø¯Ù„ØªÙŠÙ† (Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹Ù‡Ù…Ø§ Ø¨ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ Øµ = Ù… Ø³ + Ø¨):</p>
            
            <div class="space-y-2 text-gray-700 text-sm text-right">
                <!-- 1. Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„ -->
                <div class="border border-blue-200 bg-blue-50 p-2 rounded-lg">
                    <p class="font-bold text-blue-600 text-base">Ù¡. Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„: <span class="font-normal">ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ†</span> Ø§Ù„Ù…ÙŠÙ„ Ù…Ø®ØªÙ„ÙØ§Ù‹.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                        Ù…<sub>Ù¡</sub> â‰  Ù…<sub>Ù¢</sub>
                    </div>
                    <p class="text-xs">Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Ù† <span class="font-bold">ÙŠØªÙ‚Ø§Ø·Ø¹Ø§Ù†</span> ÙÙŠ Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© (Ø­Ù„ ÙˆØ­ÙŠØ¯).</p>
                </div>
                <!-- 2. ØºÙŠØ± Ù…ØªØ³Ù‚ -->
                <div class="border border-red-200 bg-red-50 p-2 rounded-lg">
                    <p class="font-bold text-red-600 text-base">Ù¢. ØºÙŠØ± Ù…ØªØ³Ù‚: <span class="font-normal">ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ†</span> Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙŠØ§Ù‹ <span class="font-normal">ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ (Ø¨)</span> Ù…Ø®ØªÙ„ÙØ§Ù‹.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                        Ù…<sub>Ù¡</sub> = Ù…<sub>Ù¢</sub>  ,  Ø¨<sub>Ù¡</sub> â‰  Ø¨<sub>Ù¢</sub>
                    </div>
                    <p class="text-xs">Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Ù† <span class="font-bold">Ù…ØªÙˆØ§Ø²ÙŠØ§Ù†</span> (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù„).</p>
                </div>
                <!-- 3. Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„ -->
                <div class="border border-green-200 bg-green-50 p-2 rounded-lg">
                    <p class="font-bold text-green-600 text-base">Ù£. Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„: <span class="font-normal">ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ†</span> Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙŠØ§Ù‹ <span class="font-normal">ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ (Ø¨)</span> Ù…ØªØ³Ø§ÙˆÙŠØ§Ù‹.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                         Ù…<sub>Ù¡</sub> = Ù…<sub>Ù¢</sub>  ,  Ø¨<sub>Ù¡</sub> = Ø¨<sub>Ù¢</sub>
                    </div>
                    <p class="text-xs">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="font-bold">Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…</span> (Ø¹Ø¯Ø¯ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø­Ù„ÙˆÙ„).</p>
                </div>
            </div>
            <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø±ØŒ Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø© -->
            <button id="close-info-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ÙÙ‡Ù…ØªØŒ Ù…ØªØ§Ø¨Ø¹Ø©!
            </button>
        </div>
    </div>


    <!-- Ø´Ø§Ø´Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ -->
    <div id="replay-confirm-modal" class="modal-overlay" style="z-index: 85;">
        <div class="modal-content text-center" style="width: 380px;">
            <h3 class="text-xl font-bold text-yellow-700 mb-3">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            </h3>
            <p class="text-gray-700 mb-5">
                Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŸ<br>
                <!-- (ØªØ¹Ø¯ÙŠÙ„) ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                <span class="text-sm text-gray-500">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø£Ù‚Ù„).</span>
            </p>
            <div class="flex justify-center gap-4">
                <button id="confirm-replay-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-8 rounded-lg transition duration-200">
                    Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯
                </button>
                <button id="cancel-replay-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg transition duration-200">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- (Ø¬Ø¯ÙŠØ¯) Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="post-game-modal" class="modal-overlay" style="z-index: 84;">
        <div class="modal-content text-center" style="width: 380px;">
            <h3 class="text-2xl font-bold text-green-600 mb-3">
                ğŸ‰ Ø£Ø­Ø³Ù†Øª! ğŸ‰
            </h3>
            <p class="text-gray-700 mb-6 text-lg">
                Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!
            </p>
            <div class="flex flex-col gap-3">
                <button id="show-result-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 text-base">
                    Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
                </button>
                <button id="improve-score-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 text-base">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ø±Ø¬Ø§ØªÙŠ
                </button>
            </div>
        </div>
    </div>


    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø© (score-modal) -->
    <div id="score-modal" class="modal-overlay" style="z-index: 70;">
        <div class="modal-content text-center">
            <h3 id="score-title" class="text-2xl font-bold text-green-600 mb-2">Ø£Ø­Ø³Ù†Øª!</h3>
            <p id="points-earned-text" class="text-4xl font-bold text-blue-700 mb-4 equation-font">+Ù¡Ù  Ù†Ù‚Ø§Ø·</p>
            <div class="border-t pt-4 mt-4 space-y-2 text-sm sm:text-base text-gray-600">
                <p id="current-question-text">Ø§Ù„Ø³Ø¤Ø§Ù„: Ù¡ / Ù£</p>
                <p id="total-score-text">Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: Ù¡Ù </p>
            </div>
            <button id="continue-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Ù…ØªØ§Ø¨Ø¹Ø©
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø´Ø±Ø­ Ø§Ù„Ø­Ù„ -->
    <div id="solution-modal" class="modal-overlay" style="z-index: 75;">
        <!-- (ØªØ¹Ø¯ÙŠÙ„) ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ -->
        <div class="modal-content text-right" style="width: 420px;">
            <h3 class="text-xl font-bold text-blue-700 mb-3 text-center">
                Ø´Ø±Ø­ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„
            </h3>
            <!-- (ØªØ¹Ø¯ÙŠÙ„) ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²Ù„Ø§Ù‚ Ù‡Ù†Ø§ -->
            <div id="solution-content" class="space-y-3 text-gray-700">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø´Ø±Ø­ Ù‡Ù†Ø§ -->
            </div>
            <button id="close-solution-btn" class="mt-5 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ÙÙ‡Ù…Øª
            </button>
        </div>
    </div>


    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (end-game-screen) -->
    <div id="end-game-screen" class="container max-w-lg w-full mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-xl flex-col items-center justify-center text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-700 mb-4">
            Ø£Ù†Ù‡ÙŠØª ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª!
        </h1>
        <p class="text-lg text-gray-700 mb-4">
            Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!
        </p>
        <p class="text-base text-gray-500 mb-6">
            Ø¥Ø¹Ø¯Ø§Ø¯: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†
        </p>
        <div id="final-result-display" class="my-4 p-4 bg-gray-100 rounded-lg w-full">
            <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        </div>
        <div id="leaderboard-loader" class="my-4" style="display: none;">
            <p class="text-blue-500">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„...</p>
        </div>
        <div id="leaderboard-container" class="w-full">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù‡Ù†Ø§ -->
        </div>
        <div id="finish-game-wrapper" class="mt-8" style="display: none;">
            <button id="finish-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
            </button>
            <button onclick="location.reload()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200 ml-2">
                Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            </button>
             <!-- (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª -->
             <button id="back-to-levels-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200 mt-3 w-full">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
            </button>
        </div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© (game-container) -->
    <div id="game-container" class="container max-w-xl w-full mx-auto bg-white p-4 sm:p-5 rounded-xl shadow-xl flex-col hidden">
        
        <script>
            var GAME_ID = 'g5_1_1'; 
            var GAME_MAX_POINTS = 100; // (30+30+40) = 100
            var PLATFORM_MAX_GRADE = 5; 
            var METRIC_TYPE = 'errors'; 
            var METRIC_LABEL = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡';
        </script>
        
        <div class="flex-shrink-0 mb-3 p-3 bg-gray-50 rounded-lg shadow-inner text-center">
            
            <div class="flex items-center justify-between gap-2 mb-2">
                 <button id="back-to-menu-btn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª" class="w-8 h-8 bg-red-100 text-red-700 rounded-full flex items-center justify-center font-bold text-lg transition hover:bg-red-200">
                    &#x2715;
                 </button>
                 <h2 id="question-text" class="text-base sm:text-lg font-semibold text-gray-800 text-center">
                     <!-- Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§ -->
                 </h2>
                 <button id="info-btn" title="Ø´Ø±Ø­ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©" class="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-lg transition hover:bg-blue-200">
                     â„¹ï¸
                 </button>
            </div>
            
            
            <div class="equations-box">
                <span id="equation1" class="equation-font text-blue-600 bg-white px-3 py-1 rounded-md border border-blue-200"></span>
                <span class="text-gray-500 font-bold text-lg">Ùˆ</span>
                <span id="equation2" class="equation-font text-purple-600 bg-white px-3 py-1 rounded-md border border-purple-200"></span>
            </div>
        </div>

        <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
        <div class="flex-grow min-h-0 mb-3 px-1"> 
            <div id="options-container" class="choices-grid-3"> 
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
            </div>
        </div>
        
        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© -->
        <div class="flex-shrink-0 text-center">
            <div id="feedback" class="h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold"></div>
            
            <button id="check-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200">
                ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            </button>
            <button id="next-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 hidden">
                Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
            <!-- Ø²Ø± Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ -->
            <button id="show-solution-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 ml-2 hidden">
                Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ
            </button>
            <button id="reset-choices-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 ml-2">
                Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            </button>
        </div>
    </div>

    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª SVG Ù„Ù„Ø­Ù‚Ù† (Ø¬Ø¯ÙŠØ¯) -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <symbol id="icon-lock" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
            </symbol>
            <symbol id="icon-replay" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.755l-.091-.454A6.5 6.5 0 002.5 12.5a6.5 6.5 0 0011.603 4.475l.894.447A7.5 7.5 0 014.28 18.179a.75.75 0 011.04-1.082l.006.003a5.5 5.5 0 019.986-3.676l.091.454A6.5 6.5 0 0017.5 7.5a6.5 6.5 0 00-11.603-4.475l-.894-.447A7.5 7.5 0 0115.72 1.821a.75.75 0 01-1.04 1.082l-.006-.003a5.5 5.5 0 01-4.688 8.524l.003-.001.002.001z" clip-rule="evenodd" />
            </symbol>
            <!-- (Ø¬Ø¯ÙŠØ¯) Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØ£Ø³ (Ù„Ù… Ø£Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø£Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø£ÙˆØ¶Ø­) -->
        </defs>
    </svg>

    <script>
        // --- Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ---
        const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        
        function toArabicNumerals(num) {
            if (num === null || num === undefined) return '';
            let str = String(num);
            let result = '';
            for (let i = 0; i < str.length; i++) {
                if (str[i] === '-') {
                    result += '\u200E-'; // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø§ØªØ¬Ø§Ù‡
                } else if (/\d/.test(str[i])) {
                    result += arabicNumerals[parseInt(str[i])];
                } else {
                    result += str[i];
                }
            }
            return result;
        }

        function formatEquation(equation, showOne = false) { 
            let formatted = String(equation);
            
            if (!showOne) {
                formatted = formatted.replace(/=\s*1x/g, '= x');
                formatted = formatted.replace(/\(\s*1x/g, '(x');
                formatted = formatted.replace(/=\s*-1x/g, '= -x');
                formatted = formatted.replace(/\(\s*-1x/g, '(-x');
                 formatted = formatted.replace(/= -x/g, '= \u200E-Ø³'); 
            } else {
                 formatted = formatted.replace(/=\s*-x/g, '= -1x'); 
                 formatted = formatted.replace(/\(\s*-x/g, '(-1x');
                formatted = formatted.replace(/=\s*x/g, '= 1x'); 
                 formatted = formatted.replace(/\(\s*x/g, '(1x');
            }
            
            // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø®ÙØ§Ø¡ + 0 Ø£Ùˆ - 0
            formatted = formatted.replace(/\+\s*0$/, ''); // "y = 3x + 0" -> "y = 3x"
            formatted = formatted.replace(/\-\s*0$/, ''); // "y = 3x - 0" -> "y = 3x"

            formatted = formatted.replace(/\((-?\d+)\/(\d+)\)/g, (match, num, den) => {
                const numArabic = toArabicNumerals(num);
                const denArabic = toArabicNumerals(den);
                return `<span class="fraction"><span class="numerator">${numArabic}</span><span class="denominator">${denArabic}</span></span>`;
            });
            
            formatted = formatted.replace(/-?\d+/g, (match) => {
                if (match.includes('<')) return match; 
                return toArabicNumerals(match);
            });
            
            // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø®ÙØ§Ø¡ + Ù  Ø£Ùˆ - Ù  (Ø¨Ø¹Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
            const zero = arabicNumerals[0];
            formatted = formatted.replace(new RegExp(`\\s*\\+\\s*${zero}(\\s|$)`), ' ');
            formatted = formatted.replace(new RegExp(`\\s*\\-\\s*${zero}(\\s|$)`), ' ');
            
            formatted = formatted.replace(/x/g, 'Ø³').replace(/y/g, 'Øµ');

             formatted = formatted.replace(/=\s*(\u200E-)/g, '=$1'); 
             formatted = formatted.replace(/\(\s*(\u200E-)/g, '($1');

             formatted = formatted.replace(new RegExp(toArabicNumerals('-') + 'Ø³', 'g'), '\u200E-Ø³');

            formatted = formatted.replace(/(\d*)Ø³\s*-\s*(\d*)Øµ/g, (match, a, b) => `${a || ''}Ø³ \u200E- ${b || ''}Øµ`); 

            formatted = formatted.replace(/ \+ /g, ' \u200E+\u200E ');
            formatted = formatted.replace(/ \- /g, ' \u200E-\u200E ');

            return formatted.trim(); // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø²Ø§Ø¦Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        }
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ù…Ù„ (Ù…Ø¹ Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª) ---
            const hint_slope = "Ù„Ø§Ø­Ø¸ Ø§Ù„Ù…ÙŠÙ„ (Ù…). Ù‡Ù„ Ù‡Ùˆ Ù…ØªØ³Ø§ÙˆÙ Ø£Ù… Ù…Ø®ØªÙ„ÙØŸ";
            const hint_intercept = "Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙ. Ù…Ø§Ø°Ø§ Ø¹Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ (Ø¨)ØŸ";
            
            const questionBank = {
                // --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„ (9 Ø£Ø³Ø¦Ù„Ø©) ---
                easy: [
                    { eq1: "y = 2x + 1", m1: 2, b1: 1, eq2: "y = 2x - 3", m2: 2, b2: -3, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = -1x + 4", m1: -1, b1: 4, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = 1x + 5", m1: 1, b1: 5, eq2: "y = 1x + 5", m2: 1, b2: 5, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -4x + 1", m1: -4, b1: 1, eq2: "y = -4x + 1", m2: -4, b2: 1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 1x - 3", m1: 1, b1: -3, eq2: "y = 1x + 4", m2: 1, b2: 4, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = 5x + 0", m1: 5, b1: 0, eq2: "y = -1x + 0", m2: -1, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = (1/2)x + 1", m1: 0.5, b1: 1, eq2: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = -2x + 7", m1: -2, b1: 7, eq2: "y = -2x + 7", m2: -2, b2: 7, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept }
                ],
                // --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø· (9 Ø£Ø³Ø¦Ù„Ø©) ---
                medium: [
                    { eq1: "y = 4x - 5", m1: 4, b1: -5, eq2: "3x + y = 2", eq2_simple: "y = -3x + 2", m2: -3, b2: 2, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -2x + 4", m1: -2, b1: 4, eq2: "2x + y = 1", eq2_simple: "y = -2x + 1", m2: -2, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y = 1x + 3", m1: 1, b1: 3, eq2: "x - y = -3", eq2_simple: "y = 1x + 3", m2: 1, b2: 3, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "x + y = 5", eq1_simple: "y = -1x + 5", m1: -1, b1: 5, eq2: "y = -1x + 2", m2: -1, b2: 2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "2x - y = 1", eq1_simple: "y = 2x - 1", m1: 2, b1: -1, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "6x + 2y = 8", eq1_simple: "y = -3x + 4", m1: -3, b1: 4, eq2: "y = -3x + 4", m2: -3, b2: 4, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 5x - 1", m1: 5, b1: -1, eq2: "10x - 2y = 2", eq2_simple: "y = 5x - 1", m2: 5, b2: -1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = 1x - 6", m1: 1, b1: -6, eq2: "4x + y = 9", eq2_simple: "y = -4x + 9", m2: -4, b2: 9, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = -1x + 7", m1: -1, b1: 7, eq2: "3x + 3y = 1", eq2_simple: "y = -1x + (1/3)", m2: -1, b2: 1/3, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept }
                ],
                // --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨ (12 Ø³Ø¤Ø§Ù„Ø§Ù‹) ---
                hard: [
                    { eq1: "2x + y = 6", eq1_simple: "y = -2x + 6", m1: -2, b1: 6, eq2: "x + y = 4", eq2_simple: "y = -1x + 4", m2: -1, b2: 4, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y + 4 = -2(x - 1)", eq1_simple: "y = -2x - 2", m1: -2, b1: -2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "2y = 6x + 4", eq1_simple: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = 3x + 2", m2: 3, b2: 2, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "x - 3y = 6", eq1_simple: "y = (1/3)x - 2", m1: 1/3, b1: -2, eq2: "y = (1/3)x + 1", m2: 1/3, b2: 1, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "y - 2 = 3(x - 1)", eq1_simple: "y = 3x - 1", m1: 3, b1: -1, eq2: "y + 1 = 3(x + 1)", eq2_simple: "y = 3x + 2", m2: 3, b2: 2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "x + 2y = 4", eq1_simple: "y = (-1/2)x + 2", m1: -0.5, b1: 2, eq2: "3x - y = 5", eq2_simple: "y = 3x - 5", m2: 3, b2: -5, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "4x - 2y = 8", eq1_simple: "y = 2x - 4", m1: 2, b1: -4, eq2: "y = 2x - 4", m2: 2, b2: -4, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y - 5 = 2(x - 1)", eq1_simple: "y = 2x + 3", m1: 2, b1: 3, eq2: "y - 1 = -1(x - 4)", eq2_simple: "y = -1x + 5", m2: -1, b2: 5, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope },
                    { eq1: "y = (1/2)x - 1", m1: 0.5, b1: -1, eq2: "2x - 4y = 4", eq2_simple: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "3x + 3y = 9", eq1_simple: "y = -1x + 3", m1: -1, b1: 3, eq2: "x + y = 3", eq2_simple: "y = -1x + 3", m2: -1, b2: 3, answer: "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", hint: hint_intercept },
                    { eq1: "y = (2/3)x + 1", m1: 2/3, b1: 1, eq2: "3y = 2x - 6", eq2_simple: "y = (2/3)x - 2", m2: 2/3, b2: -2, answer: "ØºÙŠØ± Ù…ØªØ³Ù‚", hint: hint_intercept },
                    { eq1: "5x - y = 0", eq1_simple: "y = 5x + 0", m1: 5, b1: 0, eq2: "x + y = 6", eq2_simple: "y = -1x + 6", m2: -1, b2: 6, answer: "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", hint: hint_slope }
                ]
            };
            
            const gameChoices = ["Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„", "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„", "ØºÙŠØ± Ù…ØªØ³Ù‚"];
            const motivationalQuotes = [
                "ÙƒÙ„Ù…Ø§ ØªØ¯Ø±Ø¨Øª Ø£ÙƒØ«Ø±ØŒ Ø£ØµØ¨Ø­Øª Ø£Ù‚ÙˆÙ‰!",
                "Ù„Ø§ ØªØªÙˆÙ‚ÙØŒ Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ ØªØ­Ù‚ÙŠÙ‚ Ø¥Ù†Ø¬Ø§Ø² Ø±Ø§Ø¦Ø¹!",
                "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ØªØ¹Ø©ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ!",
                "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù‚ÙŠÙ‚ Ø¯Ø±Ø¬Ø© Ø£ÙØ¶Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!",
                "Ø£Ù†Øª Ø¨Ø·Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…!"
            ];

            // --- Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
            const APP_STORAGE_KEY = `linearGameProgress_${GAME_ID}`;
            
            // (ØªØ¹Ø¯ÙŠÙ„) Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ‚Ø¯Ù… ÙŠØ®Ø²Ù† Ø§Ù„Ù†Ù‚Ø§Ø· (30ØŒ 30ØŒ 40) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
            const defaultProgress = {
                easy: { score: -1, total: 30, questions: 3, unlocked: true },
                medium: { score: -1, total: 30, questions: 3, unlocked: false },
                hard: { score: -1, total: 40, questions: 4, unlocked: false }
            };
            let playerProgress = { ...defaultProgress };

            // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
            let currentLevelName = 'easy'; 
            let currentLevelQuestions = []; 
            let currentQuestionIndex = 0; 
            
            // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·
            let currentLevelScore = 0; // (ØªØ¹Ø¯ÙŠÙ„) ÙŠØ®Ø²Ù† 10 Ø£Ùˆ 5 Ø£Ùˆ 0
            let lastPointsEarned = 0; // (10, 5, 0)
            
            // (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
            let isSecondTry = false; 

            // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„)
            let totalGameErrors = 0; // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)

            
            // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
            const welcomeModal = document.getElementById('welcome-modal');
            const showLevelsBtn = document.getElementById('show-levels-btn');
            const levelSelectModal = document.getElementById('level-select-modal');
            const levelsContainer = document.getElementById('levels-container');
            const quoteEl = document.getElementById('motivational-quote');
            const quoteContainer = document.getElementById('quote-container'); 
            const showLeaderboardBtn = document.getElementById('show-leaderboard-btn'); // (Ø¬Ø¯ÙŠØ¯)

            const replayConfirmModal = document.getElementById('replay-confirm-modal');
            const confirmReplayBtn = document.getElementById('confirm-replay-btn');
            const cancelReplayBtn = document.getElementById('cancel-replay-btn');
            let levelToReplay = null; 

            // (Ø¬Ø¯ÙŠØ¯) Ù†Ø§ÙØ°Ø© Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©
            const postGameModal = document.getElementById('post-game-modal');
            const showResultBtn = document.getElementById('show-result-btn');
            const improveScoreBtn = document.getElementById('improve-score-btn');

            const endGameScreen = document.getElementById('end-game-screen');
            const gameContainer = document.getElementById('game-container');
            const backToLevelsBtn = document.getElementById('back-to-levels-btn'); // (Ø¬Ø¯ÙŠØ¯)
            
            const equation1El = document.getElementById('equation1');
            const equation2El = document.getElementById('equation2');
            const optionsContainer = document.getElementById('options-container');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const resetChoicesBtn = document.getElementById('reset-choices-btn');
            const questionTextEl = document.getElementById('question-text');
            const infoModal = document.getElementById('info-modal');
            const infoBtn = document.getElementById('info-btn');
            const closeInfoBtn = document.getElementById('close-info-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            
            const solutionModal = document.getElementById('solution-modal');
            const solutionContentEl = document.getElementById('solution-content');
            const closeSolutionBtn = document.getElementById('close-solution-btn');
            const showSolutionBtn = document.getElementById('show-solution-btn');

            // Ù†ÙˆØ§ÙØ° Ø§Ù„Ù†Ù‚Ø§Ø·
            const scoreModal = document.getElementById('score-modal');
            const scoreTitle = document.getElementById('score-title');
            const pointsEarnedText = document.getElementById('points-earned-text');
            const continueBtn = document.getElementById('continue-btn');
            const currentQuestionText = document.getElementById('current-question-text');
            const totalScoreText = document.getElementById('total-score-text');

            // --- Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù… ---
            function loadProgress() {
                const savedProgress = localStorage.getItem(APP_STORAGE_KEY);
                if (savedProgress) {
                    playerProgress = JSON.parse(savedProgress);
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù…ØªÙˆØ§ÙÙ‚
                    if (!playerProgress.easy || !playerProgress.easy.questions) {
                        playerProgress = { ...defaultProgress };
                        saveProgress();
                    }
                } else {
                    playerProgress = { ...defaultProgress };
                    saveProgress();
                }
            }

            function saveProgress() {
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(playerProgress));
            }

            // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) ---
            function showModal(modal) {
                if(modal) modal.classList.add('show');
            }
            function hideModal(modal) {
                if(modal) modal.classList.remove('show');
            }
            
            function hideAllScreens() {
                hideModal(welcomeModal);
                hideModal(levelSelectModal);
                hideModal(scoreModal);
                hideModal(infoModal);
                hideModal(replayConfirmModal);
                hideModal(solutionModal);
                hideModal(postGameModal); // (Ø¬Ø¯ÙŠØ¯)
                gameContainer.classList.add('hidden');
                endGameScreen.classList.add('hidden');
                endGameScreen.classList.remove('flex');
                gameContainer.classList.remove('flex');
            }

            // --- Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ---
            function showWelcomeModal() {
                hideAllScreens();
                showModal(welcomeModal);
            }

            // (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙƒØ£Ø³ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨
            function showLevelSelectModal() {
                hideAllScreens();
                renderLevelButtons();
                
                // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ© ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
                quoteEl.innerHTML = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                quoteContainer.className = "mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-center";
                
                // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ÙƒØ£Ø³
                if (playerProgress.hard.score > -1) {
                    showLeaderboardBtn.classList.remove('hidden');
                } else {
                    showLeaderboardBtn.classList.add('hidden');
                }

                showModal(levelSelectModal);
            }

            // (ØªØ¹Ø¯ÙŠÙ„) Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø·)
            function renderLevelButtons() {
                levelsContainer.innerHTML = '';
                const levels = [
                    { id: 'easy', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„', icon: 'ğŸ™‚' },
                    { id: 'medium', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·', icon: 'ğŸ¤”' },
                    { id: 'hard', name: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨', icon: 'ğŸ§ ' }
                ];

                levels.forEach(level => {
                    const progress = playerProgress[level.id];
                    const button = document.createElement('button');
                    button.classList.add('level-button');

                    let scoreText = '';
                    let iconHTML = '';

                    if (progress.unlocked) {
                        if (progress.score > -1) {
                            // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªÙ…Ù„ (ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø·)
                            button.classList.add('completed');
                            scoreText = `Ø§Ù„Ø¯Ø±Ø¬Ø©: ${toArabicNumerals(progress.score)} / ${toArabicNumerals(progress.total)}`;
                            iconHTML = `<svg class="replay-icon"><use href="#icon-replay"></use></svg>`;
                            button.onclick = () => {
                                levelToReplay = level.id; 
                                showModal(replayConfirmModal); 
                            };
                        } else {
                            // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…ÙØªÙˆØ­ ÙˆÙ„ÙƒÙ†Ù‡ Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ (ÙŠÙˆÙ…Ø¶)
                            button.classList.add('unlocked', 'glowing');
                            scoreText = 'Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡!';
                            button.onclick = () => startLevel(level.id);
                        }
                    } else {
                        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…Ù‚ÙÙ„
                        button.classList.add('locked');
                        scoreText = 'Ù…Ù‚ÙÙ„';
                        iconHTML = `<svg class="lock-icon"><use href="#icon-lock"></use></svg>`;
                        button.disabled = true;
                    }

                    button.innerHTML = `
                        ${iconHTML}
                        <span class="level-icon">${level.icon}</span>
                        <span class="level-title">${level.name}</span>
                        <span class="level-score">${scoreText}</span>
                    `;
                    levelsContainer.appendChild(button);
                });
            }

            // --- Ø¯ÙˆØ§Ù„ Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ø³ØªØ®Ø¯Ø§Ù… .questions Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            function getLevelQuestions(levelName) {
                const bank = [...questionBank[levelName]]; 
                shuffleArray(bank);
                const count = playerProgress[levelName].questions; // (3 Ø£Ùˆ 4)
                return bank.slice(0, count);
            }

            // --- Ø¯ÙˆØ§Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ¥Ù†Ù‡Ø§Ø¤Ù‡ ---

            function startLevel(levelName) {
                currentLevelName = levelName;
                currentLevelQuestions = getLevelQuestions(levelName);
                currentQuestionIndex = 0;
                currentLevelScore = 0; // (ØªØ¹Ø¯ÙŠÙ„) Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† 0 Ù†Ù‚Ø·Ø©
                isSecondTry = false; // (ØªØ¹Ø¯ÙŠÙ„)
                
                hideAllScreens();
                gameContainer.classList.remove('hidden');
                gameContainer.classList.add('flex');
                
                loadProblem(currentQuestionIndex);
            }

            // (Ù…Ø¹Ø¯Ù„) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„
            function loadProblem(index) {
                resetChoices(); // (ØªØ¹Ø¯ÙŠÙ„) resetChoices ÙŠØªØ¶Ù…Ù† Ø§Ù„Ø¢Ù† isSecondTry = false
                feedbackEl.textContent = '';
                feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold';
                
                lastPointsEarned = 0;
                
                const problem = currentLevelQuestions[index];
                
                equation1El.innerHTML = formatEquation(problem.eq1, false); 
                equation2El.innerHTML = formatEquation(problem.eq2, false); 
                
                const levelNameArabic = (currentLevelName === 'easy' ? 'Ø§Ù„Ø³Ù‡Ù„' : currentLevelName === 'medium' ? 'Ø§Ù„Ù…ØªÙˆØ³Ø·' : 'Ø§Ù„ØµØ¹Ø¨');
                const totalInLevel = currentLevelQuestions.length;
                questionTextEl.innerHTML = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${levelNameArabic}: (${toArabicNumerals(index + 1)}/${toArabicNumerals(totalInLevel)})`;

                optionsContainer.innerHTML = '';
                
                const shuffledChoices = [...gameChoices];
                shuffleArray(shuffledChoices);

                shuffledChoices.forEach(choiceText => {
                    const choiceEl = document.createElement('button');
                    choiceEl.classList.add('choice-button');
                    if (choiceText === "Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„") {
                        choiceEl.classList.add('hover:border-blue-500');
                    } else if (choiceText === "Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„") {
                        choiceEl.classList.add('hover:border-green-500');
                    } else {
                        choiceEl.classList.add('hover:border-red-500');
                    }
                    
                    choiceEl.innerHTML = choiceText;
                    choiceEl.dataset.value = choiceText; 
                    
                    choiceEl.addEventListener('click', () => {
                        toggleChoice(choiceEl);
                    });

                    optionsContainer.appendChild(choiceEl);
                });

                checkBtn.classList.remove('hidden');
                resetChoicesBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                showSolutionBtn.classList.add('hidden');
            }

            // (ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø°Ø±ÙŠ) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
            function checkAnswer() {
                const problem = currentLevelQuestions[currentQuestionIndex];
                const selectedChoiceEl = optionsContainer.querySelector('.choice-button.selected');
                
                if (!selectedChoiceEl) {
                    feedbackEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.';
                    feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-red-600';
                    return;
                }

                const selectedAnswer = selectedChoiceEl.dataset.value;
                const correctAnswer = problem.answer;
                let isCorrect = (selectedAnswer === correctAnswer);

                if (isCorrect) {
                    // --- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ---
                    feedbackEl.textContent = `Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.`;
                    feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-green-600';
                    selectedChoiceEl.classList.add('correct');
                    
                    if (isSecondTry) {
                        currentLevelScore += 5; // Ù†ØµÙ Ø§Ù„Ø¯Ø±Ø¬Ø©
                        lastPointsEarned = 5;
                        feedbackEl.textContent += ` (+${toArabicNumerals(5)} Ù†Ù‚Ø§Ø·)`;
                    } else {
                        currentLevelScore += 10; // Ø¯Ø±Ø¬Ø© ÙƒØ§Ù…Ù„Ø©
                        lastPointsEarned = 10;
                        feedbackEl.textContent += ` (+${toArabicNumerals(10)} Ù†Ù‚Ø§Ø·)`;
                    }
                    
                    showEndButtons(); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ù„ØªØ§Ù„ÙŠ" Ùˆ "Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§"

                } else {
                    // --- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© ---
                    selectedChoiceEl.classList.add('incorrect');
                    
                    if (isSecondTry) {
                        // --- Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ù„Ø£Ø®ÙŠØ±Ø©) ---
                        feedbackEl.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø±.';
                        feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-red-600';
                        lastPointsEarned = 0;
                        totalGameErrors++; // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¢Ù†
                        
                        // ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                        optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                            if (btn.dataset.value === correctAnswer) {
                                btn.classList.add('correct');
                            }
                        });
                        
                        showEndButtons(); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "Ø§Ù„ØªØ§Ù„ÙŠ" Ùˆ "Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§"
                    } else {
                        // --- Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ---
                        isSecondTry = true;
                        feedbackEl.textContent = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. ØªÙ„Ù…ÙŠØ­: ${problem.hint}`;
                        feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-yellow-600'; // Ù„ÙˆÙ† Ø§Ù„ØªÙ„Ù…ÙŠØ­
                        
                        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ø·Ø¦ ÙÙ‚Ø·
                        selectedChoiceEl.disabled = true;
                        selectedChoiceEl.classList.remove('selected');
                        
                        // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                        checkBtn.classList.remove('hidden');
                        resetChoicesBtn.classList.remove('hidden');
                        nextBtn.classList.add('hidden');
                    }
                }
            }


            // (Ù…Ø¹Ø¯Ù„) Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ÙŠØ­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø·)
            function completeLevel() {
                const currentProgress = playerProgress[currentLevelName];
                let isFirstTimeCompletingHard = false;

                // 1. (ØªØ¹Ø¯ÙŠÙ„) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠÙ†Ù‡ÙŠ Ø§Ù„ØµØ¹Ø¨ (ÙÙ‚Ø· Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
                if (currentLevelName === 'hard' && currentProgress.score === -1) {
                    isFirstTimeCompletingHard = true;
                }
                // (ØªØ¹Ø¯ÙŠÙ„) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
                currentProgress.score = currentLevelScore;


                // 2. ÙØªØ­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
                if (currentLevelName === 'easy' && currentProgress.score > -1) { // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù„Ø¹Ø¨
                    playerProgress.medium.unlocked = true;
                } else if (currentLevelName === 'medium' && currentProgress.score > -1) {
                    playerProgress.hard.unlocked = true;
                }

                // 3. Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…
                saveProgress();

                // 4. (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµØ¹Ø¨ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
                if (isFirstTimeCompletingHard) {
                    hideAllScreens();
                    showModal(postGameModal); 
                } else {
                    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
                    showLevelSelectModal();
                }
            }


            // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ---
            
            function toggleChoice(choiceEl) {
                optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                   if(btn !== choiceEl) btn.classList.remove('selected');
                });
                choiceEl.classList.toggle('selected');
            }

            // (ØªØ¹Ø¯ÙŠÙ„) Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            function resetChoices() {
                optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                    btn.classList.remove('selected', 'correct', 'incorrect');
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
                feedbackEl.textContent = ''; 
                isSecondTry = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                showSolutionBtn.classList.add('hidden');
            }

            function showEndButtons() {
                checkBtn.classList.add('hidden');
                resetChoicesBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                showSolutionBtn.classList.remove('hidden');
                 optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                     btn.disabled = true;
                     btn.style.cursor = 'not-allowed';
                 });
            }

            // (Ù…Ø¹Ø¯Ù„) Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
            function showPointsModal(points) {
                 const displayPoints = Math.round(points);

                if (displayPoints > 0) {
                    pointsEarnedText.textContent = `+${toArabicNumerals(displayPoints)} Ù†Ù‚Ø·Ø©`;
                    pointsEarnedText.classList.remove('text-red-600');
                    pointsEarnedText.classList.add('text-blue-700');
                    scoreTitle.textContent = (displayPoints === 10) ? 'Ù…Ù…ØªØ§Ø²!' : 'Ø£Ø­Ø³Ù†Øª!'; // (ØªØ¹Ø¯ÙŠÙ„)
                    scoreTitle.classList.add('text-green-600');
                    scoreTitle.classList.remove('text-red-600');
                } else {
                    pointsEarnedText.textContent = `+${toArabicNumerals(0)} Ù†Ù‚Ø·Ø©`;
                    pointsEarnedText.classList.remove('text-blue-700');
                    pointsEarnedText.classList.add('text-red-600');
                    scoreTitle.textContent = 'Ù„Ø§ Ø¨Ø£Ø³!';
                    scoreTitle.classList.remove('text-green-600');
                    scoreTitle.classList.add('text-red-600');
                }
                
                // (Ù…Ø¹Ø¯Ù„) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
                totalScoreText.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${toArabicNumerals(Math.round(currentLevelScore))}`; 
                currentQuestionText.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${toArabicNumerals(currentQuestionIndex + 1)} / ${toArabicNumerals(currentLevelQuestions.length)}`;
                showModal(scoreModal);
            }

            // (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            function handleContinueClick() {
                hideModal(scoreModal);
                
                const nextQuestionInLevel = currentQuestionIndex + 1;

                if (nextQuestionInLevel < currentLevelQuestions.length) {
                    currentQuestionIndex = nextQuestionInLevel;
                    loadProblem(currentQuestionIndex);
                } else {
                    completeLevel();
                }
            }

            // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±Ø­ Ø§Ù„Ø­Ù„
            function showSolution() {
                const problem = currentLevelQuestions[currentQuestionIndex];
                
                function formatM(m) {
                    if (m === 0.5) return formatEquation("(1/2)");
                    if (m === -0.5) return formatEquation("(-1/2)");
                    if (m === 1/3) return formatEquation("(1/3)");
                    if (m === 2/3) return formatEquation("(2/3)");
                    return toArabicNumerals(m);
                }
                
                function formatB(b) {
                    if (b === 1/3) return formatEquation("(1/3)");
                    // (ØªØ¹Ø¯ÙŠÙ„) Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„ØµÙØ±
                    if (b === 0) return toArabicNumerals(0);
                    return toArabicNumerals(b);
                }

                let html = '<p>Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©ØŒ Ù†Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„ØªÙŠÙ† Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ (Øµ = Ù… Ø³ + Ø¨):</p>';
                
                html += '<div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">';
                html += `<p><span class="font-bold">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù¡:</span> <span class="equation-font text-sm">${formatEquation(problem.eq1)}</span></p>`;
                if (problem.eq1_simple) {
                    html += `<p>Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§ØŒ ØªØµØ¨Ø­: <span class="equation-font text-sm">${formatEquation(problem.eq1_simple)}</span></p>`;
                }
                html += `<p>Ø¥Ø°Ù†: <span class="font-bold">Ø§Ù„Ù…ÙŠÙ„ (Ù…Ù¡) = ${formatM(problem.m1)}</span> , <span class="font-bold">Ø§Ù„Ù…Ù‚Ø·Ø¹ (Ø¨Ù¡) = ${formatB(problem.b1)}</span></p>`;
                html += '</div>';

                html += '<div class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded-lg">';
                html += `<p><span class="font-bold">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù¢:</span> <span class="equation-font text-sm">${formatEquation(problem.eq2)}</span></p>`;
                if (problem.eq2_simple) {
                    html += `<p>Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§ØŒ ØªØµØ¨Ø­: <span class="equation-font text-sm">${formatEquation(problem.eq2_simple)}</span></p>`;
                }
                html += `<p>Ø¥Ø°Ù†: <span class="font-bold">Ø§Ù„Ù…ÙŠÙ„ (Ù…Ù¢) = ${formatM(problem.m2)}</span> , <span class="font-bold">Ø§Ù„Ù…Ù‚Ø·Ø¹ (Ø¨Ù¢) = ${formatB(problem.b2)}</span></p>`;
                html += '</div>';

                html += '<div class="mt-3 pt-3 border-t">';
                let conclusion = '';
                
                const m1_rounded = Math.round(problem.m1 * 1000);
                const m2_rounded = Math.round(problem.m2 * 1000);
                const b1_rounded = Math.round(problem.b1 * 1000);
                const b2_rounded = Math.round(problem.b2 * 1000);

                if (m1_rounded !== m2_rounded) {
                    conclusion = `Ø¨Ù…Ø§ Ø£Ù† <span class="font-bold">Ø§Ù„Ù…ÙŠÙ„ Ù…Ø®ØªÙ„Ù</span> (Ù…Ù¡ â‰  Ù…Ù¢)ØŒ ÙØ§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Ù† Ù…ØªÙ‚Ø§Ø·Ø¹Ø§Ù†.<br>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="font-bold text-blue-600">Ù…ØªØ³Ù‚ ÙˆÙ…Ø³ØªÙ‚Ù„</span> (Ø­Ù„ ÙˆØ­ÙŠØ¯).`;
                } else {
                    if (b1_rounded !== b2_rounded) {
                        conclusion = `Ø¨Ù…Ø§ Ø£Ù† <span class="font-bold">Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙ</span> (Ù…Ù¡ = Ù…Ù¢) ÙˆÙ„ÙƒÙ† <span class="font-bold">Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ Ù…Ø®ØªÙ„Ù</span> (Ø¨Ù¡ â‰  Ø¨Ù¢)ØŒ ÙØ§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Ù† Ù…ØªÙˆØ§Ø²ÙŠØ§Ù†.<br>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="font-bold text-red-600">ØºÙŠØ± Ù…ØªØ³Ù‚</span> (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù„).`;
                    } else {
                        conclusion = `Ø¨Ù…Ø§ Ø£Ù† <span class="font-bold">Ø§Ù„Ù…ÙŠÙ„ Ù…ØªØ³Ø§ÙˆÙ</span> (Ù…Ù¡ = Ù…Ù¢) ÙˆÙ <span class="font-bold">Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµØ§Ø¯ÙŠ Ù…ØªØ³Ø§ÙˆÙ</span> (Ø¨Ù¡ = Ø¨Ù¢)ØŒ ÙÙ‡Ù…Ø§ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ….<br>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span class="font-bold text-green-600">Ù…ØªØ³Ù‚ ÙˆØºÙŠØ± Ù…Ø³ØªÙ‚Ù„</span> (Ø¹Ø¯Ø¯ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø­Ù„ÙˆÙ„).`;
                    }
                }
                html += `<p class="text-center font-semibold">${conclusion}</p></div>`;
                
                solutionContentEl.innerHTML = html;
                showModal(solutionModal);
            }

            // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©/Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
            function displayLeaderboardScreen() {
                hideAllScreens();
                endGameScreen.classList.remove('hidden'); 
                endGameScreen.classList.add('flex');

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const totalLeaderboardScore = (playerProgress.easy.score > -1 ? playerProgress.easy.score : 0) +
                                              (playerProgress.medium.score > -1 ? playerProgress.medium.score : 0) +
                                              (playerProgress.hard.score > -1 ? playerProgress.hard.score : 0);
                
                const resultDisplay = document.getElementById('final-result-display');
                const maxPointsPossible = GAME_MAX_POINTS || 1;
                if (resultDisplay) {
                    const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: <span class="font-bold text-xl">${toAr(Math.round(totalLeaderboardScore))} / ${toAr(maxPointsPossible)}</span></p>
                        <p class="text-sm text-gray-500">(Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ÙŠØ¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ùƒ)</p>
                    `;
                }

                // Ø¬Ù„Ø¨ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ø³Ø¬Ù„Ø©)
                if (window.fetchAndShowLeaderboard) {
                    window.fetchAndShowLeaderboard();
                } else {
                    showFinishButton();
                }
            }


            // (ØªØ¹Ø¯ÙŠÙ„) Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (ØªØ­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø­ÙØ¸)
            function handleGameEnd() {
                hideAllScreens();
                endGameScreen.classList.remove('hidden'); 
                endGameScreen.classList.add('flex');
                
                const totalLeaderboardScore = playerProgress.easy.score + playerProgress.medium.score + playerProgress.hard.score;

                if (window.saveAndFinishGame) {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    window.saveAndFinishGame(totalLeaderboardScore, totalGameErrors);
                } else {
                    console.error("Save function not found!");
                    const resultDisplay = document.getElementById('final-result-display');
                    const maxPointsPossible = GAME_MAX_POINTS || 1;
                    if (resultDisplay) {
                        const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                        resultDisplay.innerHTML = `
                            <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span class="font-bold text-xl">${toAr(Math.round(totalLeaderboardScore))} / ${toAr(maxPointsPossible)}</span></p>
                            <p class="text-red-600">${METRIC_LABEL}: <span class="font-bold text-xl">${toAr(totalGameErrors)}</span></p>
                        `;
                    }
                    if(window.fetchAndShowLeaderboard) window.fetchAndShowLeaderboard(); 
                }
            }

            // --- Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† ---
            
            showLevelsBtn.addEventListener('click', showLevelSelectModal);
            showLeaderboardBtn.addEventListener('click', displayLeaderboardScreen); // (Ø¬Ø¯ÙŠØ¯)
            backToLevelsBtn.addEventListener('click', showLevelSelectModal); // (Ø¬Ø¯ÙŠØ¯)

            // (Ø¬Ø¯ÙŠØ¯) Ù…Ø³ØªÙ…Ø¹Ùˆ Ù†Ø§ÙØ°Ø© Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©
            showResultBtn.addEventListener('click', handleGameEnd);
            improveScoreBtn.addEventListener('click', showLevelSelectModal);

            checkBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', () => {
                showPointsModal(lastPointsEarned); 
            });
            resetChoicesBtn.addEventListener('click', resetChoices);

            continueBtn.addEventListener('click', handleContinueClick);
            scoreModal.addEventListener('click', (e) => {
                if (e.target === scoreModal) {
                    handleContinueClick();
                }
            });

            // (ØªØ¹Ø¯ÙŠÙ„) Ù…Ø³ØªÙ…Ø¹Ùˆ Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ø­Ù„ (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚)
            
            // ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†ØµÙˆØµ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ "Ø¥Ø¹Ø§Ø¯Ø©"
            function setModalToReplay() {
                const modal = document.getElementById('replay-confirm-modal');
                modal.querySelector('h3').textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰';
                modal.querySelector('p').innerHTML = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŸ<br><span class="text-sm text-gray-500">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø£Ù‚Ù„).</span>';
                modal.querySelector('#confirm-replay-btn').textContent = 'Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯';
            }

            // ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†ØµÙˆØµ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ "Ø®Ø±ÙˆØ¬"
            function setModalToExit() {
                 const modal = document.getElementById('replay-confirm-modal');
                 modal.querySelector('h3').textContent = 'Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰';
                modal.querySelector('p').innerHTML = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ<br><span class="text-sm text-gray-500">Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ.</span>';
                modal.querySelector('#confirm-replay-btn').textContent = 'Ù†Ø¹Ù…ØŒ Ø§Ø®Ø±Ø¬';
            }

            cancelReplayBtn.addEventListener('click', () => {
                hideModal(replayConfirmModal);
                levelToReplay = null;
                setModalToReplay(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            });
            replayConfirmModal.addEventListener('click', (e) => {
                if (e.target === replayConfirmModal) {
                    hideModal(replayConfirmModal);
                    levelToReplay = null;
                    setModalToReplay(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                }
            });

            confirmReplayBtn.addEventListener('click', () => {
                if (levelToReplay === 'exit') {
                    // Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
                    hideModal(replayConfirmModal);
                    showLevelSelectModal(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                    levelToReplay = null;
                    setModalToReplay(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                } else if (levelToReplay) {
                    // Ø­Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨
                    hideModal(replayConfirmModal);
                    startLevel(levelToReplay);
                    levelToReplay = null;
                    setModalToReplay(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                }
            });

            showSolutionBtn.addEventListener('click', showSolution);
            closeSolutionBtn.addEventListener('click', () => hideModal(solutionModal));
            solutionModal.addEventListener('click', (e) => {
                if (e.target === solutionModal) {
                    hideModal(solutionModal);
                }
            });


            infoBtn.addEventListener('click', () => {
                closeInfoBtn.textContent = 'ÙÙ‡Ù…ØªØŒ Ù…ØªØ§Ø¨Ø¹Ø©!'; 
                showModal(infoModal);
            });
            closeInfoBtn.addEventListener('click', () => {
                hideModal(infoModal);
            });
            
            backToMenuBtn.addEventListener('click', () => {
                setModalToExit(); // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø®Ø±ÙˆØ¬
                levelToReplay = 'exit'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ø®Ø§ØµØ©
                showModal(replayConfirmModal);
            });

            // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
            loadProgress(); 
            showWelcomeModal(); 
        });
    </script>

    <!-- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·) -->
    <script>
    // --- START OF CONNECTION & LEADERBOARD ENGINE ---
    (function() {
        
        let SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        let GAME_ID, GAME_MAX_POINTS, PLATFORM_MAX_GRADE, METRIC_TYPE, METRIC_LABEL;

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const classId = urlParams.get('classId');
        const studentName = urlParams.get('studentName');

        let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

        window.saveAndFinishGame = function(points, metricValue) {
            
            GAME_ID = window.GAME_ID || 'default_game';
            GAME_MAX_POINTS = window.GAME_MAX_POINTS || 1;
            PLATFORM_MAX_GRADE = window.PLATFORM_MAX_GRADE || 5;
            METRIC_TYPE = window.METRIC_TYPE || 'time';
            METRIC_LABEL = window.METRIC_LABEL || 'Metric';

            const finalPoints = parseFloat(points) || 0;
            const finalMetric = parseFloat(metricValue) || 0;
            const maxPoints = parseFloat(GAME_MAX_POINTS) || 1; // (Ø§Ù„Ø¢Ù† 100)
            
            // (ØªØ¹Ø¯ÙŠÙ„) ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ 100 Ù†Ù‚Ø·Ø©
            let finalGrade = (maxPoints > 0) ? (finalPoints / maxPoints) * PLATFORM_MAX_GRADE : 0; 
            if (finalGrade > PLATFORM_MAX_GRADE) finalGrade = PLATFORM_MAX_GRADE;
             if (finalGrade < 0) finalGrade = 0; 

            const resultDisplay = document.getElementById('final-result-display');
            if (resultDisplay) {
                const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                resultDisplay.innerHTML = `
                    <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span class="font-bold text-xl">${toAr(Math.round(finalPoints))} / ${toAr(maxPoints)}</span></p>
                    <p class="text-blue-600">Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                    <p class="text-red-600">${METRIC_LABEL}: <span class="font-bold text-xl">${toAr(finalMetric)}</span></p>
                `;
            }

            if (studentId && classId) {
                const params = new URLSearchParams({
                    action: 'saveGrade',
                    studentId: studentId,
                    classId: classId,
                    itemId: GAME_ID,
                    grade: finalGrade.toFixed(2),
                    metricValue: Math.round(finalMetric).toString()
                });
                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(result => console.log('Save result:', result.status))
                    .catch(err => console.error("Save Error:", err))
                    .finally(fetchAndShowLeaderboard);
            } else {
                console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                fetchAndShowLeaderboard();
            }
        }

        window.fetchAndShowLeaderboard = function() {
            const loader = document.getElementById('leaderboard-loader');
            const container = document.getElementById('leaderboard-container');
            if (!loader || !container) {
                 showFinishButton(); 
                 return;
             }
            
            if (!classId) {
                console.log("No classId found, skipping leaderboard for visitor.");
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
                showFinishButton();
                return;
            }

            loader.style.display = 'block';
            container.innerHTML = '';

            const params = new URLSearchParams({
                action: 'getLeaderboard',
                gameId: GAME_ID,
                metricType: METRIC_TYPE,
                classId: classId
            });

            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        displayLeaderboard(response.data);
                    } else {
                        throw new Error(response.message || 'Failed to load leaderboard data.');
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    container.innerHTML = `<p class="text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
                })
                .finally(() => {
                    loader.style.display = 'none';
                    showFinishButton();
                });
        }
        
        function displayLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
             if (!container) return; 
             
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
                return;
            }

            let tableHTML = `
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                    <div class="leaderboard-scroll-container"> 
                        <table class="min-w-full bg-white shadow-md rounded-lg">
                            <thead class="bg-gray-800 text-white sticky top-0 z-10"> 
                                <tr>
                                    <th class="text-center py-2 px-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th class="text-right py-2 px-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th class="text-center py-2 px-3">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;

            data.forEach((player, index) => {
                const rank = index + 1;
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = 'ğŸ¥‡';
                if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                if (rank === 3) rankDisplay = 'ğŸ¥‰';

                const isCurrentUser = (currentUser && player.name === currentUser.name);
                const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');
                
                const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                        <td class="text-right py-2 px-3">${player.name}</td>
                        <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                        <td class="text-center py-2 px-3">${toAr(player.metricValue)}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table></div></div>`; 
            container.innerHTML = tableHTML;
        }

        function showFinishButton() {
            const finishWrapper = document.getElementById('finish-game-wrapper');
            if (finishWrapper) {
                finishWrapper.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', function(event) {
                if (event.target.id === 'finish-game-btn') {
                    window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                }
            });
        });
    })();
    // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>

</body>
</html>

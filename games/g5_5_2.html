<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุนุจุฉ ูุณุฑ ุงูุฎุฒูุฉ - ุญู ุงูุฃูุธูุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .digital-screen {
            font-family: 'Tajawal', sans-serif;
            background-color: #0f172a;
            box-shadow: inset 0 0 10px #000000;
            border: 4px solid #374151;
            position: relative;
            overflow: hidden;
        }
        
        .digital-screen::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .safe-btn {
            background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
            box-shadow: 3px 3px 6px #94a3b8, -3px -3px 6px #ffffff;
            transition: all 0.2s;
        }
        .safe-btn:active {
            box-shadow: inset 3px 3px 6px #94a3b8, inset -3px -3px 6px #ffffff;
            transform: scale(0.98);
        }
        
        .btn-correct {
            background: #16a34a !important;
            color: white !important;
            border-color: #15803d !important;
        }
        .btn-wrong {
            background: #dc2626 !important; 
            color: white !important;
            border-color: #b91c1c !important;
        }

        .led-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #374151;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .led-light.red-on {
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }
        .led-light.green-on {
            background-color: #22c55e;
            box-shadow: 0 0 10px #22c55e;
        }

        .equation-line {
            direction: rtl; 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            color: #22c55e;
            text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
            font-weight: bold;
        }

        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake-anim {
            animation: shake 0.4s ease-in-out;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .status-box {
            transition: all 0.3s ease;
        }
        .status-box.solved {
            background-color: #eab308;
            color: #000;
            border-color: #ca8a04;
            box-shadow: 0 0 15px #eab308;
            transform: scale(1.05);
        }
        .status-box.failed {
            background-color: #7f1d1d;
            color: #fecaca;
            border-color: #991b1b;
        }
        .status-box.active {
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            background-color: #064e3b;
            color: #4ade80;
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
        
        .vertical-math-grid {
            display: grid;
            grid-template-columns: repeat(5, auto);
            gap: 4px 12px;
            justify-content: center;
            direction: rtl;
            font-weight: bold;
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <div class="w-full max-w-md bg-gray-300 rounded-3xl p-4 shadow-2xl border-4 border-gray-400 relative overflow-hidden flex flex-col gap-2">
        
        <!-- ูุณุงููุฑ ุงูุฒููุฉ -->
        <div class="absolute top-2 left-2 w-3 h-3 rounded-full bg-gray-400 shadow-inner border border-gray-500"></div>
        <div class="absolute top-2 right-2 w-3 h-3 rounded-full bg-gray-400 shadow-inner border border-gray-500"></div>
        <div class="absolute bottom-2 left-2 w-3 h-3 rounded-full bg-gray-400 shadow-inner border border-gray-500"></div>
        <div class="absolute bottom-2 right-2 w-3 h-3 rounded-full bg-gray-400 shadow-inner border border-gray-500"></div>

        <!-- ุงูุดุฑูุท ุงูุนููู -->
        <div class="flex justify-between items-center bg-gray-200 rounded-xl px-4 py-2 shadow-inner border border-gray-300 text-xs text-gray-700 font-bold mx-2 mt-2">
            <div>ุงููุณุชูู: <span id="level-indicator" class="text-blue-700 text-sm">ูฃ/ู</span></div>
            <div>ุงูููุช: <span id="timer" class="text-blue-700 text-sm font-mono">ูู:ูู</span></div>
            <div>ุงูููุงุท: <span id="score-display" class="text-green-700 text-sm">ู</span></div>
        </div>

        <!-- ุดุงุดุฉ ุงูุนุฑุถ ุงูุฑูููุฉ -->
        <div id="display-screen" class="digital-screen min-h-[16rem] rounded-lg mx-2 p-4 flex flex-col items-center justify-center text-green-400 transition-all duration-300 relative">
            <div id="screen-content" class="text-center w-full relative h-full flex flex-col items-center justify-center z-10">
                <!-- ุงูุจุฏุงูุฉ -->
                <div class="animate-fadeInScaleUp w-full">
                    <p class="text-yellow-400 font-bold text-xl mb-2 tracking-wide">ูุธุงู ูุณุฑ ุงูุฎุฒูุฉ</p>
                    <p class="text-gray-300 text-xs mb-6 px-4 leading-relaxed">ุงุณุชุฎุฏู ููุงุฑุงุชู ุงูุฑูุงุถูุฉ ูู ุญู ุฃูุธูุฉ ุงููุนุงุฏูุงุช ุงูุฎุทูุฉ ููุชุญ ุงูุฎุฒูุงุช ุงูุฑูููุฉ ุงููุบููุฉ.</p>
                    <div class="border-t border-gray-700 w-2/3 mx-auto my-3"></div>
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 font-bold mb-1">ุชุตููู ูุจุฑูุฌุฉ</p>
                        <p class="text-sm text-blue-300 font-bold text-glow">ุงูุฃุณุชุงุฐ ุนุจุฏ ุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู</p>
                    </div>
                </div>
            </div>
            
            <!-- ููุงูุฐ ููุจุซูุฉ -->
            <div id="success-modal" class="hidden absolute inset-0 bg-black bg-opacity-95 z-20 flex flex-col items-center justify-center p-4 text-center">
                <div class="pop-in">
                    <div class="text-4xl mb-2">๐</div>
                    <h3 class="text-white font-bold text-xl mb-1">ุฅุฌุงุจุฉ ุตุญูุญุฉ!</h3>
                    <p id="success-points" class="text-yellow-400 text-lg font-bold mb-4">+ูกู ููุงุท</p>
                    <button id="success-next-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg text-sm transition transform hover:scale-105">ุงุณุชูุฑุงุฑ</button>
                </div>
            </div>

             <div id="solution-modal" class="hidden absolute inset-0 bg-gray-900 z-30 flex flex-col p-4 text-center">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                    <h3 class="text-red-400 font-bold text-lg">ุทุฑููุฉ ุงูุญู</h3>
                    <span class="bg-gray-700 text-white text-[10px] px-2 py-1 rounded animate-pulse">โธ๏ธ ุงูููุช ูุชููู</span>
                </div>
                <div id="solution-text" class="text-right text-gray-300 text-sm leading-7 custom-scrollbar overflow-y-auto flex-grow mb-3 px-2"></div>
                <button id="solution-next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg text-sm transition transform hover:scale-105 mt-auto">ูููุชุ ุงูุชุงูู</button>
            </div>

            <div id="feedback-overlay" class="absolute bottom-2 left-0 right-0 text-center text-xs font-bold h-6 z-10"></div>
        </div>

        <!-- ุงูุชุญูู -->
        <div id="control-panel" class="bg-gray-200 rounded-xl p-3 shadow-inner border border-gray-300 min-h-[200px] flex flex-col justify-center mx-2">
            <div id="start-controls" class="text-center w-full">
                <button onclick="startLevelIntro()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105 animate-pulse">ุงุจุฏุฃ ุงููุบุงูุฑุฉ</button>
            </div>

            <div id="navigation-controls" class="hidden text-center w-full">
                <button id="nav-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg animate-pulse">ุงุณุชูุฑุงุฑ</button>
            </div>

            <!-- ุงููุฑุญูุฉ 0: ุงุฎุชูุงุฑ ุงููุนุงุฏูุงุช -->
            <div id="equation-selection-controls" class="hidden w-full">
                <div class="flex justify-between items-center mb-1 px-1">
                    <p class="text-gray-700 text-xs font-bold">ุงุฎุชุฑ ุงููุธุงู ุงูููุงุณุจ:</p>
                    <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">ูกู ููุงุท</span>
                </div>
                <div id="eq-options-container" class="grid grid-cols-2 gap-2"></div>
            </div>

            <!-- ุงููุฑุญูุฉ 1: ุงุฎุชูุงุฑ ุงูุทุฑููุฉ -->
            <div id="method-controls" class="hidden w-full">
                <div class="flex justify-between items-center mb-1 px-1">
                    <p class="text-gray-700 text-sm font-bold">ุฃูุถู ุทุฑููุฉ ููุญูุ</p>
                    <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">ูกู ููุงุท</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-method-add" onclick="selectMethod('add')" class="safe-btn py-2 px-2 rounded text-gray-800 font-bold hover:bg-white text-xs">ุงูุญุฐู ุจุงูุฌูุน (+)</button>
                    <button id="btn-method-sub" onclick="selectMethod('sub')" class="safe-btn py-2 px-2 rounded text-gray-800 font-bold hover:bg-white text-xs">ุงูุชุนููุถ</button>
                    <button id="btn-method-mult" onclick="selectMethod('mult')" class="safe-btn py-2 px-2 rounded text-gray-800 font-bold hover:bg-white text-xs">ุงูุญุฐู ุจุงูุถุฑุจ (ร)</button>
                    <button id="btn-method-minus" onclick="selectMethod('minus')" class="safe-btn py-2 px-2 rounded text-gray-800 font-bold hover:bg-white text-xs">ุงูุญุฐู ุจุงูุทุฑุญ (-)</button>
                </div>
            </div>

            <!-- ุงููุฑุญูุฉ 2: ุงูุญู -->
            <div id="keypad-controls" class="hidden w-full">
                <div class="flex justify-end mb-1 px-1">
                     <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">ูกู ููุงุท</span>
                </div>
                <div class="flex justify-between mb-2 px-1 items-center bg-gray-300 rounded p-1">
                    <div class="flex items-center gap-2">
                        <span id="input-label" class="text-xs font-bold text-blue-900 bg-blue-100 px-2 py-1 rounded">ุฃุฏุฎู ุต</span>
                        <span id="input-display" class="font-bold text-xl bg-white px-3 border border-gray-400 rounded min-w-[80px] text-center h-10 flex items-center justify-center text-gray-800 tracking-widest"></span>
                    </div>
                    <button onclick="clearInput()" class="bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-1 rounded text-xs shadow">C</button>
                </div>
                <div class="keypad-grid">
                    <button onclick="pressKey(1)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูก</button>
                    <button onclick="pressKey(2)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูข</button>
                    <button onclick="pressKey(3)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูฃ</button>
                    <button onclick="pressKey(4)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูค</button>
                    <button onclick="pressKey(5)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูฅ</button>
                    <button onclick="pressKey(6)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูฆ</button>
                    <button onclick="pressKey(7)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูง</button>
                    <button onclick="pressKey(8)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูจ</button>
                    <button onclick="pressKey(9)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ูฉ</button>
                    <button onclick="toggleSign()" class="safe-btn p-3 rounded font-bold text-xl text-blue-800 bg-blue-50 border-blue-200">-</button>
                    <button onclick="pressKey(0)" class="safe-btn p-3 rounded font-bold text-xl text-gray-700">ู</button>
                    <button onclick="submitValue()" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded shadow-sm">โ</button>
                </div>
            </div>

             <!-- ุงูููุงูุฉ -->
             <div id="end-controls" class="hidden space-y-2 w-full">
                 <div id="leaderboard-container"></div>
                 <div id="leaderboard-loader" style="display: none;" class="flex justify-center items-center my-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <p class="mr-2 text-gray-600 text-xs">ุฌุงุฑู ุงูุญูุธ...</p>
                </div>
                 <button id="finish-game-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded text-sm hidden">ุฅููุงุก ูุญูุธ</button>
                 <button onclick="location.reload()" class="w-full bg-gray-500 text-white font-bold py-2 rounded text-sm">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
             </div>
        </div>

        <div class="flex justify-between items-center px-4 py-2 mx-2">
            <h1 class="text-xl font-bold text-gray-800 tracking-wider">ุงููุญูู <span class="text-blue-600">ุงูุฐูู</span></h1>
            <div class="flex gap-2">
                <div id="led-red" class="led-light red-on"></div>
                <div id="led-green" class="led-light"></div>
            </div>
        </div>
    </div>

    <script>
        function toArabicNum(n) {
            return n.toString().replace(/\d/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ"[d]).replace('-', '-');
        }

        const poolLevel1 = [
            {
                id: 101,
                title: "ูุบุฒ ุงููุฌููุน ูุงููุฑู",
                scenario: "ุนุฏุฏุงู (ุตุ ุณ). ูุฌููุน ุงูุนุฏุฏูู ูกูุ ูุงููุฑู ุจูู ุต ู ุณ ูู ูค.",
                eqReason: "ุงูุนุจุงุฑุฉ 'ูุฌููุน ุงูุนุฏุฏูู ูกู' ุชุนูู ุณ+ุต=ูกูุ ูุงูุนุจุงุฑุฉ 'ุงููุฑู ูค' ุชุนูู ุต-ุณ=ูค.",
                methodReason: "ูุฃู ุงููุชุบูุฑ ุณ ููุฌูุฏ ุจุฅุดุงุฑุงุช ูุฎุชููุฉ (+ุณ ู -ุณ) ููุณูู ุญุฐูู ุจุงูุฌูุน ูุจุงุดุฑุฉ.",
                correctSystemIdx: 0,
                options: [
                    { eq1: "ุต + ุณ = ูกู", eq2: "ุต - ุณ = ูค" },
                    { eq1: "ุต + ุณ = ูกู", eq2: "ุต + ุณ = ูค" },
                    { eq1: "ุต - ุณ = ูกู", eq2: "ุต + ุณ = ูค" },
                    { eq1: "ุต + ุณ = ูค", eq2: "ุต - ุณ = ูกู" }
                ],
                bestMethod: "add",
                sad: 7, seen: 3,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุฎุทูุฉ ูก: ุงูุฌูุน ุงูุนููุฏู</p><p class="text-xs text-gray-300">ูุถุน ุงููุนุงุฏูุชูู ููู ุจุนุถููุง ููุฌูุน:</p><div class="bg-gray-800 p-3 rounded border border-gray-600 w-fit mx-auto shadow-md"><div class="vertical-math-grid text-white"><div>ุต</div> <div>+</div> <div>ุณ</div> <div>=</div> <div>ูกู</div><div>ุต</div> <div>-</div> <div>ุณ</div> <div>=</div> <div>ูค</div><div class="col-span-5 border-b-2 border-white my-1 relative"><span class="absolute -right-4 top-[-10px] text-yellow-400 font-bold">+</span></div><div>ูขุต</div> <div></div> <div class="text-gray-500 text-[10px]">(ู)</div> <div>=</div> <div>ูกูค</div></div></div><p class="text-green-300 font-bold text-xs mt-2">ุงูุฎุทูุฉ ูข: ุฅูุฌุงุฏ ุต</p><p class="text-xs">ููุณู ุงูุทุฑููู ุนูู ูข:<br> ุต = ูกูค รท ูข = <span class="text-yellow-400 font-bold">ูง</span></p></div>`,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุฎุทูุฉ ูฃ: ุงูุชุนููุถ ูุฅูุฌุงุฏ ุณ</p><p class="text-xs">ูุฌุฏูุง ุฃู <span class="text-yellow-400">ุต = ูง</span>.</p><p class="text-xs">ูุฎุชุงุฑ ุงููุนุงุฏูุฉ ุงูุฃููู (ุต + ุณ = ูกู) ููุนูุถ:</p><div class="bg-gray-800 p-2 rounded text-center text-xs font-bold text-white mb-2">ูง + ุณ = ูกู</div><p class="text-xs">ูุทุฑุญ ูง ูู ุงูุทุฑููู:</p><p class="text-xs">ุณ = ูกู - ูง = <span class="text-yellow-400 font-bold">ูฃ</span></p></div>`
            },
            {
                id: 102,
                title: "ูุบุฒ ุงูุตูุฏูููู",
                scenario: "ุตูุฏููุงู (ุณุ ุต) ูุฒูููุง ูุนุงู ูกูข ูุฌูุ ูุงููุฑู ุจูู ูุฒู ุต ููุฒู ุณ ูู ูข ูุฌู.",
                eqReason: "ุงููุฒู ูุนุงู: ุต+ุณ=ูกูข. ุงููุฑู: ุต-ุณ=ูข.",
                methodReason: "ูุฃู ุณ ููุฌูุฏุฉ ูุฑุฉ ููุฌุจุฉ ููุฑุฉ ุณุงูุจุฉุ ุงูุฌูุน ูุญุฐููุง ููุฑุงู.",
                correctSystemIdx: 1,
                options: [
                    { eq1: "ุต + ุณ = ูกูข", eq2: "ุต + ุณ = ูข" },
                    { eq1: "ุต + ุณ = ูกูข", eq2: "ุต - ุณ = ูข" }, // ุตุญ
                    { eq1: "ุต - ุณ = ูกูข", eq2: "ุต + ุณ = ูข" },
                    { eq1: "ุต = ูกูข", eq2: "ุณ = ูข" }
                ],
                bestMethod: "add",
                sad: 7, seen: 5,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุฌูุน ุงูุนููุฏู</p><p class="text-xs">ูุฌูุน ุงููุนุงุฏูุชูู:</p><div class="bg-gray-800 p-2 text-white text-center dir-ltr">2ุต = 14</div><p class="text-xs">ุฅุฐู ุต = ูง.</p></div>`,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุชุนููุถ</p><p class="text-xs">ุจูุง ุฃู ุต = ูงุ ูุนูุถ ูู (ุต+ุณ=ูกูข):<br>ูง + ุณ = ูกูข<br>ุณ = ูฅ.</p></div>`
            },
            {
                id: 103,
                title: "ูุบุฒ ุงูุชุทุงุจู",
                scenario: "ูุฏููุง ูุนุงุฏูุชุงู: ูฅุต + ูฃุณ = ูกูฃ ู ูฅุต + ุณ = ูกูก. ูุงุญุธ ุชุดุงุจู ุงูุญุฏูุฏ.",
                eqReason: "ุงููุนุงุฏูุงุช ูุนุทุงุฉ ูุจุงุดุฑุฉ ูู ุงููุบุฒ.",
                methodReason: "ุงูุญุฏ ูฅุต ููุฑุฑ ุจููุณ ุงูุฅุดุงุฑุฉ ูู ุงููุนุงุฏูุชููุ ุงูุทุฑุญ ูู ุงูุฃุณุฑุน ูุญุฐูู.",
                correctSystemIdx: 3,
                options: [
                    { eq1: "ูฅุต + ูฃุณ = ูกูฃ", eq2: "ูฅุต - ุณ = ูกูก" },
                    { eq1: "ูฅุต = ูกูฃ", eq2: "ูฅุต = ูกูก" },
                    { eq1: "ูฃุต + ูฅุณ = ูกูฃ", eq2: "ุต + ูฅุณ = ูกูก" },
                    { eq1: "ูฅุต + ูฃุณ = ูกูฃ", eq2: "ูฅุต + ุณ = ูกูก" } 
                ],
                bestMethod: "minus",
                startVar: 'seen', 
                sad: 2, seen: 1,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุญุฐู ุจุงูุทุฑุญ</p><p class="text-xs">ูุทุฑุญ ุงููุนุงุฏูุฉ ุงูุซุงููุฉ ูู ุงูุฃููู:</p><div class="bg-gray-800 p-2 text-white text-center dir-ltr">(5ุต - 5ุต) + (3ุณ - ุณ) = 13 - 11<br>2ุณ = 2 โ ุณ = 1</div></div>`,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุต</p><p class="text-xs">ุงูุขู ูุฌุฏ ุต ุจุงูุชุนููุถ ูู (5ุต + ุณ = 11):<br>5ุต + 1 = 11<br>5ุต = 10<br>ุต = 2</p></div>`
            }
        ];

        const poolLevel2 = [
            {
                id: 201,
                title: "ูุบุฒ ุงูุถุนู",
                scenario: "ูููุฉ ุต ุชุณุงูู ุถุนู ูููุฉ ุณุ ููุฌููุน ุงููููุชูู ูู ูกูข.",
                eqReason: "ุต=ูขุณ (ุงูุถุนู)ุ ุต+ุณ=ูกูข (ุงููุฌููุน).",
                methodReason: "ุงููุนุงุฏูุฉ ุงูุฃููู ุต=... ุฌุงูุฒุฉุ ูุงูุชุนููุถ ุฃุณุฑุน.",
                correctSystemIdx: 1,
                options: [
                    { eq1: "ุต = ุณ + ูข", eq2: "ุต + ุณ = ูกูข" },
                    { eq1: "ุต = ูขุณ", eq2: "ุต + ุณ = ูกูข" }, // ุตุญ
                    { eq1: "ุต = ูขุณ", eq2: "ุต - ุณ = ูกูข" },
                    { eq1: "ุณ = ูขุต", eq2: "ุต + ุณ = ูกูข" }
                ],
                bestMethod: "sub",
                startVar: 'seen', 
                sad: 8, seen: 4,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุชุนููุถ</p><p class="text-xs">ูุนูุถ (ูขุณ) ููุงู (ุต) ูู ุงููุนุงุฏูุฉ ุงูุซุงููุฉ:<br>ูขุณ + ุณ = ูกูข<br>ูฃุณ = ูกูข โ ุณ = ูค.</p></div>`,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุต</p><p class="text-xs">ูุฑุฌุน ูููุนุงุฏูุฉ (ุต = ูขุณ) ููุนูุถ ุนู ุณ ุจู ูค:<br>ุต = ูข(ูค) = ูจ.</p></div>`
            },
            {
                id: 202,
                title: "ูุบุฒ ุงูุฒูุงุฏุฉ",
                scenario: "ูููุฉ ุต ุชุฒูุฏ ุนู ูููุฉ ุณ ุจููุฏุงุฑ ูกุ ููุฌููุน ุงููููุชูู ูู ูง.",
                eqReason: "ุงูุฒูุงุฏุฉ: ุต=ุณ+ูก. ุงููุฌููุน: ุต+ุณ=ูง.",
                methodReason: "ุฅุญุฏู ุงููุนุงุฏูุงุช ูุฑุชุจุฉ (ุต ุจุฏูุงูุฉ ุณ)ุ ุงุณุชุฎุฏู ุงูุชุนููุถ.",
                correctSystemIdx: 2,
                options: [
                    { eq1: "ุต + ุณ = ูก", eq2: "ุต + ุณ = ูง" },
                    { eq1: "ุต = ุณ - ูก", eq2: "ุต + ุณ = ูง" },
                    { eq1: "ุต = ุณ + ูก", eq2: "ุต + ุณ = ูง" }, // ุตุญ
                    { eq1: "ุณ = ุต + ูก", eq2: "ุต + ุณ = ูง" }
                ],
                bestMethod: "sub",
                startVar: 'seen', 
                sad: 4, seen: 3,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุชุนููุถ</p><p class="text-xs">ูุนูุถ (ุณ+ูก) ููุงู ุต:<br>(ุณ+ูก) + ุณ = ูง<br>ูขุณ + ูก = ูง<br>ูขุณ = ูฆ โ ุณ = ูฃ.</p></div>`,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุต</p><p class="text-xs">ุต = ุณ + ูก = ูฃ + ูก = ูค.</p></div>`
            },
            {
                id: 203,
                title: "ูุบุฒ ุงูุซูุงุซุฉ ุฃุถุนุงู",
                scenario: "ูููุฉ ุณ ุชุณุงูู ุซูุงุซุฉ ุฃุถุนุงู ูููุฉ ุตุ ูุงููุฑู ุจูู ุณ ู ุต ูู ูฆ.",
                eqReason: "ุณ=ูฃุตุ ุณ-ุต=ูฆ.",
                methodReason: "ุณ ูุนุฒููุฉ ูู ุทุฑูุ ุงูุชุนููุถ ูู ุงูุฃูุณุจ.",
                correctSystemIdx: 0,
                options: [
                    { eq1: "ุณ = ูฃุต", eq2: "ุณ - ุต = ูฆ" }, // ุตุญ
                    { eq1: "ุต = ูฃุณ", eq2: "ุณ - ุต = ูฆ" },
                    { eq1: "ุณ = ูฃุต", eq2: "ุณ + ุต = ูฆ" },
                    { eq1: "ุณ = ูฃ + ุต", eq2: "ุณ - ุต = ูฆ" }
                ],
                bestMethod: "sub",
                sad: 3, seen: 9,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุชุนููุถ</p><p class="text-xs">ูุนูุถ (ูฃุต) ููุงู ุณ:<br>ูฃุต - ุต = ูฆ<br>ูขุต = ูฆ โ ุต = ูฃ.<br>ุณ = ูฃ(ูฃ) = ูฉ.</p></div>`,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุณ</p><p class="text-xs">ุจูุง ุฃู ุต=ูฃุ ูุณ=ูฃุตุ ูุฅู ุณ=ูฃรูฃ=ูฉ.</p></div>`
            }
        ];

        const poolLevel3 = [
            {
                id: 301,
                title: "ูุบุฒ ุงููุดุชุฑูุงุช",
                scenario: "ุงุดุชุฑู ุฃุญูุฏ ููููู ู ูฃ ุฏูุงุชุฑ ุจูุจูุบ ูกูฃ ุฑูุงูุงู. ูุงุดุชุฑู ุฎุงูุฏ ูฃ ุฃููุงู ู ุฏูุชุฑูู ุจูุจูุบ ูกูข ุฑูุงูุงู. (ุงูุฃููุงู=ุตุ ุงูุฏูุงุชุฑ=ุณ)",
                eqReason: "ุฃุญูุฏ: ูขุต + ูฃุณ = ูกูฃ. ุฎุงูุฏ: ูฃุต + ูขุณ = ูกูข.",
                methodReason: "ุงููุนุงููุงุช ูุฎุชููุฉ (ูขุ ูฃ)ุ ุงูุถุฑุจ ุถุฑูุฑู ูุชูุญูุฏูุง ูุงูุญุฐู.",
                correctSystemIdx: 2,
                options: [
                    { eq1: "ูขุต + ูฃุณ = ูกูฃ", eq2: "ูขุต + ูฃุณ = ูกูข" },
                    { eq1: "ูขุต + ูขุณ = ูกูฃ", eq2: "ูฃุต + ูฃุณ = ูกูข" },
                    { eq1: "ูขุต + ูฃุณ = ูกูฃ", eq2: "ูฃุต + ูขุณ = ูกูข" }, // ุตุญ
                    { eq1: "ูฃุต + ูขุณ = ูกูฃ", eq2: "ูขุต + ูฃุณ = ูกูข" } 
                ],
                bestMethod: "mult", 
                startVar: 'seen', 
                sad: 2, seen: 3,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุชูุญูุฏ ุงููุนุงููุงุช</p><p class="text-xs text-gray-300">ูุฌุจ ุถุฑุจ ุงููุนุงุฏูุชูู ูููุตูู ูุนูุณ ุงููุนุงูู:</p><div class="bg-gray-800 p-2 rounded text-center text-xs text-white dir-ltr">ูุถุฑุจ ุงููุนุงุฏูุฉ (ูก) ูู ูฃ โ ูฆุต + ูฉุณ = ูฃูฉ<br>ูุถุฑุจ ุงููุนุงุฏูุฉ (ูข) ูู -ูข โ -ูฆุต - ูคุณ = -ูขูค</div><p class="text-xs mt-2">ุจุงูุฌูุน: ูฅุณ = ูกูฅ โ ุณ = ูฃ.</p></div>`,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุต</p><p class="text-xs">ุจุงูุชุนููุถ ูู ุงููุนุงุฏูุฉ ุงูุฃููู: ูขุต + ูฃ(ูฃ) = ูกูฃ<br>ูขุต + ูฉ = ูกูฃ<br>ูขุต = ูค โ ุต = ูข.</p></div>`
            },
            {
                id: 302,
                title: "ูุบุฒ ุงูุฃุฑูุงู ุงููุจูุฑุฉ",
                scenario: "ุซูุงุซุฉ ุฃุถุนุงู ุต ูุถุงูุงู ุฅูููุง ุฃุฑุจุนุฉ ุฃุถุนุงู ุณ ูุณุงูู ูกูจ. ูุถุนูุง ุต ูุทุฑูุญุงู ููู ุณ ูุณุงูู ูก.",
                eqReason: "ูฃุต + ูคุณ = ูกูจุ ูขุต - ุณ = ูก.",
                methodReason: "ูุญุชุงุฌ ุถุฑุจ ุงููุนุงุฏูุฉ ุงูุซุงููุฉ ูู ูค ููุญุตู ุนูู -ูคุณ ููุญุฐููุง ูุน +ูคุณ ุจุงูุฌูุน.",
                correctSystemIdx: 0,
                options: [
                    { eq1: "ูฃุต + ูคุณ = ูกูจ", eq2: "ูขุต - ุณ = ูก" }, // ุตุญ
                    { eq1: "ูฃุต + ูคุณ = ูกูจ", eq2: "ูขุต + ุณ = ูก" },
                    { eq1: "ูฃุต - ูคุณ = ูกูจ", eq2: "ูขุต - ุณ = ูก" },
                    { eq1: "ูคุต + ูฃุณ = ูกูจ", eq2: "ุต - ูขุณ = ูก" }
                ],
                bestMethod: "mult",
                sad: 2, seen: 3,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุถุฑุจ ุงูุณุฑูุน</p><p class="text-xs text-gray-300">ูููู ุถุฑุจ ุงููุนุงุฏูุฉ ุงูุซุงููุฉ ูู ูค:</p><div class="bg-gray-800 p-2 rounded text-center text-xs text-white dir-ltr">ูจุต - ูคุณ = ูค</div><p class="text-xs mt-2">ูุฌูุนูุง ูุน ุงูุฃููู (ูฃุต + ูคุณ = ูกูจ):<br>ูกูกุต = ูขูข โ ุต = ูข.</p></div>`,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุณ</p><p class="text-xs">ูุนูุถ ุนู ุต ุจู ูข ูู ุงูุซุงููุฉ: ูข(ูข) - ุณ = ูก<br>ูค - ุณ = ูก โ ุณ = ูฃ.</p></div>`
            },
            {
                id: 303,
                title: "ูุบุฒ ุงูุชุญุฏู",
                scenario: "ุฎูุณุฉ ุฃูุซุงู ุต ูุถุงูุงู ุฅูููุง ุถุนูู ุณ ูุณุงูู ูกูฆ. ูุต ูุงุญุฏุฉ ูุถุงูุงู ุฅูููุง ุถุนูู ุณ ูุณุงูู ูจ. ุฃูุฌุฏ ุงูููู.",
                eqReason: "ูฅุต + ูขุณ = ูกูฆุ ุต + ูขุณ = ูจ.",
                methodReason: "ุงูุญุฏ ูขุณ ููุฑุฑ ุจููุณ ุงูุฅุดุงุฑุฉ. ุงุณุชุฎุฏุงู ุงูุทุฑุญ ูู ุงูุฃุณุฑุน.",
                correctSystemIdx: 1,
                options: [
                    { eq1: "ูฅุต + ูขุณ = ูกูฆ", eq2: "ุต - ูขุณ = ูจ" },
                    { eq1: "ูฅุต + ูขุณ = ูกูฆ", eq2: "ุต + ูขุณ = ูจ" }, // ุตุญ
                    { eq1: "ูขุต + ูฅุณ = ูกูฆ", eq2: "ูขุต + ุณ = ูจ" },
                    { eq1: "ูฅุต = ูกูฆ", eq2: "ูขุณ = ูจ" }
                ],
                bestMethod: "minus", // ุชู ุงูุชุนุฏูู ุฅูู ุงูุทุฑุญ
                sad: 2, seen: 3,
                solutionSad: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุงูุทุฑุญ ุงููุจุงุดุฑ</p><p class="text-xs text-gray-300">ุจูุง ุฃู ูขุณ ููุฑุฑุฉุ ูุทุฑุญ ุงููุนุงุฏูุฉ ุงูุซุงููุฉ ูู ุงูุฃููู:</p><div class="bg-gray-800 p-2 text-white text-center dir-ltr">(ูฅุต - ุต) + (ูขุณ - ูขุณ) = ูกูฆ - ูจ<br>ูคุต = ูจ โ ุต = ูข</div></div>`,
                solutionSeen: `<div class="space-y-3"><p class="text-green-300 font-bold text-xs">ุฅูุฌุงุฏ ุณ</p><p class="text-xs">ูุนูุถ ูู ุงูุซุงููุฉ: ูข + ูขุณ = ูจ โ ูขุณ = ูฆ โ ุณ = ูฃ.</p></div>`
            }
        ];

        // ... (ุจููุฉ ุงูููุฏ ูุงูุฏูุงู ุชุนูู ุจููุณ ุงูููุทู ุงูุณุงุจู) ...
        function selectRandomQuestions() {
            const l1 = poolLevel1[Math.floor(Math.random() * poolLevel1.length)];
            const l2 = poolLevel2[Math.floor(Math.random() * poolLevel2.length)];
            const l3 = poolLevel3[Math.floor(Math.random() * poolLevel3.length)];
            return [l1, l2, l3];
        }

        let levels = [];
        let currentLevelIdx = 0;
        let score = 0; 
        let levelScore = 0; 
        let startTime = 0;
        let timerInterval;
        let timerPaused = false;
        let currentInput = "";
        let inputPhase = "sad"; 
        let gameActive = false;
        let currentAttempts = 0;
        let currentQuestionScore = 10;

        const screenContent = document.getElementById('screen-content');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const successModal = document.getElementById('success-modal');
        const successPoints = document.getElementById('success-points');
        const successNextBtn = document.getElementById('success-next-btn');
        const solutionModal = document.getElementById('solution-modal');
        const solutionText = document.getElementById('solution-text');
        const solutionNextBtn = document.getElementById('solution-next-btn');
        const startControls = document.getElementById('start-controls');
        const navigationControls = document.getElementById('navigation-controls');
        const eqSelectionControls = document.getElementById('equation-selection-controls');
        const methodControls = document.getElementById('method-controls');
        const keypadControls = document.getElementById('keypad-controls');
        const endControls = document.getElementById('end-controls');
        const ledRed = document.getElementById('led-red');
        const ledGreen = document.getElementById('led-green');
        const inputDisplay = document.getElementById('input-display');
        const inputLabel = document.getElementById('input-label');
        const navBtn = document.getElementById('nav-btn');

        function startLevelIntro() {
            if (levels.length === 0) levels = selectRandomQuestions();
            startControls.classList.add('hidden');
            endControls.classList.add('hidden');
            gameActive = true; 
            if (startTime === 0) { startTime = Date.now(); startTimer(); }
            const level = levels[currentLevelIdx];
            levelScore = 0; 
            screenContent.innerHTML = `<div class="text-center animate-fadeInScaleUp"><p class="text-gray-500 text-sm mb-2">ุงููุณุชูู ${toArabicNum(currentLevelIdx + 1)}</p><h2 class="text-white text-2xl font-bold mb-4 text-glow">${level.title}</h2><div class="bg-gray-800 rounded p-3 border border-blue-500 inline-block"><p class="text-gray-400 text-xs">ูุฌููุน ุฏุฑุฌุงุช ุงููุฑุญูุฉ</p><p class="text-blue-400 text-xl font-bold mt-1">ูคู ููุทุฉ</p></div></div>`;
            hideAllControls();
            navigationControls.classList.remove('hidden');
            navBtn.onclick = startLevelGame;
            navBtn.innerText = "ุงุจุฏุฃ ุงููุณุชูู";
            updateStats();
        }

        function startLevelGame() { hideAllControls(); ledRed.classList.remove('red-on'); loadScenario(); }
        function startTimer() { clearInterval(timerInterval); timerInterval = setInterval(() => { if(!gameActive || timerPaused) return; const delta = Math.floor((Date.now() - startTime) / 1000); const mins = Math.floor(delta / 60).toString().padStart(2, '0'); const secs = (delta % 60).toString().padStart(2, '0'); document.getElementById('timer').innerText = toArabicNum(`${mins}:${secs}`); }, 1000); }
        function updateStats() { document.getElementById('level-indicator').innerText = toArabicNum(`${currentLevelIdx + 1}/3`); document.getElementById('score-display').innerText = toArabicNum(score); }
        function hideAllControls() { startControls.classList.add('hidden'); navigationControls.classList.add('hidden'); eqSelectionControls.classList.add('hidden'); methodControls.classList.add('hidden'); keypadControls.classList.add('hidden'); endControls.classList.add('hidden'); }
        function showFeedback(msg, type = 'neutral') { feedbackOverlay.innerText = msg; if (type === 'error') feedbackOverlay.className = "absolute bottom-2 left-0 right-0 text-center text-xs font-bold h-6 text-red-500 animate-pulse"; else if (type === 'success') feedbackOverlay.className = "absolute bottom-2 left-0 right-0 text-center text-xs font-bold h-6 text-green-400"; else feedbackOverlay.className = "absolute bottom-2 left-0 right-0 text-center text-xs font-bold h-6 text-gray-400"; setTimeout(() => { feedbackOverlay.innerText = ""; }, 3000); }
        function showSuccessModal(points, nextCallback) { successPoints.innerText = `+${toArabicNum(points)} ููุงุท`; successModal.classList.remove('hidden'); const allButtons = document.querySelectorAll('button'); allButtons.forEach(b => b.disabled = true); successNextBtn.disabled = false; successNextBtn.onclick = () => { successModal.classList.add('hidden'); allButtons.forEach(b => b.disabled = false); if(nextCallback) nextCallback(); }; }
        function showSolutionModal(content, nextCallback) { timerPaused = true; solutionText.innerHTML = content; solutionModal.classList.remove('hidden'); const allButtons = document.querySelectorAll('button'); allButtons.forEach(b => b.disabled = true); solutionNextBtn.disabled = false; solutionNextBtn.onclick = () => { timerPaused = false; solutionModal.classList.add('hidden'); allButtons.forEach(b => b.disabled = false); if(nextCallback) nextCallback(); }; }

        function loadScenario() {
            const level = levels[currentLevelIdx];
            currentAttempts = 0; currentQuestionScore = 10;
            screenContent.innerHTML = `<div class="text-xs text-yellow-500 mb-2 font-bold">ูููุฉ ูุฑุงุกุฉ ุงููุบุฒ</div><div class="text-white text-base leading-relaxed p-2 font-bold bg-gray-800 rounded border border-gray-600">"${level.scenario}"</div><div class="text-xs text-green-400 mt-2 animate-pulse">ุงุฎุชุฑ ุงููุนุงุฏูุงุช ุงูุตุญูุญุฉ ูู ุงูุฃุณูู</div>`;
            const optionsContainer = document.getElementById('eq-options-container');
            optionsContainer.innerHTML = '';
            level.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-gray-700 hover:bg-gray-600 text-white p-2 rounded border border-gray-500 text-sm flex flex-col items-center justify-center gap-1 transition-colors";
                btn.innerHTML = `<div class="text-green-300 font-bold" dir="rtl">${opt.eq1}</div><div class="text-green-300 font-bold" dir="rtl">${opt.eq2}</div>`;
                btn.onclick = () => checkEquationSelection(idx);
                optionsContainer.appendChild(btn);
            });
            hideAllControls(); eqSelectionControls.classList.remove('hidden');
        }

        function checkEquationSelection(selectedIdx) {
            const level = levels[currentLevelIdx];
            if (selectedIdx === level.correctSystemIdx) { playSound('correct'); addPoints(currentQuestionScore); showSuccessModal(currentQuestionScore, loadMethodPhase); } 
            else { currentAttempts++; playSound('wrong'); if (currentAttempts === 1) { currentQuestionScore = 8; showFeedback("ุฎุทุฃ! ุฎูุตูุช ุฏุฑุฌุชุงู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.", 'error'); } else { currentQuestionScore = 0; showSolutionModal(`<p class="mb-2 font-bold text-yellow-400">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู:</p><div class="bg-gray-800 p-2 rounded mb-2 font-mono text-xs text-green-300">${level.options[level.correctSystemIdx].eq1}<br>${level.options[level.correctSystemIdx].eq2}</div><p class="text-gray-300">${level.eqReason}</p>`, loadMethodPhase); } }
        }

        function loadMethodPhase() {
            const level = levels[currentLevelIdx];
            const correctOpt = level.options[level.correctSystemIdx];
            currentAttempts = 0; currentQuestionScore = 10;
            document.querySelectorAll('#method-controls button').forEach(btn => { btn.className = "safe-btn py-2 px-2 rounded text-gray-800 font-bold hover:bg-white text-xs"; btn.classList.remove('btn-correct', 'btn-wrong'); btn.disabled = false; });
            screenContent.innerHTML = `<div class="text-xs text-gray-400 mb-1">ุงููุธุงู ุงููุนุชูุฏ</div><div class="bg-black bg-opacity-40 p-2 rounded mb-2 border border-green-700 w-full"><div class="equation-line mb-1">${correctOpt.eq1}</div><div class="equation-line border-t border-gray-700 pt-1">${correctOpt.eq2}</div></div><div class="text-sm text-yellow-400 font-bold animate-pulse">ููู ุชุญู ูุฐุง ุงููุธุงูุ</div>`;
            hideAllControls(); methodControls.classList.remove('hidden');
        }

        function selectMethod(method) {
            const level = levels[currentLevelIdx];
            const btn = document.getElementById('btn-method-' + method);
            const correctBtn = document.getElementById('btn-method-' + level.bestMethod);
            let methodAr = "";
            switch(level.bestMethod) { case 'add': methodAr = "ุงูุญุฐู ุจุงูุฌูุน"; break; case 'sub': methodAr = "ุงูุชุนููุถ"; break; case 'mult': methodAr = "ุงูุญุฐู ุจุงูุถุฑุจ"; break; case 'minus': methodAr = "ุงูุญุฐู ุจุงูุทุฑุญ"; break; }
            if (method === level.bestMethod) { btn.classList.add('btn-correct'); playSound('correct'); addPoints(currentQuestionScore); showSuccessModal(currentQuestionScore, loadKeypadPhase); } 
            else { currentAttempts++; playSound('wrong'); btn.classList.add('btn-wrong'); if (currentAttempts === 1) { currentQuestionScore = 8; showFeedback("ููุณุช ุงูุทุฑููุฉ ุงูุฃุณุฑุน. ุฎุตู ุฏุฑุฌุชูู.", 'error'); } else { currentQuestionScore = 0; correctBtn.classList.add('btn-correct'); showSolutionModal(`<p class="mb-2 font-bold text-yellow-400">ุงูุทุฑููุฉ ุงูุฃูุณุจ ูู:</p><p class="text-green-300 font-bold mb-2">${methodAr}</p><p class="text-gray-300">${level.methodReason}</p>`, loadKeypadPhase); } }
        }

        function loadKeypadPhase() {
            const level = levels[currentLevelIdx];
            const correctOpt = level.options[level.correctSystemIdx];
            hideAllControls(); keypadControls.classList.remove('hidden');
            inputPhase = level.startVar || 'sad';
            screenContent.innerHTML = `<div class="bg-gray-800 p-3 rounded mb-2 w-full border-2 border-green-600 shadow-lg"><div class="flex flex-col items-center justify-center gap-1"><div class="text-xl sm:text-2xl font-bold text-green-400" dir="rtl">${correctOpt.eq1}</div><div class="w-2/3 h-0.5 bg-gray-600"></div><div class="text-xl sm:text-2xl font-bold text-green-400" dir="rtl">${correctOpt.eq2}</div></div></div><div class="bg-yellow-900 bg-opacity-40 border-r-2 border-yellow-500 pr-2 py-1 mb-2 w-full"><p class="text-[10px] sm:text-xs text-yellow-200">๐ก ุงุณุชุฎุฏู <b>ุงููุฑูุฉ ูุงูููู</b> ููุญู.</p></div><div class="flex justify-center gap-4 mt-1" dir="rtl"><div id="sad-status" class="status-box text-green-500 border border-green-500 px-3 py-1 rounded bg-green-900 font-bold text-lg min-w-[80px] text-center">ุต = ุ</div><div id="seen-status" class="status-box text-gray-500 border border-gray-700 px-3 py-1 rounded font-bold text-lg min-w-[80px] text-center">ุณ = ุ</div></div>`;
            currentInput = ""; currentAttempts = 0; currentQuestionScore = 10;
            updateInputDisplay();
        }

        function updateInputDisplay() {
            inputDisplay.innerText = toArabicNum(currentInput);
            const sadBox = document.getElementById('sad-status');
            const seenBox = document.getElementById('seen-status');
            sadBox.classList.remove('active'); seenBox.classList.remove('active');
            if (inputPhase === 'sad') { inputLabel.innerText = "ุฃุฏุฎู ูููุฉ ุต"; if(!sadBox.classList.contains('solved') && !sadBox.classList.contains('failed')) sadBox.classList.add('active'); } 
            else { inputLabel.innerText = "ุฃุฏุฎู ูููุฉ ุณ"; if(!seenBox.classList.contains('solved') && !seenBox.classList.contains('failed')) seenBox.classList.add('active'); }
        }

        function pressKey(num) { if (currentInput.length < 5) { currentInput += num; updateInputDisplay(); } }
        function toggleSign() { if (currentInput.startsWith('-')) currentInput = currentInput.substring(1); else currentInput = '-' + currentInput; updateInputDisplay(); }
        function clearInput() { currentInput = ""; updateInputDisplay(); }

        function submitValue() {
            if (currentInput === "") return;
            const val = parseInt(currentInput);
            const level = levels[currentLevelIdx];
            const correctVal = (inputPhase === 'sad') ? level.sad : level.seen;
            const elementId = (inputPhase === 'sad') ? 'sad-status' : 'seen-status';
            const statusEl = document.getElementById(elementId);

            if (val === correctVal) {
                playSound('correct'); addPoints(currentQuestionScore);
                statusEl.innerText = `${(inputPhase === 'sad' ? 'ุต' : 'ุณ')} = ${toArabicNum(val)}`;
                statusEl.classList.remove('bg-green-900', 'text-green-500', 'active');
                statusEl.classList.add('solved');
                clearInput();
                
                const startVar = level.startVar || 'sad';
                const firstVar = startVar;
                const secondVar = (startVar === 'sad') ? 'seen' : 'sad';

                if (inputPhase === firstVar) {
                    showSuccessModal(currentQuestionScore, () => {
                        inputPhase = secondVar;
                        currentAttempts = 0; currentQuestionScore = 10;
                        updateInputDisplay();
                    });
                } else { playSound('unlock'); completeLevel(true); }
            } else {
                currentAttempts++; playSound('wrong');
                inputDisplay.parentElement.classList.add('shake-anim');
                setTimeout(() => inputDisplay.parentElement.classList.remove('shake-anim'), 400);
                if (currentAttempts === 1) {
                    currentQuestionScore = 8; showFeedback("ุฎุทุฃ! ุฎูุตูุช ุฏุฑุฌุชุงู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.", 'error'); clearInput();
                } else {
                    currentQuestionScore = 0;
                    statusEl.innerText = `${(inputPhase === 'sad' ? 'ุต' : 'ุณ')} = ${toArabicNum(correctVal)}`;
                    statusEl.classList.add('failed');
                    clearInput();
                    const detailedExplanation = (inputPhase === 'sad') ? level.solutionSad : level.solutionSeen;
                    showSolutionModal(detailedExplanation, () => {
                        const startVar = level.startVar || 'sad';
                        if (inputPhase === startVar) {
                            inputPhase = (startVar === 'sad') ? 'seen' : 'sad';
                            currentAttempts = 0; currentQuestionScore = 10;
                            updateInputDisplay();
                        } else { completeLevel(false); }
                    });
                }
            }
        }

        // ... Other functions ...
        function addPoints(pts) { levelScore += pts; score += pts; updateStats(); }
        function completeLevel(success) { ledGreen.classList.add('green-on'); ledRed.classList.remove('red-on'); const msg = success ? "ุชู ุงููุชุญ!" : "ุชุฌุงูุฒ ุงููุธุงู..."; const color = success ? "text-white" : "text-orange-400"; screenContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-4xl ${color} font-bold animate-bounce">${msg}</div></div>`; feedbackOverlay.innerText = ""; setTimeout(() => { ledGreen.classList.remove('green-on'); showLevelSummary(); }, 1500); }
        function showLevelSummary() { let msg = ""; let color = ""; if (levelScore >= 35) { msg = "ุฃุฏุงุก ูุฐูู ูุง ุจุทู! ๐"; color = "text-green-400"; } else if (levelScore >= 20) { msg = "ุฃุฏุงุก ุฌูุฏ ุฌุฏุงู! ๐"; color = "text-yellow-400"; } else { msg = "ูุง ุจุฃุณุ ุญุงูู ุงูุชุฑููุฒ ุฃูุซุฑ ๐ช"; color = "text-orange-400"; } screenContent.innerHTML = `<div class="text-center animate-fadeInScaleUp"><h2 class="text-white text-xl font-bold mb-2">ููุฎุต ุงููุณุชูู</h2><p class="${color} text-lg font-bold mb-4 text-glow">${msg}</p><div class="bg-gray-800 rounded p-4 border border-gray-600 inline-block"><p class="text-gray-400 text-sm">ููุงุทู ูู ูุฐู ุงููุฑุญูุฉ</p><p class="text-white text-2xl font-bold mt-1">${toArabicNum(levelScore)} <span class="text-xs text-gray-500">/ ูคู</span></p></div></div>`; hideAllControls(); navigationControls.classList.remove('hidden'); currentLevelIdx++; if (currentLevelIdx < levels.length) { navBtn.onclick = startLevelIntro; navBtn.innerText = "ุงููุณุชูู ุงูุชุงูู"; } else { navBtn.onclick = endGame; navBtn.innerText = "ุฅููุงุก ุงููุนุจุฉ"; } }
        function endGame() { gameActive = false; clearInterval(timerInterval); const totalTime = Math.floor((Date.now() - startTime) / 1000); const finalGrade = (score / 120) * 5; screenContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full animate-fadeInScaleUp w-full px-4"><h2 class="text-green-400 text-2xl font-bold mb-4 text-glow tracking-wider">ุงูุชูุฑูุฑ ุงูููุงุฆู</h2><div class="grid grid-cols-2 gap-3 w-full max-w-xs mb-4"><div class="bg-gray-800 p-2 rounded border border-blue-500 text-center"><p class="text-[10px] text-gray-400">ูุฌููุน ุงูููุงุท</p><p class="text-white font-bold text-xl">${toArabicNum(score)} <span class="text-[10px]">/ูกูขู</span></p></div><div class="bg-gray-800 p-2 rounded border border-blue-500 text-center"><p class="text-[10px] text-gray-400">ุงูุฏุฑุฌุฉ</p><p class="text-yellow-400 font-bold text-xl">${toArabicNum(finalGrade.toFixed(1))} <span class="text-[10px]">/ูฅ</span></p></div></div><div class="bg-gray-900 px-4 py-2 rounded-full border border-gray-700"><p class="text-xs text-gray-400">ุงูููุช ุงูููู: <span class="text-white font-bold">${toArabicNum(totalTime)} ุซุงููุฉ</span></p></div></div>`; hideAllControls(); endControls.classList.remove('hidden'); if (window.saveAndFinishGame) { window.saveAndFinishGame(score, totalTime); } }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) { if (audioCtx.state === 'suspended') audioCtx.resume(); const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); const now = audioCtx.currentTime; if (type === 'correct') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(600, now); oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); oscillator.start(now); oscillator.stop(now + 0.1); } else if (type === 'wrong') { oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(150, now); oscillator.frequency.linearRampToValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2); oscillator.start(now); oscillator.stop(now + 0.2); } else if (type === 'unlock') { oscillator.type = 'square'; oscillator.frequency.setValueAtTime(800, now); oscillator.frequency.setValueAtTime(1500, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.4); oscillator.start(now); oscillator.stop(now + 0.4); } }
        (function() { const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec"; const GAME_ID = 'g5_5_2'; const GAME_MAX_POINTS = 120; const PLATFORM_MAX_GRADE = 5; const METRIC_TYPE = 'time'; const METRIC_LABEL = 'ุงูููุช (ุซ)'; const urlParams = new URLSearchParams(window.location.search); const studentId = urlParams.get('studentId'); const classId = urlParams.get('classId'); const studentName = urlParams.get('studentName'); let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null; function toArabicNum(n) { return n.toString().replace(/\d/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ"[d]); } window.saveAndFinishGame = function(points, metricValue) { const finalPoints = parseFloat(points) || 0; const finalMetric = parseFloat(metricValue) || 0; const maxPoints = GAME_MAX_POINTS; const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE; if (studentId && classId) { const loader = document.getElementById('leaderboard-loader'); if(loader) loader.style.display = 'flex'; const params = new URLSearchParams({ action: 'saveGrade', studentId: studentId, classId: classId, itemId: GAME_ID, grade: finalGrade.toFixed(2), metricValue: Math.round(finalMetric).toString() }); fetch(`${SCRIPT_URL}?${params.toString()}`).then(res => res.json()).then(() => fetchAndShowLeaderboard()).catch(() => fetchAndShowLeaderboard()); } else { fetchAndShowLeaderboard(); } }; function fetchAndShowLeaderboard() { const loader = document.getElementById('leaderboard-loader'); const container = document.getElementById('leaderboard-container'); if(loader) loader.style.display = 'none'; if (!container) return; if (!classId) { container.innerHTML = `<p class="text-center text-gray-500 mt-2 text-xs">ุณุฌู ุงูุฃุจุทุงู ูุชุงุญ ูููุณุฌููู ููุท.</p>`; showFinishButton(); return; } if(loader) loader.style.display = 'flex'; container.innerHTML = ''; const params = new URLSearchParams({ action: 'getLeaderboard', gameId: GAME_ID, metricType: METRIC_TYPE, classId: classId }); fetch(`${SCRIPT_URL}?${params.toString()}`).then(res => res.json()).then(response => { if (response.status === 'success' && response.data) { displayLeaderboard(response.data); } }).catch(err => { container.innerHTML = `<p class="text-center text-red-500 text-xs">ุฎุทุฃ ูู ุงูุชุญููู.</p>`; }).finally(() => { if(loader) loader.style.display = 'none'; showFinishButton(); }); }; function displayLeaderboard(data) { const container = document.getElementById('leaderboard-container'); if (!data || data.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 mt-2 text-xs">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ.</p>`; return; } let tableHTML = `<div class="mt-2 border-t pt-2 max-h-40 overflow-y-auto"><h3 class="text-sm font-bold text-center text-gray-800 mb-2">๐ ุฃุณุฑุน ุงูููุณุฑูู ๐</h3><table class="min-w-full text-xs bg-white rounded shadow-sm"><thead class="bg-blue-100 text-blue-900 sticky top-0"><tr><th class="py-1 px-1">#</th><th class="py-1 px-1 text-right">ุงูุงุณู</th><th class="py-1 px-1">ุงูุฏุฑุฌุฉ</th><th class="py-1 px-1">${METRIC_LABEL}</th></tr></thead><tbody class="text-gray-700">`; data.forEach((player, index) => { const rank = index + 1; const isCurrentUser = (currentUser && player.name === currentUser.name); const rowClass = isCurrentUser ? 'bg-yellow-100 font-bold' : (index % 2 === 0 ? 'bg-gray-50' : ''); tableHTML += `<tr class="${rowClass} border-b"><td class="text-center py-1 px-1">${toArabicNum(rank)}</td><td class="text-right py-1 px-1">${player.name}</td><td class="text-center py-1 px-1 font-bold">${toArabicNum(parseFloat(player.grade).toFixed(1))}</td><td class="text-center py-1 px-1">${toArabicNum(player.metricValue)}</td></tr>`; }); tableHTML += `</tbody></table></div>`; container.innerHTML = tableHTML; }; function showFinishButton() { const finishBtn = document.getElementById('finish-game-btn'); if (finishBtn) { finishBtn.classList.remove('hidden'); finishBtn.onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*'); } }; if (studentName) { document.getElementById('welcome-msg').innerHTML = `ุฃููุงู ุจุงููุญูู <span class="text-blue-600">${studentName}</span>`; } })();
    </script>
</body>
</html>

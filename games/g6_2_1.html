<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ุชุญุฏู ุงูุฃุจุทุงู V19.6 -   ุฃูุงุฏูููุฉ ุงููุถุงุก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; 
            max-width: 420px; 
            background: white; 
            border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); 
            border: 1px solid #f1f5f9;
            display: flex; 
            flex-direction: column; 
            height: 90vh; /* FIX: Force full height from start */
            max-height: 900px;
            overflow: hidden; 
            position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 6px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        /* ุณุฌู ุงูุฃุจุทุงู */
        .leaderboard-modal { 
            position: absolute; inset: 0; background: #ffffff; z-index: 100; 
            display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; 
        }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        
        .rank-row-me { background-color: #eff6ff !important; border-right: 4px solid #2563eb !important; }
        
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .leaderboard-name { color: #1e293b; font-weight: 800; font-size: 11px; }
        .leaderboard-rank { font-weight: 900; }

        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; align-items: center; line-height: 1.1; margin: 0 5px; }
        .fraction-num { border-bottom: 2.5px solid currentColor; padding: 0 4px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- ุฃููุงุท ุงููุนุจุฉ ุงูุฎุงุตุฉ --- */
        #space-game-container {
            background-color: #0f172a;
            color: white;
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 1.5rem;
        }
        
        /* Start Screen Layout Fix */
        #start-screen-content {
            background-color: #0f172a;
            color: white;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 0 0 1.5rem 1.5rem;
            overflow: hidden; /* Prevent double scrollbars */
        }

        .stars {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: #0f172a url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white"><circle cx="10" cy="10" r="0.5"/><circle cx="30" cy="40" r="0.4"/><circle cx="70" cy="20" r="0.6"/><circle cx="90" cy="80" r="0.5"/><circle cx="50" cy="50" r="0.3"/></svg>') repeat;
            opacity: 0.5;
            animation: moveStars 60s linear infinite;
        }
        @keyframes moveStars { from {background-position: 0 0;} to {background-position: 500px 500px;} }

        .game-fraction { display: inline-block; vertical-align: middle; text-align: center; font-size: 1.1em; margin: 0 4px; }
        .game-fraction > span { display: block; padding: 0 4px; }
        .game-fraction span.numerator { border-bottom: 2px solid white; }
        
        .math-display {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            direction: rtl;
            line-height: 1.5;
        }
        sup { font-size: 0.6em; vertical-align: super; margin-right: 1px; }

        .option-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #475569;
            transition: all 0.2s;
        }
        .option-btn:active { transform: scale(0.95); }
        .correct-anim { background-color: #22c55e !important; border-color: #22c55e !important; animation: pulse 0.4s; }
        .wrong-anim { background-color: #ef4444 !important; border-color: #ef4444 !important; animation: shake 0.4s; }
        
        @keyframes pulse { 50% { transform: scale(1.05); } }
        @keyframes shake { 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        .phase-enter { animation: slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #space-game-ui::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Feedback Explanation Styles */
        .explanation-step {
            text-align: right;
            margin-bottom: 8px;
            font-size: 13px;
            color: #e2e8f0;
            border-right: 3px solid #3b82f6;
            padding-right: 8px;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 4px;
        }
        .explanation-highlight { color: #fbbf24; font-weight: bold; }

        /* Moon Style */
        .moon-icon {
            background-color: #64748b;
            background-image: 
                radial-gradient(circle at 30% 40%, #334155 10%, transparent 11%),
                radial-gradient(circle at 70% 20%, #334155 6%, transparent 7%),
                radial-gradient(circle at 60% 70%, #334155 8%, transparent 9%),
                radial-gradient(circle at 20% 80%, #334155 4%, transparent 5%),
                radial-gradient(circle at 85% 85%, #334155 5%, transparent 6%);
            box-shadow: 0 0 40px rgba(100, 116, 139, 0.3);
            border: 2px solid #475569;
        }

        /* Engine Fire Animation */
        .fire-glow {
            position: absolute;
            bottom: 25px; 
            left: 30px;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #fbbf24 0%, #ef4444 60%, transparent 100%);
            filter: blur(8px);
            animation: fireFlicker 0.8s infinite alternate ease-in-out;
            z-index: 5;
            mix-blend-mode: screen;
        }

        @keyframes fireFlicker {
            0% { transform: scale(1) translate(0, 0); opacity: 0.6; }
            50% { opacity: 0.9; }
            100% { transform: scale(1.4) translate(-2px, 2px); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-3 text-right">

    <div class="compact-card">
        <!-- ุงูุดุฑูุท ุงูุนููู -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-blue-500"></i>
                <span id="top-student-name" class="truncate font-black"></span>
                <script>
                    (function() {
                        const p = new URLSearchParams(window.location.search);
                        const raw = p.get('name') || p.get('studentName') || p.get('username') || p.get('user');
                        const display = document.getElementById('top-student-name');
                        if (raw) {
                            display.textContent = decodeURIComponent(raw);
                        } else {
                            display.textContent = "ุจุทู ุงูุชุญุฏู";
                        }
                    })();
                </script>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">ู / ูฅ</span>
            </div>
        </div>

        <!-- ุงูุดุงุดุฉ 1: ุงูุจุฏุงูุฉ -->
        <div id="start-screen" class="h-full flex flex-col relative overflow-hidden">
            <div id="start-screen-content" class="p-6 text-center">
                <div class="stars"></div>
                <!-- Container fills height and centers content -->
                <div class="relative z-10 flex flex-col h-full justify-between py-4">
                    
                    <div class="flex-1 flex flex-col justify-center items-center">
                        <div class="w-32 h-32 rounded-full flex items-center justify-center mb-6 relative overflow-hidden moon-icon shrink-0">
                            <div class="fire-glow"></div>
                            <span class="relative z-10 text-6xl drop-shadow-md transform -rotate-12 block">๐</span>
                        </div>
                        
                        <h1 class="text-3xl font-black text-white mb-2 drop-shadow-lg">ุฃูุงุฏูููุฉ ุงููุถุงุก</h1>
                        <h2 class="text-lg font-bold text-blue-400 mb-6">ูููุฉ: ูุญูุฏุงุช ุงูุญุฏูุฏ</h2>
                        
                        <div class="bg-slate-800/80 p-5 rounded-2xl border border-blue-500/30 text-sm font-bold text-blue-100 leading-loose text-center backdrop-blur-sm shadow-xl w-full max-w-sm">
                            ุฃููุง ุงููุงุฆุฏุ ุงููููุฉ ููุณูุฉ ุฅูู ูค ูุทุงุนุงุช ูุถุงุฆูุฉ.<br>
                            ุนููู ุงุฌุชูุงุฒ ูฃ ุชุญุฏูุงุช ูู ูู ูุทุงุน ูุฅุตูุงุญ ุงูุณูููุฉ ุจุงููุงูู.
                        </div>
                    </div>
                    
                    <div class="w-full flex flex-row gap-3 items-stretch relative z-10 mt-6">
                        <button onclick="startGame()" class="btn-touch flex-[2.5] bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white shadow-[0_0_20px_rgba(37,99,235,0.4)] text-xl border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 py-4">
                            ุงูุทูุงู ุงููููุฉ <i class="fas fa-rocket mr-2 animate-bounce"></i>
                        </button>
                        <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-slate-800 text-slate-300 border border-slate-600 hover:bg-slate-700 text-xs flex-col leading-tight py-2 shadow-lg">
                            <i class="fas fa-trophy text-yellow-500 text-2xl mb-1"></i>
                            <span>ุงูุฃุจุทุงู</span>
                        </button>
                    </div>
                    
                    <p class="relative z-10 text-[10px] text-slate-500 font-bold mt-4 tracking-widest uppercase text-center opacity-60">ุฃ. ุนุจุฏ ุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู</p>
                </div>
            </div>
        </div>

        <!-- ุงูุดุงุดุฉ 2: ุงููุนุจุฉ -->
        <div id="game-screen" class="hidden p-3 flex flex-col h-full">
            <div class="hidden">
                <input type="number" id="input-achieved" value="0">
                <input type="number" id="input-max" value="120">
                <input type="number" id="input-metric-value" value="0">
                <button id="btn-metric-time" onclick="setMetricType('time')"></button>
            </div>

            <div id="space-game-container">
                <div class="stars"></div>
                
                <!-- Game Header with Timer -->
                <div class="relative z-10 flex justify-between items-center bg-slate-900/80 p-3 border-b border-slate-700">
                    <div class="text-blue-300 text-xs font-bold w-16">ุงูุชูุฏู: <span id="level-indicator" class="text-white">ูก/ูกูข</span></div>
                    
                    <!-- Timer Display -->
                    <div class="text-white text-xs font-bold flex items-center bg-slate-800 px-3 py-1 rounded-full border border-slate-600 shadow-inner mx-2">
                        <i class="fas fa-clock text-blue-400 ml-2 animate-pulse"></i>
                        <span id="timer-display" dir="ltr" class="font-mono tracking-widest">ูู:ูู</span>
                    </div>

                    <div class="text-yellow-400 text-xs font-bold w-16 text-left">ุงูููุงุท: <span id="score-display" class="text-white">ู</span></div>
                </div>

                <!-- Game Content -->
                <div id="space-game-ui" class="relative z-10 flex-1 overflow-y-auto p-4 flex flex-col items-center">
                    <div class="w-full h-1 bg-slate-700 rounded-full mb-6 mt-2 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="w-full bg-slate-800/90 border border-blue-500/30 rounded-2xl p-4 mb-4 text-center shadow-lg backdrop-blur-sm">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <span id="scenario-icon" class="text-2xl">โก</span>
                            <h3 id="scenario-title" class="text-sm font-bold text-blue-300">ุงูุนููุงู</h3>
                        </div>
                        <p id="scenario-desc" class="text-xs text-slate-400 mb-4">ุงููุตู...</p>
                        <div id="math-problem" class="bg-slate-900/80 rounded-xl p-6 text-white math-display text-2xl min-h-[100px] flex items-center justify-center border border-slate-700"></div>
                    </div>

                    <!-- Options -->
                    <div id="options-container" class="grid grid-cols-2 gap-3 w-full mb-10"></div>
                </div>

                <!-- Feedback Overlay -->
                <div id="feedback-overlay" class="absolute inset-0 z-40 bg-slate-900/95 flex items-center justify-center hidden backdrop-blur-md">
                    <div class="text-center p-6 w-full max-w-sm animate-bounce-in">
                        <div id="feedback-icon" class="text-5xl mb-3">โ</div>
                        <h3 id="feedback-msg" class="text-xl font-bold text-white mb-4">ููุชุงุฒ</h3>
                        
                        <!-- Buttons Row -->
                        <div class="flex gap-2">
                            <button onclick="nextStep()" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform active:scale-95">
                                ุงุณุชูุฑุงุฑ
                            </button>
                            <button onclick="showExplanation()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-yellow-400 font-bold py-3 px-2 rounded-xl shadow-lg transition-transform active:scale-95 text-sm border border-slate-600">
                                <i class="fas fa-lightbulb mb-1 block text-lg"></i>
                                ุงุนุฑู ููุงุฐุง
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Explanation Modal -->
                <div id="explanation-modal" class="absolute inset-0 z-50 bg-slate-900 flex flex-col hidden phase-enter">
                    <div class="stars"></div>
                    <div class="relative z-10 flex flex-col h-full p-4">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                            <h3 class="text-lg font-bold text-yellow-400">๐ก ููุงุฐุง ุญุฏุซ ุฐููุ</h3>
                            <button onclick="closeExplanation()" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        
                        <div id="explanation-content" class="flex-1 overflow-y-auto text-right text-slate-300 leading-relaxed bg-slate-800/50 p-4 rounded-xl border border-slate-600 math-display text-lg">
                            <!-- Content Injected Here -->
                        </div>
                        
                        <button onclick="closeExplanationAndNext()" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg">
                            ูููุชุ ุงุณุชูุฑุงุฑ
                        </button>
                    </div>
                </div>

                <!-- Phase Transition Modal -->
                <div id="phase-modal" class="absolute inset-0 z-50 bg-slate-900 flex flex-col hidden phase-enter">
                    <div class="stars"></div>
                    <div class="relative z-10 flex flex-col items-center justify-center h-full p-8 text-center">
                        <div class="w-20 h-20 rounded-full bg-green-500/20 border-2 border-green-500 flex items-center justify-center text-4xl mb-4 animate-pulse">โจ</div>
                        <h2 class="text-3xl font-black text-white mb-2">ุงูุชูู ุงููุทุงุน!</h2>
                        <p class="text-blue-300 mb-8 font-bold">ุฃุฏุงุก ุฑุงุฆุน ูู ุงููุณู ุงูุณุงุจู</p>
                        
                        <div class="bg-slate-800/80 p-6 rounded-2xl border border-blue-500/50 w-full mb-8 backdrop-blur-sm">
                            <p class="text-[10px] text-slate-400 font-bold mb-2 uppercase tracking-widest">ุงููุฏู ุงููุงุฏู</p>
                            <h3 id="next-phase-title" class="text-xl font-bold text-yellow-400 mb-2">ุนููุงู ุงููุฑุญูุฉ ุงููุงุฏูุฉ</h3>
                            <p id="next-phase-rule" class="text-sm text-white leading-relaxed">ูุงุนุฏุฉ ุงููุฑุญูุฉ ุงููุงุฏูุฉ...</p>
                        </div>
                        
                        <button onclick="startNextPhase()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-4 px-8 rounded-2xl shadow-[0_0_20px_rgba(34,197,94,0.4)] text-xl transition-transform hover:-translate-y-1">
                            ุจุฏุก ุงููุทุงุน ุงูุชุงูู <i class="fas fa-arrow-left mr-2"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ุงูุดุงุดุฉ 3: ุงููุชุงุฆุฌ -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full overflow-hidden text-center justify-center">
            <div id="final-stats" class="grid grid-cols-2 gap-2 mb-4"></div>
            <div class="bg-green-50 p-4 rounded-2xl border border-green-100 mb-4">
                <i class="fas fa-check-double text-green-500 text-2xl mb-1"></i>
                <p id="save-msg" class="font-black text-green-800 text-sm">ุชู ุงุนุชูุงุฏ ูุชูุฌุชู ุจูุฌุงุญ!</p>
            </div>
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-4 shadow-md">
                <i class="fas fa-crown ml-2"></i> ุณุฌู ุงูุฃุจุทุงู
            </button>
            <div class="mt-auto flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 text-sm font-bold">ุฅุนุงุฏุฉ</button>
                <button id="finish-btn" class="btn-touch flex-[2] bg-slate-900 text-white text-sm font-bold">ุฅููุงุก</button>
            </div>
        </div>

        <!-- ุณุฌู ุงูุฃุจุทุงู -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>ุณุฌู ุงููุชุตุฏุฑูู</h3>
                <button onclick="closeLeaderboardModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center transition-all hover:bg-red-50 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">ุฃุจุทุงู ูุตูู</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">ุฃุจุทุงู ุงููุนุจุฉ (ุงููู)</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl border border-slate-100 p-1 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><div class="sync-loader text-blue-500 text-3xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
            <p class="text-center text-[9px] text-slate-400 mt-2 font-mono italic">ุงูุชุฑุชูุจ ุญุณุจ ุงูุฏุฑุฌุฉ ุซู ุงูุฃูุถููุฉ</p>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        
        const GAME_ID = urlParams.get('gameId') || 'g6_2_1'; 
        const TOTAL_GAME_POINTS = 120; 

        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "ุจุทู ุงูุชุญุฏู");
        let currentMetricType = 'time';
        let currentLeaderboardMode = classId ? 'class' : 'global';
        let localVisitorResult = null;
        const toAr = (n) => String(n).replace(/\d/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ"[d]);

        const phases = [
            { title: "ุงููุทุงุน ุงูุฃูู: ูุณูุฉ ุงูููู", rule: "ุนูุฏ ูุณูุฉ ููุชูู ูููุง ููุณ ุงูุฃุณุงุณุ ูุทุฑุญ ุงูุฃุณุณ." },
            { title: "ุงููุทุงุน ุงูุซุงูู: ููุฉ ุงููุณูุฉ", rule: "ููุฒุน ุงูุฃุณ ุนูู ูู ูู ุงูุจุณุท ูุงูููุงู." },
            { title: "ุงููุทุงุน ุงูุซุงูุซ: ุงูุฃุณ ุงูุตูุฑ", rule: "ุฃู ููุฏุงุฑ (ุบูุฑ ุตูุฑู) ุฃุณ ุตูุฑ ูุณุงูู ุฏุงุฆูุงู ูก." },
            { title: "ุงููุทุงุน ุงูุฑุงุจุน: ุงูุฃุณ ุงูุณุงูุจ", rule: "ููุชุฎูุต ูู ุงูุฃุณ ุงูุณุงูุจุ ุงููุจ ุงูููุฏุงุฑ (ุจุณุท ูููุงู ุฃู ุงูุนูุณ)." }
        ];

        const questionBank = [
            // PHASE 0
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูฉ</sup></span><span class="denominator">ุณ<sup>ูฅ</sup></span></div>`, options: [{html: "ุณ<sup>ูค</sup>", isCorrect: true}, {html: "ุณ<sup>ูกูค</sup>", isCorrect: false}, {html: "ุณ<sup>ูคูฅ</sup>", isCorrect: false}, {html: "ุณ<sup>ูกูซูจ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุณ<sup>ูฉ</sup></span><span class="denominator">ุณ<sup>ูฅ</sup></span></div><div class="explanation-step">ุงููุงุนุฏุฉ: ุนูุฏ ุงููุณูุฉุ ูุทุฑุญ ุงูุฃุณุณ.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูฉ - ูฅ = ูค</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ุณ<sup>ูค</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ูกูขุฌ<sup>ูง</sup></span><span class="denominator">ูคุฌ<sup>ูฃ</sup></span></div>`, options: [{html: "ูฃุฌ<sup>ูค</sup>", isCorrect: true}, {html: "ูจุฌ<sup>ูค</sup>", isCorrect: false}, {html: "ูกูขุฌ<sup>ูค</sup>", isCorrect: false}, {html: "ูฃุฌ<sup>ูกู</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ูกูขุฌ<sup>ูง</sup></span><span class="denominator">ูคุฌ<sup>ูฃ</sup></span></div><div class="explanation-step">ูก. ููุณู ุงูุฃุนุฏุงุฏ: <span dir="ltr">ูกูข รท ูค = ูฃ</span></div><div class="explanation-step">ูข. ูุทุฑุญ ุงูุฃุณุณ: <span dir="ltr">ูง - ูฃ = ูค</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูฃุฌ<sup>ูค</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ุฃ<sup>ูฅ</sup>ุจ<sup>ูค</sup></span><span class="denominator">ุฃ<sup>ูข</sup>ุจ</span></div>`, options: [{html: "ุฃ<sup>ูฃ</sup>ุจ<sup>ูฃ</sup>", isCorrect: true}, {html: "ุฃ<sup>ูฃ</sup>ุจ<sup>ูค</sup>", isCorrect: false}, {html: "ุฃ<sup>ูง</sup>ุจ<sup>ูฅ</sup>", isCorrect: false}, {html: "ุฃุจ<sup>ูฃ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุฃ<sup>ูฅ</sup>ุจ<sup>ูค</sup></span><span class="denominator">ุฃ<sup>ูข</sup>ุจ</span></div><div class="explanation-step">ูุทุฑุญ ุฃุณุณ ุฃ: <span dir="ltr">ูฅ - ูข = ูฃ</span> โ ุฃ<sup>ูฃ</sup></div><div class="explanation-step">ูุทุฑุญ ุฃุณุณ ุจ: <span dir="ltr">ูค - ูก = ูฃ</span> โ ุจ<sup>ูฃ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ุฃ<sup>ูฃ</sup>ุจ<sup>ูฃ</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูจ</sup></span><span class="denominator">ุณ<sup>ูฃ</sup></span></div>`, options: [{html: "ุณ<sup>ูฅ</sup>", isCorrect: true}, {html: "ุณ<sup>ูกูก</sup>", isCorrect: false}, {html: "ุณ<sup>ูขูค</sup>", isCorrect: false}, {html: "ูก", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุณ<sup>ูจ</sup></span><span class="denominator">ุณ<sup>ูฃ</sup></span></div><div class="explanation-step">ุงููุงุนุฏุฉ: ุนูุฏ ุงููุณูุฉุ ูุทุฑุญ ุงูุฃุณุณ.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูจ - ูฃ = ูฅ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ุณ<sup>ูฅ</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ุต<sup>ูกู</sup></span><span class="denominator">ุต<sup>ูฆ</sup></span></div>`, options: [{html: "ุต<sup>ูค</sup>", isCorrect: true}, {html: "ุต<sup>ูกูฆ</sup>", isCorrect: false}, {html: "ุต<sup>ูฆู</sup>", isCorrect: false}, {html: "ุต<sup>ููซูฆ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุต<sup>ูกู</sup></span><span class="denominator">ุต<sup>ูฆ</sup></span></div><div class="explanation-step">ุงููุงุนุฏุฉ: ุนูุฏ ุงููุณูุฉุ ูุทุฑุญ ุงูุฃุณุณ.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูกู - ูฆ = ูค</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ุต<sup>ูค</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ูกูฅู<sup>ูฅ</sup></span><span class="denominator">ูฅู<sup>ูข</sup></span></div>`, options: [{html: "ูฃู<sup>ูฃ</sup>", isCorrect: true}, {html: "ูกูู<sup>ูฃ</sup>", isCorrect: false}, {html: "ูฃู<sup>ูง</sup>", isCorrect: false}, {html: "ูฅู<sup>ูฃ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ูกูฅู<sup>ูฅ</sup></span><span class="denominator">ูฅู<sup>ูข</sup></span></div><div class="explanation-step">ูก. ููุณู ุงูุฃุนุฏุงุฏ: <span dir="ltr">ูกูฅ รท ูฅ = ูฃ</span></div><div class="explanation-step">ูข. ูุทุฑุญ ุงูุฃุณุณ: <span dir="ltr">ูฅ - ูข = ูฃ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูฃู<sup>ูฃ</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ู<sup>ูค</sup>ู<sup>ูฃ</sup></span><span class="denominator">ู ู<sup>ูข</sup></span></div>`, options: [{html: "ู<sup>ูฃ</sup>ู", isCorrect: true}, {html: "ู<sup>ูค</sup>ู", isCorrect: false}, {html: "ู<sup>ูฃ</sup>ู<sup>ูฅ</sup>", isCorrect: false}, {html: "ู ู", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ู<sup>ูค</sup>ู<sup>ูฃ</sup></span><span class="denominator">ู ู<sup>ูข</sup></span></div><div class="explanation-step">ูุทุฑุญ ุฃุณุณ ู: <span dir="ltr">ูค - ูก = ูฃ</span> โ ู<sup>ูฃ</sup></div><div class="explanation-step">ูุทุฑุญ ุฃุณุณ ู: <span dir="ltr">ูฃ - ูข = ูก</span> โ ู</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ู<sup>ูฃ</sup>ู</span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ูขูุน<sup>ูจ</sup></span><span class="denominator">ูคุน<sup>ูฆ</sup></span></div>`, options: [{html: "ูฅุน<sup>ูข</sup>", isCorrect: true}, {html: "ูกูฆุน<sup>ูข</sup>", isCorrect: false}, {html: "ูฅุน<sup>ูกูค</sup>", isCorrect: false}, {html: "ูคุน<sup>ูข</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ูขูุน<sup>ูจ</sup></span><span class="denominator">ูคุน<sup>ูฆ</sup></span></div><div class="explanation-step">ูก. ููุณู ุงูุฃุนุฏุงุฏ: <span dir="ltr">ูขู รท ูค = ูฅ</span></div><div class="explanation-step">ูข. ูุทุฑุญ ุงูุฃุณุณ: <span dir="ltr">ูจ - ูฆ = ูข</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูฅุน<sup>ูข</sup></span></div>` },
            { phase: 0, questionHTML: `<div class="game-fraction"><span class="numerator">ู<sup>ูกูข</sup></span><span class="denominator">ู<sup>ูฅ</sup></span></div>`, options: [{html: "ู<sup>ูง</sup>", isCorrect: true}, {html: "ู<sup>ูกูง</sup>", isCorrect: false}, {html: "ู<sup>ูฆู</sup>", isCorrect: false}, {html: "ู<sup>ูขูซูค</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ู<sup>ูกูข</sup></span><span class="denominator">ู<sup>ูฅ</sup></span></div><div class="explanation-step">ุงููุงุนุฏุฉ: ุนูุฏ ุงููุณูุฉุ ูุทุฑุญ ุงูุฃุณุณ.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูกูข - ูฅ = ูง</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ู<sup>ูง</sup></span></div>` },

            // PHASE 1
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ูฃ</span><span class="denominator">ุณ</span></div>)<sup>ูข</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ูฉ</span><span class="denominator">ุณ<sup>ูข</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ูฃ</span><span class="denominator">ุณ<sup>ูข</sup></span></div>`, isCorrect: false}, {html: "ูฉุณ", isCorrect: false}, {html: "ูฆุณ<sup>ูข</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ูฃ</span><span class="denominator">ุณ</span></div>)<sup>ูข</sup><div class="explanation-step">ููุฒุน ุงูุฃุณ ุนูู ุงูุจุณุท: <span dir="ltr">ูฃ<sup>ูข</sup> = ูฉ</span></div><div class="explanation-step">ููุฒุน ุงูุฃุณ ุนูู ุงูููุงู: ุณ<sup>ูข</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูฉ</span><span class="denominator">ุณ<sup>ูข</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ุต</span><span class="denominator">ุน</span></div>)<sup>ูค</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุต<sup>ูค</sup></span><span class="denominator">ุน<sup>ูค</sup></span></div>`, isCorrect: true}, {html: "ุต<sup>ูค</sup>ุน", isCorrect: false}, {html: "ุตุน<sup>ูค</sup>", isCorrect: false}, {html: "ุต<sup>ูค</sup>ุน<sup>ูค</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุต</span><span class="denominator">ุน</span></div>)<sup>ูค</sup><div class="explanation-step">ููุฒุน ุงูุฃุณ ูค ุนูู ุงูุจุณุท: ุต<sup>ูค</sup></div><div class="explanation-step">ููุฒุน ุงูุฃุณ ูค ุนูู ุงูููุงู: ุน<sup>ูค</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุต<sup>ูค</sup></span><span class="denominator">ุน<sup>ูค</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ูขุฃ</span><span class="denominator">ุจ</span></div>)<sup>ูฃ</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ูจุฃ<sup>ูฃ</sup></span><span class="denominator">ุจ<sup>ูฃ</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ูฆุฃ<sup>ูฃ</sup></span><span class="denominator">ุจ<sup>ูฃ</sup></span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ูขุฃ<sup>ูฃ</sup></span><span class="denominator">ุจ<sup>ูฃ</sup></span></div>`, isCorrect: false}, {html: "ูจุฃ<sup>ูฃ</sup>ุจ<sup>ูฃ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ูขุฃ</span><span class="denominator">ุจ</span></div>)<sup>ูฃ</sup><div class="explanation-step">ููุจุณุท: <span dir="ltr">ูข<sup>ูฃ</sup> = ูจ</span> ู ุฃ<sup>ูฃ</sup></div><div class="explanation-step">ููููุงู: ุจ<sup>ูฃ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูจุฃ<sup>ูฃ</sup></span><span class="denominator">ุจ<sup>ูฃ</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ุณ</span><span class="denominator">ูค</span></div>)<sup>ูข</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ูกูฆ</span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ูค</span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ูจ</span></div>`, isCorrect: false}, {html: "ูกูฆุณ<sup>ูข</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุณ</span><span class="denominator">ูค</span></div>)<sup>ูข</sup><div class="explanation-step">ููุจุณุท: ุณ<sup>ูข</sup></div><div class="explanation-step">ููููุงู: <span dir="ltr">ูค<sup>ูข</sup> = ูกูฆ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ูกูฆ</span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ูข</span><span class="denominator">ุต</span></div>)<sup>ูฃ</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ูจ</span><span class="denominator">ุต<sup>ูฃ</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ูฆ</span><span class="denominator">ุต<sup>ูฃ</sup></span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ูข</span><span class="denominator">ุต<sup>ูฃ</sup></span></div>`, isCorrect: false}, {html: "ูจุต", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ูข</span><span class="denominator">ุต</span></div>)<sup>ูฃ</sup><div class="explanation-step">ููุจุณุท: <span dir="ltr">ูข<sup>ูฃ</sup> = ูจ</span></div><div class="explanation-step">ููููุงู: ุต<sup>ูฃ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูจ</span><span class="denominator">ุต<sup>ูฃ</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ุฃ</span><span class="denominator">ุจ</span></div>)<sup>ูฅ</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุฃ<sup>ูฅ</sup></span><span class="denominator">ุจ<sup>ูฅ</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ุฃ<sup>ูฅ</sup></span><span class="denominator">ุจ</span></div>`, isCorrect: false}, {html: "ุฃุจ<sup>ูฅ</sup>", isCorrect: false}, {html: "ูฅุฃุจ", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุฃ</span><span class="denominator">ุจ</span></div>)<sup>ูฅ</sup><div class="explanation-step">ููุฒุน ุงูุฃุณ ูฅ ุนูู ุงูุจุณุท: ุฃ<sup>ูฅ</sup></div><div class="explanation-step">ููุฒุน ุงูุฃุณ ูฅ ุนูู ุงูููุงู: ุจ<sup>ูฅ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุฃ<sup>ูฅ</sup></span><span class="denominator">ุจ<sup>ูฅ</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ูฃู</span><span class="denominator">ู</span></div>)<sup>ูข</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ูฉู<sup>ูข</sup></span><span class="denominator">ู<sup>ูข</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ูฃู<sup>ูข</sup></span><span class="denominator">ู<sup>ูข</sup></span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ูฆู<sup>ูข</sup></span><span class="denominator">ู<sup>ูข</sup></span></div>`, isCorrect: false}, {html: "ูฉู<sup>ูข</sup>ู", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ูฃู</span><span class="denominator">ู</span></div>)<sup>ูข</sup><div class="explanation-step">ููุจุณุท: <span dir="ltr">ูฃ<sup>ูข</sup> = ูฉ</span> ูู<sup>ูข</sup></div><div class="explanation-step">ููููุงู: ู<sup>ูข</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูฉู<sup>ูข</sup></span><span class="denominator">ู<sup>ูข</sup></span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ู</span><span class="denominator">ูฅ</span></div>)<sup>ูข</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ู<sup>ูข</sup></span><span class="denominator">ูขูฅ</span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ู<sup>ูข</sup></span><span class="denominator">ูกู</span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ู<sup>ูข</sup></span><span class="denominator">ูฅ</span></div>`, isCorrect: false}, {html: "ูขูฅู", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ู</span><span class="denominator">ูฅ</span></div>)<sup>ูข</sup><div class="explanation-step">ููุจุณุท: ู<sup>ูข</sup></div><div class="explanation-step">ููููุงู: <span dir="ltr">ูฅ<sup>ูข</sup> = ูขูฅ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ู<sup>ูข</sup></span><span class="denominator">ูขูฅ</span></div></div>` },
            { phase: 1, questionHTML: `(<div class="game-fraction"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ุต</span></div>)<sup>ูฃ</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูฆ</sup></span><span class="denominator">ุต<sup>ูฃ</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูฅ</sup></span><span class="denominator">ุต<sup>ูฃ</sup></span></div>`, isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูฆ</sup></span><span class="denominator">ุต</span></div>`, isCorrect: false}, {html: "ุณ<sup>ูฆ</sup>ุต<sup>ูฃ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ุต</span></div>)<sup>ูฃ</sup><div class="explanation-step">ููุจุณุท (ููุฉ ุงูููุฉ): <span dir="ltr">ูข ร ูฃ = ูฆ</span> โ ุณ<sup>ูฆ</sup></div><div class="explanation-step">ููููุงู: ุต<sup>ูฃ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุณ<sup>ูฆ</sup></span><span class="denominator">ุต<sup>ูฃ</sup></span></div></div>` },

            // PHASE 2
            { phase: 2, questionHTML: "ูกูฅุณ<sup>ู</sup>", options: [{html: "ูกูฅ", isCorrect: true}, {html: "ูก", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "ูกูฅุณ", isCorrect: false}], explanation: `ุงูุณุคุงู: ูกูฅุณ<sup>ู</sup><div class="explanation-step">ุงููุงุนุฏุฉ: ุฃู ููุฏุงุฑ ุฃุณ ุตูุฑ ูุณุงูู ูก.</div><div class="explanation-step">ุงูุชุนููุถ: <span dir="ltr">ูกูฅ ร ูก = ูกูฅ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูกูฅ</span></div>` },
            { phase: 2, questionHTML: `(<div class="game-fraction"><span class="numerator">ูฅุณ<sup>ูฉ</sup></span><span class="denominator">ูฃุต</span></div>)<sup>ู</sup>`, options: [{html: "ูก", isCorrect: true}, {html: "ู", isCorrect: false}, {html: "ูฅุณ", isCorrect: false}, {html: "ูฃุต", isCorrect: false}], explanation: `ุงูุณุคุงู: ุงูููุณ ูุงููุงู ุฃุณ ุตูุฑ.<div class="explanation-step">ุงููุงุนุฏุฉ: ุฃู ููุฏุงุฑ (ุบูุฑ ุตูุฑู) ุฃุณ ุตูุฑ ูุณุงูู ูก.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: `<div class="game-fraction"><span class="numerator">ุฌ<sup>ูค</sup></span><span class="denominator">ุฌ<sup>ูค</sup></span></div>`, options: [{html: "ูก", isCorrect: true}, {html: "ุฌ", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "ุฌ<sup>ูจ</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุฌ<sup>ูค</sup></span><span class="denominator">ุฌ<sup>ูค</sup></span></div><div class="explanation-step">ูุทุฑุญ ุงูุฃุณุณ: <span dir="ltr">ูค - ูค = ู</span></div><div class="explanation-step">ุฃู ููุฏุงุฑ ุฃุณ ุตูุฑ ูุณุงูู ูก.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: "ูง<sup>ู</sup>", options: [{html: "ูก", isCorrect: true}, {html: "ู", isCorrect: false}, {html: "ูง", isCorrect: false}, {html: "-ูง", isCorrect: false}], explanation: `ุงูุณุคุงู: ูง<sup>ู</sup><div class="explanation-step">ุงููุงุนุฏุฉ: ุฃู ุนุฏุฏ (ุบูุฑ ุงูุตูุฑ) ุฃุณ ุตูุฑ ูุณุงูู ูก.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: "(ุฃ ุจ ุฌ)<sup>ู</sup>", options: [{html: "ูก", isCorrect: true}, {html: "ู", isCorrect: false}, {html: "ุฃ ุจ ุฌ", isCorrect: false}, {html: "ูฃ", isCorrect: false}], explanation: `ุงูุณุคุงู: (ุฃ ุจ ุฌ)<sup>ู</sup><div class="explanation-step">ุงูููุฏุงุฑ ูุงููุงู ูุฑููุน ููุฃุณ ุตูุฑ.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: "ูจู<sup>ู</sup>", options: [{html: "ูจ", isCorrect: true}, {html: "ูก", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "ูจู", isCorrect: false}], explanation: `ุงูุณุคุงู: ูจู<sup>ู</sup><div class="explanation-step">ูุนูุถ ุนู ู<sup>ู</sup> ุจู ูก.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูจ ร ูก = ูจ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูจ</span></div>` },
            { phase: 2, questionHTML: "(-ูฃ)<sup>ู</sup>", options: [{html: "ูก", isCorrect: true}, {html: "-ูฃ", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "-ูก", isCorrect: false}], explanation: `ุงูุณุคุงู: (-ูฃ)<sup>ู</sup><div class="explanation-step">ุญุชู ุงูุฃุนุฏุงุฏ ุงูุณุงูุจุฉ (ุฏุงุฎู ููุณ) ุฃุณ ุตูุฑ ุชุณุงูู ูก.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: `<div class="game-fraction"><span class="numerator">ุต<sup>ูฅ</sup></span><span class="denominator">ุต<sup>ูฅ</sup></span></div>`, options: [{html: "ูก", isCorrect: true}, {html: "ุต", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "ุต<sup>ูกู</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุต<sup>ูฅ</sup></span><span class="denominator">ุต<sup>ูฅ</sup></span></div><div class="explanation-step">ุทุฑุญ ุงูุฃุณุณ: <span dir="ltr">ูฅ - ูฅ = ู</span></div><div class="explanation-step">ุต<sup>ู</sup> = ูก</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูก</span></div>` },
            { phase: 2, questionHTML: "ูขูฃู<sup>ู</sup>", options: [{html: "ูขูฃ", isCorrect: true}, {html: "ูก", isCorrect: false}, {html: "ู", isCorrect: false}, {html: "ู", isCorrect: false}], explanation: `ุงูุณุคุงู: ูขูฃู<sup>ู</sup><div class="explanation-step">ูุนูุถ ุนู ู<sup>ู</sup> ุจู ูก.</div><div class="explanation-step">ุงูุนูููุฉ: <span dir="ltr">ูขูฃ ร ูก = ูขูฃ</span></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ูขูฃ</span></div>` },

            // PHASE 3
            { phase: 3, questionHTML: "ู<sup>-ูค</sup>", options: [{html: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ู<sup>ูค</sup></span></div>`, isCorrect: true}, {html: "-ูคู", isCorrect: false}, {html: "ู<sup>ูค</sup>", isCorrect: false}, {html: "-ู<sup>ูค</sup>", isCorrect: false}], explanation: `ุงูุณุคุงู: ู<sup>-ูค</sup><div class="explanation-step">ุงููุงุนุฏุฉ: ููุชุฎูุต ูู ุงูุฃุณ ุงูุณุงูุจุ ุงููุจ ุงูููุฏุงุฑ ููููุงู.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูก</span><span class="denominator">ู<sup>ูค</sup></span></div></div>` },
            { phase: 3, questionHTML: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ู<sup>-ูฅ</sup></span></div>`, options: [{html: "ู<sup>ูฅ</sup>", isCorrect: true}, {html: "ู<sup>-ูฅ</sup>", isCorrect: false}, {html: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ู<sup>ูฅ</sup></span></div>`, isCorrect: false}, {html: "-ูฅู", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ูก</span><span class="denominator">ู<sup>-ูฅ</sup></span></div><div class="explanation-step">ุงูุฃุณ ุงูุณุงูุจ ูู ุงูููุงูุ ูุฑูุนู ููุจุณุท.</div><div class="explanation-step">ุชุชุบูุฑ ุฅุดุงุฑุฉ ุงูุฃุณ ุฅูู ููุฌุจ.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ู<sup>ูฅ</sup></span></div>` },
            { phase: 3, questionHTML: `(<div class="game-fraction"><span class="numerator">ุณ</span><span class="denominator">ุต</span></div>)<sup>-ูข</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุต<sup>ูข</sup></span><span class="denominator">ุณ<sup>ูข</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ุณ<sup>ูข</sup></span><span class="denominator">ุต<sup>ูข</sup></span></div>`, isCorrect: false}, {html: "-ูขุณ", isCorrect: false}, {html: "ุตุณ", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุณ</span><span class="denominator">ุต</span></div>)<sup>-ูข</sup><div class="explanation-step">ูก. ูููุจ ุงููุณุฑ ููุตุจุญ ุงูุฃุณ ููุฌุจุงู: (ุต/ุณ)<sup>ูข</sup></div><div class="explanation-step">ูข. ููุฒุน ุงูุฃุณ ูข.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุต<sup>ูข</sup></span><span class="denominator">ุณ<sup>ูข</sup></span></div></div>` },
            { phase: 3, questionHTML: "ุณ<sup>-ูฃ</sup>", options: [{html: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ุณ<sup>ูฃ</sup></span></div>`, isCorrect: true}, {html: "ุณ<sup>ูฃ</sup>", isCorrect: false}, {html: "-ูฃุณ", isCorrect: false}, {html: "ูก/ุณ", isCorrect: false}], explanation: `ุงูุณุคุงู: ุณ<sup>-ูฃ</sup><div class="explanation-step">ูููุจ ุงูููุฏุงุฑ ููููุงู.</div><div class="explanation-step">ูุตุจุญ ุงูุฃุณ ููุฌุจุงู.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูก</span><span class="denominator">ุณ<sup>ูฃ</sup></span></div></div>` },
            { phase: 3, questionHTML: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ู<sup>-ูข</sup></span></div>`, options: [{html: "ู<sup>ูข</sup>", isCorrect: true}, {html: "ู<sup>-ูข</sup>", isCorrect: false}, {html: "ูก/ู<sup>ูข</sup>", isCorrect: false}, {html: "-ูขู", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ูก</span><span class="denominator">ู<sup>-ูข</sup></span></div><div class="explanation-step">ุงูููุงู ูุญุชูู ุนูู ุฃุณ ุณุงูุจ.</div><div class="explanation-step">ูุฑูุนู ููุจุณุท ุจุนูุณ ุงูุฅุดุงุฑุฉ.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ู<sup>ูข</sup></span></div>` },
            { phase: 3, questionHTML: "ุน<sup>-ูฆ</sup>", options: [{html: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ุน<sup>ูฆ</sup></span></div>`, isCorrect: true}, {html: "ุน<sup>ูฆ</sup>", isCorrect: false}, {html: "-ูฆุน", isCorrect: false}, {html: "ูฆุน", isCorrect: false}], explanation: `ุงูุณุคุงู: ุน<sup>-ูฆ</sup><div class="explanation-step">ูููุจ ุงูููุฏุงุฑ ููุตุจุญ ูก ุนูู ุน.</div><div class="explanation-step">ูุฌุนู ุงูุฃุณ ููุฌุจุงู.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูก</span><span class="denominator">ุน<sup>ูฆ</sup></span></div></div>` },
            { phase: 3, questionHTML: `<div class="game-fraction"><span class="numerator">ุฃ<sup>ู</sup></span><span class="denominator">ุจ<sup>-ูฃ</sup></span></div>`, options: [{html: "ุจ<sup>ูฃ</sup>", isCorrect: true}, {html: "ุฃุจ<sup>ูฃ</sup>", isCorrect: false}, {html: "ูก/ุจ<sup>ูฃ</sup>", isCorrect: false}, {html: "ู", isCorrect: false}], explanation: `ุงูุณุคุงู: <div class="game-fraction text-yellow-400"><span class="numerator">ุฃ<sup>ู</sup></span><span class="denominator">ุจ<sup>-ูฃ</sup></span></div><div class="explanation-step">ุฃ<sup>ู</sup> = ูก</div><div class="explanation-step">ุจ<sup>-ูฃ</sup> ุชุตุนุฏ ููุจุณุท ูุชุตุจุญ ุจ<sup>ูฃ</sup></div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <span class="explanation-highlight">ุจ<sup>ูฃ</sup></span></div>` },
            { phase: 3, questionHTML: `(<div class="game-fraction"><span class="numerator">ุฃ</span><span class="denominator">ุจ</span></div>)<sup>-ูก</sup>`, options: [{html: `<div class="game-fraction"><span class="numerator">ุจ</span><span class="denominator">ุฃ</span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ุฃ</span><span class="denominator">ุจ</span></div>`, isCorrect: false}, {html: "-ุฃุจ", isCorrect: false}, {html: "ูก", isCorrect: false}], explanation: `ุงูุณุคุงู: (<div class="game-fraction text-yellow-400"><span class="numerator">ุฃ</span><span class="denominator">ุจ</span></div>)<sup>-ูก</sup><div class="explanation-step">ุงูุฃุณ -ูก ูุนูู "ุงููุนููุณ ุงูุถุฑุจู".</div><div class="explanation-step">ุจุจุณุงุทุฉุ ูููุจ ุงููุณุฑ.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ุจ</span><span class="denominator">ุฃ</span></div></div>` },
            { phase: 3, questionHTML: "ูขุณ<sup>-ูข</sup>", options: [{html: `<div class="game-fraction"><span class="numerator">ูข</span><span class="denominator">ุณ<sup>ูข</sup></span></div>`, isCorrect: true}, {html: `<div class="game-fraction"><span class="numerator">ูก</span><span class="denominator">ูขุณ<sup>ูข</sup></span></div>`, isCorrect: false}, {html: "ูขุณ<sup>ูข</sup>", isCorrect: false}, {html: "-ูคุณ", isCorrect: false}], explanation: `ุงูุณุคุงู: ูขุณ<sup>-ูข</sup><div class="explanation-step">ูุงุญุธ ุฃู ุงูุฃุณ ุงูุณุงูุจ ูู (ุณ) ููุท.</div><div class="explanation-step">ุงูุฑูู ูข ูุจูู ูู ุงูุจุณุทุ ูุงูุณูู ุชูุฒู ููููุงู.</div><div class="explanation-step">ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: <div class="game-fraction explanation-highlight"><span class="numerator">ูข</span><span class="denominator">ุณ<sup>ูข</sup></span></div></div>` }
        ];

        let currentLevelIndex = 0;
        let gameScore = 0;
        let gameStartTime = 0;
        let currentExplanationHTML = "";
        let sessionQuestions = [];
        let timerInterval;
        let isPaused = false;
        let elapsedSeconds = 0;
        let isFirstLevelLoad = true;
        let totalPauseDuration = 0;
        let pauseStartTime = 0;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            if (!classId) {
                document.getElementById('tab-class').style.display = 'none';
                currentLeaderboardMode = 'global';
            } else {
                document.getElementById('tab-class').className = 'tab-btn tab-active';
                document.getElementById('tab-global').className = 'tab-btn tab-inactive';
            }
            if (studentId && classId) {
                document.getElementById('sync-icon').classList.remove('hidden');
                fetchInitialCloudData();
            } else if (!urlParams.get('name')) {
                studentName = "ุจุทู ุฒุงุฆุฑ";
                document.getElementById('top-student-name').textContent = studentName;
            }
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startTimer() {
            clearInterval(timerInterval);
            elapsedSeconds = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    elapsedSeconds++;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const s = (elapsedSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = toAr(m) + ":" + toAr(s);
        }

        window.startGame = () => { 
            document.getElementById('start-screen').classList.add('hidden'); 
            document.getElementById('game-screen').classList.remove('hidden');
            setMetricType('time');
            
            sessionQuestions = [];
            for (let p = 0; p < 4; p++) {
                const phaseQuestions = questionBank.filter(q => q.phase === p);
                const shuffled = shuffleArray([...phaseQuestions]);
                const selected = shuffled.slice(0, 3);
                sessionQuestions = sessionQuestions.concat(selected);
            }

            currentLevelIndex = 0;
            gameScore = 0;
            totalPauseDuration = 0;
            isFirstLevelLoad = true;
            
            showPhaseTransition(0); 
        };

        function loadLevel(idx) {
            const data = sessionQuestions[idx];
            document.getElementById('level-indicator').textContent = `${toAr(idx + 1)}/${toAr(sessionQuestions.length)}`;
            document.getElementById('score-display').textContent = toAr(gameScore);
            document.getElementById('progress-bar').style.width = `${(idx / sessionQuestions.length) * 100}%`;
            
            const currentPhase = phases[data.phase];
            document.getElementById('scenario-title').textContent = currentPhase.title;
            document.getElementById('scenario-desc').textContent = "ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ"; 
            document.getElementById('scenario-icon').textContent = ["โก", "๐ก๏ธ", "๐ป", "๐"][data.phase];
            
            document.getElementById('math-problem').innerHTML = data.questionHTML;

            const optsDiv = document.getElementById('options-container');
            optsDiv.innerHTML = '';
            
            const shuffledOptions = shuffleArray([...data.options]);
            
            shuffledOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn text-white rounded-xl p-3 text-lg font-bold min-h-[70px] flex items-center justify-center math-display relative overflow-hidden";
                btn.innerHTML = `<span class="relative z-10">${opt.html}</span>`;
                btn.onclick = () => handleAnswer(opt.isCorrect, btn, data.explanation);
                optsDiv.appendChild(btn);
            });
            document.getElementById('feedback-overlay').classList.add('hidden');
            document.getElementById('phase-modal').classList.add('hidden');
            document.getElementById('explanation-modal').classList.add('hidden');
        }

        function handleAnswer(isCorrect, btn, exp) {
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            const overlay = document.getElementById('feedback-overlay');
            currentExplanationHTML = exp; 

            if (isCorrect) {
                btn.classList.add('correct-anim');
                gameScore += 10;
                document.getElementById('score-display').textContent = toAr(gameScore);
                document.getElementById('feedback-icon').textContent = "โ";
                document.getElementById('feedback-msg').textContent = "ุฃุญุณูุช ูุง ุจุทู!";
                document.getElementById('feedback-msg').className = "text-xl font-bold text-green-400 mb-4";
            } else {
                btn.classList.add('wrong-anim');
                document.getElementById('feedback-icon').textContent = "โ๏ธ";
                document.getElementById('feedback-msg').textContent = "ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ";
                document.getElementById('feedback-msg').className = "text-xl font-bold text-red-400 mb-4";
            }
            
            setTimeout(() => { overlay.classList.remove('hidden'); }, 600);
        }

        window.showExplanation = () => {
            isPaused = true; 
            const expModal = document.getElementById('explanation-modal');
            const expContent = document.getElementById('explanation-content');
            expContent.innerHTML = currentExplanationHTML;
            document.getElementById('feedback-overlay').classList.add('hidden');
            expModal.classList.remove('hidden');
        };

        window.closeExplanation = () => {
            isPaused = false; 
            document.getElementById('explanation-modal').classList.add('hidden');
            document.getElementById('feedback-overlay').classList.remove('hidden');
        };

        window.closeExplanationAndNext = () => {
            isPaused = false; 
            document.getElementById('explanation-modal').classList.add('hidden');
            nextStep();
        };

        window.nextStep = () => {
            document.getElementById('feedback-overlay').classList.add('hidden');
            const nextIndex = currentLevelIndex + 1;
            
            if (nextIndex < sessionQuestions.length && nextIndex % 3 === 0) {
                const nextPhaseIdx = sessionQuestions[nextIndex].phase;
                showPhaseTransition(nextPhaseIdx);
            } else {
                nextLevel();
            }
        };

        function showPhaseTransition(nextPhaseIndex) {
            const modal = document.getElementById('phase-modal');
            const phaseData = phases[nextPhaseIndex];
            
            if (nextPhaseIndex === 0) {
                document.querySelector('#phase-modal h2').innerText = "ุงูุทูุงู ุงููููุฉ!";
                document.querySelector('#phase-modal p.text-blue-300').innerText = "ุงุณุชุนุฏ ููุฏุฎูู ูู ุงููุทุงุน ุงูุฃูู";
            } else {
                document.querySelector('#phase-modal h2').innerText = "ุงูุชูู ุงููุทุงุน!";
                document.querySelector('#phase-modal p.text-blue-300').innerText = "ุฃุฏุงุก ุฑุงุฆุน ูู ุงููุณู ุงูุณุงุจู";
            }

            document.getElementById('next-phase-title').textContent = phaseData.title;
            document.getElementById('next-phase-rule').textContent = phaseData.rule;
            modal.classList.remove('hidden');
        }

        window.startNextPhase = () => {
            document.getElementById('phase-modal').classList.add('hidden');
            
            if (isFirstLevelLoad) {
                isFirstLevelLoad = false;
                startTimer();
                loadLevel(0);
            } else {
                nextLevel();
            }
        };

        function nextLevel() {
            currentLevelIndex++;
            if (currentLevelIndex < sessionQuestions.length) {
                loadLevel(currentLevelIndex);
            } else {
                endGame();
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('input-achieved').value = gameScore;
            document.getElementById('input-max').value = TOTAL_GAME_POINTS;
            document.getElementById('input-metric-value').value = elapsedSeconds;
            processResults();
        }

        async function fetchInitialCloudData() {
            try {
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) { studentName = res.data.name; document.getElementById('top-student-name').textContent = studentName; }
                    if (res.data.games && res.data.games[GAME_ID]) { document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / ูฅ"; }
                } else if (!urlParams.get('name')) {
                    studentName = "ุจุทู ุฒุงุฆุฑ"; document.getElementById('top-student-name').textContent = studentName;
                }
            } catch (e) { console.log("Cloud Connect Failed"); } finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        window.setMetricType = (type) => { currentMetricType = type; };
        window.processResults = () => {
            const ach = parseFloat(document.getElementById('input-achieved').value);
            const max = parseFloat(document.getElementById('input-max').value);
            const met = parseFloat(document.getElementById('input-metric-value').value) || 0;
            if (isNaN(ach) || isNaN(max) || max <= 0) return;
            const grade = ((ach / max) * 5).toFixed(1);
            showResult(ach, max, grade, met);
            if (studentId && classId) { saveScore(grade, met); } else { localVisitorResult = { name: studentName, grade: grade, metric: met, isLocal: true }; document.getElementById('save-msg').textContent = "ุชู ุชุฌููุฒ ูุชูุฌุชู ููุนุฑุถ!"; fetchAndShowLeaderboard(false); }
        };

        function showResult(a, m, g, met) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 text-center"><p class="text-[9px] font-bold text-blue-400">ุงูุฏุฑุฌุฉ</p><p class="text-lg font-black text-blue-900">${toAr(g)}</p></div>
                <div class="bg-purple-50 p-2 rounded-xl border border-purple-100 text-center"><p class="text-[9px] font-bold text-purple-400">${currentMetricType === 'time' ? 'ุงูููุช (ุซ)' : 'ุงูุฃุฎุทุงุก'}</p><p class="text-lg font-black text-purple-900">${toAr(met)}</p></div>
            `;
        }

        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            fetch(url).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (localVisitorResult && (currentLeaderboardMode === 'global' || !classId)) {
                    if (!data.find(p => p.name === localVisitorResult.name)) data.push(localVisitorResult);
                    data.sort((a, b) => parseFloat(b.grade) - parseFloat(a.grade) || parseFloat(a.metric) - parseFloat(b.metric));
                }
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="text-slate-400 border-b border-slate-100 bg-slate-50/50"><tr><th class="p-2 text-center">#</th><th class="p-2 text-right">ุงูุจุทู</th><th class="p-2 text-center text-emerald-600">ุงูุฏุฑุฌุฉ</th></tr></thead><tbody class="divide-y divide-slate-50">`;
                    data.forEach((p, i) => {
                        const isMe = (p.isLocal || (studentId && String(p.name).trim() === String(studentName).trim()));
                        h += `<tr class="${isMe ? 'rank-row-me' : 'hover:bg-slate-50/50'} transition-colors">
                            <td class="p-2 leaderboard-rank text-center ${i<3 ? 'text-yellow-500 text-sm' : 'text-slate-400'}">${i < 3 ? ['๐ฅ','๐ฅ','๐ฅ'][i] : toAr(i+1)}</td>
                            <td class="p-2 leaderboard-name ${isMe ? 'text-blue-700 font-extrabold' : 'text-slate-700'}">${p.name} ${isMe ? '<span class="bg-blue-600 text-white text-[7px] px-1 rounded-full mx-1">ุฃูุช</span>' : ''}</td>
                            <td class="p-2 text-center"><span class="text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</span> <span class="text-[8px] text-slate-400 block font-bold">(${toAr(p.metric || p.metricValue || 0)})</span></td></tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="py-10 text-center text-slate-400 text-xs italic font-bold">ุจุงูุชุธุงุฑ ุชุณุฌูู ุงูุฃุจุทุงู..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (mode) => {
            currentLeaderboardMode = mode;
            document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            fetchAndShowLeaderboard(false);
        };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

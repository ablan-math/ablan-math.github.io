<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- SYSTEM COMPLIANCE LOG: Quiz_Answers_Distributed=YES | GameModal_LeftHeader_Fixed=YES | Math_Arabic_Pro_V12=YES | Root_Perfect_Alignment_V4=YES | Vertical_Fractions_Quiz=YES | Attempts_Logic_Golden=YES | Decorative_Header_Golden=YES | Zero_Second_Name_Fetch_V3=YES | Best_Score_Sync_V3=YES | Double_Timer_Fix=YES | Games_Status_Colors=YES -->
    <title>٦-٣ كثيرات الحدود</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // نظام جلب الاسم الفوري (طريقة الصفر ثانية)
        (function(){
            const params = new URLSearchParams(window.location.search);
            const rawName = params.get('name') || params.get('studentName') || params.get('studentId') || "مرحبا بك";
            window._initialName = decodeURIComponent(rawName).trim();
        })();

        const themeColor = {
            gradient: 'from-blue-600 to-blue-800', 
            icon: 'fa-graduation-cap', 
            text: 'text-blue-600',
            bg: 'bg-blue-50',
            hex: '#2563eb',
            chapterNum: '٦' 
        };
        
        // متغير عالمي لتخزين بيانات الطالب وجلبها للألعاب
        window.currentStudentData = null;
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 140px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Math Styling - Arabic Ultimate V12 */
        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #1e40af; background-color: #f1f5f9; border: 1px solid #cbd5e1; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        
        .num-zero { font-size: 1.7em; font-weight: 900; color: #1e40af; display: inline-block; line-height: 1; vertical-align: middle; padding: 0 1px; }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .op-purple { color: #9333ea; font-weight: 800; }
        
        .tiny-sup { font-size: 0.75em; vertical-align: baseline; position: relative; top: -0.75em; margin-right: 1px; line-height: 0; font-weight: 900; display: inline-block; }
        
        /* Root Design V4 - الضبط الميليمترى المعتمد (٥ يمين، ٣ أسفل) */
        .root-container { position: relative; display: inline-flex; align-items: center; padding-right: 18px; padding-left: 6px; margin-top: 0; vertical-align: middle; }
        .root-symbol-svg { position: absolute; right: 0; top: -2px; width: 100%; height: calc(100% + 4px); pointer-events: none; overflow: visible; }
        .root-line { position: relative; z-index: 2; padding-top: 0; margin-right: 5px; line-height: 1; display: inline-block; font-weight: 800; color: #1e40af; transform: translateY(2px); }

        .fraction { display: inline-flex; flex-direction: column; vertical-align: middle; text-align: center; margin: 0 4px; font-size: 0.9em; font-weight: bold; }
        .fraction > span { padding: 0 2px; display: block; line-height: 1.1; }
        .fraction > .bar { border-top: 2px solid currentColor; height: 0; width: 100%; margin: 2px 0; }
        
        /* Step-by-Step Interactive */
        .step-interactive { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .step-interactive.active { display: block; opacity: 1; transform: translateY(0); }

        /* UI Navigation Restoration */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 12px 0; display: flex; justify-content: space-around; z-index: 2000; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.75rem; width: 25%; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: #2563eb; font-weight: 800; transform: translateY(-3px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -8px; width: 20px; height: 3px; background: #2563eb; border-radius: 4px; }
        
        .lesson-footer { text-align: center; margin-top: 40px; padding: 20px 10px 60px 10px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.85rem; }
        .step-box { border-right: 4px solid #2563eb; background: #f9fafb; padding: 12px; margin-bottom: 8px; border-radius: 8px; }

        /* Quiz Layout 2x2 */
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 14px 10px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white; text-align: center; font-weight: bold; color: #4b5563; min-height: 75px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #eff6ff; color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1); }
        
        .question-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .term-analysis { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 10px; background: white; border: 2px dashed #cbd5e1; border-radius: 12px; min-width: 80px; }
        .term-arrow { color: #2563eb; font-size: 1.3rem; animation: bounceDown 1s infinite; }
        @keyframes bounceDown { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(4px); } }

        .strip-container { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .strip-item { font-size: 1.1rem; font-weight: bold; color: #4b5563; opacity: 0.3; transform: scale(0.9); transition: 0.3s; cursor: pointer; padding: 8px 12px; border-radius: 8px; white-space: nowrap; }
        .strip-item.active { opacity: 1; transform: scale(1.15); color: #2563eb; background-color: white; border: 1px solid #e5e7eb; }
        
        .quiz-question-text { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-weight: 800; color: #1f2937; margin-bottom: 24px; line-height: 1.8; }
        .highlight-box { border: 2px solid #2563eb; background: #eff6ff; color: #1e40af; padding: 12px; border-radius: 12px; font-weight: 800; margin-top: 15px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Golden Decorative Header -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 overflow-hidden relative bg-gradient-to-r from-blue-600 to-blue-800">
        <div class="absolute inset-0 pointer-events-none overflow-hidden select-none">
            <span class="absolute top-[-10px] right-10 text-[180px] font-black text-white opacity-5 font-sans leading-none pointer-events-none">6</span>
            <i class="fas fa-graduation-cap absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <i class="fas fa-plus absolute top-4 left-1/4 text-xl text-white opacity-10"></i>
            <i class="fas fa-minus absolute bottom-8 left-1/3 text-2xl text-white opacity-10"></i>
            <i class="fas fa-times absolute top-1/3 right-1/4 text-xl text-white opacity-10"></i>
        </div>
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20">
                    <i class="fas fa-graduation-cap text-lg md:text-2xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80 uppercase tracking-wider">منصة الرياضيات التفاعلية</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">٦-٣</span>
                        <span>كثيرات الحدود</span>
                        <!-- شارة الدرجة الأفضل - ستظهر فور جلب البيانات -->
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/30 text-yellow-100 px-3 py-1 rounded-full text-xs font-black border border-yellow-400/40">
                            <i class="fas fa-star text-yellow-300"></i> 
                            <span id="student-score">٠</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> 
                    <span id="student-name">...</span>
                </div>
                <script>document.getElementById('student-name').textContent = window._initialName;</script>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 no-underline">
                    <i class="fas fa-arrow-right"></i> <span>رجوع</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8">
        
        <!-- Tab 1: التعريف والتصنيف -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-blue-100 text-blue-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg border border-blue-200 shadow-sm">١</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">تعريف وتصنيف كثيرات الحدود</h2>
            </div>
            <div id="gallery-container-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-green-50 mb-6">
                <div class="flex items-center justify-between mb-4 pb-2 border-b border-green-100">
                    <h3 class="font-bold text-green-800 text-sm md:text-lg flex items-center gap-2"><i class="fas fa-layer-group"></i> تصنيف كثيرات الحدود</h3>
                    <div class="flex gap-2 items-center">
                        <button class="gallery-nav-btn prev-btn" disabled><i class="fas fa-chevron-right"></i></button>
                        <span class="text-xs font-bold text-gray-400 counter">١ / ٤</span>
                        <button class="gallery-nav-btn next-btn"><i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>
                <div class="strip-container">
                    <div class="strip-item active" data-index="٠">وحيدة حد</div>
                    <div class="strip-item" data-index="١">ثنائية حد</div>
                    <div class="strip-item" data-index="٢">ثلاثية حدود</div>
                    <div class="strip-item" data-index="٣">متعددة الحدود</div>
                </div>
                <div class="explanation-area min-h-[140px]"></div>
            </div>
            <div id="gallery-container-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-red-50 mb-6">
                <div class="flex items-center justify-between mb-4 pb-2 border-b border-red-100">
                    <h3 class="font-bold text-red-800 text-sm md:text-lg flex items-center gap-2"><i class="fas fa-times-circle"></i> متى لا تكون كثيرة حدود؟</h3>
                    <div class="flex gap-2 items-center">
                        <button class="gallery-nav-btn prev-btn" disabled><i class="fas fa-chevron-right"></i></button>
                        <span class="text-xs font-bold text-gray-400 counter">١ / ٣</span>
                        <button class="gallery-nav-btn next-btn"><i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>
                <div class="strip-container">
                    <div class="strip-item active" data-index="٠">متغير في المقام</div>
                    <div class="strip-item" data-index="١">أسس سالبة</div>
                    <div class="strip-item" data-index="٢">متغير تحت الجذر</div>
                </div>
                <div class="explanation-area min-h-[140px]"></div>
            </div>
            <button onclick="switchTab('learn2')" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>التالي: الصورة القياسية</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Tab 2: الصورة القياسية (بدون اختصار) -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-purple-100 text-purple-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg border border-purple-200">٢</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">الصورة القياسية والدرجة</h2>
            </div>
            <div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200 shadow-sm mb-8 relative overflow-hidden">
                <h3 class="font-bold text-blue-800 text-lg mb-2 flex items-center gap-2"><i class="fas fa-info-circle"></i> التعريف والمفهوم:</h3>
                <p class="text-gray-700 leading-relaxed text-sm md:text-base font-bold">
                    **الصورة القياسية**: هي كتابة كثيرة الحدود التي تحتوي على <span class="text-red-600 text-xl border-b-2 border-red-200 px-1 font-black">متغير واحد فقط</span> بترتيب حدودها **تنازلياً** من أكبر درجة إلى أصغر درجة. 
                </p>
            </div>

            <div id="interactive-container-sf1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-8 text-center">
                <h3 class="font-bold text-blue-800 mb-4 underline">مثال ١: ثلاثية حدود</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-4 font-bold border">رتب العبارة: <span class="math-eq">٤س + ٢س<sup class="tiny-sup">٢</sup> - ٥</span></div>
                <div class="min-h-[260px] mb-4 flex flex-col items-center justify-center">
                    <div class="interactive-placeholder py-6 font-bold text-blue-600">انقر لمشاهدة التحليل التدريجي..</div>
                    <div class="flex justify-center gap-2 md:gap-4 mb-4">
                        <div class="step-interactive"><div class="term-analysis" style="border-color:#dc2626;"><span class="math-eq term-red">٤س</span><i class="fas fa-arrow-down term-arrow"></i><span class="text-xs font-bold term-red">درجة ١</span></div></div>
                        <div class="step-interactive"><div class="term-analysis" style="border-color:#059669;"><span class="math-eq term-green">٢س<sup class="tiny-sup">٢</sup></span><i class="fas fa-arrow-down term-arrow"></i><span class="text-xs font-bold term-green">درجة ٢</span></div></div>
                        <div class="step-interactive"><div class="term-analysis" style="border-color:#2563eb;"><span class="math-eq term-blue">-٥</span><i class="fas fa-arrow-down term-arrow"></i><span class="text-xs font-bold term-blue">درجة ٠</span></div></div>
                    </div>
                    <div class="step-interactive text-blue-700 font-bold my-2 animate-bounce text-sm">نرتب الآن الحدود من الأكبر إلى الأصغر:</div>
                    <div class="step-interactive w-full text-center border-t pt-4">
                        <div class="math-eq text-lg px-6 py-2 border-2 border-purple-300 shadow-md"><span class="num-red underline decoration-4">٢</span>س<sup class="tiny-sup">٢</sup> + ٤س - ٥</div>
                        <div class="highlight-box">المعامل الرئيس هو ٢ | درجة كثيرة الحدود هي ٢</div>
                    </div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <button class="prev-btn px-6 py-1.5 bg-gray-200 rounded-lg font-bold">السابق</button>
                    <button class="next-btn flex-1 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md mx-2">التالي</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- مثال ٢: خماسية حدود (مستعاد بالكامل) -->
            <div id="interactive-container-sf2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6 text-center">
                <h3 class="font-bold text-blue-800 mb-4 underline">مثال ٢: خماسية حدود</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-4 font-bold border">رتب العبارة: <span class="math-eq">٧ - س<sup class="tiny-sup">٣</sup> + ٥س<sup class="tiny-sup">٤</sup> + س<sup class="tiny-sup">٢</sup> + ٢س</span></div>
                <div class="min-h-[220px] mb-4 flex flex-col items-center justify-center">
                    <div class="interactive-placeholder py-4 font-bold text-gray-400">تحليل الحدود المتعددة..</div>
                    <div class="flex justify-center gap-1 md:gap-2 mb-4 overflow-x-auto w-full">
                        <div class="step-interactive scale-90"><div class="term-analysis"><span class="math-eq">٧</span><i class="fas fa-arrow-down term-arrow"></i><span class="text-[10px] font-bold">درجة ٠</span></div></div>
                        <div class="step-interactive scale-90"><div class="term-analysis"><span class="math-eq">-س<sup class="tiny-sup">٣</sup></span><i class="fas fa-arrow-down term-arrow"></i><span class="text-[10px] font-bold">درجة ٣</span></div></div>
                        <div class="step-interactive scale-90"><div class="term-analysis"><span class="math-eq">٥س<sup class="tiny-sup">٤</sup></span><i class="fas fa-arrow-down term-arrow"></i><span class="text-[10px] font-bold">درجة ٤</span></div></div>
                        <div class="step-interactive scale-90"><div class="term-analysis"><span class="math-eq">س<sup class="tiny-sup">٢</sup></span><i class="fas fa-arrow-down term-arrow"></i><span class="text-[10px] font-bold">درجة ٢</span></div></div>
                        <div class="step-interactive scale-90"><div class="term-analysis"><span class="math-eq">٢س</span><i class="fas fa-arrow-down term-arrow"></i><span class="text-[10px] font-bold">درجة ١</span></div></div>
                    </div>
                    <div class="step-interactive text-blue-700 font-bold my-1 text-sm animate-bounce">نرتب الآن الحدود من الأكبر إلى الأصغر:</div>
                    <div class="step-interactive w-full text-center border-t pt-2">
                        <div class="math-eq text-md px-4 py-2 border-purple-300 shadow-sm"><span class="num-red underline decoration-4">٥</span>س<sup class="tiny-sup">٤</sup> - س<sup class="tiny-sup">٣</sup> + س<sup class="tiny-sup">٢</sup> + ٢س + ٧</div>
                        <div class="highlight-box mt-2">المعامل الرئيس هو ٥ | درجة كثيرة الحدود هي ٤</div>
                    </div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <button class="prev-btn px-6 py-1.5 bg-gray-200 rounded-lg font-bold">السابق</button>
                    <button class="next-btn flex-1 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md mx-2">التالي</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">إعادة</button>
                </div>
            </div>

            <button onclick="switchTab('learn4')" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>التالي: الاستعمالات</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Tab 4: الاستعمالات (بدون اختصار) -->
        <div id="tab-learn4" class="tab-content">
             <div class="flex items-center gap-2 mb-4">
                <span class="bg-emerald-100 text-emerald-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg border border-emerald-200">٣</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">استعمالات كثيرات الحدود</h2>
            </div>
            
            <!-- مثال ١: الفيزياء -->
            <div id="interactive-container-physics" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6 text-center">
                <div class="flex items-center gap-2 mb-4"><div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center"><i class="fas fa-rocket"></i></div><h3 class="font-bold text-blue-800 text-sm md:text-base">١. الفيزياء (المقذوفات)</h3></div>
                <p class="text-sm text-gray-600 mb-4 font-bold">أوجد ارتفاع مقذوف تمثله العبارة <span class="math-eq">-٥ن<sup class="tiny-sup">٢</sup> + ٢٠ن + ٢</span> عند ن=١ ثانية.</p>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-4 flex flex-col items-center justify-center">
                    <div class="interactive-placeholder py-6 font-bold text-gray-400">انقر لمتابعة الحل الخطوي..</div>
                    <div class="step-interactive text-sm font-bold text-blue-700 mb-2">الخطوة ١ (التعويض): -٥(١)<sup class="tiny-sup">٢</sup> + ٢٠(١) + ٢</div>
                    <div class="step-interactive mt-2"><span class="math-eq text-lg bg-green-50">الارتفاع النهائي = ١٧ متراً</span></div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <button class="prev-btn px-6 py-1.5 bg-gray-200 rounded-lg font-bold">السابق</button>
                    <button class="next-btn px-10 py-1.5 bg-blue-600 text-white rounded-lg font-bold">التالي</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 rounded-lg font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- مثال ٢: الاقتصاد الهجري المفصل بـ ٦ خطوات -->
            <div id="interactive-container-hijri" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6 text-center">
                <div class="flex items-center gap-2 mb-4"><div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center"><i class="fas fa-calendar-alt"></i></div><h3 class="font-bold text-purple-800 text-sm md:text-base">٢. الاقتصاد (أرباح عامين هجريين)</h3></div>
                <p class="text-sm text-gray-600 mb-4 font-bold">أرباح شركة تمثلها العبارة <span class="math-eq">ن<sup class="tiny-sup">٢</sup> + ٣ن + ٥٠</span>. قارن الأرباح بين عامي ١٤٤٥هـ و ١٤٤٦هـ.</p>
                <div class="min-h-[360px] mb-4 bg-gray-50 rounded-lg p-4 flex flex-col items-center justify-center">
                    <div class="interactive-placeholder py-8 font-bold text-gray-400">انقر لمعالجة البيانات خطوة بخطوة..</div>
                    <div class="step-interactive bg-blue-50 p-2 rounded-lg mb-2 w-full"><p class="text-[10px] font-bold text-blue-800 underline text-right">الخطوة ١: تحديد قيمة ن</p><p class="text-xs text-right">باعتبار عام ١٤٤٠هـ هو ن=٠: ١٤٤٥هـ تعني <span class="text-red-600 font-black">ن = ٥</span> | ١٤٤٦هـ تعني <span class="text-red-600 font-black">ن = ٦</span></p></div>
                    <div class="step-interactive w-full mb-1 text-xs font-bold text-right">الخطوة ٢: معادلة أرباح ١٤٤٥هـ <br> <span class="math-eq scale-75">(٥)<sup class="tiny-sup">٢</sup> + ٣(٥) + ٥٠</span></div>
                    <div class="step-interactive w-full mb-2"><span class="math-eq scale-75 text-green-700 bg-white">النتيجة: ٩٠ مليون ريال</span></div>
                    <div class="step-interactive w-full mb-1 text-xs font-bold text-right">الخطوة ٣: معادلة أرباح ١٤٤٦هـ <br> <span class="math-eq scale-75">(٦)<sup class="tiny-sup">٢</sup> + ٣(٦) + ٥٠</span></div>
                    <div class="step-interactive w-full mb-2"><span class="math-eq scale-75 text-green-700 bg-white">النتيجة: ١٠٤ مليون ريال</span></div>
                    <div class="step-interactive p-2 bg-amber-100 text-amber-900 rounded-lg text-xs font-bold border border-amber-200">النتيجة النهائية: زادت الأرباح في عام ١٤٤٦هـ بمقدار ١٤ مليون ريال.</div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <button class="prev-btn px-6 py-1.5 bg-gray-200 rounded-lg font-bold">السابق</button>
                    <button class="next-btn px-10 py-1.5 bg-blue-600 text-white rounded-lg font-bold mx-2">التالي</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 rounded-lg font-bold hidden">إعادة</button>
                </div>
            </div>

            <!-- مثال ٣: الهندسة ومقارنة سعة الخزانات -->
            <div id="interactive-container-geo" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-amber-50 mb-6 text-center">
                <div class="flex items-center gap-2 mb-4"><div class="w-10 h-10 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center"><i class="fas fa-shapes"></i></div><h3 class="font-bold text-amber-800 text-sm md:text-base">٣. الهندسة (مقارنة سعة خزانين)</h3></div>
                <p class="text-sm text-gray-600 mb-4 font-bold">خزان (أ) سعته <span class="math-eq">س<sup class="tiny-sup">٢</sup> + ١٠</span> وخزان (ب) سعته <span class="math-eq">٣س + ٤</span>. أيهما أكبر سعة عندما س = ٥؟</p>
                <div class="min-h-[180px] mb-4 bg-gray-50 rounded-lg p-4 flex flex-col items-center justify-center">
                    <div class="interactive-placeholder py-8 font-bold text-gray-400">لنقارن بين الخزانين..</div>
                    <div class="step-interactive text-xs font-bold text-gray-500 mb-2">سعة الخزان (أ): <span class="math-eq">(٥)<sup class="tiny-sup">٢</sup> + ١٠ = ٣٥</span> وحدة</div>
                    <div class="step-interactive text-xs font-bold text-gray-500 mb-2">سعة الخزان (ب): <span class="math-eq">٣(٥) + ٤ = ١٩</span> وحدة</div>
                    <div class="step-interactive p-2 bg-blue-100 text-blue-800 rounded-lg text-xs font-bold">الخزان (أ) أكبر سعة لأن ٣٥ > ١٩.</div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <button class="prev-btn px-6 py-1.5 bg-gray-200 rounded-lg font-bold">السابق</button>
                    <button class="next-btn px-10 py-1.5 bg-blue-600 text-white rounded-lg font-bold">التالي</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 rounded-lg font-bold hidden">إعادة</button>
                </div>
            </div>

            <button onclick="switchTab('quiz')" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 animate-bounce mt-4"><span>جاهز للاختبار؟</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Quiz Tab -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">اختبر فهمك</h2><p class="text-xs md:text-sm text-gray-500">٥ أسئلة عشوائية مختارة بدقة</p></div>
                    <div class="text-center">
                        <div id="attempts-display" class="flex flex-col items-center">
                            <span class="block text-xl md:text-2xl font-bold text-blue-600" id="attempts-count">٠</span>
                            <div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>محاولات</span></div>
                        </div>
                        <div id="timer-top-container" class="hidden mt-1 px-2 py-0.5 rounded bg-red-50 border border-red-100">
                            <span id="timer-display-top" class="block text-[10px] font-bold text-red-500 font-mono tracking-tighter">٠٠:٠٠:٠٠</span>
                        </div>
                    </div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-error-msg" class="hidden mt-4 p-4 rounded-xl bg-amber-50 text-amber-700 text-sm font-bold text-center border border-amber-200"></div>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl p-6 border-2 border-blue-200 border-dashed">
                    <div id="result-icon-area" class="mb-2 text-5xl"></div>
                    <p class="text-sm text-gray-600 font-bold mb-1">الدرجة النهائية</p>
                    <p id="quiz-score" class="text-5xl font-black my-2 text-blue-600">-</p>
                    <div id="timer-bottom-container" class="hidden mt-4 bg-red-50 border border-red-100 rounded-lg p-3 inline-block">
                        <span class="block text-xs font-bold text-red-400 mb-1">فتح المحاولات خلال:</span>
                        <span id="timer-display-bottom" class="block text-xl font-bold text-red-600 font-mono tracking-wider">٠٠:٠٠:٠٠</span>
                    </div>
                </div>
                <div id="games-wrapper" class="mt-12 pt-8 border-t-2 border-dashed border-gray-200">
                    <h2 class="text-center font-black text-gray-700 mb-6 flex justify-center gap-2 items-center"><i class="fas fa-gamepad text-yellow-500"></i> استمتع وتعلم</h2>
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>

    <!-- Game Modal -->
    <div id="game-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center backdrop-blur-sm p-4 z-[9999]">
        <div id="game-frame-container" class="bg-white shadow-2xl overflow-hidden flex flex-col relative modal-default-size border border-gray-600">
            <div class="text-white px-3 py-1 flex justify-between items-center h-8 shrink-0 bg-blue-700">
                <div class="flex items-center gap-2 h-full">
                    <button onclick="closeGameModal()" class="hover:bg-red-600 p-1 rounded transition w-6 h-6 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
                    <div class="h-4 w-px bg-white/20 mx-1"></div>
                    <span id="game-modal-title" class="font-bold text-[10px] md:text-xs truncate">اللعبة</span>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="toggleMinimize()" class="hover:bg-black/20 p-1 rounded w-6 h-6 flex items-center justify-center"><i class="fas fa-minus text-xs"></i></button>
                    <button onclick="toggleMaximize()" class="hover:bg-black/20 p-1 rounded w-6 h-6 flex items-center justify-center"><i id="max-icon" class="fas fa-expand text-xs"></i></button>
                </div>
            </div>
            <iframe id="game-iframe" src="" class="w-full h-full bg-gray-100 border-none"></iframe>
        </div>
    </div>

    <!-- Modal for Explanations -->
    <div id="modal" class="fixed inset-0 bg-black/50 z-[10000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="font-bold text-lg text-blue-700">توضيح</h3>
                <button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modal-content" class="text-sm leading-relaxed max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        const LESSON_KEY = 'c6_l3';
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let isQuizResultShown = false;
        let timerInterval;

        const tabs = [
            { id: 'learn1', icon: 'book-open', label: 'التصنيف' },
            { id: 'learn2', icon: 'trending-up', label: 'القياسية' },
            { id: 'learn4', icon: 'rocket', label: 'استعمالات' },
            { id: 'quiz', icon: 'clipboard-check', label: 'الاختبار' }
        ];

        const questionBank = [
            { id: 1, type: 'التصنيف', t: 'أي مما يلي يمثل ثلاثية حدود؟', o: [{t:'٢س+٥', v:'a'}, {t:'س٢+٣س-٤', v:'b'}, {t:'٥س٣', v:'c'}, {t:'س+ص+١+ع', v:'d'}], c:'b', e:'تتكون من ٣ حدود متميزة.' },
            { id: 2, type: 'التصنيف', t: 'درجة وحيدة الحد ٧س٢ص٣ هي:', o: [{t:'٢', v:'a'}, {t:'٣', v:'b'}, {t:'٥', v:'c'}, {t:'٧', v:'d'}], c:'c', e:'جمع الأسس ٢ + ٣ = ٥.' },
            { id: 3, type: 'القياسية', t: 'المعامل الرئيس لـ ٢س + ٥س٢ - ٧ هو:', o: [{t:'٢', v:'a'}, {t:'٥', v:'b'}, {t:'-٧', v:'c'}, {t:'٠', v:'d'}], c:'b', e:'بعد الترتيب (٥س٢ + ٢س - ٧)، المعامل الرئيس هو ٥.' },
            { id: 4, type: 'القياسية', t: 'درجة كثيرة الحدود ٥س٣ - ٢س٤ + س هي:', o: [{t:'٣', v:'a'}, {t:'٤', v:'b'}, {t:'١', v:'c'}, {t:'٥', v:'d'}], c:'b', e:'أعلى أس هو ٤.' },
            { id: 5, type: 'تحدي', t: 'الدرجة الكلية للعبارة س٣ص٢ + س٤ هي:', o: [{t:'٤', v:'a'}, {t:'٥', v:'b'}, {t:'٧', v:'c'}, {t:'٣', v:'d'}], c:'b', e:'الحد الأول درجته ٥ (٣+٢)، والثاني ٤. الأكبر هو ٥.' },
            { id: 6, type: 'تحدي', t: 'أي مما يلي ليس كثيرة حدود؟', o: [{t:'س٢ + √س', v:'a'}, {t:'س٢ + س', v:'b'}, {t:'١٠', v:'c'}, {t:'س + ص', v:'d'}], c:'a', e:'الجذر على المتغير مرفوض.' },
            { id: 7, type: 'القياسية', t: 'الصورة القياسية لـ ٤ + س٢ - ٣س هي:', o: [{t:'٤-٣س+س٢', v:'a'}, {t:'س٢-٣س+٤', v:'b'}, {t:'-٣س+س٢+٤', v:'c'}, {t:'س٢+٤-٣س', v:'d'}], c:'b', e:'الترتيب التنازلي للأسس.' },
            { id: 8, type: 'الاستعمالات', t: 'تستخدم كثيرات الحدود في الفيزياء لنمذجة:', o: [{t:'الوزن فقط', v:'a'}, {t:'مسار المقذوفات', v:'b'}, {t:'درجة الحرارة', v:'c'}, {t:'لون الضوء', v:'d'}], c:'b', e:'لحساب الارتفاع والزمن.' },
            { id: 9, type: 'التصنيف', t: 'درجة وحيدة الحد الثابتة (٥) هي:', o: [{t:'١', v:'a'}, {t:'٠', v:'b'}, {t:'٥', v:'c'}, {t:'غير معرفة', v:'d'}], c:'b', e:'درجة الثابت دائماً صفر.' },
            { id: 10, type: 'القياسية', t: 'المعامل الرئيس لـ -س٣ + ٤ هو:', o: [{t:'١', v:'a'}, {t:'-١', v:'b'}, {t:'٣', v:'c'}, {t:'٤', v:'d'}], c:'b', e:'معامل س٣ هو -١.' },
            { id: 11, type: 'الاستعمالات', t: 'في حجم المكعب ح(س) = س٣، إذا كان س=٢ فإن الحجم:', o: [{t:'٤', v:'a'}, {t:'٨', v:'b'}, {t:'٦', v:'c'}, {t:'١٢', d:'d'}], c:'b', e:'٢ أس ٣ تساوي ٨.' },
            { id: 12, type: 'تحدي', t: 'أي مما يلي كثيرة حدود في أبسط صورة؟', o: [{t:'س٢ + √س', v:'a'}, {t:'س٢ + س', v:'b'}, {t:'١٠/س', v:'c'}, {t:'س + ص-١', v:'d'}], c:'b', e:'الأسس موجبة وصحيحة.' },
            { id: 13, type: 'التصنيف', t: 'العبارة س٢-٥س+٦ تسمى:', o: [{t:'وحيدة حد', v:'a'}, {t:'ثنائية حد', v:'b'}, {t:'ثلاثية حدود', v:'c'}, {t:'متعددة حدود', v:'d'}], c:'c', e:'تتكون من ٣ حدود.' },
            { id: 14, type: 'تحدي', t: 'العبارة (٣/س + ٥) هي:', o: [{t:'ثنائية حد', v:'a'}, {t:'ليست كثيرة حدود', v:'b'}, {t:'وحيدة حد', v:'c'}, {t:'ثلاثية حدود', v:'d'}], c:'b', e:'المتغير في المقام ممنوع.' },
            { id: 15, type: 'تحدي', t: 'العبارة √٢ س٢ هي:', o: [{t:'كثيرة حدود', v:'a'}, {t:'ليست كثيرة حدود', v:'b'}, {t:'وحيدة حد فقط', v:'c'}, {t:'ثنائية حد', v:'d'}], c:'a', e:'الجذر على الرقم مسموح.' }
        ];

        window.convertToArabic = function(n) { 
            if(n === 0 || n === "٠" || n === "0") return '٠';
            return n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]); 
        };

        function renderRootHTML(inner) {
            return `<div class="root-container">
                <svg class="root-symbol-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <path d="M 100 6 L 12 6 L 10 94 L 2 70" stroke="currentColor" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="root-line">${inner}</div>
            </div>`;
        }

        function formatQuizMath(str) {
            let out = str;
            out = out.replace(/([أ-ي])([\d\٠-\٩]+)/g, (m, c, d) => `${c}<sup class="tiny-sup">${d}</sup>`);
            out = out.replace(/([\d\٠-\٩]+)\/([أ-ي\d\٠-\٩]+)/g, (m, n, d) => `<span class="fraction"><span>${n}</span><span class="bar"></span><span>${d}</span></span>`);
            out = out.replace(/√([أ-ي\d\٠-\٩]+)/g, (m, v) => renderRootHTML(v)); 
            return out;
        }

        window.startTimer = function(targetTime) {
            if (timerInterval) clearInterval(timerInterval);
            const tick = () => {
                const now = Date.now();
                const diff = targetTime - now;
                if (diff <= 0) {
                    clearInterval(timerInterval);
                    attemptsLeft = 1; updateAttemptsUI();
                    document.getElementById('timer-top-container')?.classList.add('hidden');
                    document.getElementById('timer-bottom-container')?.classList.add('hidden');
                    return;
                }
                const h = Math.floor(diff/3600000);
                const m = Math.floor((diff%3600000)/60000);
                const s = Math.floor((diff%60000)/1000);
                const timeAr = `${convertToArabic(h)}:${convertToArabic(m)}:${convertToArabic(s)}`;
                const topD = document.getElementById('timer-display-top');
                const botD = document.getElementById('timer-display-bottom');
                if(topD) topD.innerHTML = timeAr;
                if(botD) botD.innerHTML = timeAr;
                document.getElementById('timer-top-container')?.classList.remove('hidden');
                document.getElementById('timer-bottom-container')?.classList.remove('hidden');
            };
            timerInterval = setInterval(tick, 1000); tick();
        }

        window.renderDynamicGames = function() {
            const container = document.getElementById('dynamic-games-container');
            if(!container) return; container.innerHTML = '';
            const sId = urlParams.get('studentId') || 'visitor';
            const cId = urlParams.get('classId') || 'default';
            const games = [{ id: 'g6_3_1', title: 'تحدي التصنيف' }, { id: 'g6_3_2', title: 'حرب كثيرات الحدود' }];
            
            games.forEach(g => {
                const url = `https://ablan-math.github.io/games/${g.id}.html?studentId=${sId}&classId=${cId}`;
                let scoreColor = "bg-blue-100 text-blue-600";
                
                // تفعيل منطق الألوان بناء على الدرجة المسجلة في السجل السحابي
                if(window.currentStudentData && window.currentStudentData.lessons && window.currentStudentData.lessons[g.id]) {
                    const gScore = window.currentStudentData.lessons[g.id].score;
                    if(gScore >= 9) scoreColor = "bg-green-100 text-green-700";
                    else if(gScore >= 5) scoreColor = "bg-yellow-100 text-yellow-700";
                    else if(gScore > 0) scoreColor = "bg-red-100 text-red-700";
                }

                container.insertAdjacentHTML('beforeend', `
                    <div onclick="openGameModal('${url}', '${g.title}')" class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition cursor-pointer flex items-center gap-4">
                        <div class="w-12 h-12 ${scoreColor} rounded-full flex items-center justify-center shadow-inner">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm">${g.title}</h4>
                            <p class="text-xs text-gray-400">اضغط للبدء</p>
                        </div>
                    </div>
                `);
            });
        }

        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.innerHTML = convertToArabic(attemptsLeft);
            const submitBtn = document.getElementById('quiz-action-btn');
            if (!submitBtn) return;
            if (isQuizResultShown) {
                 if (attemptsLeft > 0) {
                    submitBtn.textContent = "إعادة الاختبار"; submitBtn.disabled = false;
                    submitBtn.onclick = () => { isQuizResultShown = false; document.getElementById('quiz-results').classList.add('hidden'); generateQuiz(); };
                } else {
                    submitBtn.textContent = "انتهت المحاولات"; submitBtn.disabled = true;
                }
                return;
            }
            submitBtn.disabled = attemptsLeft <= 0;
            submitBtn.textContent = attemptsLeft > 0 ? "تحقق من الإجابات" : "انتهت المحاولات";
        }

        function generateQuiz() {
            const cat1 = questionBank.filter(q => q.type === 'التصنيف').sort(() => 0.5 - Math.random());
            const cat2 = questionBank.filter(q => q.type === 'القياسية').sort(() => 0.5 - Math.random());
            const cat3 = questionBank.filter(q => q.type === 'الاستعمالات').sort(() => 0.5 - Math.random());
            const catChallenge = questionBank.filter(q => q.type === 'تحدي').sort(() => 0.5 - Math.random());
            currentQuestions = [cat1[0], cat2[0], cat3[0], catChallenge[0], catChallenge[1]].filter(q => q !== undefined);
            const form = document.getElementById('quizForm');
            let html = '';
            const badgeColors = { 'التصنيف': 'bg-blue-100 text-blue-600', 'القياسية': 'bg-purple-100 text-purple-600', 'الاستعمالات': 'bg-emerald-100 text-emerald-600', 'تحدي': 'bg-red-100 text-red-600' };
            currentQuestions.forEach((q, i) => {
                const opts = [...q.o].sort(() => 0.5 - Math.random());
                html += `<div class="question-card"><div class="flex justify-between items-center mb-4"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold border">سؤال ${convertToArabic(i+1)}</span><span class="${badgeColors[q.type]} px-3 py-1 rounded-full text-[10px] font-bold shadow-sm">${q.type}</span></div><div class="quiz-question-text">${formatQuizMath(q.t)}</div><div class="options-grid">${opts.map((opt, oi) => `<div class="relative"><input type="radio" name="q${i}" id="q${i}o${oi}" value="${opt.v}" class="absolute opacity-0 w-full h-full cursor-pointer z-10"><label for="q${i}o${oi}" class="option-label">${formatQuizMath(opt.t)}</label></div>`).join('')}</div><div id="feedback-${i}" class="hidden p-4 rounded-xl mt-4 text-sm font-bold"></div><div id="actions-${i}" class="hidden flex gap-2 mt-3"><button type="button" onclick="showExplain(${i})" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg flex items-center gap-1">لماذا؟</button><button type="button" onclick="showSmart(${i})" class="text-xs bg-purple-50 text-purple-600 px-3 py-2 rounded-lg flex items-center gap-1">الحل الذكي</button><button type="button" onclick="switchTab('${q.type === 'التصنيف' ? 'learn1' : (q.type === 'القياسية' ? 'learn2' : 'learn4')}')" class="text-xs border border-gray-200 text-gray-500 px-3 py-2 rounded-lg mr-auto">مراجعة الدرس</button></div></div>`;
            });
            html += `<button type="submit" id="quiz-action-btn" class="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl transform active:scale-95 transition">تحقق من الإجابات</button>`;
            form.innerHTML = html;
            form.onsubmit = handleQuizSubmit;
            updateAttemptsUI();
        }

        async function handleQuizSubmit(e) {
            e.preventDefault(); if (isQuizResultShown) return;
            let answeredCount = 0; for(let i=0; i<currentQuestions.length; i++){ if(document.querySelector(`input[name="q${i}"]:checked`)) answeredCount++; }
            if(answeredCount < currentQuestions.length) { document.getElementById('quiz-error-msg').textContent = "يرجى الإجابة على جميع الأسئلة."; document.getElementById('quiz-error-msg').classList.remove('hidden'); setTimeout(() => document.getElementById('quiz-error-msg').classList.add('hidden'), 3000); return; }
            attemptsLeft--; const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') { localStorage.setItem(`${ATTEMPTS_KEY}_visitor`, attemptsLeft); if (attemptsLeft === 0) { startTimer(Date.now() + COOLDOWN_MS); } }
            let correctCount = 0;
            currentQuestions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`); const fb = document.getElementById(`feedback-${i}`); document.getElementById(`actions-${i}`).classList.remove('hidden');
                if (sel && sel.value === q.c) { correctCount++; fb.innerHTML = "إجابة صحيحة بطل!"; fb.className = "p-4 rounded-xl mt-4 text-sm font-bold bg-green-50 text-green-700 block border border-green-200"; }
                else { fb.innerHTML = "إجابة خاطئة، حاول مجدداً."; fb.className = "p-4 rounded-xl mt-4 text-sm font-bold bg-red-50 text-red-700 block border border-red-200"; }
            });
            const finalScore = correctCount * 2; isQuizResultShown = true;
            
            // تحديث أفضل درجة في الهيدر فورياً
            const currentBestText = document.getElementById('student-score').innerText;
            const currentBest = parseInt(currentBestText.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)])) || 0;
            if(finalScore > currentBest) {
                document.getElementById('student-score').innerHTML = convertToArabic(finalScore);
                document.getElementById('header-score-badge').classList.remove('hidden');
            }

            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('result-icon-area').innerHTML = finalScore >= 8 ? '🏆' : (finalScore >= 5 ? '⭐' : '🔄');
            document.getElementById('quiz-score').innerHTML = `${convertToArabic(finalScore)} / ١٠`;
            
            updateAttemptsUI(); window.scrollTo({ top: document.getElementById('quiz-results').offsetTop - 100, behavior: 'smooth' });
            
            if(sId !== 'visitor') {
                try {
                    await fetch(`${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${urlParams.get('classId')}&itemId=${LESSON_KEY}&score=${finalScore}&t=${Date.now()}`);
                } catch(e) { console.error("Score submission error", e); }
            }
        }

        async function fetchStudentData() {
            const sId = urlParams.get('studentId');
            if (!sId || sId === 'visitor') { 
                let stored = localStorage.getItem(`${ATTEMPTS_KEY}_visitor`); attemptsLeft = (stored !== null) ? parseInt(stored) : 1; 
                updateAttemptsUI(); renderDynamicGames(); return; 
            }
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${urlParams.get('classId')}&itemId=${LESSON_KEY}&t=${Date.now()}`);
                const res = await response.json();
                if (res.status === "success" && res.data) {
                    window.currentStudentData = res.data;
                    const consumed = res.data.lessons?.[LESSON_KEY]?.attempts || 0;
                    attemptsLeft = Math.max(0, 3 - consumed); 
                    if (attemptsLeft === 0 && res.data.lessons?.[LESSON_KEY]?.waitTime > 0) { startTimer(Date.now() + res.data.lessons[LESSON_KEY].waitTime); }
                    if(res.data.name) document.getElementById('student-name').textContent = res.data.name;
                    
                    // عرض أفضل درجة مسجلة في شريط العنوان فوراً
                    if(res.data.lessons?.[LESSON_KEY]?.score !== undefined) {
                        document.getElementById('student-score').innerHTML = convertToArabic(res.data.lessons[LESSON_KEY].score);
                        document.getElementById('header-score-badge').classList.remove('hidden');
                    }
                }
            } catch(e) {} finally { updateAttemptsUI(); renderDynamicGames(); }
        }

        window.openGameModal = function(url, title) { const modal = document.getElementById('game-modal'); document.getElementById('game-modal-title').textContent = title; document.getElementById('game-iframe').src = url; modal.classList.remove('hidden'); };
        window.closeGameModal = function() { document.getElementById('game-modal').classList.add('hidden'); document.getElementById('game-iframe').src = ''; fetchStudentData(); /* تحديث البيانات عند إغلاق اللعبة */ };
        window.toggleMaximize = function() { const container = document.getElementById('game-frame-container'); container.classList.toggle('fullscreen'); };
        window.toggleMinimize = function() { const container = document.getElementById('game-frame-container'); container.classList.toggle('minimized'); };

        window.switchTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz' && document.getElementById('quizForm').innerHTML === '') generateQuiz();
        };

        window.showExplain = function(i) { document.getElementById('modal-content').innerHTML = currentQuestions[i].e; document.getElementById('modal').classList.remove('hidden'); };
        window.showSmart = function(i) { document.getElementById('modal-content').innerHTML = `<p class="font-bold text-purple-700">💡 الحل الذكي:</p>${currentQuestions[i].smart}`; document.getElementById('modal').classList.remove('hidden'); };
        window.closeModal = function() { document.getElementById('modal').classList.add('hidden'); };

        function initStepInteractive() {
            document.querySelectorAll('div[id^="interactive-container-"]').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                const placeholder = container.querySelector('.interactive-placeholder');
                let current = -1;
                const update = () => {
                    if (current === -1) { placeholder?.classList.remove('hidden'); if(prevBtn) prevBtn.disabled = true; } 
                    else { placeholder?.classList.add('hidden'); if(prevBtn) prevBtn.disabled = false; }
                    steps.forEach((s, i) => s.classList.toggle('active', i <= current));
                    if (current >= steps.length - 1) { nextBtn?.classList.add('hidden'); resetBtn?.classList.remove('hidden'); } 
                    else { nextBtn?.classList.remove('hidden'); resetBtn?.classList.add('hidden'); }
                };
                if(nextBtn) nextBtn.onclick = () => { current++; update(); };
                if(prevBtn) prevBtn.onclick = () => { current--; update(); };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
            });
        }

        window.onload = () => {
            const nav = document.getElementById('bottom-nav-container');
            nav.innerHTML = '';
            tabs.forEach((t, i) => { const item = document.createElement('div'); item.className = `nav-item ${i===0?'active':''}`; item.id = `nav-${t.id}`; item.onclick = () => switchTab(t.id); item.innerHTML = `<i data-lucide="${t.icon}"></i><span>${t.label}</span>`; nav.appendChild(item); });
            lucide.createIcons();
            
            const setupGallery = (containerId, data) => {
                const container = document.getElementById(containerId); const items = container.querySelectorAll('.strip-item'); const expArea = container.querySelector('.explanation-area');
                const update = (i) => { items.forEach((it, j) => it.classList.toggle('active', j === i)); expArea.innerHTML = `<div class="step-box"><p class="text-sm font-bold text-gray-700">${data[i].analysis}</p></div><div class="step-box border-green-500 bg-green-50 mt-2"><p class="text-sm font-bold text-green-800">${data[i].result}</p></div>`; };
                items.forEach((it, i) => it.onclick = () => update(i)); update(0);
            };
            const galleryData1 = [ 
                { analysis: 'تتكون من حد واحد فقط (ثابت أو متغير).', result: '١) <span class="math-eq">٧س<sup class="tiny-sup">٢</sup></span><br>٢) <span class="math-eq">-١٠</span>' }, 
                { analysis: 'تتكون من مجموع وحيدتي حد متميزتين.', result: '١) <span class="math-eq">س + ٣</span><br>٢) <span class="math-eq">٢ص<sup class="tiny-sup">٢</sup> - ١</span>' }, 
                { analysis: 'تتكون من مجموع ثلاث وحيدات حد.', result: '١) <span class="math-eq">س<sup class="tiny-sup">٢</sup> + ٦س + ٨</span>' }, 
                { analysis: 'تتكون من أكثر من ٣ حدود متميزة.', result: '١) <span class="math-eq">س<sup class="tiny-sup">٥</sup> - س<sup class="tiny-sup">٤</sup> + ٣س<sup class="tiny-sup">٣</sup> + ٢</span>' } 
            ];
            const galleryData2 = [ 
                { analysis: 'وجود المتغير في المقام ممنوع.', result: 'مثال: <span class="fraction"><span>٥</span><span class="bar"></span><span>س</span></span>' }, 
                { analysis: 'الأسس يجب أن تكون أعداداً صحيحة غير سالبة.', result: 'مثال: <span class="math-eq">ص<sup class="tiny-sup">-٣</sup> + ٨</span>' }, 
                { analysis: 'المتغير تحت الجذر ممنوع.', result: `${renderRootHTML('س')} + ٤` } 
            ];
            setupGallery('gallery-container-1', galleryData1); setupGallery('gallery-container-2', galleryData2);
            initStepInteractive(); fetchStudentData();
            document.getElementById('student-name').textContent = window._initialName;
        };
    </script>
</body>
</html>

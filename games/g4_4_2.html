<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุชุจุงููุฉ ุงูุทุจูุนุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- ุงูุฎุท  ุงูุฃุณุงุณู --- */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #333; /* ููู ุงุญุชูุงุทู */
            /* ุงูุฎูููุฉ ูุชู ุชุญููููุง ุงูุขู ุนุจุฑ JS */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100vw;
        }

        /* --- ุงูููุงููู ุงูุตุงุฑูุฉ ูุนุฑุถ ุงูุฑูุงุถูุงุช (ูู ูููู) --- */
        .math-formula {
            direction: ltr;
            unicode-bidi: embed; 
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            color: #1E3A8A; /* ุฃุฒุฑู ุฏุงูู */
            font-size: 1.1em; /* ุชู ุชุตุบูุฑู ููููุงู */
        }
        
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 0.9em;
            margin: 0 0.2em;
            line-height: 1.2;
        }
        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #1E3A8A;
            padding: 0 0.2em;
        }
        .fraction .denominator {
            display: block;
            padding: 0 0.2em;
        }
        /* --- ููุงูุฉ ููุงููู ุงูุฑูุงุถูุงุช --- */

        /* --- ุญุงููุฉ ุงููุนุจุฉ ุงูุฑุฆูุณูุฉ --- */
        .game-container {
            width: 100%;
            max-width: 400px; /* <--- ุชู ุงูุชุตุบูุฑ ูู 500px */
            margin: 1rem auto;
            /* ุงูุดูุงููุฉ 50% */
            background-color: rgba(255, 255, 255, 0.5); 
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 1rem; /* ุชู ุชูููู ุงูุญุดู */
            overflow: hidden;
            transition: all 0.3s ease;
        }

        @media (max-width: 600px) {
            .game-container {
                margin: 0.5rem;
                padding: 0.75rem;
                max-width: 95vw;
            }
        }

        /* --- ุดุงุดุฉ ุงูุจุฏุงูุฉ ูุงูุชุญููู --- */
        #loading-screen {
            text-align: center;
            color: white;
            padding: 2rem 1.5rem; /* ุชุนุฏูู ุงูุญุดู */
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 1.5rem;
            width: 90%; /* ุชุตุบูุฑ ุงูุนุฑุถ */
            max-width: 320px; /* <--- ุชู ุงูุชุตุบูุฑ ูู 400px */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        #loading-screen h1 {
            font-size: 2rem; /* ุชุตุบูุฑ ุงูุฎุท 3xl */
        }
        
        #loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ade80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #start-button {
            display: none; /* ูุชู ุฅุธูุงุฑู ุนุจุฑ JS */
            margin: 0 auto; /* ุชูุณูุท ุงูุฒุฑ */
        }
        #welcome-content {
            display: none; /* ูุชู ุฅุธูุงุฑู ุนุจุฑ JS */
        }

        /* --- ุดุงุดุฉ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ --- */
        .category-grid {
            /* display: grid; */
            /* grid-template-columns: repeat(3, 1fr); */
            display: flex; /* <--- Change to flex */
            flex-wrap: wrap; /* <--- Add wrap */
            justify-content: center; /* <--- Add center */
            gap: 0.75rem; /* ุชู ุชูููู ุงููุฌูุฉ */
        }
        .category-grid .category-item:nth-child(4),
        .category-grid .category-item:nth-child(5) {
            /* grid-column: span 1; */ /* REMOVED */
        }
        /* ูุชูุณูุท ุขุฎุฑ ุนูุตุฑูู */
        .category-grid .category-item:nth-child(4) {
            /* grid-column-start: 1; */ /* REMOVED */
            /* grid-column-end: 2; */ /* REMOVED */
        }
        .category-grid .category-item:nth-child(5) {
            /* grid-column-start: 2; */ /* REMOVED */
            /* grid-column-end: 4; */ /* REMOVED */
        }
        .category-item {
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid transparent;
            border-radius: 1rem;
            padding: 0.5rem; /* ุชู ุชูููู ุงูุญุดู */
            font-size: 2.5rem; /* ุชู ุชุตุบูุฑ ุงูุฃููููุฉ */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;

            /* --- NEW RULES --- */
            flex-grow: 0; /* <--- ุฅุตูุงุญ: ููุน ุงูููู */
            flex-shrink: 1; /* ุงูุณูุงุญ ุจุงูุชููุต */
            /* ุญุณุงุจ ุงูุนุฑุถ ูู 3 ุฃุนูุฏุฉ ูุน ุงููุฌูุฉ */
            flex-basis: calc((100% - 1.5rem) / 3); /* <--- ุญุณุงุจ ุฏููู */
            min-width: 100px; /* ุฃูู ุนุฑุถ */
            
            aspect-ratio: 1 / 1; /* ุฌุนููุง ูุฑุจุนุฉ */
            display: flex; /* ูุชูุณูุท ุงูุฃููููุฉ */
            align-items: center; /* ูุชูุณูุท ุงูุฃููููุฉ */
            justify-content: center; /* ูุชูุณูุท ุงูุฃููููุฉ */
        }
        .category-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        /* ุชุถููู ุงูุฃููููุฉ ุงูููุชููุฉ */
        .category-item.completed {
            background-color: rgba(220, 220, 220, 0.7);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .category-item.completed::after {
            content: 'โ';
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #777;
        }

        /* --- ุดุงุดุฉ ุงูุณุคุงู (ุงููุฑุญูุฉ 1) --- */
        #question-screen {
            display: none;
            position: relative;
            padding: 0.5rem; /* ุชู ุชูููู ุงูุญุดู */
        }
        /* ุงูุนูุงูุฉ ุงููุงุฆูุฉ (ุงูุฃููููุฉ ูุฎูููุฉ) */
        #question-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12rem;
            color: rgba(0, 0, 0, 0.05);
            opacity: 0.5;
            z-index: 0;
            user-select: none;
        }
        /* ุฅุทุงุฑ ูุต ุงูุณุคุงู */
        .question-text-frame {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 0.75rem; /* ุชู ุชูููู ุงูุญุดู */
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 1;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem; /* ุชู ุชูููู ุงููุฌูุฉ */
            position: relative;
            z-index: 1;
        }
        .option-button {
            background-color: rgba(255, 255, 255, 0.8); /* ุดูุงููุฉ 80% */
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        /* ุฅุฎูุงุก ุฏูุงุฆุฑ ุงูุงุฎุชูุงุฑ */
        .option-button input[type="radio"] {
            display: none;
        }
        
        /* ุชุฃุซูุฑุงุช ุงูุฃุฒุฑุงุฑ (ูุจู ุงูุฅุฌุงุจุฉ) */
        .option-button:not(.disabled):hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        /* ุจุนุฏ ุงูุฅุฌุงุจุฉ */
        .option-button.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .option-button.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .option-button.correct {
            border-color: #16a34a;
            background-color: #f0fdf4;
            color: #15803d;
            font-weight: bold;
            opacity: 1;
        }
        .option-button.incorrect {
            border-color: #dc2626;
            background-color: #fef2f2;
            color: #b91c1c;
            font-weight: bold;
            opacity: 1;
        }
        
        /* ูููุถ ููุฅุฌุงุจุฉ ุงูุตุญูุญุฉ */
        @keyframes flash-green {
            0%, 100% { background-color: #f0fdf4; }
            50% { background-color: #bbf7d0; }
        }
        .option-button.correct.flash {
            animation: flash-green 0.5s 3;
        }

        /* --- ุดุงุดุฉ ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุฎุท ุงูุฃุนุฏุงุฏ) --- */
        #graph-screen {
            display: none;
            padding: 0.5rem; /* ุชู ุชูููู ุงูุญุดู */
        }
        /* ุฅุทุงุฑ ูุต ุงูุณุคุงู (ุงููุฑุญูุฉ ุงูุซุงููุฉ) */
        .graph-text-frame {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 0.75rem; /* ุชู ุชูููู ุงูุญุดู */
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 1;
        }
        
        .number-line-container {
            width: 100%;
            padding: 2rem 1rem 2rem 1rem; /* ุชุนุฏูู ุงูุญุดู */
            position: relative;
            direction: ltr; /* ููู ูุชุฑุชูุจ ุงูุฃุฑูุงู */
            margin-bottom: 0.5rem; /* ุชู ุชูููู ุงููุณุงูุฉ */
        }
        .number-line-track {
            width: 100%;
            height: 8px;
            background-color: #3f3f46; /* ุฑูุงุฏู ุฏุงูู (ุดุจู ุฃุณูุฏ) */
            border-radius: 4px;
            position: relative;
        }
        .number-line-points {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 90%; /* (90%) ูุฒูุงุฏุฉ ุงููุณุงูุฉ */
            display: flex;
            justify-content: space-evenly; /* ุชูุฒูุน ูุชุณุงูู */
        }
        .number-line-point {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .point-visual {
            width: 24px;
            height: 24px;
            margin-bottom: -28px; /* ุชู ุชูุฑูุจูุง ูู ุงูุฎุท */
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .point-visual .point-line {
            width: 3px;
            height: 24px;
            background-color: #4b5563;
            border-radius: 2px;
        }
        .point-visual .point-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 4px solid #3b82f6;
            background-color: white;
        }
        .point-visual .point-circle.closed {
            background-color: #3b82f6;
        }
        .point-label {
            margin-top: 30px; /* ุชู ุชูุฑูุจูุง ูู ุงูุฎุท */
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1rem;
        }
        
        /* ุญุงููุฉ ุฃุฒุฑุงุฑ ุงูุฃุณูู ุงูุตุบูุฑุฉ */
        .arrow-controls {
            position: absolute;
            bottom: 40px; /* ููู ุงูููุทุฉ */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem;
            z-index: 10;
            visibility: hidden; /* ูุฎููุฉ ุงูุชุฑุงุถูุงู */
            opacity: 0;
            transition: all 0.2s ease;
        }
        .point-visual:not(.state-0) + .arrow-controls {
            visibility: visible;
            opacity: 1;
        }
        .arrow-control {
            font-size: 1.25rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            padding: 0 0.25rem;
        }
        .arrow-control:hover {
            color: #3b82f6;
        }
        .arrow-control.active {
            color: #3b82f6;
        }

        /* ุงูุฃุณูู ุงูุทูููุฉ ุงูููุชุฏุฉ */
        .line-segment {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 6px;
            background-color: #3b82f6;
            z-index: 1;
            display: none; /* ูุฎูู ุงูุชุฑุงุถูุงู */
            transition: all 0.2s ease;
        }
        /* ุงูุณูู ุงูุฃููู (ุงูุฃุฒุฑู) */
        .line-segment.right {
            left: 50%; /* <--- ุฅุตูุงุญ: ุงุฌุนูู ูุจุฏุฃ ูู ุงููุฑูุฒ */
            width: 100px; /* ูุตู ุงูุทูู */
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }
        .line-segment.right::after {
            content: '';
            position: absolute;
            right: -12px; /* ุฅุตูุงุญ ุฑุฃุณ ุงูุณูู */
            top: 50%;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 12px solid #3b82f6;
        }
        /* ุงูุณูู ุงูุฃูุณุฑ (ุงูุฃุฎุถุฑ) */
        .line-segment.left {
            right: 50%; /* <--- ุฅุตูุงุญ: ุงุฌุนูู ูุจุฏุฃ ูู ุงููุฑูุฒ */
            width: 100px; /* ูุตู ุงูุทูู */
            background-color: #16a34a; /* ุฃุฎุถุฑ */
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }
        .line-segment.left::after {
            content: '';
            position: absolute;
            left: -12px; /* ุฅุตูุงุญ ุฑุฃุณ ุงูุณูู */
            top: 50%;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 12px solid #16a34a;
        }

        /* --- ุดุงุดุฉ ุงูููุงูุฉ (ุณุฌู ุงูุฃุจุทุงู) --- */
        #finish-screen {
            display: none;
            padding: 1rem;
            text-align: center;
        }
        #leaderboard-loader {
            display: none;
        }
        #finish-game-wrapper {
            display: none;
            margin-top: 1.5rem;
        }

        /* --- ุงูุดุฑูุท ุงูุณููู ููุฃุฒุฑุงุฑ --- */
        .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem; /* ุชู ุชูููู ุงูุญุดู */
            border-top: 1px solid #e5e7eb;
            margin-top: 0.75rem; /* ุชู ุชูููู ุงููุณุงูุฉ */
            gap: 0.5rem;
        }
        .bottom-bar > * {
            flex: 1;
        }
        /* ุฃุฒุฑุงุฑ CTA (ุงูุฃุณุงุณูุฉ) */
        .cta-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: block;
        }
        .cta-button:hover {
            background-color: #2563eb;
        }
        .cta-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        /* ุฒุฑ "ุงุนุฑู ููุงุฐุงุ" (ุซุงููู) */
        .secondary-button {
            background-color: #4b5563;
        }
        .secondary-button:hover {
            background-color: #374151;
        }
        /* ุฒุฑ "ุชุญูู ูู ุฑุณูู" (ุฃุฎุถุฑ) */
        .confirm-button {
            background-color: #166534; /* ุฃุฎุถุฑ ุฏุงูู */
            flex-grow: 2; /* ูุฃุฎุฐ ูุณุงุญุฉ ุฃูุจุฑ */
        }
        .confirm-button:hover {
            background-color: #15803d;
        }
        
        /* --- ุตูุฏูู ุงููุชูุฌุฉ (ุจูู ุงูุฃุฒุฑุงุฑ) --- */
        .feedback-box {
            flex: 1.5;
            text-align: center;
            font-weight: 700;
            padding: 0.6rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            display: none; /* ูุฎูู ุงูุชุฑุงุถูุงู */
        }
        .feedback-box.correct {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        .feedback-box.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* --- ุนูุงุตุฑ ุนุฏุงุฏ ุงูููุช --- */
        .timer-display {
            background-color: #e0e7ff;
            color: #3730a3;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: 700;
            text-align: center;
        }
        #total-timer {
            background-color: #ede9fe;
            color: #5b21b6;
            padding: 0.5rem 1rem;
            border-radius: 99px;
            margin-bottom: 0.75rem;
            display: inline-block;
        }

        /* --- NEW: ุญุงููุฉ ุงูููุช ูุงูููุงุท --- */
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        /* --- NEW: ุนุฑุถ ุงูููุงุท --- */
        #total-points-display {
            background-color: #eef2ff;
            color: #4338ca;
            padding: 0.5rem 1rem;
            border-radius: 99px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .category-score {
            position: absolute;
            bottom: 5px;
            left: 10px; /* ุชู ุชุบููุฑ ุงููููุน ูููุณุงุฑ */
            font-size: 0.9rem;
            font-weight: 800;
            color: #444;
        }
        .invisible {
            visibility: hidden;
            opacity: 0;
        }

        /* --- ุงููุงูุฐุฉ ุงูููุจุซูุฉ (Modal) ููุดุฑุญ --- */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: none;
        }
        #modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 360px; /* <--- ุชู ุงูุชุตุบูุฑ ูู 450px */
            z-index: 50;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
        }
        #modal-close {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 50%;
        .category-item.completed::after {
            content: 'โ';
            position: absolute;
            top: 5px;
            right: 10px; /* ุนูุงูุฉ ุงูุตุญ ุชุจูู ูููู */
            font-size: 1.5rem;
            font-weight: bold;
            color: #6b7280;
        }
        #modal-close:hover {
            background-color: #e5e7eb;
        }

    </style>
</head>
<body class="bg-gray-200">

    <!-- ุดุงุดุฉ ุงูุจุฏุงูุฉ (ุชุญููู ูุชุนูููุงุช) -->
    <div id="loading-screen">
        <div id="loading-spinner"></div>
        <p id="loading-text" class="text-lg font-semibold mb-4">ุฌุงุฑู ุชุญููู ุงูุฎูููุฉ...</p>
        
        <div id="welcome-content">
            <h1 class="text-3xl font-bold mb-4">ูุชุจุงููุฉ ุงูุทุจูุนุฉ</h1>
            <!-- ุฑุณุงูุฉ ุงูุชุฑุญูุจ ุงูุชู ูุชู ุชุฎุตูุตูุง -->
            <p id="welcomeMessage" class="text-base mb-4">
                ุฃููุงู ุจู ูู "ูุชุจุงููุฉ ุงูุทุจูุนุฉ"! ูููุชู ูู ูุณุงุนุฏุฉ ุงูุนููุงุก ูู ุชุฌุงุฑุจูู ุนู ุทุฑูู ุญู 5 ุชุญุฏูุงุช. ูู ุชุญุฏู ูุชููู ูู ูุฑุญูุชูู: ุงุฎุชูุงุฑ ุงููุชุจุงููุฉ ุงูุตุญูุญุฉุ ุซู ุชูุซูููุง ุนูู ุฎุท ุงูุฃุนุฏุงุฏ.
            </p>
            <p class="text-sm text-gray-300 mb-6">
                ููุฑุฉ ูุชุตููู: ุงูุฃุณุชุงุฐ ุนุจุฏุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู
            </p>
            <button id="start-button" class="cta-button confirm-button px-8 py-3 text-lg">
                ุงุจุฏุฃ ุงููุนุจุฉ!
            </button>
        </div>
    </div>

    <!-- ุญุงููุฉ ุงููุนุจุฉ ุงูุฑุฆูุณูุฉ (ุงููุงุฆูุฉุ ุงูุณุคุงูุ ุงูุฑุณูุ ุงูููุงูุฉ) -->
    <div id="game-container" class="game-container hidden">

        <!-- 1. ุดุงุดุฉ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ -->
        <div id="main-screen">
            <h1 class="text-2xl font-bold text-center mb-1 text-gray-800">ูุชุจุงููุฉ ุงูุทุจูุนุฉ</h1>
            <p class="text-center text-gray-600 mb-3">ุงุฎุชุฑ ุฃุญุฏ ุงูุชุญุฏูุงุช ูุชุจุฏุฃ</p>
            
            <!-- ุนุฏุงุฏ ุงูููุช ุงูุฅุฌูุงูู (ูุชููู ููุง) -->
            <div class="stats-container">
                <div id="total-timer">ุงูููุช ุงูุฅุฌูุงูู: ู ุซุงููุฉ</div>
                <!-- NEW: ุงูููุงุท ุงูุฅุฌูุงููุฉ -->
                <div id="total-points-display">ุงูููุงุท: ู / ูกู</div>
            </div>

            <div class="category-grid">
                <div class="category-item" data-category="egg">๐ฅ</div>
                <div class="category-item" data-category="tube">๐งช</div>
                <div class="category-item" data-category="rabbit">๐</div>
                <div class="category-item" data-category="temp">๐ก๏ธ</div>
                <div class="category-item" data-category="drop">๐ง</div>
            </div>
        </div>

        <!-- 2. ุดุงุดุฉ ุงูุณุคุงู (ุงููุฑุญูุฉ ุงูุฃููู) -->
        <div id="question-screen">
            <!-- ุงูุนูุงูุฉ ุงููุงุฆูุฉ -->
            <div id="question-watermark"></div>
            
            <!-- ุฅุทุงุฑ ูุต ุงูุณุคุงู -->
            <div class="question-text-frame">
                <p id="question-context" class="text-gray-700 mb-2"></p>
                <p id="question-text" class="text-lg font-semibold text-gray-900"></p>
            </div>

            <div id="options-container" class="options-grid">
                <!-- ุงูุฃุฒุฑุงุฑ ุชุถุงู ููุง ุนุจุฑ JS -->
            </div>
            
            <div class="bottom-bar">
                <button id="q-explain-button" class="cta-button secondary-button invisible">ุงุนุฑู ููุงุฐุงุ</button>
                
                <!-- ุนุฏุงุฏ ุงูููุช (ูุธูุฑ ููุง) ุฃู ุตูุฏูู ุงููุชูุฌุฉ -->
                <div id="question-timer" class="timer-display">ุงูููุช: ู ุซ</div>
                <div id="q-feedback-box" class="feedback-box"></div>
                
                <button id="q-next-button" class="cta-button" disabled>ุงูุชุงูู</button>
            </div>
        </div>

        <!-- 3. ุดุงุดุฉ ุฎุท ุงูุฃุนุฏุงุฏ (ุงููุฑุญูุฉ ุงูุซุงููุฉ) -->
        <div id="graph-screen">
            
            <!-- ุฅุทุงุฑ ูุต ุงูุณุคุงู (ุงููุฑุญูุฉ ุงูุซุงููุฉ) -->
            <div class="graph-text-frame">
                <p id="graph-correct-answer" class="text-center font-bold text-lg mb-2"></p>
                <p class="text-base font-semibold text-gray-900 text-center">ุงูุขูุ ูู ุจุชูุซูู ูุฐู ุงููุชุจุงููุฉ ุนูู ุฎุท ุงูุฃุนุฏุงุฏ:</p>
            </div>

            <div class="number-line-container">
                <div class="number-line-track"></div>
                <div id="number-line-points-container" class="number-line-points">
                    <!-- ุงูููุงุท ุชุถุงู ููุง ุนุจุฑ JS -->
                </div>
            </div>

            <div class="flex justify-center mb-2">
                <div id="graph-timer" class="timer-display hidden">ุงูููุช: ู ุซ</div>
            </div>

            <button id="g-check-button" class="cta-button confirm-button w-full">ุชุญูู ูู ุฑุณูู</button>

            <div class="bottom-bar hidden" id="g-bottom-bar">
                <button id="g-explain-button" class="cta-button secondary-button">ุงุนุฑู ููุงุฐุงุ</button>
                <div id="g-feedback-box" class="feedback-box"></div>
                <button id="g-back-button" class="cta-button">ุงูุนูุฏุฉ ูููุงุฆูุฉ</button>
            </div>
        </div>

        <!-- 4. ุดุงุดุฉ ุงูููุงูุฉ (ุณุฌู ุงูุฃุจุทุงู) -->
        <div id="finish-screen">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">ุฃุญุณูุช! ุฃูููุช ุงูุชุญุฏู</h1>
            
            <!-- ุนุฑุถ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ -->
            <div id="final-result-display" class="mb-6">
                <!-- ูุชู ููุคู ุจูุงุณุทุฉ saveAndFinishGame -->
            </div>

            <!-- ุญุงููุฉ ุณุฌู ุงูุฃุจุทุงู -->
            <div id="leaderboard-loader" class="text-center">
                <div class="inline-block border-4 border-gray-300 border-t-blue-500 rounded-full w-10 h-10 animate-spin"></div>
                <p class="mt-2 text-gray-600">ุฌุงุฑู ุชุญููู ุณุฌู ุงูุฃุจุทุงู...</p>
            </div>
            <div id="leaderboard-container">
                <!-- ูุชู ููุคู ุจูุงุณุทุฉ fetchAndShowLeaderboard -->
            </div>

            <!-- ุฒุฑ ุงูุนูุฏุฉ ููููุตุฉ -->
            <div id="finish-game-wrapper">
                <button id="finish-game-btn" class="cta-button confirm-button w-full text-lg py-3">
                    ุงูุนูุฏุฉ ุฅูู ุงูููุตุฉ
                </button>
            </div>
        </div>

    </div>

    <!-- ุงููุงูุฐุฉ ุงูููุจุซูุฉ (Modal) ููุดุฑุญ -->
    <div id="modal-backdrop"></div>
    <div id="modal">
        <div id="modal-close">โ</div>
        <h2 class="text-2xl font-bold text-center mb-4 text-blue-800">ุงูุดุฑุญ</h2>
        <p id="modal-explanation" class="text-gray-700 text-center"></p>
    </div>


    <script>
        // --- ุฅุนุฏุงุฏุงุช ุงููุนุจุฉ ---
        const gameContainer = document.getElementById('game-container');
        const loadingScreen = document.getElementById('loading-screen');
        const mainScreen = document.getElementById('main-screen');
        const questionScreen = document.getElementById('question-screen');
        const graphScreen = document.getElementById('graph-screen');
        const finishScreen = document.getElementById('finish-screen');
        
        const qWatermark = document.getElementById('question-watermark');
        const qContext = document.getElementById('question-context');
        const qText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const qNextButton = document.getElementById('q-next-button');
        const qExplainButton = document.getElementById('q-explain-button');
        const qFeedbackBox = document.getElementById('q-feedback-box');
        const qTimerDisplay = document.getElementById('question-timer');

        const gCheckButton = document.getElementById('g-check-button');
        const gBottomBar = document.getElementById('g-bottom-bar');
        const gFeedbackBox = document.getElementById('g-feedback-box');
        const gExplainButton = document.getElementById('g-explain-button');
        const gBackButton = document.getElementById('g-back-button');
        const gGraphAnswer = document.getElementById('graph-correct-answer');
        const gPointsContainer = document.getElementById('number-line-points-container');
        const gTimerDisplay = document.getElementById('graph-timer');

        const totalTimerDisplay = document.getElementById('total-timer');
        
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modal = document.getElementById('modal');
        const modalExplanation = document.getElementById('modal-explanation');
        const modalClose = document.getElementById('modal-close');

        // --- ุจูู ุงูุฃุณุฆูุฉ ---
        const questionBank = {
            'egg': [
                { context: "ููู ูููุณ ุจูุถ ุงูุณูุงุญู ุจูุฌุงุญุ ูุฌุจ ุฃู ุชุจูู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงูุญุงุถูุฉ (ุณ) ุจูู ูขูจยฐู ู ูฃูขยฐู. ุดุงููุฉ ูุงุชูู ุงูุฏุฑุฌุชูู.", text: "ุงููุชุจุงููุฉ ุงููุฑูุจุฉ ุงูุชู ุชูุซู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงูุตุงูุญุฉ ููููุณ ูู:", answer: "ูขูจ โค ุณ โค ูฃูข", options: ["ูขูจ โค ุณ โค ูฃูข", "ุณ < ูขูจ ุฃู ุณ > ูฃูข", "ุณ โฅ ูขูจ", "ุณ โค ูฃูข"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุชูุงุทุน\" (ูู) ูุฃู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ูุฌุจ ุฃู ุชุญูู ุงูุดุฑุทูู ูุนุงู (ุฃูุจุฑ ูู ุฃู ุชุณุงูู ูขูจ \"ูู\" ุฃุตุบุฑ ูู ุฃู ุชุณุงูู ูฃูข). ูุงูุทุฑูุงู ุดุงููุงู.", graph: { type: 'and', points: [{ v: 28, c: true }, { v: 32, c: true }] } },
                { context: "ุจูุถ ุงูุชูุงุณูุญ ุญุณุงุณ ุฌุฏุงูุ ููุฌุจ ุฃู ุชุจูู ุฏุฑุฌุฉ ุญุฑุงุฑุชู (ุณ) ุจูู ูฃูยฐู ู ูฃูคยฐู ุถููุงู (ุดุงููุฉ) ูุถูุงู ููุณ ุงูุฐููุฑ.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชูุซู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ููุณ ุงูุฐููุฑ ูู:", answer: "ูฃู โค ุณ โค ูฃูค", options: ["ูฃู < ุณ < ูฃูค", "ูฃู โค ุณ โค ูฃูค", "ุณ โค ูฃู", "ุณ โฅ ูฃูค"], explanation: "ูููุฉ \"ุถููุงู\" ุฃู \"ุดุงููุฉ\" ุชุนูู ุฃู ุงูุนุฏุฏูู ูฃู ู ูฃูค ูุนูุง ูู ุงูุญู. ููู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู) ูุฃู ุงูุญุฑุงุฑุฉ ูุฌุจ ุฃู ุชููู ุจูู ุงููููุชูู.", graph: { type: 'and', points: [{ v: 30, c: true }, { v: 34, c: true }] } },
                { context: "ููู ูููุณ ุจูุถ ุงููุณุฑ ุจูุฌุงุญุ ูุฌุจ ุฃู ุชุจูู ูุชุฑุฉ ุงูุญุถุงูุฉ (ุณ) ุจูู ูฃู ูููุงู ู ูฃูฅ ูููุงูุ ุดุงููุฉ ููุทุฑููู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชูุซู ูุชุฑุฉ ุงูุญุถุงูุฉ ุงูุตุญูุญุฉ ูู:", answer: "ูฃู โค ุณ โค ูฃูฅ", options: ["ุณ > ูฃู ุฃู ุณ < ูฃูฅ", "ุณ < ูฃู", "ูฃู โค ุณ โค ูฃูฅ", "ุณ > ูฃูฅ"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุชูุงุทุน\" (ูู) ูุฃู ูุชุฑุฉ ุงูุญุถุงูุฉ ูุฌุจ ุฃู ุชุญูู ุงูุดุฑุทูู ูุนุงู (ุฃูุจุฑ ูู ุฃู ุชุณุงูู ูฃู \"ูู\" ุฃุตุบุฑ ูู ุฃู ุชุณุงูู ูฃูฅ). ูุงูุทุฑูุงู ุดุงููุงู.", graph: { type: 'and', points: [{ v: 30, c: true }, { v: 35, c: true }] } }
            ],
            'tube': [
                { context: "ููู ูุชู ุงูุชูุงุนู ุจุฃูุงูุ ูุฌุจ ุฃู ุชููู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงููุฒูุฌ (ุณ) ุฅูุง ุฃูู ูู ูขูยฐู ุฃู ุฃุนูู ูู ูฅูยฐู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุฏุฑุฌุงุช ุงูุญุฑุงุฑุฉ ุงูุขููุฉ ูู:", answer: "ุณ < ูขู ุฃู ุณ > ูฅู", options: ["ูขู โค ุณ โค ูฅู", "ุณ < ูขู ุฃู ุณ > ูฅู", "ุณ โฅ ูขู", "ุณ < ูฅู"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ูุง ูููู ุฃู ุชููู ูู ุงูููุงููู ุจููุณ ุงูููุช. ููู \"ุฃูู ูู ูขู\" (ูุง ุชุดูู ูขู) \"ุฃู\" \"ุฃุนูู ูู ูฅู\" (ูุง ุชุดูู ูฅู).", graph: { type: 'or', points: [{ v: 20, c: false }, { v: 50, c: false }] } },
                { context: "ูุชุฎุฒูู ูุงุฏุฉ ููููุงุฆูุฉ ุจุฃูุงูุ ูุฌุจ ุฃู ุชููู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงููุฎุฒู (ุณ) ุฅูุง ุฃูู ุชูุงูุงู ูู ูกูฅยฐูุ ุฃู ุฃุนูู ุชูุงูุงู ูู ูคูยฐู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงูุชุฎุฒูู ุงูุขูู ูู:", answer: "ุณ < ูกูฅ ุฃู ุณ > ูคู", options: ["ูกูฅ โค ุณ โค ูคู", "ุณ > ูกูฅ", "ุณ < ูคู", "ุณ < ูกูฅ ุฃู ุณ > ูคู"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃููุง ุฅูุง ููุง ุฃู ููุงู. ููููุฉ \"ุชูุงูุงู\" ุชุนูู ุฃู ุงูุฃุทุฑุงู (ูกูฅ ู ูคู) ุบูุฑ ุดุงููุฉ.", graph: { type: 'or', points: [{ v: 15, c: false }, { v: 40, c: false }] } },
                { context: "ูุนุชุจุฑ ูุณุชูู ุงูุจุนุงุซุงุช ุงููุตูุน (ุณ) ุฎุทุฑุงู ุฅุฐุง ูุงู ุฃูู ูู ูกู ูุญุฏุงุช (ุบูุฑ ูุนุงู) ุฃู ุฃุนูู ูู ูฉู ูุญุฏุฉ (ุฎุทุฑ ุงููุฌุงุฑ).", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงููุณุชูู ุงูุฎุทุฑ ููุงูุจุนุงุซุงุช ูู:", answer: "ุณ < ูกู ุฃู ุณ > ูฉู", options: ["ุณ > ูกู", "ูกู โค ุณ โค ูฉู", "ุณ < ูกู ุฃู ุณ > ูฉู", "ุณ < ูฉู"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃู ุงููุณุชูู ูุง ูููู ุฃู ูููู ูู ุงููุทุงููู ูุนุงู. ููู \"ุฃูู ูู ูกู\" (ูุง ุชุดูู ูกู) \"ุฃู\" \"ุฃุนูู ูู ูฉู\" (ูุง ุชุดูู ูฉู).", graph: { type: 'or', points: [{ v: 10, c: false }, { v: 90, c: false }] } }
            ],
            'rabbit': [
                { context: "ุงูุฌุฑุนุฉ ุงููุณููุญุฉ ูู ุฏูุงุก ููุฃุฑุงูุจ (ุณ) ูู ูฆู ููุฌู ุจุฒูุงุฏุฉ ุฃู ููุตุงู ูุง ูุชุฌุงูุฒ ูฅ ููุฌู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงูุฌุฑุนุฉ ุงููุณููุญุฉ ูู:", answer: "ูฅูฅ โค ุณ โค ูฆูฅ", options: ["ุณ โค ูฅูฅ ุฃู ุณ โฅ ูฆูฅ", "ูฅูฅ โค ุณ โค ูฆูฅ", "ุณ < ูฅูฅ", "ุณ > ูฆูฅ"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูฆู - ูฅ = ูฅูฅ) ูุงูุฒูุงุฏุฉ (ูฆู + ูฅ = ูฆูฅ). ูููุฉ \"ูุง ูุชุฌุงูุฒ\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุดุงููุฉ (โค).", graph: { type: 'and', points: [{ v: 55, c: true }, { v: 65, c: true }] } },
                { context: "ุงููููุฉ ุงูููููุฉ ุงูููุตู ุจูุง ูู ุงูุนูู ููุฃุฑูุจ (ุณ) ูู ูจู ุฌุฑุงูุ ุจุฒูุงุฏุฉ ุฃู ููุตุงู ูุง ูุชุฌุงูุฒ ูกู ุฌุฑุงู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ูููุฉ ุงูุนูู ุงูุตุญูุญุฉ ูู:", answer: "ูงู โค ุณ โค ูฉู", options: ["ูงู โค ุณ โค ูฉู", "ุณ < ูงู ุฃู ุณ > ูฉู", "ุณ โฅ ูฉู", "ุณ โค ูงู"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูจู - ูกู = ูงู) ูุงูุฒูุงุฏุฉ (ูจู + ูกู = ูฉู). ูููุฉ \"ูุง ูุชุฌุงูุฒ\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุดุงููุฉ (โค).", graph: { type: 'and', points: [{ v: 70, c: true }, { v: 90, c: true }] } },
                { context: "ุงููุฒู ุงููุซุงูู ููุฃุฑุงูุจ ูู ุงูุชุฌุฑุจุฉ (ุณ) ูู ูฃ ูุฌูุ ุจุฒูุงุฏุฉ ุฃู ููุตุงู ูุง ูุชุฌุงูุฒ ู.ูฅ ูุฌู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงููุฒู ุงููุซุงูู ูู:", answer: "ูข.ูฅ โค ุณ โค ูฃ.ูฅ", options: ["ุณ โค ูข.ูฅ", "ุณ โฅ ูฃ.ูฅ", "ูข.ูฅ โค ุณ โค ูฃ.ูฅ", "ุณ < ูข.ูฅ ุฃู ุณ > ูฃ.ูฅ"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูฃ - ู.ูฅ = ูข.ูฅ) ูุงูุฒูุงุฏุฉ (ูฃ + ู.ูฅ = ูฃ.ูฅ). ูููุฉ \"ูุง ูุชุฌุงูุฒ\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุดุงููุฉ (โค).", graph: { type: 'and', points: [{ v: 2.5, c: true }, { v: 3.5, c: true }] } }
            ],
            'temp': [
                { context: "ุชุณุฌู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงูุทูุณ (ุณ) ูู ุฅุญุฏู ุงููุฏู ุญูู ูขูฅยฐูุ ุจูุงูุด ุฎุทุฃ ุฃูู ูู ูฃยฐู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงููุนููุฉ ูู:", answer: "ูขูข < ุณ < ูขูจ", options: ["ุณ < ูขูข", "ุณ > ูขูจ", "ุณ < ูขูข ุฃู ุณ > ูขูจ", "ูขูข < ุณ < ูขูจ"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูขูฅ - ูฃ = ูขูข) ูุงูุฒูุงุฏุฉ (ูขูฅ + ูฃ = ูขูจ). ูููุฉ \"ุฃูู ูู\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุบูุฑ ุดุงููุฉ (<).", graph: { type: 'and', points: [{ v: 22, c: false }, { v: 28, c: false }] } },
                { context: "ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุฌุณู ุงููุท ุงูุทุจูุนูุฉ (ุณ) ุชููู ุญูู ูฃูจ.ูฅยฐูุ ุจูุงูุด ุฎุทุฃ ุฃูู ูู ู.ูฅยฐู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงููุท ุงูุทุจูุนูุฉ ูู:", answer: "ูฃูจ < ุณ < ูฃูฉ", options: ["ูฃูจ โค ุณ โค ูฃูฉ", "ูฃูจ < ุณ < ูฃูฉ", "ุณ < ูฃูจ", "ุณ > ูฃูฉ"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูฃูจ.ูฅ - ู.ูฅ = ูฃูจ) ูุงูุฒูุงุฏุฉ (ูฃูจ.ูฅ + ู.ูฅ = ูฃูฉ). ูููุฉ \"ุฃูู ูู\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุบูุฑ ุดุงููุฉ (<).", graph: { type: 'and', points: [{ v: 38, c: false }, { v: 39, c: false }] } },
                { context: "ูููู ุฒูุฑุฉ ุงูุฃูุฑููุฏุ ูุฌุจ ุฃู ุชููู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ (ุณ) ุญูู ูขูคยฐูุ ุจูุงูุด ุฎุทุฃ ุฃูู ูู ูคยฐู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงูููุงุณุจุฉ ูู:", answer: "ูขู < ุณ < ูขูจ", options: ["ูขู โค ุณ โค ูขูจ", "ุณ < ูขู ุฃู ุณ > ูขูจ", "ูขู < ุณ < ูขูจ", "ุณ > ูขู"], explanation: "ูุฐู ูุชุจุงููุฉ \"ุชูุงุทุน\" (ูู). ุงูููุตุงู (ูขูค - ูค = ูขู) ูุงูุฒูุงุฏุฉ (ูขูค + ูค = ูขูจ). ูููุฉ \"ุฃูู ูู\" ุชุนูู ุฃู ุงูุฃุทุฑุงู ุบูุฑ ุดุงููุฉ (<).", graph: { type: 'and', points: [{ v: 20, c: false }, { v: 28, c: false }] } }
            ],
            'drop': [
                { context: "ูุนุชุจุฑ ูุทูู ุงูุฃูุทุงุฑ (ุณ) ุฅูุง \"ููููุงู ุฌุฏุงู\" (ุฌูุงู) ุฅุฐุง ูุงู ุฃูู ูู ูฅ ูููุ ุฃู \"ุบุฒูุฑุงู ุฌุฏุงู\" (ููุถุงู) ุฅุฐุง ูุงู ุฃุนูู ูู ูฃู ููู.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงููุทูู \"ุฎุงุฑุฌ ุงููุทุงู\" ูู:", answer: "ุณ < ูฅ ุฃู ุณ > ูฃู", options: ["ูฅ < ุณ < ูฃู", "ุณ < ูฅ ุฃู ุณ > ูฃู", "ุณ โฅ ูฅ", "ุณ โค ูฃู"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃู ุงููุทูู ูุง ูููู ุฃู ูููู ูู ุงููุทุงููู ูุนุงู. ููู \"ุฃูู ูู ูฅ\" (ูุง ุชุดูู ูฅ) \"ุฃู\" \"ุฃุนูู ูู ูฃู\" (ูุง ุชุดูู ูฃู).", graph: { type: 'or', points: [{ v: 5, c: false }, { v: 30, c: false }] } },
                { context: "ุงูุฑูู ุงูููุฏุฑูุฌููู (ุณ) ูููุงู ุงููุณุจุญ ูุนุชุจุฑ \"ุฎุงุฑุฌ ุงููุทุงู\" ุฅุฐุง ูุงู ุฃูู ูู ูง.ูข ุฃู ุฃูุจุฑ ูู ูง.ูจ.", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงูุฑูู ุงูููุฏุฑูุฌููู \"ุฎุงุฑุฌ ุงููุทุงู\" ูู:", answer: "ุณ < ูง.ูข ุฃู ุณ > ูง.ูจ", options: ["ูง.ูข < ุณ < ูง.ูจ", "ุณ > ูง.ูจ", "ุณ < ูง.ูข", "ุณ < ูง.ูข ุฃู ุณ > ูง.ูจ"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃู ุงูุฑูู ุฅูุง ููุง ุฃู ููุงู. ููููุชุง \"ุฃูู ูู\" ู \"ุฃูุจุฑ ูู\" ุชุนููุงู ุฃู ุงูุฃุทุฑุงู (ูง.ูข ู ูง.ูจ) ุบูุฑ ุดุงููุฉ.", graph: { type: 'or', points: [{ v: 7.2, c: false }, { v: 7.8, c: false }] } },
                { context: "ูุชุจูู ุดุฌุฑุฉ ูุนููุฉ ุจุตุญุฉุ ูุฌุจ ุฃู ูููู ูุณุชูู ุฑุทูุจุฉ ุงูุชุฑุจุฉ (ุณ) ุฅูุง ุฃูู ูู ูขููช (ุฌูุงู) ุฃู ุฃุนูู ูู ูจููช (ุบุฑู).", text: "ุงููุชุจุงููุฉ ุงูุชู ุชุตู ุงูุฑุทูุจุฉ \"ุฎุงุฑุฌ ุงููุทุงู\" ูู:", answer: "ุณ < ูขู ุฃู ุณ > ูจู", options: ["ูขู โค ุณ โค ูจู", "ุณ > ูขู", "ุณ < ูจู", "ุณ < ูขู ุฃู ุณ > ูจู"], explanation: "ุงููุชุจุงููุฉ ุชูุซู \"ุงุชุญุงุฏ\" (ุฃู) ูุฃู ุงูุฑุทูุจุฉ ูุง ูููู ุฃู ุชููู ูู ุงููุทุงููู ูุนุงู. ููู \"ุฃูู ูู ูขู\" (ูุง ุชุดูู ูขู) \"ุฃู\" \"ุฃุนูู ูู ูจู\" (ูุง ุชุดูู ูจู).", graph: { type: 'or', points: [{ v: 20, c: false }, { v: 80, c: false }] } }
            ]
        };
        // --- ููุงูุฉ ุจูู ุงูุฃุณุฆูุฉ ---

        // --- ูุชุบูุฑุงุช ุญุงูุฉ ุงููุนุจุฉ ---
        let currentQuestion = null;
        let selectedOption = null;
        let questionAnswered = false;
        let graphAnswered = false;
        let categoryTimerInterval = null;
        let categorySeconds = 0;
        let totalSeconds = 0;
        // let totalPoints = 0; // ุชู ุฅุฒุงูุชู
        let completedCategories = []; // ูุชุชุจุน ุงููุฆุงุช ุงูููุชููุฉ
        // --- NEW: ุชุชุจุน ุงูููุงุท ููู ูุฆุฉ ---
        let categoryPoints = {'egg': 0, 'tube': 0, 'rabbit': 0, 'temp': 0, 'drop': 0};
        // ูุชุชุจุน ุงูุฃุณุฆูุฉ ุงูุชู ุชู ุนุฑุถูุง ูู ูู ูุฆุฉ
        let shownQuestions = { 'egg': [], 'tube': [], 'rabbit': [], 'temp': [], 'drop': [] };
        // ูุชุชุจุน ุญุงูุฉ ุฎุท ุงูุฃุนุฏุงุฏ
        let numberLineState = {};
        // ูุชุชุจุน ุนุฏุงุฏ ุงูุนูุฏุฉ
        let backTimerInterval = null;
        let backTimerSeconds = 0;

        // --- 1. ุขููุฉ ุดุงุดุฉ ุงูุจุฏุงูุฉ ูุงูุชุญููู ---
        const backgroundUrl = 'https://ablan-math.github.io/img/g4/g442.png';
        
        function preloadBackground() {
            const img = new Image();
            img.src = backgroundUrl;
            img.onload = () => {
                // ุชุทุจูู ุงูุฎูููุฉ
                document.body.style.backgroundImage = `url(${backgroundUrl})`;
                // ุฅุธูุงุฑ ุงูุชุนูููุงุช ูุฒุฑ ุงูุจุฏุก
                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('welcome-content').style.display = 'block';
                document.getElementById('start-button').style.display = 'block';
            };
            img.onerror = () => {
                // ูู ุญุงู ูุดู ุชุญููู ุงูุฎูููุฉ
                document.body.style.backgroundColor = '#5a67d8'; // ููู ุงุญุชูุงุทู
                document.getElementById('loading-text').textContent = "ูุดู ุชุญููู ุงูุฎูููุฉ. ููููู ุงูุจุฏุก.";
                document.getElementById('welcome-content').style.display = 'block';
                document.getElementById('start-button').style.display = 'block';
            };
        }

        document.getElementById('start-button').addEventListener('click', () => {
            loadingScreen.style.display = 'none';
            gameContainer.style.display = 'block';
        });

        // --- 2. ุขููุฉ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ---
        function showMainScreen() {
            mainScreen.style.display = 'block';
            questionScreen.style.display = 'none';
            graphScreen.style.display = 'none';
            finishScreen.style.display = 'none';

            // ุชุญุฏูุซ ุนุฏุงุฏ ุงูููุช ุงูุฅุฌูุงูู (ูุชููู)
            stopTotalTimer();
            totalTimerDisplay.textContent = `ุงูููุช ุงูุฅุฌูุงูู: ${totalSeconds} ุซุงููุฉ`;

            // --- NEW: ุชุญุฏูุซ ุงูููุงุท ุงูุฅุฌูุงููุฉ ---
            const currentTotalPoints = Object.values(categoryPoints).reduce((a, b) => a + b, 0);
            document.getElementById('total-points-display').textContent = `ุงูููุงุท: ${currentTotalPoints} / ูกู`;

            // ุชุญุฏูุซ ุงูุฃููููุงุช ุงูููุชููุฉ
            document.querySelectorAll('.category-item').forEach(item => {
                const category = item.dataset.category;
                
                // --- NEW: ุฅุถุงูุฉ ุนุฑุถ ุงูููุงุท ---
                let scoreDisplay = item.querySelector('.category-score');
                if (!scoreDisplay) {
                    scoreDisplay = document.createElement('div');
                    scoreDisplay.className = 'category-score';
                    item.appendChild(scoreDisplay);
                }

                if (completedCategories.includes(category)) {
                    item.classList.add('completed');
                    // ุนุฑุถ ุงููุชูุฌุฉ ุงูุฎุงุตุฉ ุจุงูุฃููููุฉ
                    scoreDisplay.textContent = `${categoryPoints[category]} / ูข`;
                } else {
                    scoreDisplay.textContent = ''; // ุฅุฎูุงุก ุงูููุงุท ุฅุฐุง ูู ุชูุชูู
                }
            });

            // ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุฌููุน ุงูุฃุณุฆูุฉ ูุฏ ุงูุชููุช
            if (completedCategories.length === 5) {
                showFinishScreen();
            }
        }

        document.querySelectorAll('.category-item').forEach(item => {
            item.addEventListener('click', () => {
                const category = item.dataset.category;
                if (completedCategories.includes(category)) return;
                
                // ุงุฎุชูุงุฑ ุณุคุงู ุนุดูุงุฆู ูู ูุชู ุนุฑุถู ูู ูุจู
                let availableQuestions = questionBank[category].filter((_, index) => !shownQuestions[category].includes(index));
                if (availableQuestions.length === 0) {
                    // ุฅุฐุง ุชู ุนุฑุถ ุฌููุน ุงูุฃุณุฆูุฉุ ุฃุนุฏ ุชุนููู ุงููุงุฆูุฉ
                    shownQuestions[category] = [];
                    availableQuestions = questionBank[category];
                }
                const questionIndex = questionBank[category].indexOf(availableQuestions[Math.floor(Math.random() * availableQuestions.length)]);
                shownQuestions[category].push(questionIndex);
                
                currentQuestion = questionBank[category][questionIndex];
                currentQuestion.category = category; // ุญูุธ ุงููุฆุฉ ููุนูุฏุฉ
                loadQuestion(currentQuestion);
            });
        });

        // --- 3. ุขููุฉ ุงููุฑุญูุฉ ุงูุฃููู (ุงูุณุคุงู) ---
        function loadQuestion(question) {
            mainScreen.style.display = 'none';
            questionScreen.style.display = 'block';
            
            qWatermark.textContent = document.querySelector(`.category-item[data-category="${question.category}"]`).textContent;
            qContext.textContent = question.context;
            qText.textContent = question.text;
            
            optionsContainer.innerHTML = '';
            question.options.forEach((optionText, index) => {
                const optionButton = document.createElement('label');
                optionButton.className = 'option-button';
                optionButton.innerHTML = `
                    <input type="radio" name="option" value="${optionText}">
                    <span class="math-formula">${optionText}</span>
                `;
                optionButton.addEventListener('click', () => selectOption(optionButton, optionText));
                optionsContainer.appendChild(optionButton);
            });
            
            resetQuestionScreen();
            startTotalTimer(qTimerDisplay); // ุจุฏุก/ุงุณุชุฆูุงู ุงูุนุฏุงุฏ
        }
        
        function selectOption(button, optionText) {
            if (questionAnswered) return;
            
            selectedOption = optionText;
            document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            qNextButton.disabled = false;
            
            // --- ุชุนุฏูู: ุงูุฅุฌุงุจุฉ ุงูููุฑูุฉ ---
            checkQuestionAnswer();
        }

        function checkQuestionAnswer() {
            if (questionAnswered) return;
            questionAnswered = true;
            stopTotalTimer(); // ุฅููุงู ุงูุนุฏุงุฏ ุนูุฏ ุงูุฅุฌุงุจุฉ

            const isCorrect = (selectedOption === currentQuestion.answer);
            
            // ุชูููู ุงูุฃุฒุฑุงุฑ
            document.querySelectorAll('.option-button').forEach(btn => {
                const btnValue = btn.querySelector('input').value;
                btn.classList.add('disabled'); // ุชุนุทูู ุฌููุน ุงูุฃุฒุฑุงุฑ
                
                if (btnValue === currentQuestion.answer) {
                    btn.classList.add('correct'); // ุชูููู ุงูุตุญูุญ ุจุงูุฃุฎุถุฑ
                }
                if (btnValue === selectedOption && !isCorrect) {
                    btn.classList.add('incorrect'); // ุชูููู ุงููุฎุชุงุฑ ุงูุฎุทุฃ ุจุงูุฃุญูุฑ
                    btn.classList.remove('selected');
                }
            });
            
            // ุฅุธูุงุฑ ุงููุชูุฌุฉ ูุงููููุถ
            if (isCorrect) {
                qFeedbackBox.textContent = "ุฅุฌุงุจุฉ ุตุญูุญุฉ! ุฃุญุณูุช.";
                qFeedbackBox.className = 'feedback-box correct';
                // totalPoints += 1; // ุชู ุงูุชุบููุฑ
                categoryPoints[currentQuestion.category] += 1; // ุฅุถุงูุฉ ููุทุฉ ูููุฆุฉ
            } else {
                qFeedbackBox.textContent = "ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ.";
                qFeedbackBox.className = 'feedback-box incorrect';
                // ูููุถ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
                document.querySelector('.option-button.correct')?.classList.add('flash');
            }

            // ุฅุธูุงุฑ/ุฅุฎูุงุก ุนูุงุตุฑ ุงูุดุฑูุท ุงูุณููู
            qTimerDisplay.classList.add('hidden'); // ุฅุฎูุงุก ุงูุนุฏุงุฏ
            qFeedbackBox.style.display = 'block'; // ุฅุธูุงุฑ ุงููุชูุฌุฉ
            qExplainButton.classList.remove('invisible'); // ุฅุธูุงุฑ "ุงุนุฑู ููุงุฐุงุ"
            
            // ุจุฏุก ุนุฏุงุฏ "ุงูุชุงูู" (8 ุซูุงูู)
            startBackTimer(qNextButton, 8, loadGraphScreen);
        }

        function resetQuestionScreen() {
            questionAnswered = false;
            selectedOption = null;
            qNextButton.disabled = true;
            qNextButton.textContent = "ุงูุชุงูู";
            qExplainButton.classList.add('invisible');
            qFeedbackBox.style.display = 'none';
            qTimerDisplay.classList.remove('hidden'); // ุฅุธูุงุฑ ุงูุนุฏุงุฏ
            stopBackTimer(); // ุฅููุงู ุฃู ุนุฏุงุฏ ุณุงุจู
        }

        qNextButton.addEventListener('click', () => {
            if (questionAnswered) {
                stopBackTimer();
                loadGraphScreen();
            }
        });

        // --- 4. ุขููุฉ ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุฎุท ุงูุฃุนุฏุงุฏ) ---
        function loadGraphScreen() {
            questionScreen.style.display = 'none';
            graphScreen.style.display = 'block';
            
            gGraphAnswer.innerHTML = `ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: <span class="math-formula">${currentQuestion.answer}</span>`;
            
            // ุจูุงุก ุฎุท ุงูุฃุนุฏุงุฏ
            buildNumberLine();
            
            resetGraphScreen();
            startTotalTimer(gTimerDisplay); // ุจุฏุก/ุงุณุชุฆูุงู ุงูุนุฏุงุฏ
        }

        // ุฏุงูุฉ ุชุญููู ุงูุฃุฑูุงู
        function toArabicNumerals(numStr) {
            const arabicNumerals = ['ู', 'ูก', 'ูข', 'ูฃ', 'ูค', 'ูฅ', 'ูฆ', 'ูง', 'ูจ', 'ูฉ'];
            return String(numStr).replace(/[0-9]/g, (d) => arabicNumerals[d]).replace('.', ',');
        }

        function buildNumberLine() {
            gPointsContainer.innerHTML = '';
            numberLineState = {}; // ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ
            
            const points = currentQuestion.graph.points;
            
            points.forEach(point => {
                const pointValue = point.v;
                numberLineState[pointValue] = { state: 0, left: false, right: false }; // 0 = line, 1 = open, 2 = closed

                const pointEl = document.createElement('div');
                pointEl.className = 'number-line-point';
                pointEl.dataset.value = pointValue;
                
                pointEl.innerHTML = `
                    <div class="point-visual state-0">
                        <div class="point-line"></div>
                        <div class="point-circle hidden"></div>
                    </div>
                    <div class="arrow-controls">
                        <span class="arrow-control" data-dir="left">โจ</span>
                        <span class="arrow-control" data-dir="right">โฉ</span>
                    </div>
                    <div class="point-label">${toArabicNumerals(pointValue)}</div>
                    <div class="line-segment left"></div>
                    <div class="line-segment right"></div>
                `;
                
                // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
                pointEl.querySelector('.point-visual').addEventListener('click', () => togglePointState(pointValue));
                pointEl.querySelectorAll('.arrow-control').forEach(ctrl => {
                    ctrl.addEventListener('click', (e) => {
                        e.stopPropagation(); // ููุน ุงูููุฑ ุนูู ุงูููุทุฉ ููุณูุง
                        toggleArrowState(pointValue, ctrl.dataset.dir);
                    });
                });
                
                gPointsContainer.appendChild(pointEl);
            });
        }

        function togglePointState(value) {
            if (graphAnswered) return;
            const state = numberLineState[value];
            state.state = (state.state + 1) % 3; // 0 -> 1 -> 2 -> 0
            
            const visual = document.querySelector(`.number-line-point[data-value="${value}"] .point-visual`);
            const line = visual.querySelector('.point-line');
            const circle = visual.querySelector('.point-circle');
            
            visual.classList.remove('state-0', 'state-1', 'state-2');
            
            if (state.state === 0) { // ุฎุท
                visual.classList.add('state-0');
                line.classList.remove('hidden');
                circle.classList.add('hidden');
            } else if (state.state === 1) { // ููุชูุญุฉ
                visual.classList.add('state-1');
                line.classList.add('hidden');
                circle.classList.remove('hidden', 'closed');
            } else { // ูุบููุฉ
                visual.classList.add('state-2');
                line.classList.add('hidden');
                circle.classList.remove('hidden', 'closed');
                circle.classList.add('closed');
            }
        }

        function toggleArrowState(value, dir) {
            if (graphAnswered) return;
            const state = numberLineState[value];
            
            // ุชุจุฏูู ุงูุณูู ุงููุทููุจ
            state[dir] = !state[dir];
            // ุฅูุบุงุก ุงูุณูู ุงููุนุงูุณ
            if (state[dir]) {
                state[dir === 'left' ? 'right' : 'left'] = false;
            }
            
            // ุชุญุฏูุซ ุงููุงุฌูุฉ
            const pointEl = document.querySelector(`.number-line-point[data-value="${value}"]`);
            
            // ุชุญุฏูุซ ุงูุฃุณูู ุงูุทูููุฉ
            const leftSegment = pointEl.querySelector('.line-segment.left');
            const rightSegment = pointEl.querySelector('.line-segment.right');
            leftSegment.style.display = state.left ? 'block' : 'none';
            rightSegment.style.display = state.right ? 'block' : 'none';
            
            // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุชุญูู ุงูุตุบูุฑุฉ
            const leftCtrl = pointEl.querySelector('.arrow-control[data-dir="left"]');
            const rightCtrl = pointEl.querySelector('.arrow-control[data-dir="right"]');
            leftCtrl.classList.toggle('active', state.left);
            rightCtrl.classList.toggle('active', state.right);
        }

        gCheckButton.addEventListener('click', () => {
            if (graphAnswered) return;
            graphAnswered = true;
            stopTotalTimer(); // ุฅููุงู ุงูุนุฏุงุฏ ุนูุฏ ุงูุชุญูู

            const solution = currentQuestion.graph;
            let isCorrect = true;

            solution.points.forEach(point => {
                const userState = numberLineState[point.v];
                
                // 1. ุงูุชุญูู ูู ุงูุฏุงุฆุฑุฉ (ููุชูุญุฉ/ูุบููุฉ)
                const userCircleState = (userState.state === 1) ? false : (userState.state === 2) ? true : null;
                if (userCircleState !== point.c) {
                    isCorrect = false;
                }
                
                // 2. ุงูุชุญูู ูู ุงูุฃุณูู
                if (solution.type === 'or') {
                    if (point.v === solution.points[0].v && !userState.left) isCorrect = false; // ูุฌุจ ุฃู ูููู ุณูู ูุณุงุฑ ููููุทุฉ ุงูุฃููู
                    if (point.v === solution.points[1].v && !userState.right) isCorrect = false; // ูุฌุจ ุฃู ูููู ุณูู ูููู ููููุทุฉ ุงูุซุงููุฉ
                } else { // 'and'
                    // ูุง ูุญุชุงุฌ ุฃุณูู ููุชุฏุฉ ูููุงููุงูุฉ ูู "ูู"
                }
            });

            // ุญุงูุฉ "ูู" ุงูุฎุงุตุฉ (ุงูุฎุท ุจููููุง)
            if (solution.type === 'and') {
                const p1 = numberLineState[solution.points[0].v];
                const p2 = numberLineState[solution.points[1].v];
                // ูุฌุจ ุฃู ูููู ููุงู ุณูู ูููู ุนูุฏ ุงูููุทุฉ ุงูุฃููู ูุณูู ูุณุงุฑ ุนูุฏ ุงูููุทุฉ ุงูุซุงููุฉ
                if (!p1.right || !p2.left) {
                    isCorrect = false;
                }
            }
            
            if (isCorrect) {
                gFeedbackBox.textContent = "ุฑุณู ุจูุงูู ุตุญูุญ! ููุชุงุฒ.";
                gFeedbackBox.className = 'feedback-box correct';
                // totalPoints += 1; // ุชู ุงูุชุบููุฑ
                categoryPoints[currentQuestion.category] += 1; // ุฅุถุงูุฉ ููุทุฉ ูููุฆุฉ
            } else {
                gFeedbackBox.textContent = "ุงูุฑุณู ุบูุฑ ุฏููู.";
                gFeedbackBox.className = 'feedback-box incorrect';
            }
            
            // ุฅุธูุงุฑ ุงูุดุฑูุท ุงูุณููู
            gCheckButton.classList.add('hidden');
            gBottomBar.classList.remove('hidden');
            gFeedbackBox.style.display = 'block';
            gTimerDisplay.classList.add('hidden'); // ุฅุฎูุงุก ุงูุนุฏุงุฏ
            
            // ุจุฏุก ุนุฏุงุฏ ุงูุนูุฏุฉ ูููุงุฆูุฉ (8 ุซูุงูู)
            startBackTimer(gBackButton, 8, showMainScreen);
        });

        gExplainButton.addEventListener('click', () => {
            // --- ุชุนุฏูู: ุฅุธูุงุฑ ุงูุฑุณู ุงูุตุญูุญ ุจุฏูุงู ูู ุงูุดุฑุญ ---
            stopBackTimer(); // ุฅููุงู ุงูุนุฏุงุฏ ูุคูุชุงู
            showCorrectGraph();
            // ูุง ูุณุชุฃูู ุงูุนุฏุงุฏ ููุงุ ุจู ููุชุธุฑ ูู ุงููุณุชุฎุฏู
        });
        
        function showCorrectGraph() {
            graphAnswered = true; // ููุน ุงููุฒูุฏ ูู ุงูุชุนุฏูู
            const solution = currentQuestion.graph;
            
            solution.points.forEach(point => {
                const value = point.v;
                const state = numberLineState[value];
                
                // 1. ูุฑุถ ุญุงูุฉ ุงูุฏุงุฆุฑุฉ ุงูุตุญูุญุฉ
                const correctState = point.c ? 2 : 1; // 2=ูุบููุฉ, 1=ููุชูุญุฉ
                state.state = correctState;
                
                // ุชุญุฏูุซ ุงููุงุฌูุฉ ููุฏุงุฆุฑุฉ
                const visual = document.querySelector(`.number-line-point[data-value="${value}"] .point-visual`);
                const line = visual.querySelector('.point-line');
                const circle = visual.querySelector('.point-circle');
                
                visual.classList.remove('state-0', 'state-1', 'state-2');
                line.classList.add('hidden');
                circle.classList.remove('hidden', 'closed');
                
                if (correctState === 1) { // ููุชูุญุฉ
                    visual.classList.add('state-1');
                } else { // ูุบููุฉ
                    visual.classList.add('state-2');
                    circle.classList.add('closed');
                }
                
                // 2. ูุฑุถ ุญุงูุฉ ุงูุฃุณูู ุงูุตุญูุญุฉ
                state.left = false;
                state.right = false;
                if (solution.type === 'or') {
                    if (value === solution.points[0].v) state.left = true; // ุณูู ูุณุงุฑ ููุฃููู
                    if (value === solution.points[1].v) state.right = true; // ุณูู ูููู ููุซุงููุฉ
                } else if (solution.type === 'and') {
                    if (value === solution.points[0].v) state.right = true; // ุณูู ูููู ููุฃููู
                    if (value === solution.points[1].v) state.left = true; // ุณูู ูุณุงุฑ ููุซุงููุฉ
                }
                
                // ุชุญุฏูุซ ุงููุงุฌูุฉ ููุฃุณูู
                const pointEl = document.querySelector(`.number-line-point[data-value="${value}"]`);
                pointEl.querySelector('.line-segment.left').style.display = state.left ? 'block' : 'none';
                pointEl.querySelector('.line-segment.right').style.display = state.right ? 'block' : 'none';
                pointEl.querySelector('.arrow-control[data-dir="left"]').classList.toggle('active', state.left);
                pointEl.querySelector('.arrow-control[data-dir="right"]').classList.toggle('active', state.right);
            });
        }


        gBackButton.addEventListener('click', () => {
            stopBackTimer();
            completedCategories.push(currentQuestion.category);
            showMainScreen();
        });

        function resetGraphScreen() {
            graphAnswered = false;
            gCheckButton.classList.remove('hidden');
            gBottomBar.classList.add('hidden');
            gFeedbackBox.style.display = 'none';
            gTimerDisplay.classList.remove('hidden'); // ุฅุธูุงุฑ ุงูุนุฏุงุฏ
            stopBackTimer();
        }
        
        // --- 5. ุขููุฉ ุดุงุดุฉ ุงูููุงูุฉ ---
        function showFinishScreen() {
            mainScreen.style.display = 'none';
            questionScreen.style.display = 'none';
            graphScreen.style.display = 'none';
            finishScreen.style.display = 'block';

            // --- NEW: ุญุณุงุจ ุงูููุงุท ุงูููุงุฆูุฉ ---
            const finalTotalPoints = Object.values(categoryPoints).reduce((a, b) => a + b, 0);

            // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุญูุธ ูุฅุธูุงุฑ ุณุฌู ุงูุฃุจุทุงู
            saveAndFinishGame(finalTotalPoints, totalSeconds);
        }

        // --- 6. ุขููุฉ ุงููุงูุฐุฉ ุงูููุจุซูุฉ (Modal) ---
        function showModal(explanation) {
            stopBackTimer(); // ุฅููุงู ุนุฏุงุฏ ุงูุนูุฏุฉ
            stopTotalTimer(); // ุฅููุงู ุนุฏุงุฏ ุงูููุช
            modalExplanation.textContent = explanation;
            modalBackdrop.style.display = 'block';
            modal.style.display = 'block';
        }

        function closeModal() {
            modalBackdrop.style.display = 'none';
            modal.style.display = 'none';
            // ุงุณุชุฆูุงู ุงูุนุฏุงุฏุงุช
            if (questionScreen.style.display === 'block') {
                startBackTimer(qNextButton, 8, loadGraphScreen); // ุงุณุชุฆูุงู ุนุฏุงุฏ "ุงูุชุงูู"
                startTotalTimer(qTimerDisplay); // ุงุณุชุฆูุงู ุนุฏุงุฏ ุงูููุช
            }
        }

        modalBackdrop.addEventListener('click', closeModal);
        modalClose.addEventListener('click', closeModal);
        qExplainButton.addEventListener('click', () => showModal(currentQuestion.explanation));

        // --- 7. ุขููุฉ ุนุฏุงุฏ ุงูููุช ---
        function startTotalTimer(displayElement) {
            // ุฅุธูุงุฑ ุงูุนุฏุงุฏ ูุจุฏุก ุงูุนุฏ
            displayElement.classList.remove('hidden');
            categorySeconds = 0; // ุฅุนุงุฏุฉ ุชุนููู ุนุฏุงุฏ ุงููุฑุญูุฉ
            updateTimerDisplay(displayElement, categorySeconds);

            if (categoryTimerInterval) clearInterval(categoryTimerInterval);
            categoryTimerInterval = setInterval(() => {
                categorySeconds++;
                totalSeconds++;
                updateTimerDisplay(displayElement, categorySeconds);
                // ุชุญุฏูุซ ุงูุนุฏุงุฏ ุงูุฅุฌูุงูู (ุงููุชููู) ูู ุงูุฎูููุฉ
                totalTimerDisplay.textContent = `ุงูููุช ุงูุฅุฌูุงูู: ${totalSeconds} ุซุงููุฉ`;
            }, 1000);
        }

        function stopTotalTimer() {
            clearInterval(categoryTimerInterval);
            categoryTimerInterval = null;
        }

        function updateTimerDisplay(element, seconds) {
            element.textContent = `ุงูููุช: ${seconds} ุซ`;
        }

        // --- 8. ุขููุฉ ุนุฏุงุฏ ุงูุนูุฏุฉ ุงูุชููุงุฆู ---
        function startBackTimer(button, seconds, callback) {
            stopBackTimer(); // ุฅููุงู ุฃู ุนุฏุงุฏ ุณุงุจู
            backTimerSeconds = seconds;
            
            const updateTimer = () => {
                button.textContent = `${button.id === 'g-back-button' ? 'ุงูุนูุฏุฉ' : 'ุงูุชุงูู'} (${backTimerSeconds})`;
                backTimerSeconds--;
                if (backTimerSeconds < 0) {
                    stopBackTimer();
                    callback(); // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ (ุงูุงูุชูุงู ุฃู ุงูุนูุฏุฉ)
                }
            };
            
            updateTimer(); // ุงูุชุญุฏูุซ ุงูููุฑู
            backTimerInterval = setInterval(updateTimer, 1000);
        }

        function stopBackTimer() {
            clearInterval(backTimerInterval);
            backTimerInterval = null;
        }
        
        // --- ุจุฏุก ุชุญููู ุงูุฎูููุฉ ---
        preloadBackground();

        document.getElementById('start-button').addEventListener('click', () => {
            loadingScreen.style.display = 'none';
            gameContainer.classList.remove('hidden'); // <-- ูุฐุง ูู ุงูุฅุตูุงุญ
        });

        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
        (function() {
            // --- CONFIGURATION (ุนุฏูู ูุฐู ุงูุฅุนุฏุงุฏุงุช ููู ูุนุจุฉ) ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const GAME_ID = 'g4_4_2'; // ุชู ุงูุชุญุฏูุซ ุฅูู g4_4_2
            const GAME_MAX_POINTS = 10; // 5 ุฃุณุฆูุฉ * (1 ููุทุฉ ููุงุฎุชูุงุฑ + 1 ููุทุฉ ููุฑุณู) = 10
            const PLATFORM_MAX_GRADE = 5;                   // ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ ูู ุงูููุตุฉ
            const METRIC_TYPE = 'time';                     // ููุน ุงููุนูุงุฑ: 'time'
            const METRIC_LABEL = 'ุงูููุช (ุซูุงูู)';           // ุงุณู ุงููุนูุงุฑ ููุนุฑุถ ูู ุงูุฌุฏูู

            // --- Read URL Parameters ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const classId = urlParams.get('classId');
            const studentName = urlParams.get('studentName');

            let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

            // --- CORE FUNCTIONS ---

            // 1. ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ุงูุชู ุชุณุชุฏุนููุง ุนูุฏ ุงูุชูุงุก ุงููุนุจุฉ
            window.saveAndFinishGame = function(points, metricValue) {
                const finalPoints = parseFloat(points) || 0;
                const finalMetric = parseFloat(metricValue) || 0;
                const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
                const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

                const resultDisplay = document.getElementById('final-result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">ุงูููุงุท: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                        <p class="text-blue-600">ุงูุฏุฑุฌุฉ ูู ุงูููุตุฉ: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                    `;
                }

                if (studentId && classId) {
                    const params = new URLSearchParams({
                        action: 'saveGrade',
                        studentId: studentId,
                        classId: classId,
                        itemId: GAME_ID,
                        grade: finalGrade.toFixed(2),
                        metricValue: Math.round(finalMetric).toString()
                    });
                    fetch(`${SCRIPT_URL}?${params.toString()}`)
                        .then(res => res.json())
                        .then(result => console.log('Save result:', result.status))
                        .catch(err => console.error("Save Error:", err))
                        .finally(fetchAndShowLeaderboard);
                } else {
                    console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                    fetchAndShowLeaderboard();
                }
            }

            // 2. ุฏุงูุฉ ุฌูุจ ูุนุฑุถ ุณุฌู ุงูุฃุจุทุงู
            function fetchAndShowLeaderboard() {
                const loader = document.getElementById('leaderboard-loader');
                const container = document.getElementById('leaderboard-container');
                if (!loader || !container) return;
                
                if (!classId) {
                    console.log("No classId found, skipping leaderboard for visitor.");
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">ุณุฌู ุงูุฃุจุทุงู ูุชุงุญ ููุทูุงุจ ุงููุณุฌููู ููุท.</p>`;
                    showFinishButton();
                    return;
                }

                loader.style.display = 'block';
                container.innerHTML = '';

                const params = new URLSearchParams({
                    action: 'getLeaderboard',
                    gameId: GAME_ID,
                    metricType: METRIC_TYPE,
                    classId: classId
                });

                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            displayLeaderboard(response.data);
                        } else {
                            throw new Error(response.message || 'Failed to load leaderboard data.');
                        }
                    })
                    .catch(err => {
                        console.error("Leaderboard Error:", err);
                        container.innerHTML = `<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุณุฌู ุงูุฃุจุทุงู.</p>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                        showFinishButton();
                    });
            }
            
            // 3. ุฏุงูุฉ ุจูุงุก ุฌุฏูู ุณุฌู ุงูุฃุจุทุงู
            function displayLeaderboard(data) {
                const container = document.getElementById('leaderboard-container');
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ. ูู ุฃูู ุงูุฃุจุทุงู!</p>`;
                    return;
                }

                let tableHTML = `
                    <div class="mt-6 border-t pt-4">
                        <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">๐ ุณุฌู ุงูุฃุจุทุงู ๐</h3>
                        <table class="min-w-full bg-white shadow-md rounded-lg">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="text-center py-2 px-3">ุงูุชุฑุชูุจ</th>
                                    <th class="text-right py-2 px-3">ุงุณู ุงูุทุงูุจ</th>
                                    <th class="text-center py-2 px-3">ุงูุฏุฑุฌุฉ</th>
                                    <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;

                data.forEach((player, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = '๐ฅ';
                    if (rank === 2) rankDisplay = '๐ฅ';
                    if (rank === 3) rankDisplay = '๐ฅ';

                    const isCurrentUser = (currentUser && player.name === currentUser.name);
                    const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                            <td class="text-right py-2 px-3">${player.name}</td>
                            <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                            <td class="text-center py-2 px-3">${player.metricValue}</td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            // 4. ุฅุธูุงุฑ ุฒุฑ ุงูุฅููุงุก
            function showFinishButton() {
                const finishWrapper = document.getElementById('finish-game-wrapper');
                if (finishWrapper) {
                    finishWrapper.style.display = 'block';
                }
            }

            // 5. ุงูุชุนุงูู ูุน ุฒุฑ ุงูุฅููุงุก ูุชุฎุตูุต ุฑุณุงูุฉ ุงูุชุฑุญูุจ
            document.addEventListener('DOMContentLoaded', () => {
                // Personalize welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (studentName && welcomeMessage) {
                    welcomeMessage.innerHTML = `ุฃููุงู ุจู ูุง <span class="font-bold text-yellow-300">${studentName}</span>! ูู "ูุชุจุงููุฉ ุงูุทุจูุนุฉ". ูููุชู ูู ูุณุงุนุฏุฉ ุงูุนููุงุก ูู ุชุฌุงุฑุจูู ุนู ุทุฑูู ุญู 5 ุชุญุฏูุงุช. ูู ุชุญุฏู ูุชููู ูู ูุฑุญูุชูู: ุงุฎุชูุงุฑ ุงููุชุจุงููุฉ ุงูุตุญูุญุฉุ ุซู ุชูุซูููุง ุนูู ุฎุท ุงูุฃุนุฏุงุฏ.`;
                }

                const finishBtn = document.getElementById('finish-game-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', () => {
                        window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                    });
                }
            });
        })();
        // --- END OF CONNECTION & LEADERBOARD ENGINE ---

    </script>
</body>
</html>

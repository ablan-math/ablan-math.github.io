<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 
        MASTER TEMPLATE VERSION 5.1 (TEST READY)
        - Updated LESSON_KEY to 'c6_l3' for testing purposes.
        - All logic (Smart Ordering, 4-Options, Vertical Explanation) is active.
    -->
    <title>{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§}</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        const themeColor = {
            gradient: 'from-blue-600 to-blue-800', 
            icon: 'fa-book-open', 
            text: 'text-blue-600',
            bg: 'bg-blue-50',
            hex: '#2563eb',
            chapterNum: '{#}' 
        };
    </script>

    <style>
        /* CORE STYLES */
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .math-eq { 
            font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; 
            border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; 
            direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; 
        }
        @media (min-width: 768px) { .math-eq { font-size: 1.1em; padding: 4px 12px; } }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item span { margin-top: 2px; text-align: center; line-height: 1.1; max-width: 60px; }
        .nav-item.active { color: #2563eb; font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: #2563eb; border-radius: 4px 4px 0 0; }
        @media (min-width: 768px) { .nav-item { font-size: 0.8rem; } .nav-item svg, .nav-item i { font-size: 1.4rem; margin-bottom: 4px; } .nav-item span { max-width: none; } }
        
        .step-box { border-right: 3px solid #2563eb; background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } .step-interactive.active { display: block; opacity: 1; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #eff6ff; color: #2563eb; font-weight: bold; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        
        .result-card-base { position: relative; overflow: hidden; padding: 1.5rem !important; transition: all 0.3s ease; }
        .result-card-trophy { background-color: #fffbeb; border-color: #fcd34d; } 
        .result-card-star { background-color: #fff7ed; border-color: #fdba74; } 
        .result-card-retry { background-color: #fef2f2; border-color: #fca5a5; } 
        
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #2563eb; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 80px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }
        
        /* Explanation Styles */
        .v-step { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
        .v-arrow { color: #9ca3af; margin: 4px 0; font-size: 1.2rem; }

        /* Game Modal */
        #game-modal-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #game-modal-content { background: white; width: 90%; height: 85%; max-width: 1200px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; }
        #game-modal-content.fullscreen { width: 100%; height: 100%; border-radius: 0; max-width: none; }
        #game-modal-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #game-frame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #f3f4f6; }
        #minimized-game-bar { display: none; position: fixed; bottom: 80px; left: 20px; background: white; border: 2px solid; border-radius: 50px; padding: 8px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9998; cursor: pointer; align-items: center; gap: 10px; font-weight: bold; transition: transform 0.2s; animation: slideInUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <script>
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                const name = params.get('name');
                if (name) { window.__studentName = name; }
            } catch(e) { console.error("Identity Error", e); }
        })();
    </script>

    <!-- Header -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative bg-gradient-to-r from-blue-600 to-blue-800">
        <!-- [VISUAL FIX] Background Pattern with increased visibility and spread -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <i id="header-bg-icon" class="fas fa-book-open absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <span id="chapter-num-bg" class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">{#}</span>
            
            <!-- Mathematical Symbols (Distributed & Visible) -->
            <i class="fas fa-plus absolute top-4 left-[20%] text-xl text-white opacity-10 transform rotate-12"></i>
            <i class="fas fa-minus absolute bottom-4 right-[30%] text-2xl text-white opacity-10 transform -rotate-6"></i>
            <i class="fas fa-times absolute top-8 right-12 text-lg text-white opacity-10"></i>
            <i class="fas fa-divide absolute bottom-6 left-8 text-xl text-white opacity-10 transform rotate-45"></i>
            <i class="fas fa-superscript absolute top-1/2 left-1/2 text-sm text-white opacity-10"></i>
        </div>
        
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas fa-book-open text-lg md:text-2xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">{Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³}</span>
                        <span>{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³}</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> 
                    <span id="student-name">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ</span>
                    <script>if(window.__studentName) document.getElementById('student-name').textContent = window.__studentName;</script>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>Ø±Ø¬ÙˆØ¹</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- Tab 1 -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4"><span class="bg-blue-100 text-blue-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-blue-200 shadow-sm">Ù¡</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„}</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden group hover:shadow-md transition">
                <div class="absolute top-0 right-0 w-1 h-full bg-blue-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">{Ø´Ø±Ø­ Ù…Ø®ØªØµØ± Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©}</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 mb-2 border border-blue-100 shadow-inner">
                    <span class="math-eq text-xl">{Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©}</span>
                </div>
            </div>
            
            <div id="interactive-container-1-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-blue-800 text-sm md:text-lg">ØªØ·Ø¨ÙŠÙ‚ Ù¡: {Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ}</h3>
                    <span class="text-[10px] md:text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold">ØªÙØ§Ø¹Ù„ÙŠ</span>
                </div>
                <div class="min-h-[110px] mb-4 bg-gray-50 rounded-lg p-2 md:p-4">
                    <div class="interactive-placeholder text-center text-gray-400 py-6 text-sm md:text-base">Ø§Ø¶ØºØ· "Ø§Ù„ØªØ§Ù„ÙŠ" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©</div>
                    <div class="step-interactive step-box"><h4 class="font-bold text-xs md:text-sm text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¡</h4><p class="text-sm md:text-lg text-center">{Ø®Ø·ÙˆØ©}</p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4 class="font-bold text-xs md:text-sm text-green-600 mb-1">Ø§Ù„Ù†Ø§ØªØ¬</h4><p class="text-sm md:text-lg font-bold text-center"><span class="math-eq">{Ø§Ù„Ù†Ø§ØªØ¬}</span></p></div>
                </div>
                <div class="flex justify-between">
                    <button class="prev-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button class="next-btn px-6 py-1.5 bg-blue-600 text-white rounded-lg font-bold shadow-md">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="reset-btn px-6 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold hidden">Ø¥Ø¹Ø§Ø¯Ø©</button>
                </div>
            </div>
            <button onclick="switchTab('learn2')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: {Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ}</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Tab 2 -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4"><span class="bg-purple-100 text-purple-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-purple-200 shadow-sm">Ù¢</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ}</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-purple-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">{Ø´Ø±Ø­ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ}</p>
            </div>
            <button onclick="switchTab('learn3')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: {Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«}</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Tab 3 -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4"><span class="bg-teal-100 text-teal-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-teal-200 shadow-sm">Ù£</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«}</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-teal-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">{Ø´Ø±Ø­ Ø§Ù„Ù…ÙÙ‡ÙˆÙ…}</p>
            </div>
            <button onclick="switchTab('learn4')" class="w-full bg-gray-800 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-lg shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>Ø§Ù„ØªØ§Ù„ÙŠ: {Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹}</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- Tab 4 -->
        <div id="tab-learn4" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4"><span class="bg-red-100 text-red-700 w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg md:text-xl border border-red-200 shadow-sm">Ù¤</span><h2 class="font-bold text-xl md:text-2xl text-gray-800">{Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹}</h2></div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-red-500"></div>
                <p class="text-gray-600 text-sm md:text-lg mb-3">{Ø´Ø±Ø­ Ø§Ù„Ù…ÙÙ‡ÙˆÙ…}</p>
            </div>
            <div class="mt-4 text-center"><button onclick="switchTab('quiz')" class="bg-green-600 text-white px-8 py-3 md:py-4 rounded-full text-sm md:text-lg font-bold shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2 mx-auto w-full max-w-xs animate-bounce"><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</span><i data-lucide="arrow-left"></i></button></div>
        </div>

        <!-- Quiz Tab -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…</h2><p class="text-xs md:text-sm text-gray-500">5 Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØªØ§Ø±Ø© Ø¨Ø¯Ù‚Ø© (ØªØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…)</p></div>
                    <div class="text-center"><div id="loading-attempts" class="hidden"><div class="loader w-4 h-4"></div></div><div id="attempts-display" class="flex flex-col items-center"><span class="block text-xl md:text-2xl font-bold text-purple-600" id="attempts-count">-</span><div class="flex items-center gap-1 text-[10px] md:text-xs text-gray-400"><span>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span></div><span id="sync-status" class="w-2 h-2 rounded-full bg-gray-300 mt-1" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„"></span></div><div id="timer-top-container" class="hidden mt-1"><span class="block text-xs font-bold text-red-500 font-mono" id="timer-display-top">00:00:00</span></div></div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto">
                    <div class="result-content"><p class="text-sm text-gray-600 font-bold mb-1">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p><p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p><div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div><div class="mt-4"><div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block"><span class="block text-lg font-bold text-red-600 font-mono tracking-wider" id="timer-display-bottom">00:00:00</span></div></div></div>
                </div>
                
                <!-- Games Wrapper -->
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <h2 id="games-title" class="col-span-1 md:col-span-2 text-center font-black text-gray-700 mb-2 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> Ø§Ø³ØªÙ…ØªØ¹ ÙˆØªØ¹Ù„Ù…</h2>
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"></div>
                </div>
            </div>
        </div>
        
        <footer class="lesson-footer"><p>ØªØµÙ…ÙŠÙ… ÙˆØ¥Ø¹Ø¯Ø§Ø¯: <strong>Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</strong></p><p class="mt-1 opacity-70">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</p></footer>
        <div class="h-20"></div>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 transform transition-transform duration-300 shadow-2xl"><div class="flex justify-between mb-4 items-center"><div class="flex items-center gap-2" style="color: var(--theme-hex)"><i id="modal-icon" data-lucide="info" class="w-5 h-5"></i><h3 id="modal-title" class="font-bold text-lg">ØªÙˆØ¶ÙŠØ­</h3></div><button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div></div></div>

    <!-- Game Modal Structure -->
    <div id="game-modal-container">
        <div id="game-modal-content">
            <div id="game-modal-header" class="bg-gradient-to-r from-blue-600 to-blue-800">
                <div class="flex items-center gap-2"><i class="fas fa-gamepad"></i><span id="game-modal-title" class="font-bold"></span></div>
                <div class="flex items-center gap-2"><button onclick="minimizeGameModal()" class="p-1 hover:bg-white/20 rounded" title="ØªØµØºÙŠØ±"><i class="fas fa-minus"></i></button><button onclick="toggleGameFullscreen()" class="p-1 hover:bg-white/20 rounded" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©"><i class="fas fa-expand"></i></button><button onclick="closeGameModal()" class="p-1 hover:bg-red-500 rounded" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button></div>
            </div>
            <iframe id="game-frame" src=""></iframe>
        </div>
    </div>
    <div id="minimized-game-bar" onclick="restoreGameModal()" class="border-blue-600 text-blue-600"><i class="fas fa-gamepad"></i><span id="minimized-game-title">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ©...</span><i class="fas fa-chevron-up"></i></div>

    <script>
        // --- 1. GLOBAL VARIABLES & CONFIGURATION ---
        
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 

        const LESSON_KEY = 'c6_l3'; // <-- Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„ÙƒÙ„ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ (Ù†Ù…Ø·: cX_lY)
        
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY;
        const NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0; 
        let currentQuestions = [];
        let timerInterval;

        const tabs = [
            { id: 'learn1', icon: 'book', label: '{Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ù¡}' },
            { id: 'learn2', icon: 'layers', label: '{Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ù¢}' },
            { id: 'learn3', icon: 'target', label: '{Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ù£}' },
            { id: 'learn4', icon: 'star', label: '{Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ù¤}' },
            { id: 'quiz', icon: 'clipboard-check', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' }
        ];

        const typeLabels = { 
            'learn1': 'Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„', 'learn2': 'Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ', 'learn3': 'Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«', 'learn4': 'Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹', 'mixed': 'ØªØ­Ø¯ÙŠ / Ø´Ø§Ù…Ù„' 
        };

        // [AI_INSTRUCTION: QUESTION BANK]
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ù†ÙˆØ¹ (learn1, learn2, ...) Ø¹Ù„Ù‰ 3 Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©.
        // ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„Ù‰ 4 Ø®ÙŠØ§Ø±Ø§Øª (a, b, c, d).
        // Ø§Ù„Ø´Ø±Ø­ (e) ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ØªÙ†Ø³ÙŠÙ‚ HTML Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (step-box).
        const questionBank = [
             // --- CONCEPT 1 VARIANTS ---
             { 
                 id: 101, type: 'learn1', 
                 t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ - Ù†Ù…ÙˆØ°Ø¬ Ø£}', 
                 o: [{t:'{Ø®ÙŠØ§Ø± 1}', v:'a'}, {t:'{Ø®ÙŠØ§Ø± 2}', v:'b'}, {t:'{Ø®ÙŠØ§Ø± 3}', v:'c'}, {t:'{Ø®ÙŠØ§Ø± 4}', v:'d'}], 
                 c: 'a', 
                 e: '<div class="step-box"><h4 class="font-bold text-xs text-blue-600 mb-1">Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4><div class="v-step"><p class="text-sm">Ø´Ø±Ø­ Ø§Ù„Ø®Ø·ÙˆØ©...</p><i class="fas fa-arrow-down v-arrow"></i><p class="text-sm font-bold">Ø§Ù„Ù†ØªÙŠØ¬Ø©...</p></div></div>', 
                 smart: 'ØªÙ„Ù…ÙŠØ­ Ø°ÙƒÙŠ...' 
             },
             { id: 102, type: 'learn1', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ - Ù†Ù…ÙˆØ°Ø¬ Ø¨}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'b', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 103, type: 'learn1', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ - Ù†Ù…ÙˆØ°Ø¬ Ø¬}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'c', e: '<div class="step-box">...</div>', smart: '...' },

             // --- CONCEPT 2 VARIANTS ---
             { id: 201, type: 'learn2', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø£}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'a', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 202, type: 'learn2', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø¨}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'b', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 203, type: 'learn2', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø¬}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'c', e: '<div class="step-box">...</div>', smart: '...' },

             // --- CONCEPT 3 VARIANTS ---
             { id: 301, type: 'learn3', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø« - Ù†Ù…ÙˆØ°Ø¬ Ø£}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'a', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 302, type: 'learn3', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø« - Ù†Ù…ÙˆØ°Ø¬ Ø¨}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'b', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 303, type: 'learn3', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø« - Ù†Ù…ÙˆØ°Ø¬ Ø¬}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'c', e: '<div class="step-box">...</div>', smart: '...' },

             // --- CONCEPT 4 VARIANTS ---
             { id: 401, type: 'learn4', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹ - Ù†Ù…ÙˆØ°Ø¬ Ø£}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'a', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 402, type: 'learn4', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹ - Ù†Ù…ÙˆØ°Ø¬ Ø¨}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'b', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 403, type: 'learn4', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø±Ø§Ø¨Ø¹ - Ù†Ù…ÙˆØ°Ø¬ Ø¬}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'c', e: '<div class="step-box">...</div>', smart: '...' },

             // --- MIXED/CHALLENGE VARIANTS ---
             { id: 501, type: 'mixed', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø£}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'a', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 502, type: 'mixed', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø¨}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'b', e: '<div class="step-box">...</div>', smart: '...' },
             { id: 503, type: 'mixed', t: '{Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ - Ù†Ù…ÙˆØ°Ø¬ Ø¬}', o: [{t:'A', v:'a'}, {t:'B', v:'b'}, {t:'C', v:'c'}, {t:'D', v:'d'}], c: 'c', e: '<div class="step-box">...</div>', smart: '...' }
        ];

        // --- CORE FUNCTIONS ---
        const urlParams = new URLSearchParams(window.location.search);
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabId}`);
            const navEl = document.getElementById(`nav-${tabId}`);
            if (tabEl) tabEl.classList.remove('hidden');
            if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') {
                if(document.getElementById('quizForm').innerHTML === '') { generateQuiz(); }
                renderDynamicGames(); 
                const sId = urlParams.get('studentId');
                if(sId && sId !== 'visitor') fetchStudentData();
            }
        }

        // --- GAME MODAL LOGIC ---
        function openGameModal(url, title) {
            const modal = document.getElementById('game-modal-container');
            const iframe = document.getElementById('game-frame');
            iframe.src = url;
            document.getElementById('game-modal-title').textContent = title || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            modal.style.display = 'flex';
            document.getElementById('minimized-game-bar').style.display = 'none';
        }
        function closeGameModal() { document.getElementById('game-modal-container').style.display = 'none'; document.getElementById('game-frame').src = ''; }
        function toggleGameFullscreen() { document.getElementById('game-modal-content').classList.toggle('fullscreen'); }
        function minimizeGameModal() { document.getElementById('game-modal-container').style.display = 'none'; document.getElementById('minimized-game-bar').style.display = 'flex'; }
        function restoreGameModal() { document.getElementById('game-modal-container').style.display = 'flex'; document.getElementById('minimized-game-bar').style.display = 'none'; }

        // --- INTERACTIVE APPS LOGIC ---
        function initInteractive() {
            document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive');
                const placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                const prevBtn = container.querySelector('.prev-btn');
                const resetBtn = container.querySelector('.reset-btn');
                let current = -1;
                const update = () => {
                    if(!prevBtn) return;
                    prevBtn.disabled = current === -1;
                    if (current === -1) placeholder.classList.remove('hidden'); else placeholder.classList.add('hidden');
                    steps.forEach((s, i) => { if (i <= current) s.classList.add('active'); else s.classList.remove('active'); });
                    if (current >= steps.length - 1) { nextBtn.classList.add('hidden'); resetBtn.classList.remove('hidden'); } 
                    else { nextBtn.classList.remove('hidden'); resetBtn.classList.add('hidden'); }
                };
                if(nextBtn) nextBtn.onclick = () => { if(current < steps.length - 1) { current++; update(); } };
                if(prevBtn) prevBtn.onclick = () => { if(current > -1) { current--; update(); } };
                if(resetBtn) resetBtn.onclick = () => { current = -1; update(); };
                update();
            });
        }
        
        async function saveScoreToBackend(lessonId, grade) {
            const sId = urlParams.get('studentId');
            const cId = urlParams.get('classId');
            const saveStatus = document.getElementById('save-status');
            if (!sId || !cId) { if(saveStatus) saveStatus.innerHTML = '<span class="text-yellow-600">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø²Ø§Ø¦Ø±)</span>'; return; }
            if(saveStatus) saveStatus.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©...</span>';
            const requestUrl = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            
            let success = false;
            for(let i=0; i<3; i++) {
                try { 
                    await fetch(requestUrl); 
                    success = true; 
                    break;
                } catch (error) { await new Promise(r => setTimeout(r, 1500)); } 
            }
            if(success) {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-green-600 font-bold">âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­!</span>';
                setTimeout(() => fetchStudentData(), 1000); 
            } else {
                if(saveStatus) saveStatus.innerHTML = '<span class="text-red-600 font-bold">âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….</span>';
            }
        }
        
        async function fetchStudentData() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') return;
            document.getElementById('loading-attempts').classList.remove('hidden');
            document.getElementById('attempts-display').classList.add('hidden');
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url);
                const json = await response.json();
                if (json.status === "success" && json.data) {
                    let d = json.data.lessons && json.data.lessons[LESSON_KEY] ? json.data.lessons[LESSON_KEY] : { attempts: 0, grade: 0 };
                    attemptsLeft = Math.max(0, 3 - (d.attempts || 0));
                    if (attemptsLeft === 0 && d.waitTime > 0) {
                        startTimer(Date.now() + d.waitTime); 
                    }
                    if (d.grade > 0) { document.getElementById('student-score').textContent = d.grade; document.getElementById('header-score-badge').classList.remove('hidden'); }
                    if (json.data.name) document.getElementById('student-name').textContent = json.data.name;
                }
            } catch (e) { console.error(e); } finally { updateAttemptsUI(); document.getElementById('loading-attempts').classList.add('hidden'); document.getElementById('attempts-display').classList.remove('hidden'); }
        }

        function initAttempts() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') { 
                const visitorAttempts = localStorage.getItem(ATTEMPTS_KEY + '_visitor');
                if (visitorAttempts !== null) {
                    attemptsLeft = parseInt(visitorAttempts);
                } else {
                    attemptsLeft = 1; // Default for new visitor
                }
                const nextAttempt = localStorage.getItem(NEXT_ATTEMPT_KEY + '_visitor');
                if (nextAttempt && parseInt(nextAttempt) > Date.now()) {
                    startTimer(parseInt(nextAttempt));
                    attemptsLeft = 0;
                }
                updateAttemptsUI(); 
            } 
            else { 
                attemptsLeft = 0; // Default until fetch
                updateAttemptsUI(); 
                fetchStudentData(); 
            }
        }
        
        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count');
            if(countEl) countEl.textContent = convertToArabic(attemptsLeft);
            
            const btn = document.getElementById('quiz-action-btn');
            if (!btn) return;

            const resultsVisible = !document.getElementById('quiz-results').classList.contains('hidden');

            if (resultsVisible) {
                if (attemptsLeft > 0) {
                    btn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±";
                    btn.disabled = false;
                    btn.type = "button"; 
                    btn.onclick = resetQuizView; 
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    btn.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª";
                    btn.disabled = true;
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            } else {
                btn.onclick = null; 
                if (attemptsLeft > 0) {
                    btn.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª";
                    btn.disabled = false;
                    btn.type = "submit"; 
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    btn.textContent = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø³ØªÙ†ÙØ°Ø©";
                    btn.disabled = true;
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            }
        }

        function startTimer(target) {
             clearInterval(timerInterval);
             document.getElementById('timer-bottom-container').classList.remove('hidden'); 
             timerInterval = setInterval(() => {
                const diff = target - Date.now();
                if (diff <= 0) { clearInterval(timerInterval); location.reload(); return; } 
                const t = new Date(diff).toISOString().substr(11, 8).replace(/\d/g, d=>"Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
                document.getElementById('timer-display-top').textContent = t; 
                document.getElementById('timer-display-top').parentElement.classList.remove('hidden');
                document.getElementById('timer-display-bottom').textContent = t;
             }, 1000);
        }

        // [GENIUS: Smart Ordering Algorithm]
        function generateQuiz() { 
            currentQuestions = [];
            // Order: Concept 1 -> Concept 2 -> Concept 3 -> Concept 4 (if exists) -> Mixed
            const requiredTypes = ['learn1', 'learn2', 'learn3', 'learn4', 'mixed'];
            
            requiredTypes.forEach(type => {
                const pool = questionBank.filter(q => q.type === type);
                if(pool.length > 0) {
                    // Pick 1 random variant from this concept
                    const randomQ = pool[Math.floor(Math.random() * pool.length)];
                    currentQuestions.push(randomQ);
                } else {
                    // Fallback: If learn4 is missing (concept 4), try filling with mixed/challenge
                    if (type === 'learn4') {
                        const extraMixed = questionBank.filter(q => q.type === 'mixed' && !currentQuestions.includes(q));
                        if(extraMixed.length > 0) {
                             const randomMixed = extraMixed[Math.floor(Math.random() * extraMixed.length)];
                             currentQuestions.push(randomMixed);
                        }
                    }
                }
            });
            
            renderQuiz(); 
        }

        function renderQuiz() {
            const f = document.getElementById('quizForm');
            if(!f) return;
            let h = '';
            currentQuestions.forEach((q, i) => {
                h += `<div class="border border-gray-200 rounded-xl p-4 bg-white mb-6 hover:shadow-sm transition">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] md:text-xs font-bold">Ø³Ø¤Ø§Ù„ ${convertToArabic(i+1)}</span>
                                <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1"><i class="fas fa-tag text-xs"></i> ${typeLabels[q.type] || 'Ø¹Ø§Ù…'}</span>
                            </div>
                            <p class="font-bold text-gray-800 text-sm md:text-lg leading-6 mt-1">${q.t}</p>
                        </div>
                        <div class="options-grid">${q.o.map((o, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${o.v}" class="hidden"><label for="q${i}o${oi}" class="option-label shadow-sm">${o.t}</label></div>`).join('')}</div>
                        
                        <div id="feedback-${i}" class="hidden p-3 rounded-lg mt-2 font-bold"></div>
                        
                        <div id="actions-${i}" class="hidden mt-3 flex flex-wrap gap-2 items-center">
                             <button type="button" onclick="showExplain(${i})" class="text-xs md:text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 flex items-center gap-1 transition"><i data-lucide="help-circle" class="w-3 h-3"></i> Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                             <button type="button" onclick="showSmart(${i})" class="text-xs md:text-sm bg-purple-50 text-purple-600 px-3 py-2 rounded-lg hover:bg-purple-100 flex items-center gap-1 transition"><i data-lucide="lightbulb" class="w-3 h-3"></i> Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ</button>
                             <button type="button" onclick="switchTab('${q.type.replace('mixed','learn4')}')" class="text-xs md:text-sm border border-gray-200 text-gray-500 px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-1 transition mr-auto"><i data-lucide="book-open" class="w-3 h-3"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³</button>
                        </div>
                      </div>`;
            });
            h += '<button type="submit" id="quiz-action-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700 transition">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>';
            f.innerHTML = h;
            f.onsubmit = handleQuizSubmit;
            lucide.createIcons(); 
        }

        function handleQuizSubmit(e) {
            e.preventDefault();
            if (attemptsLeft <= 0) return;
            
            attemptsLeft--;
            
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                localStorage.setItem(ATTEMPTS_KEY + '_visitor', attemptsLeft);
                if (attemptsLeft === 0) { 
                    const nextTime = Date.now() + COOLDOWN_MS;
                    localStorage.setItem(NEXT_ATTEMPT_KEY + '_visitor', nextTime);
                    startTimer(nextTime); 
                }
            } else {
                if (attemptsLeft === 0) startTimer(Date.now() + COOLDOWN_MS); 
            }

            let score = 0;
            currentQuestions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                const fb = document.getElementById(`feedback-${i}`);
                const acts = document.getElementById(`actions-${i}`);
                if(sel && sel.value === q.c) { 
                    score++; 
                    fb.innerHTML = 'âœ” Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©'; fb.className = 'block bg-green-50 text-green-700 p-3 rounded-lg mt-2 font-bold border border-green-100'; 
                } else { 
                    fb.innerHTML = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'; fb.className = 'block bg-red-50 text-red-700 p-3 rounded-lg mt-2 font-bold border border-red-100'; 
                }
                acts.classList.remove('hidden');
                document.querySelectorAll(`input[name="q${i}"]`).forEach(inp => inp.disabled = true);
            });
            
            saveScoreToBackend(LESSON_KEY, score * 2);
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${convertToArabic(score * 2)} / Ù¡Ù `;
            
            const card = document.getElementById('quiz-results');
            card.classList.remove('result-card-trophy', 'result-card-star', 'result-card-retry');
            if (score*2 >= 8) card.classList.add('result-card-trophy');
            else if (score*2 >= 5) card.classList.add('result-card-star');
            else card.classList.add('result-card-retry');
            
            updateAttemptsUI();
        }

        function resetQuizView() {
            document.getElementById('quiz-results').classList.add('hidden');
            generateQuiz(); // Smart Ordering Reshuffle
            document.getElementById('tab-quiz').scrollIntoView({behavior: 'smooth'});
            const sId = urlParams.get('studentId');
            if(sId && sId !== 'visitor') fetchStudentData();
            else updateAttemptsUI();
        }

        function renderDynamicGames() {
            const container = document.getElementById('dynamic-games-container');
            if (!container) return;
            container.innerHTML = '';
            
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/);
            if (!match) return; 
            const ch = match[1]; 
            const ls = match[2]; 
            
            const games = [
                { id: `g${ch}_${ls}_1`, title: 'Ù„Ø¹Ø¨Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (ØªÙØ§Ø¹Ù„ÙŠ)', icon: 'fa-gamepad' },
                { id: `g${ch}_${ls}_2`, title: 'Ø³Ø¨Ø§Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠ (ØªÙØ§Ø¹Ù„ÙŠ)', icon: 'fa-trophy' }
            ];

            const sId = urlParams.get('studentId') || '';
            const cId = urlParams.get('classId') || '';
            
            games.forEach(g => {
                const gameUrl = `https://ablan-math.github.io/games/${g.id}.html?studentId=${sId}&classId=${cId}`;
                container.innerHTML += `
                <div class="p-4 border rounded-xl flex items-center gap-3 cursor-pointer hover:shadow-md transition bg-white" 
                     onclick="openGameModal('${gameUrl}', '${g.title}')">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fas ${g.icon}"></i>
                    </div>
                    <span class="font-bold text-gray-700">${g.title}</span>
                </div>`;
            });
            document.getElementById('games-wrapper').classList.remove('hidden');
        }

        function showExplain(i) { document.getElementById('modal-content').innerHTML = currentQuestions[i].e; document.getElementById('modal').classList.remove('hidden'); }
        function showSmart(i) { document.getElementById('modal-content').innerHTML = `<p class="font-bold text-purple-700 mb-2">ğŸ’¡ Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ:</p>${currentQuestions[i].smart}`; document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = function() {
            document.documentElement.style.setProperty('--theme-hex', themeColor.hex);
            const nav = document.getElementById('bottom-nav-container');
            if(nav) {
                tabs.forEach((t, i) => {
                    nav.innerHTML += `<div class="nav-item ${i===0?'active':''}" id="nav-${t.id}" onclick="switchTab('${t.id}')"><i data-lucide="${t.icon}"></i><span>${t.label}</span></div>`;
                });
                lucide.createIcons();
            }
            initInteractive();
            initAttempts();
        };
    </script>
</body>
</html>

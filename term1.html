<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© | Ø£.Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f4f8;
        }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-container, #login-view { flex-grow: 1; }
        #login-view { display: flex; align-items: center; justify-content: center; }
        #app-container { display: grid; grid-template-rows: auto 1fr; }

        /* --- Tabbed Card Styles --- */
        .tabbed-card-container {
            background-color: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            overflow: hidden;
        }
        .card-tabs {
            display: flex;
            justify-content: space-between;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            flex-grow: 0;
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #6b7280;
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-button.active { color: #4f46e5; }
        .tab-button.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
            height: 3px; background-color: #4f46e5; border-top-left-radius: 3px; border-top-right-radius: 3px;
        }
        .card-content .content-view { padding: 1.5rem; }
        @media (max-width: 768px) {
            .card-content .content-view { padding: 1rem; }
            .tab-button { font-size: 1rem; padding: 1rem 0.75rem; }
        }

        /* --- Leaderboard Styles --- */
        .leaderboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .leaderboard-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1rem; }
        .leaderboard-title { font-size: 1.25rem; font-weight: 800; color: #1e3a8a; margin-bottom: 1rem; text-align: center; }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 0.75rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .leaderboard-table th { font-weight: 700; color: #4b5563; }
        .leaderboard-table tr:last-child td { border-bottom: none; }
        .leaderboard-table .rank { width: 60px; text-align: center; vertical-align: middle; } /* Adjusted width for stars */
        .leaderboard-table .score { text-align: left; line-height: 1.2; }
        .leaderboard-table tr.current-student { background-color: #eef2ff; }
        .current-student-rank-card { margin-top: 1rem; padding: 0.75rem; background-color: #e0e7ff; border-radius: 0.75rem; text-align: center; font-weight: 700; color: #312e81; }
        .expand-leaderboard-btn { width: 100%; margin-top: 0.75rem; padding: 0.5rem; background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; font-weight: 600; color: #4b5563; cursor: pointer; transition: background-color 0.2s; }
        .expand-leaderboard-btn:hover { background-color: #e5e7eb; }
        .expand-leaderboard-btn .fas { transition: transform 0.3s; }

        /* Rank Star Styles for Leaderboard */
        .rank-star-container {
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
        }
        .rank-star-icon {
            font-size: 2.2rem;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        .rank-star-gold { color: #FFD700; }
        .rank-star-silver { color: #C0C0C0; }
        .rank-star-bronze { color: #CD7F32; } /* Fallback */
        .rank-star-number {
            position: absolute;
            color: #fff;
            font-weight: 900;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -45%); /* Slight adjust for visual center */
        }
        .rank-simple-number {
            font-weight: 700;
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* --- Lesson & Path Styles --- */
        .lesson-checkpoint.locked .lesson-card, .lesson-checkpoint.locked .game-card { opacity: 0.6; background-color: #f3f4f6; pointer-events: none; cursor: not-allowed; }
        .lesson-checkpoint.locked .checkpoint-icon { background-color: #9ca3af; box-shadow: 0 0 0 3px #9ca3af; }
        .lesson-summary-box.locked { opacity: 0.5; background-color: #f8f8f8; pointer-events: none; cursor: not-allowed; }
        .lesson-summary-box.locked .summary-icon { color: #b0b0b0 !important; }

        .unlock-date { font-size: 0.8rem; font-weight: 600; color: #4b5563; background-color: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 0.5rem; margin-top: 0.5rem; display: inline-block; }
        .card { background-color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .chapter-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .chapter-card-header { padding: 1.5rem; cursor: pointer; }
        .chapter-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); border-color: #4f46e5; }
        .chapter-lessons-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 1.5rem; border-top: 1px solid #e5e7eb; }
        .chapter-card.expanded .chapter-lessons-container { max-height: 2000px; padding: 1.5rem; }
        .chapter-card.expanded .expand-icon { transform: rotate(180deg); }
        .expand-icon { transition: transform 0.3s ease-in-out; }
        .lesson-summary-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; justify-content: center; }
        .lesson-summary-box { width: 80px; height: 80px; border: 2px solid #e5e7eb; background-color: #f9fafb; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.25rem; transition: all 0.2s ease; }
        .lesson-summary-box:hover:not(.locked) { border-color: #4f46e5; transform: scale(1.05); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .lesson-summary-box .top-part, .lesson-summary-box .bottom-part a { transition: background-color 0.2s ease; width: 100%; display: flex; justify-content: center; align-items: center; text-decoration: none; color: inherit; }
        .lesson-summary-box .top-part:hover, .lesson-summary-box .bottom-part a:hover { background-color: #eef2ff; }
        .lesson-summary-box .top-part { gap: 0.5rem; flex-grow: 1; border-top-left-radius: 0.6rem; border-top-right-radius: 0.6rem; }
        .lesson-summary-box .bottom-part { display: flex; gap: 1rem; flex-grow: 1; }
        .lesson-summary-box .bottom-part a { border-bottom-left-radius: 0.6rem; border-bottom-right-radius: 0.6rem; }
        .lesson-summary-box .lesson-number { font-size: 1.2rem; font-weight: 700; color: #6b7280; }
        .lesson-summary-box .top-part .summary-icon { font-size: 1.8rem; }
        .lesson-summary-box .bottom-part .summary-icon { font-size: 1.2rem; }
        .summary-icon { font-size: 1.4rem; }
        .summary-icon.fa-trophy { color: #f59e0b; }
        .summary-icon.fa-check { color: #22c55e; }
        .summary-icon.fa-sync-alt { color: #ef4444; }
        .summary-icon.fa-circle-notch { color: #9ca3af; font-size: 1.2rem; }
        .lessons-path { padding-top: 1rem; }
        .lesson-checkpoint { display: flex; align-items: flex-start; position: relative; padding-bottom: 2rem; }
        .lesson-checkpoint:not(:last-child)::before { content: ''; position: absolute; top: 25px; right: 24px; width: 2px; height: 100%; background-color: #d1d5db; }
        .checkpoint-icon { width: 50px; height: 50px; border-radius: 50%; display: grid; place-items: center; font-size: 1.5rem; color: white; border: 4px solid #f0f4f8; transition: all 0.3s ease; }
        .lesson-checkpoint.not-started .checkpoint-icon { background-color: #6366f1; box-shadow: 0 0 0 3px #6366f1; }
        .lesson-checkpoint.improve .checkpoint-icon { background-color: #ef4444; box-shadow: 0 0 0 3px #ef4444; }
        .lesson-checkpoint.good .checkpoint-icon { background-color: #22c55e; box-shadow: 0 0 0 3px #22c55e; }
        .lesson-checkpoint.excellent .checkpoint-icon { background-color: #f59e0b; box-shadow: 0 0 0 3px #f59e0b; }
        .checkpoint-content { margin-right: 1.5rem; width: 100%; }
        .lesson-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; transition: border-color 0.3s; position: relative; }
        
        /* NEW: Styles for the lesson test card */
        .lesson-test-card {
            display: flex;
            align-items: center;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.75rem;
            padding: 1rem;
            text-decoration: none;
            color: #312e81;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
            position: relative; /* Added for badge positioning */
        }
        .lesson-test-card:hover {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            transform: translateY(-2px);
        }
        .lesson-test-card .lesson-title { font-weight: 700; }
        .lesson-test-card .lesson-grade { font-weight: 700; margin-right: auto; }
        .lesson-test-card.spotlight {
            border-color: #4f46e5;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);
            animation: pulse-border 2s infinite;
        }

        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1rem; }
        .game-card { position: relative; background-color: white; border-radius: 0.5rem; padding: 0.75rem; text-align: center; border: 1px solid #e5e7eb; transition: transform 0.2s, border-color 0.3s, box-shadow 0.3s; text-decoration: none; color: #374151; cursor: pointer; }
        .game-card:hover { transform: translateY(-3px); }
        .game-title { font-weight: 600; font-size: 0.875rem; padding-top: 0.5rem; }
        .game-grade { font-size: 0.875rem; font-weight: 700; color: #1d4ed8; margin-top: 0.25rem; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background-color: white; border-radius: 1rem; padding: 1rem; width: 100%; max-width: 900px; max-height: 90%; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: flex-end; padding-bottom: 0.5rem; }
        .modal-close-btn { background: #e5e7eb; color: #4b5563; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; border: none; cursor: pointer; }
        .modal-body { flex-grow: 1; }
        .modal-body iframe { width: 100%; height: 100%; border: none; min-height: 500px; }
        .diagnostic-modal-content { background-color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; text-align: center; padding: 2.5rem; border-radius: 1rem; position: relative; }
        #close-diagnostic-modal { position: absolute; top: 0.75rem; left: 0.75rem; background: #f1f5f9; color: #64748b; border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; font-size: 1.5rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .progress-circle { width: 150px; height: 150px; border-radius: 50%; display: grid; place-items: center; transition: background 0.5s; }
        .progress-circle-inner { width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* --- Spotlight and Guidance Styles --- */
        .game-card.spotlight { border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); animation: pulse-border-red 2s infinite; }
        .start-here-badge { position: absolute; top: -12px; right: -12px; background-color: #ef4444; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .game-icon-badge { position: absolute; top: -15px; left: -15px; background-color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes pulse-border-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* --- Musaid (Assistant) Modal Styles --- */
        .musaid-modal-content { background: white; border-radius: 1.5rem; width: 100%; max-width: 500px; text-align: center; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; animation: fadeIn 0.3s ease-out; }
        .musaid-modal-header .emoji-icon { font-size: 4rem; line-height: 1; }
        .musaid-modal-title { font-size: 2rem; font-weight: 800; color: #1e3a8a; margin-top: 0.5rem; }
        .musaid-modal-body p { color: #4b5563; font-size: 1.1rem; line-height: 1.6; }
        .task-name { font-weight: 700; color: #1d4ed8; background-color: #eef2ff; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: inline-block; margin-top: 0.5rem; margin-bottom: 1.5rem; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; text-align: center; }
        .stat-item { background-color: #f3f4f6; padding: 1rem; border-radius: 0.75rem; }
        .stat-value { font-size: 2rem; font-weight: 800; color: #1e3a8a; }
        .stat-label { font-size: 0.9rem; color: #4b5563; }
        .action-btn { background: linear-gradient(to right, #22c55e, #16a34a); color: white; font-weight: 700; font-size: 1.1rem; padding: 0.75rem 2rem; border-radius: 9999px; text-decoration: none; display: inline-block; transition: transform 0.2s; border: none; cursor: pointer; }
        .action-btn:hover { transform: scale(1.05); }
        .dismiss-btn { background: transparent; border: none; color: #6b7280; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-top: 1rem; transition: color 0.2s; }
        .dismiss-btn:hover { color: #1f2937; text-decoration: underline; }
        /* NEW: Secondary button style */
        .secondary-action-btn {
            background: transparent;
            border: none;
            color: #4f46e5;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .recall-musaid-btn {
            background-color: #eef2ff; color: #4f46e5; border-radius: 50%;
            width: 48px; height: 48px; font-size: 1.5rem;
            display: inline-flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            animation: pulse-glow 2s infinite;
        }
        .recall-musaid-btn:hover { transform: scale(1.1); background-color: #e0e7ff; }

        /* NEW STYLE FOR DISMISSED STATE */
        .recall-musaid-btn.musaid-dismissed {
            background-color: #e5e7eb; /* Grey background */
            color: #9ca3af; /* Grey icon */
            animation: none; /* Turn off animation */
            opacity: 0.8;
        }
        .recall-musaid-btn.musaid-dismissed:hover {
             background-color: #d1d5db; /* Slightly darker grey on hover */
             transform: scale(1.1); /* Keep the hover effect */
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 10px 10px rgba(79, 70, 229, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .social-icon {
            transition: transform 0.2s ease-in-out;
        }
        .social-icon:hover {
            transform: scale(1.15);
        }
        /* Star/Medal Badge Styles */
        .star-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.3s, transform 0.3s;
            position: relative;
            width: 80px;
            height: auto;
            justify-content: flex-start;
            margin-bottom: 0.5rem; /* Added some spacing */
        }
        .star-badge.active {
            opacity: 1;
            transform: scale(1.02); /* Slightly reduced scale for subtleties */
        }
        .star-badge .fa-star {
            font-size: 2rem;
            /* Default color for unknown state */
            color: #e5e7eb; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .star-badge .fa-lock {
            font-size: 1.8rem;
            color: #9ca3af;
        }
        
        /* 3D Star Floating Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); } /* Reduced float height */
            100% { transform: translateY(0px); }
        }

        .star-animate {
            animation: float 4s ease-in-out infinite;
        }
        
        .star-label {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 0.3rem;
            color: #6b7280;
            text-align: center;
        }
        .star-badge.active .star-label {
            color: #1e3a8a;
        }
        .star-sublabel {
            font-size: 0.7rem;
            color: #9ca3af;
            text-align: center;
        }
        .star-badge.active .star-sublabel {
            color: #4b5563;
            font-weight: bold;
        }
        
        /* New Score Box Style */
        .star-score-box {
            margin-top: 4px;
            border: 1px solid #3b82f6;
            background-color: #fff;
            color: #1e3a8a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            direction: ltr; /* Ensure percentage looks right */
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Hidden SVG Defs for 3D Stars -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <!-- Gold Gradient -->
            <linearGradient id="grad-gold-3d" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#FFF5C3;stop-opacity:1" />
                <stop offset="40%" style="stop-color:#FFD700;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
            </linearGradient>
            <!-- Silver Gradient -->
            <linearGradient id="grad-silver-3d" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#F5F5F5;stop-opacity:1" />
                <stop offset="40%" style="stop-color:#C0C0C0;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#505050;stop-opacity:1" />
            </linearGradient>
            <!-- Bronze Gradient -->
            <linearGradient id="grad-bronze-3d" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#F4A460;stop-opacity:1" />
                <stop offset="40%" style="stop-color:#CD7F32;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#603000;stop-opacity:1" />
            </linearGradient>
            
            <!-- Inset Shadow Filter -->
            <filter id="inset-shadow-3d">
                <feOffset dx="0" dy="0"/>
                <feGaussianBlur stdDeviation="1" result="offset-blur"/>
                <feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse"/>
                <feFlood flood-color="black" flood-opacity="0.5" result="color"/>
                <feComposite operator="in" in="color" in2="inverse" result="shadow"/>
                <feComposite operator="over" in="shadow" in2="SourceGraphic"/>
            </filter>
        </defs>
    </svg>

    <!-- Preloader -->
    <div id="preloader" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #f0f4f8; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="loader" style="width: 50px; height: 50px; border-top-color: #3b82f6;"></div>
    </div>

    <!-- Login View -->
    <div id="login-view" style="display: none;">
        <main class="container mx-auto px-6 py-8">
            <div class="max-w-md mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-blue-800 mb-4">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
                    <p class="text-lg text-gray-600 mb-2">Ù„Ù„Ù…Ø¹Ù„Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
                    <hr class="my-6">
                    <h2 class="text-2xl font-bold mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h2>
                    <p class="text-gray-600 mb-6">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØªÙƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <input type="text" id="login-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©" class="w-full text-center text-lg px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 text-lg flex justify-center items-center transition-all duration-300 transform hover:scale-105">
                            <span id="login-submit-text">Ø¯Ø®ÙˆÙ„</span>
                            <div id="login-loader" class="loader hidden"></div>
                        </button>
                    </form>
                    <div id="login-error" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"></div>
                    <div class="mt-8">
                        <p class="text-gray-600 mb-2">Ø£Ùˆ</p>
                        <button id="visitor-btn" class="font-bold text-gray-700 hover:underline">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ²Ø§Ø¦Ø±</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Main App Container -->
    <div id="app-container" style="display: none;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto px-4 sm:px-6 py-8">
            
            <!-- Tabbed Card Container -->
            <div id="dashboard-container" class="tabbed-card-container">
                <div class="card-tabs">
                    <button id="student-data-tab" class="tab-button active"><i class="fas fa-user-chart mr-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
                    <button id="leaderboard-tab" class="tab-button"><i class="fas fa-trophy mr-2"></i>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
                </div>
                <div class="card-content">
                    <!-- View 1: Student Data -->
                    <div id="student-data-view" class="content-view">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Student Info & Diagnostic -->
                            <div class="card space-y-4 border border-gray-200">
                                <div id="student-info-card"></div>
                                <div id="diagnostic-card"></div>
                            </div>
                            <!-- Progress Circle & Achievement Bar -->
                            <div class="card flex flex-col items-center justify-center border border-gray-200">
                                <h3 class="text-2xl font-bold text-blue-800 mb-4">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¥ØªÙ‚Ø§Ù†</h3>
                                <div id="overall-progress-circle" class="progress-circle bg-gray-200">
                                    <div class="progress-circle-inner">
                                        <span id="mastery-percentage-text" class="text-3xl font-black text-green-600">0%</span>
                                        <span class="text-sm text-black font-bold mt-1">Ø§Ù„Ø§ØªÙ‚Ø§Ù† Ù„Ù„Ù…ØªØ§Ø­</span>
                                    </div>
                                </div>
                                
                                <!-- Legend moved up, separator removed from here, text removed -->
                                <div class="w-full mt-4 text-center">
                                    <!-- Removed h4 title -->
                                    <div id="progress-legend" class="flex flex-wrap justify-center items-center gap-x-4 gap-y-2 w-full">
                                        <div class="flex items-center gap-2">
                                            <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                            <span id="needs-improvement-legend-text" class="text-sm font-semibold text-gray-600">ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† 0%</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-3 h-3 rounded-full bg-indigo-300"></span>
                                            <span id="pending-legend-text" class="text-sm font-semibold text-gray-600">Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ 0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Achievement Bar Container (Separator added in JS) -->
                                <div id="certificate-progress-container" class="w-full"></div>

                            </div>
                        </div>
                    </div>
                    <!-- View 2: Leaderboards -->
                    <div id="leaderboard-view" class="content-view hidden">
                        <div class="text-center p-8" id="leaderboard-loader">
                             <div class="loader inline-block"></div>
                             <p class="mt-2 font-semibold text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆØ§Ø¦Ù„...</p>
                        </div>
                        <div id="leaderboard-grid" class="leaderboard-grid hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Learning Path Section -->
            <div id="learning-path-section" class="space-y-4 mt-8"></div>
        </main>
    </div>
    
    <footer id="main-footer" class="bg-gray-200 py-4 mt-auto"></footer>

    <!-- Modals -->
    <div id="game-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><button id="modal-close-btn" class="modal-close-btn">&times;</button></div><div class="modal-body"><iframe id="game-iframe"></iframe></div></div></div>
    <div id="diagnostic-modal" class="modal-overlay hidden"><div class="diagnostic-modal-content"><button id="close-diagnostic-modal" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button><i class="fas fa-rocket text-5xl text-blue-600 mb-4"></i><h2 class="text-2xl font-bold mb-2">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª!</h2><p class="mb-6">Ø³ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ ÙÙ‡Ù… Ù†Ù‚Ø§Ø· Ù‚ÙˆØªÙƒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ±ÙƒÙŠØ² Ø£ÙƒØ¨Ø±.</p><a id="start-diagnostic-btn" href="#" class="inline-block bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 transition-transform hover:scale-105"><i class="fas fa-play-circle mr-2"></i>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</a></div></div>
    
    <!-- Musaid Modal -->
    <div id="musaid-modal" class="modal-overlay hidden">
        <div class="musaid-modal-content">
            <div id="musaid-modal-header" class="musaid-modal-header">
                <span class="emoji-icon">ğŸ‘‹</span>
                <h2 class="musaid-modal-title">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
            </div>
            <div id="musaid-modal-body" class="musaid-modal-body"></div>
            <div id="musaid-modal-footer" class="musaid-modal-footer"></div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const VISITOR_MAX_ATTEMPTS = 3;

        const curriculumIndex = {
            'c1': { 
                title: "Ø§Ù„ÙØµÙ„ Ù¡: Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©",
                lessons: [
                    { id: 'c1_l1', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¡-Ù¡: Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª', maxScore: 10, games: [ { id: 'g1_1_1', title: 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø°Ø±Ø©', maxScore: 5 }, { id: 'g1_1_2', title: 'Ù…ØµÙ†Ø¹ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª', maxScore: 5 } ]},
                    { id: 'c1_l2', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¡-Ù¢: Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©', maxScore: 10, games: [ { id: 'g1_2_1', title: 'Ø±Ø§Ù…ÙŠ Ø§Ù„Ø³Ù‡Ø§Ù…', maxScore: 5 }, { id: 'g1_2_2', title: 'ÙÙƒ Ø§Ù„Ø´ÙØ±Ø©', maxScore: 5 } ]},
                    { id: 'c1_l3', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¡-Ù£: Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø®Ø·ÙˆØ§Øª', maxScore: 10, games: [ { id: 'g1_3_1', title: 'ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ¨ÙˆØª', maxScore: 5 }, { id: 'g1_3_2', title: 'Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¬Ø¨Ù„ÙŠØ©', maxScore: 5 } ]},
                    { id: 'c1_l4', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¡-Ù¤: Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ù…ØªØºÙŠØ±Ø§Ù‹ ÙÙŠ Ø·Ø±ÙÙŠÙ‡Ø§', maxScore: 10, games: [ { id: 'g1_4_1', title: 'Ø¨Ù†Ø§Ø¡ Ø¬Ø³Ø± Ø§Ù„Ù†Ø¬Ø§Ø­', maxScore: 5 }, { id: 'g1_4_2', title: 'ØªØ³Ù„Ù‚ Ù‚Ù…Ø© Ø§Ù„Ø¬Ø¨Ù„', maxScore: 5 } ]},
                    { id: 'c1_l5', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¡-Ù¥: Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ¶Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©', maxScore: 10, games: [ { id: 'g1_5_1', title: 'Ù‡Ø¯Ø§Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', maxScore: 5 }, { id: 'g1_5_2', title: 'Ø­Ø§Ø±Ø³ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', maxScore: 5 } ]},
                ]
            },
            'c2': {
                title: "Ø§Ù„ÙØµÙ„ Ù¢: Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙŠØ©",
                lessons: [
                    { id: 'c2_l1', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù¡: Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª', maxScore: 10, games: [ { id: 'g2_1_1', title: 'Ù…ØºØ§Ù…Ø±Ø© Ø³ÙÙŠÙ†Ø© Ø§Ù„ÙƒÙ†Ø²', maxScore: 5 }, { id: 'g2_1_2', title: 'ØµÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ', maxScore: 5 } ]},
                    { id: 'c2_l2', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù¢: Ø§Ù„Ø¯ÙˆØ§Ù„', maxScore: 10, games: [ { id: 'g2_2_1', title: 'Ù…Ø­Ù‚Ù‚ Ø§Ù„Ø¯ÙˆØ§Ù„', maxScore: 5 }, { id: 'g2_2_2', title: 'Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙˆØ§Ù„', maxScore: 5 } ]},
                    { id: 'c2_l3', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù£: ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ© Ø¨ÙŠØ§Ù†ÙŠØ§Ù‹', maxScore: 10, games: [ { id: 'g2_3_1', title: 'Ø·ÙŠØ§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„', maxScore: 5 }, { id: 'g2_3_2', title: 'Ø¨Ø§Ø®Ø±Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª', maxScore: 5 } ]},
                    { id: 'c2_l4', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù¤: Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ© Ø¨ÙŠØ§Ù†ÙŠØ§Ù‹', maxScore: 10, games: [ { id: 'g2_4_1', title: 'Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ', maxScore: 5 }, { id: 'g2_4_2', title: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù†Ø§Ø¬Ø­', maxScore: 5 } ]},
                    { id: 'c2_l5', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù¥: Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ÙˆØ§Ù„Ù…ÙŠÙ„', maxScore: 10, games: [ { id: 'g2_5_1', title: 'ØºØ±ÙØ© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', maxScore: 5 }, { id: 'g2_5_2', title: 'Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ù‡Ù…', maxScore: 5 } ]},
                    { id: 'c2_l6', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¢-Ù¦: Ø§Ù„Ù…ØªØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© ÙƒØ¯ÙˆØ§Ù„ Ø®Ø·ÙŠØ©', maxScore: 10, games: [ { id: 'g2_6_1', title: 'Ù…Ø®Ø·ÙˆØ·Ù‡ Ø§Ù„ÙƒÙ†Ø²', maxScore: 5 }, { id: 'g2_6_2', title: 'Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ', maxScore: 5 } ]},
                ]
            },
            'c3': { 
                title: "Ø§Ù„ÙØµÙ„ Ù£: Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙŠØ©",
                lessons: [
                    { id: 'c3_l1', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù£-Ù¡: ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© Ø¨ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ Ø¨ÙŠØ§Ù†ÙŠØ§Ù‹', maxScore: 10, games: [ { id: 'g3_1_1', title: 'Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª', maxScore: 5 }, { id: 'g3_1_2', title: 'Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹', maxScore: 5 } ]},
                    { id: 'c3_l2', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù£-Ù¢: ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø¨ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹', maxScore: 10, games: [ { id: 'g3_2_1', title: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ©', maxScore: 5 }, { id: 'g3_2_2', title: 'Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ', maxScore: 5 } ]},
                    { id: 'c3_l3', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù£-Ù£: ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø¨ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆÙ†Ù‚Ø·Ø©', maxScore: 10, games: [ { id: 'g3_3_1', title: 'Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ù…ÙŠÙ„ ÙˆÙ†Ù‚Ø·Ø©', maxScore: 5 }, { id: 'g3_3_2', title: 'ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©', maxScore: 5 } ]},
                    { id: 'c3_l4', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù£-Ù¤: Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠØ© ÙˆØ§Ù„Ù…ØªØ¹Ø§Ù…Ø¯Ø©', maxScore: 10, games: [ { id: 'g3_4_1', title: 'Ø§Ù„ØªÙˆØ§Ø²ÙŠ ÙˆØ§Ù„ØªØ¹Ø§Ù…Ø¯', maxScore: 5 }, { id: 'g3_4_2', title: 'Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©', maxScore: 5 } ]},
                ]
            },
            'c4': { 
                title: "Ø§Ù„ÙØµÙ„ Ù¤: Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©",
                lessons: [
                    { id: 'c4_l1', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¤-Ù¡: Ø­Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø¨Ø§Ù„Ø¬Ù…Ø¹ Ø£Ùˆ Ø¨Ø§Ù„Ø·Ø±Ø­', maxScore: 10, games: [ { id: 'g4_1_1', title: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª', maxScore: 5 }, { id: 'g4_1_2', title: 'Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', maxScore: 5 } ]},
                    { id: 'c4_l2', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¤-Ù¢: Ø­Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø¨Ø§Ù„Ø¶Ø±Ø¨ Ø£Ùˆ Ø¨Ø§Ù„Ù‚Ø³Ù…Ø©', maxScore: 10, games: [ { id: 'g4_2_1', title: 'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª', maxScore: 5 }, { id: 'g4_2_2', title: 'Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', maxScore: 5 } ]},
                    { id: 'c4_l3', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¤-Ù£: Ø­Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø®Ø·ÙˆØ§Øª', maxScore: 10, games: [ { id: 'g4_3_1', title: 'Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª', maxScore: 5 }, { id: 'g4_3_2', title: 'ØªØ±Ø¬Ù… Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©', maxScore: 5 } ]},
                    { id: 'c4_l4', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¤-Ù¤: Ø­Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', maxScore: 10, games: [ { id: 'g4_4_1', title: 'Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', maxScore: 5 }, { id: 'g4_4_2', title: 'Ù…ØªØ¨Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©', maxScore: 5 } ]},
                    { id: 'c4_l5', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¤-Ù¥: Ø­Ù„ Ø§Ù„Ù…ØªØ¨Ø§ÙŠÙ†Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ¶Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©', maxScore: 10, games: [ { id: 'g4_5_1', title: 'Ø£Ù‚ÙØ§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø© ', maxScore: 5 }, { id: 'g4_5_2', title: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¯Ù‚Ø©', maxScore: 5 } ]},
                ]
            },
            'c5': { 
                title: "Ø§Ù„ÙØµÙ„ Ù¥: Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©",
                lessons: [
                    { id: 'c5_l1', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¥-Ù¡: Ø­Ù„ Ù†Ø¸Ø§Ù… Ù…Ù† Ù…Ø¹Ø§Ø¯Ù„ØªÙŠÙ† Ø®Ø·ÙŠØªÙŠÙ† Ø¨ÙŠØ§Ù†ÙŠØ§Ù‹', maxScore: 10, games: [ { id: 'g5_1_1', title: 'Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ©', maxScore: 5 }, { id: 'g5_1_2', title: 'Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ', maxScore: 5 } ]},
                    { id: 'c5_l2', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¥-Ù¢: Ø­Ù„ Ù†Ø¸Ø§Ù… Ù…Ù† Ù…Ø¹Ø§Ø¯Ù„ØªÙŠÙ† Ø®Ø·ÙŠØªÙŠÙ† Ø¨Ø§Ù„ØªØ¹ÙˆÙŠØ¶', maxScore: 10, games: [ { id: 'g5_2_1', title: 'Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„ØªØ¹ÙˆÙŠØ¶1', maxScore: 5 }, { id: 'g5_2_2', title: 'Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„ØªØ¹ÙˆÙŠØ¶2', maxScore: 5 } ]},
                    { id: 'c5_l3', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¥-Ù£: Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„Ø­Ø°Ù (Ø§Ù„Ø¬Ù…Ø¹ Ø£Ùˆ Ø§Ù„Ø·Ø±Ø­)', maxScore: 10, games: [ { id: 'g5_3_1', title: 'Ø§Ù„Ø­Ø°Ù Ø¨Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø·Ø±Ø­', maxScore: 5 }, { id: 'g5_3_2', title: 'Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙØ¸ÙŠØ© 1', maxScore: 5 } ]},
                    { id: 'c5_l4', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¥-Ù¤: Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„Ø­Ø°Ù (Ø§Ù„Ø¶Ø±Ø¨)', maxScore: 10, games: [ { id: 'g5_4_1', title: 'Ø§Ù„Ø­Ø°Ù Ø¨Ø§Ù„Ø¶Ø±Ø¨', maxScore: 5 }, { id: 'g5_4_2', title: 'Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙØ¸ÙŠØ© 2', maxScore: 5 } ]},
                    { id: 'c5_l5', title: 'Ø§Ù„Ø¯Ø±Ø³ Ù¥-Ù¥: ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙŠ', maxScore: 10, games: [ { id: 'g5_5_1', title: 'Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø©', maxScore: 5 }, { id: 'g5_5_2', title: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙˆØ§Ù‚Ø¹ÙŠØ©', maxScore: 5 } ]},
                ]
            }
        };

        // CALCULATE TOTAL PLATFORM SCORE FOR PERCENTAGE
        let totalPlatformMaxScore = 0;
        Object.values(curriculumIndex).forEach(chapter => {
            chapter.lessons.forEach(lesson => {
                totalPlatformMaxScore += (lesson.maxScore || 10);
                (lesson.games || []).forEach(game => {
                    totalPlatformMaxScore += (game.maxScore || 5);
                });
            });
        });

        const preloader = document.getElementById('preloader');
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const gameModal = document.getElementById('game-modal');
        const gameIframe = document.getElementById('game-iframe');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const diagnosticModal = document.getElementById('diagnostic-modal');
        const startDiagnosticBtn = document.getElementById('start-diagnostic-btn');
        const closeDiagnosticModalBtn = document.getElementById('close-diagnostic-modal');
        const studentDataTab = document.getElementById('student-data-tab');
        const leaderboardTab = document.getElementById('leaderboard-tab');
        const studentDataView = document.getElementById('student-data-view');
        const leaderboardView = document.getElementById('leaderboard-view');
        const musaidModal = document.getElementById('musaid-modal');

        function getClassIdentifier(fullClassName) { if (!fullClassName) return null; const classMap = { "Ø«Ø§Ù„Ø« / Ø£ÙˆÙ„": "3-1", "Ø«Ø§Ù„Ø« / Ø«Ø§Ù†ÙŠ": "3-2", "Ø«Ø§Ù„Ø« / Ø«Ø§Ù„Ø«": "3-3" }; return classMap[fullClassName.trim()] || null; }
        function robustParseFloat(value) { if (value === null || value === undefined || value === "") return null; const stringValue = String(value); const sanitizedValue = stringValue.replace(',', '.').trim(); const parsed = parseFloat(sanitizedValue); return isNaN(parsed) ? null : parsed; }
        
        // NEW: Utility to round to 1 decimal place
        function formatDecimal(val) {
            if (val === null || val === undefined || val === '') return null;
            const num = parseFloat(val);
            return isNaN(num) ? val : Math.round(num * 10) / 10;
        }

        function parseDateAsLocal(dateString) {
            if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return new Date('9999-12-31');
            const parts = dateString.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        
        function switchView(viewName) {
            loginView.style.display = viewName === 'login' ? 'flex' : 'none';
            appContainer.style.display = viewName === 'app' ? 'block' : 'none';
        }
        
        function switchDashboardTab(tabName) {
            studentDataTab.classList.toggle('active', tabName === 'student');
            leaderboardTab.classList.toggle('active', tabName === 'leaderboard');
            studentDataView.classList.toggle('hidden', tabName !== 'student');
            leaderboardView.classList.toggle('hidden', tabName !== 'leaderboard');
        }

        function renderAppContent(studentData) {
            buildHeader(studentData);
            buildFooter();
            if (studentData) {
                showStudentDashboard(studentData);
                fetchAndRenderLeaderboards(studentData);
            } else { 
                document.getElementById('dashboard-container').classList.add('hidden');
                buildLearningPath({ lessons: {}, games: {} });
            }
        }
        
        function getStudentFromStorage() { const s = localStorage.getItem('currentStudent'); return s ? JSON.parse(s) : null; }

        function handleLogin(studentId) {
            const loader = document.getElementById('login-loader');
            const errorDiv = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');

            fetch(`${SCRIPT_URL}?action=findStudentById&studentId=${studentId}`, { redirect: 'follow' })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        result.data.classIdentifier = getClassIdentifier(result.data.class);
                        if (!result.data.classIdentifier && result.data.role !== 'teacher') {
                                errorDiv.textContent = 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙŠØºØ© Ø§Ù„ÙØµÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨.';
                                errorDiv.classList.remove('hidden');
                                return;
                        }
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        renderAppContent(result.data);
                        switchView('app');
                    } else {
                        errorDiv.textContent = result.message || 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙØµÙ„.';
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error("Login Error:", err);
                    errorDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                    errorDiv.classList.remove('hidden');
                })
                .finally(() => {
                    loader.classList.add('hidden');
                    submitBtn.disabled = false;
                });
        }
        
        function refreshStudentData(studentId, classIdentifier) {
            if (!studentId || !classIdentifier) {
                if(preloader) preloader.style.display = 'none';
                switchView('login');
                buildFooter();
                return;
            }

            fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${classIdentifier}`, { redirect: 'follow' })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        result.data.classIdentifier = getClassIdentifier(result.data.class);
                        const currentData = getStudentFromStorage();
                        if(currentData && currentData.role) {
                            result.data.role = currentData.role;
                        }
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        
                        renderAppContent(result.data); 
                        
                        if(preloader) preloader.style.display = 'none';
                        switchView('app');
                    } else {
                        throw new Error(result.message || "Failed to refresh student data.");
                    }
                })
                .catch(err => {
                    console.error("Data refresh error:", err);
                    localStorage.removeItem('currentStudent');
                    if(preloader) preloader.style.display = 'none';
                    switchView('login');
                    buildFooter();
                });
        }

        function buildHeader(studentData) {
            const headerContainer = document.getElementById('main-header');
            if (!headerContainer) return;
            let userInfoHtml = studentData ? `<div class="flex items-center gap-4"><span class="font-semibold">Ø£Ù‡Ù„Ø§Ù‹ØŒ ${studentData.name} ${studentData.role === 'teacher' ? '(Ù…Ø¹Ù„Ù…)' : ''}</span><button id="logout-btn" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600 transition-colors">Ø®Ø±ÙˆØ¬</button></div>` : `<div class="flex items-center gap-4"><p class="text-lg text-gray-600">Ø²Ø§Ø¦Ø±</p><button id="visitor-login-btn" class="bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 transition-colors">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>`;
            headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center"><a href="#" onclick="window.location.reload()" class="text-2xl font-bold text-blue-800">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</a>${userInfoHtml}</div>`;
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', () => { localStorage.removeItem('currentStudent'); window.location.reload(); });
            const visitorLoginBtn = document.getElementById('visitor-login-btn');
            if (visitorLoginBtn) visitorLoginBtn.addEventListener('click', () => switchView('login'));
        }

        function buildFooter() {
            const footerContainer = document.getElementById('main-footer');
            if (!footerContainer) return;
            const shareText = encodeURIComponent('Ø£Ø¯Ø¹ÙˆÙƒ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ù…Ø¹Ù„Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†:');
            const pageUrl = encodeURIComponent(window.location.href);
            footerContainer.innerHTML = `<div class="container mx-auto px-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0"><p class="text-gray-600 text-sm">Â© 2024 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | ØªØ·ÙˆÙŠØ±: Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p><div class="flex items-center space-x-4" dir="ltr">
                <a href="https://www.snapchat.com/share?url=${pageUrl}" target="_blank" aria-label="Share on Snapchat" class="social-icon"><svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#FFFC00"/><path d="M12.0118 6.66667C8.68183 6.66667 6 9.3485 6 12.6785C6 14.8385 7.15233 16.7385 8.88233 17.8485C8.96233 17.9085 9.05233 17.9485 9.14233 17.9485C9.28233 17.9485 9.42233 17.8785 9.51233 17.7485C9.66233 17.5385 9.60233 17.2385 9.39233 17.0885C7.98233 16.1485 7 14.5085 7 12.6785C7 9.8985 9.22183 7.66667 12.0118 7.66667C14.7918 7.66667 17.0218 9.8985 17.0218 12.6785C17.0218 14.5085 16.0318 16.1485 14.6218 17.0885C14.4118 17.2385 14.3518 17.5385 14.5018 17.7485C14.5918 17.8785 14.7318 17.9485 14.8718 17.9485C14.9618 17.9485 15.0518 17.9085 15.1418 17.8485C16.8618 16.7385 18.0218 14.8385 18.0218 12.6785C18.0218 9.3485 15.3418 6.66667 12.0118 6.66667Z" fill="white"/></svg></a>
                <a href="https://t.me/share/url?url=${pageUrl}&text=${shareText}" target="_blank" aria-label="Share on Telegram" class="social-icon"><svg class="w-8 h-8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#2AABEE"/><path d="m9.417 15.181-.397 5.584c.568 0 .814-.244 1.109-.537l2.663-2.545 5.518 4.041c1.012.564 1.725.267 1.998-.931L22.43 5.218c.347-1.61-1.2-2.127-2.299-1.594L4.543 11.177c-1.636.682-1.66 1.32.285 1.721l4.252 1.325 9.46-5.924c.448-.277.855-.136.524.162z" fill="#fff"/></svg></a>
                <a href="https://twitter.com/intent/tweet?text=${shareText}&url=${pageUrl}" target="_blank" aria-label="Share on Twitter" class="social-icon"><svg class="w-8 h-8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#000"/><path d="m10.215 13.584-6.328 7.163h1.416l5.59-6.328 4.35 6.328h6.92l-6.7-9.74 6.13-6.95h-1.416l-5.18 5.86-4.01-5.86h-6.92l7.07 10.28zm-.76-1.13-1.42-2.02-5.1-7.25h2.15l4.2 5.97 1.42 2.02 5.43 7.72h-2.15l-4.58-6.5z" fill="#fff"/></svg></a>
                <a href="https://api.whatsapp.com/send?text=${shareText}%20${pageUrl}" target="_blank" aria-label="Share on WhatsApp" class="social-icon"><svg class="w-8 h-8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#25D366" d="M12 2C6.477 2 2 6.477 2 12c0 1.742.448 3.385 1.253 4.814L2 22l5.186-1.253A9.93 9.93 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z"/><path fill="#FFF" d="M17.23 14.25c-.21-.12-.83-.41-1-.47-.16-.07-.3-.07-.42.12-.12.2-.4.48-.48.57-.08.1-.16.1-.28 0-.12-.07-.5-.18-1.03-.63-.8-.7-1.33-1.56-1.48-1.82-.15-.26-.02-.4.07-.53.08-.12.18-.3.27-.4.1-.1.12-.18.18-.3.06-.12.03-.23 0-.33-.03-.1-.28-.68-.38-1-.1-.31-.2-.26-.28-.26-.08 0-.18 0-.28 0-.1 0-.26.04-.4.2-.13.16-.52.5-.52 1.22 0 .72.53 1.42.6 1.52.08.1.92 1.47 2.4 2.1.37.16.66.25.88.32.22.07.42.06.58.02.18-.04.58-.24.7-.47.12-.24.12-.44.08-.48-.03-.05-.1-.07-.2-.1z"/></svg></a>
                <span class="text-gray-600 text-sm">:Ø´Ø§Ø±ÙƒÙ†Ø§</span></div></div>`;
        }
        
        function showStudentDashboard(studentData) {
            document.getElementById('dashboard-container').classList.remove('hidden');
            
            const studentInfoCard = document.getElementById('student-info-card');
            
            // Updated User Info Layout
            studentInfoCard.innerHTML = `
                <h4 class="text-xl font-bold text-blue-800 mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h4>
                <div class="flex items-center gap-2 text-gray-800 text-lg">
                    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="display-name">${studentData.name || '-'}</span></p>
                    <span class="text-gray-400">|</span>
                    <p><strong>Ø§Ù„ØµÙ:</strong> <span id="display-class">${studentData.class || '-'}</span></p>
                </div>
            `;

            renderTestCard(studentData);

            // Define essential variables at the top scope of function to fix ReferenceError
            const studentLessons = studentData.lessons || {};
            const studentGames = studentData.games || {};
            const lessonRules = studentData.lessonRules || {};

            // --- CALCULATION: INTERACTION PERCENTAGE FROM SHEET (COLUMN "Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ %") ---
            // This ensures consistency across the platform
            // Also use a fallback calculation in case the sheet column is missing or empty, to avoid showing 0% incorrectly
            let sheetInteractionScore = studentData['Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ %'] ? robustParseFloat(studentData['Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ %']) : 0;
            
            // Fallback calculation logic if sheet value is missing (DYNAMIC DENOMINATOR)
            if (!sheetInteractionScore || sheetInteractionScore === 0) {
                 let totalLessonsScore = 0;
                 let totalLessonsPossible = 0;
                 let totalGamesScore = 0;
                 let totalGamesPossible = 0;
                 
                 // Get today's date for checking availability
                 const today = new Date();
                 today.setHours(0, 0, 0, 0);

                 Object.values(curriculumIndex).forEach(chapter => {
                    chapter.lessons.forEach(lesson => {
                        // Check if lesson is unlocked based on date
                        const rule = lessonRules[lesson.id];
                        let isLocked = true;
                        
                        if (rule) {
                            if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                            else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                                const d = parseDateAsLocal(rule.value);
                                if (today >= d) { isLocked = false; }
                            }
                        } else { isLocked = false; } // Default to unlocked if no rule? (Adjust based on business logic)
                        
                        // Only include in denominator if unlocked
                        if (!isLocked) {
                            const lMax = lesson.maxScore || 10;
                            totalLessonsPossible += lMax;
                            const lGrade = robustParseFloat(studentLessons[lesson.id]?.grade);
                            if (lGrade !== null) totalLessonsScore += lGrade;

                            (lesson.games || []).forEach(game => {
                                const gMax = game.maxScore || 5;
                                totalGamesPossible += gMax;
                                const gGrade = robustParseFloat(studentGames[game.id]?.grade);
                                if (gGrade !== null) totalGamesScore += gGrade;
                            });
                        }
                    });
                });
                const lessonPct = totalLessonsPossible > 0 ? (totalLessonsScore / totalLessonsPossible) * 100 : 0;
                const gamePct = totalGamesPossible > 0 ? (totalGamesScore / totalGamesPossible) * 100 : 0;
                // Fallback average
                sheetInteractionScore = (lessonPct + gamePct) / 2;
            }
            
            // Helper function to get the correct 3D star SVG string based on type
            function getStarSVG(type) {
                // Changed size from w-20 h-20 to w-10 h-10 (~2.5rem)
                const sizeClass = "w-10 h-10"; 
                let fillUrl = "";
                
                if (type === 'gold') fillUrl = "url(#grad-gold-3d)";
                else if (type === 'silver') fillUrl = "url(#grad-silver-3d)";
                else if (type === 'bronze') fillUrl = "url(#grad-bronze-3d)";
                else return ""; // Should not happen for active stars

                return `
                <div class="${sizeClass} star-animate relative z-10">
                    <svg viewBox="0 0 24 24" class="w-full h-full drop-shadow-2xl" fill="${fillUrl}">
                        <path d="M12 2L15 9L22 9L17 14L19 21L12 17L5 21L7 14L2 9L9 9L12 2Z" filter="url(#inset-shadow-3d)"/>
                        <path d="M12 17V9L15 9" fill="black" fill-opacity="0.1"/>
                    </svg>
                </div>`;
            }


            // --- HELPER: Get Medal Config based on Score ---
            function getMedalStatus(score, thresholds) {
                // thresholds = { gold: 95, silver: 75, bronze: 50 }
                if (score >= thresholds.gold) return { type: 'gold', label: 'Ø°Ù‡Ø¨ÙŠØ©' }; 
                if (score >= thresholds.silver) return { type: 'silver', label: 'ÙØ¶ÙŠØ©' }; 
                if (score >= thresholds.bronze) return { type: 'bronze', label: 'Ø¨Ø±ÙˆÙ†Ø²ÙŠØ©' }; 
                return null; // No medal
            }

            // --- STAR 1: DIAGNOSTIC ---
            const diagnostics = studentData.diagnostics || {};
            const diagnosticScore = diagnostics.d_best_weighted 
                ? robustParseFloat(diagnostics.d_best_weighted.grade) 
                : (studentData['Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ© Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø©'] ? robustParseFloat(studentData['Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ© Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø©']) : 0);
            
            const diagMedal = getMedalStatus(diagnosticScore, { gold: 95, silver: 75, bronze: 50 });
            
            let star1Html = '';
            if (diagMedal) {
                // Active 3D Star
                star1Html = `
                <div class="star-badge active" title="Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ: ${formatDecimal(diagnosticScore)}%">
                    ${getStarSVG(diagMedal.type)}
                    <span class="star-label">Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</span>
                    <span class="star-sublabel">${diagMedal.label}</span>
                    <div class="star-score-box" dir="ltr">${formatDecimal(diagnosticScore)}%</div>
                </div>`;
            } else {
                // Gray/Locked state for low score (FA Icon)
                star1Html = `
                <div class="star-badge" title="Ø¯Ø±Ø¬Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ Ù…Ù†Ø®ÙØ¶Ø©">
                    <i class="fas fa-star text-gray-300" style="font-size: 2.5rem;"></i>
                    <span class="star-label text-gray-400">Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</span>
                    <span class="star-sublabel text-red-500 font-bold">Ù„Ù… ÙŠØ³ØªØ­Ù‚</span>
                    <div class="star-score-box" dir="ltr">${formatDecimal(diagnosticScore)}%</div>
                </div>`;
            }

            // --- STAR 2: MASTERY ---
            let star2Html = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 1. Check Date First (Absolute Priority)
            const masteryDateStr = (studentData.lessonRules && studentData.lessonRules['star_mastery']) ? studentData.lessonRules['star_mastery'].value : null;
            let isMasteryLocked = true; // Default locked unless we prove it's open

            if (masteryDateStr) {
                const masteryDate = parseDateAsLocal(masteryDateStr);
                // Check if today is before the unlock date
                if (today < masteryDate) {
                    isMasteryLocked = true;
                } else {
                    isMasteryLocked = false;
                }
            } else {
                // If no date rule, fallback to locked (or could be unlocked, depending on business rule. Usually locked if not set)
                isMasteryLocked = true;
            }

            if (isMasteryLocked) {
                // SHOW LOCK UI WITH DATE
                const displayDate = masteryDateStr || "";
                star2Html = `
                <div class="star-badge" title="Ù„Ù… ÙŠØ­Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø¹Ø¯: ${displayDate}">
                    <i class="fas fa-lock" style="font-size: 2.5rem;"></i>
                    <span class="star-label text-gray-400">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>
                    <span class="star-sublabel text-gray-400" style="font-size:0.65rem; direction: ltr;">${displayDate}</span>
                </div>`;
            } else {
                // DATE IS OPEN - NOW CHECK SCORE
                const masteryFrozenRaw = studentData.masteryFrozen;
                const hasMasteryFrozen = (masteryFrozenRaw !== null && masteryFrozenRaw !== undefined && masteryFrozenRaw !== "");
                
                let finalMasteryScore = 0;
                
                if (hasMasteryFrozen) {
                    // Use Frozen Score
                    finalMasteryScore = parseFloat(masteryFrozenRaw) * 100;
                } else {
                    // Use Dynamic Calculation
                    finalMasteryScore = sheetInteractionScore;
                }

                const masteryMedal = getMedalStatus(finalMasteryScore, { gold: 85, silver: 55, bronze: 999 });

                if (masteryMedal) {
                     star2Html = `
                        <div class="star-badge active" title="${hasMasteryFrozen ? 'Ù†Ø³Ø¨Ø© Ù…Ø«Ø¨ØªØ©' : 'Ù†Ø³Ø¨Ø© ØªÙØ§Ø¹Ù„'}: ${formatDecimal(finalMasteryScore)}%">
                            ${getStarSVG(masteryMedal.type)}
                            <span class="star-label">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>
                            <span class="star-sublabel">${masteryMedal.label}</span>
                            <div class="star-score-box" dir="ltr">${formatDecimal(finalMasteryScore)}%</div>
                        </div>`;
                } else {
                     star2Html = `
                      <div class="star-badge" style="opacity:0.8">
                         <i class="fas fa-star text-gray-300" style="font-size: 2.5rem;"></i>
                         <span class="star-label">Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>
                         <span class="star-sublabel text-red-600 font-bold">Ù„Ù… ÙŠØ³ØªØ­Ù‚</span>
                         <div class="star-score-box" dir="ltr">${formatDecimal(finalMasteryScore)}%</div>
                      </div>`;
                }
            }

            // --- STAR 3: FINAL STAR (Ø§Ù„Ø®ØªØ§Ù… / Ù†Ø¬Ù… Ø§Ù„Ù…Ù†ØµØ©) ---
            let star3Html = '';
            
            // 1. Check Date First (Absolute Priority) 
            // Try 'star_final' first, then 'star_completion' as fallback
            const rules = studentData.lessonRules || {};
            const finalRule = rules['star_final'] || rules['star_completion'];
            const finalDateStr = finalRule ? finalRule.value : null;
            
            let isFinalLocked = true;

            if (finalDateStr) {
                if (finalRule.method === 'ÙŠØ¯ÙˆÙŠ' && finalRule.value === 'Ù…ÙØªÙˆØ­') {
                     isFinalLocked = false;
                } else {
                    const finalDate = parseDateAsLocal(finalDateStr);
                    if (today < finalDate) {
                        isFinalLocked = true;
                    } else {
                        isFinalLocked = false;
                    }
                }
            } else {
                isFinalLocked = true;
            }
            
            // Allow teacher access always
            if (studentData.role === 'teacher') isFinalLocked = false;

            if (isFinalLocked) {
                // SHOW LOCK UI WITH DATE
                const displayDate = finalDateStr || "";
                star3Html = `
                <div class="star-badge" title="Ù„Ù… ÙŠØ­Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø¹Ø¯: ${displayDate}">
                    <i class="fas fa-lock" style="font-size: 2.5rem;"></i>
                    <span class="star-label text-gray-400">Ø§Ù„Ø®ØªØ§Ù…</span>
                    <span class="star-sublabel text-gray-400" style="font-size:0.65rem; direction: ltr;">${displayDate}</span>
                </div>`;
            } else {
                // DATE IS OPEN - NOW CHECK SCORE
                // Note: We use 'finalFrozen' data if available (passed from GAS)
                // Also check 'completionFrozen' as a fallback just in case old data persists
                const finalFrozenRaw = studentData.finalFrozen || studentData.completionFrozen; 
                const hasFinalFrozen = (finalFrozenRaw !== null && finalFrozenRaw !== undefined && finalFrozenRaw !== "");
                
                let finalScore = 0;

                if (hasFinalFrozen) {
                    finalScore = parseFloat(finalFrozenRaw) * 100;
                } else {
                    finalScore = sheetInteractionScore; // Fallback to current calc
                }

                // Check Medal Status - UPDATED TO 95% GOLD, 80% SILVER
                const finalMedal = getMedalStatus(finalScore, { gold: 95, silver: 80, bronze: 999 });

                if (finalMedal) {
                     // Active Star
                     star3Html = `
                        <div class="star-badge active" title="${hasFinalFrozen ? 'Ù†Ø³Ø¨Ø© Ù…Ø«Ø¨ØªØ©' : 'Ù†Ø³Ø¨Ø© ØªÙØ§Ø¹Ù„'}: ${formatDecimal(finalScore)}%">
                            ${getStarSVG(finalMedal.type)}
                            <span class="star-label">Ø§Ù„Ø®ØªØ§Ù…</span>
                            <span class="star-sublabel">${finalMedal.label}</span>
                            <div class="star-score-box" dir="ltr">${formatDecimal(finalScore)}%</div>
                        </div>`;
                } else {
                     // Faded Star (Did not deserve)
                     star3Html = `
                        <div class="star-badge" style="opacity:0.8">
                            <i class="fas fa-star text-gray-300" style="font-size: 2.5rem;"></i>
                            <span class="star-label">Ø§Ù„Ø®ØªØ§Ù…</span>
                            <span class="star-sublabel text-red-600 font-bold">Ù„Ù… ÙŠØ³ØªØ­Ù‚</span>
                             <div class="star-score-box" dir="ltr">${formatDecimal(finalScore)}%</div>
                        </div>`;
                }
            }

            // Render Stars HTML Container
            const starsContainer = document.createElement('div');
            starsContainer.className = "flex justify-around mt-6 pt-4 border-t border-gray-200";
            starsContainer.innerHTML = star1Html + star2Html + star3Html;
            
            const diagnosticCard = document.getElementById('diagnostic-card');
            const existingStars = diagnosticCard.querySelector('.flex.justify-around.mt-6');
            if(existingStars) existingStars.remove();
            diagnosticCard.appendChild(starsContainer);


            // ... (Rest of logic for Progress Circle calculation to match new structure if needed) ...
            let totalUnlockedPossibleScoreCircle = 0;
            let totalUnlockedGainedScoreCircle = 0;
            let totalUnlockedLostScoreCircle = 0;
            let totalUnlockedAttemptedPossibleScoreCircle = 0;

            Object.values(curriculumIndex).forEach(chapter => {
                chapter.lessons.forEach(lesson => {
                    // ... Locking logic for circle ...
                    const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    if (rule) {
                        if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                        else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                            const d = parseDateAsLocal(rule.value);
                            const t = new Date(); t.setHours(0,0,0,0);
                            if (t >= d) { isLocked = false; }
                        }
                    } else { isLocked = false; }
                    if (studentData && studentData.role === 'teacher') { isLocked = false; }

                    if (!isLocked) {
                        const lessonMaxScore = lesson.maxScore || 10;
                        totalUnlockedPossibleScoreCircle += lessonMaxScore;
                        const lessonGrade = robustParseFloat(studentLessons[lesson.id]?.grade);
                        if (lessonGrade !== null) {
                            totalUnlockedGainedScoreCircle += lessonGrade;
                            totalUnlockedAttemptedPossibleScoreCircle += lessonMaxScore;
                        }
                        (lesson.games || []).forEach(game => {
                            const gameMaxScore = game.maxScore || 5;
                            totalUnlockedPossibleScoreCircle += gameMaxScore;
                            const gameGrade = robustParseFloat(studentGames[game.id]?.grade);
                            if (gameGrade !== null) {
                                totalUnlockedGainedScoreCircle += gameGrade;
                                totalUnlockedAttemptedPossibleScoreCircle += gameMaxScore;
                            }
                        });
                    }
                });
            });
            
            totalUnlockedLostScoreCircle = totalUnlockedAttemptedPossibleScoreCircle - totalUnlockedGainedScoreCircle;
            const masteryPercentageCircle = totalUnlockedPossibleScoreCircle > 0 ? Math.round(totalUnlockedGainedScoreCircle / totalUnlockedPossibleScoreCircle * 100) : 0;
            
            const needsImprovementPercent = totalUnlockedPossibleScoreCircle > 0 ? Math.round(totalUnlockedLostScoreCircle / totalUnlockedPossibleScoreCircle * 100) : 0;
            const pendingPercent = 100 - masteryPercentageCircle - needsImprovementPercent;

            const progressCircle = document.getElementById('overall-progress-circle');
            const masteryText = document.getElementById('mastery-percentage-text');
            const needsImprovementLegendText = document.getElementById('needs-improvement-legend-text');
            const pendingLegendText = document.getElementById('pending-legend-text');

            masteryText.textContent = `${masteryPercentageCircle}%`;
            needsImprovementLegendText.textContent = `ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ${needsImprovementPercent}%`;
            pendingLegendText.textContent = `Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ ${Math.max(0, pendingPercent)}%`;

            const gainedDegrees = totalUnlockedPossibleScoreCircle > 0 ? (totalUnlockedGainedScoreCircle / totalUnlockedPossibleScoreCircle) * 360 : 0;
            const needsImprovementDegrees = totalUnlockedPossibleScoreCircle > 0 ? (totalUnlockedLostScoreCircle / totalUnlockedPossibleScoreCircle) * 360 : 0;
            
            progressCircle.style.background = `conic-gradient(#22c55e 0deg ${gainedDegrees}deg, #ef4444 ${gainedDegrees}deg ${gainedDegrees + needsImprovementDegrees}deg, #a5b4fc ${gainedDegrees + needsImprovementDegrees}deg 360deg)`;

            // --- Achievement Bar Logic (UPDATED WITH PLATFORM STAR) ---
            const achievementContainer = document.getElementById('certificate-progress-container');
            if (achievementContainer) {
                const isParticipant = masteryPercentageCircle >= 55;
                const isExcellent = masteryPercentageCircle >= 85;
                const isPlatformStar = masteryPercentageCircle >= 95;

                achievementContainer.innerHTML = `
                <div class="w-full mt-6 pt-6 border-t border-gray-200 px-2">
                    <div class="relative h-4 bg-gray-200 rounded-full w-full mt-12 mb-12">
                        <!-- Progress Bar Fill -->
                        <div class="absolute top-0 right-0 h-full bg-gradient-to-l from-blue-400 to-blue-600 rounded-full transition-all duration-1000 shadow-sm flex items-center justify-center overflow-hidden" style="width: ${masteryPercentageCircle}%">
                             <span class="text-[10px] font-bold text-white px-1 truncate">${masteryPercentageCircle}%</span>
                        </div>
                        
                        <!-- Marker 1: Participant (55%) -->
                        <div class="absolute top-[-4px] right-[55%] w-0.5 h-6 bg-gray-400 z-10"></div>
                        <div class="absolute bottom-full mb-2 right-[55%] transform translate-x-1/2 flex flex-col items-center w-24">
                            <span class="text-[10px] font-bold bg-gray-100 border border-gray-200 px-1 py-0.5 rounded shadow-sm ${isParticipant ? 'text-green-600' : 'text-gray-500'}">Ø´Ù‡Ø§Ø¯Ø© Ù…Ø´Ø§Ø±Ùƒ</span>
                        </div>
                        <div class="absolute top-6 right-[55%] transform translate-x-1/2 flex flex-col items-center w-24">
                            <span class="text-[10px] font-bold text-gray-500">55% ÙØ£ÙƒØ«Ø±</span>
                        </div>

                        <!-- Marker 2: Excellent (85%) -->
                        <div class="absolute top-[-4px] right-[85%] w-0.5 h-6 bg-yellow-400 z-10"></div>
                        <div class="absolute bottom-full mb-2 right-[85%] transform translate-x-1/2 flex flex-col items-center w-24">
                            <span class="text-[10px] font-bold bg-yellow-50 border border-yellow-200 px-1 py-0.5 rounded shadow-sm ${isExcellent ? 'text-yellow-700' : 'text-gray-500'}">Ø´Ù‡Ø§Ø¯Ø© ØªÙ…ÙŠØ²</span>
                        </div>
                        <div class="absolute top-6 right-[85%] transform translate-x-1/2 flex flex-col items-center w-24">
                            <span class="text-[10px] font-bold text-gray-500">85% ÙØ£ÙƒØ«Ø±</span>
                        </div>

                        <!-- Marker 3: Platform Star (95%) -->
                        <div class="absolute top-[-4px] right-[95%] w-0.5 h-6 bg-purple-500 z-10"></div>
                        <div class="absolute bottom-full mb-8 right-[95%] transform translate-x-1/2 flex flex-col items-center w-28">
                            <span class="text-xs font-black bg-purple-100 border border-purple-300 px-2 py-1 rounded-full shadow-md ${isPlatformStar ? 'text-purple-800' : 'text-gray-400'}">ğŸŒŸ Ù†Ø¬Ù… Ø§Ù„Ù…Ù†ØµØ©</span>
                        </div>
                        <div class="absolute top-6 right-[95%] transform translate-x-1/2 flex flex-col items-center w-28">
                            <span class="text-[10px] font-bold text-purple-600">95% ÙØ£ÙƒØ«Ø±</span>
                        </div>
                    </div>
                </div>
                `;
            }
            
            const nextTaskForSpotlight = determineMusaidTasks(studentData).primaryTask;
            
            buildLearningPath(studentData, nextTaskForSpotlight);
            
            const dismissUntil = localStorage.getItem('dismissMusaidUntil');
            const musaidIsDismissed = dismissUntil && new Date().getTime() < parseInt(dismissUntil);

            if (determineMusaidTasks(studentData).primaryTask && !musaidIsDismissed) {
                showMusaidModal(determineMusaidTasks(studentData), calculateRemainingTasks(studentData));
            }
        }

        function fetchAndRenderLeaderboards(currentStudent) {
            const loader = document.getElementById('leaderboard-loader');
            const grid = document.getElementById('leaderboard-grid');
            loader.classList.remove('hidden');
            grid.classList.add('hidden');

            fetch(`${SCRIPT_URL}?action=getLeaderboardData&studentId=${currentStudent.id}&classId=${currentStudent.classIdentifier}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        const data = response.data;
                        grid.innerHTML = ''; 
                        // UPDATED: Title to "Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©" instead of "Ø£ÙˆØ§Ø¦Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„"
                        grid.appendChild(createLeaderboardCard('Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©', 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·', data.overallTop10, currentStudent.id, data.ranks.overall));
                        grid.appendChild(createLeaderboardCard(`Ø£ÙˆØ§Ø¦Ù„ ÙØµÙ„ ${currentStudent.class}`, 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·', data.classTop10, currentStudent.id, data.ranks.class));
                        grid.appendChild(createLeaderboardCard('Ø£ÙˆØ§Ø¦Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ', 'Ø§Ù„Ù…Ø¹Ø¯Ù„', data.diagnosticTop10, currentStudent.id, data.ranks.diagnostic, true));
                        loader.classList.add('hidden');
                        grid.classList.remove('hidden');
                    } else {
                        throw new Error(response.message || "Failed to load leaderboard data.");
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    loader.innerHTML = `<p class="text-red-500 font-semibold">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„.</p>`;
                });
        }

        function createLeaderboardCard(title, scoreLabel, data, currentStudentId, rank, isDiagnostic = false) {
            const card = document.createElement('div');
            card.className = 'leaderboard-card';
            const uniqueId = `leaderboard-${title.replace(/[\s/]/g, '-')}`;

            // Helper to calculate score percentage for the general leaderboard
            // Assuming totalPlatformMaxScore is calculated
            const getPercentage = (score) => {
                if (isDiagnostic) return score; // Diagnostic comes as percentage already or distinct metric
                if (totalPlatformMaxScore > 0) return (score / totalPlatformMaxScore) * 100;
                return 0;
            };

            // Calculate ranks considering ties
            let currentRank = 1;
            let previousScore = -1;
            let displayRankData = [];

            data.forEach((student, index) => {
                let studentScore = isDiagnostic ? student.diagnosticGrade : student.totalScore;
                
                // If score is different from previous, update rank to current index + 1 (Standard Competition Ranking) 
                // OR Dense Ranking (1, 1, 2)? 
                // User requirement: "If multiple students took 100%, record number 1 on all of them."
                // User also implies grouping. I will use Dense Ranking for simplicity in Star grouping (1, 1, 2, 2, 3...)
                // Actually, standard tie logic usually skips. Let's stick to: if score < previous, increment rank.
                if (index === 0) {
                    currentRank = 1;
                } else {
                    let prevStudentScore = isDiagnostic ? data[index-1].diagnosticGrade : data[index-1].totalScore;
                    if (studentScore < prevStudentScore) {
                        currentRank = index + 1; // Standard Competition Ranking (1, 1, 3)
                        // Or Dense? currentRank++; (1, 1, 2). 
                        // "Record number 1 on all of them" supports ties.
                        // Let's use Standard Ranking as it is fair for "Top 10" lists.
                    }
                }
                displayRankData.push({ ...student, rank: currentRank });
            });

            // UPDATED: Removed slicing to show all data received from backend (which is now 100)
            let tableRows = displayRankData.map((student) => {
                const isCurrentUser = student.id.toString() === currentStudentId.toString();
                let scoreDisplay;
                let scoreVal;
                
                if (isDiagnostic) {
                    scoreVal = student.diagnosticGrade;
                    scoreDisplay = `<div><span class="font-bold">${formatDecimal(student.diagnosticGrade)}%</span><span class="block text-xs text-gray-500 font-normal">${student.diagnosticPoints} Ù†Ù‚Ø·Ø©</span></div>`;
                } else {
                    scoreVal = getPercentage(student.totalScore);
                    scoreDisplay = `<span class="font-bold">${formatDecimal(student.totalScore)}</span>`;
                }

                // STAR RANK LOGIC
                let rankDisplay = `<span class="rank-simple-number">#${student.rank}</span>`;
                
                // Only apply stars for General Leaderboard (not diagnostic necessarily unless requested, but logic applies nicely)
                // Thresholds: Gold >= 95%, Silver >= 80%
                if (!isDiagnostic) {
                    if (scoreVal >= 95) {
                        rankDisplay = `<div class="rank-star-container" title="Ù†Ø¬Ù… Ù…Ù†ØµØ© Ø°Ù‡Ø¨ÙŠ"><i class="fas fa-star rank-star-icon rank-star-gold"></i><span class="rank-star-number text-yellow-900">${student.rank}</span></div>`;
                    } else if (scoreVal >= 80) {
                        rankDisplay = `<div class="rank-star-container" title="Ù†Ø¬Ù… Ù…Ù†ØµØ© ÙØ¶ÙŠ"><i class="fas fa-star rank-star-icon rank-star-silver"></i><span class="rank-star-number text-gray-800">${student.rank}</span></div>`;
                    }
                } else {
                    // Apply similar logic for Diagnostic
                    if (scoreVal >= 95) {
                        rankDisplay = `<div class="rank-star-container"><i class="fas fa-star rank-star-icon rank-star-gold"></i><span class="rank-star-number text-yellow-900">${student.rank}</span></div>`;
                    } else if (scoreVal >= 80) {
                        rankDisplay = `<div class="rank-star-container"><i class="fas fa-star rank-star-icon rank-star-silver"></i><span class="rank-star-number text-gray-800">${student.rank}</span></div>`;
                    }
                }

                // Keep showing only top 5 initially, hide the rest
                const hiddenClass = displayRankData.indexOf(student) >= 5 ? 'expandable-row hidden' : ''; 
                
                return `<tr class="${isCurrentUser ? 'current-student' : ''} ${hiddenClass}" data-table-id="${uniqueId}">
                            <td class="rank">${rankDisplay}</td>
                            <td>${student.name} <span class="text-sm text-gray-500">(${student.class})</span></td>
                            <td class="score">${scoreDisplay}</td>
                        </tr>`;
            }).join('');

            const rankCard = rank > 0 ? `<div class="current-student-rank-card">Ù…Ø±ÙƒØ²Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${rank}</div>` : '';
            // Show expand button if more than 5 rows
            const expandButton = data.length > 5 ? `<button onclick="toggleLeaderboard(this, '${uniqueId}')" class="expand-leaderboard-btn">ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ <i class="fas fa-chevron-down ml-1"></i></button>` : '';

            card.innerHTML = `<h3 class="leaderboard-title">${title}</h3><table class="leaderboard-table"><thead><tr><th>Ø§Ù„ØªØ±ØªÙŠØ¨</th><th>Ø§Ù„Ø§Ø³Ù…</th><th class="score">${scoreLabel}</th></tr></thead><tbody>${tableRows}</tbody></table>${expandButton}${rankCard}`;
            return card;
        }

        window.toggleLeaderboard = (button, tableId) => {
            const rows = document.querySelectorAll(`.expandable-row[data-table-id="${tableId}"]`);
            if (!rows.length) return;
            const isHidden = rows[0].classList.contains('hidden');
            rows.forEach(row => row.classList.toggle('hidden'));
            button.innerHTML = isHidden ? 'Ø¥Ø®ÙØ§Ø¡ <i class="fas fa-chevron-up ml-1"></i>' : 'ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ <i class="fas fa-chevron-down ml-1"></i>';
        };

        function buildLearningPath(studentData, nextTask = null) {
            const learningPathContainer = document.getElementById('learning-path-section');
            const studentLessons = studentData.lessons || {};
            const studentGames = studentData.games || {};
            const lessonRules = studentData.lessonRules || {};

            learningPathContainer.innerHTML = `<div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h2 class="text-3xl font-bold text-blue-800">Ù…Ø³Ø§Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² ÙˆØ§Ù„ØªØ¹Ù„Ù…</h2>
                    <button id="recall-musaid-btn" class="recall-musaid-btn" title="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ">ğŸ’¡</button>
                </div>
                <div class="flex flex-wrap gap-x-4 gap-y-2 mt-4 sm:mt-0 text-sm text-gray-600 font-semibold bg-gray-200 px-3 py-2 rounded-lg">
                    <span><i class="fas fa-trophy text-yellow-500"></i> Ø¥ØªÙ‚Ø§Ù†</span>
                    <span><i class="fas fa-check text-green-500"></i> Ø¬ÙŠØ¯</span>
                    <span><i class="fas fa-sync-alt text-red-500"></i> ØªØ­Ø³ÙŠÙ†</span>
                    <span><i class="fas fa-circle-notch text-gray-500"></i> Ù„Ù… ÙŠØ¨Ø¯Ø£</span>
                    <span><i class="fas fa-lock text-gray-500"></i> Ù…ØºÙ„Ù‚</span>
                </div>
            </div>`;
            
            document.getElementById('recall-musaid-btn').addEventListener('click', () => {
                localStorage.removeItem('dismissMusaidUntil');
                updateMusaidIconState(); 
                const student = getStudentFromStorage();
                const musaidTasks = determineMusaidTasks(student);
                const stats = calculateRemainingTasks(student);
                if (musaidTasks.primaryTask) {
                    showMusaidModal(musaidTasks, stats);
                }
            });
            
            updateMusaidIconState();

            Object.keys(curriculumIndex).forEach((chapterKey) => {
                const chapter = curriculumIndex[chapterKey];
                let lessonSummariesHtml = '';
                const lessonsHtml = chapter.lessons.map((lesson, index) => {
                    const lessonData = studentLessons[lesson.id];
                    const lessonGrade = robustParseFloat(lessonData?.grade);
                    
                    const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    let unlockDate = null;

                    if (rule) {
                        if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                        else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                            const today = new Date();
                            const openDate = parseDateAsLocal(rule.value);
                            today.setHours(0, 0, 0, 0);
                            if (today >= openDate) { isLocked = false; } else { unlockDate = rule.value; }
                        }
                    } else { isLocked = false; }
                    
                    if (studentData && studentData.role === 'teacher') { isLocked = false; unlockDate = null; }

                    const game1 = lesson.games && lesson.games[0] ? lesson.games[0] : null;
                    const game1Data = game1 ? studentGames[game1.id] : null;
                    const game1Grade = robustParseFloat(game1Data?.grade);
                    const game2 = lesson.games && lesson.games[1] ? lesson.games[1] : null;
                    const game2Data = game2 ? studentGames[game2.id] : null;
                    const game2Grade = robustParseFloat(game2Data?.grade);

                    lessonSummariesHtml += buildSummaryBox(lesson, index, { lessonGrade, game1Grade, game2Grade }, studentData, isLocked);

                    const allGrades = [{ grade: lessonGrade, maxScore: lesson.maxScore }];
                    if(game1) allGrades.push({ grade: game1Grade, maxScore: game1.maxScore });
                    if(game2) allGrades.push({ grade: game2Grade, maxScore: game2.maxScore });

                    const { state, icon } = isLocked 
                        ? { state: 'locked', icon: 'fa-lock' } 
                        : getCheckpointPerformance(allGrades);

                    let gradeHtml = `<span class="lesson-grade">${lessonGrade !== null ? `${formatDecimal(lessonGrade)}/${lesson.maxScore}`: 'Ù„Ù… ÙŠØªÙ…'}</span>`;
                    
                    const lessonLink = studentData.id ? `lessons/${lesson.id}.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}` : `lessons/${lesson.id}.html`;
                    
                    const isLessonSpotlight = nextTask && nextTask.type === 'lesson' && nextTask.details.id === lesson.id;
                    const lessonSpotlightText = isLessonSpotlight ? "Ø§Ø¨Ø¯Ø£ Ù‡Ù†Ø§" : "";
                    
                    const lessonTestHtml = `<a id="lesson-card-${lesson.id}" href="${lessonLink}" target="_top" class="lesson-test-card ${isLessonSpotlight ? 'spotlight' : ''}">
                        ${isLessonSpotlight ? `<div class="start-here-badge">${lessonSpotlightText}</div>` : ''}
                        <span class="text-3xl ml-4">ğŸ“–</span>
                        <span class="lesson-title flex-grow">${lesson.title}</span>
                        ${gradeHtml}
                    </a>`;

                    const gamesHtml = (lesson.games || []).map(game => {
                        const gameGrade = robustParseFloat(studentGames[game.id]?.grade);
                        
                        const isGameSpotlight = nextTask && nextTask.type === 'game' && nextTask.details.id === game.id;
                        const gameSpotlightText = isGameSpotlight ? "Ø§Ø¨Ø¯Ø£ Ù‡Ù†Ø§" : "";
                        const gameStartBadge = isGameSpotlight ? `<div class="start-here-badge" style="font-size: 0.7rem; top: -10px; right: -10px; left: auto;">${gameSpotlightText}</div>` : '';

                        return `<div id="game-${game.id}" onclick="openGameModal('${game.id}')" class="game-card ${isGameSpotlight ? 'spotlight' : ''}">
                                    ${gameStartBadge}
                                    <div class="game-icon-badge">ğŸ®</div>
                                    <div class="game-title">${game.title}</div>
                                    <div class="game-grade">${gameGrade !== null ? `${formatDecimal(gameGrade)} / ${game.maxScore}` : '- / -'} ${gameGrade === game.maxScore ? '<i class="fas fa-star text-yellow-400 ml-1"></i>' : ''}</div>
                                </div>`;
                    }).join('');

                    const unlockDateHtml = unlockDate ? `<div class="unlock-date">${unlockDate} :ÙŠÙØªØ­ Ø¨ØªØ§Ø±ÙŠØ®</div>` : '';

                    return `<div id="lesson-${lesson.id}" class="lesson-checkpoint ${state}">
                                <div class="checkpoint-icon"><i class="fas ${icon}"></i></div>
                                <div class="checkpoint-content">
                                    <div class="lesson-card">
                                        ${lessonTestHtml}
                                        ${gamesHtml ? `<div class="games-grid">${gamesHtml}</div>` : ''}
                                        ${unlockDateHtml}
                                    </div>
                                </div>
                            </div>`;
                }).join('');

                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-card mb-4';
                chapterCard.innerHTML = `<div class="chapter-card-header"><div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-blue-800">${chapter.title}</h3><i class="fas fa-chevron-down text-2xl text-gray-400 expand-icon"></i></div><div class="lesson-summary-grid">${lessonSummariesHtml}</div></div><div class="chapter-lessons-container"><div class="lessons-path">${lessonsHtml}</div></div>`;
                learningPathContainer.appendChild(chapterCard);
                chapterCard.querySelector('.chapter-card-header').addEventListener('click', (e) => {
                    if (!e.target.closest('.lesson-summary-box')) {
                        chapterCard.classList.toggle('expanded');
                    }
                });
                
                if(nextTask && chapter.lessons.some(l => (nextTask.type === 'lesson' && l.id === nextTask.details.id) || (nextTask.type === 'game' && l.id === nextTask.parentLessonId))){
                    chapterCard.classList.add('expanded');
                }
            });
        }
        
        function getCheckpointPerformance(grades) {
            if (grades.some(g => g.grade === null)) {
                return { state: 'not-started', icon: 'fa-book-open' };
            }

            let totalGrade = 0;
            let totalMaxScore = 0;
            grades.forEach(g => {
                totalGrade += g.grade;
                totalMaxScore += g.maxScore;
            });

            if (totalGrade === totalMaxScore) {
                return { state: 'excellent', icon: 'fa-trophy' };
            }
            
            if (grades.some(g => g.grade < g.maxScore / 2)) {
                 return { state: 'improve', icon: 'fa-sync-alt' };
            }

            return { state: 'good', icon: 'fa-check' };
        }

        function updateMusaidIconState() {
            const recallBtn = document.getElementById('recall-musaid-btn');
            if (!recallBtn) return;

            const dismissUntil = localStorage.getItem('dismissMusaidUntil');
            const isDismissed = dismissUntil && new Date().getTime() < parseInt(dismissUntil);

            if (isDismissed) {
                recallBtn.classList.add('musaid-dismissed');
                recallBtn.title = "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ (Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹)";
            } else {
                recallBtn.classList.remove('musaid-dismissed');
                recallBtn.title = "Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ";
            }
        }

        function isTaskSetComplete(lesson, studentData) {
            if (!lesson) return true;
            const { lessons = {}, games = {} } = studentData;

            if (robustParseFloat(lessons[lesson.id]?.grade) === null) {
                return false;
            }
            for (const game of (lesson.games || [])) {
                if (robustParseFloat(games[game.id]?.grade) === null) {
                    return false;
                }
            }
            return true;
        }

        function findFirstIncompleteInSet(lesson, studentData) {
             if (!lesson) return null;
             const { lessons = {}, games = {} } = studentData;
             
             if (robustParseFloat(lessons[lesson.id]?.grade) === null) {
                 return { type: 'lesson', details: lesson };
             }
             
             for (const game of (lesson.games || [])) {
                 if (robustParseFloat(games[game.id]?.grade) === null) {
                      return { type: 'game', details: game, parentLessonId: lesson.id };
                 }
             }
             return null;
        }

        function findOldestUncompletedTask(studentData) {
            const { lessons: studentLessons = {}, games: studentGames = {}, lessonRules = {} } = studentData;

            for (const chapterKey of Object.keys(curriculumIndex)) {
                for (const lesson of curriculumIndex[chapterKey].lessons) {
                    const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    if (rule) {
                        if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                        else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                            const today = new Date(); 
                            const openDate = parseDateAsLocal(rule.value);
                            today.setHours(0, 0, 0, 0);
                            if (today >= openDate) { isLocked = false; }
                        }
                    } else { isLocked = false; }
                    if (studentData && studentData.role === 'teacher') { isLocked = false; }

                    if (!isLocked) {
                        if (robustParseFloat(studentLessons[lesson.id]?.grade) === null) {
                            return { type: 'lesson', details: lesson };
                        }
                        for (const game of (lesson.games || [])) {
                            if (robustParseFloat(studentGames[game.id]?.grade) === null) {
                                return { type: 'game', details: game, parentLessonId: lesson.id };
                            }
                        }
                    }
                }
            }
            return null;
        }

        function determineMusaidTasks(studentData) {
            if (!studentData) return { primaryTask: null, secondaryTask: null, messageType: 'none' };

            const { diagnostics = {}, lessonRules = {}, role } = studentData;

            if (!diagnostics.d_best_weighted && !diagnostics.d_test_overall) {
                return {
                    primaryTask: { type: 'diagnostic', details: { title: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ', id: 'diagnostic' } },
                    secondaryTask: null,
                    messageType: 'diagnostic'
                };
            }

            const oldestUncompletedTask = findOldestUncompletedTask(studentData);

            const unlockedLessons = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            Object.values(curriculumIndex).forEach(chapter => {
                chapter.lessons.forEach(lesson => {
                    const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    if (rule) {
                        if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                        else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                            const openDate = parseDateAsLocal(rule.value);
                            if (today >= openDate) { isLocked = false; }
                        }
                    } else { isLocked = false; }
                    if (role === 'teacher') { isLocked = false; }

                    if (!isLocked) {
                        unlockedLessons.push(lesson);
                    }
                });
            });

            const newestLesson = unlockedLessons.length > 0 ? unlockedLessons[unlockedLessons.length - 1] : null;
            const previousLesson = unlockedLessons.length > 1 ? unlockedLessons[unlockedLessons.length - 2] : null;

            const isPreviousComplete = isTaskSetComplete(previousLesson, studentData);
            const isNewestComplete = isTaskSetComplete(newestLesson, studentData);

            if (previousLesson && !isPreviousComplete) {
                return {
                    primaryTask: findFirstIncompleteInSet(previousLesson, studentData),
                    secondaryTask: oldestUncompletedTask,
                    messageType: 'complete-previous'
                };
            }

            if (newestLesson && !isNewestComplete) {
                return {
                    primaryTask: findFirstIncompleteInSet(newestLesson, studentData),
                    secondaryTask: oldestUncompletedTask,
                    messageType: 'do-new'
                };
            }

            if (oldestUncompletedTask) {
                return {
                    primaryTask: oldestUncompletedTask,
                    secondaryTask: null, 
                    messageType: 'complete-oldest'
                };
            }

            return { primaryTask: null, secondaryTask: null, messageType: 'all-done' };
        }

        function calculateRemainingTasks(studentData) {
            let remainingLessons = 0;
            let remainingGames = 0;
            const studentLessons = studentData.lessons || {};
            const studentGames = studentData.games || {};
            const lessonRules = studentData.lessonRules || {};

             for (const chapterKey of Object.keys(curriculumIndex)) {
                 for (const lesson of curriculumIndex[chapterKey].lessons) {
                        const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    if (rule) {
                        if (rule.method === 'ÙŠØ¯ÙˆÙŠ' && rule.value === 'Ù…ÙØªÙˆØ­') { isLocked = false; }
                        else if (rule.method === 'ØªØ§Ø±ÙŠØ®') {
                            const today = new Date(); 
                            const openDate = parseDateAsLocal(rule.value);
                            today.setHours(0, 0, 0, 0);
                            if (today >= openDate) { isLocked = false; }
                        }
                    } else { isLocked = false; }
                    if (studentData && studentData.role === 'teacher') { isLocked = false; }

                    if(!isLocked) {
                        if (robustParseFloat(studentLessons[lesson.id]?.grade) === null) {
                            remainingLessons++;
                        }
                        for (const game of (lesson.games || [])) {
                             if (robustParseFloat(studentGames[game.id]?.grade) === null) {
                                  remainingGames++;
                             }
                        }
                    }
                 }
             }
            return { remainingLessons, remainingGames };
        }

        function showMusaidModal(musaidTasks, stats) {
            const { primaryTask, secondaryTask, messageType } = musaidTasks;
            if (!primaryTask) return;

            let taskTitle = primaryTask.details.title;
            let icon = 'ğŸ¯';
            let taskTypeMessage = '';
            let actionButtonText = 'ğŸš€ Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†';

            switch (messageType) {
                case 'diagnostic':
                    taskTypeMessage = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù‡ÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ:';
                    icon = 'ğŸš€';
                    actionButtonText = 'ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†';
                    break;
                case 'complete-previous':
                    taskTypeMessage = 'Ø§Ù†ØªØ¨Ù‡! Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ø§Ù… Ø³Ø§Ø¨Ù‚Ø© Ù„Ù… ØªÙƒØªÙ…Ù„Ù‡Ø§. Ù…Ù‡Ù…ØªÙƒ Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¢Ù† Ù‡ÙŠ:';
                    icon = 'âš ï¸';
                    break;
                case 'do-new':
                    taskTypeMessage = 'Ø£Ø­Ø³Ù†Øª! Ù…Ù‡Ù…ØªÙƒ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ:';
                    icon = 'âœ¨';
                    break;
                case 'complete-oldest':
                    taskTypeMessage = 'Ø±Ø§Ø¦Ø¹! Ø£Ù†Øª Ù…ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø£Ø®ÙŠØ±Ø©. Ù„Ø§Ø­Ø¸Ù†Ø§ Ø£Ù† Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ù…Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù… ØªÙ†Ù‡Ù‡Ø§:';
                    icon = 'ğŸ§';
                    break;
                default: 
                    taskTypeMessage = 'Ù…Ù‡Ù…ØªÙƒ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù‡ÙŠ:';
            }

            const musaidBody = musaidModal.querySelector('#musaid-modal-body');
            const musaidFooter = musaidModal.querySelector('#musaid-modal-footer');
            const musaidHeader = musaidModal.querySelector('#musaid-modal-header');

            musaidHeader.querySelector('.emoji-icon').textContent = icon;
            musaidBody.innerHTML = `<p>${taskTypeMessage}</p>
                <p class="task-name">${taskTitle}</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.remainingLessons}</div>
                        <div class="stat-label">Ø¯Ø±ÙˆØ³ Ù…ØªØ¨Ù‚ÙŠØ©</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.remainingGames}</div>
                        <div class="stat-label">Ù„Ø¹Ø¨Ø© Ù…ØªØ¨Ù‚ÙŠØ©</div>
                    </div>
                </div>`;
            
            let secondaryTaskHtml = '';
            if (secondaryTask && secondaryTask.details.id !== primaryTask.details.id) {
                secondaryTaskHtml = `<button id="musaid-secondary-btn" class="secondary-action-btn">Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ø§Ù… Ù‚Ø¯ÙŠÙ…Ø©.. Ø§Ø°Ù‡Ø¨ Ù„Ø£ÙˆÙ„Ù‡Ø§</button>`;
            }
            
            musaidFooter.innerHTML = `
                <button id="musaid-action-btn" class="action-btn">${actionButtonText}</button>
                <div class="mt-3">${secondaryTaskHtml}</div>
                <button id="musaid-dismiss-btn" class="dismiss-btn">ğŸ‘ Ø­Ø³Ù†Ù‹Ø§ØŒ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„ÙŠÙˆÙ…</button>`;
            
            document.getElementById('musaid-action-btn').onclick = () => goToTaskAndCloseModal(primaryTask, "Ø§Ø¨Ø¯Ø£ Ù‡Ù†Ø§");
            
            if (secondaryTaskHtml) {
                document.getElementById('musaid-secondary-btn').onclick = () => goToTaskAndCloseModal(secondaryTask, "Ø£ÙƒÙ…Ù„ Ù‡Ù†Ø§");
            }

            document.getElementById('musaid-dismiss-btn').onclick = dismissMusaidForToday;

            musaidModal.classList.remove('hidden');
        }

        function goToTaskAndCloseModal(task, badgeText) {
            musaidModal.classList.add('hidden');
            let url;
            if (task.type === 'diagnostic') {
                const student = getStudentFromStorage();
                if (student) {
                    url = `diagnostic.html?studentId=${student.id}&classId=${student.classIdentifier}`;
                    window.open(url, '_top');
                }
                return;
            }

            document.querySelectorAll('.spotlight').forEach(el => el.classList.remove('spotlight'));
            document.querySelectorAll('.start-here-badge').forEach(badge => badge.remove());

            let elementId = task.type === 'lesson' ? `lesson-card-${task.details.id}` : `game-${task.details.id}`;
            const element = document.getElementById(elementId);

            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('spotlight');
                
                const badge = document.createElement('div');
                badge.className = 'start-here-badge';
                badge.textContent = badgeText;
                
                if (task.type === 'game') {
                    badge.style.cssText = 'font-size: 0.7rem; top: -10px; right: -10px; left: auto;';
                }
                
                element.appendChild(badge);

                const chapterCard = element.closest('.chapter-card');
                if (chapterCard && !chapterCard.classList.contains('expanded')) {
                    chapterCard.classList.add('expanded');
                }
            }
        }

        function dismissMusaidForToday() {
            const now = new Date();
            const expiry = now.getTime() + 24 * 60 * 60 * 1000;
            localStorage.setItem('dismissMusaidUntil', expiry);
            musaidModal.classList.add('hidden');
            updateMusaidIconState();
        }
        
        function buildSummaryBox(lesson, index, grades, studentData, isLocked) {
            const { lessonGrade, game1Grade, game2Grade } = grades;
            const lessonIcon = isLocked ? 'fa-lock' : getPerformanceIcon(lessonGrade, lesson.maxScore);
            const game1 = lesson.games && lesson.games[0];
            const game2 = lesson.games && lesson.games[1];
            const game1Icon = isLocked ? 'fa-lock' : (game1 ? getPerformanceIcon(game1Grade, game1.maxScore) : 'fa-times');
            const game2Icon = isLocked ? 'fa-lock' : (game2 ? getPerformanceIcon(game2Grade, game2.maxScore) : 'fa-times');
            const lessonLink = studentData.id ? `lessons/${lesson.id}.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}` : `lessons/${lesson.id}.html`;
            let content = `<a href="${lessonLink}" target="_top" class="top-part" title="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø±Ø³"><span class="lesson-number">${index + 1}</span><i class="fas ${lessonIcon} summary-icon"></i></a><div class="bottom-part"><a href="#" onclick="openGameModal('${game1 ? game1.id : ''}'); return false;" title="${game1 ? game1.title : ''}"><i class="fas ${game1Icon} summary-icon"></i></a><a href="#" onclick="openGameModal('${game2 ? game2.id : ''}'); return false;" title="${game2 ? game2.title : ''}"><i class="fas ${game2Icon} summary-icon"></i></a></div>`;
            return `<div class="lesson-summary-box ${isLocked ? 'locked' : ''}" title="${isLocked ? 'Ø§Ù„Ø¯Ø±Ø³ Ù…ØºÙ„Ù‚' : lesson.title}">${content}</div>`;
        }

        function getPerformanceIcon(grade, maxScore) { 
            if (grade === null) return 'fa-circle-notch'; 
            const numericGrade = parseFloat(grade);
            if (numericGrade === maxScore) return 'fa-trophy'; 
            if (numericGrade >= maxScore / 2) return 'fa-check'; 
            return 'fa-sync-alt'; 
        }

        function renderTestCard(studentData) {
            const card = document.getElementById('diagnostic-card');
            const diagnostics = studentData.diagnostics || {};
            const diagnosticLink = `diagnostic.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}`;
            if (diagnostics.d_best_weighted !== undefined) {
                const scoreData = diagnostics.d_best_weighted;
                const score = robustParseFloat(scoreData?.grade) ?? 0;
                const scoreColor = score >= 80 ? 'text-green-600' : (score >= 50 ? 'text-yellow-600' : 'text-red-600');
                const totalPoints = scoreData?.metricValue ?? 'N/A';
                card.innerHTML = `<h4 class="text-xl font-bold text-purple-700 mb-3">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</h4><div class="flex justify-around items-center text-center p-3 bg-purple-50 rounded-lg"><div><p class="text-sm font-bold text-gray-500 mb-1">Ø§Ù„Ù…Ø¹Ø¯Ù„</p><span class="text-3xl font-extrabold ${scoreColor}">${formatDecimal(score)}%</span></div><div class="border-r border-purple-200 h-10 mx-2"></div><div><p class="text-sm font-bold text-gray-500 mb-1">Ø§Ù„Ù†Ù‚Ø§Ø·</p><span class="text-3xl font-extrabold text-purple-800">${totalPoints}</span></div></div><a href="${diagnosticLink}" target="_top" class="mt-4 w-full text-center block bg-purple-100 text-purple-800 font-bold py-2 rounded-lg hover:bg-purple-200 transition-colors">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</a>`;
            } else {
                card.innerHTML = `<h4 class="text-xl font-bold text-purple-700 mb-2">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ</h4><p class="text-gray-600 my-4 text-center font-semibold">Ù„Ù… ÙŠØªÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯.</p><a href="${diagnosticLink}" target="_top" class="w-full text-center block bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors shadow-md hover:shadow-lg">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</a>`;
            }
        }
        
        window.openGameModal = (gameId) => {
            if (!gameId || gameId === 'null') return;
            const student = getStudentFromStorage();
            if (!student) {
                const attempts = JSON.parse(localStorage.getItem('visitorGameAttempts') || '{}');
                const gameAttempts = attempts[gameId] || 0;
                if (gameAttempts >= VISITOR_MAX_ATTEMPTS) {
                    const body = document.querySelector('body');
                    const msgBox = document.createElement('div');
                    msgBox.textContent = `Ù„Ù‚Ø¯ Ø§Ø³ØªÙ†ÙØ¯Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (${VISITOR_MAX_ATTEMPTS}). ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.`;
                    msgBox.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 1rem; border-radius: 0.5rem; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                    body.appendChild(msgBox);
                    setTimeout(() => body.removeChild(msgBox), 4000);
                    return;
                }
            }
            const gameSrc = student ? `games/${gameId}.html?studentId=${student.id}&classId=${student.classIdentifier}` : `games/${gameId}.html`;
            gameIframe.src = gameSrc;
            gameModal.classList.remove('hidden');
        };
        
        function closeGameModal() {
            gameModal.classList.add('hidden');
            gameIframe.src = 'about:blank';
            const student = getStudentFromStorage();
            if (student) { refreshStudentData(student.id, student.classIdentifier); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const student = getStudentFromStorage();

            if (student && student.id && student.classIdentifier) {
                refreshStudentData(student.id, student.classIdentifier);
            } else {
                if (preloader) preloader.style.display = 'none';
                switchView('login');
                buildFooter();
            }
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('login-id').value.trim();
                if (studentId) { handleLogin(studentId); }
            });

            document.getElementById('visitor-btn').addEventListener('click', () => {
                localStorage.removeItem('currentStudent');
                renderAppContent(null);
                switchView('app');
            });

            studentDataTab.addEventListener('click', () => switchDashboardTab('student'));
            leaderboardTab.addEventListener('click', () => switchDashboardTab('leaderboard'));

            modalCloseBtn.addEventListener('click', closeGameModal);
            closeDiagnosticModalBtn.addEventListener('click', () => diagnosticModal.classList.add('hidden'));

            window.addEventListener('message', (event) => {
                if (event.data && event.data.event === 'gameFinished') {
                    const student = getStudentFromStorage();
                    if (!student && event.data.gameId) {
                        const attempts = JSON.parse(localStorage.getItem('visitorGameAttempts') || '{}');
                        attempts[event.data.gameId] = (attempts[event.data.gameId] || 0) + 1;
                        localStorage.setItem('visitorGameAttempts', JSON.stringify(attempts));
                    }
                    closeGameModal();
                }
            });
        });
    })();
    </script>
</body>
</html>

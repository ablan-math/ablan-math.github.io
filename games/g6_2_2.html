<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ V19.6 - ÙÙˆØ±Ù…ÙˆÙ„Ø§ Ø§Ù„Ù‚Ø³Ù…Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 420px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; height: 96vh; max-height: 900px; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 6px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b; flex-shrink: 0;
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ */
        .leaderboard-modal { 
            position: absolute; inset: 0; background: #ffffff; z-index: 100; 
            display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; 
        }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        
        .rank-row-me { background-color: #eff6ff !important; border-right: 4px solid #2563eb !important; }
        
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .leaderboard-name { color: #1e293b; font-weight: 800; font-size: 11px; }
        .leaderboard-rank { font-weight: 900; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„ÙƒØ³ÙˆØ± */
        canvas { display: block; width: 100%; height: 100%; border-radius: 1rem; cursor: pointer; }
        .hud-panel {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 8px 20px;
            border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center; border: 2px solid #e2e8f0; width: 90%;
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
            z-index: 20;
        }
        
        .fraction-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            font-size: 1.5rem;
            font-weight: 900;
            color: #1e293b;
            margin: 0 2px;
            direction: rtl; 
        }
        .fraction-top {
            border-bottom: 3px solid #1e293b;
            padding: 2px 4px;
            line-height: 1;
            width: 100%;
            text-align: center;
        }
        .fraction-bottom {
            padding: 2px 4px;
            line-height: 1;
            width: 100%;
            text-align: center;
        }
        sup {
            font-size: 0.75em;
            font-weight: 800;
            vertical-align: super;
            margin-right: 2px;
        }

        .power-wrapper {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            color: #1e293b;
            direction: rtl; 
        }
        .big-paren {
            font-size: 2.2rem;
            font-weight: 300;
            color: #475569;
            margin-bottom: 4px;
        }

        .hud-score { width: 100%; font-size: 0.8rem; font-weight: bold; color: #64748b; margin-top: 4px; display: flex; justify-content: space-between; direction: rtl;}
        
        .control-area { display: none; } 

        #level-transition-screen {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #level-transition-screen.active { opacity: 1; pointer-events: auto; }
        .level-title { font-size: 2rem; font-weight: 900; color: #2563eb; margin-bottom: 10px; }
        .level-subtitle { font-size: 1rem; color: #64748b; font-weight: bold; }
        .level-score-badge { 
            background: #f0f9ff; color: #0369a1; padding: 8px 20px; 
            border-radius: 99px; font-weight: 800; border: 2px solid #bae6fd;
            margin-bottom: 15px; font-size: 1.1rem;
        }
        
        .turbo-active #gameCanvas {
            box-shadow: 0 0 15px #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-3 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-blue-500"></i>
                <span id="top-student-name" class="truncate font-black"></span>
                <script>
                    (function() {
                        const p = new URLSearchParams(window.location.search);
                        const raw = p.get('name') || p.get('studentName') || p.get('username') || p.get('user');
                        document.getElementById('top-student-name').textContent = raw ? decodeURIComponent(raw) : "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ";
                    })();
                </script>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-4 h-full justify-center relative z-10 bg-white">
            <div class="w-24 h-24 bg-blue-100 rounded-full mx-auto flex items-center justify-center mb-2">
                <i class="fas fa-flag-checkered text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-800">ÙÙˆØ±Ù…ÙˆÙ„Ø§ Ø§Ù„Ù‚Ø³Ù…Ø©</h1>
            <h2 class="text-sm font-bold text-slate-500 -mt-2">Ù‚Ø³Ù…Ø© ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ (Ù¥ Ù…Ø³ØªÙˆÙŠØ§Øª)</h2>
            
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-[11px] font-bold text-blue-700 leading-relaxed text-center">
                <p class="mb-2">ØªØ¯Ø±Ø¬ ÙÙŠ Ø§Ù„ØµØ¹ÙˆØ¨Ø© Ø¹Ø¨Ø± Ù¥ Ù…Ø³ØªÙˆÙŠØ§Øª! Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.</p>
                <p class="text-red-500 bg-red-50 p-1 rounded font-black border border-red-100">
                    <i class="fas fa-tachometer-alt"></i> ØªÙ„Ù…ÙŠØ­: Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ø¶ØºØ· Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©!
                </p>
            </div>
            
            <div class="flex flex-row gap-2 items-stretch mt-4">
                <button onclick="window.gameApp.init()" class="btn-touch flex-[2.5] bg-blue-600 text-white shadow-lg text-lg hover:bg-blue-700">
                    Ø§Ù†Ø·Ù„Ø§Ù‚ <i class="fas fa-rocket mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-slate-600 border border-slate-200 text-[10px] flex-col leading-tight py-2 hover:bg-slate-50">
                    <i class="fas fa-trophy text-yellow-500 text-xl mb-1"></i>
                    <span>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
            
            <p class="text-[10px] text-slate-400 font-bold mt-auto tracking-widest uppercase text-center">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù„Ø¹Ø¨Ø© (Canvas) -->
        <div id="game-screen" class="hidden w-full h-full relative bg-slate-800 transition-all duration-200">
            <canvas id="gameCanvas"></canvas>
            <div class="hud-panel">
                <div id="level-indicator" class="text-[10px] text-blue-500 font-bold mb-1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¡: Ø§Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</div>
                <div id="math-problem-display"></div>
                <div class="hud-score">
                    <span id="score-display" class="text-green-600">Ø§Ù„ØªÙ‚Ø¯Ù…: Ù /Ù¡Ù¥</span>
                    <span id="time-display" class="text-blue-600">Ø§Ù„ÙˆÙ‚Øª: Ù Ù :Ù Ù </span>
                </div>
            </div>
            <div id="level-transition-screen">
                <div class="text-4xl text-yellow-500 mb-2"><i class="fas fa-star animate-spin"></i></div>
                <h2 class="level-title">Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!</h2>
                <div id="level-score-display" class="level-score-badge">Ù†ØªÙŠØ¬ØªÙƒ: Ù  / Ù£</div>
                <p class="level-subtitle" id="next-level-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ...</p>
            </div>
        </div>

        <!-- Ø­Ù‚ÙˆÙ„ Ù…Ø®ÙÙŠØ© -->
        <input type="hidden" id="input-achieved">
        <input type="hidden" id="input-max">
        <input type="hidden" id="input-metric-value">
        <input type="hidden" id="btn-metric-time">
        <input type="hidden" id="btn-metric-error">

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full overflow-hidden text-center justify-center bg-white z-20 absolute inset-0">
            <div class="w-20 h-20 bg-green-100 rounded-full mx-auto flex items-center justify-center mb-4 animate-bounce">
                <i class="fas fa-trophy text-3xl text-green-600"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 mb-6">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø³Ø¨Ø§Ù‚</h2>
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-6"></div>
            <div class="bg-green-50 p-4 rounded-2xl border border-green-100 mb-4">
                <p id="save-msg" class="font-black text-green-800 text-xs">Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ...</p>
            </div>
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-3 shadow-md hover:bg-blue-700">
                <i class="fas fa-crown ml-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
            </button>
            <div class="mt-auto flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 text-sm font-bold hover:bg-slate-200">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
                <button id="finish-btn" class="btn-touch flex-[2] bg-slate-900 text-white text-sm font-bold hover:bg-slate-800">Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                <button onclick="closeLeaderboardModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center transition-all hover:bg-red-50 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„ÙƒÙ„)</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl border border-slate-100 p-1 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><div class="sync-loader text-blue-500 text-3xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
            <p class="text-center text-[9px] text-slate-400 mt-2 font-mono italic">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø«Ù… Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ©</p>
        </div>
    </div>

    <!-- ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <script>
        window.gameApp = (function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            let state = {
                active: false,
                lane: 1,
                score: 0,
                levelScore: 0, 
                questionCount: 0,
                maxQuestions: 15,
                startTime: 0,
                baseSpeed: 0.7, 
                speed: 0.7, 
                roadOffset: 0,
                gates: [],
                currentProblem: null,
                isGameOver: false,
                isTransitioning: false,
                particles: [],
                sessionQuestions: [],
                questionAnswered: false,
                isBoosting: false 
            };

            const LANES = [0.25, 0.5, 0.75]; 
            const CAR_COLOR = '#ef4444';
            const CAR_WIDTH = 50;
            const CAR_HEIGHT = 80;

            const toArDigit = (n) => String(n).replace(/-/g,'-').replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

            const formatTermHTML = (coeff, exp, variable = 'Ø³') => {
                let cStr = (coeff === 1) ? '' : toArDigit(coeff);
                if (coeff === 1 && exp === 0) cStr = 'Ù¡'; 
                if (exp === 0) return toArDigit(coeff); 
                if (exp === 1) return `${cStr}${variable}`;
                return `${cStr}${variable}<sup>${toArDigit(exp)}</sup>`;
            };

            const formatTermText = (coeff, exp, variable = 'Ø³') => {
                if (exp === 0) return toArDigit(coeff);
                
                if (exp < 0) {
                    let num = toArDigit(coeff); 
                    let denExp = Math.abs(exp);
                    let denStr = (denExp === 1) ? variable : `${variable}^${toArDigit(denExp)}`;
                    return `${num}/${denStr}`;
                }

                let cStr = (coeff === 1) ? '' : toArDigit(coeff);
                if (exp === 1) return `${cStr}${variable}`;
                return `${cStr}${variable}^${toArDigit(exp)}`;
            };

            const formatMultiVarHTML = (terms) => terms.map(t => t.e===0 ? '' : (t.e===1 ? t.v : `${t.v}<sup>${toArDigit(t.e)}</sup>`)).join('');
            const formatMultiVarText = (terms) => terms.map(t => t.e===0 ? '' : (t.e===1 ? t.v : `${t.v}^${toArDigit(t.e)}`)).join('');

            // --- Question Bank Generators ---
            
            const getLevel1Bank = () => [
                {A:1, n:5, B:1, m:2}, {A:1, n:7, B:1, m:3}, {A:1, n:4, B:1, m:2},
                {A:1, n:6, B:1, m:1}, {A:1, n:9, B:1, m:4}, {A:1, n:8, B:1, m:5}
            ].map(p => createQ_Basic(p));

            const getLevel2Bank = () => [
                {n:4, m:2, p:3}, {n:5, m:3, p:2}, {n:3, m:1, p:4},
                {n:2, m:1, p:5}, {n:6, m:4, p:2}, {n:7, m:5, p:3}
            ].map(p => createQ_Power(p));

            // Level 3: 6 questions (Modified)
            // Added multipliers for Q1 and Q2 as requested
            const getLevel3Bank = () => [
                {extra:' Øµ', n:2, m:1, type:'zero_power', mult:'Ù¢'}, // Answer is 2
                {coeff:5, n:3, m:2, type:'zero_power', mult:'Ù¢Ø³'}, // Answer is 2s
                {n:2, m:5, p:-2, type:'neg_power'}, 
                {n:3, m:7, p:-3, type:'neg_power'}, 
                {n:5, m:2, p:-2, type:'neg_power'}, 
                {n:6, m:1, p:-3, type:'neg_power'}
            ].map(p => createQ_Negative(p));

            const getLevel4Bank = () => [
                {v1:'Ø³', e1:2, v2:'Øµ', e2:3, p:2}, 
                {v1:'Ø¹', e1:3, v2:'Ø³', e2:2, p:3},
                {v1:'Ø³', e1:1, v2:'Øµ', e2:2, p:4},
                {v1:'Øµ', e1:3, v2:'Ø³', e2:4, p:2},
                {v1:'Ø³', e1:2, v2:'Ø¹', e2:1, p:5},
                {v1:'Øµ', e1:1, v2:'Ø³', e2:1, p:3}
            ].map(p => createQ_MultiVar(p));

            const getLevel5Bank = () => [
                {A:12, n:5, B:3, m:2}, {A:10, n:7, B:2, m:3}, {A:8, n:4, B:4, m:2},
                {A:15, n:6, B:5, m:2}, {A:18, n:3, B:6, m:1}, {A:20, n:5, B:4, m:3}
            ].map(p => createQ_Basic(p));

            // Helpers
            function createQ_Basic(p) {
                const resCoeff = p.A / p.B;
                const resExp = p.n - p.m;
                const html = `<div class="fraction-container"><span class="fraction-top">${formatTermHTML(p.A, p.n)}</span><span class="fraction-bottom">${formatTermHTML(p.B, p.m)}</span></div>`;
                const correct = formatTermText(resCoeff, resExp);
                return { html, correct, type: 'coeff', coeff: resCoeff, exp: resExp };
            }

            function createQ_Power(p) {
                const html = `<div class="power-wrapper"><span class="big-paren">(</span><div class="fraction-container"><span class="fraction-top">${formatTermHTML(1, p.n)}</span><span class="fraction-bottom">${formatTermHTML(1, p.m)}</span></div><span class="big-paren">)</span><sup>${toArDigit(p.p)}</sup></div>`;
                const finalExp = (p.n - p.m) * p.p;
                const correct = formatTermText(1, finalExp);
                return { html, correct, type: 'power', coeff: 1, exp: finalExp };
            }

            function createQ_Negative(p) {
                if (p.type === 'zero_power') {
                    const termTop = formatTermHTML(p.coeff || 1, p.n) + (p.extra || '');
                    const termBot = formatTermHTML(1, p.m);
                    
                    // Show multiplier if it exists
                    const multHtml = p.mult ? `<span class="mx-2 text-2xl font-bold">${p.mult}</span>` : '';
                    
                    const powerHtml = `<div class="power-wrapper"><span class="big-paren">(</span><div class="fraction-container"><span class="fraction-top">${termTop}</span><span class="fraction-bottom">${termBot}</span></div><span class="big-paren">)</span><sup style="font-size:1.2em; font-weight:900; color:#1e293b;">Ù </sup></div>`;
                    
                    const html = `<div class="flex items-center justify-center">${multHtml}${powerHtml}</div>`;
                    const correct = p.mult || "Ù¡";
                    
                    return { html, correct, type: 'zero_ans', mult: p.mult };
                } else {
                    const html = `<div class="power-wrapper"><span class="big-paren">(</span><div class="fraction-container"><span class="fraction-top">${formatTermHTML(1, p.n)}</span><span class="fraction-bottom">${formatTermHTML(1, p.m)}</span></div><span class="big-paren">)</span><sup>${toArDigit(p.p)}</sup></div>`;
                    const innerExp = p.n - p.m; 
                    const finalExp = innerExp * p.p;
                    const correct = formatTermText(1, finalExp);
                    return { html, correct, type: 'negative', coeff: 1, exp: finalExp };
                }
            }

            function createQ_MultiVar(p) {
                const topTerms = [{v: p.v1, e: p.e1}];
                const bottomTerms = [{v: p.v2, e: p.e2}];
                const html = `<div class="power-wrapper"><span class="big-paren">(</span><div class="fraction-container"><span class="fraction-top">${formatMultiVarHTML(topTerms)}</span><span class="fraction-bottom">${formatMultiVarHTML(bottomTerms)}</span></div><span class="big-paren">)</span><sup>${toArDigit(p.p)}</sup></div>`;
                
                const resTop = [{v: p.v1, e: p.e1 * p.p}];
                const resBot = [{v: p.v2, e: p.e2 * p.p}];
                const correct = `${formatMultiVarText(resTop)}/${formatMultiVarText(resBot)}`;
                
                const w1Top = [{v: p.v1, e: p.e1 + p.p}]; 
                const w1Bot = [{v: p.v2, e: p.e2 + p.p}];
                const wrong1 = `${formatMultiVarText(w1Top)}/${formatMultiVarText(w1Bot)}`;

                const w2Top = [{v: p.v1, e: p.e1 * p.p}];
                const w2Bot = [{v: p.v2, e: p.e2}]; 
                const wrong2 = `${formatMultiVarText(w2Top)}/${formatMultiVarText(w2Bot)}`;
                
                return { html, correct, type: 'multivar', options: shuffle([correct, wrong1, wrong2]) };
            }

            function generateSessionQuestions() {
                const l1 = shuffle(getLevel1Bank()).slice(0, 3);
                const l2 = shuffle(getLevel2Bank()).slice(0, 3);
                const l3 = shuffle(getLevel3Bank()).slice(0, 3);
                const l4 = shuffle(getLevel4Bank()).slice(0, 3);
                const l5 = shuffle(getLevel5Bank()).slice(0, 3);
                
                l1.forEach(q => q.levelTitle = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¡: Ø§Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©');
                l2.forEach(q => q.levelTitle = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¢: Ù‚ÙˆØ© Ù†Ø§ØªØ¬ Ø§Ù„Ù‚Ø³Ù…Ø©');
                l3.forEach(q => q.levelTitle = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù£: Ø§Ù„Ø£Ø³Ø³ Ø§Ù„ØµÙØ±ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ù„Ø¨Ø©');
                l4.forEach(q => q.levelTitle = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¤: Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆÙ‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ©');
                l5.forEach(q => q.levelTitle = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¥: Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„');

                return [...l1, ...l2, ...l3, ...l4, ...l5];
            }

            function generateDistractors(q) {
                if (q.type === 'multivar') return q.options;
                
                if (q.type === 'zero_ans') {
                    if (q.mult) {
                        if (q.mult === 'Ù¢') return shuffle(['Ù¢', 'Ù¡', 'Ù¤']); // e.g. for 2
                        if (q.mult === 'Ù¢Ø³') return shuffle(['Ù¢Ø³', 'Ù¡', 'Ù¢']); // e.g. for 2s
                        return shuffle([q.mult, 'Ù¡', 'Ù ']); // fallback
                    }
                    return shuffle(["Ù¡", "Ù ", "Ø³"]);
                }

                let distractors = [];
                const coeff = q.coeff;
                const exp = q.exp;
                const correct = q.correct;

                if (q.type === 'coeff' || q.type === 'basic') {
                    distractors.push(formatTermText(coeff, exp + 2)); 
                    if (coeff > 1) distractors.push(formatTermText(coeff + 2, exp));
                    else distractors.push(formatTermText(1, Math.abs(exp - 1) || 2));
                } else if (q.type === 'power' || q.type === 'negative') {
                    distractors.push(formatTermText(coeff, exp + 2));
                    distractors.push(formatTermText(coeff, -exp)); 
                }
                
                distractors = distractors.filter(d => d !== correct);
                while(distractors.length < 2) {
                    const rndExp = exp + Math.floor(Math.random()*3) + 1;
                    const d = formatTermText(coeff, rndExp);
                    if (d !== correct && !distractors.includes(d)) distractors.push(d);
                    else distractors.push(formatTermText(coeff + 1, exp)); 
                }
                return shuffle([correct, distractors[0], distractors[1]]);
            }

            function shuffle(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            function init() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                resize();
                window.addEventListener('resize', resize);
                
                state.active = true;
                state.score = 0;
                state.levelScore = 0; 
                state.questionCount = 0;
                state.sessionQuestions = generateSessionQuestions();
                state.startTime = Date.now();
                state.gates = [];
                state.particles = [];
                state.lane = 1;
                state.isGameOver = false;
                state.roadOffset = 0;
                state.questionAnswered = false; 
                state.isBoosting = false; // Reset boost
                
                // Input Listeners for Boost Logic
                window.addEventListener('keydown', handleKeyStart);
                window.addEventListener('keyup', handleKeyEnd);
                
                canvas.addEventListener('mousedown', handleInputStart);
                canvas.addEventListener('mouseup', handleInputEnd);
                canvas.addEventListener('mouseleave', handleInputEnd);
                
                canvas.addEventListener('touchstart', handleInputStart, {passive: false});
                canvas.addEventListener('touchend', handleInputEnd);

                spawnGate();
                loop();
            }

            // --- INPUT HANDLING (BOOST LOGIC) ---
            
            function handleInputStart(e) {
                if (!state.active || state.isGameOver || state.isTransitioning) return;
                if (e.type === 'touchstart') e.preventDefault();
                
                state.isBoosting = true; // Activate Turbo
                document.getElementById('game-screen').classList.add('turbo-active');

                const rect = canvas.getBoundingClientRect();
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const x = clientX - rect.left;
                const width = rect.width;

                if (x < width / 3) { state.lane = 0; } 
                else if (x < (width * 2) / 3) { state.lane = 1; } 
                else { state.lane = 2; }
            }

            function handleInputEnd(e) {
                state.isBoosting = false; // Deactivate Turbo
                document.getElementById('game-screen').classList.remove('turbo-active');
            }

            function handleKeyStart(e) {
                if (!state.active || state.isGameOver) return;
                state.isBoosting = true;
                document.getElementById('game-screen').classList.add('turbo-active');
                if (e.key === 'ArrowLeft' && state.lane > 0) state.lane--;
                if (e.key === 'ArrowRight' && state.lane < 2) state.lane++;
            }

            function handleKeyEnd(e) {
                state.isBoosting = false;
                document.getElementById('game-screen').classList.remove('turbo-active');
            }

            function resize() {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
            }

            function showLevelTransition() {
                state.isTransitioning = true;
                state.active = false; 
                state.isBoosting = false; // Reset boost on pause
                document.getElementById('game-screen').classList.remove('turbo-active');

                const overlay = document.getElementById('level-transition-screen');
                const nextLevel = Math.floor(state.questionCount / 3) + 1;
                
                document.getElementById('level-score-display').textContent = `Ù†ØªÙŠØ¬ØªÙƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…: ${toArDigit(state.levelScore)} Ù…Ù† Ù£`;
                document.getElementById('next-level-text').textContent = `Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${toArDigit(nextLevel)}`;
                
                overlay.classList.add('active');
                
                setTimeout(() => {
                    overlay.classList.remove('active');
                    state.isTransitioning = false;
                    state.active = true;
                    state.levelScore = 0; 
                    spawnGate();
                    loop(); 
                }, 3000); 
            }

            function spawnGate() {
                if (state.questionCount >= state.maxQuestions) return;
                
                const q = state.sessionQuestions[state.questionCount];
                state.currentProblem = q;
                state.questionAnswered = false; 
                
                document.getElementById('level-indicator').textContent = q.levelTitle;
                document.getElementById('math-problem-display').innerHTML = q.html;
                
                const options = generateDistractors(q);
                const yStart = -150; 
                state.gates = []; 
                options.forEach((opt, index) => {
                    state.gates.push({
                        lane: index,
                        y: yStart,
                        text: opt,
                        isCorrect: opt === q.correct,
                        hit: false
                    });
                });
                state.questionCount++;
                document.getElementById('score-display').textContent = `Ø§Ù„ØªÙ‚Ø¯Ù…: ${toArDigit(state.questionCount)}/${toArDigit(state.maxQuestions)}`;
            }

            function update() {
                if (!state.active || state.isGameOver || state.isTransitioning) return;
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const secs = String(elapsed % 60).padStart(2, '0');
                document.getElementById('time-display').textContent = `Ø§Ù„ÙˆÙ‚Øª: ${toArDigit(mins)}:${toArDigit(secs)}`;

                // Calculate Speed (Turbo Logic)
                let currentSpeed = state.isBoosting ? state.baseSpeed * 3 : state.baseSpeed;
                state.speed = currentSpeed;

                state.roadOffset = (state.roadOffset + state.speed * 2) % 40; 

                let passedGates = false;
                state.gates.forEach(gate => {
                    gate.y += state.speed;
                    // Collision logic
                    if (!gate.hit && gate.y + 80 > canvas.height - CAR_HEIGHT - 20 && gate.y < canvas.height - 20) {
                        if (gate.lane === state.lane) {
                            
                            if (state.questionAnswered) return; 

                            state.questionAnswered = true; 
                            gate.hit = true; 

                            if (gate.isCorrect) {
                                state.score++;
                                state.levelScore++; 
                                createParticles(canvas.width * LANES[state.lane], gate.y + 80, '#22c55e');
                                document.getElementById('math-problem-display').style.color = '#22c55e';
                                setTimeout(() => document.getElementById('math-problem-display').style.color = '#1e293b', 500);
                            } else {
                                createParticles(canvas.width * LANES[state.lane], gate.y + 80, '#ef4444');
                                document.getElementById('game-screen').classList.add('animate-pulse');
                                setTimeout(() => document.getElementById('game-screen').classList.remove('animate-pulse'), 300);
                            }
                        }
                    }
                    if (gate.y > canvas.height) passedGates = true;
                });

                if (passedGates) {
                    state.gates = state.gates.filter(g => g.y <= canvas.height);
                    if (state.gates.length === 0) {
                        if (state.questionCount >= state.maxQuestions) {
                            finishGame();
                        } else if (state.questionCount % 3 === 0) {
                            showLevelTransition();
                        } else {
                            spawnGate();
                        }
                    }
                }

                // Add trail particles if boosting
                if (state.isBoosting) {
                    const carX = canvas.width * LANES[state.lane];
                    const carY = canvas.height - CAR_HEIGHT - 20 + CAR_HEIGHT;
                    state.particles.push({
                        x: carX + (Math.random() - 0.5) * 20, 
                        y: carY, 
                        vx: (Math.random() - 0.5) * 2, 
                        vy: Math.random() * 5 + 2, 
                        life: 10, 
                        color: Math.random() > 0.5 ? '#f59e0b' : '#ef4444', 
                        size: Math.random() * 3 + 1
                    });
                }

                state.particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; });
                state.particles = state.particles.filter(p => p.life > 0);
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#334155'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const curbWidth = 15;
                const blockSize = 40;
                for (let y = -blockSize + state.roadOffset; y < canvas.height; y += blockSize) {
                    ctx.fillStyle = (Math.floor((y - state.roadOffset) / blockSize) % 2 === 0) ? '#ef4444' : '#f8fafc';
                    ctx.fillRect(0, y, curbWidth, blockSize);
                    ctx.fillRect(canvas.width - curbWidth, y, curbWidth, blockSize);
                }

                ctx.strokeStyle = 'rgba(255,255,255,0.3)'; 
                ctx.setLineDash([20, 20]); 
                ctx.lineDashOffset = -state.roadOffset; 
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(canvas.width * 0.33, 0); ctx.lineTo(canvas.width * 0.33, canvas.height);
                ctx.moveTo(canvas.width * 0.66, 0); ctx.lineTo(canvas.width * 0.66, canvas.height);
                ctx.stroke();
                ctx.setLineDash([]); 

                state.gates.forEach(gate => {
                    if (gate.hit) return;

                    const centerX = canvas.width * LANES[gate.lane];
                    const w = canvas.width / 3 - 25; 
                    const h = 80; 
                    const poleW = 6;
                    
                    ctx.fillStyle = '#64748b'; 
                    ctx.fillRect(centerX - w/2, gate.y, poleW, h); 
                    ctx.fillRect(centerX + w/2 - poleW, gate.y, poleW, h); 

                    const headerH = 40;
                    ctx.fillStyle = '#1e293b'; 
                    ctx.beginPath();
                    ctx.roundRect(centerX - w/2 - 2, gate.y, w + 4, headerH, 5);
                    ctx.fill();

                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    drawGateMath(gate.text, centerX, gate.y + headerH/2 + 5);

                    ctx.fillStyle = gate.isCorrect && false ? '#22c55e' : '#f59e0b'; 
                    ctx.beginPath();
                    ctx.arc(centerX, gate.y - 5, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                const carX = canvas.width * LANES[state.lane];
                const carY = canvas.height - CAR_HEIGHT - 20;
                
                // Shake effect when boosting
                let drawX = carX;
                if (state.isBoosting) {
                    drawX += (Math.random() - 0.5) * 4;
                }

                ctx.fillStyle = CAR_COLOR; 
                ctx.beginPath(); ctx.roundRect(drawX - CAR_WIDTH/2, carY, CAR_WIDTH, CAR_HEIGHT, 10); ctx.fill();
                ctx.fillStyle = '#1e293b';
                ctx.beginPath(); 
                ctx.moveTo(drawX - CAR_WIDTH/2 + 5, carY + 20);
                ctx.lineTo(drawX + CAR_WIDTH/2 - 5, carY + 20);
                ctx.lineTo(drawX + CAR_WIDTH/2 - 8, carY + 45);
                ctx.lineTo(drawX - CAR_WIDTH/2 + 8, carY + 45);
                ctx.fill();
                ctx.fillStyle = '#991b1b'; 
                ctx.fillRect(drawX - CAR_WIDTH/2 - 4, carY + CAR_HEIGHT - 12, CAR_WIDTH + 8, 8);
                ctx.fillStyle = 'rgba(255,255,255,0.8)'; 
                ctx.fillRect(drawX - 4, carY + 5, 8, CAR_HEIGHT - 15);

                state.particles.forEach(p => {
                    ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                });
            }

            function drawGateMath(text, x, y) {
                ctx.direction = 'rtl';
                ctx.fillStyle = '#f8fafc'; 
                
                if (text.includes('/')) {
                    const parts = text.split('/');
                    const top = parts[0];
                    const bottom = parts[1];
                    ctx.font = 'bold 16px "Cairo", sans-serif';
                    const topW = ctx.measureText(top).width;
                    const botW = ctx.measureText(bottom).width;
                    const maxW = Math.max(topW, botW);
                    drawComplexText(ctx, top, x, y - 10);
                    ctx.fillRect(x - maxW/2, y, maxW, 2);
                    drawComplexText(ctx, bottom, x, y + 15);
                } else {
                    drawComplexText(ctx, text, x, y);
                }
            }

            function drawComplexText(ctx, text, x, y) {
                if (text.includes('^')) {
                    let parts = text.split(/(\^[-]?[\dÙ -Ù©]+)/); 
                    let widths = [];
                    ctx.font = 'bold 18px "Cairo", sans-serif'; 
                    let smallFont = 'bold 12px "Cairo", sans-serif'; 
                    parts.forEach(p => {
                        if (p.startsWith('^')) {
                            // Check if exponent is zero (or contains zero like Ù )
                            if(p.includes('Ù ')) {
                                ctx.font = 'bold 18px "Cairo", sans-serif'; // Bigger font for zero
                            } else {
                                ctx.font = smallFont;
                            }
                            let w = ctx.measureText(p.substring(1)).width;
                            widths.push({text: p.substring(1), w: w, type: 'exp', isZero: p.includes('Ù ')});
                        } else if (p) {
                            ctx.font = 'bold 18px "Cairo", sans-serif';
                            let w = ctx.measureText(p).width;
                            widths.push({text: p, w: w, type: 'base'});
                        }
                    });
                    let currentX = x + 20; 
                    for (let i = 0; i < widths.length; i++) {
                        let item = widths[i];
                        ctx.textAlign = 'right'; 
                        if (item.type === 'base') {
                            ctx.font = 'bold 18px "Cairo", sans-serif';
                            ctx.fillText(item.text, currentX, y);
                            currentX -= item.w;
                        } else {
                            if(item.isZero) {
                                ctx.font = 'bold 18px "Cairo", sans-serif';
                                ctx.fillText(item.text, currentX, y - 8); 
                            } else {
                                ctx.font = smallFont;
                                ctx.fillText(item.text, currentX, y - 6); 
                            }
                            currentX -= item.w;
                        }
                    }
                } else {
                    ctx.font = 'bold 18px "Cairo", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, x, y);
                }
            }

            function createParticles(x, y, color) {
                for(let i=0; i<15; i++) {
                    state.particles.push({x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 30, color: color, size: Math.random()*4+2});
                }
            }

            function loop() { if (state.active) { update(); draw(); requestAnimationFrame(loop); } }
            function finishGame() {
                state.isGameOver = true; state.active = false;
                const totalTime = Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('input-achieved').value = state.score;
                document.getElementById('input-max').value = state.maxQuestions;
                document.getElementById('input-metric-value').value = totalTime;
                window.setMetricType('time');
                window.processResults();
            }
            
            return { init };
        })();
    </script>
    
    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = 'g6_2_2';
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        let currentMetricType = 'time';
        let currentLeaderboardMode = classId ? 'class' : 'global';
        let localVisitorResult = null;
        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

        document.addEventListener('DOMContentLoaded', () => {
            if (!classId) { document.getElementById('tab-class').style.display = 'none'; currentLeaderboardMode = 'global'; } 
            else { document.getElementById('tab-class').className = 'tab-btn tab-active'; document.getElementById('tab-global').className = 'tab-btn tab-inactive'; }
            if (studentId && classId) { document.getElementById('sync-icon').classList.remove('hidden'); fetchInitialCloudData(); } 
            else if (!urlParams.get('name')) { studentName = "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±"; document.getElementById('top-student-name').textContent = studentName; }
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        async function fetchInitialCloudData() {
            try {
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) { studentName = res.data.name; document.getElementById('top-student-name').textContent = studentName; }
                    if (res.data.games && res.data.games[GAME_ID]) { document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥"; }
                }
            } catch (e) { console.log("Cloud Connect Failed"); } finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }
        window.setMetricType = (type) => { currentMetricType = type; };
        window.processResults = () => {
            const ach = parseFloat(document.getElementById('input-achieved').value);
            const max = parseFloat(document.getElementById('input-max').value);
            const met = parseFloat(document.getElementById('input-metric-value').value) || 0;
            if (isNaN(ach) || isNaN(max) || max <= 0) return;
            const grade = ((ach / max) * 5).toFixed(1);
            showResult(ach, max, grade, met);
            if (studentId && classId) { saveScore(grade, met); } 
            else { localVisitorResult = { name: studentName, grade: grade, metric: met, isLocal: true }; document.getElementById('save-msg').textContent = "ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù†ØªÙŠØ¬ØªÙƒ Ù„Ù„Ø¹Ø±Ø¶ (ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±)"; fetchAndShowLeaderboard(false); }
        };
        function showResult(a, m, g, met) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 text-center flex flex-col justify-center">
                    <p class="text-[8px] font-bold text-blue-400 mb-1">Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</p>
                    <p class="text-base font-black text-blue-900 leading-none">${toAr(a)}<span class="text-xs text-blue-300">/${toAr(m)}</span></p>
                </div>
                <div class="bg-purple-50 p-2 rounded-xl border border-purple-100 text-center flex flex-col justify-center">
                    <p class="text-[8px] font-bold text-purple-400 mb-1">Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø©</p>
                    <p class="text-base font-black text-purple-900 leading-none">${toAr(g)}<span class="text-xs text-purple-300">/Ù¥</span></p>
                </div>
                <div class="bg-amber-50 p-2 rounded-xl border border-amber-100 text-center flex flex-col justify-center">
                    <p class="text-[8px] font-bold text-amber-400 mb-1">Ø§Ù„ÙˆÙ‚Øª</p>
                    <p class="text-base font-black text-amber-900 leading-none">${toAr(met)} <span class="text-[9px]">Ø«</span></p>
                </div>
            `;
        }
        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); document.getElementById('save-msg').textContent = "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!"; } catch(e) { document.getElementById('save-msg').textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; } finally { fetchAndShowLeaderboard(false); }
        }
        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            fetch(url).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (localVisitorResult && (currentLeaderboardMode === 'global' || !classId)) { data = data.filter(p => p.name !== localVisitorResult.name); data.push(localVisitorResult); data.sort((a, b) => parseFloat(b.grade) - parseFloat(a.grade) || parseFloat(a.metric) - parseFloat(b.metric)); }
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="text-slate-400 border-b border-slate-100 bg-slate-50/50"><tr><th class="p-2 text-center">#</th><th class="p-2 text-right">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center text-emerald-600">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody class="divide-y divide-slate-50">`;
                    data.forEach((p, i) => {
                        const isMe = (p.isLocal || (studentId && String(p.name).trim() === String(studentName).trim()));
                        h += `<tr class="${isMe ? 'rank-row-me' : 'hover:bg-slate-50/50'} transition-colors"><td class="p-2 leaderboard-rank text-center ${i<3 ? 'text-yellow-500 text-sm' : 'text-slate-400'}">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td><td class="p-2 leaderboard-name ${isMe ? 'text-blue-700 font-extrabold' : 'text-slate-700'}">${p.name} ${isMe ? '<span class="bg-blue-600 text-white text-[7px] px-1 rounded-full mx-1">Ø£Ù†Øª</span>' : ''}</td><td class="p-2 text-center"><span class="text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</span><span class="text-[8px] text-slate-400 block font-bold">(${toAr(p.metric || p.metricValue || 0)} Ø«)</span></td></tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="py-10 text-center text-slate-400 text-xs italic font-bold">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };
        window.switchTab = (mode) => { currentLeaderboardMode = mode; document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; fetchAndShowLeaderboard(false); };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø¹Ø¨Ø§Ù‚Ø±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ V19.10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£Ù†ÙŠÙ‚ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .compact-card {
            width: 100%; max-width: 450px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; max-height: 96vh; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 6px 12px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 10px; font-weight: 800; color: #64748b;
        }
        .btn-touch { min-height: 48px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        /* Jeopardy Styles */
        .jeopardy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; padding: 8px; }
        .card-inner {
            height: 75px; border: 2px solid #3b82f6; border-radius: 1rem;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .card-inner.disabled-correct { background: #ecfdf5; border-color: #10b981; color: #059669; cursor: not-allowed; }
        .card-inner.disabled-wrong { background: #fef2f2; border-color: #ef4444; color: #b91c1c; cursor: not-allowed; }
        .card-inner .level-label { font-size: 13px; font-weight: 900; color: #1e40af; }
        .card-inner .pts-label { font-size: 9px; color: #3b82f6; }

        /* Math Display Logic */
        .math-term { display: inline-flex; flex-direction: row; align-items: baseline; margin: 0 0.1rem; }
        .math-var { font-style: italic; font-size: 1.1em; margin-right: 1px; }
        .math-pow { font-size: 0.65em; transform: translate(-1px, -0.65em); font-weight: bold; color: #2563eb; }
        .math-frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; line-height: 1; }
        .frac-num { border-bottom: 2px solid #1e293b; padding: 0 4px; }
        .frac-den { padding: 1px 4px 0 4px; }

        /* Modal & UI */
        .game-modal { position: absolute; inset: 0; background: white; z-index: 50; display: none; flex-direction: column; padding: 1rem; }
        .game-modal.active { display: flex; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; width: 100%; }
        .option-btn { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 0.75rem; min-height: 60px; display: flex; align-items: center; justify-content: center; font-weight: 800; transition: 0.2s; padding: 4px; font-size: 0.9rem; }
        .option-btn:active { background: #f1f5f9; border-color: #3b82f6; }

        /* ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù„Ù„ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ù…Ø§ Ø¨ØµØ±ÙŠØ§Ù‹ */
        .leaderboard-modal { position: absolute; inset: 0; background: #ffffff; z-index: 100; display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tabs-container { background: #f1f5f9; padding: 4px; border-radius: 12px; display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: 900; border-radius: 10px; transition: 0.2s; text-align: center; cursor: pointer; }
        .tab-active { background: white; color: #2563eb; shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .tab-inactive { color: #64748b; }

        .rank-row-me { background-color: #eff6ff !important; border-right: 4px solid #2563eb !important; }
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .section-tag { font-size: 8px; padding: 2px 6px; border-radius: 50px; background: #f1f5f9; color: #64748b; font-weight: 800; border: 1px solid #e2e8f0; }
        .section-tag.success { background: #ecfdf5; color: #059669; border-color: #10b981; }

        #instruction-popup, #warning-popup { z-index: 60; background: rgba(15, 23, 42, 0.9); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-2 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-blue-500 text-xs"></i>
                <span id="top-student-name" class="truncate font-black">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..</span>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[9px]"></i>
                <span id="top-prev-score">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-3 h-full justify-center">
            <div>
                <i class="fas fa-brain text-4xl text-blue-600 mb-2"></i>
                <h1 class="text-2xl font-black text-slate-800 leading-tight">Ø¹Ø¨Ø§Ù‚Ø±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-tighter">ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯ V19.10</p>
            </div>
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-[10px] font-bold text-blue-700 leading-relaxed">
                Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: ÙŠØ¬Ø¨ Ø­Ù„ Ø³Ø¤Ø§Ù„ ØµØ­ÙŠØ­ Ù…Ù† ÙƒÙ„ Ù‚Ø³Ù… (Ø§Ù„Ø¯Ø±Ø¬Ø©ØŒ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ØŒ Ø§Ù„ØµÙˆØ±Ø©) Ù„ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬ØªÙƒ!
            </div>
            <div class="flex flex-row gap-2 items-stretch mt-1">
                <button onclick="showInstructions()" class="btn-touch flex-[2.5] bg-blue-600 text-white shadow-lg text-lg">
                    Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø¨Ø§Ù‚ <i class="fas fa-bolt mr-1"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-slate-600 border border-slate-200 text-[9px] flex-col py-2">
                    <i class="fas fa-trophy text-yellow-500 text-lg mb-1"></i>
                    <span>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
            <p class="text-[9px] text-slate-400 font-bold mt-1 tracking-widest uppercase text-center w-full">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
        <div id="instruction-popup" class="hidden absolute inset-0 flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-6 shadow-2xl text-center max-w-[340px] border-4 border-blue-500 animate-in zoom-in duration-300">
                <h2 class="text-lg font-black text-blue-600 mb-4">ğŸ’¡ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø·ÙˆØ±Ø©</h2>
                <div class="space-y-4 text-xs font-bold text-slate-600 text-right leading-relaxed">
                    <div class="flex gap-2">
                        <span class="text-xl">ğŸŸ¢</span>
                        <p><span class="text-blue-600 font-black">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù‡Ù„:</span> ÙˆØ­ÙŠØ¯Ø§Øª Ø­Ø¯ Ø¨Ø³ÙŠØ·Ø© Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ.</p>
                    </div>
                    <div class="flex gap-2 border-t pt-3">
                        <span class="text-xl">ğŸŸ¡</span>
                        <p><span class="text-yellow-600 font-black">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙˆØ³Ø·:</span> ÙƒØ«ÙŠØ±Ø§Øª Ø­Ø¯ÙˆØ¯ Ù…Ø¨Ø¹Ø«Ø±Ø© ØªØªØ·Ù„Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ø¯.</p>
                    </div>
                    <div class="flex gap-2 border-t pt-3">
                        <span class="text-xl">ğŸ”´</span>
                        <p><span class="text-red-600 font-black">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨:</span> Ø­Ø¯ÙˆØ¯ Ù…ØªØ´Ø§Ø¨Ù‡Ø© ÙŠØ¬Ø¨ ØªØ¨Ø³ÙŠØ·Ù‡Ø§ Ø°Ù‡Ù†ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±!</p>
                    </div>
                </div>
                <button onclick="startGame()" class="btn-touch w-full bg-blue-600 text-white mt-6 shadow-lg shadow-blue-200">Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ! ğŸš€</button>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± -->
        <div id="warning-popup" class="hidden absolute inset-0 flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-6 shadow-2xl text-center max-w-[340px] border-4 border-red-500">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h2 class="text-lg font-black text-red-600 mb-2">ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø±Ø¬!</h2>
                <p class="text-xs font-bold text-slate-600 leading-relaxed mb-6">
                    Ù„Ù… ØªÙ‚Ù… Ø¨Ø­Ù„ Ø³Ø¤Ø§Ù„ ØµØ­ÙŠØ­ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† ÙƒÙ„ Ù‚Ø³Ù…. <br>
                    <span class="text-red-500 underline font-black">Ø¯Ø±Ø¬ØªÙƒ Ø³ØªÙƒÙˆÙ† (ØµÙØ±) Ø¥Ø°Ø§ Ø§Ø¹ØªÙ…Ø¯Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¢Ù†.</span>
                </p>
                <div class="flex flex-col gap-2">
                    <button onclick="hideWarning()" class="btn-touch w-full bg-blue-600 text-white shadow-md">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù„ âœï¸</button>
                    <button onclick="confirmFinishWithZero()" class="text-[10px] font-black text-red-400 py-2">Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ø±ØµÙŠØ¯ ØµÙØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="game-screen" class="hidden flex flex-col h-full bg-slate-50">
            <div class="p-2 bg-white border-b flex justify-between items-center shadow-sm">
                <div class="flex gap-1">
                    <div id="ind-deg" class="section-tag">Ø§Ù„Ø¯Ø±Ø¬Ø© âœ•</div>
                    <div id="ind-coeff" class="section-tag">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ âœ•</div>
                    <div id="ind-std" class="section-tag">Ø§Ù„ØµÙˆØ±Ø© âœ•</div>
                </div>
                <div class="text-[10px] font-black text-blue-600">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="live-points">Ù </span></div>
            </div>

            <div class="p-1.5 grid grid-cols-3 gap-2 text-center bg-blue-900 text-white text-[9px] font-black shadow-inner">
                <div>Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ«ÙŠØ±Ø©</div>
                <div>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
                <div>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©</div>
            </div>

            <div id="jeopardy-main-grid" class="jeopardy-grid overflow-y-auto"></div>
            
            <div class="mt-auto p-3 text-center border-t bg-white">
                <button onclick="checkAndFinish()" class="text-[10px] font-black text-blue-500 bg-blue-50 px-4 py-1.5 rounded-full border border-blue-100 transition hover:bg-blue-100 active:scale-95 shadow-sm">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø³Ø¤Ø§Ù„ Modal -->
        <div id="question-modal" class="game-modal">
            <div class="flex-1 overflow-y-auto pr-1">
                <div class="flex justify-between items-center mb-3">
                    <span id="modal-category" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[9px] font-black uppercase">Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                    <span id="modal-points" class="text-blue-600 font-black text-xs italic">Ù¡Ù Ù  Ù†Ù‚Ø·Ø©</span>
                </div>
                
                <div class="text-center mb-4">
                    <h2 class="text-md font-black mb-3 text-slate-700 leading-tight" id="question-text">ØŸ</h2>
                    <div id="math-display" class="bg-slate-50 rounded-xl p-6 border-2 border-dashed border-slate-200 shadow-inner text-xl"></div>
                </div>

                <div class="options-grid" id="options-container"></div>
            </div>
            
            <div class="mt-2 pt-2 border-t flex flex-col gap-2">
                <div id="modal-feedback" class="text-center font-black text-xs hidden"></div>
                <button id="modal-next-btn" onclick="closeQuestionModal()" class="hidden btn-touch w-full bg-blue-600 text-white shadow-lg text-sm">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠ <i class="fas fa-arrow-left ml-1"></i></button>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 4: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full text-center justify-center">
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-4"></div>
            <div id="success-box" class="p-3 rounded-xl border mb-4">
                <i id="status-icon" class="text-2xl mb-1"></i>
                <p id="save-msg" class="font-black text-xs"></p>
            </div>
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-3 shadow-md text-sm">
                <i class="fas fa-crown ml-1"></i> Ø³Ø¬Ù„ Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…
            </button>
            <div class="flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 text-[10px] font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
                <button id="finish-btn" class="btn-touch flex-[2] bg-slate-900 text-white text-[10px] font-bold">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal">
            <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2">
                <h3 class="font-black text-slate-800 text-md"><i class="fas fa-trophy text-yellow-500 ml-1"></i>Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</h3>
                <button onclick="closeLeaderboardModal()" class="w-7 h-7 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center transition-all hover:bg-red-50 hover:text-red-500"><i class="fas fa-times text-xs"></i></button>
            </div>
            
            <div class="tabs-container">
                <div onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</div>
                <div onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø§Ù„ÙƒÙ„</div>
            </div>

            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-xl border border-slate-100 p-1 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><div class="sync-loader text-blue-500 text-2xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = urlParams.get('gameId') || 'g6_3_1';
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        let currentPoints = 0, questionsDone = 0, startTime = 0;
        let solvedSections = { deg: false, coeff: false, std: false };
        let currentLeaderboardMode = classId ? 'class' : 'global';
        let localVisitorResult = null;

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            if (!classId) document.getElementById('tab-class').style.display = 'none';
            if (studentId && classId) {
                document.getElementById('sync-icon').classList.remove('hidden');
                fetchInitialCloudData();
            }
            renderJeopardyGrid();
        });

        async function fetchInitialCloudData() {
            try {
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) { studentName = res.data.name; document.getElementById('top-student-name').textContent = studentName; }
                    if (res.data.games && res.data.games[GAME_ID]) document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                }
            } catch (e) {} finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        const gameBank = {
            deg: {
                easy: [
                    { pts: 100, q: "Ù…Ø§ Ø¯Ø±Ø¬Ø© ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ", math: [{type:'poly', c:'Ù£', p:'Ù¢'}], options: [[{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù '}]], correct: 1 },
                    { pts: 100, q: "Ù…Ø§ Ø¯Ø±Ø¬Ø© ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ", math: [{type:'poly', c:'Ù¥', p:'Ù¤'}], options: [[{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù¤'}], [{type:'const', v:'Ù©'}], [{type:'const', v:'Ù¡'}]], correct: 1 },
                    { pts: 100, q: "Ù…Ø§ Ø¯Ø±Ø¬Ø© ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ", math: [{type:'poly', c:'-Ù¢', p:'Ù£'}], options: [[{type:'const', v:'Ù£'}], [{type:'const', v:'-Ù¢'}], [{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù '}]], correct: 0 }
                ],
                med: [
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø¯Ø±Ø¬Ø© ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'const', v:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù§', p:'Ù¡'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¤', p:'Ù£'}], options: [[{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù§'}]], correct: 2 },
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø¯Ø±Ø¬Ø© ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'poly', c:'Ù¥', p:'Ù¢'}, {type:'op', v:'-'}, {type:'const', v:'Ù¡'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¤'}], options: [[{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¤'}], [{type:'const', v:'Ù¥'}]], correct: 2 },
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø¯Ø±Ø¬Ø© ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'poly', c:'', p:'Ù¡'}, {type:'op', v:'-'}, {type:'const', v:'Ù©'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù¢'}], options: [[{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù©'}]], correct: 1 }
                ],
                hard: [
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø£ÙˆØ¬Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø© (Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©):", math: [{type:'poly', c:'Ù¤', p:'Ù¦'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¥'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¢', p:'Ù¦'}], options: [[{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù¦'}], [{type:'const', v:'Ù¡Ù¡'}], [{type:'const', v:'Ù¡'}]], correct: 1 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø£ÙˆØ¬Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø© (Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©):", math: [{type:'poly', c:'Ù£', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¥', p:'Ù£'}, {type:'op', v:'-'}, {type:'poly', c:'Ù£', p:'Ù¢'}], options: [[{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù¦'}]], correct: 2 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø£ÙˆØ¬Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø© (Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©):", math: [{type:'poly', c:'', p:'Ù¤'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¢', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¥'}], options: [[{type:'const', v:'Ù¤'}], [{type:'const', v:'Ù¨'}], [{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù£'}]], correct: 0 }
                ]
            },
            coeff: {
                easy: [
                    { pts: 100, q: "Ù…Ø§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ØŸ", math: [{type:'poly', c:'Ù¥', p:'Ù£'}], options: [[{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù¡Ù¥'}], [{type:'const', v:'Ù¡'}]], correct: 0 },
                    { pts: 100, q: "Ù…Ø§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ØŸ", math: [{type:'poly', c:'-Ù§', p:'Ù¤'}], options: [[{type:'const', v:'Ù¤'}], [{type:'const', v:'-Ù§'}], [{type:'const', v:'Ù§'}], [{type:'const', v:'-Ù¤'}]], correct: 1 },
                    { pts: 100, q: "Ù…Ø§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ØŸ", math: [{type:'poly', c:'', p:'Ù¢'}], options: [[{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù '}], [{type:'const', v:'-Ù¡'}]], correct: 1 }
                ],
                med: [
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'poly', c:'Ù¤', p:'Ù¡'}, {type:'op', v:'-'}, {type:'poly', c:'', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¥'}], options: [[{type:'const', v:'Ù¤'}], [{type:'const', v:'Ù¡'}], [{type:'const', v:'-Ù¡'}], [{type:'const', v:'Ù '}]], correct: 2 },
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'const', v:'Ù¡Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù¤'}, {type:'op', v:'-'}, {type:'poly', c:'', p:'Ù¡'}], options: [[{type:'const', v:'Ù¡Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'-Ù¡'}], [{type:'const', v:'Ù¤'}]], correct: 1 },
                    { pts: 200, q: "Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø©):", math: [{type:'poly', c:'-Ù¨', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¥', p:'Ù£'}], options: [[{type:'const', v:'-Ù¨'}], [{type:'const', v:'Ù¢'}], [{type:'const', v:'-Ù¥'}], [{type:'const', v:'Ù¥'}]], correct: 2 }
                ],
                hard: [
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:", math: [{type:'poly', c:'Ù§', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¥', p:'Ù£'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¢', p:'Ù£'}], options: [[{type:'const', v:'Ù§'}], [{type:'const', v:'Ù¥'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù¢'}]], correct: 2 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:", math: [{type:'poly', c:'', p:'Ù¤'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¢', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¥'}], options: [[{type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¢'}], [{type:'const', v:'Ù£'}], [{type:'const', v:'Ù¥'}]], correct: 2 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:", math: [{type:'poly', c:'Ù¡Ù ', p:'Ù¢'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¤', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¡'}], options: [[{type:'const', v:'Ù¡Ù '}], [{type:'const', v:'Ù¦'}], [{type:'const', v:'Ù¤'}], [{type:'const', v:'Ù¡'}]], correct: 1 }
                ]
            },
            std: {
                easy: [
                    { pts: 100, q: "Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠÙ…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù€:", math: [{type:'const', v:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¢'}], options: [[{type:'const', v:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¢'}], [{type:'poly', c:'', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}], [{type:'poly', c:'Ù¢', p:'Ù¢'}], [{type:'const', v:'Ù¤'}]], correct: 1 },
                    { pts: 100, q: "Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠÙ…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù€:", math: [{type:'const', v:'Ù¥'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù¡'}], options: [[{type:'poly', c:'Ù£', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù¥'}], [{type:'const', v:'Ù¥'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù¡'}], [{type:'poly', c:'Ù¨', p:'Ù¡'}], [{type:'const', v:'Ù¨'}]], correct: 0 },
                    { pts: 100, q: "Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠÙ…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù€:", math: [{type:'poly', c:'', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù¨'}], options: [[{type:'const', v:'Ù¨'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¡'}], [{type:'poly', c:'', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù¨'}], [{type:'poly', c:'Ù¨', p:'Ù¡'}], [{type:'const', v:'Ù '}]], correct: 1 }
                ],
                med: [
                    { pts: 200, q: "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'poly', c:'Ù¥', p:'Ù¡'}, {type:'op', v:'-'}, {type:'poly', c:'Ù£', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù§'}], options: [[{type:'poly', c:'-Ù£', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¥', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù§'}], [{type:'const', v:'Ù§'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¥', p:'Ù¡'}, {type:'op', v:'-'}, {type:'poly', c:'Ù£', p:'Ù¢'}], [{type:'poly', c:'Ù£', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¥', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù§'}], [{type:'poly', c:'Ù¥', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù§'}]], correct: 0 },
                    { pts: 200, q: "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'const', v:'Ù¤'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù£'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¢', p:'Ù¡'}], options: [[{type:'poly', c:'', p:'Ù£'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¢', p:'Ù¡'}, {type:'op', v:'+'}, {type:'const', v:'Ù¤'}], [{type:'const', v:'Ù¤'}, {type:'op', v:'-'}, {type:'poly', c:'Ù¢', p:'Ù¡'}], [{type:'poly', c:'Ù£', p:'Ù£'}, {type:'op', v:'+'}, {type:'const', v:'Ù¤'}], [{type:'poly', c:'Ù¡', p:'Ù£'}]], correct: 0 },
                    { pts: 200, q: "Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø¹Ø«Ø±Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'poly', c:'Ù©', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¡'}, {type:'op', v:'-'}, {type:'poly', c:'', p:'Ù¤'}], options: [[{type:'poly', c:'-Ù¡', p:'Ù¤'}, {type:'op', v:'+'}, {type:'poly', c:'Ù©', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¡'}], [{type:'poly', c:'Ù©', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¡'}], [{type:'poly', c:'Ù¡', p:'Ù¤'}, {type:'op', v:'-'}], [{type:'const', v:'Ù¡Ù '}]], correct: 0 }
                ],
                hard: [
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'poly', c:'', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù£'}, {type:'op', v:'-'}, {type:'poly', c:'', p:'Ù¢'}, {type:'op', v:'+'}, {type:'const', v:'Ù¡'}], options: [[{type:'poly', c:'', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù£'}], [{type:'poly', c:'Ù£', p:'Ù£'}, {type:'op', v:'+'}, {type:'const', v:'Ù¡'}], [{type:'const', v:'Ù¡'}, {type:'op', v:'+'}, {type:'poly', c:'Ù£', p:'Ù£'}], [{type:'poly', c:'Ù£', p:'Ù£'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¢', p:'Ù¢'}]], correct: 1 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'poly', c:'Ù¥', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}, {type:'op', v:'-'}, {type:'poly', c:'', p:'Ù¤'}], options: [[{type:'poly', c:'Ù¤', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}], [{type:'poly', c:'Ù¦', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}], [{type:'poly', c:'Ù¥', p:'Ù¤'}, {type:'op', v:'+'}, {type:'const', v:'Ù¢'}], [{type:'const', v:'Ù¦'}]], correct: 0 },
                    { pts: 300, q: "Ø¨Ø³Ø· Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©:", math: [{type:'poly', c:'', p:'Ù¡'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¤', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¡'}], options: [[{type:'poly', c:'Ù¤', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'Ù¢', p:'Ù¡'}], [{type:'poly', c:'Ù¦', p:'Ù¢'}], [{type:'poly', c:'Ù¤', p:'Ù¢'}, {type:'op', v:'+'}, {type:'poly', c:'', p:'Ù¡'}], [{type:'const', v:'Ù¦'}]], correct: 0 }
                ]
            }
        };

        function renderJeopardyGrid() {
            const container = document.getElementById('jeopardy-main-grid');
            const ptsList = ['easy', 'med', 'hard'], cats = ['deg', 'coeff', 'std'];
            const labels = {easy: 'Ø³Ù‡Ù„', med: 'Ù…ØªÙˆØ³Ø·', hard: 'ØµØ¹Ø¨'}, ptsVal = {easy: 'Ù¡Ù Ù ', med: 'Ù¢Ù Ù ', hard: 'Ù£Ù Ù '};
            container.innerHTML = '';
            ptsList.forEach(lvl => {
                cats.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'card-inner shadow-sm';
                    card.id = `card-${c}-${lvl}`;
                    card.innerHTML = `<span class="level-label">${labels[lvl]}</span><span class="pts-label">${ptsVal[lvl]}</span>`;
                    card.onclick = () => openQuestion(c, lvl, card);
                    container.appendChild(card);
                });
            });
        }

        function createMathHTML(terms) {
            let html = '<div class="flex flex-wrap items-center justify-center gap-1" dir="rtl">';
            terms.forEach(t => {
                if (t.type === 'poly') {
                    html += `<div class="math-term">`;
                    let c = t.c || ''; if (c === 'Ù¡') c = ''; else if (c === '-Ù¡') c = '-';
                    if (c) html += `<span>${toAr(c)}</span>`;
                    html += `<span class="math-var">Ø³</span>`;
                    if (t.p && t.p !== 'Ù¡' && t.p !== '') html += `<span class="math-pow">${toAr(t.p)}</span>`;
                    html += `</div>`;
                } else if (t.type === 'frac_poly') {
                    html += `<div class="flex items-center"><div class="math-frac"><span class="frac-num">${toAr(t.n)}</span><span class="frac-den">${toAr(t.d)}</span></div><div class="math-term"><span class="math-var">Ø³</span>${t.p ? `<span class="math-pow">${toAr(t.p)}</span>`: ''}</div></div>`;
                } else if (t.type === 'const') html += `<span>${toAr(t.v)}</span>`;
                else if (t.type === 'op') html += `<span class="mx-0.5 text-blue-500 font-bold">${t.v}</span>`;
            });
            return html + '</div>';
        }

        window.showInstructions = () => { document.getElementById('instruction-popup').classList.remove('hidden'); };
        window.hideWarning = () => { document.getElementById('warning-popup').classList.add('hidden'); };

        window.startGame = () => { 
            document.getElementById('start-screen').classList.add('hidden'); 
            document.getElementById('instruction-popup').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden'); 
            startTime = Date.now();
        };

        function openQuestion(cat, lvl, element) {
            if (element.classList.contains('disabled-correct') || element.classList.contains('disabled-wrong')) return;
            const questionsArray = gameBank[cat][lvl];
            const data = questionsArray[Math.floor(Math.random() * questionsArray.length)];
            document.getElementById('modal-category').textContent = {deg:'Ø§Ù„Ø¯Ø±Ø¬Ø©', coeff:'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„', std:'Ø§Ù„ØµÙˆØ±Ø©'}[cat];
            document.getElementById('modal-points').textContent = toAr(data.pts) + ' Ù†Ù‚Ø·Ø©';
            document.getElementById('question-text').textContent = data.q;
            document.getElementById('math-display').innerHTML = createMathHTML(data.math);
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            data.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn shadow-sm';
                btn.innerHTML = createMathHTML(opt);
                btn.onclick = () => handleAnswer(idx, data.correct, data.pts, cat, btn, element);
                container.appendChild(btn);
            });
            document.getElementById('modal-feedback').classList.add('hidden');
            document.getElementById('modal-next-btn').classList.add('hidden');
            document.getElementById('question-modal').classList.add('active');
        }

        function handleAnswer(idx, correct, pts, cat, btn, element) {
            const feedback = document.getElementById('modal-feedback');
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.onclick = null);
            if (idx === correct) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                feedback.textContent = 'ØµØ­ÙŠØ­! + ' + toAr(pts);
                feedback.className = 'text-center font-black text-xs text-green-600';
                currentPoints += pts; solvedSections[cat] = true; updateIndicators();
                element.className = 'card-inner disabled-correct shadow-inner';
                element.innerHTML = '<i class="fas fa-check-circle text-2xl"></i>';
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                btns[correct].classList.add('bg-green-50', 'border-green-300');
                feedback.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                feedback.className = 'text-center font-black text-xs text-red-500';
                element.className = 'card-inner disabled-wrong shadow-inner';
                element.innerHTML = '<i class="fas fa-times-circle text-2xl"></i>';
            }
            document.getElementById('live-points').textContent = toAr(currentPoints);
            feedback.classList.remove('hidden');
            document.getElementById('modal-next-btn').classList.remove('hidden');
            questionsDone++;
        }

        function updateIndicators() {
            if (solvedSections.deg) document.getElementById('ind-deg').className = 'section-tag success';
            if (solvedSections.coeff) document.getElementById('ind-coeff').className = 'section-tag success';
            if (solvedSections.std) document.getElementById('ind-std').className = 'section-tag success';
        }

        window.closeQuestionModal = () => {
            document.getElementById('question-modal').classList.remove('active');
            if (questionsDone === 9) checkAndFinish();
        };

        window.checkAndFinish = () => {
            const isQualified = solvedSections.deg && solvedSections.coeff && solvedSections.std;
            if (!isQualified) document.getElementById('warning-popup').classList.remove('hidden');
            else processFinalResult();
        };

        window.confirmFinishWithZero = () => {
            document.getElementById('warning-popup').classList.add('hidden');
            processFinalResult();
        };

        function processFinalResult() {
            const timeElapsed = Math.floor((Date.now() - startTime) / 1000);
            const isQualified = solvedSections.deg && solvedSections.coeff && solvedSections.std;
            const finalGrade = isQualified ? ((currentPoints / 1800) * 5).toFixed(1) : "0.0";
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 flex flex-col justify-center text-center">
                    <p class="text-[8px] font-bold text-blue-400 uppercase">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                    <p class="text-[10px] font-black">${toAr(currentPoints)}</p>
                </div>
                <div class="bg-emerald-50 p-2 rounded-xl border border-emerald-100 flex flex-col justify-center shadow-sm text-center">
                    <p class="text-[8px] font-bold text-emerald-600 uppercase">Ø§Ù„Ø¯Ø±Ø¬Ø©</p>
                    <p class="text-xl font-black text-emerald-900">${toAr(finalGrade)}</p>
                </div>
                <div class="bg-purple-50 p-2 rounded-xl border border-purple-100 flex flex-col justify-center text-center">
                    <p class="text-[8px] font-bold text-purple-400 uppercase">Ø§Ù„ÙˆÙ‚Øª</p>
                    <p class="text-xl font-black text-purple-900">${toAr(timeElapsed)}Ø«</p>
                </div>`;
            const box = document.getElementById('success-box'), msg = document.getElementById('save-msg'), icon = document.getElementById('status-icon');
            if (isQualified) {
                box.className = "p-3 rounded-xl border mb-4 bg-green-50 border-green-100";
                icon.className = "fas fa-medal text-green-500 text-2xl mb-1";
                msg.textContent = "Ø£Ø¨Ø¯Ø¹Øª ÙŠØ§ Ø¨Ø·Ù„! Ù„Ù‚Ø¯ Ø­Ù‚Ù‚Øª Ø´Ø±Ø· Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.";
                saveToCloud(finalGrade, timeElapsed);
            } else {
                box.className = "p-3 rounded-xl border mb-4 bg-red-50 border-red-100";
                icon.className = "fas fa-exclamation-circle text-red-500 text-2xl mb-1";
                msg.textContent = "Ø¹Ø°Ø±Ø§Ù‹! Ù„Ù… ØªØ­Ù‚Ù‚ Ø´Ø±Ø· Ø§Ù„Ø­Ù„ ÙÙŠ ÙƒÙ„ Ù‚Ø³Ù…. Ø¯Ø±Ø¬ØªÙƒ ØµÙØ±.";
                saveToCloud(0, timeElapsed);
            }
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        }

        async function saveToCloud(g, met) {
            if (!studentId || !classId) {
                localVisitorResult = { name: studentName, grade: g, metric: met, isLocal: true };
                fetchAndShowLeaderboard(false);
                return;
            }
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } catch (e) {} finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = async function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            try {
                const response = await fetch(url);
                const res = await response.json();
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (localVisitorResult && (currentLeaderboardMode === 'global' || !classId)) {
                    if (!data.find(p => p.name === localVisitorResult.name)) data.push(localVisitorResult);
                    data.sort((a, b) => parseFloat(b.grade) - parseFloat(a.grade) || parseFloat(a.metric) - parseFloat(b.metric));
                }
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="text-slate-400 border-b border-slate-100 bg-slate-50/50"><tr><th class="p-2 text-center">#</th><th class="p-2 text-right">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody class="divide-y divide-slate-50">`;
                    data.forEach((p, i) => {
                        const isMe = (studentId && String(p.name).trim() === String(studentName).trim()) || p.isLocal;
                        h += `<tr class="${isMe ? 'rank-row-me' : ''}">
                            <td class="p-2 text-center ${i<3 ? 'text-xs' : 'text-slate-400'} font-black">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td>
                            <td class="p-2 font-black ${isMe ? 'text-blue-700' : 'text-slate-700'}">${p.name} ${isMe ? '<span class="bg-blue-600 text-white text-[7px] px-1 rounded-full mx-1">Ø£Ù†Øª</span>' : ''}</td>
                            <td class="p-2 text-center"><span class="text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</span></td>
                        </tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="py-6 text-center text-slate-400 text-[10px] italic font-bold">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            } catch (e) {
                content.innerHTML = `<div class="py-10 text-center flex flex-col items-center gap-2"><i class="fas fa-wifi text-slate-300 text-2xl"></i><p class="text-slate-400 text-[10px] font-bold">Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ.</p></div>`;
            } finally { document.getElementById('modal-loader').classList.add('hidden'); }
        };

        window.switchTab = (mode) => { currentLeaderboardMode = mode; document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; fetchAndShowLeaderboard(false); };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

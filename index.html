<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الرياضيات | أ.عبدالعزيز خالد العبلان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grade-display.passed { background-color: #dcfce7; color: #166534; }
        .grade-display.failed { background-color: #fee2e2; color: #991b1b; }
        #app-container { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- حاوية تسجيل الدخول (تظهر في البداية) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center">
        <main class="container mx-auto px-6 py-8">
            <div class="max-w-md mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-blue-800 mb-4">منصة الرياضيات</h1>
                    <p class="text-lg text-gray-600 mb-2">للمعلم: عبدالعزيز خالد العبلان</p>
                    <hr class="my-6">
                    <h2 class="text-2xl font-bold mb-2">أهلاً بك</h2>
                    <p class="text-gray-600 mb-6">أدخل رقم هويتك للدخول كطالب مسجل</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <input type="text" id="login-id" placeholder="رقم الهوية / الإقامة" class="w-full text-center text-lg px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 text-lg flex justify-center items-center transition-colors">
                            <span id="login-submit-text">دخول</span>
                            <div id="login-loader" class="loader hidden"></div>
                        </button>
                    </form>
                    <div id="login-error" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"></div>
                    <div class="mt-8">
                        <p class="text-gray-600 mb-2">أو</p>
                        <button id="visitor-btn" class="font-bold text-gray-700 hover:underline">المتابعة كزائر</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- حاوية التطبيق الرئيسية (تكون مخفية في البداية) -->
    <div id="app-container" class="hidden">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto px-6 py-8">
            <div id="dashboard-section" class="hidden bg-blue-50 p-6 rounded-lg shadow-lg mb-12 border-l-4 border-blue-500">
                <h3 class="text-2xl font-bold text-center mb-6">لوحة التحكم</h3>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xl font-bold text-blue-700 mb-3">معلوماتك المسجلة</h4>
                        <div class="bg-white p-4 rounded-lg border space-y-2">
                            <p><strong>الاسم:</strong> <span id="display-name"></span></p>
                            <p><strong>رقم الهوية:</strong> <span id="display-id"></span></p>
                            <p><strong>الصف:</strong> <span id="display-class"></span></p>
                            <p><strong>رقم الجوال:</strong> <span id="display-phone"></span></p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-blue-700 mb-3">ملخص الدرجات</h4>
                        <div class="bg-white p-4 rounded-lg border space-y-2">
                            <p><strong>مجموع الفصل الأول:</strong> <span id="total-c1" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الثاني:</strong> <span id="total-c2" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الثالث:</strong> <span id="total-c3" class="font-bold">0</span></p>
                            <p><strong>مجموع الفصل الرابع:</strong> <span id="total-c4" class="font-bold">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold text-center mb-6">فهرس الفصول الدراسية</h3>
                <div id="accordion-container" class="space-y-4"></div>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    
    <script>
        // =================================================================
        // == 1. الإعدادات والبيانات الأساسية
        // =================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const MAX_ATTEMPTS = 3;

        // =================================================================
        // == 2. دوال إدارة الواجهات (Views)
        // =================================================================
        function showAppView(studentData) {
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            if (loginView && appContainer) {
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }
            buildHeader(studentData);
            buildFooter();
            if (typeof curriculumIndex !== 'undefined') {
                buildAccordion(curriculumIndex, studentData);
            }
            if (studentData) {
                showStudentDashboard(studentData);
            }
        }

        function showLoginView() {
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            if (loginView && appContainer) {
                appContainer.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        }

        // =================================================================
        // == 3. دوال المصادقة والبيانات
        // =================================================================
        function getStudentFromStorage() {
            const studentDataString = localStorage.getItem('currentStudent');
            if (studentDataString) {
                try {
                    return JSON.parse(studentDataString);
                } catch (e) {
                    console.error("Error parsing student data", e);
                    localStorage.removeItem('currentStudent');
                    return null;
                }
            }
            return null;
        }

        function handleLogin(studentId) {
            const loader = document.getElementById('login-loader');
            const errorDiv = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}`)
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        showAppView(result.data);
                    } else {
                        errorDiv.textContent = 'رقم الهوية غير مسجل.';
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error("Login Error:", err);
                    errorDiv.textContent = 'خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.';
                    errorDiv.classList.remove('hidden');
                })
                .finally(() => {
                    loader.classList.add('hidden');
                    submitBtn.disabled = false;
                });
        }

        // =================================================================
        // == 4. دوال بناء مكونات الواجهة (UI Builders)
        // =================================================================
        function buildHeader(studentData) {
            const headerContainer = document.getElementById('main-header');
            if (!headerContainer) return;
            let userInfoHtml = '';
            if (studentData) {
                userInfoHtml = `
                    <div class="flex items-center gap-4">
                        <span class="font-semibold">أهلاً، ${studentData.name}</span>
                        <button id="logout-btn" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</button>
                    </div>`;
            } else {
                userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`;
            }
            headerContainer.innerHTML = `
                <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <a href="index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">رياضيات الصف الثالث المتوسط</h1></a>
                    ${userInfoHtml}
                </div>`;
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('currentStudent');
                    showLoginView();
                });
            }
        }

        function buildFooter() {
            const footerContainer = document.getElementById('main-footer');
            if (!footerContainer) return;
            const shareText = encodeURIComponent('أدعوك للاستفادة من منصة الرياضيات للمعلم عبدالعزيز العبلان:');
            const pageUrl = encodeURIComponent(window.location.origin);
            footerContainer.innerHTML = `
                <div class="container mx-auto px-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    <p class="text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p>
                    <div class="flex items-center space-x-4" dir="ltr">
                        <a href="https://twitter.com/intent/tweet?text=${shareText}&url=${pageUrl}" target="_blank" aria-label="Share on Twitter" class="text-gray-600 hover:text-blue-500"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg></a>
                        <a href="https://api.whatsapp.com/send?text=${shareText}%20${pageUrl}" target="_blank" aria-label="Share on WhatsApp" class="text-gray-600 hover:text-green-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06c0 1.66.41 3.23 1.21 4.6l-1.17 4.25 4.35-1.15c1.33.73 2.83 1.12 4.39 1.12 5.5 0 9.96-4.49 9.96-10.02S17.5 2.04 12 2.04zM16.56 14.26c-.16-.08-1.02-.5-1.18-.56-.16-.06-.28-.08-.41.08-.13.16-.44.56-.55.68-.1.12-.21.14-.38.06-.17-.08-1.02-.38-1.94-1.2-.72-.64-1.2-1.43-1.36-1.67-.16-.24-.02-.37.07-.49.08-.1.18-.26.27-.39.09-.12.12-.21.18-.35.06-.14.03-.26 0-.34-.03-.08-.41-1-.56-1.37-.16-.37-.32-.32-.44-.32h-.18c-.14 0-.36.06-.55.24-.18.18-.7.68-.7 1.65 0 .97.72 1.92.82 2.06.1.14 1.41 2.18 3.43 3.07.49.21.88.34 1.18.43.52.15 1 .13 1.35-.05.4-.18 1.18-.96 1.35-1.29.16-.32.16-.6.11-.68-.05-.08-.17-.13-.35-.21z"/></svg></a>
                        <span class="text-gray-600 text-sm">:شاركنا</span>
                    </div>
                </div>`;
        }

        function buildAccordion(curriculumIndex, studentData) {
            const accordionContainer = document.getElementById('accordion-container');
            if (!accordionContainer) return;
            accordionContainer.innerHTML = '';
            const studentLessons = studentData ? studentData.lessons || {} : {};
            Object.keys(curriculumIndex).forEach(chapterKey => {
                const chapter = curriculumIndex[chapterKey];
                const lessonsHtml = chapter.lessons.map(lesson => {
                    const lessonGradeData = studentLessons[lesson.id];
                    let gradeHtml = '';
                    if (studentData) {
                        const grade = lessonGradeData ? lessonGradeData.grade : '-';
                        const gradeClass = grade >= 5 ? 'passed' : (grade === '-' ? '' : 'failed');
                        gradeHtml = `<span id="grade-${lesson.id}" class="grade-display ${gradeClass} text-sm font-bold px-2 py-1 rounded">${grade}</span>`;
                    }
                    return `
                        <li class="flex justify-between items-center">
                            <a href="lessons/${lesson.id}.html" target="_top" class="lesson-link text-gray-600 hover:text-indigo-600 text-right">${lesson.title}</a>
                            ${gradeHtml}
                        </li>`;
                }).join('');
                const chapterHtml = `
                    <div class="border border-gray-200 rounded-lg">
                        <button class="chapter-toggle w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100">
                            <h4 class="text-xl font-bold text-blue-700">${chapter.title}</h4>
                            <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="lessons-list hidden p-4 border-t border-gray-200">
                            <ul class="space-y-3">${lessonsHtml}</ul>
                        </div>
                    </div>`;
                accordionContainer.innerHTML += chapterHtml;
            });
            document.querySelectorAll('.chapter-toggle').forEach(btn => {
                btn.onclick = () => {
                    btn.nextElementSibling.classList.toggle('hidden');
                    btn.querySelector('svg').classList.toggle('rotate-180');
                };
            });
        }

        function showStudentDashboard(studentData) {
            const dashboardSection = document.getElementById('dashboard-section');
            if (!dashboardSection) return;
            dashboardSection.classList.remove('hidden');
            ['name', 'id', 'class', 'phone'].forEach(key => {
                const el = document.getElementById(`display-${key}`);
                if (el) el.textContent = studentData[key] || '-';
            });
            const totals = { c1: 0, c2: 0, c3: 0, c4: 0 };
            if (studentData.lessons) {
                Object.keys(studentData.lessons).forEach(lessonId => {
                    const chapterKey = lessonId.substring(0, 2);
                    if (totals.hasOwnProperty(chapterKey)) {
                        totals[chapterKey] += studentData.lessons[lessonId].grade;
                    }
                });
            }
            Object.keys(totals).forEach(key => {
                const totalEl = document.getElementById(`total-${key}`);
                if (totalEl) totalEl.textContent = totals[key] || 0;
            });
        }
        
        // بيانات المنهج الأساسية (للفهرس)
        const curriculumIndex = {
            'c1': { 
                title: "الفصل ١: المعادلات الخطية",
                lessons: [
                    { id: 'c1_l1', title: 'الدرس ١-١: المعادلات' },
                    { id: 'c1_l2', title: 'الدرس ١-٢: حل المعادلات ذات الخطوة الواحدة' },
                ]
            },
            'c2': {
                title: "الفصل ٢: العلاقات والدوال الخطية",
                lessons: [
                    { id: 'c2_l1', title: 'الدرس ٢-١: العلاقات' },
                    { id: 'c2_l2', title: 'الدرس ٢-٢: الدوال' },
                ]
            }
        };

        // نقطة انطلاق التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            const student = getStudentFromStorage();
            if (student) {
                showAppView(student);
            } else {
                showLoginView();
            }

            // ربط الأحداث الخاصة بواجهة تسجيل الدخول
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('login-id').value.trim();
                if (studentId) handleLogin(studentId);
            });

            const visitorBtn = document.getElementById('visitor-btn');
            visitorBtn.addEventListener('click', () => {
                localStorage.removeItem('currentStudent');
                showAppView(null); // عرض لوحة التحكم كزائر
            });
        });
    </script>
</body>
</html>

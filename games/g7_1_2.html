<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†ÙŠÙ†Ø¬Ø§ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ - V20.0 (Comprehensive Leaderboard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            overflow: hidden;
            background-color: #1e293b;
            touch-action: none;
            user-select: none;
            height: 100vh;
            width: 100vw;
            margin: 0;
        }
        .arabic-num { font-feature-settings: "ss01"; font-variant-numeric: tabular-nums; }
        #game-container {
            max-width: 450px;
            height: 100%;
            margin: 0 auto;
            position: relative;
            background-color: #1e293b;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }
        .pulse-btn { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .var-group { display: inline-flex; align-items: flex-start; flexDirection: row; margin-left: 8px; }
        .exponent-style {
            font-size: 0.75em; color: #fbbf24; font-weight: 900; position: relative; top: -0.4em; margin-right: -2px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); line-height: 1;
        }
        .loader { border: 2px solid #334155; border-top: 2px solid #3b82f6; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rank-row-me { background-color: #312e81 !important; border-right: 4px solid #facc15 !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        @keyframes scarf-flow { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .scarf-anim { animation: scarf-flow 2s ease-in-out infinite; transform-origin: top left; }

        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (V20) --- */
        .tab-btn { flex: 1; text-align: center; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="flex justify-between items-center px-4 py-2 bg-slate-800 text-white z-50 shadow-md h-[50px] shrink-0 border-b border-slate-700">
            <div class="bg-indigo-900/50 border border-indigo-500/30 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">
                <span class="text-indigo-300">Ø§Ù„Ø³Ø§Ø¨Ù‚:</span>
                <span id="prev-score-display" class="arabic-num text-white">--</span>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-user-ninja text-indigo-400"></i>
                <div id="student-name-display" class="font-bold text-sm truncate max-w-[150px] text-indigo-100">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...
                </div>
            </div>
        </div>

        <div id="content-area" class="relative flex-grow w-full h-full overflow-hidden">

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
            <div id="screen-splash" class="absolute inset-0 flex flex-col justify-center items-center bg-slate-900 z-40 p-6 text-center">
                <div class="mb-6 relative">
                    <!-- Ninja Character SVG -->
                    <svg width="140" height="140" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="100" cy="100" r="90" fill="#0f172a" fill-opacity="0.5"/>
                        <path class="scarf-anim" d="M140 120 C160 120 190 100 195 90 C200 80 190 130 170 140 C150 150 140 140 130 130" stroke="#ef4444" stroke-width="12" stroke-linecap="round"/>
                        <circle cx="100" cy="95" r="55" fill="#1e293b" stroke="#334155" stroke-width="4"/>
                        <path d="M70 85 C70 85 85 80 100 80 C115 80 130 85 130 85 V105 C130 105 115 115 100 115 C85 115 70 105 70 105 V85Z" fill="#fca5a5"/>
                        <path d="M70 105 C70 105 85 115 100 115 C115 115 130 105 130 105 V125 C130 140 100 145 100 145 C100 145 70 140 70 125 V105Z" fill="#1e293b"/>
                        <rect x="65" y="60" width="70" height="20" rx="4" fill="#94a3b8"/>
                        <circle cx="72" cy="70" r="3" fill="#cbd5e1"/>
                        <circle cx="128" cy="70" r="3" fill="#cbd5e1"/>
                        <path d="M95 65 L105 65 M100 65 V75" stroke="#475569" stroke-width="2" stroke-linecap="round"/>
                        <path d="M78 92 L88 95" stroke="black" stroke-width="2" stroke-linecap="round"/>
                        <path d="M122 92 L112 95" stroke="black" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="85" cy="96" r="3" fill="black"/>
                        <circle cx="115" cy="96" r="3" fill="black"/>
                        <path d="M65 65 C50 60 40 50 35 40" stroke="#94a3b8" stroke-width="8" stroke-linecap="round"/>
                        <path d="M65 75 C50 80 40 90 35 100" stroke="#94a3b8" stroke-width="8" stroke-linecap="round"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2">Ù†ÙŠÙ†Ø¬Ø§ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</h1>
                <p class="text-slate-400 text-sm mb-8">ÙƒÙ† Ø¨Ø·Ù„Ø§Ù‹ ÙˆØ§Ù‚Ø·Ø¹ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØµØ­ÙŠØ­Ø©!</p>
                <div class="space-y-3 w-full max-w-[260px]">
                    <button onclick="GameApp.startGame()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 transition-all">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ âš”ï¸</button>
                    <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                    <button onclick="window.fetchAndShowLeaderboard(true)" class="w-full py-3 bg-slate-700 text-slate-200 rounded-xl font-bold border border-slate-600 text-sm">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</button>
                </div>
                <div class="mt-auto pt-6 text-[10px] text-slate-600 font-Cairo">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù† (V20.0)</div>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
            <div id="screen-game" class="absolute inset-0 z-10 hidden bg-slate-900">
                <div class="absolute top-0 w-full z-20 flex flex-col items-center pt-2 pointer-events-none">
                    <div class="flex justify-between w-full px-4 mb-2 items-start">
                        <div class="bg-black/40 px-3 py-1 rounded text-white text-xs mt-1">Ù…Ø³ØªÙˆÙ‰ <span id="current-round" class="text-yellow-400 font-bold arabic-num">1</span></div>
                        <div class="flex flex-col items-end">
                            <div class="bg-black/40 px-3 py-1 rounded text-white text-xs mb-1"><span id="lives-display">â¤ï¸â¤ï¸â¤ï¸</span></div>
                            <div id="timer-display" class="text-[10px] font-bold text-slate-400 font-mono bg-slate-800/80 px-2 rounded-md border border-slate-700 arabic-num">00:00</div>
                        </div>
                    </div>
                    <div class="bg-slate-800/90 border-2 border-yellow-500/50 px-6 py-2 rounded-xl text-center shadow-lg backdrop-blur-sm min-w-[180px]">
                        <span class="text-slate-400 text-[10px] block font-bold">Ø­Ù„Ù„ ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯:</span>
                        <div id="target-monomial" class="text-4xl font-black text-white arabic-num py-2 flex justify-center items-center gap-1" dir="rtl">...</div>
                    </div>
                    <div class="mt-2 bg-black/50 px-4 py-1 rounded-full border border-white/10">
                        <span class="text-slate-400 text-[10px]">Ø§Ù„Ù…Ø¬Ù…Ø¹:</span>
                        <span id="collected-factors" class="text-emerald-400 font-bold text-lg arabic-num mx-2" dir="ltr">...</span>
                    </div>
                </div>
                <div class="absolute bottom-6 w-full flex justify-center z-30 pointer-events-auto">
                    <button id="finish-btn" onclick="GameApp.ninja.checkAnswer()" class="pulse-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-10 rounded-full shadow-lg border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1 transition-all">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ âœ…</button>
                </div>
                <canvas id="gameCanvas"></canvas>
            </div>

            <!-- Feedback Overlay -->
            <div id="screen-feedback" class="absolute inset-0 z-[60] hidden flex flex-col justify-center items-center bg-slate-900/98 backdrop-blur-xl p-6">
                <div id="feedback-icon" class="text-6xl mb-4 animate-bounce">ğŸ¤”</div>
                <h2 id="feedback-title" class="text-2xl font-bold text-white mb-2">...</h2>
                <div id="feedback-stars" class="flex gap-1 mb-6 text-2xl text-slate-700"></div>
                <div class="bg-slate-800 w-full max-w-sm rounded-xl p-5 border border-slate-600 shadow-2xl text-center">
                    <div class="mb-4 border-b border-slate-700 pb-3">
                        <p class="text-slate-400 text-xs font-bold mb-1">Ø§Ù„Ø³Ø¤Ø§Ù„</p>
                        <div id="feedback-question" class="text-4xl font-black text-white arabic-num flex justify-center items-center gap-1" dir="rtl"></div>
                    </div>
                    <div>
                        <p class="text-emerald-400 text-xs font-bold mb-1">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­</p>
                        <div id="feedback-correct-answer" class="text-2xl font-bold text-yellow-400 arabic-num" dir="ltr"></div>
                    </div>
                </div>
                <button onclick="GameApp.nextStep()" class="mt-8 bg-white text-slate-900 px-8 py-3 rounded-xl font-bold hover:bg-gray-100 transition-colors shadow-lg">Ø§Ù„ØªØ§Ù„ÙŠ âœ</button>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
            <div id="screen-result" class="absolute inset-0 z-50 hidden flex flex-col justify-center items-center bg-slate-900 p-6">
                <h2 class="text-3xl font-bold text-white mb-6">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
                <div class="relative w-36 h-36 flex items-center justify-center mb-4">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#334155" stroke-width="8" />
                        <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke="#10b981" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="transition-all duration-1000" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="final-score-val" class="text-4xl font-black text-white arabic-num">0</span>
                        <span class="text-xs text-slate-400">Ù…Ù† 5</span>
                    </div>
                </div>
                
                <div class="bg-blue-500/10 border border-blue-500/20 px-4 py-2 rounded-lg mb-6 flex items-center gap-2">
                    <i class="fas fa-stopwatch text-blue-400"></i>
                    <span class="text-blue-400 text-sm">Ø§Ù„ÙˆÙ‚Øª:</span>
                    <span id="final-time-val" class="text-xl font-bold text-white arabic-num">00:00</span>
                </div>

                <div class="w-full bg-slate-800 rounded-xl p-4 mb-4 border border-slate-700 flex flex-col h-[200px]">
                    <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                        <h3 id="leaderboard-title" class="text-xs font-bold text-slate-400">Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h3>
                        <div class="flex items-center gap-2">
                            <div id="leaderboard-loader" class="hidden"><div class="loader"></div></div>
                            <!-- Ø²Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                            <button onclick="window.fetchAndShowLeaderboard(true)" class="bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 text-[10px] px-2 py-1 rounded transition-colors flex items-center gap-1">
                                <i class="fas fa-expand"></i> ØªÙƒØ¨ÙŠØ±
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto custom-scroll flex-grow pr-1">
                        <table class="w-full text-sm text-right text-slate-300"><tbody id="leaderboard-body"></tbody></table>
                    </div>
                </div>

                <div class="flex gap-2 w-full max-w-[300px]">
                    <button onclick="location.reload()" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow">Ø¥Ø¹Ø§Ø¯Ø©</button>
                    <button onclick="GameApp.finishGame()" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-lg font-bold border border-slate-600">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>
            </div>

            <!-- Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Modal V20) -->
            <div id="leaderboard-modal" class="absolute inset-0 bg-slate-900 z-[100] hidden flex-col p-4 opacity-0 transition-all duration-200 transform scale-95" dir="rtl">
                <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
                <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                    <h3 class="font-black text-white text-lg"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
                    <button onclick="window.closeLeaderboardModal()" class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-red-500 transition shadow-lg border border-slate-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Tabs) -->
                <div class="flex gap-2 mb-2">
                    <button onclick="window.switchLeaderboardTab('class')" id="tab-class" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                    <button onclick="window.switchLeaderboardTab('global')" id="tab-global" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ù…Ù„ÙƒØ© (Ø§Ù„ÙƒÙ„)</button>
                </div>

                <!-- Ù…Ù†Ø·Ù‚Ù‡ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
                <div class="flex-1 overflow-y-auto no-scrollbar space-y-1 bg-slate-800/50 rounded-xl p-2 border border-slate-700 relative">
                    <div id="modal-leaderboard-loader" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 z-10 hidden">
                        <div class="loader"></div>
                    </div>
                    <div id="modal-leaderboard-body"></div>
                </div>
                <p class="text-center text-[10px] text-slate-500 mt-2">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨: Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰ > Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ© (ÙˆÙ‚Øª/Ø£Ø®Ø·Ø§Ø¡)</p>
            </div>

            <div id="loader" class="absolute inset-0 z-[100] bg-slate-900/90 hidden flex flex-col justify-center items-center">
                <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-white text-sm animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</p>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec';
        const urlParams = new URLSearchParams(window.location.search);
        
        const AppConfig = {
            gameId: urlParams.get('gameId') || 'g7_1_2',
            studentId: urlParams.get('studentId'),
            classId: urlParams.get('classId'),
            studentName: urlParams.get('name') || urlParams.get('studentName') || "Ø¨Ø·Ù„ Ù†ÙŠÙ†Ø¬Ø§"
        };

        // --- ÙƒÙˆØ¯ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø´Ø§Ù…Ù„ V20 ---
        let currentLeaderboardMode = 'class'; 
        let classLeaderboardData = []; // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª

        const Utils = {
            toArabicNum: (num) => {
                if (num === null || num === undefined) return '';
                return String(num).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
            },
            formatTime: (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const m = Math.floor(totalSeconds / 60);
                const s = totalSeconds % 60;
                return `${Utils.toArabicNum(m)}:${Utils.toArabicNum(String(s).padStart(2, '0'))}`;
            }
        };

        // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        window.switchLeaderboardTab = function(mode) {
            currentLeaderboardMode = mode;
            if (mode === 'class') {
                document.getElementById('tab-class').className = 'tab-btn tab-active';
                document.getElementById('tab-global').className = 'tab-btn tab-inactive';
            } else {
                document.getElementById('tab-global').className = 'tab-btn tab-active';
                document.getElementById('tab-class').className = 'tab-btn tab-inactive';
            }
            window.fetchAndShowLeaderboard(true);
        };

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨ ÙˆØ§Ù„Ø¹Ø±Ø¶
        window.fetchAndShowLeaderboard = function(isManual = false) {
            if (isManual) { 
                const modal = document.getElementById('leaderboard-modal');
                modal.classList.remove('hidden', 'opacity-0', 'pointer-events-none', 'scale-95');
                modal.classList.add('flex', 'opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('modal-leaderboard-loader').classList.remove('hidden');
            }
            
            const container = document.getElementById('modal-leaderboard-body');
            container.innerHTML = '';
            
            let requestClassId = (currentLeaderboardMode === 'class') ? (AppConfig.classId || '') : 'all';
            
            let url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${AppConfig.gameId}&classId=${encodeURIComponent(requestClassId)}&t=${Date.now()}`;
            
            fetch(url)
                .then(res => res.json())
                .then(response => {
                    let dataToRender = [];
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        dataToRender = response.data;
                        if (currentLeaderboardMode === 'class') classLeaderboardData = dataToRender;
                    } else if (currentLeaderboardMode === 'global' && classLeaderboardData.length > 0) {
                        dataToRender = classLeaderboardData;
                    }
                    
                    if (dataToRender.length > 0) {
                        let html = `<table class="w-full text-right text-[10px]"><tbody class="divide-y divide-slate-700">`;
                        dataToRender.forEach((p, i) => {
                            const isMe = (AppConfig.studentId && String(p.studentId) === String(AppConfig.studentId));
                            const metricVal = parseFloat(p.metricValue) || 0; // Ø§Ù„ÙˆÙ‚Øª Ù‡Ù†Ø§
                            const gradeVal = parseFloat(p.grade) || 0;
                            
                            let classDisplay = "";
                            if (currentLeaderboardMode === 'global' && p.className) {
                                classDisplay = `<div class="text-[9px] text-blue-400 mt-0.5"><i class="fas fa-users ml-1"></i> ${p.className}</div>`;
                            }

                            html += `
                                <tr class="${isMe ? 'rank-row-me' : ''} hover:bg-slate-800 transition">
                                    <td class="p-3 text-center font-black w-10 text-lg ${i<3 ? 'text-yellow-400' : 'text-slate-500'}">${Utils.toArabicNum(i+1)}</td>
                                    <td class="p-3 font-bold text-slate-300">
                                        ${p.name}
                                        ${isMe ? '<span class="mr-2 text-[8px] bg-blue-600 text-white px-1.5 py-0.5 rounded-full">Ø£Ù†Øª</span>' : ''}
                                        ${classDisplay}
                                    </td>
                                    <td class="p-3 text-left">
                                        <div class="flex flex-col items-end">
                                            <span class="font-mono font-bold text-emerald-400 text-sm">${Utils.toArabicNum(gradeVal.toFixed(1))}</span>
                                            ${metricVal > 0 ? `<span class="text-[9px] text-slate-500">(${Utils.formatTime(metricVal)})</span>` : ''}
                                        </div>
                                    </td>
                                </tr>`;
                        });
                        container.innerHTML = html + `</tbody></table>`;
                    } else {
                        container.innerHTML = `<p class="py-12 text-slate-500 text-[11px] text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
                    }
                })
                .finally(() => { 
                    if(isManual) document.getElementById('modal-leaderboard-loader').classList.add('hidden');
                });
        };

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        window.closeLeaderboardModal = function() {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.add('hidden', 'opacity-0', 'pointer-events-none', 'scale-95');
            modal.classList.remove('flex', 'opacity-100', 'pointer-events-auto', 'scale-100');
        };

        const AppState = {
            startTime: 0,
            endTime: 0,
            prevScore: 0,
            totalPoints: 0, 
            maxPoints: 15,
            totalMistakes: 0,
            maxRounds: 5,
            timerInterval: null
        };

        const QuestionBank = {
            levels: {
                1: [{ coeff: 10, vars: {} }, { coeff: 12, vars: {} }, { coeff: 36, vars: {} }, { coeff: 49, vars: {} }, { coeff: 18, vars: {} }],
                2: [{ coeff: 2, vars: { 'Ø³': 3 } }, { coeff: 3, vars: { 'Øµ': 2 } }, { coeff: 5, vars: { 'Ø£': 2 } }, { coeff: 7, vars: { 'Ø¨': 3 } }],
                3: [{ coeff: 4, vars: { 'Ø³': 2 } }, { coeff: 6, vars: { 'Øµ': 3 } }, { coeff: 9, vars: { 'Ø£': 2 } }, { coeff: 8, vars: { 'Ø³': 3 } }],
                4: [{ coeff: 2, vars: { 'Ø³': 2, 'Øµ': 1 } }, { coeff: 3, vars: { 'Ø£': 1, 'Ø¨': 2 } }, { coeff: 5, vars: { 'Ø³': 2, 'Ø¹': 2 } }, { coeff: 7, vars: { 'Ù…': 1, 'Ù†': 2 } }],
                5: [{ coeff: 12, vars: { 'Ø³': 2, 'Øµ': 1 } }, { coeff: 36, vars: { 'Ø³': 1, 'Øµ': 2 } }, { coeff: 18, vars: { 'Ø£': 2, 'Ø¨': 2 } }, { coeff: 4, vars: { 'Ø³': 3, 'Øµ': 2 } }]
            },
            generate: (level) => {
                const currentLevelQuestions = QuestionBank.levels[level] || QuestionBank.levels[1];
                const index = Math.floor(Math.random() * currentLevelQuestions.length);
                return QuestionBank.process(currentLevelQuestions[index]);
            },
            process: (data) => {
                let factors = [];
                let num = data.coeff;
                let d = 2;
                while (d * d <= num) {
                    while (num % d === 0) { factors.push(Utils.toArabicNum(d)); num /= d; }
                    d++;
                }
                if (num > 1) factors.push(Utils.toArabicNum(num));
                for (let v in data.vars) {
                    for (let i = 0; i < data.vars[v]; i++) factors.push(v);
                }
                factors.sort((a, b) => {
                    const isNumA = /[Ù -Ù©]/.test(a);
                    const isNumB = /[Ù -Ù©]/.test(b);
                    if (isNumA && !isNumB) return -1;
                    if (!isNumA && isNumB) return 1;
                    return a.localeCompare(b);
                });
                let displayHTML = '';
                if (data.coeff !== 1 || Object.keys(data.vars).length === 0) {
                    displayHTML += `<span class="inline-block">${Utils.toArabicNum(data.coeff)}</span>`;
                }
                let keys = Object.keys(data.vars).sort();
                for (let k of keys) {
                    if (data.vars[k] > 1) {
                        displayHTML += `<span class="var-group text-4xl">${k}<span class="exponent-style">${Utils.toArabicNum(data.vars[k])}</span></span>`;
                    } else {
                        displayHTML += `<span class="inline-block mx-px text-4xl">${k}</span>`;
                    }
                }
                return {
                    display: displayHTML,
                    required: factors,
                    remaining: [...factors],
                    fullAnswer: factors.join(' Ã— '),
                    existingVars: Object.keys(data.vars),
                    rawCoeff: data.coeff 
                };
            }
        };

        class NinjaGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 0; this.height = 0;
                this.balls = []; this.particles = []; this.trail = []; this.collected = [];
                this.input = { x: 0, y: 0 };
                this.setupEvents();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.width = this.canvas.width = rect.width;
                this.height = this.canvas.height = rect.height;
            }

            setupEvents() {
                const move = (x, y) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.input.x = x - rect.left;
                    this.input.y = y - rect.top;
                    this.trail.push({ x: this.input.x, y: this.input.y, life: 10 }); 
                    this.checkCollision();
                };
                this.canvas.addEventListener('mousemove', (e) => move(e.clientX, e.clientY));
                this.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
            }

            init() { this.resize(); this.currentRound = 1; this.startRound(); this.loop(); }

            startRound() {
                this.isPaused = false; this.lives = 3; this.balls = []; this.collected = []; this.trail = [];
                this.target = QuestionBank.generate(this.currentRound);
                
                document.getElementById('current-round').innerText = Utils.toArabicNum(this.currentRound);
                document.getElementById('target-monomial').innerHTML = this.target.display;
                document.getElementById('lives-display').innerText = 'â¤ï¸â¤ï¸â¤ï¸';
                document.getElementById('feedback-question').innerHTML = this.target.display;
                this.updateCollectedUI();
                if (this.spawnTimer) clearInterval(this.spawnTimer);
                this.spawnTimer = setInterval(() => { if (!this.isPaused && this.balls.length < 5) this.spawnBall(); }, 1200);
            }

            updateCollectedUI() {
                const el = document.getElementById('collected-factors');
                if (this.collected.length === 0) el.innerHTML = '<span class="text-slate-500 text-xs">Ù„Ø§ Ø´ÙŠØ¡</span>';
                else el.innerHTML = this.collected.map(item => `<span class="${item.correct ? 'text-emerald-400' : 'text-red-400'} mx-1">${item.val}</span>`).join('<span class="text-white text-xs">Ã—</span>');
            }

            spawnBall() {
                const r = 35;
                const x = Math.random() * (this.width - 2 * r) + r;
                let val, isCorrect;
                
                if (Math.random() < 0.6 && this.target.remaining.length > 0) {
                    const idx = Math.floor(Math.random() * this.target.remaining.length);
                    val = this.target.remaining[idx]; 
                    isCorrect = true;
                } else {
                    isCorrect = false;
                    let distractorPool = [];
                    const coeff = this.target.rawCoeff;

                    if (coeff > 1) {
                        if (coeff >= 4) distractorPool.push(Utils.toArabicNum(coeff - 2)); 
                        if (coeff % 2 === 0 && coeff > 2) distractorPool.push(Utils.toArabicNum(coeff / 2)); 
                        if (coeff > 3) distractorPool.push(Utils.toArabicNum(coeff - 1)); 
                        if (coeff % 3 === 0 && coeff > 3) distractorPool.push(Utils.toArabicNum(coeff / 3));
                        if ([12, 18, 24, 36].includes(coeff)) distractorPool.push('Ù¤', 'Ù¦', 'Ù©', 'Ù¡Ù¢'); 
                        distractorPool.push('Ù¤', 'Ù¦', 'Ù¨', 'Ù©', 'Ù¡Ù ', 'Ù¡Ù¢');
                    }
                    
                    if (this.target.existingVars && this.target.existingVars.length > 0) {
                        distractorPool = distractorPool.concat(this.target.existingVars);
                    }

                    const randoms = ['Ù¢', 'Ù£', 'Ù¥', 'Ù§', 'Ø³', 'Øµ', 'Ø£', 'Ø¨'];
                    distractorPool = distractorPool.concat(randoms);

                    val = distractorPool[Math.floor(Math.random() * distractorPool.length)];

                    if (this.target.remaining.includes(val)) {
                        isCorrect = true; 
                    }
                }

                this.balls.push({ 
                    x, 
                    y: this.height + r, 
                    r, 
                    val, 
                    isCorrect, 
                    vx: (Math.random() - 0.5) * 3, 
                    vy: -(Math.random() * 3 + 5.5), 
                    gravity: 0.08, 
                    angle: 0 
                });
            }

            checkCollision() {
                if (this.trail.length < 1) return;
                const p = this.trail[this.trail.length - 1];
                for (let i = this.balls.length - 1; i >= 0; i--) {
                    const ball = this.balls[i];
                    const dist = Math.hypot(ball.x - p.x, ball.y - p.y);
                    if (dist < ball.r + 10) {
                        this.sliceBall(ball, i);
                    }
                }
            }

            sliceBall(ball, index) {
                this.balls.splice(index, 1);
                for (let i = 0; i < 10; i++) this.particles.push({ x: ball.x, y: ball.y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1, color: ball.isCorrect ? '#10b981' : '#ef4444' });

                if (ball.isCorrect) {
                    const needIdx = this.target.remaining.indexOf(ball.val);
                    if (needIdx > -1) {
                        this.target.remaining.splice(needIdx, 1);
                        this.collected.push({ val: ball.val, correct: true });
                    } else {
                        this.collected.push({ val: ball.val, correct: false });
                        this.handleMistake();
                    }
                } else {
                    this.collected.push({ val: ball.val, correct: false });
                    this.handleMistake();
                }
                this.updateCollectedUI();
            }

            handleMistake() {
                AppState.totalMistakes++; this.lives--;
                let hearts = ''; for(let i=0; i<this.lives; i++) hearts += 'â¤ï¸';
                document.getElementById('lives-display').innerText = hearts;
                document.getElementById('lives-display').parentElement.classList.add('shake');
                setTimeout(() => document.getElementById('lives-display').parentElement.classList.remove('shake'), 500);

                if (this.lives <= 0) { 
                    this.isPaused = true; 
                    GameApp.showFeedback(false, this.target.display, this.target.fullAnswer, 0); 
                }
            }

            checkAnswer() {
                if (this.isPaused) return;
                const isComplete = this.target.remaining.length === 0;

                if (isComplete) {
                    this.isPaused = true; 
                    const roundPoints = this.lives; 
                    AppState.totalPoints += roundPoints;

                    GameApp.showFeedback(true, this.target.display, this.target.fullAnswer, roundPoints);
                } else {
                    if (this.lives > 0) {
                        const btn = document.getElementById('finish-btn');
                        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                        btn.classList.add('bg-red-600');
                        btn.innerText = 'Ù†Ø§Ù‚ØµØ©! âŒ';
                        setTimeout(() => {
                            btn.classList.remove('bg-red-600');
                            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
                            btn.innerText = 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ âœ…';
                        }, 800);
                        this.handleMistake(); 
                    }
                }
            }

            loop() {
                if (!this.isPaused) {
                    this.ctx.clearRect(0, 0, this.width, this.height);
                    
                    this.balls.forEach((ball, i) => {
                        ball.x += ball.vx; ball.y += ball.vy; ball.vy += ball.gravity; ball.angle += 0.05;
                        if (ball.y > this.height + 100) { this.balls.splice(i, 1); return; }
                        
                        this.ctx.save();
                        this.ctx.translate(ball.x, ball.y);
                        this.ctx.save();
                        this.ctx.rotate(ball.angle);
                        this.ctx.beginPath(); this.ctx.arc(0, 0, ball.r, 0, Math.PI * 2);
                        const grad = this.ctx.createRadialGradient(-10, -10, 0, 0, 0, ball.r);
                        grad.addColorStop(0, '#7dd3fc'); grad.addColorStop(1, '#0369a1');
                        this.ctx.fillStyle = grad; this.ctx.fill();
                        this.ctx.strokeStyle = 'white'; this.ctx.lineWidth = 3; this.ctx.stroke();
                        this.ctx.restore(); 
                        
                        this.ctx.fillStyle = 'white'; this.ctx.font = 'bold 28px Cairo';
                        this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(ball.val, 0, 0); 
                        
                        this.ctx.restore();
                    });

                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                        if (p.life <= 0) { this.particles.splice(i, 1); continue; }
                        this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color;
                        this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 5, 0, Math.PI * 2); this.ctx.fill(); this.ctx.globalAlpha = 1;
                    }

                    for (let i = 0; i < this.trail.length; i++) {
                        this.trail[i].life -= 1.5;
                    }
                    this.trail = this.trail.filter(p => p.life > 0);

                    if (this.trail.length > 1) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.trail[0].x, this.trail[0].y);
                        for (let i = 1; i < this.trail.length - 1; i++) {
                            const xc = (this.trail[i].x + this.trail[i + 1].x) / 2;
                            const yc = (this.trail[i].y + this.trail[i + 1].y) / 2;
                            this.ctx.quadraticCurveTo(this.trail[i].x, this.trail[i].y, xc, yc);
                        }
                        if (this.trail.length > 2) {
                            this.ctx.lineTo(this.trail[this.trail.length - 1].x, this.trail[this.trail.length - 1].y);
                        }

                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                        this.ctx.strokeStyle = 'white';
                        this.ctx.lineWidth = 5; 
                        this.ctx.lineCap = 'round';
                        this.ctx.stroke();
                        this.ctx.shadowBlur = 0;
                    }
                }
                requestAnimationFrame(() => this.loop());
            }
        }

        const GameApp = {
            ninja: new NinjaGame(),
            init: async () => {
                document.getElementById('student-name-display').innerText = decodeURIComponent(AppConfig.studentName);
                if (AppConfig.studentId && AppConfig.classId) {
                    await GameApp.fetchInitialDataV19();
                } else {
                    document.getElementById('student-name-display').innerText = "Ø²Ø§Ø¦Ø±";
                }
                GameApp.showScreen('splash');
            },
            fetchInitialDataV19: async () => {
                try {
                    const url = `${SCRIPT_URL}?action=getStudentData&studentId=${AppConfig.studentId}&classId=${encodeURIComponent(AppConfig.classId)}&itemId=${AppConfig.gameId}&t=${Date.now()}`;
                    const res = await fetch(url);
                    const response = await res.json();
                    if (response.status === 'success' && response.data) {
                        if (response.data.name) {
                            AppConfig.studentName = response.data.name;
                            document.getElementById('student-name-display').innerText = response.data.name;
                        }
                        const games = response.data.games || {};
                        if (games[AppConfig.gameId]) {
                            AppState.prevScore = parseFloat(games[AppConfig.gameId].grade) || 0;
                            document.getElementById('prev-score-display').innerText = Utils.toArabicNum(AppState.prevScore.toFixed(1));
                        }
                    }
                } catch (e) { console.error("Connection error"); }
            },
            saveDataV19: async (grade, metric) => {
                if (!AppConfig.studentId) return;
                document.getElementById('leaderboard-loader').classList.remove('hidden');
                const params = new URLSearchParams({ 
                    action: 'saveScore', 
                    studentId: AppConfig.studentId, 
                    classId: AppConfig.classId || '0', 
                    itemId: AppConfig.gameId, 
                    score: grade, 
                    metricValue: metric, 
                    type: 'game' 
                });
                try { await fetch(`${SCRIPT_URL}?${params.toString()}`); } 
                catch(e) { console.error("Save failed"); } 
                finally { 
                    // Ù†Ù‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± (ÙˆÙ‡ÙŠ ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù„Ø¨)
                    // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù†Ù…Ø±Ø± false Ù„Ø¹Ø¯Ù… ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ ÙˆÙ†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± ÙŠØ¯ÙˆÙŠØ§Ù‹
                    // Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ø³Ù†Ø³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± ÙÙ‚Ø·ØŒ
                    // Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± ÙŠØ¯ÙˆÙŠØ§Ù‹.
                    // Ù‡Ù†Ø§ Ø³Ù†Ø³ØªØ¯Ø¹ÙŠ fetchLeaderboardV19 Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„ØªÙŠ Ø³Ù†Ø¹ÙŠØ¯ ØªØ¹Ø±ÙŠÙÙ‡Ø§ Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
                    GameApp.updateMiniLeaderboard(); 
                }
            },
            // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ± (Mini Leaderboard)
            updateMiniLeaderboard: () => {
                const tbody = document.getElementById('leaderboard-body');
                document.getElementById('leaderboard-loader').classList.remove('hidden');
                tbody.innerHTML = '';
                
                let url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${AppConfig.gameId}&classId=${encodeURIComponent(AppConfig.classId || '')}&t=${Date.now()}`;
                fetch(url)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            GameApp.renderTable(response.data, 'leaderboard-body');
                        }
                    })
                    .finally(() => document.getElementById('leaderboard-loader').classList.add('hidden'));
            },
            renderTable: (data, targetElementId) => {
                const tbody = document.getElementById(targetElementId);
                let html = '';
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-slate-500 text-xs">ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</td></tr>';
                    return;
                }
                data.slice(0, 10).forEach((row, i) => { // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØºÙŠØ±
                    const isMe = (AppConfig.studentId && String(row.studentId) === String(AppConfig.studentId));
                    const padding = 'p-2 text-xs';
                    const iconSize = 'text-xs';
                    html += `
                        <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition-colors ${isMe ? 'rank-row-me' : ''}">
                            <td class="${padding} text-center font-bold ${i < 3 ? 'text-yellow-400 '+iconSize : 'text-slate-500'}">
                                ${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : Utils.toArabicNum(i+1)}
                            </td>
                            <td class="${padding} font-bold ${isMe ? 'text-white' : 'text-slate-300'}">
                                ${row.name} ${isMe ? '<span class="text-[10px] bg-indigo-500 text-white px-1.5 rounded-full mr-1">Ø£Ù†Øª</span>' : ''}
                            </td>
                            <td class="${padding} text-center text-emerald-400 font-bold arabic-num">
                                ${Utils.toArabicNum(parseFloat(row.grade).toFixed(1))}
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            },
            // ØªÙ… Ø¯Ù…Ø¬ fetchLeaderboardV19 Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ updateMiniLeaderboard
            fetchLeaderboardV19: (showModal = false) => {
               if (showModal) window.fetchAndShowLeaderboard(true);
               else GameApp.updateMiniLeaderboard();
            },
            openFullLeaderboard: () => window.fetchAndShowLeaderboard(true),
            closeFullLeaderboard: () => window.closeLeaderboardModal(),
            
            showFeedback: (isSuccess, question, answer, roundPoints) => {
                const screen = document.getElementById('screen-feedback');
                const icon = document.getElementById('feedback-icon');
                const title = document.getElementById('feedback-title');
                const starsContainer = document.getElementById('feedback-stars');
                screen.classList.remove('hidden');
                document.getElementById('feedback-question').innerHTML = question;
                document.getElementById('feedback-correct-answer').innerText = answer;
                let starsHTML = '';
                if (isSuccess && roundPoints > 0) {
                    for(let i=0; i<3; i++) {
                        starsHTML += `<i class="fas fa-star ${i < roundPoints ? 'text-yellow-400' : 'text-slate-600'}"></i>`;
                    }
                    starsContainer.innerHTML = starsHTML;
                    if (roundPoints === 3) {
                        icon.innerText = 'ğŸ‰'; title.innerText = 'Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!'; title.className = 'text-2xl font-bold text-emerald-400 mb-2';
                    } else {
                        icon.innerText = 'â­'; title.innerText = 'Ø¬ÙŠØ¯!'; title.className = 'text-2xl font-bold text-yellow-400 mb-2';
                    }
                } else {
                    starsContainer.innerHTML = '<i class="fas fa-heart-broken text-red-500"></i>';
                    icon.innerText = 'ğŸ’€'; title.innerText = 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'; title.className = 'text-2xl font-bold text-red-400 mb-2';
                }
            },
            nextStep: () => {
                document.getElementById('screen-feedback').classList.add('hidden');
                if (GameApp.ninja.currentRound < AppState.maxRounds) { GameApp.ninja.currentRound++; GameApp.ninja.startRound(); }
                else GameApp.showResult();
            },
            showScreen: (id) => {
                ['screen-splash', 'screen-game', 'screen-result', 'screen-feedback'].forEach(s => document.getElementById(s).classList.add('hidden'));
                document.getElementById('screen-' + id).classList.remove('hidden');
                if (id === 'game') GameApp.ninja.resize();
            },
            startGame: () => { 
                AppState.currentScore = 0; 
                AppState.totalPoints = 0;
                AppState.totalMistakes = 0;
                AppState.startTime = Date.now();
                if (AppState.timerInterval) clearInterval(AppState.timerInterval);
                AppState.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - AppState.startTime;
                    document.getElementById('timer-display').innerText = Utils.formatTime(elapsed);
                }, 1000);
                GameApp.showScreen('game'); 
                GameApp.ninja.init(); 
            },
            showResult: () => {
                AppState.endTime = Date.now();
                if (AppState.timerInterval) clearInterval(AppState.timerInterval);
                const elapsedTime = AppState.endTime - AppState.startTime;
                const finalGrade = (AppState.totalPoints / 15) * 5;
                document.getElementById('final-score-val').innerText = Utils.toArabicNum(finalGrade.toFixed(1)); 
                document.getElementById('final-time-val').innerText = Utils.formatTime(elapsedTime);
                setTimeout(() => { const offset = 283 - (finalGrade / 5) * 283; document.getElementById('score-circle').style.strokeDashoffset = offset; }, 100);
                GameApp.showScreen('result'); 
                document.querySelector('#screen-result button:first-child').style.display = 'block';
                GameApp.saveDataV19(finalGrade.toFixed(1), elapsedTime);
            },
            finishGame: () => window.parent.postMessage({ event: 'gameFinished', gameId: AppConfig.gameId }, '*')
        };
        window.onload = GameApp.init;
    </script>
</body>
</html>

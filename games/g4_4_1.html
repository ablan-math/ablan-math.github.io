<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة المتباينات المركبة</title>
    <!-- تحميل Tailwind CSS للتصميم السريع -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل خط 'Tajawal' من Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* تطبيق الخط العربي 'Tajawal' على كامل الصفحة */
        body {
            font-family: 'Tajawal', sans-serif;
            font-size: 15px; /* تصغير الخط الأساسي قليلاً */
        }

        /* تنسيق الأرقام داخل الأسئلة */
        .math-content {
            unicode-bidi: embed; 
            font-size: 1.2em; /* تصغير الخط الرياضي قليلاً */
            font-weight: 700;
            color: #1E3A8A; 
        }

        /* --- تنسيق الكسور --- */
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 0.9em; 
            margin: 0 0.2em;
            line-height: 1.2;
        }
        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #1E3A8A; 
            padding: 0 0.2em;
        }
        .fraction .denominator {
            display: block;
            padding: 0 0.2em;
        }
        /* -------------------------- */

        /* كلاس لتلوين الروابط */
        .connector-red {
            color: #DC2626; /* لون أحمر */
            font-weight: 700;
            margin: 0 0.15em;
        }

        /* --- تنسيقات خط الأعداد (الإصلاح النهائي للأسهم) --- */
        .number-line-container {
            width: 100%;
            padding: 20px 0;
            margin-top: 10px;
            direction: ltr; /* نجبر الاتجاه من اليسار لليمين للرسم */
        }
        .number-line {
            position: relative;
            width: 80%; 
            margin: 0 auto;
            height: 4px;
            background-color: #9CA3AF; /* gray-400 */
            display: flex;
            align-items: center;
        }
        .number-line::before, .number-line::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            transform: translateY(-50%);
        }
        .number-line::before {
            /* الإصلاح: السهم الأيسر خارج الخط */
            left: -12px;
            border-right: 12px solid #9CA3AF;
        }
        .number-line::after {
            /* الإصلاح: السهم الأيمن خارج الخط */
            right: -12px;
            border-left: 12px solid #9CA3AF;
        }
        /* --------------------------------------------------- */

        .line-segment {
            position: absolute;
            height: 6px;
            background-color: #3B82F6; /* blue-500 */
            top: 50%;
            /* الإصلاح: إزالة translateX(-50%) لضمان بدء الشعاع من النقطة الصحيحة */
            transform: translateY(-50%); 
            z-index: 5; /* خلف الدوائر */
        }

        .tick {
            position: absolute;
            width: 3px;
            height: 16px;
            background-color: #6B7280; /* gray-500 */
            top: 50%;
            transform: translateY(-50%) translateX(-50%); 
            z-index: 10;
        }

        .tick-label {
            position: absolute;
            top: 25px;
            transform: translateX(-50%);
            color: #1F2937; /* gray-800 */
            font-weight: 700;
            font-size: 1.1em;
            /* إصلاح السالب */
            unicode-bidi: bidi-override;
            direction: ltr;
        }

        .circle {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #3B82F6; /* blue-500 */
            top: 50%;
            transform: translateY(-50%) translateX(-50%); 
            z-index: 10;
        }
        .circle.closed {
            background-color: #3B82F6; /* blue-500 */
        }
        /* -------------------------- */


        /* كلاسات للرسوم المتحركة لظهور الأسئلة */
        .question-card.entering {
            animation: fadeInScaleUp 0.5s ease-out forwards;
        }

        .question-card.exiting {
            animation: fadeOutScaleDown 0.3s ease-in forwards;
        }

        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOutScaleDown {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        /* أنيميشن لزر "اعرف لماذا؟" - تم تعديل المدة إلى 5 ثوان */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.9); }
            15% { opacity: 1; transform: scale(1); }
            90% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.9); }
        }

        /* كلاسات لتمييز الإجابات */
        .option-btn.correct {
            background-color: #10B981;
            color: white;
            transform: scale(1.05);
            border-color: #059669;
        }
        .option-btn.incorrect {
            background-color: #EF4444;
            color: white;
            border-color: #DC2626;
        }
        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- شاشة البداية -->
        <div id="start-screen" class="p-6 sm:p-8 text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-800 mb-3">لعبة المتباينات المركبة</h1>
            <p id="welcomeMessage" class="text-base sm:text-lg text-gray-700 mb-4">هل أنت مستعد لاختبار مهاراتك في حل المتباينات المركبة؟</p>
            
            <!-- القاعدة التعريفية -->
            <div class="bg-yellow-100 border-r-4 border-yellow-500 text-yellow-800 p-3 mb-4 rounded-lg text-right text-sm" role="alert">
                <p class="font-bold">تذكير هام:</p>
                <p>تذكر أن <span class="connector-red">"و"</span> تعني التقاطع، و <span class="connector-red">"أو"</span> تعني الاتحاد. وانتبه عند القسمة على عدد <span class="font-bold text-red-600">سالب</span>!</p>
            </div>
            
            <button id="start-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform duration-200 transform hover:scale-105 mb-3">
                ابدأ اللعبة!
            </button>
            
            <!-- فكرة وإعداد -->
            <p class="text-xs text-gray-500 mt-4">فكرة وإعداد: الأستاذ عبد العزيز خالد العبلان</p>
        </div>

        <!-- شاشة اللعبة (مخفية في البداية) -->
        <div id="game-screen" class="hidden p-4 sm:p-6">
            <!-- الشريط العلوي (النتيجة والسؤال الحالي) -->
            <div class="flex justify-between items-center mb-4 flex-wrap">
                <div class="text-base sm:text-lg font-medium text-gray-600">النتيجة: <span id="score" class="font-bold text-green-600">٠</span></div>
                <div id="timer-display" class="text-base sm:text-lg font-medium text-gray-800">الوقت: ٠ ثانية</div>
                <div class="text-base sm:text-lg font-medium text-gray-600">السؤال <span id="question-number">١</span> / <span id="total-questions">10</span></div>
            </div>

            <!-- بطاقة السؤال -->
            <div id="question-card" class="bg-blue-100 p-4 sm:p-6 rounded-lg mb-4 shadow-md min-h-[140px] flex items-center justify-center">
                <h2 id="question-text" class="text-xl sm:text-2xl font-bold text-blue-900 text-center math-content"></h2>
            </div>

            <!-- حاوية الاختيارات -->
            <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <!-- الأزرار ستتم إضافتها هنا بواسطة JavaScript -->
            </div>

            <!-- حاوية لزر "اعرف لماذا؟" -->
            <div id="feedback-container" class="mt-4 h-14 flex items-center justify-center">
                <!-- زر "اعرف لماذا؟" سيظهر هنا -->
            </div>
        </div>

        <!-- شاشة النهاية (مخفية في البداية) -->
        <div id="end-screen" class="hidden p-6 sm:p-8 text-center">
            <h2 class="text-2xl sm:text-3xl font-bold text-blue-800 mb-4">انتهت اللعبة!</h2>
            
            <div id="final-result-display" class="my-4 text-center"></div>

            <p class="text-lg sm:text-xl text-gray-700 mb-6">
                الوقت المستغرق:
                <span id="final-time" class="font-bold text-gray-800 text-xl sm:text-2xl block my-2"></span>
            </p>

            <div id="leaderboard-loader" style="display: none;" class="flex justify-center items-center my-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mr-2 text-gray-600">جاري تحميل سجل الأبطال...</p>
            </div>
            <div id="leaderboard-container"></div>
            
            <div id="finish-game-wrapper" style="display: none;" class="mt-6 mb-4">
                <button id="finish-game-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">
                    الخروج والعودة للمنصة
                </button>
            </div>

            <button id="restart-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform duration-200 transform hover:scale-105">
                أعد اللعب
            </button>
        </div>
    </div>

    <!-- نافذة "اعرف لماذا؟" (Modal) -->
    <div id="solution-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" dir="rtl">
        <div class="bg-white rounded-lg shadow-xl p-5 sm:p-6 w-full max-w-sm text-right">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4">طريقة الحل:</h3>
            <div id="solution-text" class="text-base sm:text-lg text-gray-700 mb-6 space-y-2 math-content" style="font-size: 1em;">
                <!-- سيتم ملء هذا المحتوى بالـ JavaScript -->
            </div>
            <button id="close-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-base sm:text-lg">
                أغلق
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            
            // --- 1. تعريف عناصر الواجهة ---
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const endScreen = document.getElementById('end-screen');
            
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            
            const scoreElement = document.getElementById('score');
            const questionNumberElement = document.getElementById('question-number');
            const totalQuestionsElement = document.getElementById('total-questions'); // إجمالي الأسئلة
            const timerDisplayElement = document.getElementById('timer-display'); 
            const questionCard = document.getElementById('question-card');
            const questionTextElement = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const feedbackContainer = document.getElementById('feedback-container'); 
            
            const finalTimeElement = document.getElementById('final-time'); 

            // عناصر نافذة الحل
            const solutionModal = document.getElementById('solution-modal');
            const solutionTextElement = document.getElementById('solution-text');
            const closeModalButton = document.getElementById('close-modal-button');

            // --- 2. بنك الأسئلة (20 سؤالاً) ---
            const questionBank = [
                {
                    // 1. سؤال رسم "اتحاد" (تم إصلاح CSS)
                    question: `أي متباينة تمثل خط الأعداد التالي؟
                        <div class="number-line-container">
                            <div class="number-line">
                                <!-- Line segments (تمتد لتغطي الأسهم) -->
                                <div class="line-segment" style="left: 0%; width: 25%;"></div>
                                <div class="line-segment" style="left: 75%; width: 25%;"></div>
                                <!-- Ticks and Labels -->
                                <div style="position: absolute; left: 0%;"><div class="tick"></div></div><span class="tick-label" style="left: 0%;">-٤</span>
                                <div style="position: absolute; left: 25%;"><div class="tick"></div></div><span class="tick-label" style="left: 25%;">-٢</span>
                                <div style="position: absolute; left: 50%;"><div class="tick"></div></div><span class="tick-label" style="left: 50%;">٠</span>
                                <div style="position: absolute; left: 75%;"><div class="tick"></div></div><span class="tick-label" style="left: 75%;">٢</span>
                                <div style="position: absolute; left: 100%;"><div class="tick"></div></div><span class="tick-label" style="left: 100%;">٤</span>
                                <!-- Circles -->
                                <div class="circle" style="left: 25%;"></div>
                                <div class="circle" style="left: 75%;"></div>
                            </div>
                        </div>`,
                    options: [
                        "س < -٢ <span class='connector-red'>أو</span> س > ٢", // صحيح
                        "س < -٢ <span class='connector-red'>أو</span> س < ٢", // خطأ
                        "-٢ < س < ٢", // خطأ (تقاطع)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س < -٢ <span class='connector-red'>أو</span> س > ٢",
                    solution: "الرسم يوضح شعاعين. الأول يبدأ بدائرة مفتوحة عند -٢ ويتجه يساراً (س < -٢). الثاني يبدأ بدائرة مفتوحة عند ٢ ويتجه يميناً (س > ٢). الرابط هو اتحاد <span class='connector-red'>'أو'</span>."
                },
                {
                    // 2. سؤال رسم "تقاطع" (تم إصلاح CSS)
                    question: `أي متباينة تمثل خط الأعداد التالي؟
                        <div class="number-line-container">
                            <div class="number-line">
                                <!-- Line segment -->
                                <div class="line-segment" style="left: 25%; width: 50%;"></div>
                                <!-- Ticks and Labels -->
                                <div style="position: absolute; left: 0%;"><div class="tick"></div></div><span class="tick-label" style="left: 0%;">-٥</span>
                                <div style="position: absolute; left: 25%;"><div class="tick"></div></div><span class="tick-label" style="left: 25%;">٠</span>
                                <div style="position: absolute; left: 50%;"><div class="tick"></div></div><span class="tick-label" style="left: 50%;">٥</span>
                                <div style="position: absolute; left: 75%;"><div class="tick"></div></div><span class="tick-label" style="left: 75%;">١٠</span>
                                <div style="position: absolute; left: 100%;"><div class="tick"></div></div><span class="tick-label" style="left: 100%;">١٥</span>
                                <!-- Circles -->
                                <div class="circle closed" style="left: 25%;"></div>
                                <div class="circle" style="left: 75%;"></div>
                            </div>
                        </div>`,
                    options: [
                        "٠ ≤ س < ١٠", // صحيح
                        "٠ < س ≤ ١٠", // خطأ (الدوائر)
                        "∅", // خطأ
                        "س ≤ ٠ <span class='connector-red'>أو</span> س > ١٠" // خطأ (اتحاد)
                    ],
                    answer: "٠ ≤ س < ١٠",
                    solution: "الرسم يوضح قطعة مستقيمة. تبدأ بدائرة مغلقة عند ٠ (≤ ٠) وتنتهي بدائرة مفتوحة عند ١٠ (< ١٠). هذا تقاطع. <br> إذن، الحل هو: ٠ ≤ س < ١٠."
                },
                {
                    // 3. سؤال "أو" (كسور وتوزيع)
                    question: "<span class='fraction'><span class='numerator'>س + ٥</span><span class='denominator'>٣</span></span> ≥ ٣ <span class='connector-red'>أو</span> ٢(س - ١) < ٨", 
                    options: [
                        "س ≥ ٤ <span class='connector-red'>أو</span> س < ٥", // صحيح
                        "س ≤ ٤ <span class='connector-red'>أو</span> س < ٥", // خطأ (عكس إشارة)
                        "٤ ≤ س < ٥", // خطأ (تقاطع)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س ≥ ٤ <span class='connector-red'>أو</span> س < ٥",
                    solution: "الأولى: س + ٥ ≥ ٩ &lArr; س ≥ ٤. <br> الثانية: ٢س - ٢ < ٨ &lArr; ٢س < ١٠ &lArr; س < ٥. <br> الرابط <span class='connector-red'>'أو'</span>. <br> إذن، الحل هو: س ≥ ٤ <span class='connector-red'>أو</span> س < ٥"
                },
                {
                    // 4. سؤال "و" (توزيع وقسمة سالب)
                    question: "-٢(س + ١) > ٦ <span class='connector-red'>و</span> ٣س - ١ > ٢",
                    options: [
                        "∅", // صحيح
                        "س < -٤ <span class='connector-red'>و</span> س > ١", // خطأ (نسي عكس الإشارة)
                        "س > -٤ <span class='connector-red'>و</span> س > ١", // خطأ (عكس الإشارة خطأ)
                        "-٤ < س < ١" // خطأ (تقاطع خاطئ)
                    ],
                    answer: "∅",
                    solution: "الأولى: -٢س - ٢ > ٦ &lArr; -٢س > ٨ &lArr; س < -٤ (نعكس الإشارة). <br> الثانية: ٣س > ٣ &lArr; س > ١. <br> الرابط <span class='connector-red'>'و'</span>. لا يوجد عدد أصغر من -٤ وأكبر من ١. <br> إذن، الحل هو ∅."
                },
                {
                    // 5. سؤال "أو" (يؤدي إلى R)
                    question: "٢س - ٤ ≥ -٤ <span class='connector-red'>أو</span> س + ١ < ٣",
                    options: [
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>", // صحيح
                        "٠ ≤ س < ٢", // خطأ (تقاطع)
                        "س ≥ ٠ <span class='connector-red'>أو</span> س > ٢", // خطأ (حسابي)
                        "س ≤ ٠ <span class='connector-red'>أو</span> س < ٢" // خطأ (حسابي)
                    ],
                    answer: "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>",
                    solution: "الأولى: ٢س ≥ ٠ &lArr; س ≥ ٠. <br> الثانية: س < ٢. <br> الرابط <span class='connector-red'>'أو'</span>. اتحاد [٠, ∞) و (-∞, ٢) يغطي كل الأعداد. <br> إذن، الحل هو جميع الأعداد الحقيقية."
                },
                {
                    // 6. سؤال "و" (مزدوج)
                    question: "٤ ≤ -٢س + ٦ < ١٠",
                    options: [
                        "-٢ < س ≤ ١", // صحيح
                        "∅", // خطأ
                        "-٨ < س ≤ -٥", // خطأ (جمع ٦ بدلاً من الطرح)
                        "٥ > س ≥ -٢" // خطأ (حسابي)
                    ],
                    answer: "-٢ < س ≤ ١",
                    solution: "نطرح ٦ من الأطراف: ٤ - ٦ ≤ -٢س < ١٠ - ٦ <br> &lArr; -٢ ≤ -٢س < ٤ <br> نقسم على -٢ (ونعكس الإشارات): <br> &lArr; ١ ≥ س > -٢ <br> إذن، الحل هو: -٢ < س ≤ ١"
                },
                {
                    // 7. سؤال "و" (أخطاء حسابية)
                    question: "س + ١ > ٣ <span class='connector-red'>و</span> ٢س ≤ ١٢",
                    options: [
                        "٢ < س ≤ ٦", // صحيح
                        "س > ٤ <span class='connector-red'>و</span> س ≤ ٦", // خطأ (جمع ١ بدلاً من الطرح)
                        "س > ٢ <span class='connector-red'>و</span> س ≤ ١٠", // خطأ (طرح ٢ بدلاً من القسمة)
                        "∅" // خطأ
                    ],
                    answer: "٢ < س ≤ ٦",
                    solution: "الأولى: س > ٣ - ١ &lArr; س > ٢. <br> الثانية: س ≤ ١٢ / ٢ &lArr; س ≤ ٦. <br> الرابط <span class='connector-red'>'و'</span>. <br> إذن، الحل هو: ٢ < س ≤ ٦"
                },
                {
                    // 8. سؤال "أو" (أخطاء حسابية)
                    question: "٣س ≤ -٦ <span class='connector-red'>أو</span> س - ٢ > ١",
                    options: [
                        "س ≤ -٢ <span class='connector-red'>أو</span> س > ٣", // صحيح
                        "س ≥ -٢ <span class='connector-red'>أو</span> س > ٣", // خطأ (عكس إشارة القسمة على موجب)
                        "س ≤ -٣ <span class='connector-red'>أو</span> س > -١", // خطأ (أخطاء حسابية)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س ≤ -٢ <span class='connector-red'>أو</span> س > ٣",
                    solution: "الأولى: س ≤ -٦ / ٣ &lArr; س ≤ -٢. <br> الثانية: س > ١ + ٢ &lArr; س > ٣. <br> الرابط <span class='connector-red'>'أو'</span>. <br> إذن، الحل هو: س ≤ -٢ <span class='connector-red'>أو</span> س > ٣"
                },
                {
                    // 9. سؤال "و" (مزدوج وكسور)
                    question: "٠ ≤ <span class='fraction'><span class='numerator'>٤س - ٨</span><span class='denominator'>٢</span></span> < ٦",
                    options: [
                        "٢ ≤ س < ٥", // صحيح
                        "٤ ≤ س < ١٠", // خطأ (نسي القسمة على ٢)
                        "∅", // خطأ
                        "-٢ ≤ س < ١" // خطأ (حسابي)
                    ],
                    answer: "٢ ≤ س < ٥",
                    solution: "نبسط الكسر: ٠ ≤ ٢س - ٤ < ٦ <br> نجمع ٤: ٤ ≤ ٢س < ١٠ <br> نقسم على ٢: <br> ٢ ≤ س < ٥"
                },
                {
                    // 10. سؤال "أو" (يؤدي إلى R)
                    question: "<span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س > -١ <span class='connector-red'>أو</span> -س > -٤",
                    options: [
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>", // صحيح
                        "س > -٢ <span class='connector-red'>أو</span> س > ٤", // خطأ (نسي عكس الإشارة)
                        "س > -٢ <span class='connector-red'>أو</span> س < ٤", // هذا صحيح أيضاً، لكن R أشمل
                        "-٢ < س < ٤" // خطأ (تقاطع)
                    ],
                    answer: "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>",
                    solution: "الأولى: س > -٢. <br> الثانية: س < ٤ (نعكس الإشارة). <br> الرابط <span class='connector-red'>'أو'</span>. (س > -٢) اتحاد (س < ٤) يغطي كل الأعداد. <br> إذن، الحل هو جميع الأعداد الحقيقية."
                },
                // --- الأسئلة الإضافية (11-20) ---
                {
                    // 11. سؤال رسم "تقاطع" (مثل صورة 14)
                    question: `أي متباينة تمثل خط الأعداد التالي؟
                        <div class="number-line-container">
                            <div class="number-line">
                                <!-- Line segment -->
                                <div class="line-segment" style="left: 20%; width: 40%;"></div>
                                <!-- Ticks and Labels -->
                                <div style="position: absolute; left: 0%;"><div class="tick"></div></div><span class="tick-label" style="left: 0%;">١</span>
                                <div style="position: absolute; left: 20%;"><div class="tick"></div></div><span class="tick-label" style="left: 20%;">٣</span>
                                <div style="position: absolute; left: 40%;"><div class="tick"></div></div><span class="tick-label" style="left: 40%;">٥</span>
                                <div style="position: absolute; left: 60%;"><div class="tick"></div></div><span class="tick-label" style="left: 60%;">٧</span>
                                <div style="position: absolute; left: 80%;"><div class="tick"></div></div><span class="tick-label" style="left: 80%;">٩</span>
                                <div style="position: absolute; left: 100%;"><div class="tick"></div></div><span class="tick-label" style="left: 100%;">١١</span>
                                <!-- Circles -->
                                <div class="circle closed" style="left: 20%;"></div>
                                <div class="circle closed" style="left: 60%;"></div>
                            </div>
                        </div>`,
                    options: [
                        "٣ ≤ س ≤ ٧", // صحيح
                        "٣ < س < ٧", // خطأ (مفتوح)
                        "∅", // خطأ
                        "س ≤ ٣ <span class='connector-red'>أو</span> س ≥ ٧" // خطأ (اتحاد)
                    ],
                    answer: "٣ ≤ س ≤ ٧",
                    solution: "الرسم يوضح قطعة مستقيمة. تبدأ بدائرة مغلقة عند ٣ (≥ ٣) وتنتهي بدائرة مغلقة عند ٧ (≤ ٧). <br> إذن، الحل هو: ٣ ≤ س ≤ ٧."
                },
                {
                    // 12. سؤال رسم "اتحاد" (مثل صورة 13)
                    question: `أي متباينة تمثل خط الأعداد التالي؟
                        <div class="number-line-container">
                            <div class="number-line">
                                <!-- Line segments (تمتد لتغطي الأسهم) -->
                                <div class="line-segment" style="left: 0%; width: 25%;"></div>
                                <div class="line-segment" style="left: 50%; width: 50%;"></div>
                                <!-- Ticks and Labels -->
                                <div style="position: absolute; left: 0%;"><div class="tick"></div></div><span class="tick-label" style="left: 0%;">-٦</span>
                                <div style="position: absolute; left: 25%;"><div class="tick"></div></div><span class="tick-label" style="left: 25%;">-٤</span>
                                <div style="position: absolute; left: 50%;"><div class="tick"></div></div><span class="tick-label" style="left: 50%;">-٢</span>
                                <div style="position: absolute; left: 75%;"><div class="tick"></div></div><span class="tick-label" style="left: 75%;">٠</span>
                                <div style="position: absolute; left: 100%;"><div class="tick"></div></div><span class="tick-label" style="left: 100%;">٢</span>
                                <!-- Circles -->
                                <div class="circle" style="left: 25%;"></div>
                                <div class="circle" style="left: 50%;"></div>
                            </div>
                        </div>`,
                    options: [
                        "س < -٤ <span class='connector-red'>أو</span> س > -٢", // صحيح
                        "س < -٤ <span class='connector-red'>أو</span> س < -٢", // خطأ
                        "-٤ < س < -٢", // خطأ (تقاطع)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س < -٤ <span class='connector-red'>أو</span> س > -٢",
                    solution: "الرسم يوضح شعاعين. الأول (يساراً) دائرة مفتوحة عند -٤ (س < -٤). الثاني (يميناً) دائرة مفتوحة عند -٢ (س > -٢). الرابط هو اتحاد <span class='connector-red'>'أو'</span>."
                },
                {
                    // 13. سؤال "و" (كسور وقسمة سالب)
                    question: "<span class='fraction'><span class='numerator'>س</span><span class='denominator'>-٢</span></span> < ٤ <span class='connector-red'>و</span> س + ٥ ≤ ١٠",
                    options: [
                        "-٨ < س ≤ ٥", // صحيح
                        "س > -٨ <span class='connector-red'>و</span> س ≤ ٥", // خطأ (نسي عكس الإشارة)
                        "س < -٨ <span class='connector-red'>و</span> س ≤ ٥", // خطأ
                        "∅" // خطأ
                    ],
                    answer: "-٨ < س ≤ ٥",
                    solution: "الأولى: نضرب في -٢ ونعكس الإشارة &lArr; س > -٨. <br> الثانية: نطرح ٥ &lArr; س ≤ ٥. <br> الرابط <span class='connector-red'>'و'</span>. <br> إذن، الحل هو: -٨ < س ≤ ٥"
                },
                {
                    // 14. سؤال "أو" (توزيع)
                    question: "٣(س + ١) < ٠ <span class='connector-red'>أو</span> ٢س - ٥ > ١",
                    options: [
                        "س < -١ <span class='connector-red'>أو</span> س > ٣", // صحيح
                        "س < -١ <span class='connector-red'>أو</span> س > -٢", // خطأ (حسابي)
                        "-١ < س < ٣", // خطأ (تقاطع)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س < -١ <span class='connector-red'>أو</span> س > ٣",
                    solution: "الأولى: ٣س + ٣ < ٠ &lArr; ٣س < -٣ &lArr; س < -١. <br> الثانية: ٢س > ٦ &lArr; س > ٣. <br> الرابط <span class='connector-red'>'أو'</span>. <br> إذن، الحل هو: س < -١ <span class='connector-red'>أو</span> س > ٣"
                },
                {
                    // 15. سؤال "و" (مزدوج وقسمة سالب)
                    question: "١٠ ≥ -٥س > -٥",
                    options: [
                        "١ > س ≥ -٢", // صحيح
                        "∅", // خطأ
                        "-٢ < س ≤ ١", // خطأ (عكس الإشارة > بدلاً من ≥)
                        "١ < س ≤ -٢" // خطأ (مستحيل)
                    ],
                    answer: "١ > س ≥ -٢",
                    solution: "نقسم الأطراف على -٥ (عدد سالب) ونعكس الإشارات: <br> ١٠/(-٥) ≤ س < -٥/(-٥) <br> &lArr; -٢ ≤ س < ١. <br> يمكن كتابتها أيضاً: ١ > س ≥ -٢."
                },
                {
                    // 16. سؤال "و" -> ∅ (بسيط)
                    question: "س + ٣ < ١ <span class='connector-red'>و</span> س - ١ > ٢",
                    options: [
                        "∅", // صحيح
                        "س < -٢ <span class='connector-red'>و</span> س > ٣", // خطأ (هذه هي الخطوات، ليست الحل)
                        "-٢ < س < ٣", // خطأ (تقاطع خاطئ)
                        "س > -٢ <span class='connector-red'>و</span> س < ٣" // خطأ (حسابي)
                    ],
                    answer: "∅",
                    solution: "الأولى: س < -٢. <br> الثانية: س > ٣. <br> الرابط <span class='connector-red'>'و'</span>. لا يوجد عدد أصغر من -٢ وأكبر من ٣. <br> إذن، الحل هو ∅."
                },
                {
                    // 17. سؤال "أو" -> R (بسيط)
                    question: "س - ٢ ≤ ٠ <span class='connector-red'>أو</span> س + ١ > ٠",
                    options: [
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>", // صحيح
                        "س ≤ ٢ <span class='connector-red'>أو</span> س > -١", // هذا صحيح، لكن R أشمل
                        "س ≤ ٢ <span class='connector-red'>أو</span> س < -١", // خطأ
                        "-١ < س ≤ ٢" // خطأ (تقاطع)
                    ],
                    answer: "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>",
                    solution: "الأولى: س ≤ ٢. <br> الثانية: س > -١. <br> الرابط <span class='connector-red'>'أو'</span>. اتحاد (-∞, ٢] و (-١, ∞) يغطي كل الأعداد. <br> إذن، الحل هو جميع الأعداد الحقيقية."
                },
                {
                    // 18. سؤال "و" (كسور)
                    question: "<span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س ≤ ٢ <span class='connector-red'>و</span> <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س > ٠",
                    options: [
                        "٠ < س ≤ ٤", // صحيح
                        "س ≤ ٤ <span class='connector-red'>و</span> س > ٠", // صحيح (نفس الإجابة)
                        "∅", // خطأ
                        "٠ < س ≤ ٢" // خطأ (حسابي)
                    ],
                    answer: "٠ < س ≤ ٤",
                    solution: "الأولى: نضرب في ٢ &lArr; س ≤ ٤. <br> الثانية: نضرب في ٣ &lArr; س > ٠. <br> الرابط <span class='connector-red'>'و'</span>. <br> إذن، الحل هو: ٠ < س ≤ ٤."
                },
                {
                    // 19. سؤال "أو" (قسمة سالب)
                    question: "-٢س < -٨ <span class='connector-red'>أو</span> -٣س ≥ ٦",
                    options: [
                        "س > ٤ <span class='connector-red'>أو</span> س ≤ -٢", // صحيح
                        "س < ٤ <span class='connector-red'>أو</span> س ≤ -٢", // خطأ (نسي عكس الإشارة الأولى)
                        "س > ٤ <span class='connector-red'>أو</span> س ≥ -٢", // خطأ (نسي عكس الإشارة الثانية)
                        "<span style='font-size: 0.9em;'>جميع الأعداد الحقيقية</span>" // خطأ
                    ],
                    answer: "س > ٤ <span class='connector-red'>أو</span> س ≤ -٢",
                    solution: "الأولى: نقسم على -٢ ونعكس &lArr; س > ٤. <br> الثانية: نقسم على -٣ ونعكس &lArr; س ≤ -٢. <br> الرابط <span class='connector-red'>'أو'</span>. <br> إذن، الحل هو: س > ٤ <span class='connector-red'>أو</span> س ≤ -٢."
                },
                {
                    // 20. سؤال "و" (مزدوج وقسمة سالب)
                    question: "٠ ≥ ٣س - ٩ > -١٢",
                    options: [
                        "-١ < س ≤ ٣", // صحيح
                        "∅", // خطأ
                        "٣ ≤ س < -١", // خطأ (مستحيل)
                        "٣ > س ≥ -١" // خطأ (عكس الإشارة > بدلاً من ≥)
                    ],
                    answer: "-١ < س ≤ ٣",
                    solution: "نجمع ٩ للأطراف: ٩ ≥ ٣س > -٣ <br> نقسم على ٣: ٣ ≥ س > -١. <br> يمكن كتابتها أيضاً: -١ < س ≤ ٣."
                }
            ];


            // --- 3. متغيرات حالة اللعبة ---
            const GAME_MAX_QUESTIONS = 10; // عدد الأسئلة في كل جولة
            let currentQuestionIndex = 0;
            let score = 0;
            let shuffledQuestions = []; // الأسئلة الـ 10 المختارة عشوائياً
            let totalTime = 0; 
            let questionStartTime = 0; 
            let timerPaused = false; 
            let nextQuestionTimer = null; 
            let gameTimerInterval = null; 

            // --- 4. وظائف اللعبة ---

            // وظيفة خلط مصفوفة (Fisher-Yates shuffle)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function updateTimerDisplay() {
                if (!timerPaused) {
                    let currentQuestionTime = Date.now() - questionStartTime;
                    let displayTime = totalTime + currentQuestionTime;

                    const minutes = Math.floor(displayTime / 60000);
                    const seconds = ((displayTime % 60000) / 1000).toFixed(0);
                    
                    if (minutes > 0) {
                        timerDisplayElement.textContent = `الوقت: ${minutes}د و ${seconds}ث`;
                    } else {
                        timerDisplayElement.textContent = `الوقت: ${seconds} ثانية`;
                    }
                }
            }
            
            function formatDisplayTime(timeInMs) {
                const minutes = Math.floor(timeInMs / 60000);
                const seconds = ((timeInMs % 60000) / 1000).toFixed(0);
                if (minutes > 0) {
                    return `الوقت: ${minutes}د و ${seconds}ث`;
                } else {
                    return `الوقت: ${seconds} ثانية`;
                }
            }

            function startGame() {
                score = 0;
                currentQuestionIndex = 0;
                totalTime = 0; 
                timerPaused = false;
                if (nextQuestionTimer) clearTimeout(nextQuestionTimer); 
                if (gameTimerInterval) clearInterval(gameTimerInterval); 

                // --- التعديل: اختيار 10 أسئلة عشوائية من البنك ---
                shuffledQuestions = shuffleArray([...questionBank]).slice(0, GAME_MAX_QUESTIONS);
                totalQuestionsElement.textContent = GAME_MAX_QUESTIONS; // تحديث إجمالي الأسئلة
                
                scoreElement.textContent = "٠";
                timerDisplayElement.textContent = "الوقت: ٠ ثانية"; 
                startScreen.classList.add('hidden');
                endScreen.classList.add('hidden');
                solutionModal.classList.add('hidden'); 
                gameScreen.classList.remove('hidden');
                
                gameTimerInterval = setInterval(updateTimerDisplay, 1000); 
                showQuestion();
            }

            function showQuestion() {
                optionsContainer.innerHTML = "";
                feedbackContainer.innerHTML = ""; 
                questionCard.classList.remove('entering', 'exiting');
                
                setTimeout(() => {
                    questionCard.classList.add('entering');
                }, 0);

                const question = shuffledQuestions[currentQuestionIndex];
                
                questionTextElement.innerHTML = question.question;
                questionNumberElement.textContent = currentQuestionIndex + 1;
                
                // --- التعديل: خلط الخيارات قبل عرضها ---
                const shuffledOptions = shuffleArray([...question.options]);

                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = option; 
                    button.dataset.option = option;
                    button.className = "option-btn w-full bg-white border-2 border-blue-300 text-blue-800 font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-blue-100 transition-all duration-200 text-base sm:text-lg math-content";
                    button.addEventListener('click', () => selectAnswer(button, option, question.answer));
                    optionsContainer.appendChild(button);
                });

                timerPaused = false; 
                questionStartTime = Date.now();
            }

            function selectAnswer(selectedButton, selectedOption, correctAnswer) {
                if (!timerPaused) {
                    totalTime += Date.now() - questionStartTime;
                    timerPaused = true; 
                }
                if (nextQuestionTimer) clearTimeout(nextQuestionTimer);

                timerDisplayElement.textContent = formatDisplayTime(totalTime);

                const allOptions = optionsContainer.querySelectorAll('.option-btn');
                allOptions.forEach(btn => btn.classList.add('disabled'));

                if (selectedOption === correctAnswer) {
                    score++;
                    scoreElement.textContent = score;
                    selectedButton.classList.add('correct');
                } else {
                    selectedButton.classList.add('incorrect');
                    allOptions.forEach(btn => {
                        if (btn.dataset.option === correctAnswer) {
                            btn.classList.add('correct');
                        }
                    });
                }

                const currentQuestion = shuffledQuestions[currentQuestionIndex];
                const whyButton = document.createElement('button');
                whyButton.id = "why-button";
                whyButton.innerHTML = "اعرف لماذا؟";
                whyButton.className = "bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-lg shadow-md";
                whyButton.style.animation = "fadeInOut 5s ease-in-out forwards"; 
                
                whyButton.onclick = () => {
                    showSolutionModal(currentQuestion.solution);
                };
                
                feedbackContainer.innerHTML = ""; 
                feedbackContainer.appendChild(whyButton);

                nextQuestionTimer = setTimeout(() => {
                    nextQuestion();
                }, 5000); 
            }

            function nextQuestion() {
                if (nextQuestionTimer) clearTimeout(nextQuestionTimer); 
                
                questionCard.classList.remove('entering');
                questionCard.classList.add('exiting');

                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < GAME_MAX_QUESTIONS) { // التأكد من استخدام GAME_MAX_QUESTIONS
                        showQuestion();
                    } else {
                        showEndScreen();
                    }
                }, 300); 
            }

            function showEndScreen() {
                if (gameTimerInterval) clearInterval(gameTimerInterval); 
                
                gameScreen.classList.add('hidden');
                solutionModal.classList.add('hidden'); 
                endScreen.classList.remove('hidden');
                
                finalTimeElement.textContent = formatDisplayTime(totalTime).replace("الوقت: ", "");

                const metricInSeconds = totalTime / 1000;
                if (window.saveAndFinishGame) {
                    saveAndFinishGame(score, metricInSeconds);
                } else {
                    console.error("محرك الاتصال بالمنصة غير موجود!");
                    const loader = document.getElementById('leaderboard-loader');
                    if (loader) loader.style.display = 'none';
                    const finishWrapper = document.getElementById('finish-game-wrapper');
                    if (finishWrapper) finishWrapper.style.display = 'block';

                    // عرض النتيجة كإجراء احتياطي
                    const resultDisplay = document.getElementById('final-result-display');
                    if (resultDisplay) {
                         resultDisplay.innerHTML = `
                             <p class="text-gray-700">النقاط: <span class="font-bold text-xl">${score} / ${GAME_MAX_QUESTIONS}</span></p>
                         `;
                    }
                }
            }

            function showSolutionModal(solution) {
                if (nextQuestionTimer) clearTimeout(nextQuestionTimer); 
                timerPaused = true; 
                
                solutionTextElement.innerHTML = solution;
                solutionModal.classList.remove('hidden');
            }

            function closeModal() {
                solutionModal.classList.add('hidden');
                nextQuestion(); 
            }

            // --- 5. ربط الأحداث ---
            if (startButton) {
                startButton.addEventListener('click', startGame);
            }
            if (restartButton) {
                restartButton.addEventListener('click', startGame);
            }
            if (closeModalButton) {
                closeModalButton.addEventListener('click', closeModal); 
            }

        }); // --- نهاية غلاف DOMContentLoaded ---
    </script>

    <!-- محرك الربط وسجل الأبطال -->
    <script>
    // --- START OF CONNECTION & LEADERBOARD ENGINE ---
    (function() {
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const GAME_ID = 'g4_4_1'; // تم التحديث
        const GAME_MAX_POINTS = 10; // عدد الأسئلة لكل جولة
        const PLATFORM_MAX_GRADE = 5; 
        const METRIC_TYPE = 'time'; 
        const METRIC_LABEL = 'الوقت (ثواني)'; 

        // --- Read URL Parameters ---
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const classId = urlParams.get('classId');
        const studentName = urlParams.get('studentName');

        let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

        // --- CORE FUNCTIONS ---
        window.saveAndFinishGame = function(points, metricValue) {
            const finalPoints = parseFloat(points) || 0;
            const finalMetric = parseFloat(metricValue) || 0;
            const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
            const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

            const resultDisplay = document.getElementById('final-result-display');
            if (resultDisplay) {
                resultDisplay.innerHTML = `
                    <p class="text-gray-700">النقاط: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                    <p class="text-blue-600">الدرجة في المنصة: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                `;
            }

            if (studentId && classId) {
                const params = new URLSearchParams({
                    action: 'saveGrade',
                    studentId: studentId,
                    classId: classId,
                    itemId: GAME_ID,
                    grade: finalGrade.toFixed(2),
                    metricValue: Math.round(finalMetric).toString()
                });
                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(result => console.log('Save result:', result.status))
                    .catch(err => console.error("Save Error:", err))
                    .finally(fetchAndShowLeaderboard);
            } else {
                console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                fetchAndShowLeaderboard();
            }
        }

        function fetchAndShowLeaderboard() {
            const loader = document.getElementById('leaderboard-loader');
            const container = document.getElementById('leaderboard-container');
            if (!loader || !container) return;
            
            if (!classId) {
                console.log("No classId found, skipping leaderboard for visitor.");
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">سجل الأبطال متاح للطلاب المسجلين فقط.</p>`;
                showFinishButton();
                return;
            }

            loader.style.display = 'block';
            container.innerHTML = '';

            const params = new URLSearchParams({
                action: 'getLeaderboard',
                gameId: GAME_ID,
                metricType: METRIC_TYPE,
                classId: classId
            });

            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        displayLeaderboard(response.data);
                    } else {
                        throw new Error(response.message || 'Failed to load leaderboard data.');
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    container.innerHTML = `<p class="text-center text-red-500">حدث خطأ في تحميل سجل الأبطال.</p>`;
                })
                .finally(() => {
                    loader.style.display = 'none';
                    showFinishButton();
                });
        }
        
        function displayLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">لا توجد نتائج بعد. كن أول الأبطال!</p>`;
                return;
            }

            let tableHTML = `
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">🏆 سجل الأبطال 🏆</h3>
                    <table class="min-w-full bg-white shadow-md rounded-lg">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="text-center py-2 px-3">الترتيب</th>
                                <th class="text-right py-2 px-3">اسم الطالب</th>
                                <th class="text-center py-2 px-3">الدرجة</th>
                                <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">`;

            data.forEach((player, index) => {
                const rank = index + 1;
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = '🥇';
                if (rank === 2) rankDisplay = '🥈';
                if (rank === 3) rankDisplay = '🥉';

                const isCurrentUser = (currentUser && player.name === currentUser.name);
                const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                        <td class="text-right py-2 px-3">${player.name}</td>
                        <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                        <td class="text-center py-2 px-3">${player.metricValue}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
        }

        function showFinishButton() {
            const finishWrapper = document.getElementById('finish-game-wrapper');
            if (finishWrapper) {
                finishWrapper.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (studentName && welcomeMessage) {
                welcomeMessage.innerHTML = `أهلاً بك يا <span class="font-bold text-blue-900">${studentName}</span>! ركز جيداً في حل المتباينات، وتذكر القاعدة الذهبية عند التعامل مع الأعداد السالبة!`;
            }

            const finishBtn = document.getElementById('finish-game-btn');
            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                });
            }
        });
    })();
    // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙƒØ±ÙŠØ³ØªØ§Ù„Ø§Øª V19.10 - g6_5_2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; background-color: #010204; }
        .compact-card {
            width: 100%; max-width: 450px; background: #05070a; border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9); border: 1px solid #1e293b;
            display: flex; flex-direction: column; max-height: 98vh; overflow: hidden; position: relative;
        }
        
        /* Cave Atmosphere */
        .cave-ambient {
            position: absolute; inset: 0; pointer-events: none; z-index: 1;
            background: 
                radial-gradient(circle at 15% 15%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 85% 85%, rgba(234, 179, 8, 0.1) 0%, transparent 50%);
        }
        .stars-container { position: absolute; inset: 0; pointer-events: none; z-index: 2; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: twinkle 4s infinite; }
        .star-yellow { background: #fbbf24; box-shadow: 0 0 4px #fbbf24; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.3); } }

        .top-info-bar {
            background: rgba(10, 15, 25, 0.95); border-bottom: 1px solid #1e293b; padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; font-weight: 800; color: #94a3b8; backdrop-filter: blur(10px); z-index: 50;
        }
        
        /* Crystal Graphics */
        .crystal-container { perspective: 1000px; height: 90px; display: flex; align-items: center; justify-content: center; position: relative; }
        .crystal-svg { width: 60px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .active-target { transform: scale(1.18); filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.7)); z-index: 30; }
        .success-glow { filter: drop-shadow(0 0 12px rgba(16, 185, 129, 0.6)); }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px) rotate(-1deg); } 75% { transform: translateX(4px) rotate(1deg); } }
        .broken-shake { animation: shake 0.2s ease-in-out; }
        
        @keyframes rise-left { 0% { transform: translateY(60px) scale(0.4); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
        .rising-crystal { animation: rise-left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* Dark Leaderboard */
        .leaderboard-modal { position: absolute; inset: 0; background: #05070a; z-index: 100; display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; color: #f1f5f9; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tab-btn { flex: 1; padding: 10px; font-size: 12px; font-weight: bold; border-radius: 12px; transition: 0.3s; border: 1px solid #1e293b; cursor: pointer; }
        .tab-active { background-color: #2563eb; color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); border-color: #3b82f6; }
        .tab-inactive { background-color: #0f172a; color: #64748b; }
        
        .rank-row-me { background: linear-gradient(to left, rgba(37, 99, 235, 0.25), transparent) !important; border-right: 4px solid #2563eb !important; }
        .sync-loader { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1.15rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.96); }
        
        sup { font-size: 0.65em; font-weight: 900; vertical-align: super; }

        /* Next Button Tiny Style */
        #next-btn {
            background: #2563eb; color: white; border-radius: 0.75rem; 
            padding: 4px 12px; font-size: 11px; font-weight: 900; 
            height: 32px; min-height: 32px; border: 1px solid #3b82f6;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }
    </style>
</head>
<body class="flex items-center justify-center p-3 text-right overflow-hidden">

    <div class="compact-card">
        <div class="cave-ambient"></div>
        <div id="stars" class="stars-container"></div>

        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…Ø·ÙˆØ± V19.10 -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-magic text-blue-400"></i>
                <span id="top-student-name" class="truncate font-black text-blue-50">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„..</span>
            </div>
            <div class="flex items-center gap-2">
                <span id="question-counter" class="hidden text-[10px] bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded-full border border-blue-800 font-bold">Ø§Ù„Ø³Ø¤Ø§Ù„ Ù¡</span>
                <div class="flex items-center gap-2 bg-slate-900/80 px-3 py-1 rounded-full border border-slate-700 shadow-sm font-bold">
                    <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                    <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                    <span id="top-prev-score" class="text-white text-[10px]">Ù  / Ù¥</span>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-6 h-full justify-center z-10">
            <div class="w-32 h-32 mx-auto relative animate-bounce" style="animation-duration: 4s;">
                <svg viewBox="0 0 100 140" class="w-full h-full drop-shadow-[0_0_30px_rgba(239,68,68,0.4)]">
                    <path d="M10 0 H90 L100 35 L50 140 L0 35 Z" fill="#ef4444" />
                    <path d="M10 0 L30 35 H0 Z" fill="white" fill-opacity="0.3" />
                </svg>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tight">Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙƒØ±ÙŠØ³ØªØ§Ù„Ø§Øª</h1>
            <div class="bg-blue-950/40 p-5 rounded-[2rem] border border-blue-500/20 text-[13px] font-bold text-blue-100 leading-relaxed shadow-inner">
                ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙŠ ÙƒÙ‡Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø±. Ø±ÙƒÙ‘Ø² ÙÙŠ Ù†Ø§ØªØ¬ Ø§Ù„Ø¶Ø±Ø¨ Ù„ÙØªØ­ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©!
            </div>
            
            <div class="flex flex-row gap-2 items-stretch mt-4">
                <button onclick="startGame()" class="btn-touch flex-[2.5] bg-blue-600 text-white shadow-2xl text-xl border-b-4 border-blue-800 active:border-b-0">
                    Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© <i class="fas fa-bolt-lightning mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-slate-900 text-slate-300 border border-slate-800 text-[11px] flex-col leading-tight py-2">
                    <i class="fas fa-trophy text-yellow-500 text-xl mb-1"></i>
                    <span>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
            <p class="text-[10px] text-slate-600 font-bold mt-4 tracking-[0.4em] uppercase text-center font-mono">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="game-screen" class="hidden h-full flex flex-col overflow-hidden relative z-10">
            <div class="bg-black/60 p-4 py-8 flex items-center justify-center gap-1 border-b border-white/5 shadow-2xl">
                <div id="monomial-crystal" class="crystal-container w-16"></div>
                <div class="text-blue-500 font-black text-2xl px-2 self-center animate-pulse">Ã—</div>
                <div id="poly-crystals" class="flex gap-1"></div>
            </div>

            <div class="flex-grow flex flex-col items-center justify-center p-2 relative bg-slate-950/30">
                <p class="text-[10px] font-black text-yellow-500/30 uppercase tracking-[0.5em] mb-4">ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬Ø©</p>
                <div id="result-row" class="flex flex-row items-center justify-center gap-2 h-32 w-full px-4 overflow-visible"></div>
            </div>

            <div class="p-6 bg-black/80 backdrop-blur-xl rounded-t-[3rem] border-t border-white/10">
                <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØµØºÙŠØ± Ù…Ø¹ Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ -->
                <div class="flex items-center justify-between gap-2 mb-6 px-2 min-h-[35px]">
                    <div class="flex items-center gap-2">
                        <div id="status-light" class="w-2.5 h-2.5 bg-emerald-400 rounded-full animate-ping"></div>
                        <span id="instruction-text" class="text-emerald-400 text-xs font-black uppercase tracking-tight">Ø§Ø¶Ø±Ø¨ ÙÙŠ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙˆÙ„</span>
                    </div>
                    <!-- Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙˆØ¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
                    <button id="next-btn" onclick="goToNext()" class="hidden flex items-center justify-center gap-1 active:scale-95 transition-all">
                        <span>Ø§Ù„ØªØ§Ù„ÙŠ</span> <i class="fas fa-arrow-left text-[9px]"></i>
                    </button>
                </div>
                
                <div id="options-row" class="flex justify-center gap-3"></div>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ V19.10 -->
        <div id="result-screen" class="hidden p-6 flex flex-col h-full overflow-hidden text-center justify-center animate-in zoom-in duration-500 z-10">
            <div class="w-24 h-24 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl border-4 border-white/10 relative">
                <i class="fas fa-trophy text-4xl"></i>
            </div>
            <h2 class="text-3xl font-black text-white mb-8 tracking-tighter">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„!</h2>
            
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-8 px-2"></div>
            
            <div class="bg-emerald-950/20 p-4 rounded-3xl border border-emerald-500/10 mb-8">
                <i class="fas fa-shield-check text-emerald-400 text-xl mb-1"></i>
                <p id="save-msg" class="font-bold text-emerald-200 text-[10px]">ØªÙ… Ø­ÙØ¸ Ø¥Ù†Ø¬Ø§Ø²Ùƒ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white shadow-xl border-b-4 border-blue-800">
                    <i class="fas fa-crown ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
                </button>
                <div class="flex gap-2">
                    <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-900 text-white text-sm font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
                    <button id="finish-btn" class="btn-touch flex-[2] bg-blue-900 text-white text-sm font-bold">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ø«ÙŠÙ… Ø§Ù„ÙƒÙ‡Ù) -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                <h3 class="font-black text-yellow-500 text-xl"><i class="fas fa-gem ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
                <button onclick="closeLeaderboardModal()" class="w-10 h-10 rounded-full bg-slate-900 text-slate-400 flex items-center justify-center border border-slate-800"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-6">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-950/80 rounded-[2rem] border border-slate-800 p-1 relative shadow-inner">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-black/60 z-10 rounded-[2rem]"><div class="sync-loader text-blue-500 text-4xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = "g6_5_2";
        const studentId = urlParams.get('studentId') || urlParams.get('userId') || 'guest';
        const classId = urlParams.get('classId');
        
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        let currentLeaderboardMode = classId ? 'class' : 'global';
        let startTime, duration, score = 0;
        let currentQuestionIndex = 0, currentStep = 0;
        let problem = null;
        let polyStates = ['idle', 'idle', 'idle'];

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

        // Cave Sparkles
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 40; i++) {
            const star = document.createElement('div');
            star.className = `star ${Math.random() > 0.7 ? 'star-yellow' : ''}`;
            star.style.width = Math.random() * 3 + 'px'; star.style.height = star.style.width;
            star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 4 + 's';
            starsContainer.appendChild(star);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (studentId === 'guest' && !urlParams.get('name')) studentName = "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±";
            document.getElementById('top-student-name').textContent = studentName;
            if (!classId) document.getElementById('tab-class').style.display = 'none';
            if (studentId !== 'guest') fetchInitialCloudData();
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        async function fetchInitialCloudData() {
            try {
                document.getElementById('sync-icon').classList.remove('hidden');
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId || 'all')}&itemId=${GAME_ID}&t=${Date.now()}`;
                const res = await (await fetch(url)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) { studentName = res.data.name; document.getElementById('top-student-name').textContent = studentName; }
                    if (res.data.games && res.data.games[GAME_ID]) document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                }
            } catch (e) {} finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        window.startGame = () => {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('question-counter').classList.remove('hidden');
            startTime = Date.now(); score = 0; currentQuestionIndex = 0;
            initLevel();
        };

        function initLevel() {
            let mono;
            if (currentQuestionIndex === 0) mono = { coef: Math.floor(Math.random() * 5) + 2, exp: 0 };
            else if (currentQuestionIndex === 1) mono = { coef: Math.floor(Math.random() * 4) + 2, exp: 1 };
            else mono = { coef: Math.floor(Math.random() * 3) + 2, exp: 2 };

            problem = {
                mono: mono,
                poly: [
                    { coef: Math.floor(Math.random() * 5) + 2, exp: 2 },
                    { coef: (Math.floor(Math.random() * 5) + 1) * (Math.random() > 0.5 ? 1 : -1), exp: 1 },
                    { coef: (Math.floor(Math.random() * 8) + 1) * (Math.random() > 0.5 ? 1 : -1), exp: 0 }
                ]
            };
            currentStep = 0; polyStates = ['active', 'idle', 'idle'];
            document.getElementById('result-row').innerHTML = '';
            document.getElementById('question-counter').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${toAr(currentQuestionIndex + 1)}`;
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('instruction-text').classList.remove('hidden');
            document.getElementById('status-light').classList.remove('hidden');
            renderMatrix();
            setupOptions();
        }

        function createCrystalHTML(coef, exp, color, state = 'idle', showPlus = false) {
            const absCoef = Math.abs(coef);
            const sign = coef < 0 ? ' - ' : (showPlus ? ' + ' : '');
            const displayCoef = (absCoef === 1 && exp !== 0) ? '' : toAr(absCoef);
            const displayVar = exp === 0 ? '' : 'Ø³';
            const displayExp = exp > 1 ? `<sup>${toAr(exp)}</sup>` : '';
            
            let fill;
            if (state === 'broken') fill = '#0a0a0c'; 
            else if (state === 'idle' && color === 'green') fill = '#1e293b'; 
            else if (color === 'red') fill = '#ef4444';
            else if (color === 'yellow') fill = '#d97706';
            else fill = '#059669';

            let cracks = state === 'broken' ? `<path d="M20 20 L45 55 M55 35 L30 80 M75 25 L55 60" stroke="white" stroke-width="2.5" stroke-opacity="0.9" fill="none" />` : '';

            return `
                <div class="crystal-container relative ${state === 'active' ? 'active-target' : ''} ${state === 'success' ? 'success-glow' : ''} ${state === 'broken' ? 'broken-shake' : ''}">
                    <svg viewBox="0 0 100 140" class="w-full h-full">
                        <path d="M10 0 H90 L100 35 L50 140 L0 35 Z" fill="${fill}" />
                        ${cracks}
                        <path d="M10 0 L30 35 H0 Z" fill="white" fill-opacity="0.15" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center pt-2 text-white font-black text-sm md:text-lg whitespace-nowrap" style="text-shadow: 0 2px 8px #000">
                        ${sign}${displayCoef}${displayVar}${displayExp}
                    </div>
                </div>`;
        }

        function renderMatrix() {
            document.getElementById('monomial-crystal').innerHTML = createCrystalHTML(problem.mono.coef, problem.mono.exp, 'red');
            document.getElementById('poly-crystals').innerHTML = problem.poly.map((p, i) => 
                createCrystalHTML(p.coef, p.exp, 'green', polyStates[i], i > 0)
            ).join('');
        }

        function setupOptions(disabled = false) {
            const target = problem.poly[currentStep];
            const correct = { coef: problem.mono.coef * target.coef, exp: problem.mono.exp + target.exp };
            let choices = [correct];
            const distRules = [
                () => ({ coef: problem.mono.coef + target.coef, exp: correct.exp }), 
                () => ({ coef: correct.coef, exp: Math.max(1, (problem.mono.exp || 1) * (target.exp || 1)) }), 
                () => ({ coef: correct.coef, exp: Math.abs(problem.mono.exp - target.exp) })
            ];
            let attempts = 0;
            while (choices.length < 3 && attempts < 30) {
                attempts++;
                let wrong = distRules[Math.floor(Math.random() * distRules.length)]();
                if (!choices.find(c => c.coef === wrong.coef && c.exp === wrong.exp)) choices.push(wrong);
            }
            if (choices.length < 3) choices.push({ coef: correct.coef + 2, exp: correct.exp + 1 });
            choices.sort(() => Math.random() - 0.5);

            document.getElementById('options-row').innerHTML = choices.map(c => `
                <button onclick='handleSelection(${JSON.stringify(c)})' ${disabled ? 'disabled' : ''} class="w-16 h-24 md:w-20 md:h-28 active:scale-90 transition-all ${disabled ? 'opacity-50 grayscale' : ''}">
                    ${createCrystalHTML(c.coef, c.exp, 'yellow')}
                </button>
            `).join('');
            
            const labels = ["Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„Ø£Ø®ÙŠØ±"];
            document.getElementById('instruction-text').textContent = `Ø§Ø¶Ø±Ø¨ ÙÙŠ Ø§Ù„Ø­Ø¯ ${labels[currentStep]}`;
        }

        window.handleSelection = (choice) => {
            const target = problem.poly[currentStep];
            const isCorrect = (choice.coef === (problem.mono.coef * target.coef)) && (choice.exp === (problem.mono.exp + target.exp));
            const resultRow = document.getElementById('result-row');
            
            const resItem = document.createElement('div');
            resItem.className = 'rising-crystal w-16 h-24 relative flex-shrink-0';
            
            if (isCorrect) {
                score += 10; polyStates[currentStep] = 'success';
                resItem.innerHTML = createCrystalHTML(choice.coef, choice.exp, 'yellow', 'success', currentStep > 0);
            } else {
                polyStates[currentStep] = 'broken';
                resItem.innerHTML = createCrystalHTML(choice.coef, choice.exp, 'yellow', 'broken', currentStep > 0);
            }
            
            resultRow.appendChild(resItem);
            renderMatrix();

            if (currentStep < 2) {
                currentStep++;
                polyStates[currentStep] = 'active';
                renderMatrix();
                setupOptions();
            } else {
                // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                setupOptions(true); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ¨Ù‚Ø§Ø¤Ù‡Ø§ Ø¸Ø§Ù‡Ø±Ø©
                document.getElementById('instruction-text').textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰";
                document.getElementById('status-light').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
                if (currentQuestionIndex === 2) {
                    document.getElementById('next-btn').innerHTML = `Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ <i class="fas fa-flag-checkered mr-2 text-[9px]"></i>`;
                }
            }
        };

        window.goToNext = () => {
            if (currentQuestionIndex < 2) {
                currentQuestionIndex++;
                initLevel();
            } else {
                processFinalResults();
            }
        };

        function processFinalResults() {
            duration = Math.floor((Date.now() - startTime) / 1000);
            const grade = ((score / 90) * 5).toFixed(1);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-slate-900/60 p-3 rounded-2xl border border-slate-800">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                    <p class="text-xs font-black text-white">${toAr(score)} / Ù©Ù </p>
                </div>
                <div class="bg-blue-600 p-3 rounded-2xl shadow-xl scale-110 ring-4 ring-blue-500/10">
                    <p class="text-[9px] font-black text-blue-100 uppercase">Ø§Ù„Ø¯Ø±Ø¬Ø©</p>
                    <p class="text-xl font-black text-white">${toAr(grade)}</p>
                </div>
                <div class="bg-slate-900/60 p-3 rounded-2xl border border-slate-800">
                    <p class="text-[9px] font-black text-slate-500 uppercase">Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</p>
                    <p class="text-xl font-black text-white">${toAr(duration)}</p>
                </div>
            `;
            if (studentId !== 'guest') saveScore(grade, duration);
        }

        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'time' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            fetch(url).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (data.length > 0) {
                    let h = `<table class="w-full text-right text-[11px] text-slate-200"><tbody class="divide-y divide-slate-900">`;
                    data.forEach((p, i) => {
                        const isMe = (studentId && String(p.name).trim() === String(studentName).trim());
                        h += `<tr class="${isMe ? 'rank-row-me' : ''}">
                            <td class="p-4 text-center font-black ${i<3 ? 'text-yellow-500 text-lg' : 'text-slate-500'}">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td>
                            <td class="p-4 font-black text-slate-200">${p.name} ${isMe ? '<span class="bg-blue-600 text-white text-[8px] px-2 rounded-full mx-1 font-black">Ø£Ù†Øª</span>' : ''}</td>
                            <td class="p-4 text-center font-black text-blue-400">${toAr(parseFloat(p.grade).toFixed(1))} <span class="text-[9px] text-slate-600 block font-normal">(${toAr(p.metricValue || 0)}Ø«)</span></td>
                        </tr>`;
                    });
                    document.getElementById('leaderboard-content').innerHTML = h + `</tbody></table>`;
                } else document.getElementById('leaderboard-content').innerHTML = `<div class="py-12 text-center text-slate-600 font-black italic">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (mode) => { currentLeaderboardMode = mode; document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; fetchAndShowLeaderboard(false); };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

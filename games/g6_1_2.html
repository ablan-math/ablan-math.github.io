<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ V19.5 - Ù…Ø¨Ø§Ø±Ø²Ø© Ø§Ù„ÙˆØ­ÙˆØ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Chakra+Petch:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 420px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; max-height: 96vh; height: 96vh; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 6px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b; flex-shrink: 0;
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ø·ÙˆØ± V19.5 */
        .leaderboard-modal { 
            position: absolute; inset: 0; background: #ffffff; z-index: 100; 
            display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; 
        }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        
        .rank-row-me { background-color: #eff6ff !important; border-right: 4px solid #2563eb !important; }
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .leaderboard-name { color: #1e293b; font-weight: 700; }
        .leaderboard-rank { font-weight: 900; }
        
        /* --- Monster Duel Animations & Styles --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }
        
        /* Charge Animations */
        @keyframes chargePlayer { 0% { transform: translate(0, 0); } 50% { transform: translate(-80px, -20px) scale(1.1); } 100% { transform: translate(0, 0); } }
        @keyframes chargeEnemy { 0% { transform: translate(0, 0); } 50% { transform: translate(80px, 20px) scale(1.1); } 100% { transform: translate(0, 0); } }

        @keyframes painEnemy {
            0% { transform: translate(0, 0); filter: brightness(1); }
            10% { transform: translate(-10px, -10px); filter: brightness(3) sepia(1) hue-rotate(-50deg) saturate(5); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); opacity: 0.8; }
            100% { transform: translate(0, 0); opacity: 1; filter: brightness(1); }
        }
        @keyframes painPlayer {
            0% { transform: translate(0, 0); filter: brightness(1); }
            10% { transform: translate(10px, 10px); filter: brightness(3) sepia(1) hue-rotate(-50deg) saturate(5); }
            20% { transform: translate(-10px, -10px); }
            30% { transform: translate(10px, -10px); }
            40% { transform: translate(-10px, 10px); opacity: 0.8; }
            100% { transform: translate(0, 0); opacity: 1; filter: brightness(1); }
        }

        @keyframes damageTextAnim {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            20% { opacity: 1; transform: translateY(-20px) scale(1.5); }
            80% { opacity: 1; transform: translateY(-30px) scale(1); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        .monster { animation: float 4s ease-in-out infinite; }
        .anim-charge-p { animation: chargePlayer 0.4s ease-in-out; }
        .anim-charge-e { animation: chargeEnemy 0.4s ease-in-out; }
        .anim-pain-p { animation: painPlayer 0.5s ease-out; }
        .anim-pain-e { animation: painEnemy 0.5s ease-out; }
        .anim-damage-text { animation: damageTextAnim 0.8s forwards; }

        .math-text { font-family: 'Cairo', sans-serif; direction: ltr; display: inline-block; }
        .math-arabic { direction: rtl; unicode-bidi: embed; }
        sup { font-size: 0.7em; vertical-align: super; margin-right: 2px; }
        .card-btn { transition: transform 0.1s, background-color 0.2s; }
        .card-btn: active { transform: scale(0.95); }
        .var-spacing { margin-left: 3px; display: inline-block; }
        
        /* Timer Style */
        .digital-clock {
            font-family: 'Chakra Petch', sans-serif; /* Tech font */
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Instruction Modal */
        #level-modal {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-3 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-blue-500"></i>
                <span id="top-student-name" class="truncate font-black">Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ</span>
                <script>
                    (function() {
                        const p = new URLSearchParams(window.location.search);
                        const n = p.get('name') || p.get('studentName') || p.get('username') || p.get('user');
                        if (n) document.getElementById('top-student-name').textContent = decodeURIComponent(n);
                    })();
                </script>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync sync-loader text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-4 h-full justify-center relative overflow-hidden">
            <div class="absolute top-10 left-10 opacity-10 text-6xl rotate-12">âœ–ï¸</div>
            <div class="absolute bottom-20 right-10 opacity-10 text-6xl -rotate-12">â•</div>

            <h1 class="text-2xl font-black text-slate-800 drop-shadow-sm">Ù…Ø¨Ø§Ø±Ø²Ø© Ø§Ù„ÙˆØ­ÙˆØ´</h1>
            <h2 class="text-sm font-bold text-blue-500 -mt-2">ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</h2>

            <div class="flex justify-center gap-4 my-4">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-3xl">ğŸ¤–</div>
                <div class="text-2xl font-black self-center">VS</div>
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-3xl">ğŸ‘¹</div>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-[11px] font-bold text-blue-700 leading-relaxed shadow-sm">
                Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ Ù„Ù‡Ø²ÙŠÙ…Ø© Ø§Ù„ÙˆØ­Ø´!
                <br>
                Ù¡. Ø¶Ø±Ø¨ Ø§Ù„Ù‚ÙˆÙ‰ (Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³)
                <br>
                Ù¢. Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© (Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³)
                <br>
                Ù£. Ù‚ÙˆØ© Ø­Ø§ØµÙ„ Ø§Ù„Ø¶Ø±Ø¨ (Ø§Ù„ØªÙˆØ²ÙŠØ¹)
            </div>
            <div class="flex gap-2 mt-auto">
                <button onclick="startGame()" class="btn-touch flex-[2] bg-gradient-to-l from-blue-600 to-indigo-600 text-white shadow-lg text-lg">
                    Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø±ÙƒØ© <i class="fas fa-swords mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-slate-600 border border-slate-200 text-xs font-bold px-1">
                    <i class="fas fa-trophy ml-1 text-yellow-500"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
                </button>
            </div>
            <p class="text-[10px] text-slate-400 font-bold mt-2 tracking-widest">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù…Ø³Ø±Ø­ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©) -->
        <div id="game-screen" class="hidden flex flex-col h-full bg-slate-900 relative overflow-hidden">
            
            <!-- Match Timer -->
            <div class="absolute top-4 left-0 right-0 z-0 flex justify-center items-center gap-3">
                 <div class="digital-clock text-white text-xl font-black px-4 py-1 rounded-lg shadow-lg border-2 border-slate-700">
                    <span id="timer-display">00:00</span>
                </div>
            </div>

            <!-- Battle Arena -->
            <div class="flex-1 relative flex flex-col justify-between p-4 pt-16">
                <!-- Enemy Area (Top Left in RTL) -->
                <div class="flex flex-col items-end relative w-full"> 
                    <div id="enemy-sprite" class="monster w-28 h-28 relative z-10 self-end mr-4">
                        <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-2xl">
                            <path d="M30,30 L20,10 L45,25 Z" fill="#7f1d1d"/> 
                            <path d="M70,30 L80,10 L55,25 Z" fill="#7f1d1d"/>
                            <path d="M20,80 Q50,90 80,80 L70,30 Q50,10 30,30 Z" fill="#ef4444" stroke="#7f1d1d" stroke-width="2"/>
                            <path d="M30,40 L70,40 L65,60 L35,60 Z" fill="#1f2937"/> 
                            <path d="M35,45 L50,45 L50,55 Z" fill="#fca5a5"/> 
                            <path d="M65,45 L50,45 L50,55 Z" fill="#fca5a5"/> 
                            <circle cx="50" cy="70" r="5" fill="#fca5a5" class="animate-pulse"/>
                        </svg>
                    </div>
                    <div class="w-32 h-2 bg-slate-800 rounded-full border border-slate-600 mt-2 overflow-hidden relative shadow-lg self-end mr-2">
                        <div id="enemy-hp" class="h-full bg-red-500 transition-all duration-300" style="width: 100%;"></div>
                    </div>
                    <div id="enemy-damage-text" class="absolute top-10 right-24 text-4xl font-black text-white stroke-black opacity-0" style="text-shadow: 2px 2px 0 #000; color: #fff;">-Ù¢Ù </div>
                </div>

                <!-- Player Area (Bottom Right in RTL) -->
                <div class="flex flex-col items-start relative w-full mt-4">
                    <div id="player-sprite" class="monster w-24 h-24 relative z-10 self-start ml-4">
                        <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-2xl" style="transform: scaleX(-1);">
                            <path d="M20,80 Q50,90 80,80 L70,30 Q50,10 30,30 Z" fill="#2563eb" stroke="#1d4ed8" stroke-width="2"/>
                            <path d="M30,40 L70,40 L65,60 L35,60 Z" fill="#1e293b"/> 
                            <circle cx="40" cy="50" r="3" fill="#06b6d4"/> <circle cx="60" cy="50" r="3" fill="#06b6d4"/>
                            <rect x="45" y="80" width="10" height="15" fill="#1d4ed8"/> 
                        </svg>
                    </div>
                    <div class="w-32 h-2 bg-slate-800 rounded-full border border-slate-600 mt-2 overflow-hidden relative shadow-lg self-start ml-2">
                        <div id="player-hp" class="h-full bg-green-500 transition-all duration-300" style="width: 100%;"></div>
                    </div>
                     <div id="player-damage-text" class="absolute bottom-10 left-24 text-4xl font-black text-red-500 opacity-0" style="text-shadow: 1px 1px 0 #fff;">-Ù¡Ù </div>
                </div>
            </div>

            <!-- Question & Actions Area -->
            <div class="bg-slate-800 rounded-t-3xl shadow-2xl border-t-4 border-blue-600 p-4 z-20 relative">
                <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-1 rounded-full text-xs font-bold border-2 border-slate-800 shadow-lg">
                    Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level-display">Ù¡</span>
                </div>
                <div class="text-center mb-4 mt-1">
                    <div class="bg-slate-900 rounded-xl p-3 border border-slate-600 shadow-inner flex justify-center items-center h-16">
                        <span id="question-text" class="math-arabic text-2xl font-bold text-white tracking-wider" dir="rtl"></span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-2" id="answers-grid"></div>
                 <div id="feedback-msg" class="text-center text-xs font-bold min-h-[1.5rem] mt-1 text-white"></div>
            </div>
        </div>

        <!-- Level Complete Modal (Instructional) -->
        <div id="level-modal" class="absolute inset-0 z-50 hidden flex flex-col items-center justify-center p-6 text-center">
            <div class="bg-slate-800 border-2 border-blue-500 rounded-2xl p-6 shadow-2xl w-full max-w-sm relative overflow-hidden">
                <!-- Shine effect -->
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-400 to-transparent"></div>
                
                <h3 class="text-2xl font-black text-white mb-2">Ø£Ø­Ø³Ù†Øª! ğŸ‰</h3>
                <p class="text-slate-300 text-xs mb-4">Ø£Ù†Ù‡ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰. Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©:</p>
                
                <div class="bg-slate-900 rounded-xl p-4 border border-slate-700 mb-6 text-right">
                    <h4 class="text-yellow-400 font-bold text-sm mb-2" id="modal-rule-title">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h4>
                    <p class="text-white text-sm leading-relaxed mb-3" id="modal-rule-text">...</p>
                    <div class="bg-slate-800 p-2 rounded text-center border border-slate-700">
                        <span class="text-blue-300 text-xs block mb-1">Ù…Ø«Ø§Ù„:</span>
                        <span class="math-arabic text-lg font-bold text-white" id="modal-rule-example" dir="rtl">...</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="retryLevel()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold text-sm border border-slate-600 transition-colors">
                        <i class="fas fa-redo ml-1"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
                    </button>
                    <button onclick="nextLevel()" class="flex-[2] py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-sm border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all">
                        Ø§Ø³ØªÙ…Ø±Ø§Ø± <i class="fas fa-arrow-left mr-1"></i>
                    </button>
                </div>
                <p class="text-[9px] text-slate-500 mt-2">* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„Ø§ ØªÙˆÙ‚Ù Ø§Ù„ÙˆÙ‚Øª!</p>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full overflow-hidden text-center justify-center">
            <div id="result-icon" class="text-6xl mb-4">ğŸ†</div>
            <h2 id="result-title" class="text-2xl font-black text-slate-800 mb-2">Ø§Ù†ØªØµØ§Ø± Ø³Ø§Ø­Ù‚!</h2>
            <div id="final-stats" class="grid grid-cols-2 gap-2 mb-4"></div>
            <div class="bg-green-50 p-4 rounded-2xl border border-green-100 mb-4">
                <i class="fas fa-cloud-upload-alt text-green-500 text-2xl mb-1"></i>
                <p class="font-black text-green-800 text-sm text-center">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</p>
            </div>
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-4 shadow-md">
                <i class="fas fa-crown ml-2"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø«
            </button>
            <div class="mt-auto flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 text-sm font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
                <button id="finish-btn" class="btn-touch flex-[2] bg-slate-900 text-white text-sm font-bold">Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ø·ÙˆØ± V19.5 -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                <button onclick="closeLeaderboardModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„ÙƒÙ„)</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl border border-slate-100 p-1 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><div class="sync-loader text-blue-500 text-3xl"><i class="fas fa-sync"></i></div></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
            <p class="text-center text-[9px] text-slate-400 mt-2 font-mono">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø«Ù… Ø§Ù„ÙˆÙ‚Øª</p>
        </div>
    </div>

    <script>
    (function() {
        // --- Core Configuration (V19.5) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = urlParams.get('gameId') || 'g6_1_2'; 
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        
        let effectiveStudentId = studentId;
        if (!effectiveStudentId) {
            effectiveStudentId = sessionStorage.getItem('guestId');
            if (!effectiveStudentId) {
                effectiveStudentId = 'guest_' + Math.floor(Math.random() * 1000000);
                sessionStorage.setItem('guestId', effectiveStudentId);
            }
        }

        let currentMetricType = 'time'; 
        let currentLeaderboardMode = classId ? 'class' : 'global';

        // --- Helper Functions ---
        const toAr = (str) => {
            if (typeof str === 'number') str = String(str);
            const map = {
                '0': 'Ù ', '1': 'Ù¡', '2': 'Ù¢', '3': 'Ù£', '4': 'Ù¤', 
                '5': 'Ù¥', '6': 'Ù¦', '7': 'Ù§', '8': 'Ù¨', '9': 'Ù©',
                'x': 'Ø³', 'y': 'Øµ', 'm': 'Ù…', 'n': 'Ù†', 'a': 'Ø£', 'b': 'Ø¨', 'z': 'Ø¹',
                '.': '.' // Keep dot for decimals if needed
            };
            return str.replace(/[0-9xymnabz]/g, c => map[c] || c);
        };

        const spacer = () => '<span class="var-spacing"></span>';

        // --- FIXED QUESTION BANK (V2) ---
        const QUESTION_BANK = {
            1: [
                { q: `Ø³<sup>Ù£</sup> Ã— Ø³<sup>Ù¤</sup>`, a: `Ø³<sup>Ù§</sup>`, w1: `Ø³<sup>Ù¡Ù¢</sup>`, w2: `Ù¢Ø³<sup>Ù§</sup>`, exp: "ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Øµ<sup>Ù¢</sup> Ã— Øµ<sup>Ù¥</sup>`, a: `Øµ<sup>Ù§</sup>`, w1: `Øµ<sup>Ù¡Ù </sup>`, w2: `Øµ<sup>Ù£</sup>`, exp: "ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ø£ Ã— Ø£<sup>Ù£</sup>`, a: `Ø£<sup>Ù¤</sup>`, w1: `Ø£<sup>Ù£</sup>`, w2: `Ù¢Ø£<sup>Ù£</sup>`, exp: "ØªØ°ÙƒØ±: Ø£ ØªØ¹Ù†ÙŠ Ø£ Ø£Ø³ Ù¡" },
                { q: `Ù†<sup>Ù¤</sup> Ã— Ù†<sup>Ù¦</sup>`, a: `Ù†<sup>Ù¡Ù </sup>`, w1: `Ù†<sup>Ù¢Ù¤</sup>`, w2: `Ù¢Ù†<sup>Ù¡Ù </sup>`, exp: "ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ù¢Ø³<sup>Ù¢</sup> Ã— Ù£Ø³<sup>Ù£</sup>`, a: `Ù¦Ø³<sup>Ù¥</sup>`, w1: `Ù¥Ø³<sup>Ù¥</sup>`, w2: `Ù¦Ø³<sup>Ù¦</sup>`, exp: "Ù†Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙ†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ù¤Ù…<sup>Ù¢</sup> Ã— Ù…<sup>Ù¥</sup>`, a: `Ù¤Ù…<sup>Ù§</sup>`, w1: `Ù¤Ù…<sup>Ù¡Ù </sup>`, w2: `Ù¥Ù…<sup>Ù§</sup>`, exp: "Ù†Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙ†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ù¥Ø¬ Ã— Ù¢Ø¬<sup>Ù¢</sup>`, a: `Ù¡Ù Ø¬<sup>Ù£</sup>`, w1: `Ù§Ø¬<sup>Ù£</sup>`, w2: `Ù¡Ù Ø¬<sup>Ù¢</sup>`, exp: "Ù†Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙ†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ù£Ù‡Ù€<sup>Ù¤</sup> Ã— Ù£Ù‡Ù€<sup>Ù¤</sup>`, a: `Ù©Ù‡Ù€<sup>Ù¨</sup>`, w1: `Ù¦Ù‡Ù€<sup>Ù¨</sup>`, w2: `Ù©Ù‡Ù€<sup>Ù¡Ù¦</sup>`, exp: "Ù†Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙ†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³" },
                { q: `Ø³<sup>Ù¢</sup>Øµ Ã— Ø³ Øµ<sup>Ù¤</sup>`, a: `Ø³<sup>Ù£</sup>Øµ<sup>Ù¥</sup>`, w1: `Ø³<sup>Ù¢</sup>Øµ<sup>Ù¤</sup>`, w2: `Ù¢Ø³<sup>Ù¢</sup>Øµ<sup>Ù¤</sup>`, exp: "Ø§Ø¬Ù…Ø¹ Ø£Ø³Ø³ ÙƒÙ„ Ù…ØªØºÙŠØ± Ø¹Ù„Ù‰ Ø­Ø¯Ø©" },
                { q: `Ù¢Ø³ Øµ<sup>Ù¢</sup>Ø¹ Ã— Ù£Ø³<sup>Ù¢</sup>Øµ Ø¹<sup>Ù£</sup>`, a: `Ù¦Ø³<sup>Ù£</sup>Øµ<sup>Ù£</sup>Ø¹<sup>Ù¤</sup>`, w1: `Ù¥Ø³<sup>Ù£</sup>Øµ<sup>Ù£</sup>Ø¹<sup>Ù¤</sup>`, w2: `Ù¦Ø³<sup>Ù¢</sup>Øµ<sup>Ù¢</sup>Ø¹<sup>Ù£</sup>`, exp: "Ø§Ø¬Ù…Ø¹ Ø£Ø³Ø³ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª" }
            ],
            2: [
                { q: `(Ø³<sup>Ù¢</sup>)<sup>Ù£</sup>`, a: `Ø³<sup>Ù¦</sup>`, w1: `Ø³<sup>Ù¥</sup>`, w2: `Ù£Ø³<sup>Ù¢</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Øµ<sup>Ù£</sup>)<sup>Ù£</sup>`, a: `Øµ<sup>Ù©</sup>`, w1: `Øµ<sup>Ù¦</sup>`, w2: `Ù£Øµ<sup>Ù£</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ù†<sup>Ù¤</sup>)<sup>Ù¢</sup>`, a: `Ù†<sup>Ù¨</sup>`, w1: `Ù†<sup>Ù¦</sup>`, w2: `Ù¢Ù†<sup>Ù¤</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ø£<sup>Ù¥</sup>)<sup>Ù¢</sup>`, a: `Ø£<sup>Ù¡Ù </sup>`, w1: `Ø£<sup>Ù§</sup>`, w2: `Ù¢Ø£<sup>Ù¥</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ùƒ<sup>Ù¢</sup>)<sup>Ù¥</sup>`, a: `Ùƒ<sup>Ù¡Ù </sup>`, w1: `Ùƒ<sup>Ù§</sup>`, w2: `Ù¥Ùƒ<sup>Ù¢</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ù…<sup>Ù£</sup>)<sup>Ù¤</sup>`, a: `Ù…<sup>Ù¡Ù¢</sup>`, w1: `Ù…<sup>Ù§</sup>`, w2: `Ù¤Ù…<sup>Ù£</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ø¯<sup>Ù¤</sup>)<sup>Ù¢</sup>`, a: `Ø¯<sup>Ù¨</sup>`, w1: `Ø¯<sup>Ù¦</sup>`, w2: `Ù¢Ø¯<sup>Ù¤</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ø³<sup>Ù¦</sup>)<sup>Ù¢</sup>`, a: `Ø³<sup>Ù¡Ù¢</sup>`, w1: `Ø³<sup>Ù¨</sup>`, w2: `Ù¢Ø³<sup>Ù¦</sup>`, exp: "ÙÙŠ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ© Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ù¢Ø³<sup>Ù£</sup>)<sup>Ù¢</sup>`, a: `Ù¤Ø³<sup>Ù¦</sup>`, w1: `Ù¢Ø³<sup>Ù¦</sup>`, w2: `Ù¤Ø³<sup>Ù¥</sup>`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³: Ù¢ Ø£Ø³ Ù¢ ÙˆØ³ Ø£Ø³ (Ù£Ã—Ù¢)" },
                { q: `(Ù£Øµ<sup>Ù¢</sup>)<sup>Ù£</sup>`, a: `Ù¢Ù§Øµ<sup>Ù¦</sup>`, w1: `Ù©Øµ<sup>Ù¦</sup>`, w2: `Ù£Øµ<sup>Ù¦</sup>`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³: Ù£ Ø£Ø³ Ù£ ÙˆØ³ Ø£Ø³ (Ù¢Ã—Ù£)" }
            ],
            3: [
                { q: `(Ø³ Øµ)<sup>Ù£</sup>`, a: `Ø³<sup>Ù£</sup>Øµ<sup>Ù£</sup>`, w1: `Ø³ Øµ<sup>Ù£</sup>`, w2: `Ù£Ø³ Øµ`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¹Ù„Ù‰ Ù…Ø§ Ø¨Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚ÙˆØ³" },
                { q: `(Ù¢Ø³)<sup>Ù¢</sup>`, a: `Ù¤Ø³<sup>Ù¢</sup>`, w1: `Ù¢Ø³<sup>Ù¢</sup>`, w2: `Ù¤Ø³`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ù…ØªØºÙŠØ±" },
                { q: `(Ù£Øµ<sup>Ù¢</sup>)<sup>Ù¢</sup>`, a: `Ù©Øµ<sup>Ù¤</sup>`, w1: `Ù£Øµ<sup>Ù¤</sup>`, w2: `Ù¦Øµ<sup>Ù¤</sup>`, exp: "Ø±Ø¨Ø¹ Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙˆØ§Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ø£<sup>Ù¢</sup>Ø¨)<sup>Ù£</sup>`, a: `Ø£<sup>Ù¦</sup>Ø¨<sup>Ù£</sup>`, w1: `Ø£<sup>Ù¥</sup>Ø¨<sup>Ù£</sup>`, w2: `Ø£<sup>Ù¦</sup>Ø¨`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¨Ø§Ù„Ø¶Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø³" },
                { q: `(Ù¥Ùƒ)<sup>Ù¢</sup>`, a: `Ù¢Ù¥Ùƒ<sup>Ù¢</sup>`, w1: `Ù¡Ù Ùƒ<sup>Ù¢</sup>`, w2: `Ù¥Ùƒ<sup>Ù¢</sup>`, exp: "Ù¥ Ø£Ø³ Ù¢ ØªØ³Ø§ÙˆÙŠ Ù¢Ù¥" },
                { q: `(Ù¢Ù… Ù†<sup>Ù¢</sup>)<sup>Ù£</sup>`, a: `Ù¨Ù…<sup>Ù£</sup>Ù†<sup>Ù¦</sup>`, w1: `Ù¦Ù…<sup>Ù£</sup>Ù†<sup>Ù¦</sup>`, w2: `Ù¢Ù…<sup>Ù£</sup>Ù†<sup>Ù¦</sup>`, exp: "Ù¢ Ø£Ø³ Ù£ ØªØ³Ø§ÙˆÙŠ Ù¨" },
                { q: `(Ù¤Ø¹<sup>Ù¢</sup>)<sup>Ù¢</sup>`, a: `Ù¡Ù¦Ø¹<sup>Ù¤</sup>`, w1: `Ù¨Ø¹<sup>Ù¤</sup>`, w2: `Ù¤Ø¹<sup>Ù¤</sup>`, exp: "Ù¤ Ø£Ø³ Ù¢ ØªØ³Ø§ÙˆÙŠ Ù¡Ù¦" },
                { q: `(Ø³<sup>Ù£</sup>Øµ<sup>Ù¤</sup>)<sup>Ù¢</sup>`, a: `Ø³<sup>Ù¦</sup>Øµ<sup>Ù¨</sup>`, w1: `Ø³<sup>Ù¥</sup>Øµ<sup>Ù¦</sup>`, w2: `Ø³<sup>Ù©</sup>Øµ<sup>Ù¡Ù¦</sup>`, exp: "Ø§Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„" },
                { q: `(Ø³ Øµ Ø¹)<sup>Ù¤</sup>`, a: `Ø³<sup>Ù¤</sup>Øµ<sup>Ù¤</sup>Ø¹<sup>Ù¤</sup>`, w1: `Ø³ Øµ Ø¹<sup>Ù¤</sup>`, w2: `Ù¤Ø³ Øµ Ø¹`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹" },
                { q: `(Ù¢Ø³<sup>Ù¢</sup>Øµ Ø¹<sup>Ù£</sup>)<sup>Ù¢</sup>`, a: `Ù¤Ø³<sup>Ù¤</sup>Øµ<sup>Ù¢</sup>Ø¹<sup>Ù¦</sup>`, w1: `Ù¢Ø³<sup>Ù¤</sup>Øµ<sup>Ù¢</sup>Ø¹<sup>Ù¦</sup>`, w2: `Ù¤Ø³<sup>Ù¤</sup>Øµ Ø¹<sup>Ù¦</sup>`, exp: "ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„ÙƒÙ„" }
            ]
        };

        // Rule Content
        const RULES = {
            1: { title: "Ù‚Ø§Ø¹Ø¯Ø© Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯", text: "Ø¹Ù†Ø¯ Ø¶Ø±Ø¨ Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ø£Ø³Ø§Ø³ØŒ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³.", ex: "Ø³<sup>Ù¢</sup> Ã— Ø³<sup>Ù£</sup> = Ø³<sup>Ù¥</sup>" },
            2: { title: "Ù‚Ø§Ø¹Ø¯Ø© Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ©", text: "Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ©ØŒ Ù†Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³Ø³ Ø¨Ø¨Ø¹Ø¶Ù‡Ø§.", ex: "(Ø³<sup>Ù¢</sup>)<sup>Ù£</sup> = Ø³<sup>Ù¦</sup>" },
            3: { title: "Ù‚Ø§Ø¹Ø¯Ø© Ù‚ÙˆØ© Ø­Ø§ØµÙ„ Ø§Ù„Ø¶Ø±Ø¨", text: "Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ù„Ù‚ÙˆØ©ØŒ ÙˆØ²Ø¹ Ø§Ù„Ø£Ø³ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ø§Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚ÙˆØ³.", ex: "(Ù¢Ø³)<sup>Ù£</sup> = Ù¨Ø³<sup>Ù£</sup>" }
        };

        // --- Monster Duel Game State ---
        let gameActive = false;
        let level = 1;
        let playerMaxHP = 100;
        let enemyMaxHP = 100;
        let playerCurrentHP = 100;
        let enemyCurrentHP = 100;
        let startTime = 0;
        let timerInterval;
        
        let levelQuestions = []; 

        // --- DOM Elements ---
        const playerHpBar = document.getElementById('player-hp');
        const enemyHpBar = document.getElementById('enemy-hp');
        const questionText = document.getElementById('question-text');
        const answersGrid = document.getElementById('answers-grid');
        const feedbackMsg = document.getElementById('feedback-msg');
        const playerSprite = document.getElementById('player-sprite');
        const enemySprite = document.getElementById('enemy-sprite');
        const levelDisplay = document.getElementById('level-display');
        const timerDisplay = document.getElementById('timer-display');
        const levelModal = document.getElementById('level-modal');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            
            if (!classId) {
                document.getElementById('tab-class').style.display = 'none';
                currentLeaderboardMode = 'global';
            } else {
                document.getElementById('tab-class').className = 'tab-btn tab-active';
                document.getElementById('tab-global').className = 'tab-btn tab-inactive';
                currentLeaderboardMode = 'class';
            }

            if (studentId && classId) {
                document.getElementById('sync-icon').classList.remove('hidden');
                fetchInitialCloudData();
            }
            document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        });

        async function fetchInitialCloudData() {
            try {
                const res = await (await fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) {
                        studentName = res.data.name;
                        document.getElementById('top-student-name').textContent = studentName;
                    } else if (!urlParams.get('name')) {
                        document.getElementById('top-student-name').textContent = "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±";
                    }
                    if (res.data.games && res.data.games[GAME_ID]) {
                        document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                    }
                }
            } catch (e) { console.log("Sync Error"); }
            finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        // --- Game Logic ---

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        window.startGame = () => { 
            document.getElementById('start-screen').classList.add('hidden'); 
            document.getElementById('game-screen').classList.remove('hidden'); 
            initDuel();
        };

        function initDuel() {
            gameActive = true;
            level = 1;
            playerCurrentHP = 100;
            enemyCurrentHP = 100;
            updateHP();
            prepareLevelQuestions(); 
            generateQuestion();
            
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!gameActive) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            timerDisplay.innerText = toAr(`${m}:${s}`);
        }

        function updateHP() {
            const pPercent = (playerCurrentHP / playerMaxHP) * 100;
            const ePercent = (enemyCurrentHP / enemyMaxHP) * 100;
            playerHpBar.style.width = `${Math.max(0, pPercent)}%`;
            enemyHpBar.style.width = `${Math.max(0, ePercent)}%`;
            playerHpBar.className = `h-full transition-all duration-500 ${pPercent < 30 ? 'bg-red-500' : 'bg-green-500'}`;
        }

        function prepareLevelQuestions() {
            if (QUESTION_BANK[level]) {
                levelQuestions = shuffle([...QUESTION_BANK[level]]);
            } else {
                levelQuestions = []; 
            }
        }

        function generateQuestion() {
            if (!gameActive) return;
            
            feedbackMsg.innerText = '';
            answersGrid.innerHTML = '';
            levelDisplay.innerText = toAr(level);

            if (levelQuestions.length === 0) {
                prepareLevelQuestions();
            }

            const qData = levelQuestions.pop();

            questionText.innerHTML = qData.q;

            let answers = [
                { html: qData.a, isCorrect: true },
                { html: qData.w1, isCorrect: false },
                { html: qData.w2, isCorrect: false }
            ];
            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = "card-btn bg-white border-2 border-slate-300 rounded-lg py-4 px-1 flex justify-center items-center shadow-md text-slate-800 focus:outline-none";
                btn.innerHTML = `<span class="math-arabic text-lg font-bold" dir="rtl">${ans.html}</span>`;
                btn.onclick = () => handleAnswer(ans.isCorrect, qData.exp);
                answersGrid.appendChild(btn);
            });
        }

        function handleAnswer(isCorrect, explanation) {
            const btns = document.querySelectorAll('.card-btn');
            btns.forEach(b => b.disabled = true);

            playerSprite.classList.add('anim-charge-p');
            enemySprite.classList.add('anim-charge-e');

            setTimeout(() => {
                if (isCorrect) {
                    feedbackMsg.innerText = "Ù‡Ø¬ÙˆÙ… Ù†Ø§Ø¬Ø­!";
                    feedbackMsg.className = "text-center text-xs font-bold min-h-[1.5rem] mt-1 text-green-400";
                    enemySprite.classList.remove('anim-charge-e');
                    void enemySprite.offsetWidth;
                    enemySprite.classList.add('anim-pain-e');
                    
                    let dmg = 25; 
                    enemyCurrentHP -= dmg;
                    showDamage(dmg, 'enemy');
                    updateHP();

                    if (enemyCurrentHP <= 0) {
                        setTimeout(() => {
                            showLevelCompleteModal();
                        }, 1000);
                    } else {
                        setTimeout(generateQuestion, 1200);
                    }
                } else {
                    feedbackMsg.innerText = "Ø®Ø·Ø£! " + explanation;
                    feedbackMsg.className = "text-center text-xs font-bold min-h-[1.5rem] mt-1 text-red-400";
                    playerSprite.classList.remove('anim-charge-p');
                    void playerSprite.offsetWidth;
                    playerSprite.classList.add('anim-pain-p');
                    
                    let dmg = 20;
                    playerCurrentHP -= dmg;
                    showDamage(dmg, 'player');
                    updateHP();

                    if (playerCurrentHP <= 0) {
                        setTimeout(() => endGame(false), 1000);
                    } else {
                        setTimeout(generateQuestion, 2000);
                    }
                }
            }, 300);

            setTimeout(() => {
                playerSprite.classList.remove('anim-charge-p', 'anim-pain-p');
                enemySprite.classList.remove('anim-charge-e', 'anim-pain-e');
            }, 1200);
        }

        function showDamage(amount, target) {
            const el = document.getElementById(`${target}-damage-text`);
            el.innerText = `-${toAr(amount)}`;
            el.classList.remove('opacity-0');
            el.classList.add('anim-damage-text');
            setTimeout(() => { el.classList.remove('anim-damage-text'); el.classList.add('opacity-0'); }, 1000);
        }

        function showLevelCompleteModal() {
            // Populate modal with current level rules
            const rule = RULES[level];
            document.getElementById('modal-rule-title').textContent = rule.title;
            document.getElementById('modal-rule-text').textContent = rule.text;
            document.getElementById('modal-rule-example').innerHTML = rule.ex;
            
            levelModal.classList.remove('hidden');
            levelModal.classList.add('flex');
        }

        window.retryLevel = function() {
            levelModal.classList.add('hidden');
            levelModal.classList.remove('flex');
            
            // Reset for retry
            enemyCurrentHP = 100;
            playerCurrentHP = 100; // Give a fresh start for health to pass level
            updateHP();
            prepareLevelQuestions();
            generateQuestion();
            // Timer keeps running
        };

        window.nextLevel = function() {
            levelModal.classList.add('hidden');
            levelModal.classList.remove('flex');

            if (level >= 3) {
                endGame(true);
            } else {
                level++;
                enemyCurrentHP = 100;
                // Player health carries over? Or resets? 
                // "Instruction: continue... basically continue the game"
                // Usually next level means new challenge. Let's keep existing HP or maybe heal slightly?
                // Let's reset HP to be fair for the new level challenge since it's "Stages".
                // But Scenario 3 was Survival. 
                // However, with "Retry", Survival becomes tricky. 
                // Let's stick to the prompt: "Continue...". Let's keep HP as is for survival challenge.
                updateHP();
                prepareLevelQuestions();
                feedbackMsg.innerText = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${toAr(level)}`;
                feedbackMsg.className = "text-center text-xs font-bold min-h-[1.5rem] mt-1 text-yellow-400";
                generateQuestion();
            }
        };

        function endGame(victory) {
            gameActive = false;
            clearInterval(timerInterval);
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
            
            // Scoring Logic - Scenario 3: Grade = Remaining Health
            let achieved = 0;
            let max = 100;
            
            if (victory) {
                achieved = playerCurrentHP;
            } else {
                let progress = ((level - 1) * 33) + ((100 - enemyCurrentHP) * 0.33);
                achieved = Math.min(90, Math.floor(progress));
            }

            const grade = ((achieved / max) * 5).toFixed(1);
            
            // UI Updates
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            
            if (victory) {
                resultIcon.textContent = 'ğŸ†';
                resultTitle.textContent = 'Ø§Ù†ØªØµØ§Ø± Ø³Ø§Ø­Ù‚!';
                resultTitle.className = "text-2xl font-black text-green-600 mb-2";
            } else {
                resultIcon.textContent = 'ğŸ’€';
                resultTitle.textContent = 'Ù‡Ø²Ù…Ùƒ Ø§Ù„ÙˆØ­Ø´!';
                resultTitle.className = "text-2xl font-black text-red-600 mb-2";
            }

            showResult(achieved, max, grade, timeTaken);
            saveScore(grade, timeTaken); 
        }

        function showResult(a, m, g, met) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-2 rounded-xl border border-blue-100"><p class="text-[9px] font-bold text-blue-400">Ø§Ù„Ø¯Ø±Ø¬Ø©</p><p class="text-lg font-black text-blue-900">${toAr(g)}</p></div>
                <div class="bg-purple-50 p-2 rounded-xl border border-purple-100"><p class="text-[9px] font-bold text-purple-400">Ø§Ù„ÙˆÙ‚Øª (Ø«)</p><p class="text-lg font-black text-purple-900">${toAr(met)}</p></div>
            `;
        }

        async function saveScore(g, met) {
            const sId = effectiveStudentId;
            const cId = classId || 'global'; 
            const p = new URLSearchParams({ action: 'saveScore', studentId: sId, classId: cId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            
            let reqClassId = (currentLeaderboardMode === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;

            fetch(url).then(r => r.json()).then(res => {
                if (res.status === 'success' && res.data?.length > 0) {
                    let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="text-slate-400 border-b border-slate-100 bg-slate-50/50"><tr><th class="p-2 text-center">#</th><th class="p-2 text-right">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody class="divide-y divide-slate-50">`;
                    res.data.forEach((p, i) => {
                        const isMe = (String(p.studentId || "").trim() === String(effectiveStudentId).trim()) || (studentId && String(p.name).trim() === String(studentName).trim());
                        let displayName = p.name;
                        if (!displayName && isMe) displayName = studentName || "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±";
                        if (!displayName) displayName = "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±";

                        h += `<tr class="${isMe ? 'rank-row-me' : 'hover:bg-slate-50/50'} transition-colors">
                            <td class="p-2 leaderboard-rank text-center ${i<3 ? 'text-yellow-500 text-sm' : 'text-slate-400'}">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td>
                            <td class="p-2 leaderboard-name ${isMe ? 'text-blue-700 font-black' : 'text-slate-700'}">${displayName} ${isMe ? '<span class="bg-blue-600 text-white text-[8px] px-1 rounded mx-1">Ø£Ù†Øª</span>' : ''}</td>
                            <td class="p-2 text-center">
                                <span class="text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</span> 
                                <span class="text-[8px] text-slate-400 block font-bold">(${toAr(p.metric || p.metricValue || 0)} Ø«)</span>
                            </td>
                        </tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="py-10 text-center text-slate-400 text-xs italic">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (mode) => {
            currentLeaderboardMode = mode;
            document.getElementById('tab-class').className = mode === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            document.getElementById('tab-global').className = mode === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive';
            fetchAndShowLeaderboard(false);
        };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
    })();
    </script>
</body>
</html>

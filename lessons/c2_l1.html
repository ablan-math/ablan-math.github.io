<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٢-١: العلاقات | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .step-box { border-right: 4px solid #1d4ed8; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        input[type="radio"]:disabled + .option-label { cursor: not-allowed; background-color: #f3f4f6; }
        input[type="radio"]:disabled:checked + .option-label { background-color: #dbeafe; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .math-eq {
            font-family: "Courier New", monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 2px 8px;
            border-radius: 6px;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Interactive Example Styles */
        .interactive-table input { width: 100%; text-align: center; border: 1px solid #d1d5db; border-radius: 4px; }
        .interactive-table input.correct { border-color: #16a34a; background-color: #f0fdf4; }
        .interactive-table input.incorrect { border-color: #dc2626; background-color: #fef2f2; }
        .graph-target-point { cursor: pointer; fill: transparent; }
        .graph-user-point { transition: opacity 0.3s; }
        .mapping-source, .mapping-target { cursor: pointer; }
        .mapping-source.selected { font-weight: bold; fill: #2563eb; }
        
        /* Glowing Text Effect */
        .glow-blue {
            color: #2563eb; /* blue-600 */
            text-shadow: 0 0 8px #60a5fa, 0 0 12px #60a5fa;
            transition: all 0.3s ease-in-out;
        }
        .glow-green {
            color: #16a34a; /* green-600 */
            text-shadow: 0 0 8px #4ade80, 0 0 12px #4ade80;
            transition: all 0.3s ease-in-out;
        }
        .analysis-text-item {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٢-١: العلاقات</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفهوم الأساسي</h2>
                    <div class="p-4 bg-blue-50 rounded-lg space-y-3">
                        <p>في الرياضيات، <span class="vocab-term">العلاقة</span> هي أي مجموعة من الأزواج المرتبة. يمكن تمثيل العلاقة بعدة طرق: جدول، تمثيل بياني، أو مخطط سهمي.</p>
                        <p>كل زوج مرتب يتكون من <span class="vocab-term">إحداثي سيني</span> و <span class="vocab-term">إحداثي صادي</span>. مجموعة الإحداثيات السينية تسمى <span class="vocab-term">المجال</span>، ومجموعة الإحداثيات الصادية تسمى <span class="vocab-term">المدى</span>.</p>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: تمثيل العلاقة</h2>
                     <div class="p-6 bg-gray-50 rounded-lg">
                        <p class="text-lg font-semibold mb-4">مثال: مثل العلاقة <span class="math-eq">{ (٢، ٥)، (-٢، ٣)، (٥، -٢)، (-١، -٢) }</span> بيانياً، وبجدول، وبمخطط سهمي. ثم حدد المجال والمدى.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div>
                                <h4 class="font-bold mb-2">جدول</h4>
                                <table class="w-full border text-center rounded-lg overflow-hidden"><thead class="bg-gray-200"><tr class="border-b"><th class="p-2">س</th><th class="p-2">ص</th></tr></thead><tbody><tr class="border-b"><td>٢</td><td>٥</td></tr><tr class="border-b"><td>-٢</td><td>٣</td></tr><tr class="border-b"><td>٥</td><td>-٢</td></tr><tr><td>-١</td><td>-٢</td></tr></tbody></table>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">تمثيل بياني</h4>
                                <!-- Note: SVG y-axis is inverted (0 is at the top). So (x, y) is plotted at (x, -y) -->
                                <div class="p-2 bg-white border rounded-lg"><svg viewBox="-6 -6 12 12" class="w-full h-48"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -5 5 V -5 M -4 5 V -5 M -3 5 V -5 M -2 5 V -5 M -1 5 V -5 M 1 5 V -5 M 2 5 V -5 M 3 5 V -5 M 4 5 V -5 M 5 5 V -5" /><path d="M -5 5 H 5 M -5 4 H 5 M -5 3 H 5 M -5 2 H 5 M -5 1 H 5 M -5 -1 H 5 M -5 -2 H 5 M -5 -3 H 5 M -5 -4 H 5 M -5 -5 H 5" /></g><line x1="-5.5" y1="0" x2="5.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-5.5" x2="0" y2="5.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="2" cy="-5" r="0.2" fill="#ef4444"/><circle cx="-2" cy="-3" r="0.2" fill="#ef4444"/><circle cx="5" cy="2" r="0.2" fill="#ef4444"/><circle cx="-1" cy="2" r="0.2" fill="#ef4444"/></svg></div>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">مخطط سهمي</h4>
                                <div class="p-2 bg-white border rounded-lg"><svg viewBox="0 0 100 100" class="w-full h-48"><defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="18" font-size="8" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="35" font-size="8" text-anchor="middle">٢</text><text x="80" y="50" font-size="8" text-anchor="middle">-٢</text><text x="80" y="65" font-size="8" text-anchor="middle">٥</text><text x="80" y="80" font-size="8" text-anchor="middle">-١</text><rect x="5" y="15" width="30" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="28" font-size="8" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="45" font-size="8" text-anchor="middle">٥</text><text x="20" y="60" font-size="8" text-anchor="middle">٣</text><text x="20" y="75" font-size="8" text-anchor="middle">-٢</text><path d="M 65 35 Q 50 40 35 45" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 50 Q 50 55 35 60" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 65 Q 50 70 35 75" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /><path d="M 65 80 Q 50 78 35 75" stroke="#60a5fa" stroke-width="0.5" fill="none" marker-end="url(#arrow)" /></svg></div>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-green-100 rounded-lg text-center">
                            <p><span class="vocab-term">المجال</span> هو مجموعة قيم س: <span class="math-eq">{٢، -٢، ٥، -١}</span></p>
                            <p><span class="vocab-term">المدى</span> هو مجموعة قيم ص: <span class="math-eq">{٥، ٣، -٢}</span> (بدون تكرار)</p>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">✍️ مثال تفاعلي: أكمل التمثيلات</h2>
                     <div id="interactive-example-container" class="p-6 bg-gray-50 rounded-lg">
                         <p class="text-lg font-semibold mb-4">المهمة: أكمل تمثيلات العلاقة <span class="math-eq">{ (٢، ٠)، (-٢، ٣)، (٥، -٢)، (-١، -٢) }</span></p>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                             <div>
                                 <h4 class="font-bold mb-2">١. أكمل الجدول</h4>
                                 <table class="w-full border text-center rounded-lg overflow-hidden interactive-table"><thead class="bg-gray-200"><tr class="border-b"><th class="p-2">س</th><th class="p-2">ص</th></tr></thead><tbody><tr class="border-b"><td>٢</td><td>٠</td></tr><tr class="border-b"><td>-٢</td><td>٣</td></tr><tr class="border-b"><td><input type="number" id="interactive-s1" data-correct="5"></td><td><input type="number" id="interactive-p1" data-correct="-2"></td></tr><tr><td><input type="number" id="interactive-s2" data-correct="-1"></td><td><input type="number" id="interactive-p2" data-correct="-2"></td></tr></tbody></table>
                             </div>
                             <div>
                                 <h4 class="font-bold mb-2">٢. أضف النقاط</h4>
                                 <!-- Note: SVG y-axis is inverted. Points to add are (5, -2) and (-1, -2). They are plotted at cy="2" -->
                                 <div class="p-2 bg-white border rounded-lg"><svg id="interactive-graph" viewBox="-6 -6 12 12" class="w-full h-48"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -5 5 V -5 M -4 5 V -5 M -3 5 V -5 M -2 5 V -5 M -1 5 V -5 M 1 5 V -5 M 2 5 V -5 M 3 5 V -5 M 4 5 V -5 M 5 5 V -5" /><path d="M -5 5 H 5 M -5 4 H 5 M -5 3 H 5 M -5 2 H 5 M -5 1 H 5 M -5 -1 H 5 M -5 -2 H 5 M -5 -3 H 5 M -5 -4 H 5 M -5 -5 H 5" /></g><line x1="-5.5" y1="0" x2="5.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-5.5" x2="0" y2="5.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="2" cy="0" r="0.2" fill="#16a34a"/><circle cx="-2" cy="-3" r="0.2" fill="#16a34a"/><circle id="user-point-1" cx="5" cy="2" r="0.2" fill="#ef4444" class="graph-user-point" opacity="0"/><circle id="user-point-2" cx="-1" cy="2" r="0.2" fill="#ef4444" class="graph-user-point" opacity="0"/><circle data-point-id="user-point-1" cx="5" cy="2" r="0.5" class="graph-target-point"/><circle data-point-id="user-point-2" cx="-1" cy="2" r="0.5" class="graph-target-point"/></svg></div>
                             </div>
                             <div>
                                 <h4 class="font-bold mb-2">٣. ارسم الأسهم</h4>
                                 <div class="p-2 bg-white border rounded-lg"><svg id="interactive-mapping" viewBox="0 0 100 100" class="w-full h-48"><defs><marker id="arrow-interactive" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="18" font-size="8" font-weight="bold" text-anchor="middle">المجال</text><text class="mapping-source" data-value="2" x="80" y="35" font-size="8" text-anchor="middle">٢</text><text class="mapping-source" data-value="-2" x="80" y="50" font-size="8" text-anchor="middle">-٢</text><text class="mapping-source" data-value="5" x="80" y="65" font-size="8" text-anchor="middle">٥</text><text class="mapping-source" data-value="-1" x="80" y="80" font-size="8" text-anchor="middle">-١</text><rect x="5" y="15" width="30" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="28" font-size="8" font-weight="bold" text-anchor="middle">المدى</text><text class="mapping-target" data-value="0" x="20" y="45" font-size="8" text-anchor="middle">٠</text><text class="mapping-target" data-value="3" x="20" y="60" font-size="8" text-anchor="middle">٣</text><text class="mapping-target" data-value="-2" x="20" y="75" font-size="8" text-anchor="middle">-٢</text><path d="M 65 35 Q 50 40 35 45" stroke="#16a34a" stroke-width="0.5" fill="none" marker-end="url(#arrow-interactive)" /><path d="M 65 50 Q 50 55 35 60" stroke="#16a34a" stroke-width="0.5" fill="none" marker-end="url(#arrow-interactive)" /><g id="user-arrows-container"></g></svg></div>
                             </div>
                         </div>
                         <div id="interactive-feedback" class="mt-4 text-center font-bold"></div>
                         <div class="mt-4 flex justify-center gap-4">
                             <button id="check-interactive-btn" class="bg-green-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-green-700">تحقق من عملي</button>
                             <button id="show-solution-btn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">أظهر الحل</button>
                         </div>
                     </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثالثاً: المتغير المستقل والمتغير التابع</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <p class="text-lg font-semibold mb-4">في العلاقة، المتغير الذي يحدد قيمة المخرجة يسمى <span class="vocab-term">المتغير المستقل</span> (عادة س)، بينما المتغير الذي تعتمد قيمته على المدخلة يسمى <span class="vocab-term">المتغير التابع</span> (عادة ص).</p>
                        
                        <div id="variables-examples-container" class="mt-4 border-t pt-4">
                            <div id="example-display" class="p-4 bg-white rounded-lg min-h-[150px] flex flex-col justify-center text-center">
                                <!-- Example content will be injected here by JS -->
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-example-btn" class="bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">&larr; السابق</button>
                                <span id="example-counter" class="text-sm font-bold text-gray-600"></span>
                                <div>
                                    <button id="next-example-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700">التالي &rarr;</button>
                                    <button id="reset-vars-btn" class="hidden bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700">إعادة عرض الأمثلة</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📊 رابعاً: تحليل التمثيلات البيانية</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div id="analysis-container">
                            <div class="flex flex-col md:flex-row items-center gap-6">
                                <div id="analysis-text-container" class="flex-1 min-h-[150px]">
                                    <!-- Analysis text will be injected here -->
                                </div>
                                <div class="w-full md:w-1/3">
                                    <svg id="analysis-graph" viewBox="0 0 100 100" class="w-full bg-white border rounded-lg p-2">
                                        <line x1="10" y1="5" x2="10" y2="90" stroke="black" stroke-width="1"/>
                                        <line x1="10" y1="90" x2="95" y2="90" stroke="black" stroke-width="1"/>
                                        <text id="analysis-graph-xlabel" x="50" y="98" text-anchor="middle" font-size="8"></text>
                                        <text id="analysis-graph-ylabel" x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)"></text>
                                        <g id="analysis-graph-base"></g>
                                        <g id="analysis-graph-segments"></g>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-analysis-btn" class="bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">&larr; السابق</button>
                                <span id="analysis-counter" class="text-sm font-bold text-gray-600"></span>
                                <div>
                                    <button id="next-analysis-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700">التالي &rarr;</button>
                                    <button id="reset-analysis-btn" class="hidden bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700">إعادة عرض الأمثلة</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ خامساً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // --- COMMON VARIABLES & SETUP ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    const LESSON_ID = 'c1_l1';
    let currentQuestions = []; // For the quiz

    // --- COMMON FUNCTIONS ---
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { explanationText.innerHTML = currentQuestions[questionIndex].explanation; modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }

    // --- SECTION: INTERACTIVE REPRESENTATIONS ---
    const interactiveSolution = {
        table: { 'interactive-s1': '5', 'interactive-p1': '-2', 'interactive-s2': '-1', 'interactive-p2': '-2' },
        points: ['user-point-1', 'user-point-2'],
        mapping: { '5': '-2', '-1': '-2' }
    };
    let selectedSource = null;
    const userArrows = {};

    function handleGraphClick(event) {
        const pointId = event.target.dataset.pointId;
        if (pointId) document.getElementById(pointId).style.opacity = '1';
    }

    function handleMappingClick(event) {
        const interactiveMappingSources = document.querySelectorAll('.mapping-source');
        const userArrowsContainer = document.getElementById('user-arrows-container');
        const element = event.target;
        if (element.classList.contains('mapping-source')) {
            interactiveMappingSources.forEach(src => src.classList.remove('selected'));
            element.classList.add('selected');
            selectedSource = element;
        } else if (element.classList.contains('mapping-target') && selectedSource) {
            const sourceValue = selectedSource.dataset.value;
            const targetValue = element.dataset.value;
            if (!userArrows[sourceValue]) {
                const sourceY = selectedSource.getAttribute('y');
                const targetY = element.getAttribute('y');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 65 ${sourceY} Q 50 ${(+sourceY + +targetY)/2} 35 ${targetY}`);
                path.setAttribute('stroke', '#ef4444');
                path.setAttribute('stroke-width', '0.5');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrow-interactive)');
                userArrowsContainer.appendChild(path);
                userArrows[sourceValue] = { target: targetValue, element: path };
            }
            selectedSource.classList.remove('selected');
            selectedSource = null;
        }
    }

    function checkInteractiveAnswers() {
        const interactiveFeedbackEl = document.getElementById('interactive-feedback');
        let correctCount = 0;
        const totalCount = Object.keys(interactiveSolution.table).length + interactiveSolution.points.length + Object.keys(interactiveSolution.mapping).length;
        Object.keys(interactiveSolution.table).forEach(id => {
            const input = document.getElementById(id);
            input.classList.remove('correct', 'incorrect');
            if (input.value === interactiveSolution.table[id]) {
                input.classList.add('correct');
                correctCount++;
            } else {
                input.classList.add('incorrect');
            }
        });
        interactiveSolution.points.forEach(pointId => {
            if (document.getElementById(pointId).style.opacity === '1') correctCount++;
        });
        Object.keys(interactiveSolution.mapping).forEach(sourceValue => {
            if (userArrows[sourceValue] && userArrows[sourceValue].target === interactiveSolution.mapping[sourceValue]) {
                userArrows[sourceValue].element.setAttribute('stroke', '#16a34a');
                correctCount++;
            } else if (userArrows[sourceValue]) {
                userArrows[sourceValue].element.setAttribute('stroke', '#dc2626');
            }
        });
        interactiveFeedbackEl.textContent = `أحسنت! لقد أجبت بشكل صحيح على ${correctCount} من أصل ${totalCount} جزءًا.`;
    }

    function showInteractiveSolution() {
        const interactiveMappingSources = document.querySelectorAll('.mapping-source');
        const interactiveMappingTargets = document.querySelectorAll('.mapping-target');
        const userArrowsContainer = document.getElementById('user-arrows-container');
        const interactiveFeedbackEl = document.getElementById('interactive-feedback');

        Object.keys(interactiveSolution.table).forEach(id => {
            const input = document.getElementById(id);
            input.value = interactiveSolution.table[id];
            input.classList.remove('incorrect');
            input.classList.add('correct');
        });
        interactiveSolution.points.forEach(pointId => {
            document.getElementById(pointId).style.opacity = '1';
        });
        userArrowsContainer.innerHTML = '';
        const sourceElements = Array.from(interactiveMappingSources).reduce((acc, el) => ({...acc, [el.dataset.value]: el }), {});
        const targetElements = Array.from(interactiveMappingTargets).reduce((acc, el) => ({...acc, [el.dataset.value]: el }), {});
        Object.keys(interactiveSolution.mapping).forEach(sourceValue => {
            const targetValue = interactiveSolution.mapping[sourceValue];
            const sourceEl = sourceElements[sourceValue];
            const targetEl = targetElements[targetValue];
            if(sourceEl && targetEl) {
                const sourceY = sourceEl.getAttribute('y');
                const targetY = targetEl.getAttribute('y');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 65 ${sourceY} Q 50 ${(+sourceY + +targetY)/2} 35 ${targetY}`);
                path.setAttribute('stroke', '#16a34a');
                path.setAttribute('stroke-width', '0.5');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrow-interactive)');
                userArrowsContainer.appendChild(path);
            }
        });
        interactiveFeedbackEl.textContent = 'هذه هي الإجابات الصحيحة الكاملة.';
    }

    // --- SECTION 2: INTERACTIVE VARIABLES ---
    const variablesExamples = [
        { scenario: 'في العلاقة التي تربط زيادة درجة الحرارة بزيادة ضغط الهواء داخل إطار السيارة...', independent: { text: 'درجة الحرارة', color: 'blue' }, dependent: { text: 'ضغط الهواء', color: 'green' }, explanation: 'لأن ضغط الهواء يعتمد على درجة الحرارة.' },
        { scenario: 'يعمل أحمد في محل تجاري ويتقاضى أجرًا على كل ساعة عمل...', independent: { text: 'عدد ساعات العمل', color: 'blue' }, dependent: { text: 'الأجر الإجمالي', color: 'green' }, explanation: 'لأن الأجر الإجمالي يعتمد على عدد الساعات التي عملها.' },
        { scenario: 'عندما تقود سيارتك لمدة ساعة، فإن المسافة التي تقطعها تعتمد على سرعتك...', independent: { text: 'سرعة السيارة', color: 'blue' }, dependent: { text: 'المسافة المقطوعة', color: 'green' }, explanation: 'لأن المسافة المقطوعة تعتمد على السرعة.' }
    ];
    let currentVarExampleIndex = 0;
    let currentVarStepIndex = 0;
    
    function renderVariableStep() {
        const varDisplay = document.getElementById('example-display');
        const varCounter = document.getElementById('example-counter');
        const varNextBtn = document.getElementById('next-example-btn');
        const varPrevBtn = document.getElementById('prev-example-btn');
        const varResetBtn = document.getElementById('reset-vars-btn');
        const example = variablesExamples[currentVarExampleIndex];
        let scenarioHTML = `<p class="text-xl mb-2">${example.scenario}</p>`;
        let independentHTML = (currentVarStepIndex >= 1) ? `<div class="mt-4 transition-opacity duration-500 opacity-100"><p>المتغير المستقل هو: <strong class="glow-${example.independent.color} font-bold">${example.independent.text}</strong></p></div>` : `<div class="mt-4 transition-opacity duration-500 opacity-0 min-h-[28px]"></div>`;
        let dependentHTML = (currentVarStepIndex >= 2) ? `<div class="mt-2 transition-opacity duration-500 opacity-100"><p>المتغير التابع هو: <strong class="glow-${example.dependent.color} font-bold">${example.dependent.text}</strong></p><p class="text-sm text-gray-500 mt-1">(${example.explanation})</p></div>` : `<div class="mt-2 transition-opacity duration-500 opacity-0 min-h-[44px]"></div>`;
        varDisplay.innerHTML = scenarioHTML + independentHTML + dependentHTML;
        varCounter.textContent = `مثال ${currentVarExampleIndex + 1} من ${variablesExamples.length} (الخطوة ${currentVarStepIndex + 1} من 3)`;
        varPrevBtn.disabled = (currentVarExampleIndex === 0 && currentVarStepIndex === 0);
        const isLastVarStep = (currentVarExampleIndex === variablesExamples.length - 1 && currentVarStepIndex === 2);
        varNextBtn.classList.toggle('hidden', isLastVarStep);
        varResetBtn.classList.toggle('hidden', !isLastVarStep);
    }

    function handleVarNext() {
        if (currentVarStepIndex < 2) {
            currentVarStepIndex++;
        } else if (currentVarExampleIndex < variablesExamples.length - 1) {
            currentVarExampleIndex++;
            currentVarStepIndex = 0;
        }
        renderVariableStep();
    }

    function handleVarPrev() {
        if (currentVarStepIndex > 0) {
            currentVarStepIndex--;
        } else if (currentVarExampleIndex > 0) {
            currentVarExampleIndex--;
            currentVarStepIndex = 2;
        }
        renderVariableStep();
    }

    function handleVarReset() {
        currentVarExampleIndex = 0;
        currentVarStepIndex = 0;
        renderVariableStep();
    }

    // --- SECTION 3: INTERACTIVE ANALYSIS ---
    const analysisExamples = [
        { title: "مثال ١: ركوب الدراجة", xlabel: "الزمن", ylabel: "المسافة", steps: [ { path: "M 10 90 L 40 50", color: "#16a34a", text: "تزداد المسافة بازدياد الزمن، مما يعني أن سعدًا كان يبتعد." }, { path: "M 40 50 L 70 50", color: "#3b82f6", text: "أصبح الخط أفقيًا، مما يعني أن الزمن يمر ولكن المسافة ثابتة، أي أن سعدًا قد توقف." }, { path: "M 70 50 L 100 20", color: "#16a34a", text: "ثم تابع ركوب الدراجة، فازدادت المسافة مرة أخرى مع ازدياد الزمن." } ] },
        { title: "مثال ٢: مستوى الماء في خزان", xlabel: "الزمن", ylabel: "مستوى الماء", steps: [ { path: "M 10 30 L 40 50", color: "#f97316", text: "يتناقص مستوى الماء بمعدل بطيء، مما يعني أن هناك تسريبًا بسيطًا." }, { path: "M 40 50 L 60 90", color: "#dc2626", text: "ثم زاد معدل التناقص بشكل حاد، مما يعني أن الصنبور فُتح لتفريغ الخزان بسرعة." }, { path: "M 60 90 L 100 60", color: "#16a34a", text: "أخيرًا، بدأ مستوى الماء في التزايد، مما يعني أنه بدأ ملء الخزان من جديد." } ] }
    ];
    let currentAnalysisExample = 0;
    let currentAnalysisStep = 0;

    function renderAnalysisStep() {
        const analysisTextContainer = document.getElementById('analysis-text-container');
        const analysisGraphBase = document.getElementById('analysis-graph-base');
        const analysisGraphSegments = document.getElementById('analysis-graph-segments');
        const analysisCounter = document.getElementById('analysis-counter');
        const analysisNextBtn = document.getElementById('next-analysis-btn');
        const analysisPrevBtn = document.getElementById('prev-analysis-btn');
        const analysisResetBtn = document.getElementById('reset-analysis-btn');
        const analysisXLabel = document.getElementById('analysis-graph-xlabel');
        const analysisYLabel = document.getElementById('analysis-graph-ylabel');

        const example = analysisExamples[currentAnalysisExample];
        analysisXLabel.textContent = example.xlabel;
        analysisYLabel.textContent = example.ylabel;
        analysisGraphBase.innerHTML = '';
        example.steps.forEach(step => {
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', step.path.replace('M ', '').replace(/ L /g, ' '));
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', '#d1d5db');
            polyline.setAttribute('stroke-width', '3');
            analysisGraphBase.appendChild(polyline);
        });
        analysisGraphSegments.innerHTML = '';
        for (let i = 0; i <= currentAnalysisStep; i++) {
            const step = example.steps[i];
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', step.path.replace('M ', '').replace(/ L /g, ' '));
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', step.color);
            polyline.setAttribute('stroke-width', '3');
            analysisGraphSegments.appendChild(polyline);
        }
        analysisTextContainer.innerHTML = `<h4 class="font-bold mb-2">${example.title}</h4>`;
        for (let i = 0; i <= currentAnalysisStep; i++) {
            const step = example.steps[i];
            const p = document.createElement('p');
            p.className = 'analysis-text-item mb-2';
            p.style.color = step.color;
            p.style.fontWeight = '600';
            p.textContent = step.text;
            analysisTextContainer.appendChild(p);
        }
        analysisCounter.textContent = `مثال ${currentAnalysisExample + 1} من ${analysisExamples.length} (الخطوة ${currentAnalysisStep + 1} من ${example.steps.length})`;
        analysisPrevBtn.disabled = currentAnalysisExample === 0 && currentAnalysisStep === 0;
        const isLastStep = currentAnalysisExample === analysisExamples.length - 1 && currentAnalysisStep === example.steps.length - 1;
        analysisNextBtn.classList.toggle('hidden', isLastStep);
        analysisResetBtn.classList.toggle('hidden', !isLastStep);
    }

    function handleAnalysisNext() {
        const example = analysisExamples[currentAnalysisExample];
        if (currentAnalysisStep < example.steps.length - 1) {
            currentAnalysisStep++;
        } else if (currentAnalysisExample < analysisExamples.length - 1) {
            currentAnalysisExample++;
            currentAnalysisStep = 0;
        }
        renderAnalysisStep();
    }

    function handleAnalysisPrev() {
        if (currentAnalysisStep > 0) {
            currentAnalysisStep--;
        } else if (currentAnalysisExample > 0) {
            currentAnalysisExample--;
            currentAnalysisStep = analysisExamples[currentAnalysisExample].steps.length - 1;
        }
        renderAnalysisStep();
    }

    function handleAnalysisReset() {
        currentAnalysisExample = 0;
        currentAnalysisStep = 0;
        renderAnalysisStep();
    }

    // --- SECTION 4: QUIZ ---
    function saveGrade(lessonId, grade, studentId) {
        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'جاري حفظ نتيجتك...';
        console.log(`Attempting to save grade for student ${studentId} on lesson ${lessonId}. Grade: ${grade}`);
        // In a real application, this would be an API call to SCRIPT_URL.
        // For this demonstration, we'll simulate a successful save.
        setTimeout(() => {
            statusEl.textContent = `تم حفظ نتيجتك بنجاح: ${grade} / 10`;
            statusEl.style.color = '#16a34a'; // Green color for success
        }, 1000);
    }
    
    function generateQuiz() { 
        const questionBank = [
            { type: 'mcq', level: '⭐', topic: 'domain-range', text: 'ما هو مجال العلاقة <span class="math-eq">{ (١، ٢)، (٣، ٤)، (١، ٥) }</span>؟', options: [ { display: '<span class="math-eq">{١، ٣}</span>', value: '{1, 3}' }, { display: '<span class="math-eq">{٢، ٤، ٥}</span>', value: '{2, 4, 5}' }, { display: '<span class="math-eq">{١، ٢، ٣، ٤، ٥}</span>', value: '{1, 2, 3, 4, 5}' }, { display: '<span class="math-eq">{١، ٣، ١}</span>', value: '{1, 3, 1}' } ], correct: '{1, 3}', explanation: `<p class='mb-2'>المجال هو مجموعة كل الإحداثيات السينية (الأولى) في الأزواج المرتبة، وبدون تكرار.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>الأزواج المرتبة: (<b>١</b>، ٢)، (<b>٣</b>، ٤)، (<b>١</b>، ٥)<br>المجال = {١، ٣}</p>` },
            { type: 'mcq', level: '⭐', topic: 'domain-range', text: 'ما هو مدى العلاقة <span class="math-eq">{ (٠، ٠)، (-١، ٢)، (١، ٢) }</span>؟', options: [ { display: '<span class="math-eq">{٠، -١، ١}</span>', value: '{0, -1, 1}' }, { display: '<span class="math-eq">{٠، ٢، ٢}</span>', value: '{0, 2, 2}' }, { display: '<span class="math-eq">{٠، ٢}</span>', value: '{0, 2}' }, { display: '<span class="math-eq">{٠}</span>', value: '{0}' } ], correct: '{0, 2}', explanation: `<p class='mb-2'>المدى هو مجموعة كل الإحداثيات الصادية (الثانية) في الأزواج المرتبة، وبدون تكرار.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>الأزواج المرتبة: (٠، <b>٠</b>)، (-١، <b>٢</b>)، (١، <b>٢</b>)<br>المدى = {٠، ٢}</p>` },
            { type: 'mcq', level: '⭐⭐', topic: 'variables', text: 'في العلاقة التي تربط عدد ساعات الدراسة (س) بالدرجة في الاختبار (ص)، أي متغير هو التابع؟', options: [ { display: 'عدد ساعات الدراسة', value: 's' }, { display: 'الدرجة في الاختبار', value: 'p' }, { display: 'كلاهما مستقل', value: 'both_ind' }, { display: 'لا يمكن التحديد', value: 'cannot' } ], correct: 'p', explanation: `<p class='mb-2'>الدرجة التي تحصل عليها في الاختبار <strong class="text-green-600">تعتمد</strong> على عدد ساعات دراستك. لذلك، الدرجة (ص) هي المتغير التابع.</p>` },
            { type: 'graph_mcq', level: '⭐⭐⭐', topic: 'analysis', text: 'يصف التمثيل البياني المجاور رحلة شخص ما. أي من التالي هو الوصف الصحيح للرحلة؟', graph: `<svg viewBox="0 0 100 100" class="w-48 h-48 bg-white border rounded-lg p-2"><polyline points="10,80 40,40 60,40 100,80" fill="none" stroke="#ef4444" stroke-width="3" /><text x="50" y="98" text-anchor="middle" font-size="8">الزمن</text><text x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)">المسافة من المنزل</text><line x1="10" y1="0" x2="10" y2="90" stroke="black" stroke-width="1"/><line x1="10" y1="90" x2="100" y2="90" stroke="black" stroke-width="1"/></svg>`, options: [ { display: 'سار الشخص مبتعداً عن المنزل، ثم توقف، ثم أكمل السير مبتعداً.', value: 'away-stop-away' }, { display: 'سار الشخص مبتعداً عن المنزل، ثم توقف لفترة، ثم عاد باتجاه المنزل.', value: 'away-stop-back' },{ display: 'كان الشخص عائداً للمنزل، ثم توقف، ثم أكمل العودة.', value: 'back-stop-back' },{ display: 'سار الشخص مبتعداً ثم عاد إلى المنزل مباشرة.', value: 'away-back' } ], correct: 'away-stop-back', explanation: `<p class='mb-2'>لنحلل الرسم البياني (المسافة من المنزل مقابل الزمن):</p><ul class='list-disc pr-4 space-y-1'><li><b>الجزء الأول (مائل للأعلى):</b> المسافة من المنزل تزداد مع مرور الزمن، مما يعني أن الشخص يسير مبتعدًا.</li><li><b>الجزء الثاني (أفقي):</b> يمر الزمن ولكن المسافة عن المنزل لا تتغير، مما يعني أن الشخص قد توقف.</li><li><b>الجزء الثالث (مائل للأسفل):</b> المسافة من المنزل تقل مع مرور الزمن، مما يعني أن الشخص يعود باتجاه المنزل.</li></ul><p class='mt-2 p-2 bg-green-100 rounded-md'>إذًا، الوصف الصحيح هو: سار مبتعدًا، توقف، ثم عاد.</p>` },
            { type: 'graph_mcq', level: '⭐⭐', topic: 'domain-range', text: 'من التمثيل البياني المجاور، ما هو <strong>مجال</strong> العلاقة؟', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-3" cy="-2" r="0.2" fill="#ef4444"/><circle cx="-1" cy="4" r="0.2" fill="#ef4444"/><circle cx="0" cy="-1" r="0.2" fill="#ef4444"/><circle cx="3" cy="-2" r="0.2" fill="#ef4444"/></svg>`, options: [ { display: '<span class="math-eq">{-٣, -١, ٠, ٣}</span>', value: '{-3, -1, 0, 3}' }, { display: '<span class="math-eq">{-٢, -١, ٤}</span>', value: '{-2, -1, 4}' }, { display: '<span class="math-eq">{-٤, -٣, -١, ٠, ١, ٢, ٣}</span>', value: '{-4, -3, -1, 0, 1, 2, 3}' }, { display: '<span class="math-eq">{٢, -٤, ١, ٢}</span>', value: '{2, -4, 1, 2}' } ], correct: '{-3, -1, 0, 3}', explanation: `<p class='mb-2'>المجال هو مجموعة قيم <b>س</b> لجميع النقاط. بالنظر إلى الرسم، النقاط هي (-٣, -٢)، (-١, ٤)، (٠, -١)، (٣, -٢). الإحداثيات السينية هي -٣، -١، ٠، ٣.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>المجال = {-٣, -١, ٠, ٣}</p>` },
            { type: 'graph_mcq', level: '⭐⭐', topic: 'domain-range', text: 'من التمثيل البياني المجاور، ما هو <strong>مدى</strong> العلاقة؟', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-4" cy="-2" r="0.2" fill="#3b82f6"/><circle cx="-2" cy="3" r="0.2" fill="#3b82f6"/><circle cx="1" cy="-2" r="0.2" fill="#3b82f6"/><circle cx="4" cy="1" r="0.2" fill="#3b82f6"/></svg>`, options: [ { display: '<span class="math-eq">{-٣, -١, ٢}</span>', value: '{-3, -1, 2}' }, { display: '<span class="math-eq">{-٤, -٢, ١, ٤}</span>', value: '{-4, -2, 1, 4}' }, { display: '<span class="math-eq">{٢, -٣, ٢, -١}</span>', value: '{2, -3, 2, -1}' }, { display: '<span class="math-eq">{-٢, ١, ٣}</span>', value: '{-2, 1, 3}' } ], correct: '{-3, -1, 2}', explanation: `<p class='mb-2'>المدى هو مجموعة قيم <b>ص</b> لجميع النقاط، بدون تكرار. بالنظر إلى الرسم، النقاط هي (-٤, ٢)، (-٢, -٣)، (١, ٢)، (٤, -١). الإحداثيات الصادية هي ٢، -٣، ٢، -١.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>المدى (مرتباً وبدون تكرار) = {-٣, -١, ٢}</p>` },
            { type: 'mcq', level: '⭐', topic: 'domain-range', text: 'ما هو مدى العلاقة <span class="math-eq">{ (٥، -١)، (٠، -١)، (٢، ٤) }</span>؟', options: [ { display: '<span class="math-eq">{٥, ٠, ٢}</span>', value: '{5, 0, 2}' }, { display: '<span class="math-eq">{-١, ٤}</span>', value: '{-1, 4}' }, { display: '<span class="math-eq">{-١, -١, ٤}</span>', value: '{-1, -1, 4}' }, { display: '<span class="math-eq">{٥, -١, ٠, ٢, ٤}</span>', value: '{5, -1, 0, 2, 4}' } ], correct: '{-1, 4}', explanation: `<p class='mb-2'>المدى هو مجموعة كل الإحداثيات الصادية (الثانية) في الأزواج المرتبة، وبدون تكرار.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>الأزواج المرتبة: (٥، <b>-١</b>)، (٠، <b>-١</b>)، (٢، <b>٤</b>)<br>المدى = {-١, ٤}</p>` },
            { type: 'mcq', level: '⭐⭐', topic: 'variables', text: 'تكلفة تعبئة الوقود تعتمد على عدد اللترات التي تشتريها. أي متغير هو المستقل؟', options: [ { display: 'تكلفة الوقود', value: 'cost' }, { display: 'عدد اللترات', value: 'liters' }, { display: 'كلاهما تابع', value: 'both_dep' }, { display: 'نوع السيارة', value: 'car_type' } ], correct: 'liters', explanation: `<p class='mb-2'>التكلفة الإجمالية <strong class="text-green-600">تعتمد</strong> على عدد اللترات. أنت تختار عدد اللترات أولاً (المتغير المستقل)، وبناءً عليه تُحسب التكلفة (المتغير التابع).</p>` },
            { type: 'mcq', level: '⭐⭐', topic: 'variables', text: 'عند شراء التفاح من المتجر، تعتمد التكلفة الإجمالية على عدد كيلوغرامات التفاح التي تشتريها. أي متغير هو المتغير المستقل؟', options: [ { display: 'التكلفة الإجمالية', value: 'cost' }, { display: 'عدد الكيلوغرامات', value: 'kg' }, { display: 'نوع التفاح', value: 'type' }, { display: 'اسم المتجر', value: 'store' } ], correct: 'kg', explanation: `<p class='mb-2'>التكلفة الإجمالية <strong class="text-green-600">تعتمد</strong> على الكمية التي تشتريها. أنت تختار عدد الكيلوغرامات (المستقل) أولاً، وبناءً عليه تُحسب التكلفة (التابع).</p>` },
            { type: 'mcq', level: '⭐', topic: 'domain-range', text: 'ما هو مجال العلاقة <span class="math-eq">{ (-٢, ٠), (٣, ١), (٤, ٠) }</span>؟', options: [ { display: '<span class="math-eq">{٠, ١}</span>', value: '{0,1}' }, { display: '<span class="math-eq">{-٢, ٣, ٤}</span>', value: '{-2,3,4}' }, { display: '<span class="math-eq">{٠, ١, ٠}</span>', value: '{0,1,0}' }, { display: '<span class="math-eq">{-٢, ٠, ١, ٣, ٤}</span>', value: '{-2,0,1,3,4}' } ], correct: '{-2,3,4}', explanation: `<p class='mb-2'>المجال هو مجموعة كل الإحداثيات السينية (الأولى) في الأزواج المرتبة.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>الأزواج المرتبة: (<b>-٢</b>, ٠), (<b>٣</b>, ١), (<b>٤</b>, ٠)<br>المجال = {-٢, ٣, ٤}</p>` },
            { type: 'graph_mcq', level: '⭐⭐', topic: 'domain-range', text: 'من التمثيل البياني المجاور، ما هو <strong>مدى</strong> العلاقة؟', graph: `<svg viewBox="-5 -5 10 10" class="w-48 h-48 bg-white border rounded-lg"><g stroke="#e2e8f0" stroke-width="0.05"><path d="M -4 4 V -4 M -3 4 V -4 M -2 4 V -4 M -1 4 V -4 M 1 4 V -4 M 2 4 V -4 M 3 4 V -4 M 4 4 V -4" /><path d="M -4 4 H 4 M -4 3 H 4 M -4 2 H 4 M -4 1 H 4 M -4 -1 H 4 M -4 -2 H 4 M -4 -3 H 4 M -4 -4 H 4" /></g><line x1="-4.5" y1="0" x2="4.5" y2="0" stroke="#a0aec0" stroke-width="0.1"/><line x1="0" y1="-4.5" x2="0" y2="4.5" stroke="#a0aec0" stroke-width="0.1"/><circle cx="-3" cy="3" r="0.2" fill="#c026d3"/><circle cx="1" cy="1" r="0.2" fill="#c026d3"/><circle cx="4" cy="-2" r="0.2" fill="#c026d3"/></svg>`, options: [ { display: '<span class="math-eq">{-٣, -١, ٢}</span>', value: '{-3, -1, 2}' }, { display: '<span class="math-eq">{-٢, ١, ٣}</span>', value: '{-2, 1, 3}' }, { display: '<span class="math-eq">{-٣, ١, ٤}</span>', value: '{-3, 1, 4}' }, { display: '<span class="math-eq">{-٣, ١}</span>', value: '{-3, 1}' } ], correct: '{-3, -1, 2}', explanation: `<p class='mb-2'>المدى هو مجموعة قيم <b>ص</b> لجميع النقاط، بدون تكرار. بالنظر إلى الرسم، النقاط هي (-٣, -٣)، (١, -١)، (٤, ٢). الإحداثيات الصادية هي -٣، -١، ٢.</p><p class='mt-2 p-2 bg-green-100 rounded-md'>المدى (مرتباً) = {-٣, -١, ٢}</p>` },
            { type: 'graph_mcq', level: '⭐⭐⭐', topic: 'analysis', text: 'يمثل الرسم البياني المجاور مستوى الماء في خزان أثناء ملئه. أي وصف هو الصحيح؟', graph: `<svg viewBox="0 0 100 100" class="w-48 h-48 bg-white border rounded-lg p-2"><polyline points="10,90 40,60 60,60 90,10" fill="none" stroke="#0891b2" stroke-width="3" /><text x="50" y="98" text-anchor="middle" font-size="8">الزمن</text><text x="5" y="50" text-anchor="middle" font-size="8" transform="rotate(-90 5 50)">مستوى الماء</text><line x1="10" y1="0" x2="10" y2="90" stroke="black" stroke-width="1"/><line x1="10" y1="90" x2="100" y2="90" stroke="black" stroke-width="1"/></svg>`, options: [ { display: 'بدأ الملء ثم توقف ثم استمر بنفس المعدل.', value: 'fill-stop-fill' }, { display: 'بدأ الملء بسرعة، ثم أبطأ، ثم توقف.', value: 'fast-slow-stop' }, { display: 'بدأ الملء بمعدل ثابت، ثم توقف لفترة، ثم استمر بمعدل أسرع.', value: 'fill-stop-faster' }, { display: 'كان الخزان يفرغ ثم امتلأ.', value: 'empty-fill' } ], correct: 'fill-stop-faster', explanation: `<p class='mb-2'>لنحلل الرسم البياني:</p><ul class='list-disc pr-4 space-y-1'><li><b>الجزء الأول (مائل للأعلى):</b> مستوى الماء يرتفع بمعدل ثابت.</li><li><b>الجزء الثاني (أفقي):</b> يمر الزمن ومستوى الماء لا يتغير، مما يعني أن الملء توقف.</li><li><b>الجزء الثالث (أكثر انحدارًا):</b> مستوى الماء يرتفع مرة أخرى ولكن بشكل أسرع من المرة الأولى.</li></ul><p class='mt-2 p-2 bg-green-100 rounded-md'>إذًا، الوصف الصحيح هو: بدأ الملء، ثم توقف، ثم استمر بمعدل أسرع.</p>` }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random()); 
        const questionCount = Math.min(shuffled.length, 5); 
        return shuffled.slice(0, questionCount); 
    }
    
    function initializeQuiz(lessonId, questions, studentData) {
        currentQuestions = questions;
        const quizForm = document.getElementById('quizForm');
        if (!quizForm) return;
        if (questions.length === 0) {
            quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`;
            return;
        }
        let attemptsLeft;
        if (studentData) {
            const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 };
            attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts;
        } else {
            attemptsLeft = 1;
        }
        const attemptsCounter = document.getElementById('attempts-counter');
        if (attemptsCounter) {
            attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`;
        }
        const quizHtml = questions.map((q, index) => {
            const optionsHTML = q.options.map((opt, optIndex) => {
                // **MODIFICATION**: Removed the graph from the option content for graph_mcq type.
                let content = opt.display;
                return `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${content}</label></div>`;
            }).join('');
            
            const questionText = q.type === 'graph_mcq' ? `<div class="flex flex-col md:flex-row items-center gap-4"><div class="flex-1"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p></div><div class="flex-shrink-0">${q.graph}</div></div>` : `<p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p>`;

            return `<div class="p-4 border-2 border-gray-200 rounded-lg">${questionText}<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div>`;
        }).join('');

        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`;
        
        questions.forEach((q, index) => {
            const explainBtn = document.getElementById(`explain-btn-${index}`);
            if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index));
        });
        if (attemptsLeft <= 0) {
            const submitBtn = quizForm.querySelector('#submit-quiz-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'لا توجد محاولات متبقية';
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400');
        }
        quizForm.onsubmit = (e) => {
            e.preventDefault();
            let score = 0;
            questions.forEach((q, index) => {
                const userAnswer = e.target.elements[`q${index}`]?.value;
                const feedbackEl = document.getElementById(`feedback-q${index}`);
                if (userAnswer === q.correct) {
                    score++;
                    feedbackEl.textContent = '✔ إجابة صحيحة!';
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600';
                } else {
                    feedbackEl.textContent = `❌ إجابة خاطئة.`;
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600';
                }
                document.getElementById(`explain-btn-${index}`).classList.remove('hidden');
            });
            const finalGrade = Math.round((score / questions.length) * 10);
            const resultsDiv = document.getElementById('quiz-results');
            resultsDiv.classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`;
            if (studentData) {
                saveGrade(lessonId, finalGrade, studentData.id);
                if (attemptsLeft - 1 > 0) {
                    document.getElementById('retake-quiz-btn').classList.remove('hidden');
                }
            } else {
                document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.';
            }
            e.target.querySelector('#submit-quiz-btn').disabled = true;
        };
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();

        // Attach listeners for interactive representations
        const interactiveCheckBtn = document.getElementById('check-interactive-btn');
        const interactiveSolutionBtn = document.getElementById('show-solution-btn');
        const interactiveGraph = document.getElementById('interactive-graph');
        const interactiveMapping = document.getElementById('interactive-mapping');

        if (interactiveCheckBtn) interactiveCheckBtn.addEventListener('click', checkInteractiveAnswers);
        if (interactiveSolutionBtn) interactiveSolutionBtn.addEventListener('click', showInteractiveSolution);
        if (interactiveGraph) interactiveGraph.addEventListener('click', handleGraphClick);
        if (interactiveMapping) interactiveMapping.addEventListener('click', handleMappingClick);

        // Attach listeners for interactive variables
        const varNextBtn = document.getElementById('next-example-btn');
        const varPrevBtn = document.getElementById('prev-example-btn');
        const varResetBtn = document.getElementById('reset-vars-btn');
        if(varNextBtn) varNextBtn.addEventListener('click', handleVarNext);
        if(varPrevBtn) varPrevBtn.addEventListener('click', handleVarPrev);
        if(varResetBtn) varResetBtn.addEventListener('click', handleVarReset);

        // Attach listeners for interactive analysis
        const analysisNextBtn = document.getElementById('next-analysis-btn');
        const analysisPrevBtn = document.getElementById('prev-analysis-btn');
        const analysisResetBtn = document.getElementById('reset-analysis-btn');
        if(analysisNextBtn) analysisNextBtn.addEventListener('click', handleAnalysisNext);
        if(analysisPrevBtn) analysisPrevBtn.addEventListener('click', handleAnalysisPrev);
        if(analysisResetBtn) analysisResetBtn.addEventListener('click', handleAnalysisReset);

        // Attach listeners for quiz
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
        
        // --- INITIALIZE DYNAMIC SECTIONS ---
        renderVariableStep();
        renderAnalysisStep();
    });
    </script>
</body>
</html>

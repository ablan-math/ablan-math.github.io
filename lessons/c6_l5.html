<!-- 
    ğŸ›‘ğŸ›‘ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¸ÙˆØ±Ø© Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (STRICT PROTOCOL) ğŸ›‘ğŸ›‘
    =========================================================================
    Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨ (Master Template V2):

    1. Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù…Ù‚Ø¯Ø³Ø© (Do Not Touch):
       - Ù…Ù…Ù†ÙˆØ¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (fetchStudentData, saveScoreToBackend).
       - Ù…Ù…Ù†ÙˆØ¹ ØªØ¹Ø¯ÙŠÙ„ "Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‡ÙˆÙŠØ©" (Theme Engine) Ø£Ùˆ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (CHAPTER_THEMES).
       - Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ± Ù…Ù†Ø·Ù‚ "Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨" (renderDynamicGames).
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ù…Ù†Ø·Ù‚ "Ø²Ø± Ø§Ù„ØªØ­Ù‚Ù‚" (Quiz Button Logic): ØªØ­ÙˆÙ„Ù‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† (ØªØ­Ù‚Ù‚) -> (Ø¥Ø¹Ø§Ø¯Ø©) -> (Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª).
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ Ø­Ø°Ù Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ "Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ Ùˆ Ø§Ù„Ø³ÙÙ„ÙŠ" (Bottom Timer) Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.
       - âš ï¸ Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ± Ù‡ÙŠÙƒÙ„ÙŠØ© "Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø«Ù„Ø§Ø«Ø©" (Ù„Ù…Ø§Ø°Ø§ØŸ - Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³) Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.

    2. Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… (Concept Flexibility):
       - Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙŠØ­ØªÙˆÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù„Ù‰ 4 Ù…ÙØ§Ù‡ÙŠÙ… (Tabs).
    =========================================================================
-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- [THEME DICTIONARY] -->
    <script>
        const LESSON_KEY = 'c6_l5'; 
        function convertToArabic(n) { return n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }

        const CHAPTER_THEMES = {
            '6': { name: 'ÙƒØ«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø¯ÙˆØ¯', gradient: 'from-blue-600 to-blue-800', baseColor: 'blue', hex: '#2563eb', icon: 'fa-graduation-cap' },
            '7': { name: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠØ©', gradient: 'from-purple-600 to-purple-800', baseColor: 'purple', hex: '#9333ea', icon: 'fa-puzzle-piece' },
            'default': { gradient: 'from-gray-700 to-gray-900', baseColor: 'gray', hex: '#374151', icon: 'fa-book' }
        };

        function getTheme() {
            const match = LESSON_KEY.match(/c(\d+)/);
            const chNum = match ? match[1] : 'default';
            const theme = CHAPTER_THEMES[chNum] || CHAPTER_THEMES['default'];
            theme.chNum = chNum === 'default' ? '#' : chNum;
            return theme;
        }
        const currentTheme = getTheme();
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .hidden { display: none !important; }
        .tab-content { padding-bottom: 20px; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        :root { --theme-hex: #374151; }

        .math-eq { font-family: 'Cairo', sans-serif; font-weight: 700; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2px 8px; border-radius: 4px; display: inline-block; direction: rtl; unicode-bidi: embed; vertical-align: middle; line-height: 1.8; }
        .num-red { color: #dc2626; } .var-green { color: #16a34a; } .var-blue { color: #2563eb; } .op-purple { color: #9333ea; font-weight: 800; } 
        .tiny-sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.6em; margin-right: 1px; line-height: 0; font-family: 'Cairo', sans-serif; }
        
        .btn-theme { background-color: var(--theme-hex); color: white; transition: all 0.3s ease; }
        .btn-theme:hover { filter: brightness(0.85); transform: translateY(-1px); }

        .step-box { border-right: 3px solid var(--theme-hex); background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px 0; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 0.6rem; width: 100%; cursor: pointer; transition: all 0.3s; padding: 4px 2px; position: relative; }
        .nav-item.active { color: var(--theme-hex); font-weight: 800; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0px; width: 20px; height: 3px; background: var(--theme-hex); border-radius: 4px 4px 0 0; }
        
        .step-interactive { display: none; opacity: 0; transition: opacity 0.3s; } .step-interactive.active { display: block; opacity: 1; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .option-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; height: 100%; min-height: 50px; background: white; text-align: center; }
        input[type="radio"]:checked + .option-label { border-color: var(--theme-hex); background-color: #eff6ff; color: var(--theme-hex); font-weight: bold; }

        .result-card-trophy { background-color: #fffbeb !important; border-color: #fcd34d !important; border-width: 2px !important; } 
        .result-card-star { background-color: #fff7ed !important; border-color: #fdba74 !important; border-width: 2px !important; } 
        .result-card-retry { background-color: #fef2f2 !important; border-color: #fca5a5 !important; border-width: 2px !important; } 

        #game-modal-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #game-modal-content { background: white; width: 90%; height: 85%; max-width: 1200px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; transition: all 0.3s ease; }
        #game-modal-header { padding: 4px 10px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 32px; }
        #game-frame { flex-grow: 1; width: 100%; height: 100%; border: none; background: #f3f4f6; }
        .win-btn { padding: 2px 8px; border-radius: 4px; transition: background 0.2s; color: rgba(255,255,255,0.9); font-size: 0.85rem; display: flex; align-items: center; justify-content: center; }
        .win-btn:hover { background-color: rgba(255,255,255,0.2); color: white; }
        .win-btn-close:hover { background-color: #ef4444; }
        #minimized-game-bar { display: none; position: fixed; bottom: 80px; left: 20px; background: white; border: 2px solid; border-radius: 50px; padding: 8px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9998; cursor: pointer; align-items: center; gap: 10px; font-weight: bold; transition: transform 0.2s; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--theme-hex); width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lesson-footer { text-align: center; margin-top: 40px; margin-bottom: 100px; padding-top: 20px; border-top: 1px dashed #e5e7eb; color: #9ca3af; font-size: 0.75rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <script>
        (function() {
            const root = document.documentElement;
            root.style.setProperty('--theme-hex', currentTheme.hex);
        })();
    </script>

    <!-- HEADER (Sacred UI Restored) -->
    <header id="main-header" class="w-full text-white shadow-lg px-4 py-3 sticky top-0 z-50 transition-colors overflow-hidden relative">
        <script>document.getElementById('main-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <i id="bg-giant-icon" class="fas absolute -left-6 -bottom-8 text-8xl md:text-9xl text-white opacity-10 transform -rotate-12"></i>
            <script>document.getElementById('bg-giant-icon').classList.add(currentTheme.icon);</script>
            <span class="absolute top-[-10px] right-10 text-9xl font-black text-white opacity-5 font-sans leading-none select-none">
                <script>document.write(currentTheme.chNum)</script>
            </span>
            <i class="fas fa-plus absolute top-4 left-[20%] text-xl text-white opacity-10 transform rotate-12"></i>
            <i class="fas fa-minus absolute bottom-4 right-[30%] text-2xl text-white opacity-10 transform -rotate-6"></i>
            <i class="fas fa-times absolute top-8 right-12 text-lg text-white opacity-10"></i>
            <i class="fas fa-divide absolute bottom-6 left-8 text-xl text-white opacity-10 transform rotate-45"></i>
        </div>
        <div class="container mx-auto max-w-4xl flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-14 md:h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center border border-white/20 shadow-md">
                    <i id="header-icon" class="fas text-lg md:text-2xl"></i>
                    <script>document.getElementById('header-icon').classList.add(currentTheme.icon);</script>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] md:text-xs font-bold opacity-80">Ù…Ù†ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
                    <h1 class="text-base md:text-xl font-black flex items-center gap-2">
                        <span class="bg-white/20 px-2 rounded text-sm md:text-base font-sans pt-1">
                            <script>document.write(convertToArabic('6-5'));</script>
                        </span>
                        <span id="lesson-title-text">Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</span>
                        <span id="header-score-badge" class="hidden flex items-center gap-1 bg-yellow-400/20 text-yellow-100 px-2 py-0.5 rounded-full text-xs border border-yellow-400/30 animate-pulse">
                            <i class="fas fa-star text-[10px]"></i> <span id="student-score">0</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
                <div class="bg-black/10 px-3 py-0.5 rounded-lg border border-white/10 flex items-center gap-2 text-[10px] md:text-sm font-bold">
                    <i class="fas fa-user"></i> <span id="student-name">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ</span>
                </div>
                <a href="https://ablan-math.github.io/term2.html" class="bg-white text-blue-700 hover:bg-red-50 hover:text-red-600 px-3 py-1 rounded-lg font-bold text-xs md:text-sm shadow-sm transition flex items-center gap-1 cursor-pointer no-underline">
                    <i class="fas fa-arrow-right"></i> <span>Ø±Ø¬ÙˆØ¹</span>
                </a>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto max-w-4xl p-4 md:p-8 mb-4 transition-all duration-300">
        
        <!-- [TAB 1: Multiplication] -->
        <div id="tab-learn1" class="tab-content">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-lg bg-blue-100 text-blue-700 border border-blue-200">Ù¡</span>
                <h2 class="font-bold text-xl md:text-2xl text-gray-800">Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯ ÙÙŠ ÙƒØ«ÙŠØ±Ø© Ø­Ø¯ÙˆØ¯</h2>
            </div>
            
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border-r-4 border-blue-500 relative overflow-hidden group hover:shadow-md transition">
                <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-lightbulb ml-2"></i>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹:</h4>
                <p class="text-gray-600 text-sm md:text-lg mb-3">Ù†Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø© Ø§Ù„Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø­Ø¯ Ù…Ù† Ø­Ø¯ÙˆØ¯ ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ØŒ Ù…Ø¹ **Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³** Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©.</p>
                <div class="text-center py-3 bg-blue-50 rounded-lg text-blue-900 border border-blue-100 shadow-inner">
                    <span class="math-eq text-xl"><span class="num-red">Ø£</span> ( <span class="var-green">Ø¨</span> + <span class="var-blue">Ø¬Ù€</span> ) = <span class="num-red">Ø£Ø¨</span> + <span class="num-red">Ø£Ø¬Ù€</span></span>
                </div>
            </div>
            
            <!-- Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
            <div id="interactive-container-1-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6">
                <h3 class="font-bold text-blue-800 mb-4">Ù…Ø«Ø§Ù„ Ù¡: ØªÙˆØ²ÙŠØ¹ ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯ Ù…ÙˆØ¬Ø¨Ø©</h3>
                <div class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 mb-4 text-center">
                    <span class="math-eq text-xl"><span class="num-red">Ù£Ø³</span> ( <span class="var-green">Ù¢Ø³</span> + <span class="var-blue">Ù¥</span> )</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¶Ø±Ø¨ Ø§Ù„ØµØ±ÙŠØ­</h4><p class="text-center"><span class="math-eq">(<span class="num-red">Ù£Ø³</span> Ã— <span class="var-green">Ù¢Ø³</span>) + (<span class="num-red">Ù£Ø³</span> Ã— <span class="var-blue">Ù¥</span>)</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù¦Ø³<span class="tiny-sup">Ù¢</span> + Ù¡Ù¥Ø³</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div id="interactive-container-1-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-6">
                <h3 class="font-bold text-blue-800 mb-4">Ù…Ø«Ø§Ù„ Ù¢: Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ù„Ø¨Ø©</h3>
                <div class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 mb-4 text-center">
                    <span class="math-eq text-xl"><span class="num-red">-Ù¢Ø£</span> ( <span class="var-green">Ù¤Ø£</span> - <span class="var-blue">Ù£</span> )</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø§Ù†ØªØ¨Ù‡ Ù„Ø¶Ø±Ø¨ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª</h4><p class="text-center"><span class="math-eq">(-Ù¢Ø£ Ã— Ù¤Ø£) - (-Ù¢Ø£ Ã— Ù£)</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">-Ù¨Ø£<span class="tiny-sup">Ù¢</span> + Ù¦Ø£</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div id="interactive-container-1-3" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-blue-50 mb-4">
                <h3 class="font-bold text-blue-800 mb-4">Ù…Ø«Ø§Ù„ Ù£: Ø¶Ø±Ø¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³</h3>
                <div class="bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300 mb-4 text-center">
                    <span class="math-eq text-xl"><span class="num-red">Ø³<span class="tiny-sup">Ù¢</span></span> ( <span class="var-green">Ù£Ø³</span> + <span class="var-blue">Ù¡</span> )</span>
                </div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: ØªØ°ÙƒØ± Ø£Ù† Ø³ Ù‡ÙŠ Ø³Â¹</h4><p class="text-center"><span class="math-eq">(Ø³<span class="tiny-sup">Ù¢</span> Ã— Ù£Ø³<span class="tiny-sup">Ù¡</span>) + (Ø³<span class="tiny-sup">Ù¢</span> Ã— Ù¡)</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù£Ø³<span class="tiny-sup">Ù£</span> + Ø³<span class="tiny-sup">Ù¢</span></span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-1.5 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <button onclick="switchTab('learn2')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>Ø§Ù„ØªØ§Ù„ÙŠ: ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 2: Simplifying] -->
        <div id="tab-learn2" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 rounded-full flex items-center justify-center font-bold bg-purple-100 text-purple-700">Ù¢</span>
                <h2 class="font-bold text-xl text-gray-800">ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¨Ø±ÙŠØ©</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border-r-4 border-purple-500">
                <h4 class="font-bold text-purple-800 mb-1">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ¨Ø³ÙŠØ·:</h4>
                <p class="text-gray-700 leading-relaxed text-sm md:text-base">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¶Ø±Ø¨ Ù„Ù„ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… **Ø¯Ù…Ø¬ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©** (Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ù…ØªØºÙŠØ± ÙˆØ§Ù„Ø£Ø³ Ù†ÙØ³Ù‡).</p>
            </div>
            
            <div id="interactive-container-2-1" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-6">
                <h3 class="font-bold text-purple-800 mb-4">Ù…Ø«Ø§Ù„ Ù¡: Ø¯Ù…Ø¬ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center"><span class="math-eq text-lg">Ù£(Ø³ + Ù¤) + Ù¢(Ø³ - Ù¡)</span></div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: ÙÙƒ Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹</h4><p class="text-center"><span class="math-eq"><span class="var-green">Ù£Ø³</span> + <span class="var-blue">Ù¡Ù¢</span> + <span class="var-green">Ù¢Ø³</span> - <span class="var-blue">Ù¢</span></span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø¯Ù…Ø¬ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</h4><p class="text-lg font-bold text-center"><span class="math-eq"><span class="var-green">Ù¥Ø³</span> + <span class="var-blue">Ù¡Ù </span></span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div id="interactive-container-2-2" class="bg-white rounded-xl p-4 md:p-6 shadow-sm border-2 border-purple-50 mb-4">
                <h3 class="font-bold text-purple-800 mb-4">Ù…Ø«Ø§Ù„ Ù¢: Ø·Ø±Ø­ ÙˆØ­ÙŠØ¯Ø§Øª Ø­Ø¯ Ù…ØªØ´Ø§Ø¨Ù‡Ø©</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center"><span class="math-eq text-lg">Ø³(Ø³ + Ù£) - Ø³<span class="tiny-sup">Ù¢</span></span></div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„ØªÙˆØ²ÙŠØ¹</h4><p class="text-center"><span class="math-eq">Ø³<span class="tiny-sup">Ù¢</span> + Ù£Ø³ - Ø³<span class="tiny-sup">Ù¢</span></span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù£Ø³</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <button onclick="switchTab('learn3')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 3: Equations] -->
        <div id="tab-learn3" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 rounded-full flex items-center justify-center font-bold bg-emerald-100 text-emerald-700">Ù£</span>
                <h2 class="font-bold text-xl text-gray-800">Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø¬Ø¨Ø±ÙŠØ©</h2>
            </div>
            <div class="bg-white rounded-xl p-5 md:p-8 shadow-sm mb-6 border-r-4 border-emerald-500">
                <h4 class="font-bold text-emerald-800">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ù„:</h4>
                <p class="text-gray-600">Ø¨Ø³Ø· ÙƒÙ„ Ø·Ø±Ù Ù…Ù† Ø·Ø±ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©ØŒ Ø«Ù… Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø¬Ø§Ù‡ÙŠÙ„ ÙÙŠ Ø·Ø±Ù ÙˆØ§Ù„Ø£Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø·Ø±Ù Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØºÙŠØ±.</p>
            </div>
            <div id="interactive-container-3-1" class="bg-white rounded-xl p-4 md:p-6 border-2 border-emerald-50 mb-6">
                <h3 class="font-bold text-emerald-800 mb-4">Ù…Ø«Ø§Ù„ Ù¡: ØªÙˆØ²ÙŠØ¹ Ø·Ø±ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center"><span class="math-eq text-lg">Ù£(Ø³ - Ù¢) = Ù¢(Ø³ + Ù¤)</span></div>
                <div class="min-h-[200px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„ÙÙƒ Ø§Ù„ØµØ±ÙŠØ­</h4><p class="text-center"><span class="math-eq">Ù£Ø³ - Ù¦ = Ù¢Ø³ + Ù¨</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù£Ø³ - Ù¢Ø³ = Ù¨ + Ù¦  â†  Ø³ = Ù¡Ù¤</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
            
            <div id="interactive-container-3-2" class="bg-white rounded-xl p-4 md:p-6 border-2 border-emerald-50 mb-4">
                <h3 class="font-bold text-emerald-800 mb-4">Ù…Ø«Ø§Ù„ Ù¢: Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ±Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø­Ø°ÙˆÙ</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center"><span class="math-eq text-lg">Ø³(Ø³ + Ù¢) = Ø³<span class="tiny-sup">Ù¢</span> + Ù¦</span></div>
                <div class="min-h-[110px] mb-4">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: ØªÙˆØ²ÙŠØ¹ Ø³</h4><p class="text-center"><span class="math-eq">Ø³<span class="tiny-sup">Ù¢</span> + Ù¢Ø³ = Ø³<span class="tiny-sup">Ù¢</span> + Ù¦</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø­Ø°Ù Ø³Â²</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù¢Ø³ = Ù¦  â†  Ø³ = Ù£</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <button onclick="switchTab('learn4')" class="btn-theme w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 mt-4"><span>ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø­ÙŠØ§ØªÙŠØ©</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [TAB 4: Applications] -->
        <div id="tab-learn4" class="tab-content hidden">
            <div class="flex items-center gap-2 mb-4">
                <span class="w-8 h-8 rounded-full flex items-center justify-center font-bold bg-amber-100 text-amber-700">Ù¤</span>
                <h2 class="font-bold text-xl text-gray-800">ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù† ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©</h2>
            </div>
            <div id="interactive-container-4-1" class="bg-white rounded-xl p-4 md:p-6 border-2 border-amber-50 mb-6">
                <h3 class="font-bold text-amber-800 mb-4">ØªØ·Ø¨ÙŠÙ‚ Ù¡: Ù…Ø³Ø§Ø­Ø© Ø­Ø¯ÙŠÙ‚Ø© Ù…Ø³ØªØ·ÙŠÙ„Ø©</h3>
                <div class="bg-amber-50 p-5 rounded-lg mb-4 text-gray-700 border-r-4 border-amber-300">
                    Ø£ÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø© Ù…Ø³ØªØ·ÙŠÙ„ Ø¹Ø±Ø¶Ù‡ <span class="math-eq">Ù£Ø³</span> ÙˆØ·ÙˆÙ„Ù‡ <span class="math-eq">Ø³ + Ù¤</span>.
                </div>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-2">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† (Ø§Ù„Ø·ÙˆÙ„ Ã— Ø§Ù„Ø¹Ø±Ø¶)</h4><p class="text-center font-bold"><span class="math-eq">Ù… = Ù£Ø³ Ã— ( Ø³ + Ù¤ )</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù… = Ù£Ø³<span class="tiny-sup">Ù¢</span> + Ù¡Ù¢Ø³</span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù„</button>
            </div>

            <div id="interactive-container-4-2" class="bg-white rounded-xl p-4 md:p-6 border-2 border-amber-50 mb-4">
                <h3 class="font-bold text-amber-800 mb-4">ØªØ·Ø¨ÙŠÙ‚ Ù¢: Ù…Ø³Ø§Ø­Ø© Ù„ÙˆØ­Ø© Ù…Ø«Ù„Ø«ÙŠØ©</h3>
                <div class="bg-amber-50 p-5 rounded-lg mb-4 text-gray-700 border-r-4 border-amber-300">
                    Ù„ÙˆØ­Ø© Ù…Ø«Ù„Ø«Ø©ØŒ Ù‚Ø§Ø¹Ø¯ØªÙ‡Ø§ <span class="math-eq">Ù¤Ø³</span> ÙˆØ§Ø±ØªÙØ§Ø¹Ù‡Ø§ <span class="math-eq">Ø³</span>. Ø£ÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­ØªÙ‡Ø§.
                </div>
                <div class="min-h-[160px] mb-4 bg-gray-50 rounded-lg p-2">
                    <div class="step-interactive step-box"><h4>Ø®Ø·ÙˆØ© Ù¡: Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† (Ù ,Ù¥ Ã— Ù‚ Ã— Ø¹)</h4><p class="text-center font-bold"><span class="math-eq">Ù… = Ù ,Ù¥ Ã— Ù¤Ø³ Ã— Ø³</span></p></div>
                    <div class="step-interactive step-box border-green-500 bg-green-50"><h4>Ø®Ø·ÙˆØ© Ù¢: Ø§Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h4><p class="text-lg font-bold text-center"><span class="math-eq">Ù… = Ù¢Ø³<span class="tiny-sup">Ù¢</span></span></p></div>
                </div>
                <button class="next-btn btn-theme px-6 py-2 rounded-lg font-bold w-full">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù„</button>
            </div>

            <button onclick="switchTab('quiz')" class="btn-theme w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 mt-4 animate-bounce"><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</span><i data-lucide="arrow-left"></i></button>
        </div>

        <!-- [QUIZ TAB] (Sacred Protocol V2) -->
        <div id="tab-quiz" class="tab-content hidden">
             <div class="bg-white rounded-xl shadow-sm p-4 md:p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div><h2 class="font-bold text-lg md:text-2xl text-gray-800">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…</h2><p class="text-xs text-gray-500">Ù¥ Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø£ØµÙ„ Ù¡Ù¥ Ù†Ù…ÙˆØ°Ø¬Ø§Ù‹</p></div>
                    <div class="text-center">
                        <div id="loading-attempts" class="hidden"><div class="loader"></div></div>
                        <div id="attempts-display" class="flex flex-col items-center">
                            <span class="block text-xl md:text-2xl font-bold" style="color: var(--theme-hex)" id="attempts-count">-</span>
                            <div class="flex items-center gap-1 text-[10px] text-gray-400"><span>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span></div>
                        </div>
                        <div id="timer-top-container" class="hidden mt-1 font-mono text-red-500 text-xs font-bold"><span id="timer-display-top">00:00:00</span></div>
                    </div>
                </div>
                <form id="quizForm" class="space-y-6"></form>
                <div id="quiz-results" class="hidden mt-6 text-center bg-gray-50 rounded-xl border border-gray-200 result-card-base max-w-sm mx-auto p-4">
                    <p class="text-sm text-gray-600 font-bold mb-1">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p><p id="quiz-score" class="text-5xl font-black my-2 tracking-widest drop-shadow-sm">-</p><div id="save-status" class="mt-3 text-center text-sm font-bold animate-pulse"></div>
                    <div class="mt-4"><div id="timer-bottom-container" class="hidden bg-red-50 border border-red-100 rounded-lg p-2 inline-block"><span id="timer-display-bottom" class="block text-lg font-bold text-red-600 font-mono tracking-wider">00:00:00</span></div></div>
                </div>
                <div id="games-wrapper" class="hidden mt-8 pt-6 border-t border-gray-200">
                    <h2 class="text-center font-black text-gray-700 mb-4 flex justify-center gap-2 items-center w-full"><i class="fas fa-gamepad text-yellow-500"></i> Ø§Ø³ØªÙ…ØªØ¹ ÙˆØªØ¹Ù„Ù…</h2>
                    <div id="dynamic-games-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
        <footer class="lesson-footer"><p>ØªØµÙ…ÙŠÙ… ÙˆØ¥Ø¹Ø¯Ø§Ø¯: <strong>Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</strong></p><p class="mt-1 opacity-70">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ù¢Ù Ù¢Ù¥</p></footer>
    </main>

    <nav class="bottom-nav" id="bottom-nav-container"></nav>

    <!-- [MODALS] -->
    <div id="modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-xl p-6 shadow-2xl">
            <div class="flex justify-between mb-4 items-center">
                <div class="flex items-center gap-2" style="color: var(--theme-hex)"><i id="modal-icon" data-lucide="info" class="w-5 h-5"></i><h3 id="modal-title" class="font-bold text-lg">ØªÙˆØ¶ÙŠØ­</h3></div>
                <button onclick="closeModal()" class="bg-gray-100 p-1 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modal-content" class="text-sm text-gray-600 leading-relaxed max-h-[60vh] overflow-y-auto pl-1"></div>
        </div>
    </div>

    <div id="game-modal-container">
        <div id="game-modal-content">
            <div id="game-modal-header">
                <script>document.getElementById('game-modal-header').className += ` bg-gradient-to-r ${currentTheme.gradient}`;</script>
                <div class="flex items-center gap-2"><i class="fas fa-gamepad"></i><span id="game-modal-title" class="font-bold">Ø§Ù„Ù„Ø¹Ø¨Ø©</span></div>
                <div class="flex items-center gap-2">
                    <button onclick="closeGameModal()" class="win-btn win-btn-close"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <iframe id="game-frame" src=""></iframe>
        </div>
    </div>
    <div id="minimized-game-bar" onclick="restoreGameModal()" class="border-blue-600 text-blue-600"><i class="fas fa-gamepad"></i><span id="minimized-game-title">Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ©...</span><i class="fas fa-chevron-up"></i></div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec"; 
        const ATTEMPTS_KEY = 'quiz_attempts_' + LESSON_KEY, NEXT_ATTEMPT_KEY = 'quiz_next_attempt_' + LESSON_KEY, COOLDOWN_MS = 24 * 60 * 60 * 1000;
        let attemptsLeft = 0, currentQuestions = [], timerInterval, studentData = null;
        const urlParams = new URLSearchParams(window.location.search);

        const tabs = [{ id: 'learn1', icon: 'book', label: 'Ø§Ù„Ø¶Ø±Ø¨' }, { id: 'learn2', icon: 'layers', label: 'Ø§Ù„ØªØ¨Ø³ÙŠØ·' }, { id: 'learn3', icon: 'target', label: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª' }, { id: 'learn4', icon: 'star', label: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª' }, { id: 'quiz', icon: 'clipboard-check', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' }];
        const typeLabels = { 'learn1': 'Ø¶Ø±Ø¨ ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯', 'learn2': 'ØªØ¨Ø³ÙŠØ· Ø¹Ø¨Ø§Ø±Ø©', 'learn3': 'Ø­Ù„ Ù…Ø¹Ø§Ø¯Ù„Ø©', 'learn4': 'ØªØ·Ø¨ÙŠÙ‚ Ø­ÙŠØ§ØªÙŠ', 'mixed': 'ØªØ­Ø¯ÙŠ' };

        // [QUESTION BANK: 15 FULL QUESTIONS RESTORED]
        const questionBank = [
            { id: 1, type: 'learn1', t: 'Ø£ÙˆØ¬Ø¯ Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨: Ù¢Ø³ (Ø³ + Ù£)', o: [{t:'Ù¢Ø³Â² + Ù¦Ø³', v:'a'}, {t:'Ù¢Ø³ + Ù¦', v:'b'}, {t:'Ù¢Ø³Â² + Ù£', v:'c'}, {t:'Ø³Â² + Ù¦Ø³', v:'d'}], c: 'a', e: '<div class="step-box">Ù†ÙˆØ²Ø¹ Ù¢Ø³ Ø¹Ù„Ù‰ Ø³ ÙØªØµØ¨Ø­ Ù¢Ø³Â²ØŒ ÙˆÙ†ÙˆØ²Ø¹Ù‡Ø§ Ø¹Ù„Ù‰ Ù£ ÙØªØµØ¨Ø­ Ù¦Ø³.</div>', smart: 'Ù†Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙ†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³.' },
            { id: 2, type: 'learn1', t: 'Ù†Ø§ØªØ¬ Ø¶Ø±Ø¨ -Ù£Ø£ (Ù¤Ø£ - Ù¢) Ù‡Ùˆ:', o: [{t:'Ù¡Ù¢Ø£Â² + Ù¦Ø£', v:'a'}, {t:'-Ù¡Ù¢Ø£Â² + Ù¦Ø£', v:'b'}, {t:'-Ù¡Ù¢Ø£Â² - Ù¦Ø£', v:'c'}, {t:'Ù§Ø£ - Ù¡Ù¡', v:'d'}], c: 'b', e: '<div class="step-box">-Ù£Ø£ Ã— Ù¤Ø£ = -Ù¡Ù¢Ø£Â²ØŒ Ùˆ -Ù£Ø£ Ã— -Ù¢ = +Ù¦Ø£.</div>', smart: 'Ø§Ù†ØªØ¨Ù‡ Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹.' },
            { id: 3, type: 'learn1', t: 'Ø¨Ø³Ø· Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©: Ù¥Øµ (ØµÂ² + Ù£)', o: [{t:'Ù¥Øµ + Ù¡Ù¥', v:'a'}, {t:'Ù¥ØµÂ² + Ù¡Ù¥', v:'b'}, {t:'Ù¥ØµÂ³ + Ù¡Ù¥Øµ', v:'c'}, {t:'ØµÂ³ + Ù¡Ù¥Øµ', v:'d'}], c: 'c', e: '<div class="step-box">Ù†ÙˆØ²Ø¹ Ù¥Øµ: Ù¥Øµ Ã— ØµÂ² = Ù¥ØµÂ³ØŒ Ùˆ Ù¥Øµ Ã— Ù£ = Ù¡Ù¥Øµ.</div>', smart: 'Ø§Ù„Ø£Ø³ Ø§Ù„Ø®ÙÙŠ Ù„Ù€ (Øµ) Ù‡Ùˆ Ù¡.' },
            { id: 4, type: 'learn2', t: 'Ø¨Ø³Ø· Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©: Ù¢(Ø³ + Ù¤) + Ù¥Ø³', o: [{t:'Ù¡Ù Ø³ + Ù¨', v:'a'}, {t:'Ù§Ø³ + Ù¤', v:'b'}, {t:'Ù¢Ø³ + Ù¨', v:'c'}, {t:'Ù§Ø³ + Ù¨', v:'d'}], c: 'd', e: '<div class="step-box">ØªÙˆØ²ÙŠØ¹ Ù¢ ÙŠØ¹Ø·ÙŠ Ù¢Ø³ + Ù¨ØŒ Ø«Ù… Ù†Ø¬Ù…Ø¹ Ù¢Ø³ + Ù¥Ø³ = Ù§Ø³.</div>', smart: 'Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø³ÙŠÙ†Ø§Øª Ù…Ø¹Ø§Ù‹ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ø¹Ø§Ù‹.' },
            { id: 5, type: 'learn2', t: 'Ø¨Ø³Ø·: Ø³(Ø³ + Ù£) - Ø³Â²', o: [{t:'Ø³Â²', v:'a'}, {t:'Ù£Ø³', v:'b'}, {t:'Ù ', v:'c'}, {t:'Ø³', v:'d'}], c: 'b', e: '<div class="step-box">Ø³Â² + Ù£Ø³ - Ø³Â²ØŒ Ù†Ø­Ø°Ù Ø³Â² Ù…Ø¹ -Ø³Â² ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù£Ø³.</div>', smart: 'Ø§Ù„Ø­Ø¯ ÙˆÙ…Ø¹ÙƒÙˆØ³Ù‡ Ù†Ø§ØªØ¬Ù‡Ù…Ø§ ØµÙØ±.' },
            { id: 6, type: 'learn2', t: 'Ø¨Ø³Ø·: Ù£(Ù† - Ù¢) + Ù¢Ù†', o: [{t:'Ù¥Ù† + Ù¦', v:'a'}, {t:'Ù† - Ù¦', v:'b'}, {t:'Ù¥Ù† - Ù¦', v:'c'}, {t:'Ù£Ù† - Ù¦', v:'d'}], c: 'c', e: '<div class="step-box">Ù£Ù† - Ù¦ + Ù¢Ù† = Ù¥Ù† - Ù¦.</div>', smart: 'ÙˆØ²Ø¹ Ù‚Ø¨Ù„ Ø£Ù† ØªØ¬Ù…Ø¹.' },
            { id: 7, type: 'learn3', t: 'Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ø³(Ø³ + Ù¢) = Ø³Â² + Ù¦', o: [{t:'Ù¦', v:'a'}, {t:'Ù¢', v:'b'}, {t:'Ù£', v:'c'}, {t:'Ù ', v:'d'}], c: 'c', e: '<div class="step-box">Ø³Â² + Ù¢Ø³ = Ø³Â² + Ù¦ØŒ Ù†Ø­Ø°Ù Ø³Â² Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†ØŒ Ù¢Ø³ = Ù¦ Ø¥Ø°Ù† Ø³=Ù£.</div>', smart: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠØ© ØªØªØ­ÙˆÙ„ Ù„Ø®Ø·ÙŠØ© Ø¨Ø§Ù„Ø­Ø°Ù.' },
            { id: 8, type: 'learn3', t: 'Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ù¢(Ø³ - Ù¡) = Ù¨', o: [{t:'Ù¥', v:'a'}, {t:'Ù¤', v:'b'}, {t:'Ù£', v:'c'}, {t:'Ù¦', v:'d'}], c: 'a', e: '<div class="step-box">Ù¢Ø³ - Ù¢ = Ù¨ØŒ Ù¢Ø³ = Ù¡Ù  Ø¥Ø°Ù† Ø³=Ù¥.</div>', smart: 'Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ù¢ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø£Ø³Ù‡Ù„.' },
            { id: 9, type: 'learn3', t: 'Ø­Ù„: Ù£Ø³ + Ù¦ = Ù¡Ù¨', o: [{t:'Ù¦', v:'a'}, {t:'Ù¤', v:'b'}, {t:'Ù¨', v:'c'}, {t:'Ù¢', v:'d'}], c: 'b', e: '<div class="step-box">Ù£Ø³ = Ù¡Ù¢ Ø¥Ø°Ù† Ø³ = Ù¤.</div>', smart: 'Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ÙÙŠ Ø·Ø±Ù.' },
            { id: 10, type: 'learn4', t: 'Ù…Ø³Ø§Ø­Ø© Ù…Ø³ØªØ·ÙŠÙ„ Ø·ÙˆÙ„Ù‡ Ø³ ÙˆØ¹Ø±Ø¶Ù‡ Ø³ + Ù¥ Ù‡ÙŠ:', o: [{t:'Ù¢Ø³ + Ù¥', v:'a'}, {t:'Ø³ + Ù¥', v:'b'}, {t:'Ø³Â² + Ù¥Ø³', v:'c'}, {t:'Ù¥Ø³', v:'d'}], c: 'c', e: '<div class="step-box">Ø³ Ã— (Ø³ + Ù¥) = Ø³Â² + Ù¥Ø³.</div>', smart: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù‡ÙŠ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ø§Ù„Ø¨Ø¹Ø¯ÙŠÙ†.' },
            { id: 11, type: 'learn4', t: 'Ù…Ø³Ø§Ø­Ø© Ù…Ø«Ù„Ø« Ù‚Ø§Ø¹Ø¯ØªÙ‡ Ù¤Ø³ ÙˆØ§Ø±ØªÙØ§Ø¹Ù‡ Ø³ Ù‡ÙŠ:', o: [{t:'Ù¤Ø³Â²', v:'a'}, {t:'Ù¢Ø³', v:'b'}, {t:'Ø³Â²', v:'c'}, {t:'Ù¢Ø³Â²', v:'d'}], c: 'd', e: '<div class="step-box">Ù ,Ù¥ Ã— Ù¤Ø³ Ã— Ø³ = Ù¢Ø³Â².</div>', smart: 'Ù„Ø§ ØªÙ†Ø³Ù‰ Ø§Ù„Ù†ØµÙ ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø«Ù„Ø«.' },
            { id: 12, type: 'learn4', t: 'ØªÙƒÙ„ÙØ© Ø¯Ù‡Ø§Ù† Ø­Ø§Ø¦Ø· Ù…Ø³Ø§Ø­ØªÙ‡ (Ø³ + Ù£) Ø¨Ø³Ø¹Ø± Ù¥ Ø±ÙŠØ§Ù„Ø§Øª:', o: [{t:'Ù¥Ø³ + Ù¡Ù¥', v:'a'}, {t:'Ø³ + Ù¡Ù¥', v:'b'}, {t:'Ù¥Ø³ + Ù£', v:'c'}, {t:'Ù¡Ù¥Ø³', v:'d'}], c: 'a', e: '<div class="step-box">Ù¥ Ã— (Ø³ + Ù£) = Ù¥Ø³ + Ù¡Ù¥.</div>', smart: 'Ø§Ù„Ø³Ø¹Ø± ÙŠÙˆØ²Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø­Ø©.' },
            { id: 13, type: 'mixed', t: 'Ø¨Ø³Ø·: Ø³(Ø³ + Ù¡) - Ø³Â²', o: [{t:'Ù¡', v:'a'}, {t:'Ø³', v:'b'}, {t:'Ù ', v:'c'}, {t:'Ù¢Ø³', v:'d'}], c: 'b', e: '<div class="step-box">Ø³Â² + Ø³ - Ø³Â² = Ø³.</div>', smart: 'ÙˆØ²Ø¹ Ø§Ù„Ù‚ÙˆØ³ Ø£ÙˆÙ„Ø§Ù‹.' },
            { id: 14, type: 'mixed', t: 'Ø­Ù„: Ù¢Ø³(Ø³ + Ù£) = Ù¢Ø³Â² + Ù¡Ù¢', o: [{t:'Ù¦', v:'a'}, {t:'Ù¡', v:'b'}, {t:'Ù¢', v:'c'}, {t:'Ù ', v:'d'}], c: 'c', e: '<div class="step-box">Ù¢Ø³Â² + Ù¦Ø³ = Ù¢Ø³Â² + Ù¡Ù¢ØŒ Ø¥Ø°Ù† Ù¦Ø³ = Ù¡Ù¢.</div>', smart: 'Ø§Ø­Ø°Ù Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†.' },
            { id: 15, type: 'mixed', t: 'Ø¨Ø³Ø·: Øµ(Øµ+Ù¡) + Øµ(Øµ-Ù¡)', o: [{t:'Øµ', v:'a'}, {t:'Ù ', v:'b'}, {t:'Ù¢Øµ', v:'c'}, {t:'Ù¢ØµÂ²', v:'d'}], c: 'd', e: '<div class="step-box">ØµÂ² + Øµ + ØµÂ² - Øµ = Ù¢ØµÂ².</div>', smart: 'Ø§Ø¬Ù…Ø¹ Ø­Ø¯ÙˆØ¯ ØµÂ² Ù…Ø¹Ø§Ù‹.' }
        ];

        // --- GLOBAL FUNCTIONS ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById('tab-' + tabId), navEl = document.getElementById('nav-' + tabId);
            if (tabEl) tabEl.classList.remove('hidden'); if (navEl) navEl.classList.add('active');
            window.scrollTo(0,0);
            if(tabId === 'quiz') { if(!document.getElementById('quizForm').innerHTML) generateQuiz(); renderDynamicGames(); fetchStudentData(); }
        }

        async function fetchStudentData() {
            const sId = urlParams.get('studentId') || 'visitor'; if (sId === 'visitor') return;
            try {
                const cId = urlParams.get('classId') || 'visitor';
                const url = `${APPS_SCRIPT_URL}?action=getStudentData&studentId=${sId}&classId=${cId}&itemId=${LESSON_KEY}&t=${Date.now()}`;
                const response = await fetch(url), json = await response.json();
                studentData = json;
                if (json.status === "success" && json.data) {
                    let d = json.data.lessons?.[LESSON_KEY] || { attempts: 0, grade: 0 };
                    attemptsLeft = Math.max(0, 3 - (d.attempts || 0));
                    if (attemptsLeft === 0 && d.waitTime > 0) startTimer(Date.now() + d.waitTime);
                    if (d.grade > 0) { document.getElementById('student-score').textContent = d.grade; document.getElementById('header-score-badge')?.classList.remove('hidden'); }
                    if (json.data.name) document.getElementById('student-name').textContent = json.data.name;
                    syncGamesWithData();
                }
            } catch (e) {} finally { updateAttemptsUI(); }
        }

        async function saveScoreToBackend(lessonId, grade) {
            const sId = urlParams.get('studentId'), cId = urlParams.get('classId'), saveStatus = document.getElementById('save-status');
            if (!sId || !cId) return;
            saveStatus.innerHTML = '<span class="text-blue-600">Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...</span>';
            const url = `${APPS_SCRIPT_URL}?action=saveScore&studentId=${sId}&classId=${cId}&itemId=${lessonId}&score=${grade}&type=lesson`;
            try { await fetch(url); saveStatus.innerHTML = '<span class="text-green-600 font-bold">âœ” ØªÙ… Ø§Ù„Ø­ÙØ¸</span>'; setTimeout(() => fetchStudentData(), 1000); } catch (e) {}
        }

        function generateQuiz() { currentQuestions = []; ['learn1', 'learn2', 'learn3', 'learn4', 'mixed'].forEach(type => { const pool = questionBank.filter(q => q.type === type); currentQuestions.push(pool[Math.floor(Math.random() * pool.length)]); }); renderQuiz(); }

        function renderQuiz() {
            const f = document.getElementById('quizForm'); if(!f) return;
            let h = '';
            currentQuestions.forEach((q, i) => {
                h += `<div class="border border-gray-200 rounded-xl p-4 bg-white mb-6">
                        <div class="flex justify-between items-center mb-4"><span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold">Ø³Ø¤Ø§Ù„ ${convertToArabic(i+1)}</span><span class="text-[10px] text-gray-400 font-bold">${typeLabels[q.type]}</span></div>
                        <p class="font-bold text-gray-800 mb-4">${q.t}</p>
                        <div class="options-grid">${q.o.map((o, oi) => `<div><input type="radio" name="q${i}" id="q${i}o${oi}" value="${o.v}" class="hidden"><label for="q${i}o${oi}" class="option-label shadow-sm text-sm">${o.t}</label></div>`).join('')}</div>
                        <div id="feedback-${i}" class="hidden p-3 rounded-lg mt-2 font-bold text-xs"></div>
                        <div id="actions-${i}" class="hidden mt-3 flex flex-wrap gap-2 items-center">
                             <button type="button" onclick="showExplain(${i})" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg flex items-center gap-1"><i data-lucide="help-circle" class="w-3 h-3"></i> Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                             <button type="button" onclick="showSmart(${i})" class="text-xs bg-purple-50 text-purple-600 px-3 py-2 rounded-lg flex items-center gap-1"><i data-lucide="lightbulb" class="w-3 h-3"></i> Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ</button>
                             <button type="button" onclick="switchTab('${q.type.replace('mixed','learn4')}')" class="text-xs border border-gray-200 text-gray-500 px-3 py-2 rounded-lg mr-auto flex items-center gap-1"><i data-lucide="book-open" class="w-3 h-3"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³</button>
                        </div>
                      </div>`;
            });
            h += '<button type="submit" id="quiz-action-btn" class="btn-theme w-full font-bold py-3 rounded-xl shadow-lg transition">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>';
            f.innerHTML = h; f.onsubmit = handleQuizSubmit; lucide.createIcons(); updateAttemptsUI();
        }

        async function handleQuizSubmit(e) {
            e.preventDefault(); if (attemptsLeft <= 0) return; attemptsLeft--;
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') { localStorage.setItem(ATTEMPTS_KEY + '_visitor', attemptsLeft); if (attemptsLeft === 0) { const nt = Date.now() + COOLDOWN_MS; localStorage.setItem(NEXT_ATTEMPT_KEY + '_visitor', nt); startTimer(nt); } }
            else if (attemptsLeft === 0) startTimer(Date.now() + COOLDOWN_MS);

            let sc = 0;
            currentQuestions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`), fb = document.getElementById('feedback-'+i), acts = document.getElementById('actions-'+i);
                if(sel?.value === q.c) { sc++; if(fb) { fb.innerHTML = 'âœ” Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©'; fb.className = 'block bg-green-50 text-green-700 p-3 rounded-lg mt-2 text-xs font-bold border border-green-100'; } }
                else if(fb) { fb.innerHTML = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'; fb.className = 'block bg-red-50 text-red-700 p-3 rounded-lg mt-2 text-xs font-bold border border-red-100'; }
                if(acts) acts.classList.remove('hidden'); document.querySelectorAll(`input[name="q${i}"]`).forEach(inp => inp.disabled = true);
            });
            const gr = sc * 2; document.getElementById('quiz-results')?.classList.remove('hidden');
            const scE = document.getElementById('quiz-score'); if(scE) scE.textContent = convertToArabic(gr) + ' / Ù¡Ù ';
            saveScoreToBackend(LESSON_KEY, gr); updateAttemptsUI();
        }

        function updateAttemptsUI() {
            const countEl = document.getElementById('attempts-count'); if(countEl) countEl.textContent = convertToArabic(attemptsLeft);
            const btn = document.getElementById('quiz-action-btn'), resDiv = document.getElementById('quiz-results');
            if (!btn || !resDiv) return;
            if (!resDiv.classList.contains('hidden')) {
                if (attemptsLeft > 0) { btn.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"; btn.disabled = false; btn.type = "button"; btn.onclick = () => { resDiv.classList.add('hidden'); generateQuiz(); }; btn.className = "btn-theme w-full font-bold py-3 rounded-xl"; }
                else { btn.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª"; btn.disabled = true; btn.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-xl cursor-not-allowed"; }
            } else {
                if (attemptsLeft > 0) { btn.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª"; btn.disabled = false; btn.type = "submit"; btn.onclick = null; btn.className = "btn-theme w-full font-bold py-3 rounded-xl shadow-lg"; }
                else { btn.textContent = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø³ØªÙ†ÙØ°Ø©"; btn.disabled = true; btn.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-xl cursor-not-allowed"; }
            }
        }

        function startTimer(target) {
            clearInterval(timerInterval);
            document.getElementById('timer-top-container')?.classList.remove('hidden');
            document.getElementById('timer-bottom-container')?.classList.remove('hidden');
            timerInterval = setInterval(() => {
                const diff = target - Date.now();
                if (diff <= 0) { clearInterval(timerInterval); location.reload(); return; }
                const t = new Date(diff).toISOString().substr(11, 8).replace(/\d/g, d=>"Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
                document.getElementById('timer-display-top').textContent = t;
                document.getElementById('timer-display-bottom').textContent = t;
            }, 1000);
        }

        function showExplain(i) { const c = document.getElementById('modal-content'); if(c) { c.innerHTML = currentQuestions[i].e; document.getElementById('modal')?.classList.remove('hidden'); } }
        function showSmart(i) { const c = document.getElementById('modal-content'); if(c) { c.innerHTML = `<p class="font-bold text-purple-700 mb-2">ğŸ’¡ Ø§Ù„Ø­Ù„ Ø§Ù„Ø°ÙƒÙŠ:</p>${currentQuestions[i].smart}`; document.getElementById('modal')?.classList.remove('hidden'); } }
        function closeModal() { document.getElementById('modal')?.classList.add('hidden'); }

        function initInteractive() {
            document.querySelectorAll('[id^="interactive-container-"]').forEach(container => {
                const steps = container.querySelectorAll('.step-interactive'), placeholder = container.querySelector('.interactive-placeholder');
                const nextBtn = container.querySelector('.next-btn');
                let current = -1;
                const update = () => { if(placeholder) placeholder.classList.toggle('hidden', current !== -1); steps.forEach((s, i) => s.classList.toggle('active', i <= current)); if(nextBtn) nextBtn.textContent = current >= steps.length - 1 ? "Ø¥Ø¹Ø§Ø¯Ø©" : "Ø§Ù„ØªØ§Ù„ÙŠ"; };
                if(nextBtn) nextBtn.onclick = () => { current = current < steps.length - 1 ? current + 1 : -1; update(); };
                update();
            });
        }

        function initAttempts() {
            const sId = urlParams.get('studentId') || 'visitor';
            if (sId === 'visitor') {
                const saved = localStorage.getItem(ATTEMPTS_KEY + '_visitor');
                attemptsLeft = saved !== null ? parseInt(saved) : 1;
                const next = localStorage.getItem(NEXT_ATTEMPT_KEY + '_visitor');
                if (next && parseInt(next) > Date.now()) { startTimer(parseInt(next)); attemptsLeft = 0; }
                updateAttemptsUI();
            } else { fetchStudentData(); }
        }

        window.onload = function() {
            const nav = document.getElementById('bottom-nav-container');
            if(nav) tabs.forEach((t, i) => { nav.innerHTML += `<div class="nav-item ${i===0?'active':''}" id="nav-${t.id}" onclick="switchTab('${t.id}')"><i data-lucide="${t.icon}"></i><span>${t.label}</span></div>`; });
            lucide.createIcons(); initInteractive(); initAttempts();
        };

        function openGameModal(url, title) { document.getElementById('game-modal-container').style.display = 'flex'; document.getElementById('game-frame').src = url; document.getElementById('game-modal-title').textContent = title; }
        function closeGameModal() { document.getElementById('game-modal-container').style.display = 'none'; document.getElementById('game-frame').src = ''; }
        function minimizeGameModal() { document.getElementById('game-modal-container').style.display = 'none'; document.getElementById('minimized-game-bar').style.display = 'flex'; }
        function restoreGameModal() { document.getElementById('game-modal-container').style.display = 'flex'; document.getElementById('minimized-game-bar').style.display = 'none'; }

        function renderDynamicGames() {
            const container = document.getElementById('dynamic-games-container'); if (!container) return;
            container.innerHTML = '';
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/); if (!match) return;
            const ch = match[1], ls = match[2];
            const games = [
                { id: `g${ch}_${ls}_1`, title: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¶Ø±Ø¨', icon: 'fa-gamepad' },
                { id: `g${ch}_${ls}_2`, title: 'Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„', icon: 'fa-trophy' }
            ];
            games.forEach((g, idx) => {
                const url = `https://ablan-math.github.io/games/${g.id}.html?studentId=${urlParams.get('studentId')||''}&classId=${urlParams.get('classId')||''}`;
                container.innerHTML += `<div id="game-card-${idx+1}" class="p-4 border rounded-xl flex items-center gap-3 cursor-pointer bg-white hover:shadow-md transition" onclick="openGameModal('${url}', '${g.title}')">
                    <div id="game-icon-${idx+1}" class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-100 text-blue-600"><i class="fas ${g.icon}"></i></div>
                    <div class="flex flex-col"><span class="font-bold text-sm">${g.title}</span><span id="game-status-${idx+1}" class="text-[10px] opacity-70">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø¨</span></div>
                </div>`;
            });
            document.getElementById('games-wrapper')?.classList.remove('hidden');
            if(studentData) syncGamesWithData();
        }

        function syncGamesWithData() {
            if (!studentData?.data) return;
            const match = LESSON_KEY.match(/c(\d+)_l(\d+)/); if (!match) return;
            const gameIds = [`g${match[1]}_${match[2]}_1`, `g${match[1]}_${match[2]}_2`];
            gameIds.forEach((gid, idx) => {
                let d = studentData.data.games?.[gid] || studentData.data.lessons?.[gid] || studentData.data[gid];
                if (d && d.grade !== undefined) {
                    const s = parseFloat(d.grade);
                    const card = document.getElementById(`game-card-${idx+1}`), status = document.getElementById(`game-status-${idx+1}`), icon = document.getElementById(`game-icon-${idx+1}`);
                    if (s >= 5) { card.className += " result-card-trophy"; status.textContent = `Ø£Ø­Ø³Ù†Øª! (${convertToArabic(s)}/Ù¥)`; icon.className = "w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"; icon.innerHTML = '<i class="fas fa-trophy"></i>'; }
                }
            });
        }
    </script>
</body>
</html>

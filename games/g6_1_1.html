<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØµØ§Ø¦Ø¯ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯ | V25.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }

        #app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 900px;
            background-color: #0f172a;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* Fraction Style for Instructions */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            font-size: 0.8em;
            margin: 0 2px;
        }
        .fraction > span {
            display: block;
            padding: 0 2px;
        }
        .fraction span.numerator {
            border-bottom: 1px solid currentColor;
        }
        .fraction span.denominator {
            border-top: 0;
        }

        ::-webkit-scrollbar { display: none; }

        .screen {
            position: absolute;
            top: 3rem; 
            left: 0; 
            width: 100%; 
            height: calc(100% - 3rem); 
            display: flex; flex-direction: column;
            z-index: 10;
            transition: opacity 0.3s ease;
            background-color: #0f172a;
            opacity: 0; pointer-events: none;
        }
        
        .active { opacity: 1; pointer-events: auto; z-index: 20; }
        .visually-hidden { display: none !important; }

        #gameCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            display: block;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 12px;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }

        .btn-secondary {
            background-color: #334155;
            color: white;
            border-radius: 12px;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.4);
        }
        .btn-secondary:active { transform: scale(0.96); }

        /* Overlays */
        #level-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 50;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #level-overlay.show { opacity: 1; pointer-events: auto; }

        #leaderboard-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98);
            z-index: 100;
            display: flex; flex-direction: column;
            padding: 1.5rem;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #leaderboard-modal.show { opacity: 1; pointer-events: auto; }

        .leaderboard-row:nth-child(even) { background-color: rgba(255,255,255,0.05); }
        .rank-1 { color: #fbbf24; font-weight: 900; }
        .rank-2 { color: #94a3b8; font-weight: 800; }
        .rank-3 { color: #b45309; font-weight: 800; }

        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app-container">
    
    <!-- Top Header: Student Name (Right) & Best Score (Left) -->
    <header class="h-12 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4 z-50 shrink-0 relative shadow-md">
        <div class="flex items-center gap-2 text-slate-200">
            <span class="text-[10px] text-slate-400">Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
            <span id="header-student-name" class="font-bold text-xs truncate max-w-[120px]">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <!-- Moved Best Score Here -->
        <div class="flex items-center gap-2">
            <span class="text-[10px] text-slate-400">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©:</span>
            <span id="header-best-score" class="font-mono font-black text-emerald-400 text-base">...</span>
        </div>
    </header>

    <!-- Start Screen -->
    <div id="start-screen" class="screen active px-5 py-4 items-center justify-start text-center overflow-hidden">
        
        <!-- Compact Title -->
        <div class="mt-2 mb-3 flex items-center justify-center gap-2">
            <div class="text-4xl animate-bounce">ğŸš€</div>
            <h1 class="text-2xl font-black text-white leading-tight">ØµØ§Ø¦Ø¯ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯</h1>
        </div>

        <!-- Compact Instructions Area -->
        <div class="bg-slate-800/80 p-3 rounded-xl w-full mb-3 border border-slate-700 text-right shadow-lg flex-1 flex flex-col justify-center max-h-[280px]">
            <h3 class="text-yellow-400 font-bold mb-2 text-xs border-b border-slate-600 pb-1">ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©:</h3>
            
            <div class="mb-2">
                <p class="text-[10px] text-slate-300 font-bold mb-0.5">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ù£ Ù…Ø±Ø§Ø­Ù„):</p>
                <ul class="text-[10px] text-slate-400 list-disc list-inside space-y-0.5 mr-1 leading-tight">
                    <li>Ø¬Ù…Ø¹ <span class="text-white">Ù¡Ù¥</span> ÙƒØ±Ø© (Ø³Ù‡Ù„Ø©) â¬…ï¸ <span class="text-white">Ù¡Ù </span> (Ù…ØªÙˆØ³Ø·Ø©) â¬…ï¸ <span class="text-white">Ù¥</span> (ØµØ¹Ø¨Ø©).</li>
                </ul>
            </div>

            <div>
                <p class="text-[10px] text-slate-300 font-bold mb-0.5">âš ï¸ Ø§Ø­Ø°Ø± Ù…Ù† (ØºÙŠØ± ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯):</p>
                <ul class="text-[10px] text-slate-400 list-disc list-inside space-y-1 mr-1 leading-tight">
                    <li><span class="text-red-400 font-bold">Ù„Ø§</span> Ø¬Ù…Ø¹ (+) ÙˆÙ„Ø§ Ø·Ø±Ø­ (-).</li>
                    <li><span class="text-red-400 font-bold">Ù„Ø§</span> Ù…ØªØºÙŠØ± Ø¨Ø§Ù„Ù…Ù‚Ø§Ù… (Ù…Ø«Ø§Ù„: <div class="fraction text-white"><span class="numerator">Ù¥</span><span class="denominator">Ø³</span></div> Ù…Ù…Ù†ÙˆØ¹ âŒ).</li>
                    <li><span class="text-red-400 font-bold">Ù„Ø§</span> Ø£Ø³ Ø³Ø§Ù„Ø¨ (Ù…Ø«Ù„ Ø³â»Â²).</li>
                    <li><span class="text-red-400 font-bold">Ù„Ø§</span> Ø¬Ø°Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± (âˆšØ³).</li>
                </ul>
            </div>
        </div>

        <!-- Buttons Area - Moved Up & Side-by-Side -->
        <div class="w-full mt-1 mb-2">
            <div class="flex gap-2 w-full h-14">
                <!-- Big Launch Button -->
                <button id="start-btn" class="btn-primary flex-[2.5] flex items-center justify-center gap-2 text-sm shadow-xl border-b-4 border-blue-700 active:border-b-0 active:translate-y-1">
                    <span class="text-xl">ğŸ›¸</span>
                    <span>Ø§Ù†Ø·Ù„Ù‚ Ù„Ù„Ù…Ù‡Ù…Ø©</span>
                </button>
                
                <!-- Smaller Leaderboard Button -->
                <button onclick="showLeaderboardModal()" class="btn-secondary flex-1 flex flex-col items-center justify-center gap-0.5 text-[10px] shadow-lg">
                    <span class="text-lg">ğŸ†</span>
                    <span>Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</span>
                </button>
            </div>
        </div>

        <footer class="text-[9px] text-slate-600 mt-auto">
            ØªØ·ÙˆÙŠØ±: Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†
        </footer>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen visually-hidden">
        <div class="absolute top-3 left-3 right-3 flex justify-between items-start z-30 pointer-events-none">
            <div class="flex flex-col gap-1 items-start">
                <div class="bg-blue-600/90 px-2 py-0.5 rounded-md border border-blue-400 shadow-sm backdrop-blur-sm">
                    <span class="text-[10px] text-white">Ù…Ø±Ø­Ù„Ø©</span>
                    <span id="level-display" class="font-black text-white text-xs mr-1">Ù¡</span>
                </div>
                <div class="bg-slate-800/80 px-2 py-0.5 rounded-md border border-slate-600 backdrop-blur-sm">
                    <span class="text-[10px] text-slate-400">Ù‡Ø¯Ù</span>
                    <span id="level-progress" class="font-mono font-bold text-emerald-400 text-xs mr-1">Ù /Ù¡Ù¥</span>
                </div>
            </div>
            
            <div class="bg-slate-800/80 px-2 py-1 rounded-md border border-slate-600 flex gap-0.5 items-center backdrop-blur-sm">
                <span id="lives-display" class="text-sm">â¤ï¸â¤ï¸â¤ï¸</span>
            </div>
        </div>

        <div id="canvas-wrapper" class="flex-1 w-full h-full relative overflow-hidden">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <div id="level-overlay">
            <h2 id="overlay-title" class="text-4xl font-black text-white mb-2">Ù…Ù…ØªØ§Ø²!</h2>
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-600 mb-4 text-center w-64">
                <div class="text-slate-400 text-xs mb-1">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
                <div id="overlay-stats" class="text-xl font-bold text-emerald-400">ØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ù‡Ø¯Ù</div>
                <div id="overlay-lives" class="text-sm text-red-400 mt-1">â¤ï¸ Ù…ØªØ¨Ù‚ÙŠØ©</div>
            </div>
            <p id="overlay-subtitle" class="text-slate-300 text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„...</p>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen visually-hidden px-4 py-4 items-center pt-6">
        <h2 class="text-2xl font-black text-white mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
        
        <!-- Score Card -->
        <div class="bg-slate-800 w-full p-4 rounded-xl border border-slate-700 mb-4 text-center shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl">ğŸ“Š</div>
            <div class="flex justify-around items-end border-b border-slate-700/50 pb-4 mb-3">
                <div>
                    <div class="text-slate-400 text-[10px] mb-1">ØµØ­ÙŠØ­Ø©</div>
                    <div class="text-2xl font-black text-white font-mono"><span id="total-collected">Ù </span>/Ù£Ù </div>
                </div>
                <div>
                    <div class="text-slate-400 text-[10px] mb-1">Ø¨ÙˆÙ†Øµ</div>
                    <div class="text-2xl font-black text-red-400 font-mono">+<span id="hearts-bonus">Ù </span></div>
                </div>
            </div>
            
            <div>
                <div class="text-slate-400 text-xs mb-1">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
                <div class="text-5xl font-black text-yellow-400 font-mono leading-none"><span id="final-grade">Ù </span>/Ù¥</div>
            </div>
            
            <div id="feedback-text" class="text-xs text-slate-300 mt-3">Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯!</div>
            <div id="new-record-badge" class="hidden bg-yellow-500/20 text-yellow-300 text-[10px] px-3 py-1 rounded-full mt-2 inline-block border border-yellow-500/30 font-bold">
                ğŸ† Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!
            </div>
        </div>

        <!-- Buttons -->
        <div class="w-full mt-auto space-y-2 pb-4">
            <div class="flex gap-2 w-full">
                <button id="restart-btn" class="btn-primary flex-[2] py-3 text-sm shadow-lg border-b-4 border-blue-700 active:border-b-0 active:translate-y-1">Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ğŸ”„</button>
                <button onclick="showLeaderboardModal()" class="btn-secondary flex-1 py-3 text-xl shadow-lg">ğŸ†</button>
            </div>
            <button id="exit-btn" class="bg-slate-700 hover:bg-slate-600 text-white w-full py-3 rounded-xl font-bold text-xs transition">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸšª</button>
        </div>
    </div>

    <!-- Full Screen Leaderboard Modal -->
    <div id="leaderboard-modal">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ†</span>
                <h2 class="text-xl font-black text-white">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h2>
            </div>
            <button onclick="hideLeaderboardModal()" class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold transition">âœ•</button>
        </div>
        
        <div class="bg-slate-800 rounded-xl flex-1 border border-slate-700 overflow-hidden flex flex-col shadow-2xl">
            <div class="bg-slate-900/80 p-3 text-xs font-bold text-slate-400 border-b border-slate-700 flex justify-between">
                <span>Ø§Ù„ØªØ±ØªÙŠØ¨ / Ø§Ù„Ø§Ø³Ù…</span>
                <span>Ø§Ù„Ù†Ù‚Ø§Ø·</span>
            </div>
            <div class="leaderboard-list p-2 overflow-y-auto flex-1 text-sm text-slate-200 space-y-1">
                <div class="text-center py-8 text-slate-500 text-xs flex flex-col items-center gap-2">
                    <div class="loader"></div>
                    <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
                </div>
            </div>
        </div>
        
        <p class="text-center text-[10px] text-slate-500 mt-4">ÙŠØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©</p>
    </div>

</div>

<script>
/**
 * V25.5 - FINAL FIX for Student ID & Saving Logic
 */

// 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª
const CONFIG = {
    gameId: 'g6_1_1', 
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· (ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹ØªÙ…Ø¯)
    scriptUrl: 'https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec'
};

const getQueryParam = (param) => new URLSearchParams(window.location.search).get(param);

const STATE = {
    studentName: 'Ø¶ÙŠÙ',
    // 2. Ø§Ù„ØªÙ‚Ø§Ø· Ù‡ÙˆÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    studentId: getQueryParam('studentId') || getQueryParam('userId') || getQueryParam('id') || 'guest',
    bestScore: 0,
    currentLevel: 1, levelScore: 0, totalScore: 0, lives: 3, totalLivesSaved: 0,
    isPlaying: false, isTransitioning: false
};

const LEVELS = [
    { id: 1, speed: 1.2, wrongRatio: 0.3, target: 15 },
    { id: 2, speed: 1.8, wrongRatio: 0.5, target: 10 },
    { id: 3, speed: 2.5, wrongRatio: 0.6, target: 5 }
];

const toArNum = (n) => (n || 0).toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

// --- Modal Logic ---
function showLeaderboardModal() {
    document.getElementById('leaderboard-modal').classList.add('show');
}
function hideLeaderboardModal() {
    document.getElementById('leaderboard-modal').classList.remove('show');
}

// --- API (Fixed for Saving & Fetching) ---
const API = {
    async fetchStudentData() {
        const idFromUrl = getQueryParam('gameId');
        const finalId = idFromUrl || CONFIG.gameId;
        
        try {
            // Ø¥Ø¶Ø§ÙØ© studentId Ù„Ù„Ø±Ø§Ø¨Ø·
            const url = `${CONFIG.scriptUrl}?action=getStudentData&gameId=${finalId}&studentId=${STATE.studentId}`;
            console.log('Fetching Student:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.result === 'success') {
                STATE.studentName = data.name || 'Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯';
                STATE.bestScore = parseInt(data.bestScore) || 0;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('header-student-name').textContent = STATE.studentName;
                document.getElementById('header-best-score').textContent = toArNum(STATE.bestScore);
            } else {
                document.getElementById('header-student-name').textContent = "Ø¶ÙŠÙ";
                document.getElementById('header-best-score').textContent = "Ù ";
            }
        } catch (e) {
            console.error('Connection Error:', e);
            document.getElementById('header-student-name').textContent = "ØºÙŠØ± Ù…ØªØµÙ„";
        }
    },

    async saveScore(score, grade) {
        const idFromUrl = getQueryParam('gameId');
        const finalId = idFromUrl || CONFIG.gameId;
        try {
            // Ø¥Ø¶Ø§ÙØ© studentId Ù„Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ù„Ù„Ø´Ø®Øµ Ø§Ù„ØµØ­ÙŠØ­
            const url = `${CONFIG.scriptUrl}?action=saveScore&gameId=${finalId}&studentId=${STATE.studentId}&score=${score}&metricValue=${grade}&type=game`;
            console.log('Saving Score:', url);
            
            await fetch(url);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
            this.fetchLeaderboard();
        } catch (e) { console.error('Save Error:', e); }
    },

    async fetchLeaderboard() {
        const idFromUrl = getQueryParam('gameId');
        const finalId = idFromUrl || CONFIG.gameId;
        const containers = document.querySelectorAll('.leaderboard-list');
        
        try {
            const response = await fetch(`${CONFIG.scriptUrl}?action=getLeaderboard&gameId=${finalId}`);
            const data = await response.json();
            if (data.result === 'success') {
                const html = data.data.map((p, i) => `
                    <div class="leaderboard-row flex justify-between items-center py-3 px-3 rounded-lg text-xs border border-transparent hover:border-slate-600 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="${i < 3 ? `rank-${i+1} text-lg` : 'text-slate-500'} font-black w-6 text-center">${toArNum(i+1)}</div>
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-200 text-sm truncate max-w-[140px]">${p.name}</span>
                                <span class="text-[10px] text-slate-500">${p.date || ''}</span>
                            </div>
                        </div>
                        <span class="font-mono font-bold text-emerald-400 text-base bg-slate-800/50 px-3 py-1 rounded-lg border border-slate-700/50">${toArNum(p.score)}</span>
                    </div>
                `).join('');
                containers.forEach(c => c.innerHTML = html);
            }
        } catch (e) { 
            containers.forEach(c => c.innerHTML = '<div class="text-center text-red-400 text-xs py-4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>');
        }
    }
};

// --- Game Engine ---
const Game = {
    canvas: null, ctx: null, animationId: null,
    player: { x: 0, y: 0, width: 50, height: 70 },
    items: [], particles: [], frameCount: 0, spawnRate: 60, wrapper: null,

    levelData: {
        1: {
            monomials: [{ parts: [{v:'Ù¡Ù¢'}] }, { parts: [{v:'Ø³'}] }, { parts: [{v:'Ù¥'}, {v:'Ø³'}] }, { parts: [{v:'-'}, {v:'Ù¢'}, {v:'Ø£'}] }, { parts: [{v:'Øµ'}] }, { parts: [{v:'Ù§'}] }],
            nonMonomials: [{ parts: [{v:'Ø³'}, {v:'+'}, {v:'Øµ'}] }, { parts: [{v:'Ø£'}, {v:'-'}, {v:'Ø¨'}] }, { parts: [{v:'Ù¥'}, {v:'+'}, {v:'Ø³'}] }, { parts: [{v:'Ø³'}, {v:'-'}, {v:'Ù¡'}] }]
        },
        2: {
            monomials: [{ parts: [{v:'Ù¥'}, {v:'Ø³'}, {t:'sup', v:'Ù¢'}] }, { parts: [{v:'Ù£'}, {v:'Ø³'}, {v:'Øµ'}] }, { parts: [{t:'frac', n:'Ø³', d:'Ù£'}] }, { parts: [{t:'frac', n:'Ù¡', d:'Ù¢'}, {v:'Ù…'}] }, { parts: [{v:'-'}, {v:'Ø³'}, {t:'sup', v:'Ù£'}] }],
            nonMonomials: [{ parts: [{t:'frac', n:'Ù¥', d:'Ø³'}] }, { parts: [{t:'frac', n:'Ù¢', d:'Ù†'}] }, { parts: [{v:'Ù£'}, {v:'Ø³'}, {t:'sup', v:'Ù¢-'}] }, { parts: [{v:'Øµ'}, {t:'sup', v:'Ù¡-'}] }]
        },
        3: {
            monomials: [{ parts: [{t:'sqrt', v:'Ù¡Ù¦'}] }, { parts: [{t:'frac', n:'Ù£', d:'Ù¤'}] }, { parts: [{t:'frac', n:'Ù¡', d:'Ù¢'}, {v:'Ù…'}, {t:'sup', v:'Ù¢'}] }, { parts: [{v:'Ø£'}, {v:'Ø¨'}, {v:'Ø¬'}, {t:'sup', v:'Ù£'}] }, { parts: [{v:'Ø·'}, {v:'Ù†Ù‚'}, {t:'sup', v:'Ù¢'}] }],
            nonMonomials: [{ parts: [{t:'sqrt', v:'Ø³'}] }, { parts: [{t:'frac', n:'Ø³', d:'Øµ'}] }, { parts: [{v:'Ø³'}, {t:'sup', v:'Ù¢'}, {v:'+'}, {v:'Ù¤'}] }, { parts: [{v:'Ù£'}, {v:'Ø³'}, {v:'+'}, {v:'Ù¡'}] }, { parts: [{t:'frac', n:'Ù¡', d:'Ù¢'}, {v:'Ø³'}, {t:'sup', v:'Ù¡-'}] }]
        }
    },

    init() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.wrapper = document.getElementById('canvas-wrapper');

        const inputHandler = (e) => {
            if (!STATE.isPlaying || STATE.isTransitioning) return;
            if (!this.canvas.width || this.canvas.width < 10) return;
            const rect = this.canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let relativeX = clientX - rect.left;
            relativeX *= (this.canvas.width / rect.width);
            this.player.x = Math.max(this.player.width/2, Math.min(this.canvas.width - this.player.width/2, relativeX));
        };

        window.addEventListener('mousemove', inputHandler);
        window.addEventListener('touchmove', (e) => {
            if(STATE.isPlaying && e.target === this.canvas) e.preventDefault();
            inputHandler(e);
        }, { passive: false });
        window.addEventListener('resize', () => { if(STATE.isPlaying) this.resize(); });
    },

    resize() {
        const w = this.wrapper.clientWidth;
        const h = this.wrapper.clientHeight;
        if (w === 0 || h === 0) { this.canvas.width = window.innerWidth * 2; this.canvas.height = window.innerHeight * 2; } 
        else { this.canvas.width = w * 2; this.canvas.height = h * 2; }
        this.player.y = this.canvas.height - 150;
    },

    start() {
        this.resize();
        STATE.totalScore = 0; STATE.totalLivesSaved = 0; STATE.currentLevel = 1;
        this.startLevel(1);
    },

    startLevel(levelNum) {
        STATE.isPlaying = true; STATE.isTransitioning = false; STATE.currentLevel = levelNum; STATE.levelScore = 0; STATE.lives = 3;
        this.items = []; this.particles = []; this.frameCount = 0;
        document.getElementById('level-display').textContent = toArNum(levelNum);
        this.updateHUD();
        document.getElementById('level-overlay').classList.remove('show');
        this.loop();
    },

    updateHUD() {
        const levelConfig = LEVELS[STATE.currentLevel - 1];
        document.getElementById('level-progress').textContent = toArNum(STATE.levelScore) + "/" + toArNum(levelConfig.target);
        document.getElementById('lives-display').textContent = "â¤ï¸".repeat(STATE.lives);
    },

    nextLevel() {
        STATE.totalLivesSaved += STATE.lives;
        STATE.isTransitioning = true;
        const currentLvl = STATE.currentLevel;
        if (currentLvl >= 3) { this.stop(); return; }

        const overlay = document.getElementById('level-overlay');
        document.getElementById('overlay-title').textContent = "Ù…Ù…ØªØ§Ø²!";
        document.getElementById('overlay-title').className = "text-4xl font-black text-blue-400 mb-2";
        const config = LEVELS[currentLvl - 1];
        document.getElementById('overlay-stats').textContent = "ØªÙ… Ø¬Ù…Ø¹: " + toArNum(STATE.levelScore) + "/" + toArNum(config.target);
        document.getElementById('overlay-stats').className = "text-xl font-bold text-emerald-400";
        document.getElementById('overlay-lives').textContent = "â¤ï¸".repeat(STATE.lives);
        document.getElementById('overlay-subtitle').textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„...";
        overlay.classList.add('show');
        setTimeout(() => { this.startLevel(currentLvl + 1); }, 2000);
    },

    levelFailed() {
        STATE.isTransitioning = true;
        const currentLvl = STATE.currentLevel;
        if (currentLvl >= 3) { this.stop(); return; }

        const overlay = document.getElementById('level-overlay');
        document.getElementById('overlay-title').textContent = "Ù†ÙØ°Øª Ø§Ù„Ù‚Ù„ÙˆØ¨!";
        document.getElementById('overlay-title').className = "text-4xl font-black text-red-500 mb-2";
        const config = LEVELS[currentLvl - 1];
        document.getElementById('overlay-stats').textContent = "ØªÙ… Ø¬Ù…Ø¹: " + toArNum(STATE.levelScore) + "/" + toArNum(config.target);
        document.getElementById('overlay-stats').className = "text-xl font-bold text-slate-400";
        document.getElementById('overlay-lives').textContent = "ğŸ’”";
        document.getElementById('overlay-subtitle').textContent = "ØªØ®Ø·ÙŠ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©...";
        overlay.classList.add('show');
        setTimeout(() => { this.startLevel(currentLvl + 1); }, 2000);
    },

    stop() {
        if (STATE.lives > 0) STATE.totalLivesSaved += STATE.lives;
        STATE.isPlaying = false;
        cancelAnimationFrame(this.animationId);
        showScreen('result-screen');
        
        const totalTargets = 30; // 15+10+5
        let grade = Math.ceil((STATE.totalScore / totalTargets) * 5);
        if(grade > 5) grade = 5; if(grade < 0) grade = 0;
        
        const heartsBonus = STATE.totalLivesSaved * 50;
        const lbScore = (STATE.totalScore * 100) + heartsBonus;

        document.getElementById('total-collected').textContent = toArNum(STATE.totalScore);
        document.getElementById('hearts-bonus').textContent = toArNum(heartsBonus);
        document.getElementById('final-grade').textContent = toArNum(grade);
        
        const feedbackEl = document.getElementById('feedback-text');
        if (grade === 5) feedbackEl.textContent = "Ù…Ø°Ù‡Ù„! Ø¹Ù„Ø§Ù…Ø© ÙƒØ§Ù…Ù„Ø©! ğŸŒŸ";
        else if (grade >= 3) feedbackEl.textContent = "Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù†!";
        else feedbackEl.textContent = "Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù‚Ù…Ø©.";

        if (lbScore > STATE.bestScore) { document.getElementById('new-record-badge').classList.remove('hidden'); } 
        else { document.getElementById('new-record-badge').classList.add('hidden'); }
        
        API.saveScore(lbScore, grade);
    },

    spawnItem() {
        if (this.canvas.width < 100) return;
        const config = LEVELS[STATE.currentLevel - 1];
        const isWrong = Math.random() < config.wrongRatio;
        const currentLevelData = this.levelData[STATE.currentLevel];
        const dataList = isWrong ? currentLevelData.nonMonomials : currentLevelData.monomials;
        const data = dataList[Math.floor(Math.random() * dataList.length)];
        const radius = 60; 
        this.items.push({
            x: Math.random() * (this.canvas.width - 2 * radius) + radius,
            y: -120, parts: data.parts, type: isWrong ? "not-monomial" : "monomial",
            speed: (4 + Math.random() * 3) * config.speed, radius: radius,
            angle: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.03
        });
    },

    measureMath(parts, fontSize) {
        this.ctx.save(); this.ctx.textAlign = 'left'; this.ctx.direction = 'ltr';
        let width = 0; this.ctx.font = `bold ${fontSize}px "Cairo", sans-serif`;
        parts.forEach(part => {
            const type = part.t || 'text';
            if (type === 'text') width += this.ctx.measureText(part.v).width;
            else if (type === 'sup') { this.ctx.font = `bold ${fontSize * 0.7}px "Cairo", sans-serif`; width += this.ctx.measureText(part.v).width; this.ctx.font = `bold ${fontSize}px "Cairo", sans-serif`; }
            else if (type === 'frac') { this.ctx.font = `bold ${fontSize * 0.8}px "Cairo", sans-serif`; const wNum = this.ctx.measureText(part.n).width; const wDen = this.ctx.measureText(part.d).width; width += Math.max(wNum, wDen) + 10; this.ctx.font = `bold ${fontSize}px "Cairo", sans-serif`; }
            else if (type === 'sqrt') { width += this.ctx.measureText(part.v).width + 20; }
        });
        this.ctx.restore(); return width;
    },

    drawMath(parts, centerX, centerY, maxWidth) {
        this.ctx.save(); this.ctx.textAlign = 'left'; this.ctx.direction = 'ltr'; 
        const fontSize = 36; const totalWidth = this.measureMath(parts, fontSize);
        this.ctx.translate(centerX, centerY);
        if (maxWidth && totalWidth > maxWidth) { const scale = maxWidth / totalWidth; this.ctx.scale(scale, scale); }
        let cursorX = totalWidth / 2; this.ctx.fillStyle = '#ffffff'; this.ctx.textBaseline = 'middle';
        parts.forEach(part => {
                const type = part.t || 'text'; this.ctx.font = `bold ${fontSize}px "Cairo", sans-serif`;
                if (type === 'text') { const w = this.ctx.measureText(part.v).width; cursorX -= w; this.ctx.fillText(part.v, cursorX, 0); } 
                else if (type === 'sup') { this.ctx.font = `bold ${fontSize * 0.7}px "Cairo", sans-serif`; const w = this.ctx.measureText(part.v).width; cursorX -= w; this.ctx.fillText(part.v, cursorX, -15); }
                else if (type === 'frac') { const fSize = fontSize * 0.8; this.ctx.font = `bold ${fSize}px "Cairo", sans-serif`; const wNum = this.ctx.measureText(part.n).width; const wDen = this.ctx.measureText(part.d).width; const maxWidthPart = Math.max(wNum, wDen) + 10; cursorX -= maxWidthPart; this.ctx.fillText(part.n, cursorX + (maxWidthPart - wNum)/2, -20); this.ctx.fillText(part.d, cursorX + (maxWidthPart - wDen)/2, 24); this.ctx.fillRect(cursorX + 2, 0, maxWidthPart - 4, 3); }
                else if (type === 'sqrt') { const wContent = this.ctx.measureText(part.v).width; const wTotal = wContent + 20; cursorX -= wTotal; this.ctx.lineWidth = 3; this.ctx.strokeStyle = '#fff'; this.ctx.beginPath(); this.ctx.moveTo(cursorX + wTotal, -8); this.ctx.lineTo(cursorX + wTotal - 6, 12); this.ctx.lineTo(cursorX + wTotal - 14, -22); this.ctx.lineTo(cursorX, -22); this.ctx.stroke(); this.ctx.fillText(part.v, cursorX + 6, 4); }
                cursorX -= 2;
        });
        this.ctx.restore();
    },

    drawShip() {
        this.ctx.save(); this.ctx.translate(this.player.x, this.player.y); const scale = 1.5;
        this.ctx.beginPath(); this.ctx.moveTo(-10 * scale, 20 * scale); this.ctx.lineTo(0, (35 + Math.random()*10) * scale); this.ctx.lineTo(10 * scale, 20 * scale); this.ctx.fillStyle = '#f59e0b'; this.ctx.fill();
        this.ctx.beginPath(); this.ctx.moveTo(0, -40 * scale); this.ctx.lineTo(25 * scale, 20 * scale); this.ctx.lineTo(0, 10 * scale); this.ctx.lineTo(-25 * scale, 20 * scale); this.ctx.closePath(); this.ctx.fillStyle = '#3b82f6'; this.ctx.fill(); this.ctx.lineWidth = 4; this.ctx.strokeStyle = '#60a5fa'; this.ctx.stroke();
        this.ctx.beginPath(); this.ctx.ellipse(0, -5 * scale, 8 * scale, 15 * scale, 0, 0, Math.PI * 2); this.ctx.fillStyle = '#bae6fd'; this.ctx.fill(); this.ctx.restore();
    },

    loop() {
        if (!STATE.isPlaying || STATE.isTransitioning) return;
        if (this.canvas.width === 0) { this.animationId = requestAnimationFrame(() => this.loop()); return; }
        this.ctx.fillStyle = '#0f172a'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.fillStyle = '#ffffff'; for(let i=0; i<8; i++) { this.ctx.fillRect(Math.random() * this.canvas.width, Math.random() * this.canvas.height, 3, 3); }
        this.drawShip();
        this.frameCount++; if (this.frameCount % Math.floor(this.spawnRate) === 0) { this.spawnItem(); }
        for (let i = this.items.length - 1; i >= 0; i--) {
            let item = this.items[i]; item.y += item.speed; item.angle += item.rotationSpeed;
            this.ctx.save(); this.ctx.translate(item.x, item.y); this.ctx.rotate(item.angle);
            this.ctx.beginPath(); this.ctx.arc(0, 0, item.radius, 0, Math.PI*2); this.ctx.fillStyle = 'rgba(59, 130, 246, 0.25)'; this.ctx.strokeStyle = '#60a5fa'; this.ctx.lineWidth = 4; this.ctx.fill(); this.ctx.stroke();
            this.ctx.beginPath(); this.ctx.arc(0, 0, item.radius - 10, 0, Math.PI*2); this.ctx.strokeStyle = 'rgba(147, 197, 253, 0.5)'; this.ctx.lineWidth = 2; this.ctx.stroke();
            this.ctx.rotate(-item.angle); this.ctx.shadowColor = "rgba(0,0,0,1)"; this.ctx.shadowBlur = 4;
            this.drawMath(item.parts, 0, 0, item.radius * 2 - 30); this.ctx.shadowBlur = 0; this.ctx.restore();
            const dx = item.x - this.player.x; const dy = item.y - this.player.y;
            if (Math.sqrt(dx*dx + dy*dy) < item.radius + 30) {
                if (item.type === 'monomial') {
                    STATE.levelScore++; STATE.totalScore++; this.createParticles(item.x, item.y, '#4ade80'); this.updateHUD();
                    const config = LEVELS[STATE.currentLevel - 1]; if (STATE.levelScore >= config.target) { this.nextLevel(); this.items = []; return; }
                } else {
                    STATE.lives--; this.updateHUD(); this.createParticles(item.x, item.y, '#f87171');
                    if (STATE.lives <= 0) { this.levelFailed(); this.items = []; return; }
                }
                this.items.splice(i, 1); continue;
            }
            if (item.y > this.canvas.height + 100) this.items.splice(i, 1);
        }
        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            this.ctx.globalAlpha = p.life; this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 4, 0, Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha = 1.0;
            if (p.life <= 0) this.particles.splice(i, 1);
        }
        this.animationId = requestAnimationFrame(() => this.loop());
    },

    createParticles(x, y, color) { for(let i=0; i<10; i++) { this.particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, life: 1.0, color: color }); } }
};

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.classList.add('visually-hidden'); });
    const s = document.getElementById(screenId); s.classList.remove('visually-hidden');
    setTimeout(() => s.classList.add('active'), 10);
}

document.addEventListener('DOMContentLoaded', () => {
    API.fetchStudentData(); API.fetchLeaderboard(); Game.init();
    document.getElementById('start-btn').addEventListener('click', () => { showScreen('game-screen'); setTimeout(() => Game.start(), 50); });
    document.getElementById('restart-btn').addEventListener('click', () => { showScreen('game-screen'); setTimeout(() => Game.start(), 50); });
    document.getElementById('exit-btn').addEventListener('click', () => { if(window.parent) window.parent.postMessage('gameFinished', '*'); window.location.reload(); });
});

</script>
</body>
</html>

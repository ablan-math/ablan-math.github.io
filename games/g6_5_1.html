<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªØ¹Ù„Ù… - V19.10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 450px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; max-height: 98vh; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b;
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ (Stepper) */
        #game-stepper {
            display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; padding: 10px;
            background: #f1f5f9; border-radius: 1rem; margin-bottom: 10px; scrollbar-width: none;
        }
        #game-stepper::-webkit-scrollbar { display: none; }
        .step-item { padding: 4px 12px; border-radius: 999px; font-size: 10px; font-weight: 800; color: #94a3b8; border: 2px solid transparent; }
        .step-active { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; }

        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© */
        .math-display { font-family: 'Tajawal', serif; display: inline-flex; align-items: center; justify-content: center; line-height: 1.2; direction: rtl; }
        .exponent { font-size: 0.75em; vertical-align: super; position: relative; top: -0.45em; right: 0.05em; font-weight: 800; color: #2563eb; margin-right: -0.1em; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 8px; line-height: 1; }
        .numerator { padding: 2px 6px; }
        .denominator { border-top: 2.5px solid currentColor; padding: 2px 6px; width: 100%; text-align: center; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª 2x2 */
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        .btn-option { 
            min-height: 70px; background: white; border: 2px solid #e2e8f0; border-radius: 1.2rem;
            display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem;
            transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .btn-option:active { background: #f8fafc; border-color: #3b82f6; transform: scale(0.96); }

        .leaderboard-modal { position: absolute; inset: 0; background: #ffffff; z-index: 100; display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        
        .timer-badge { background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 9999px; font-weight: 900; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-2 text-right">

    <div class="compact-card">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Smart Identity) -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-graduation-cap text-blue-600"></i>
                <span id="top-student-name" class="truncate font-black">Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ</span>
                <script>
                    (function() {
                        const p = new URLSearchParams(window.location.search);
                        const raw = p.get('name') || p.get('studentName') || p.get('username') || p.get('user');
                        const display = document.getElementById('top-student-name');
                        if (raw) display.textContent = decodeURIComponent(raw);
                    })();
                </script>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <span id="sync-icon" class="hidden"><i class="fas fa-sync fa-spin text-blue-400"></i></span>
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">Ù  / Ù¥</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="p-8 text-center flex flex-col gap-5 h-full justify-center">
            <div class="text-7xl mb-2 animate-bounce">ğŸ“</div>
            <h1 class="text-2xl font-black text-slate-800">Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„ØªØ¹Ù„Ù…</h1>
            <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 text-[13px] font-bold text-indigo-700 leading-relaxed shadow-sm">
                Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠ ÙˆØ­ÙŠØ¯Ø§Øª Ø§Ù„Ø­Ø¯! <br>
                ØªØ¹Ù„Ù… Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ØŒ ØªØ¯Ø±Ø¨ Ø¨Ø°ÙƒØ§Ø¡ØŒ ÙˆØ­Ø·Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†.
            </div>
            <div class="flex flex-row gap-2 mt-2">
                <button onclick="startGame()" class="btn-touch flex-[3.5] bg-blue-600 text-white shadow-xl text-lg">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© <i class="fas fa-play-circle mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch flex-1 bg-white text-slate-600 border border-slate-200">
                    <i class="fas fa-trophy text-yellow-500 text-2xl"></i>
                </button>
            </div>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase italic">Ø¥ØµØ¯Ø§Ø± V19.10 Ø§Ù„Ø°Ù‡Ø¨ÙŠ</p>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (#game-screen) -->
        <div id="game-screen" class="hidden p-4 flex flex-col h-full overflow-hidden">
            <div id="game-stepper">
                <div id="step-intro" class="step-item step-active">Ø§Ù„ØªÙ…Ù‡ÙŠØ¯</div>
                <div id="step-0" class="step-item">Ø§Ù„Ø¬Ù…Ø¹</div>
                <div id="step-1" class="step-item">Ø§Ù„Ø¶Ø±Ø¨</div>
                <div id="step-2" class="step-item">Ø§Ù„Ù‚ÙˆØ©</div>
                <div id="step-exam" class="step-item">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
            </div>

            <div id="academy-content" class="flex-1 flex flex-col justify-center overflow-y-auto px-1">
                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ­Ù‚Ù† Ù‡Ù†Ø§ -->
            </div>

            <div id="academy-controls" class="flex justify-between items-center pt-4 border-t border-slate-100 mt-2">
                <button id="academy-back" onclick="goBack()" class="bg-slate-100 text-slate-500 px-6 py-2 rounded-xl font-bold text-xs">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <div id="timer-display" class="hidden timer-badge">Ù Ù :Ù Ù </div>
                <button id="academy-next" onclick="handleAcademyAction()" class="bg-blue-600 text-white px-10 py-2 rounded-xl font-bold shadow-md text-xs">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø« V19.10) -->
        <div id="result-screen" class="hidden p-6 flex flex-col h-full text-center justify-center overflow-y-auto">
            <div id="final-stats" class="grid grid-cols-3 gap-2 mb-6"></div>
            
            <div class="bg-emerald-50 p-5 rounded-3xl border border-emerald-100 mb-6 shadow-sm">
                <i class="fas fa-check-double text-emerald-500 text-4xl mb-2"></i>
                <p id="save-msg" class="font-black text-emerald-800 text-sm">Ø¨Ø·Ù„! ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯Ø±Ø¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.</p>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch bg-blue-600 text-white shadow-lg">
                    <i class="fas fa-crown ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
                </button>
                <div class="flex gap-2">
                    <button onclick="resetToExam()" class="btn-touch flex-1 bg-amber-500 text-white text-xs">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ”„</button>
                    <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-800 text-white text-xs">Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙƒØ§Ù…Ù„Ø©</button>
                </div>
                <button id="finish-btn" class="btn-touch w-full bg-slate-200 text-slate-700 text-sm font-black">Ø¥Ù†Ù‡Ù€Ù€Ù€Ø§Ø¡</button>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
                <button onclick="closeLeaderboardModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn tab-inactive">Ø£Ø¨Ø·Ø§Ù„ ÙØµÙ„ÙŠ</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn tab-active">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl p-1 relative">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><i class="fas fa-sync fa-spin text-blue-500 text-3xl"></i></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = 'g6_5_1'; // Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø§Ù„ØµØ§Ø±Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || "Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ");
        
        let academyPhase = 'intro';
        let moduleIdx = 0;
        let practiceIdx = 0;
        let examIdx = 0;
        let examScore = 0;
        let examTries = 0;
        let seconds = 0;
        let timerInt = null;
        let selectedQuestions = [];
        let localVisitorResult = null;
        let currentLeaderboardMode = classId ? 'class' : 'global';

        const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

        // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©
        const exp = (v) => `<span class="exponent">${v}</span>`;
        const frc = (n, d) => `<div class="fraction"><div class="numerator">${n}</div><div class="denominator">${d}</div></div>`;

        const questionBank = [
            { q: `Ù¥Ø³${exp('Ù¢')} + Ù¢Ø³${exp('Ù¢')}`, a: [`Ù§Ø³${exp('Ù¢')}`, `Ù§Ø³${exp('Ù¤')}`, `Ù¡Ù Ø³${exp('Ù¢')}`, `Ù¥Ù¢Ø³`], c: 0 },
            { q: `Ù¨Øµ${exp('Ù£')} - Ù¥Øµ${exp('Ù£')}`, a: [`Ù£Øµ${exp('Ù£')}`, `Ù£`, `Ù¡Ù£Øµ${exp('Ù£')}`, `Ù£Øµ${exp('Ù ')}`], c: 0 },
            { q: `Ø³${exp('Ù¤')} + Ø³${exp('Ù¤')}`, a: [`Ù¢Ø³${exp('Ù¤')}`, `Ø³${exp('Ù¨')}`, `Ù¢Ø³${exp('Ù¨')}`, `Ø³${exp('Ù¡Ù¦')}`], c: 0 },
            { q: `Ù¡Ù Ø¹${exp('Ù¥')} - Ø¹${exp('Ù¥')}`, a: [`Ù©Ø¹${exp('Ù¥')}`, `Ù©`, `Ù¡Ù¡Ø¹${exp('Ù¥')}`, `Ù¡Ù Ø¹`], c: 0 },
            { q: `Ù£Ø³${exp('Ù¢')} Ã— Ù¤Ø³${exp('Ù£')}`, a: [`Ù¡Ù¢Ø³${exp('Ù¥')}`, `Ù¡Ù¢Ø³${exp('Ù¦')}`, `Ù§Ø³${exp('Ù¥')}`, `Ù¡Ù¢Ø³`], c: 0 },
            { q: frc(`Ù¢Ù Ø³${exp('Ù¦')}`, `Ù¥Ø³${exp('Ù¢')}`), a: [`Ù¤Ø³${exp('Ù¤')}`, `Ù¤Ø³${exp('Ù£')}`, `Ù¡Ù¥Ø³${exp('Ù¤')}`, `Ù¤Ø³${exp('Ù¨')}`], c: 0 },
            { q: `Øµ${exp('Ù§')} Ã— Øµ${exp('Ù¢')}`, a: [`Øµ${exp('Ù©')}`, `Øµ${exp('Ù¡Ù¤')}`, `Ù¢Øµ${exp('Ù©')}`, `Øµ${exp('Ù¥')}`], c: 0 },
            { q: frc(`Ø¹${exp('Ù¨')}`, `Ø¹${exp('Ù¨')}`), a: [`Ù¡`, `Ø¹`, `Ù `, `Ø¹${exp('Ù¡Ù¦')}`], c: 0 },
            { q: `(Ø³${exp('Ù¥')})${exp('Ù¢')}`, a: [`Ø³${exp('Ù¡Ù ')}`, `Ø³${exp('Ù§')}`, `Ø³${exp('Ù¢Ù¥')}`, `Ù¢Ø³${exp('Ù¥')}`], c: 0 },
            { q: `(Øµ${exp('Ù£')})${exp('Ù¤')}`, a: [`Øµ${exp('Ù¡Ù¢')}`, `Øµ${exp('Ù§')}`, `Øµ${exp('Ù¨Ù¡')}`, `Ù¤Øµ${exp('Ù£')}`], c: 0 },
            { q: `Ø³${exp('Ù¢')} + Ø³${exp('Ù¢')} Ã— Ø³`, a: [`Ø³${exp('Ù¢')} + Ø³${exp('Ù£')}`, `Ù¢Ø³${exp('Ù£')}`, `Ø³${exp('Ù¥')}`, `Ù¢Ø³${exp('Ù¢')}`], c: 0 },
            { q: `Ù¢Ø³ Ã— Ù£Ø³`, a: [`Ù¦Ø³${exp('Ù¢')}`, `Ù¦Ø³`, `Ù¥Ø³${exp('Ù¢')}`, `Ù¦`], c: 0 },
            { q: `(Ù¢Ø³${exp('Ù¢')})${exp('Ù£')}`, a: [`Ù¨Ø³${exp('Ù¦')}`, `Ù¢Ø³${exp('Ù¦')}`, `Ù¨Ø³${exp('Ù¥')}`, `Ù¦Ø³${exp('Ù¦')}`], c: 0 },
            { q: frc(`Ù¡Ù¨Øµ${exp('Ù©')}`, `Ù£Øµ${exp('Ù£')}`), a: [`Ù¦Øµ${exp('Ù¦')}`, `Ù¦Øµ${exp('Ù£')}`, `Ù¡Ù¥Øµ${exp('Ù¦')}`, `Ù¦Øµ${exp('Ù¡Ù¢')}`], c: 0 },
            { q: `Ù¤Ø¨${exp('Ù ')}`, a: [`Ù¤`, `Ù¤Ø¨`, `Ù `, `Ù¡`], c: 0 }
        ];

        const modules = [
            { id: 1, title: "Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø·Ø±Ø­", rule: "ÙŠØ¬Ø¨ ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„Ø£Ø³ ØªÙ…Ø§Ù…Ø§Ù‹. Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙ‚Ø· ÙˆÙ†Ø¨Ù‚ÙŠ Ø§Ù„Ø£Ø³ ÙƒÙ…Ø§ Ù‡Ùˆ.", formulas: [`Ù¥Ø³${exp('Ù£')} + Ù¢Ø³${exp('Ù£')} = Ù§Ø³${exp('Ù£')}`, `Ù©Øµ${exp('Ù¤')} - Ù£Øµ${exp('Ù¤')} = Ù¦Øµ${exp('Ù¤')}`], questions: [{q:`Ù¦Øµ${exp('Ù£')} - Ù¢Øµ${exp('Ù£')}`, o:[`Ù¤Øµ${exp('Ù£')}`, `Ù¤Øµ${exp('Ù ')}`, `Ù¨Øµ${exp('Ù£')}`, `Ù¤`], c:0}, {q:`Ù£Øµ${exp('Ù¥')} + Øµ${exp('Ù¥')}`, o:[`Ù¤Øµ${exp('Ù¥')}`, `Ù£Øµ${exp('Ù¡Ù ')}`, `Ù¤Øµ${exp('Ù¡Ù ')}`, `Ù£Øµ${exp('Ù¥')}`], c:0}] },
            { id: 2, title: "Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø©", rule: "ÙŠÙƒÙÙŠ ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ø­Ø±Ù. ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø³ØŒ ÙˆÙÙŠ Ø§Ù„Ù‚Ø³Ù…Ø© Ù†Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø³.", formulas: [`Ù£Ø³${exp('Ù¢')} Ã— Ù¥Ø³${exp('Ù¤')} = Ù¡Ù¥Ø³${exp('Ù¦')}`, `${frc('Ù¡Ù¢Ø³'+exp('Ù¨'), 'Ù¤Ø³'+exp('Ù¢'))} = Ù£Ø³${exp('Ù¦')}`], questions: [{q:`Ù¥Ø³${exp('Ù¤')} Ã— Ù¢Ø³${exp('Ù£')}`, o:[`Ù¡Ù Ø³${exp('Ù§')}`, `Ù¡Ù Ø³${exp('Ù¡Ù¢')}`, `Ù§Ø³${exp('Ù§')}`, `Ù¡Ù Ø³`], c:0}, {q:frc('Ù¡Ù¢Øµ'+exp('Ù¨'), 'Ù£Øµ'+exp('Ù¢')), o:[`Ù¤Øµ${exp('Ù¦')}`, `Ù¤Øµ${exp('Ù¤')}`, `Ù©Øµ${exp('Ù¦')}`, `Ù¤Øµ${exp('Ù¡Ù ')}`], c:0}] },
            { id: 3, title: "Ù‚ÙˆØ© Ø§Ù„Ù‚ÙˆØ©", rule: "Ø¹Ù†Ø¯ Ø±ÙØ¹ ÙˆØ­ÙŠØ¯Ø© Ø­Ø¯ Ù„Ø£Ø³ÙŠÙ†ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¶Ø±Ø¨ Ø§Ù„Ø£Ø³ÙŠÙ† Ø¨Ø¨Ø¹Ø¶Ù‡Ù…Ø§ ÙÙˆØ±Ø§Ù‹.", formulas: [`(Ø³${exp('Ù¥')})${exp('Ù£')} = Ø³${exp('Ù¡Ù¥')}`], questions: [{q:`(Øµ${exp('Ù£')})${exp('Ù¥')}`, o:[`Øµ${exp('Ù¡Ù¥')}`, `Øµ${exp('Ù¨')}`, `Øµ${exp('Ù£Ù¥')}`, `Øµ${exp('Ù£')}${exp('Ù¥')}`], c:0}] }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if (studentId && classId) fetchInitialCloudData();
            else if (!urlParams.get('name')) { studentName = "Ø¨Ø·Ù„ Ø²Ø§Ø¦Ø±"; document.getElementById('top-student-name').textContent = studentName; }
            if (!classId) document.getElementById('tab-class').style.display = 'none';
        });

        async function fetchInitialCloudData() {
            try {
                document.getElementById('sync-icon').classList.remove('hidden');
                const res = await (await fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`)).json();
                if (res.status === 'success' && res.data) {
                    if (res.data.name) { studentName = res.data.name; document.getElementById('top-student-name').textContent = studentName; }
                    if (res.data.games && res.data.games[GAME_ID]) document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / Ù¥";
                }
            } finally { document.getElementById('sync-icon').classList.add('hidden'); }
        }

        window.startGame = () => { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden'); renderAcademy(); };

        function renderAcademy() {
            const area = document.getElementById('academy-content');
            const nextBtn = document.getElementById('academy-next');
            const backBtn = document.getElementById('academy-back');
            area.innerHTML = '';
            updateStepper();
            nextBtn.classList.remove('hidden');
            backBtn.classList.toggle('hidden', academyPhase === 'intro' || academyPhase === 'exam');

            if (academyPhase === 'intro') {
                area.innerHTML = `<div class="text-center fade-in space-y-4 pt-8"><div class="text-6xl">ğŸ’¡</div><h2 class="text-lg font-black text-slate-800 underline underline-offset-8">Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹</h2><div class="space-y-3"><div class="p-4 bg-red-50 rounded-2xl border text-center shadow-sm"><h3 class="font-black text-red-700 text-xs mb-1">Ù¡. Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø·Ø±Ø­</h3><p class="text-xs">Ø§Ù„Ø£Ø³ Ø«Ø§Ø¨Øª Ù„Ø§ ÙŠØªØºÙŠØ±. Ø³${exp('Ù¢')} + Ø³${exp('Ù¢')} = Ù¢Ø³${exp('Ù¢')}</p></div><div class="p-4 bg-green-50 rounded-2xl border text-center shadow-sm"><h3 class="font-black text-green-700 text-xs mb-1">Ù¢. Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø©</h3><p class="text-xs">Ù†Ø¬Ù…Ø¹ Ø£Ùˆ Ù†Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø³. Ø³${exp('Ù¢')} Ã— Ø³${exp('Ù£')} = Ø³${exp('Ù¥')}</p></div></div></div>`;
                nextBtn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ù„Ù…";
            }
            else if (academyPhase === 'tutorial') {
                const mod = modules[moduleIdx];
                area.innerHTML = `<div class="fade-in space-y-4"><h2 class="text-lg font-black text-blue-700 border-b-2 border-blue-50 pb-1">${mod.title}</h2><div class="bg-indigo-50 p-5 rounded-3xl space-y-4 shadow-inner"><p class="text-xs font-bold text-slate-700 leading-relaxed">${mod.rule}</p>${mod.formulas.map(f => `<div class="bg-white p-3 rounded-xl border flex justify-center text-xl font-bold math-display shadow-sm">${f}</div>`).join('')}</div><div class="bg-yellow-50 p-3 rounded-xl border border-yellow-200 text-yellow-800 text-[10px] font-bold flex items-center gap-3"><span class="text-2xl">ğŸ’¡</span> ${mod.tip || 'Ø§Ù„ØªØ±ÙƒÙŠØ² Ù‡Ùˆ Ø³Ø± Ø§Ù„ØªÙ…ÙŠØ²!'}</div></div>`;
                nextBtn.innerText = "ØªØ¯Ø±ÙŠØ¨ Ø³Ø±ÙŠØ¹";
            }
            else if (academyPhase === 'practice') {
                const pr = modules[moduleIdx].questions[practiceIdx];
                area.innerHTML = `<div class="fade-in space-y-5"><div class="flex justify-between items-center"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-black">ØªÙ…Ø±ÙŠÙ† ØªØ·Ø¨ÙŠÙ‚</span></div><div class="bg-slate-50 p-10 rounded-[2.5rem] border-4 border-dashed border-slate-200 flex justify-center items-center text-4xl font-black math-display text-slate-800">${pr.q}</div><div class="options-grid">${pr.o.map((o, i) => `<button onclick="checkPractice(${i})" class="btn-option math-display shadow-md">${o}</button>`).join('')}</div><div id="p-fb" class="hidden p-3 rounded-2xl text-center font-black text-xs"></div></div>`;
                nextBtn.classList.add('hidden');
            }
            else if (academyPhase === 'examWarning') {
                area.innerHTML = `<div class="text-center fade-in space-y-6 pt-6"><div class="text-7xl text-red-500">ğŸš©</div><h2 class="text-xl font-black text-red-600">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2><div class="bg-red-50 p-6 rounded-3xl text-right text-[11px] font-bold leading-relaxed space-y-2"><li>Ù¡Ù  Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.</li><li>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù€ Ù¢ Ù†Ù‚Ø·Ø©.</li><li>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù€ Ù¡ Ù†Ù‚Ø·Ø©.</li><li>Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒÙ„ÙŠ.</li></div><p class="text-indigo-600 font-black text-sm">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: Ù¢Ù  Ù†Ù‚Ø·Ø© | Ø§Ù„Ø¯Ø±Ø¬Ø© Ù…Ù† Ù¥</p></div>`;
                nextBtn.innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±";
            }
            else if (academyPhase === 'exam') {
                const q = selectedQuestions[examIdx];
                document.getElementById('timer-display').classList.remove('hidden');
                area.innerHTML = `<div class="fade-in space-y-5"><div class="flex justify-between items-center"><span id="try-badge" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</span><span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-[10px] font-black">Ø³Ø¤Ø§Ù„ ${toAr(examIdx+1)} Ù…Ù† Ù¡Ù </span></div><div class="bg-indigo-900 p-12 rounded-[3rem] flex justify-center items-center text-5xl text-white font-black math-display shadow-2xl">${q.q}</div><div class="options-grid">${q.a.map((o, i) => `<button id="eo-${i}" onclick="checkExam(${i})" class="btn-option math-display shadow-lg">${o}</button>`).join('')}</div><div id="e-fb" class="hidden p-3 rounded-2xl text-center font-black text-xs"></div></div>`;
                nextBtn.classList.add('hidden');
            }
        }

        window.handleAcademyAction = () => {
            if (academyPhase === 'intro') academyPhase = 'tutorial';
            else if (academyPhase === 'tutorial') academyPhase = 'practice';
            else if (academyPhase === 'examWarning') startExam();
            renderAcademy();
        };

        window.goBack = () => {
            if (academyPhase === 'tutorial') academyPhase = (moduleIdx === 0) ? 'intro' : 'practice';
            else if (academyPhase === 'practice') { if (practiceIdx > 0) practiceIdx--; else academyPhase = 'tutorial'; }
            renderAcademy();
        };

        window.checkPractice = (idx) => {
            const pr = modules[moduleIdx].questions[practiceIdx];
            const fb = document.getElementById('p-fb');
            fb.classList.remove('hidden');
            if (idx === pr.c) {
                fb.innerHTML = `Ø±Ø§Ø¦Ø¹! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆÙ…ØªÙ…ÙŠØ²Ø©`; fb.className = "p-3 rounded-2xl text-center font-black text-xs bg-green-100 text-green-700";
                setTimeout(() => {
                    if (practiceIdx < modules[moduleIdx].questions.length - 1) practiceIdx++;
                    else { practiceIdx = 0; if (moduleIdx < modules.length - 1) { moduleIdx++; academyPhase = 'tutorial'; } else academyPhase = 'examWarning'; }
                    renderAcademy();
                }, 1000);
            } else {
                fb.innerHTML = `Ø§Ù†ØªØ¨Ù‡ Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹`; fb.className = "p-3 rounded-2xl text-center font-black text-xs bg-red-100 text-red-700";
            }
        };

        function startExam() {
            selectedQuestions = shuffleArray([...questionBank]).slice(0, 10).map(q => {
                const ans = shuffleArray([...q.a]);
                return { q: q.q, a: ans, c: ans.indexOf(q.a[q.c]) };
            });
            academyPhase = 'exam'; examIdx = 0; examScore = 0; seconds = 0;
            timerInt = setInterval(() => { seconds++; document.getElementById('timer-display').innerText = toAr(formatTime(seconds)); }, 1000);
        }

        window.checkExam = (idx) => {
            const q = selectedQuestions[examIdx];
            const fb = document.getElementById('e-fb');
            const btn = document.getElementById(`eo-${idx}`);
            fb.classList.remove('hidden');
            if (idx === q.c) {
                examScore += (examTries === 0 ? 2 : 1);
                fb.innerHTML = `ØµØ­ÙŠØ­! +${toAr(examTries === 0 ? 2 : 1)} Ù†Ù‚Ø·Ø©`; fb.className = "p-2 rounded-xl bg-green-50 text-green-700";
                document.querySelectorAll('.btn-option').forEach(b => b.style.pointerEvents = 'none');
                setTimeout(() => {
                    if (examIdx < 9) { examIdx++; examTries = 0; renderAcademy(); }
                    else finishAcademy();
                }, 800);
            } else {
                examTries++; btn.classList.add('opacity-40'); btn.disabled = true;
                if (examTries === 1) {
                    fb.innerText = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®ÙŠØ±Ø© (Ù¡ Ù†Ù‚Ø·Ø©)"; fb.className = "p-2 rounded-xl bg-orange-50 text-orange-600";
                    document.getElementById('try-badge').innerText = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©"; document.getElementById('try-badge').className = "bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-[10px] font-black";
                } else {
                    fb.innerText = "Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.."; fb.className = "p-2 rounded-xl bg-red-50 text-red-600";
                    setTimeout(() => { examIdx++; examTries = 0; if (examIdx < 10) renderAcademy(); else finishAcademy(); }, 1000);
                }
            }
        };

        function finishAcademy() {
            clearInterval(timerInt);
            const grade = (examScore / 20 * 5).toFixed(1);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 flex flex-col justify-center shadow-inner">
                    <p class="text-[8px] font-black text-blue-400 uppercase">Ù†Ù‚Ø§Ø·Ùƒ</p>
                    <p class="text-sm font-black text-blue-900">${toAr(examScore)} / Ù¢Ù </p>
                </div>
                <div class="bg-emerald-50 p-3 rounded-2xl border border-emerald-100 flex flex-col justify-center shadow-md ring-4 ring-emerald-50">
                    <p class="text-[8px] font-black text-emerald-600 uppercase">Ø§Ù„Ø¯Ø±Ø¬Ø©</p>
                    <p class="text-xl font-black text-emerald-900">${toAr(grade)}</p>
                </div>
                <div class="bg-purple-50 p-3 rounded-2xl border border-purple-100 flex flex-col justify-center shadow-inner">
                    <p class="text-[8px] font-black text-purple-400 uppercase">Ø§Ù„ÙˆÙ‚Øª</p>
                    <p class="text-sm font-black text-purple-900">${toAr(formatTime(seconds))}</p>
                </div>
            `;
            if (studentId && classId) saveScore(grade, seconds);
            else { localVisitorResult = { name: studentName, grade: grade, metric: seconds, isLocal: true }; fetchAndShowLeaderboard(false); }
        }

        window.resetToExam = () => {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            academyPhase = 'examWarning';
            renderAcademy();
        };

        async function saveScore(g, met) {
            const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: g, metricValue: met, type: 'game' });
            try { await fetch(`${SCRIPT_URL}?${p.toString()}`); } finally { fetchAndShowLeaderboard(false); }
        }

        window.fetchAndShowLeaderboard = function(manual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (manual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClass = (currentLeaderboardMode === 'class') ? classId : 'all';
            fetch(`${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClass || 'all')}&t=${Date.now()}`).then(r => r.json()).then(res => {
                let data = (res.status === 'success' && res.data) ? res.data : [];
                if (localVisitorResult && (currentLeaderboardMode === 'global' || !classId)) {
                    if (!data.find(p => p.name === localVisitorResult.name)) data.push(localVisitorResult);
                    data.sort((a,b) => parseFloat(b.grade) - parseFloat(a.grade) || parseFloat(a.metric) - parseFloat(b.metric));
                }
                let h = `<table class="w-full text-right text-[10px] border-collapse"><thead class="text-slate-400 border-b bg-slate-50/50"><tr><th class="p-2 text-center">#</th><th class="p-2">Ø§Ù„Ø¨Ø·Ù„</th><th class="p-2 text-center text-emerald-600">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody>`;
                data.forEach((p, i) => {
                    const isMe = (p.isLocal || (studentId && String(p.name).trim() === String(studentName).trim()));
                    h += `<tr class="${isMe ? 'bg-blue-50/50 border-r-4 border-blue-600' : ''}"><td class="p-2 text-center font-black">${i<3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : toAr(i+1)}</td><td class="p-2 font-bold ${isMe ? 'text-blue-700':'text-slate-700'}">${p.name} ${isMe ? '<span class="bg-blue-600 text-white text-[7px] px-1 rounded-full mx-1 font-black">Ø£Ù†Øª</span>' : ''}</td><td class="p-2 text-center"><span class="text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</span> <span class="text-[7px] text-slate-400 block">(${toAr(formatTime(p.metric || p.metricValue || 0))})</span></td></tr>`;
                });
                document.getElementById('leaderboard-content').innerHTML = data.length > 0 ? h + `</tbody></table>` : `<div class="py-10 text-center text-slate-400 text-xs italic font-bold">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„..</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.switchTab = (m) => { currentLeaderboardMode = m; document.getElementById('tab-class').className = m === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; document.getElementById('tab-global').className = m === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; fetchAndShowLeaderboard(false); };
        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
        function updateStepper() {
            const steps = ['step-intro', 'step-0', 'step-1', 'step-2', 'step-exam'];
            let activeId = (academyPhase === 'intro' || academyPhase === 'overview') ? 'step-intro' : (academyPhase === 'exam' || academyPhase === 'examWarning') ? 'step-exam' : `step-${moduleIdx}`;
            steps.forEach(id => { const el = document.getElementById(id); if (el) { el.classList.remove('step-active'); if (el.id === activeId) { el.classList.add('step-active'); el.scrollIntoView({ behavior: 'smooth', inline: 'center' }); } } });
        }
        function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
        function formatTime(s) { const m = Math.floor(s / 60); const sec = s % 60; return `${m < 10 ? '0' + m : m}:${sec < 10 ? '0' + sec : sec}`; }
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٥-٤: حل نظام من معادلتين بالحذف باستعمال الضرب | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .step-box { border-right: 4px solid #9333ea; /* purple-600 */ }
        .math-eq { font-family: "Courier New", monospace; font-size: 1.2rem; font-weight: bold; color: #4338ca; background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 4px 10px; border-radius: 6px; display: inline-flex; align-items: center; vertical-align: middle; transition: all 0.3s ease-in-out; }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateY(10px); }
        .step-interactive.active { display: block; opacity: 1; transform: translateY(0); }
        .highlight-number {
            background-color: #fef9c3; /* yellow-100 */
            color: #b45309; /* amber-700 */
            padding: 1px 5px;
            border-radius: 4px;
            border: 1px solid #fde047; /* yellow-300 */
            font-weight: bold;
        }
        .target-term {
            outline: 2px solid #ef4444; /* red-500 */
            box-shadow: 0 0 10px #f43f5e;
            border-radius: 4px;
            transition: all 0.3s ease-in-out;
        }
        .eq-1-color { color: #2563eb; /* blue-600 */ }
        .eq-2-color { color: #16a34a; /* green-600 */ }
        .eq-3-color { color: #9333ea; /* purple-600 */ }
        .eq-4-color { color: #c2410c; /* orange-600 */ }
        .eq-5-color { color: #0891b2; /* cyan-600 */ }
        .eq-1-bg { background-color: #dbeafe; border-color: #93c5fd; }
        .eq-2-bg { background-color: #dcfce7; border-color: #86efac; }
        .eq-3-bg { background-color: #f3e8ff; border-color: #d8b4fe; }
        .eq-4-bg { background-color: #ffedd5; border-color: #fed7aa; }
        .eq-5-bg { background-color: #cffafe; border-color: #a5f3fc; }
        .temp-comment {
            transition: opacity 0.3s ease-in-out;
            min-height: 56px; /* To prevent layout shift for two lines */
        }
        .multiplier {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateX(-10px);
            font-size: 1.1rem; /* Smaller font size */
        }
        .multiplier.visible {
            opacity: 1;
            transform: translateX(0);
        }
        .visual-workspace .math-eq { width: 100%; text-align: center; }
        .visual-workspace {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .visual-workspace.visible {
            opacity: 1;
        }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .fraction { display: inline-flex; flex-direction: column; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > .frac-bar { border-top: 2px solid currentColor; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-purple-800">الدرس ٥-٤: حل نظام من معادلتين بالحذف باستعمال الضرب</h1>
                </header>
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفهوم الأساسي</h2>
                    <div class="p-4 bg-purple-50 rounded-lg space-y-3">
                        <p>لحل نظام معادلات بالحذف، قد نحتاج لضرب إحدى المعادلتين أو كلتيهما في عدد ثابت لجعل معاملات أحد المتغيرين متعاكسة.</p>
                        <ol class="list-decimal pr-8 space-y-2">
                            <li><strong>الخطوة ١:</strong> اختر متغيراً لحذفه، واضرب المعادلات في أعداد مناسبة لجعل معاملي هذا المتغير متعاكسين (مثل <span class="highlight-number">٦</span> و <span class="highlight-number">-٦</span>).</li>
                            <li><strong>الخطوة ٢:</strong> اجمع المعادلتين الجديدتين للتخلص من المتغير، وحل المعادلة الناتجة.</li>
                            <li><strong>الخطوة ٣:</strong> عوّض القيمة الناتجة في أي من المعادلات الأصلية لإيجاد قيمة المتغير الثاني.</li>
                        </ol>
                    </div>
                </section>
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: أمثلة تفاعلية</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div class="flex flex-col space-y-8">
                            
                            <!-- صف الأمثلة الأول -->
                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- المثال الأول -->
                                <div id="interactive-container-1" class="p-4 bg-white rounded-lg shadow">
                                    <p class="text-lg font-semibold mb-2">مثال ١: ضرب إحدى المعادلتين</p>
                                    <div class="mb-4 p-3 bg-gray-100 rounded-lg text-center">
                                        <p class="font-semibold mb-2">حل النظام الآتي:</p>
                                        <div class="inline-block text-left">
                                            <p class="math-eq eq-1-bg eq-1-color">٢س + ص = ٢٣</p><br>
                                            <p class="math-eq eq-2-bg eq-2-color">٣س + ٢ص = ٣٧</p>
                                        </div>
                                    </div>
                                    <div id="visual-workspace-1" class="visual-workspace space-y-3 text-center min-h-[250px] flex flex-col justify-center items-center">
                                        <div class="inline-flex flex-col items-center space-y-2">
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div id="multiplier-1" class="multiplier font-bold text-red-500 w-16 text-center"></div>
                                                <p id="eq1-visual-1" class="math-eq eq-1-bg eq-1-color flex-1">٢س + <span>ص</span> = ٢٣</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div class="w-16"></div> <!-- Placeholder for alignment -->
                                                <p id="eq2-visual-1" class="math-eq eq-2-bg eq-2-color flex-1">٣س + <span>٢ص</span> = ٣٧</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div class="w-16"></div> <!-- Placeholder for alignment -->
                                                <div class="flex flex-col items-center flex-1">
                                                    <div id="addition-line-1" class="border-t-2 border-gray-700 my-2 opacity-0 transition-opacity w-full"></div>
                                                    <p id="result-visual-1" class="math-eq opacity-0 w-full"></p>
                                                    <p id="simplified-result-visual-1" class="math-eq opacity-0 w-full"></p>
                                                </div>
                                            </div>
                                        </div>
                                        <p id="temp-comment-1" class="temp-comment text-purple-700 font-semibold"></p>
                                    </div>
                                    <div class="steps-container-text-1 space-y-4">
                                         <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">الخطوة التالية: التعويض</h4><p>بعد إيجاد قيمة <span class="math-eq">س = ٩</span>، نعوضها في المعادلة الأولى الأصلية لإيجاد قيمة (ص).</p></div>
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">حل لإيجاد ص</h4><p><span class="math-eq eq-1-bg eq-1-color">٢(٩) + ص = ٢٣</span><br><span class="math-eq">١٨ + ص = ٢٣</span><br><span class="math-eq">ص = ٥</span></p></div>
                                        <div class="step-interactive p-4 bg-green-200 rounded-lg step-box border-green-600"><h4 class="font-bold">الحل النهائي</h4><p>الحل هو الزوج المرتب <span class="math-eq">(٩, ٥)</span>.</p></div>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button data-example="1" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                        <div>
                                            <button data-example="1" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                            <button data-example="1" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- المثال الثاني -->
                                <div id="interactive-container-2" class="p-4 bg-white rounded-lg shadow">
                                     <p class="text-lg font-semibold mb-2">مثال ٢: ضرب كلتا المعادلتين</p>
                                    <div class="mb-4 p-3 bg-gray-100 rounded-lg text-center">
                                        <p class="font-semibold mb-2">حل النظام الآتي:</p>
                                        <div class="inline-block text-left">
                                            <p class="math-eq eq-1-bg eq-1-color">٤س + ٣ص = ٨</p><br>
                                            <p class="math-eq eq-2-bg eq-2-color">٣س - ٥ص = -٢٣</p>
                                        </div>
                                    </div>
                                    <div id="visual-workspace-2" class="visual-workspace space-y-3 text-center min-h-[250px] flex flex-col justify-center items-center">
                                        <div class="inline-flex flex-col items-center space-y-2">
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div id="multiplier-2a" class="multiplier font-bold text-red-500 w-16 text-center"></div>
                                                <p id="eq1-visual-2" class="math-eq eq-1-bg eq-1-color flex-1">٤س + <span>٣ص</span> = ٨</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div id="multiplier-2b" class="multiplier font-bold text-red-500 w-16 text-center"></div>
                                                <p id="eq2-visual-2" class="math-eq eq-2-bg eq-2-color flex-1">٣س - <span>٥ص</span> = -٢٣</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div class="w-16"></div> <!-- Placeholder for alignment -->
                                                <div class="flex flex-col items-center flex-1">
                                                    <div id="addition-line-2" class="border-t-2 border-gray-700 my-2 opacity-0 transition-opacity w-full"></div>
                                                    <p id="result-visual-2" class="math-eq opacity-0 w-full"></p>
                                                    <p id="simplified-result-visual-2" class="math-eq opacity-0 w-full"></p>
                                                </div>
                                            </div>
                                        </div>
                                        <p id="temp-comment-2" class="temp-comment text-purple-700 font-semibold"></p>
                                    </div>
                                    <div class="steps-container-text-2 space-y-4">
                                         <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">الخطوة التالية: التعويض</h4><p>بعد إيجاد قيمة <span class="math-eq">س = -١</span>، نعوضها في المعادلة الأولى الأصلية لإيجاد قيمة (ص).</p></div>
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">حل لإيجاد ص</h4><p><span class="math-eq eq-1-bg eq-1-color">٤(-١) + ٣ص = ٨</span><br><span class="math-eq">-٤ + ٣ص = ٨</span><br><span class="math-eq">٣ص = ١٢</span> ⟸ <span class="math-eq">ص = ٤</span></p></div>
                                        <div class="step-interactive p-4 bg-green-200 rounded-lg step-box border-green-600"><h4 class="font-bold">الحل النهائي</h4><p>الحل هو الزوج المرتب <span class="math-eq">(-١, ٤)</span>.</p></div>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button data-example="2" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                        <div>
                                            <button data-example="2" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                            <button data-example="2" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- صف الأمثلة الثاني -->
                            <div>
                                <!-- المثال الثالث -->
                                <div id="interactive-container-3" class="p-4 bg-white rounded-lg shadow">
                                    <p class="text-lg font-semibold mb-2">مثال ٣: مسائل من واقع الحياة</p>
                                    <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                                        <p class="font-semibold mb-2 text-center">المسألة:</p>
                                        <p>اشترى أحمد <span class="highlight-number">٣</span> دفاتر و <span class="highlight-number">٤</span> أقلام بمبلغ <span class="highlight-number">٣٩</span> ريالاً. واشترى صديقه دفترين و <span class="highlight-number">٥</span> أقلام من نفس النوع بمبلغ <span class="highlight-number">٣٨</span> ريالاً. فما ثمن الدفتر الواحد والقلم الواحد؟</p>
                                    </div>
                                    <div id="visual-workspace-3" class="visual-workspace space-y-3 text-center min-h-[250px] flex flex-col justify-center items-center">
                                        <div class="inline-flex flex-col items-center space-y-2">
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div id="multiplier-3a" class="multiplier font-bold text-red-500 w-16 text-center"></div>
                                                <p id="eq1-visual-3" class="math-eq eq-1-bg eq-1-color flex-1 opacity-0"><span>٣د</span> + ٤ق = ٣٩</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div id="multiplier-3b" class="multiplier font-bold text-red-500 w-16 text-center"></div>
                                                <p id="eq2-visual-3" class="math-eq eq-2-bg eq-2-color flex-1 opacity-0"><span>٢د</span> + ٥ق = ٣٨</p>
                                            </div>
                                            <div class="flex items-center justify-start gap-4 w-full">
                                                <div class="w-16"></div> <!-- Placeholder for alignment -->
                                                <div class="flex flex-col items-center flex-1">
                                                    <div id="addition-line-3" class="border-t-2 border-gray-700 my-2 opacity-0 transition-opacity w-full"></div>
                                                    <p id="result-visual-3" class="math-eq opacity-0 w-full"></p>
                                                    <p id="simplified-result-visual-3" class="math-eq opacity-0 w-full"></p>
                                                </div>
                                            </div>
                                        </div>
                                        <p id="temp-comment-3" class="temp-comment text-purple-700 font-semibold"></p>
                                    </div>
                                    <div class="steps-container-text-3 space-y-4">
                                         <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">الخطوة التالية: التعويض</h4><p>بعد إيجاد قيمة القلم (ق) = <span class="highlight-number">٤</span> ريالات، نعوضها في المعادلة الأولى الأصلية لإيجاد ثمن الدفتر (د).</p></div>
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box"><h4 class="font-bold">حل لإيجاد د</h4><p><span class="math-eq eq-1-bg eq-1-color">٣د + ٤(٤) = ٣٩</span><br><span class="math-eq">٣د + ١٦ = ٣٩</span><br><span class="math-eq">٣د = ٢٣</span><br><span class="math-eq">د = ٧</span></p></div>
                                        <div class="step-interactive p-4 bg-green-200 rounded-lg step-box border-green-600"><h4 class="font-bold">الحل النهائي</h4><p>ثمن الدفتر = <span class="highlight-number">٧</span> ريال، وثمن القلم = <span class="highlight-number">٤</span> ريال.</p></div>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button data-example="3" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                        <div>
                                            <button data-example="3" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                            <button data-example="3" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>
                
                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ رابعاً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>

            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <div id="smartExplanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full border-t-4 border-purple-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">🧠 الحل الذكي</h3>
                <button id="closeSmartModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="smartExplanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    // --- SCRIPT GENERAL ---
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) {
        const headerContainer = document.getElementById('main-header');
        if (!headerContainer) return;
        let titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-purple-700 leading-tight">${lessonTitle}</h1></div>`;
        let userInfoHtml = '';
        if (studentData && studentData.name) {
            userInfoHtml = `
                <div class="text-left">
                    <div class="flex items-center gap-4">
                        <span class="font-semibold text-lg">أهلاً، ${studentData.name}</span>
                        <a href="../index.html" id="logout-link" class="text-sm bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a>
                    </div>
                    <a href="../index.html" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </div>`;
        } else {
            userInfoHtml = `
                <div class="text-left">
                    <p class="text-lg text-gray-600 font-semibold">زائر</p>
                    <a href="../index.html" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </div>`;
        }
        headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`;
        const logoutLink = headerContainer.querySelector('#logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('currentStudent');
            });
        }
    }
    function buildFooter() {
        const footerContainer = document.getElementById('main-footer');
        if (!footerContainer) return;
        footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`;
    }
    function initializeQuiz(lessonId, questions, studentData, classId) { 
        currentQuestions = questions; 
        const quizForm = document.getElementById('quizForm'); 
        if (!quizForm) return; 
        if (questions.length === 0) { 
            quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; 
            return; 
        } 
        let attemptsLeft; 
        if (studentData) { 
            const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 }; 
            attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts; 
        } else { 
            attemptsLeft = 1; 
        } 
        const attemptsCounter = document.getElementById('attempts-counter'); 
        if (attemptsCounter) { 
            attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; 
        } 
        const quizHtml = questions.map((q, index) => { const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); const smartButtonHTML = q.smartExplanation ? `<button type="button" id="smart-explain-btn-${index}" class="hidden mt-2 text-xs text-purple-600 hover:underline font-semibold">🧠 الحل الذكي</button>` : ''; return `<div class="p-4 border-2 border-gray-200 rounded-lg"><p class="font-bold">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><div class="flex items-center space-x-4 space-x-reverse">${smartButtonHTML}<button type="button" id="explain-btn-${index}" class="hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div></div>`; }).join(''); 
        quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; 
        questions.forEach((q, index) => { 
            const explainBtn = document.getElementById(`explain-btn-${index}`); 
            if(explainBtn) explainBtn.addEventListener('click', () => showExplanation(index)); 
            if (q.smartExplanation) { 
                const smartExplainBtn = document.getElementById(`smart-explain-btn-${index}`); 
                if(smartExplainBtn) smartExplainBtn.addEventListener('click', () => showSmartExplanation(index)); 
            } 
        }); 
        if (attemptsLeft <= 0) { 
            const submitBtn = quizForm.querySelector('#submit-quiz-btn'); 
            submitBtn.disabled = true; 
            submitBtn.textContent = 'لا توجد محاولات متبقية'; 
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400'); 
        } 
        quizForm.onsubmit = (e) => { 
            e.preventDefault(); 
            let score = 0; 
            questions.forEach((q, index) => { 
                const userAnswer = e.target.elements[`q${index}`]?.value; 
                const feedbackEl = document.getElementById(`feedback-q${index}`); 
                if (userAnswer === q.correct) { 
                    score++; 
                    feedbackEl.textContent = '✔ إجابة صحيحة!'; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; 
                } else { 
                    feedbackEl.textContent = `❌ إجابة خاطئة.`; 
                    feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; 
                } 
                document.getElementById(`explain-btn-${index}`).classList.remove('hidden'); 
                if (q.smartExplanation) { 
                    document.getElementById(`smart-explain-btn-${index}`).classList.remove('hidden'); 
                } 
            }); 
            const finalGrade = Math.round((score / questions.length) * 10); 
            const resultsDiv = document.getElementById('quiz-results'); 
            resultsDiv.classList.remove('hidden'); 
            document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; 
            if (studentData) { 
                saveGrade(lessonId, finalGrade, studentData.id, classId); 
                if (attemptsLeft - 1 > 0) { 
                    document.getElementById('retake-quiz-btn').classList.remove('hidden'); 
                } 
            } else { 
                document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; 
            } 
            e.target.querySelector('#submit-quiz-btn').disabled = true; 
        }; 
    }
    function saveGrade(lessonId, grade, studentId, classId) { 
        const saveStatus = document.getElementById('save-status');
        if (!studentId || !classId) {
            console.error("Student ID or Class ID is missing from the URL.");
            saveStatus.textContent = 'خطأ: لا يمكن حفظ نتيجتك. بيانات الطالب غير مكتملة.';
            return;
        }
        saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; 
        const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&classId=${classId}&lessonId=${lessonId}&grade=${grade}`; 
        fetch(url, { method: 'POST', body: '' }) 
            .then(res => res.json()) 
            .then(result => { 
                if (result.status === 'success') { 
                    saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; 
                    const studentData = JSON.parse(localStorage.getItem('currentStudent')); 
                    if (studentData) {
                        if (!studentData.lessons) studentData.lessons = {}; 
                        if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { 
                            studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; 
                        } else { 
                            studentData.lessons[lessonId].attempts++; 
                        } 
                        localStorage.setItem('currentStudent', JSON.stringify(studentData)); 
                    }
                } else { 
                    throw new Error(result.message || 'Unknown error from Apps Script'); 
                } 
            }) 
            .catch(error => { 
                saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; 
                console.error("Save Grade Error:", error); 
            }); 
    }
    function showExplanation(questionIndex) { const modal = document.getElementById('explanationModal'); const explanationText = document.getElementById('explanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].explanation) { explanationText.innerHTML = currentQuestions[questionIndex].explanation; modal.classList.remove('hidden'); } }
    function closeModal() { document.getElementById('explanationModal').classList.add('hidden'); }
    function showSmartExplanation(questionIndex) { const modal = document.getElementById('smartExplanationModal'); const explanationText = document.getElementById('smartExplanationText'); if(modal && explanationText && currentQuestions[questionIndex] && currentQuestions[questionIndex].smartExplanation) { explanationText.innerHTML = currentQuestions[questionIndex].smartExplanation; modal.classList.remove('hidden'); } }
    function closeSmartModal() { document.getElementById('smartExplanationModal').classList.add('hidden'); }
    // --- END SCRIPT GENERAL ---

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const studentIdFromUrl = urlParams.get('studentId');
        const classIdFromUrl = urlParams.get('classId');

        const studentFromStorage = getStudentFromStorage();
        let student = null;

        if (studentIdFromUrl && studentFromStorage && studentFromStorage.id === studentIdFromUrl) {
            student = studentFromStorage;
        }

        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        
        const LESSON_ID = 'c5_l4';
        const quizQuestions = generateQuiz();
        initializeQuiz(LESSON_ID, quizQuestions, student, classIdFromUrl);
        
        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('closeSmartModalBtn').addEventListener('click', closeSmartModal);

        // --- Interactive Examples Setup ---
        const examples = {
            '1': {
                totalSteps: 9,
                workspace: document.getElementById('visual-workspace-1'),
                multiplier: document.getElementById('multiplier-1'),
                eq1: document.getElementById('eq1-visual-1'),
                eq2: document.getElementById('eq2-visual-1'),
                line: document.getElementById('addition-line-1'),
                result: document.getElementById('result-visual-1'),
                simplifiedResult: document.getElementById('simplified-result-visual-1'),
                comment: document.getElementById('temp-comment-1'),
                textSteps: document.querySelectorAll('.steps-container-text-1 .step-interactive'),
                runStep: runStep1,
            },
            '2': {
                totalSteps: 11,
                workspace: document.getElementById('visual-workspace-2'),
                multiplierA: document.getElementById('multiplier-2a'),
                multiplierB: document.getElementById('multiplier-2b'),
                eq1: document.getElementById('eq1-visual-2'),
                eq2: document.getElementById('eq2-visual-2'),
                line: document.getElementById('addition-line-2'),
                result: document.getElementById('result-visual-2'),
                simplifiedResult: document.getElementById('simplified-result-visual-2'),
                comment: document.getElementById('temp-comment-2'),
                textSteps: document.querySelectorAll('.steps-container-text-2 .step-interactive'),
                runStep: runStep2,
            },
            '3': {
                totalSteps: 17,
                workspace: document.getElementById('visual-workspace-3'),
                multiplierA: document.getElementById('multiplier-3a'),
                multiplierB: document.getElementById('multiplier-3b'),
                eq1: document.getElementById('eq1-visual-3'),
                eq2: document.getElementById('eq2-visual-3'),
                line: document.getElementById('addition-line-3'),
                result: document.getElementById('result-visual-3'),
                simplifiedResult: document.getElementById('simplified-result-visual-3'),
                comment: document.getElementById('temp-comment-3'),
                textSteps: document.querySelectorAll('.steps-container-text-3 .step-interactive'),
                runStep: runStep3,
            }
        };

        Object.keys(examples).forEach(key => {
            const ex = examples[key];
            ex.currentIndex = -1;
            ex.nextBtn = document.querySelector(`button.next-btn[data-example="${key}"]`);
            ex.prevBtn = document.querySelector(`button.prev-btn[data-example="${key}"]`);
            ex.resetBtn = document.querySelector(`button.reset-btn[data-example="${key}"]`);
            setupExample(ex);
        });

        function setupExample(ex) {
            ex.nextBtn.addEventListener('click', () => {
                if (ex.currentIndex < ex.totalSteps) {
                    ex.currentIndex++;
                    ex.runStep(ex.currentIndex);
                }
            });
            ex.prevBtn.addEventListener('click', () => {
                if (ex.currentIndex > -1) {
                    ex.currentIndex--;
                    ex.runStep(ex.currentIndex);
                }
            });
            ex.resetBtn.addEventListener('click', () => {
                ex.currentIndex = -1;
                ex.runStep(ex.currentIndex);
            });
            ex.runStep(-1); // Initial setup
        }

        function updateButtons(ex) {
            ex.prevBtn.disabled = ex.currentIndex <= -1;
            if (ex.currentIndex >= ex.totalSteps) {
                ex.nextBtn.classList.add('hidden');
                ex.resetBtn.classList.remove('hidden');
            } else {
                ex.nextBtn.classList.remove('hidden');
                ex.resetBtn.classList.add('hidden');
            }
        }

        // --- Step Runners for each example ---
        function runStep1(index) {
            const ex = examples['1'];
            // Reset
            ex.workspace.classList.remove('visible');
            ex.eq1.innerHTML = '٢س + <span>ص</span> = ٢٣';
            ex.eq2.innerHTML = '٣س + <span>٢ص</span> = ٣٧';
            ex.eq1.querySelector('span').classList.remove('target-term');
            ex.eq2.querySelector('span').classList.remove('target-term');
            ex.comment.textContent = '';
            ex.multiplier.classList.remove('visible');
            ex.eq1.className = 'math-eq eq-1-bg eq-1-color flex-1';
            ex.line.style.opacity = '0';
            ex.result.style.opacity = '0';
            ex.simplifiedResult.style.opacity = '0';
            ex.textSteps.forEach(s => s.classList.remove('active'));

            // Apply
            if (index >= 0) ex.workspace.classList.add('visible');
            if (index >= 1) {
                ex.eq1.querySelector('span').classList.add('target-term');
                ex.eq2.querySelector('span').classList.add('target-term');
                ex.comment.textContent = 'لحذف (ص)، نضرب المعادلة الأولى في (-٢).';
            }
            if (index >= 2) {
                ex.comment.textContent = '';
                ex.multiplier.textContent = '× (-٢)';
                ex.multiplier.classList.add('visible');
            }
            if (index >= 3) {
                ex.multiplier.classList.remove('visible');
                ex.eq1.innerHTML = '-٤س - ٢ص = -٤٦';
                ex.eq1.className = 'math-eq eq-3-bg eq-3-color flex-1';
                ex.eq2.querySelector('span').classList.remove('target-term');
            }
            if (index >= 4) {
                ex.comment.textContent = 'الآن، نجمع المعادلتين.';
                ex.line.style.opacity = '1';
            }
            if (index >= 5) {
                ex.comment.textContent = '';
                ex.result.innerHTML = '-س + ٠ = -٩';
                ex.result.style.opacity = '1';
            }
            if (index >= 6) {
                ex.comment.textContent = 'نبسط المعادلة.';
            }
            if (index >= 7) {
                ex.comment.textContent = '';
                ex.simplifiedResult.innerHTML = 'س = ٩';
                ex.simplifiedResult.className = 'math-eq bg-green-200 border-green-600 w-full';
                ex.simplifiedResult.style.opacity = '1';
            }
            if (index >= 8) ex.textSteps[0].classList.add('active');
            if (index >= 9) ex.textSteps[1].classList.add('active');
            if (index >= 10) ex.textSteps[2].classList.add('active');
            
            updateButtons(ex);
        }

        function runStep2(index) {
            const ex = examples['2'];
            // Reset
            ex.workspace.classList.remove('visible');
            ex.eq1.innerHTML = '٤س + <span>٣ص</span> = ٨';
            ex.eq2.innerHTML = '٣س - <span>٥ص</span> = -٢٣';
            ex.eq1.querySelector('span').classList.remove('target-term');
            ex.eq2.querySelector('span').classList.remove('target-term');
            ex.comment.textContent = '';
            ex.multiplierA.classList.remove('visible');
            ex.multiplierB.classList.remove('visible');
            ex.eq1.className = 'math-eq eq-1-bg eq-1-color flex-1';
            ex.eq2.className = 'math-eq eq-2-bg eq-2-color flex-1';
            ex.line.style.opacity = '0';
            ex.result.style.opacity = '0';
            ex.simplifiedResult.style.opacity = '0';
            ex.textSteps.forEach(s => s.classList.remove('active'));

            // Apply
            if (index >= 0) ex.workspace.classList.add('visible');
            if (index >= 1) {
                ex.eq1.querySelector('span').classList.add('target-term');
                ex.eq2.querySelector('span').classList.add('target-term');
                ex.comment.textContent = 'لحذف (ص)، نضرب الأولى في (٥) والثانية في (٣).';
            }
            if (index >= 2) {
                ex.comment.textContent = '';
                ex.multiplierA.textContent = '× (٥)';
                ex.multiplierA.classList.add('visible');
            }
            if (index >= 3) {
                ex.eq1.innerHTML = '٢٠س + ١٥ص = ٤٠';
                ex.eq1.className = 'math-eq eq-4-bg eq-4-color flex-1';
            }
            if (index >= 4) {
                ex.multiplierB.textContent = '× (٣)';
                ex.multiplierB.classList.add('visible');
            }
            if (index >= 5) {
                ex.multiplierA.classList.remove('visible');
                ex.multiplierB.classList.remove('visible');
                ex.eq2.innerHTML = '٩س - ١٥ص = -٦٩';
                ex.eq2.className = 'math-eq eq-5-bg eq-5-color flex-1';
            }
            if (index >= 6) {
                ex.comment.textContent = 'الآن، نجمع المعادلتين.';
                ex.line.style.opacity = '1';
            }
            if (index >= 7) {
                ex.comment.textContent = '';
                ex.result.innerHTML = '٢٩س = -٢٩';
                ex.result.style.opacity = '1';
            }
            if (index >= 8) {
                ex.comment.textContent = 'نبسط لإيجاد (س).';
            }
            if (index >= 9) {
                ex.comment.textContent = '';
                ex.simplifiedResult.innerHTML = 'س = -١';
                ex.simplifiedResult.className = 'math-eq bg-green-200 border-green-600 w-full';
                ex.simplifiedResult.style.opacity = '1';
            }
            if (index >= 10) ex.textSteps[0].classList.add('active');
            if (index >= 11) ex.textSteps[1].classList.add('active');
            if (index >= 12) ex.textSteps[2].classList.add('active');

            updateButtons(ex);
        }
        
        function runStep3(index) {
            const ex = examples['3'];
            // Reset
            ex.workspace.classList.remove('visible');
            ex.eq1.innerHTML = '<span>٣د</span> + ٤ق = ٣٩';
            ex.eq2.innerHTML = '<span>٢د</span> + ٥ق = ٣٨';
            ex.eq1.className = 'math-eq eq-1-bg eq-1-color flex-1 opacity-0';
            ex.eq2.className = 'math-eq eq-2-bg eq-2-color flex-1 opacity-0';
            ex.eq1.querySelector('span').classList.remove('target-term');
            ex.eq2.querySelector('span').classList.remove('target-term');
            ex.comment.textContent = '';
            ex.comment.className = 'temp-comment text-purple-700 font-semibold';
            ex.multiplierA.classList.remove('visible');
            ex.multiplierB.classList.remove('visible');
            ex.line.style.opacity = '0';
            ex.result.style.opacity = '0';
            ex.simplifiedResult.style.opacity = '0';
            ex.textSteps.forEach(s => s.classList.remove('active'));

            // Apply
            if (index >= 0) ex.workspace.classList.add('visible');
            if (index >= 1) {
                ex.comment.innerHTML = "أولاً، نحدد المتغيرات:<br> <span class='font-bold text-blue-600'>د = ثمن الدفتر</span>, <span class='font-bold text-green-600'>ق = ثمن القلم</span>";
            }
            if (index >= 2) {
                ex.comment.innerHTML = "<span class='text-blue-600'>من جملة '٣ دفاتر و ٤ أقلام بمبلغ ٣٩ ريالاً'، نكون المعادلة الأولى.</span>";
            }
            if (index >= 3) {
                 ex.eq1.classList.remove('opacity-0');
                 ex.comment.innerHTML = '';
            }
            if (index >= 4) {
                 ex.comment.innerHTML = "<span class='text-green-600'>ومن جملة 'دفترين و ٥ أقلام بمبلغ ٣٨ ريالاً'، نكون المعادلة الثانية.</span>";
            }
            if (index >= 5) {
                ex.eq2.classList.remove('opacity-0');
                ex.comment.innerHTML = '';
            }
            if (index >= 6) {
                ex.eq1.querySelector('span').classList.add('target-term');
                ex.eq2.querySelector('span').classList.add('target-term');
                ex.comment.textContent = 'لحذف (د)، نضرب الأولى في (٢) والثانية في (-٣).';
            }
            if (index >= 7) {
                ex.comment.textContent = '';
                ex.multiplierA.textContent = '× (٢)';
                ex.multiplierA.classList.add('visible');
            }
            if (index >= 8) {
                ex.eq1.innerHTML = '٦د + ٨ق = ٧٨';
                ex.eq1.className = 'math-eq eq-4-bg eq-4-color flex-1';
            }
            if (index >= 9) {
                ex.multiplierB.textContent = '× (-٣)';
                ex.multiplierB.classList.add('visible');
            }
            if (index >= 10) {
                ex.multiplierA.classList.remove('visible');
                ex.multiplierB.classList.remove('visible');
                ex.eq2.innerHTML = '-٦د - ١٥ق = -١١٤';
                ex.eq2.className = 'math-eq eq-5-bg eq-5-color flex-1';
            }
            if (index >= 11) {
                ex.comment.textContent = 'الآن، نجمع المعادلتين.';
                ex.line.style.opacity = '1';
            }
            if (index >= 12) {
                ex.comment.textContent = '';
                ex.result.innerHTML = '-٧ق = -٣٦';
                ex.result.style.opacity = '1';
            }
            if (index >= 13) {
                ex.comment.textContent = 'نبسط لإيجاد (ق).';
            }
            if (index >= 14) {
                ex.comment.textContent = '';
                ex.simplifiedResult.innerHTML = 'ق = ٤';
                ex.simplifiedResult.className = 'math-eq bg-green-200 border-green-600 w-full';
                ex.simplifiedResult.style.opacity = '1';
            }
            if (index >= 15) ex.textSteps[0].classList.add('active');
            if (index >= 16) ex.textSteps[1].classList.add('active');
            if (index >= 17) ex.textSteps[2].classList.add('active');

            updateButtons(ex);
        }
        
        function generateQuiz() {
            const questionBank = [
                {
                    type: 'mcq',
                    level: '⭐',
                    topic: 'elimination_multiplication',
                    text: 'لحذف المتغير (ص) في النظام التالي، في أي عدد يجب ضرب المعادلة الأولى؟ <br><span class="math-eq eq-1-bg eq-1-color">س + ص = ٥</span><br><span class="math-eq eq-2-bg eq-2-color">٢س - ٣ص = ٠</span>',
                    options: [
                        { display: '<span class="highlight-number">-٢</span>', value: 'a' },
                        { display: '<span class="highlight-number">٢</span>', value: 'b' },
                        { display: '<span class="highlight-number">٣</span>', value: 'c' },
                        { display: '<span class="highlight-number">-٣</span>', value: 'd' }
                    ],
                    correct: 'c',
                    explanation: 'لجعل معامل (ص) في المعادلة الأولى معكوساً جمعياً لمعامل (ص) في المعادلة الثانية (<span class="highlight-number">-٣</span>)، يجب أن نجعله <span class="highlight-number">+٣</span>. لذلك، نضرب المعادلة الأولى كلها في <span class="highlight-number">٣</span>.'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    topic: 'elimination_multiplication',
                    text: 'ما هو حل النظام التالي؟<br><span class="math-eq">٥س + ٢ص = ٦</span><br><span class="math-eq">-٢س + ص = ٣</span>',
                    options: [
                        { display: '<span class="math-eq">(٠, ٣)</span>', value: 'a' },
                        { display: '<span class="math-eq">(٢, -٢)</span>', value: 'b' },
                        { display: '<span class="math-eq">(٣, ٠)</span>', value: 'c' },
                        { display: '<span class="math-eq">(٤, -٧)</span>', value: 'd' }
                    ],
                    correct: 'a',
                    explanation: `<div class='space-y-3 text-center'>
                        <p>لحل هذا النظام، سنستخدم الحذف بالضرب. هدفنا هو جعل معاملات 'ص' متعاكسة.</p>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ١: تحديد عملية الضرب</h4>
                            <p>المعادلتان هما:</p>
                            <div class="inline-block text-left">
                                <p class="math-eq eq-1-bg eq-1-color">٥س + ٢ص = ٦</p><br>
                                <p class="math-eq eq-2-bg eq-2-color">-٢س + <span class='target-term'>ص</span> = ٣</p>
                            </div>
                            <p class='mt-2'>لجعل معامل 'ص' في المعادلة الثانية (<span class='highlight-number'>١</span>) معكوساً لمعامل 'ص' في الأولى (<span class='highlight-number'>٢</span>)، نضرب المعادلة الثانية في <span class='highlight-number'>-٢</span>.</p>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٢: تنفيذ الضرب</h4>
                            <p><span class='font-bold text-red-500 text-lg'>× (-٢)</span> <span class="math-eq eq-2-bg eq-2-color">-٢س + ص = ٣</span></p>
                            <p class='text-2xl'>⇩</p>
                            <p class="math-eq eq-3-bg eq-3-color">٤س - ٢ص = -٦</p>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٣: الحذف بالجمع</h4>
                            <div class='inline-flex flex-col items-center'>
                                <p class="math-eq eq-1-bg eq-1-color">٥س + ٢ص = ٦</p>
                                <p class="math-eq eq-3-bg eq-3-color">٤س - ٢ص = -٦</p>
                                <div class='border-t-2 border-black w-full my-1'></div>
                                <p class="math-eq">٩س + ٠ = ٠</p>
                                <p class='text-2xl'>⇩</p>
                                <p class="math-eq bg-green-200">س = ٠</p>
                            </div>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٤: إيجاد 'ص'</h4>
                            <p>نعوض <span class='math-eq'>س = ٠</span> في المعادلة الثانية الأصلية:</p>
                            <p class="math-eq eq-2-bg eq-2-color">-٢(٠) + ص = ٣</p>
                            <p class="math-eq">ص = ٣</p>
                            <p class='mt-2 font-bold'>إذن، الحل هو <span class="math-eq bg-green-200">(٠, ٣)</span>.</p>
                        </div>
                    </div>`,
                    smartExplanation: 'جرب الخيارات. لنختبر الخيار (أ) <span class="math-eq">(٠, ٣)</span>:<br><strong>المعادلة ١:</strong> <span class="math-eq">٥(٠) + ٢(٣) = ٦</span> ⟸ <span class="math-eq">٦ = ٦</span> (صحيح).<br><strong>المعادلة ٢:</strong> <span class="math-eq">-٢(٠) + ٣ = ٣</span> ⟸ <span class="math-eq">٣ = ٣</span> (صحيح).<br>بما أن الخيار (أ) يحقق المعادلتين، فهو الحل الصحيح.'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    topic: 'elimination_multiplication',
                    text: 'حل النظام:<br><span class="math-eq">٣س + ٤ص = -٢٥</span><br><span class="math-eq">٢س - ٣ص = ٦</span>',
                    options: [
                        { display: '<span class="math-eq">(-٣, -٤)</span>', value: 'a' },
                        { display: '<span class="math-eq">(-٧, -١)</span>', value: 'b' },
                        { display: '<span class="math-eq">(٣, -١)</span>', value: 'c' },
                        { display: '<span class="math-eq">(١, -٧)</span>', value: 'd' }
                    ],
                    correct: 'a',
                    explanation: `<div class='space-y-3 text-center'>
                        <p>لحل هذا النظام، سنستخدم الحذف بالضرب. هدفنا هو جعل معاملات 'ص' متعاكسة.</p>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ١: تحديد عملية الضرب</h4>
                            <p>لجعل معاملي 'ص' (<span class='highlight-number'>٤</span> و <span class='highlight-number'>-٣</span>) متعاكسين، نضرب المعادلة الأولى في <span class='highlight-number'>٣</span> والثانية في <span class='highlight-number'>٤</span>.</p>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٢: تنفيذ الضرب</h4>
                            <p><span class='font-bold text-red-500 text-lg'>× (٣)</span> <span class="math-eq eq-1-bg eq-1-color">٣س + ٤ص = -٢٥</span> ⇩ <span class="math-eq eq-4-bg eq-4-color">٩س + ١٢ص = -٧٥</span></p>
                            <p><span class='font-bold text-red-500 text-lg'>× (٤)</span> <span class="math-eq eq-2-bg eq-2-color">٢س - ٣ص = ٦</span> ⇩ <span class="math-eq eq-5-bg eq-5-color">٨س - ١٢ص = ٢٤</span></p>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٣: الحذف بالجمع</h4>
                            <div class='inline-flex flex-col items-center'>
                                <p class="math-eq eq-4-bg eq-4-color">٩س + ١٢ص = -٧٥</p>
                                <p class="math-eq eq-5-bg eq-5-color">٨س - ١٢ص = ٢٤</p>
                                <div class='border-t-2 border-black w-full my-1'></div>
                                <p class="math-eq">١٧س = -٥١</p>
                                <p class='text-2xl'>⇩</p>
                                <p class="math-eq bg-green-200">س = -٣</p>
                            </div>
                        </div>
                        <div class='p-2 bg-gray-50 rounded-lg'>
                            <h4 class='font-bold text-purple-700'>الخطوة ٤: إيجاد 'ص'</h4>
                            <p>نعوض <span class='math-eq'>س = -٣</span> في المعادلة الثانية الأصلية:</p>
                            <p class="math-eq eq-2-bg eq-2-color">٢(-٣) - ٣ص = ٦</p>
                            <p class="math-eq">-٦ - ٣ص = ٦</p>
                            <p class="math-eq">-٣ص = ١٢</p>
                            <p class="math-eq">ص = -٤</p>
                            <p class='mt-2 font-bold'>إذن، الحل هو <span class="math-eq bg-green-200">(-٣, -٤)</span>.</p>
                        </div>
                    </div>`
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    topic: 'word_problem',
                    text: 'سعر <span class="highlight-number">٣</span> تذاكر للكبار وتذكرتين للصغار لحضور مباراة هو <span class="highlight-number">٣٨٠</span> ريالاً. وسعر تذكرتين للكبار و<span class="highlight-number">٣</span> للصغار هو <span class="highlight-number">٣٢٠</span> ريالاً. ما سعر تذكرة الكبار؟',
                    options: [
                        { display: '٦٠ ريال', value: 'a' },
                        { display: '٨٠ ريال', value: 'b' },
                        { display: '٤٠ ريال', value: 'c' },
                        { display: '١٠٠ ريال', value: 'd' }
                    ],
                    correct: 'd',
                    explanation: 'نفرض سعر تذكرة الكبار (ك) وسعر تذكرة الصغار (ص).<br><strong>المعادلة ١:</strong> <span class="math-eq">٣ك + ٢ص = ٣٨٠</span><br><strong>المعادلة ٢:</strong> <span class="math-eq">٢ك + ٣ص = ٣٢٠</span><br>لحذف (ص)، نضرب الأولى في <span class="highlight-number">٣</span> والثانية في <span class="highlight-number">-٢</span>.<br><span class="math-eq">٩ك + ٦ص = ١١٤٠</span><br><span class="math-eq">-٤ك - ٦ص = -٦٤٠</span><br>نجمع المعادلتين: <span class="math-eq">٥ك = ٥٠٠</span> ⟸ <span class="math-eq">ك = ١٠٠</span>. إذن سعر تذكرة الكبار ١٠٠ ريال.'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    topic: 'special_case_infinite',
                    text: 'عند حل النظام: <span class="math-eq">٢س - ص = ٤</span> و <span class="math-eq">٦س - ٣ص = ١٢</span> بالحذف، ماذا تكون النتيجة؟',
                    options: [
                        { display: 'الحل هو <span class="math-eq">(٠, ٠)</span>', value: 'a' },
                        { display: 'لا يوجد حل', value: 'b' },
                        { display: 'يوجد عدد لا نهائي من الحلول', value: 'c' },
                        { display: 'الحل هو <span class="math-eq">(٢, ٠)</span>', value: 'd' }
                    ],
                    correct: 'c',
                    explanation: 'نضرب المعادلة الأولى في <span class="highlight-number">-٣</span> لحذف (س):<br><span class="math-eq">-٣(٢س - ص = ٤)</span> ⟸ <span class="math-eq">-٦س + ٣ص = -١٢</span>.<br>الآن نجمعها مع المعادلة الثانية <span class="math-eq">٦س - ٣ص = ١٢</span>.<br>النتيجة هي <span class="math-eq">٠ = ٠</span>. هذه عبارة صحيحة دائماً، مما يعني أن المعادلتين متكافئتين (نفس الخط) ويوجد عدد لا نهائي من الحلول.',
                    smartExplanation: 'لاحظ أن المعادلة الثانية (<span class="math-eq">٦س - ٣ص = ١٢</span>) هي نفسها المعادلة الأولى (<span class="math-eq">٢س - ص = ٤</span>) ولكن مضروبة في <span class="highlight-number">٣</span>. إذا كانت إحدى المعادلات من مضاعفات الأخرى، فهما يمثلان نفس الخط، وبالتالي هناك عدد لا نهائي من الحلول.'
                },
                {
                    type: 'mcq',
                    level: '⭐',
                    topic: 'elimination_multiplication',
                    text: 'حل النظام:<br><span class="math-eq">٤س - ص = ٩</span><br><span class="math-eq">٢س + ٣ص = -١</span>',
                    options: [
                        { display: '<span class="math-eq">(٢, -١)</span>', value: 'a' },
                        { display: '<span class="math-eq">(-١, ٢)</span>', value: 'b' },
                        { display: '<span class="math-eq">(١, -٥)</span>', value: 'c' },
                        { display: '<span class="math-eq">(٣, ٣)</span>', value: 'd' }
                    ],
                    correct: 'a',
                    explanation: 'نضرب المعادلة الأولى في ٣ لحذف ص. <br> ١٢س - ٣ص = ٢٧ <br> ٢س + ٣ص = -١ <br> بالجمع: ١٤س = ٢٦ ⟸ س = ٢. بالتعويض: ٤(٢) - ص = ٩ ⟸ ٨ - ص = ٩ ⟸ ص = -١. الحل هو (٢, -١).'
                },
                {
                    type: 'mcq',
                    level: '⭐',
                    topic: 'elimination_multiplication',
                    text: 'حل النظام:<br><span class="math-eq">س + ٢ص = ٨</span><br><span class="math-eq">٣س + ص = ٩</span>',
                    options: [
                        { display: '<span class="math-eq">(٤, ٢)</span>', value: 'a' },
                        { display: '<span class="math-eq">(٢, ٣)</span>', value: 'b' },
                        { display: '<span class="math-eq">(٠, ٤)</span>', value: 'c' },
                        { display: '<span class="math-eq">(٣, ٢.٥)</span>', value: 'd' }
                    ],
                    correct: 'b',
                    explanation: 'نضرب المعادلة الثانية في -٢ لحذف ص. <br> س + ٢ص = ٨ <br> -٦س - ٢ص = -١٨ <br> بالجمع: -٥س = -١٠ ⟸ س = ٢. بالتعويض: ٢ + ٢ص = ٨ ⟸ ٢ص = ٦ ⟸ ص = ٣. الحل هو (٢, ٣).'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    topic: 'elimination_multiplication',
                    text: 'حل النظام:<br><span class="math-eq">٢س + ٣ص = ١</span><br><span class="math-eq">٣س + ٥ص = ٢</span>',
                    options: [
                        { display: '<span class="math-eq">(-١, ١)</span>', value: 'a' },
                        { display: '<span class="math-eq">(٢, -١)</span>', value: 'b' },
                        { display: '<span class="math-eq">(١, -<span class="fraction"><span>١</span><span class="frac-bar"></span><span>٣</span></span>)</span>', value: 'c' },
                        { display: '<span class="math-eq">(٤, -٣)</span>', value: 'd' }
                    ],
                    correct: 'a',
                    explanation: 'نضرب الأولى في ٣ والثانية في -٢ لحذف س. <br> ٦س + ٩ص = ٣ <br> -٦س - ١٠ص = -٤ <br> بالجمع: -ص = -١ ⟸ ص = ١. بالتعويض: ٢س + ٣(١) = ١ ⟸ ٢س = -٢ ⟸ س = -١. الحل هو (-١, ١).'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    topic: 'word_problem',
                    text: 'مجموع عمر أب وابنه ٦٠ عاماً. وقبل ٥ سنوات، كان عمر الأب أربعة أضعاف عمر ابنه. كم عمر كل منهما الآن؟',
                    options: [
                        { display: 'الأب ٥٠، الابن ١٠', value: 'a' },
                        { display: 'الأب ٤٥، الابن ١٥', value: 'b' },
                        { display: 'الأب ٤٠، الابن ٢٠', value: 'c' },
                        { display: 'الأب ٥٥، الابن ٥', value: 'd' }
                    ],
                    correct: 'b',
                    explanation: 'نفرض عمر الأب (أ) وعمر الابن (ب). <br> أ + ب = ٦٠ <br> أ - ٥ = ٤(ب - ٥) ⟸ أ - ٤ب = -١٥. <br> بطرح المعادلتين: ٥ب = ٧٥ ⟸ ب = ١٥. بالتعويض: أ + ١٥ = ٦٠ ⟸ أ = ٤٥. عمر الأب ٤٥ والابن ١٥.'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐',
                    topic: 'special_case_no_solution',
                    text: 'ماذا يحدث عند حل النظام:<br><span class="math-eq">س - ٢ص = ٥</span><br><span class="math-eq">٣س - ٦ص = ١٠</span>',
                    options: [
                        { display: 'حل وحيد', value: 'a' },
                        { display: 'لا يوجد حل', value: 'b' },
                        { display: 'عدد لا نهائي من الحلول', value: 'c' },
                        { display: 'الحل هو (١, -٢)', value: 'd' }
                    ],
                    correct: 'b',
                    explanation: 'نضرب المعادلة الأولى في -٣. <br> -٣س + ٦ص = -١٥ <br> ٣س - ٦ص = ١٠ <br> بالجمع نحصل على: ٠ = -٥. هذه عبارة خاطئة، لذا لا يوجد حل للنظام.'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    topic: 'elimination_multiplication',
                    text: 'حل النظام:<br><span class="math-eq">٥س - ٢ص = -١٩</span><br><span class="math-eq">٢س + ٣ص = ٠</span>',
                    options: [
                        { display: '<span class="math-eq">(١, ١٢)</span>', value: 'a' },
                        { display: '<span class="math-eq">(-٥, -٣)</span>', value: 'b' },
                        { display: '<span class="math-eq">(٣, -٢)</span>', value: 'c' },
                        { display: '<span class="math-eq">(-٣, ٢)</span>', value: 'd' }
                    ],
                    correct: 'd',
                    explanation: 'نضرب الأولى في ٣ والثانية في ٢ لحذف ص. <br> ١٥س - ٦ص = -٥٧ <br> ٤س + ٦ص = ٠ <br> بالجمع: ١٩س = -٥٧ ⟸ س = -٣. بالتعويض: ٢(-٣) + ٣ص = ٠ ⟸ -٦ + ٣ص = ٠ ⟸ ٣ص = ٦ ⟸ ص = ٢. الحل هو (-٣, ٢).'
                },
                {
                    type: 'mcq',
                    level: '⭐⭐⭐',
                    topic: 'word_problem',
                    text: 'في محل للحيوانات الأليفة، يوجد طيور وقطط فقط. إذا كان مجموع الرؤوس هو ٢٠ ومجموع الأرجل هو ٥٤، فكم عدد الطيور والقطط؟',
                    options: [
                        { display: '١٠ طيور و ١٠ قطط', value: 'a' },
                        { display: '١٥ طير و ٥ قطط', value: 'b' },
                        { display: '٧ طيور و ١٣ قطة', value: 'c' },
                        { display: '١٣ طير و ٧ قطط', value: 'd' }
                    ],
                    correct: 'd',
                    explanation: 'نفرض عدد الطيور (ط) وعدد القطط (ق). <br> ط + ق = ٢٠ (معادلة الرؤوس) <br> ٢ط + ٤ق = ٥٤ (معادلة الأرجل). <br> نضرب الأولى في -٢: -٢ط - ٢ق = -٤٠. <br> بالجمع مع المعادلة الثانية: ٢ق = ١٤ ⟸ ق = ٧. بالتعويض: ط + ٧ = ٢٠ ⟸ ط = ١٣. الحل: ١٣ طير و ٧ قطط.'
                }
            ];
            const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
            const questionCount = Math.min(shuffled.length, 5);
            return shuffled.slice(0, questionCount);
        }

    });
    </script>
</body>
</html>

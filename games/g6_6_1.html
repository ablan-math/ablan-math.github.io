<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ุชุญุฏู ุงูุถุฑุจ V19.10 - ุถุฑุจ ูุซูุฑุงุช ุงูุญุฏูุฏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: manipulation; direction: rtl; }
        .compact-card {
            width: 100%; max-width: 420px; background: white; border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; max-height: 96vh; overflow: hidden; position: relative;
        }
        .top-info-bar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 16px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 800; color: #64748b;
        }
        .btn-touch { min-height: 50px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 1rem; font-weight: 800; cursor: pointer; }
        .btn-touch:active { transform: scale(0.97); }
        
        .math-text { font-family: 'Cairo', sans-serif; font-weight: 900; color: #1e293b; white-space: nowrap; }
        .math-var { font-weight: 900; color: #2563eb; font-style: normal; margin: 0 1px; display: inline-block; }
        .math-exp { vertical-align: super; font-size: 0.75em; font-weight: 900; color: #ef4444; display: inline-block; line-height: 0; margin-top: -5px; }
        
        .option-card {
            border: 2px solid #f1f5f9; border-radius: 1.25rem; padding: 12px 6px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: row; align-items: center; justify-content: center; min-height: 60px;
            font-size: 11px; white-space: nowrap; overflow: hidden;
        }
        .option-card:hover { border-color: #3b82f6; background: #f8fafc; }
        .option-card.correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
        .option-card.wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }

        .blink-correct { animation: blinker 0.4s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }

        .overlay-screen {
            position: absolute; inset: 0; background: white; z-index: 50;
            display: flex; flex-direction: column; padding: 1.5rem; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .overlay-active { transform: translateY(0); }

        .modal-backdrop {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px); z-index: 150; display: none; align-items: center; justify-content: center; padding: 1.5rem;
        }
        .explanation-modal {
            background: white; width: 100%; max-width: 360px; border-radius: 2rem;
            padding: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            display: flex; flex-direction: column; max-height: 80vh;
        }
        .step-row { 
            display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; 
            padding: 12px; background: #f8fafc; border-radius: 1rem; border-right: 4px solid #3b82f6;
            text-align: right; line-height: 1.5;
        }

        .leaderboard-modal { 
            position: absolute; inset: 0; background: #ffffff; z-index: 200; 
            display: flex; flex-direction: column; padding: 1.25rem; transition: all 0.3s; 
        }
        .hidden-modal { opacity: 0; pointer-events: none; transform: scale(0.95); display: none; }
        .visible-modal { opacity: 1; pointer-events: auto; transform: scale(1); display: flex; }
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; font-weight: bold; border-radius: 8px; transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .tab-active { background-color: #3b82f6; color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        .tab-inactive { background-color: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        .rank-row-me { background-color: #eff6ff !important; border-right: 4px solid #2563eb !important; }
        .sync-loader { font-size: 10px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen flex items-center justify-center p-3 text-right">

    <div class="compact-card">
        <!-- ุงูุดุฑูุท ุงูุนููู -->
        <div class="top-info-bar">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-user-graduate text-blue-500"></i>
                <span id="top-student-name" class="truncate font-black">ุจุทู ุงูุชุญุฏู</span>
            </div>
            <div class="flex items-center gap-2 bg-white px-2 py-0.5 rounded-full border shadow-sm font-bold">
                <i class="fas fa-star text-yellow-500 text-[10px]"></i>
                <span id="top-prev-score">ู / ูฅ</span>
            </div>
        </div>

        <!-- ุงูุดุงุดุฉ 1: ุงูุจุฏุงูุฉ -->
        <div id="start-screen" class="p-6 text-center flex flex-col gap-4 h-full justify-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center shadow-xl shadow-blue-200 rotate-3">
                <i class="fas fa-rocket text-white text-4xl"></i>
            </div>
            <h1 class="text-xl font-black text-slate-800 mt-2">ุชุญุฏู ุงูุถุฑุจ</h1>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-[11px] font-bold text-blue-700 leading-relaxed text-center">
                ุฃุฌุจ ุนู ูจ ุฃุณุฆูุฉ ูุชุฏุฑุฌุฉ ุงูุตุนูุจุฉ. ูุชู ุงุฎุชูุงุฑ ุงูุฃุณุฆูุฉ ุนุดูุงุฆูุงู ูู ุจูู ุงูุฃุณุฆูุฉ ูู ูู ูุฑุฉ!
            </div>
            
            <div class="flex flex-col gap-2">
                <button onclick="startGame()" class="btn-touch bg-blue-600 text-white shadow-lg text-lg w-full">
                    ุจุฏุก ุงูุชุญุฏู <i class="fas fa-play-circle mr-2"></i>
                </button>
                <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch bg-white text-slate-600 border border-slate-200 text-sm w-full">
                    <i class="fas fa-trophy text-yellow-500 ml-2"></i> ุณุฌู ุงูุฃุจุทุงู
                </button>
            </div>
            <p class="text-[10px] text-slate-400 font-bold mt-2 tracking-widest uppercase text-center">ุฃ. ุนุจุฏ ุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู</p>
        </div>

        <!-- ุงูุดุงุดุฉ 2: ุงููุนุจุฉ -->
        <div id="game-screen" class="hidden p-4 flex flex-col h-full overflow-hidden">
            <div class="flex justify-between items-center mb-4 px-2">
                <span id="progress-text" class="text-[10px] font-black text-slate-400">ุงูุณุคุงู ูก ูู ูจ</span>
                <div class="h-1.5 flex-1 mx-4 bg-slate-100 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 12.5%"></div>
                </div>
                <div class="flex items-center gap-1 text-red-500 font-black text-[10px]">
                    <i class="fas fa-clock"></i>
                    <span id="timer-display">ู</span>
                </div>
            </div>

            <div class="bg-slate-50 rounded-3xl p-6 mb-4 border-2 border-dashed border-slate-200 flex flex-col items-center justify-center min-h-[140px]">
                <p class="text-slate-400 text-[9px] font-bold mb-2 uppercase tracking-wider text-center">ุฃูุฌุฏ ูุงุชุฌ ุงูุถุฑุจ ูู ุฃุจุณุท ุตูุฑุฉ:</p>
                <div id="question-text" class="text-xl math-text text-center leading-relaxed"></div>
            </div>

            <div id="options-grid" class="grid grid-cols-2 gap-2 mb-4"></div>
        </div>

        <!-- ุงูุดุงุดุฉ 3: ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ -->
        <div id="feedback-screen" class="overlay-screen">
            <div class="text-center mt-6 mb-4">
                <div id="feedback-icon" class="text-5xl mb-2"></div>
                <h2 id="feedback-title" class="text-xl font-black mb-1"></h2>
                <p id="feedback-subtitle" class="text-slate-400 font-bold text-xs"></p>
            </div>

            <div class="bg-slate-50 border border-slate-100 p-4 rounded-3xl mb-4 text-center">
                <p class="text-[9px] text-slate-500 font-bold mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู:</p>
                <div id="feedback-correct-text" class="text-lg math-text"></div>
            </div>

            <div class="mt-auto flex flex-row gap-2">
                <button onclick="openExplanation()" class="btn-touch flex-1 bg-amber-100 text-amber-700 border border-amber-200 text-sm">
                    <i class="fas fa-lightbulb ml-2"></i> ุงุนุฑู ููุงุฐุงุ
                </button>
                <button onclick="nextStep()" class="btn-touch flex-1 bg-blue-600 text-white shadow-lg text-sm">
                    ุงูุชุงูู <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุงูุดุฑุญ ุงูููุจุซูุฉ -->
        <div id="explanation-modal" class="modal-backdrop" onclick="closeExplanation()">
            <div class="explanation-modal" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-black text-slate-800"><i class="fas fa-book-open text-blue-500 ml-2"></i>ุฎุทูุงุช ุงูุญู</h3>
                    <button onclick="closeExplanation()" class="text-slate-400 hover:text-red-500 text-xl"><i class="fas fa-times-circle"></i></button>
                </div>
                <div class="text-center mb-4 p-2 bg-blue-50 rounded-xl">
                    <p class="text-[9px] text-blue-400 font-bold uppercase mb-1">ุงููุณุฃูุฉ ุงูุฃุตููุฉ</p>
                    <div id="exp-small-q" class="text-sm font-black text-blue-800"></div>
                </div>
                <div id="steps-list" class="flex-1 overflow-y-auto pr-1"></div>
                <button onclick="closeExplanation()" class="mt-4 btn-touch bg-slate-900 text-white text-sm">ูููุช ุฐูู</button>
            </div>
        </div>

        <!-- ุงูุดุงุดุฉ 4: ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ -->
        <div id="result-screen" class="hidden p-5 flex flex-col h-full overflow-hidden text-center justify-center">
            <div id="final-stats" class="grid grid-cols-3 gap-1 mb-4"></div>
            <div class="bg-green-50 p-6 rounded-3xl border border-green-100 mb-6">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                <h3 class="text-xl font-black text-green-900">ุชู ุญูุธ ุฏุฑุฌุชู!</h3>
                <p class="text-sm font-bold text-green-700">ููุฏ ุฃุชููุช ุชุญุฏู ุงูุถุฑุจ ุจูุฌุงุญ ูุชู ุฅุฑุณุงู ุงููุชูุฌุฉ ููููุตุฉ.</p>
            </div>
            
            <button onclick="fetchAndShowLeaderboard(true)" class="btn-touch w-full bg-blue-600 text-white mb-3 shadow-md">
                <i class="fas fa-crown ml-2"></i> ุดุงูุฏ ูุฑูุฒู ูู ุงูุฃุจุทุงู
            </button>
            
            <div class="flex gap-2">
                <button onclick="location.reload()" class="btn-touch flex-1 bg-slate-100 text-slate-600 font-bold text-sm">ุฅุนุงุฏุฉ</button>
                <button id="finish-btn" class="btn-touch flex-1 bg-slate-900 text-white font-bold text-sm">ุฅููุงุก</button>
            </div>
        </div>

        <!-- ุณุฌู ุงูุฃุจุทุงู -->
        <div id="leaderboard-modal" class="leaderboard-modal hidden-modal">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-black text-slate-800 text-lg"><i class="fas fa-trophy text-yellow-500 ml-2"></i>ุณุฌู ุงูุฃุจุทุงู</h3>
                <button onclick="closeLeaderboardModal()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="switchTab('class')" id="tab-class" class="tab-btn">ูุตูู</button>
                <button onclick="switchTab('global')" id="tab-global" class="tab-btn">ุนุงู</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto bg-slate-50 rounded-2xl p-1 relative min-h-[200px]">
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center hidden bg-white/80 z-10"><i class="fas fa-sync sync-loader text-blue-500 text-3xl"></i></div>
                <div id="leaderboard-content" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqAQlGhNs8k5RwHs6jrWxDiDwaMABSx8a9Fl81O5oVVa5fHRWTwIEvsGy2cSDP4zGLWQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const GAME_ID = urlParams.get('gameId') || 'g6_6_1';
        const studentId = urlParams.get('studentId') || urlParams.get('userId');
        const classId = urlParams.get('classId');
        
        let studentName = decodeURIComponent(urlParams.get('name') || urlParams.get('studentName') || urlParams.get('username') || "ุจุทู ุงูุชุญุฏู");
        let currentLeaderboardMode = classId ? 'class' : 'global'; 
        const toAr = (n) => String(n).replace(/\d/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ"[d]);

        const questionBank = [
            // ูุณุชูู 1
            [
                { q: "(ุณ + ูข)(ุณ + ูฃ)", options: ["ุณ<span class='math-exp'>ูข</span> + ูฅุณ + ูฆ", "ุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูฅ", "ุณ<span class='math-exp'>ูข</span> + ูฅ", "ูขุณ + ูฅ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ุณ ร ุณ = ุณยฒ.", "ูข. ูุถุฑุจ ุงูุทุฑููู (ูฃุณ) ูุงููุณุทูู (ูขุณ) ุซู ูุฌูุนูู = ูฅุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑ ูู ุงูุฃุฎูุฑ: ูข ร ูฃ = ูฆ.", "ูค. ุงููุงุชุฌ: ุณยฒ + ูฅุณ + ูฆ."] },
                { q: "(ุณ + ูก)(ุณ + ูฆ)", options: ["ุณ<span class='math-exp'>ูข</span> + ูงุณ + ูฆ", "ุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูก", "ุณ<span class='math-exp'>ูข</span> + ูง", "ูขุณ + ูง"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ุณ ร ุณ = ุณยฒ.", "ูข. ูุฌูุน ุงูุซูุงุจุช (ูก+ูฆ) ูููุนุงูู ุงูุฃูุณุท: ูงุณ.", "ูฃ. ูุถุฑุจ ุงูุซูุงุจุช (ูกรูฆ) ููุญุฏ ุงูุฃุฎูุฑ: ูฆ.", "ูค. ุงููุงุชุฌ: ุณยฒ + ูงุณ + ูฆ."] }
            ],
            // ูุณุชูู 2
            [
                { q: "(ุณ - ูฃ)(ุณ + ูฅ)", options: ["ุณ<span class='math-exp'>ูข</span> + ูขุณ - ูกูฅ", "ุณ<span class='math-exp'>ูข</span> - ูขุณ - ูกูฅ", "ุณ<span class='math-exp'>ูข</span> - ูกูฅ", "ุณ<span class='math-exp'>ูข</span> + ูจุณ - ูกูฅ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุณ ร ุณ = ุณยฒ.", "ูข. ูุฌูุน (-ูฃ + ูฅ) ูุฅูุฌุงุฏ ุงููุนุงูู ุงูุฃูุณุท: +ูขุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: -ูฃ ร ูฅ = -ูกูฅ.", "ูค. ุงููุงุชุฌ: ุณยฒ + ูขุณ - ูกูฅ."] },
                { q: "(ุณ + ูข)(ุณ - ูค)", options: ["ุณ<span class='math-exp'>ูข</span> - ูขุณ - ูจ", "ุณ<span class='math-exp'>ูข</span> + ูขุณ - ูจ", "ุณ<span class='math-exp'>ูข</span> - ูจ", "ุณ<span class='math-exp'>ูข</span> + ูฆุณ - ูจ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ุณยฒ.", "ูข. ูุฌูุน (+ูข) ู (-ูค) ูููุนุงูู ุงูุฃูุณุท: -ูขุณ.", "ูฃ. ูุถุฑุจ (+ูข) ร (-ูค) = -ูจ.", "ูค. ุงููุงุชุฌ: ุณยฒ - ูขุณ - ูจ."] }
            ],
            // ูุณุชูู 3
            [
                { q: "(ุณ - ูข)(ุณ - ูค)", options: ["ุณ<span class='math-exp'>ูข</span> - ูฆุณ + ูจ", "ุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูจ", "ุณ<span class='math-exp'>ูข</span> - ูจ", "ุณ<span class='math-exp'>ูข</span> + ูจ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ุณยฒ.", "ูข. ูุฌูุน (-ูข) ู (-ูค) ูููุนุงูู ุงูุฃูุณุท: -ูฆุณ.", "ูฃ. ูุถุฑุจ (-ูข) ร (-ูค) = +ูจ (ุณุงูุจ ร ุณุงูุจ = ููุฌุจ).", "ูค. ุงููุงุชุฌ: ุณยฒ - ูฆุณ + ูจ."] },
                { q: "(ุณ - ูก)(ุณ - ูฅ)", options: ["ุณ<span class='math-exp'>ูข</span> - ูฆุณ + ูฅ", "ุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูฅ", "ุณ<span class='math-exp'>ูข</span> + ูฅ", "ุณ<span class='math-exp'>ูข</span> - ูฅ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ุณยฒ.", "ูข. ูุฌูุน (-ูก) ู (-ูฅ) ูููุนุงูู ุงูุฃูุณุท: -ูฆุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: (-ูก) ร (-ูฅ) = +ูฅ.", "ูค. ุงููุงุชุฌ: ุณยฒ - ูฆุณ + ูฅ."] }
            ],
            // ูุณุชูู 4
            [
                { q: "(ูขุณ + ูก)(ุณ + ูฃ)", options: ["ูขุณ<span class='math-exp'>ูข</span> + ูงุณ + ูฃ", "ูขุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูฃ", "ูฃุณ + ูค", "ูขุณ<span class='math-exp'>ูข</span> + ูฃ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ูขุณ ร ุณ = ูขุณยฒ.", "ูข. ูุถุฑุจ ุงูุทุฑููู (ูฆุณ) ูุงููุณุทูู (ูกุณ) ููุฌูุนูู: ูงุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: ูก ร ูฃ = ูฃ.", "ูค. ุงููุงุชุฌ: ูขุณยฒ + ูงุณ + ูฃ."] },
                { q: "(ูฃุณ + ูข)(ุณ + ูก)", options: ["ูฃุณ<span class='math-exp'>ูข</span> + ูฅุณ + ูข", "ูฃุณ<span class='math-exp'>ูข</span> + ูฃุณ + ูข", "ูคุณ + ูฃ", "ูฃุณ<span class='math-exp'>ูข</span> + ูข"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ูฃุณ ร ุณ = ูฃุณยฒ.", "ูข. ุงูุฃุทุฑุงู: ูฃุณรูก=ูฃุณุ ุงูุฃูุณุงุท: ูขรุณ=ูขุณ. ูุฌููุนูู: ูฅุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: ูข ร ูก = ูข.", "ูค. ุงููุงุชุฌ: ูฃุณยฒ + ูฅุณ + ูข."] }
            ],
            // ูุณุชูู 5
            [
                { q: "(ูฃุณ - ูข)(ูขุณ + ูก)", options: ["ูฆุณ<span class='math-exp'>ูข</span> - ุณ - ูข", "ูฆุณ<span class='math-exp'>ูข</span> + ุณ - ูข", "ูฆุณ<span class='math-exp'>ูข</span> - ูค", "ูฅุณ - ูก"], correct: 0, steps: ["ูก. ูุถุฑุจ ูฃุณ ร ูขุณ = ูฆุณยฒ.", "ูข. ุงูุทุฑูุงู (ูฃุณ) ูุงููุณุทุงู (-ูคุณ) ูุฌููุนูู: -ุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: -ูข ร ูก = -ูข.", "ูค. ุงููุงุชุฌ: ูฆุณยฒ - ุณ - ูข."] },
                { q: "(ูขุณ + ูฅ)(ุณ - ูข)", options: ["ูขุณ<span class='math-exp'>ูข</span> + ุณ - ูกู", "ูขุณ<span class='math-exp'>ูข</span> - ุณ - ูกู", "ูขุณ<span class='math-exp'>ูข</span> + ูฅุณ - ูกู", "ูขุณ + ูฃ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุงูุฃูู ูู ุงูุฃูู: ูขุณยฒ.", "ูข. ุงูุฃุทุฑุงู: -ูคุณุ ุงูุฃูุณุงุท: +ูฅุณ. ูุฌููุนูู: +ุณ.", "ูฃ. ูุถุฑุจ ุงูุฃุฎูุฑูู: ูฅ ร (-ูข) = -ูกู.", "ูค. ุงููุงุชุฌ: ูขุณยฒ + ุณ - ูกู."] }
            ],
            // ูุณุชูู 6
            [
                { q: "(ุณ + ูฃ)<span class='math-exp'>ูข</span>", options: ["ุณ<span class='math-exp'>ูข</span> + ูฆุณ + ูฉ", "ุณ<span class='math-exp'>ูข</span> + ูฉ", "ุณ<span class='math-exp'>ูข</span> + ูฃุณ + ูฉ", "ูขุณ + ูฆ"], correct: 0, steps: ["ูก. ูุฑุจุน ุงูุฃูู: ุณยฒ.", "ูข. ูุถุฑุจ ุงูุฃูู ร ุงูุซุงูู ร ูข: ุณ ร ูฃ ร ูข = ูฆุณ.", "ูฃ. ูุฑุจุน ุงูุฃุฎูุฑ: ูฃยฒ = ูฉ.", "ูค. ุงููุงุชุฌ: ุณยฒ + ูฆุณ + ูฉ."] },
                { q: "(ุณ + ูค)<span class='math-exp'>ูข</span>", options: ["ุณ<span class='math-exp'>ูข</span> + ูจุณ + ูกูฆ", "ุณ<span class='math-exp'>ูข</span> + ูกูฆ", "ุณ<span class='math-exp'>ูข</span> + ูคุณ + ูกูฆ", "ูขุณ + ูจ"], correct: 0, steps: ["ูก. ูุฑุจุน ุงูุฃูู: ุณยฒ.", "ูข. ูุถุฑุจ ุงูุฃูู ร ุงูุซุงูู ร ูข: ุณ ร ูค ร ูข = ูจุณ.", "ูฃ. ูุฑุจุน ุงูุฃุฎูุฑ: ูคยฒ = ูกูฆ.", "ูค. ุงููุงุชุฌ: ุณยฒ + ูจุณ + ูกูฆ."] }
            ],
            // ูุณุชูู 7
            [
                { q: "(ุณ - ูก)(ุณ<span class='math-exp'>ูข</span> + ุณ + ูก)", options: ["ุณ<span class='math-exp'>ูฃ</span> - ูก", "ุณ<span class='math-exp'>ูฃ</span> + ูก", "ุณ<span class='math-exp'>ูฃ</span> + ุณ - ูก", "ุณ<span class='math-exp'>ูข</span> - ูก"], correct: 0, steps: ["ูก. ููุฒุน (ุณ) ุนูู ุงูููุณ ุงูุซุงูู: ุณยณ + ุณยฒ + ุณ.", "ูข. ููุฒุน (-ูก) ุนูู ุงูููุณ ุงูุซุงูู: -ุณยฒ - ุณ - ูก.", "ูฃ. ูุฌูุน ุงูุญุฏูุฏ ุงููุชุดุงุจูุฉ ููุฎุชูู ุงูุฃูุณุท.", "ูค. ุงููุชุจูู: ุณยณ - ูก."] },
                { q: "(ุณ + ูข)(ุณ<span class='math-exp'>ูข</span> - ูขุณ + ูค)", options: ["ุณ<span class='math-exp'>ูฃ</span> + ูจ", "ุณ<span class='math-exp'>ูฃ</span> - ูจ", "ุณ<span class='math-exp'>ูฃ</span> + ูค", "ุณ<span class='math-exp'>ูข</span> + ูค"], correct: 0, steps: ["ูก. ููุฒุน (ุณ): ุณยณ - ูขุณยฒ + ูคุณ.", "ูข. ููุฒุน (+ูข): ูขุณยฒ - ูคุณ + ูจ.", "ูฃ. ูุญุฐู ุงูุญุฏูุฏ ุงููุชุดุงุจูุฉ ุงููุชุนุงูุณุฉ ูู ุงูุฅุดุงุฑุฉ.", "ูค. ุงููุชุจูู: ุณยณ + ูจ."] }
            ],
            // ูุณุชูู 8
            [
                { q: "(ุณ + ูก)(ุณ + ูข)(ุณ + ูฃ)", options: ["ุณ<span class='math-exp'>ูฃ</span> + ูฆุณ<span class='math-exp'>ูข</span> + ูกูกุณ + ูฆ", "ุณ<span class='math-exp'>ูฃ</span> + ูฆ", "ุณ<span class='math-exp'>ูฃ</span> + ูฃุณ + ูฆ", "ูฃุณ + ูฆ"], correct: 0, steps: ["ูก. ูุถุฑุจ ุฃูู ููุณูู: (ุณ+ูก)(ุณ+ูข) = ุณยฒ+ูฃุณ+ูข.", "ูข. ูุถุฑุจ ุงููุงุชุฌ ูู ุงูููุณ ุงูุซุงูุซ: (ุณยฒ+ูฃุณ+ูข)(ุณ+ูฃ).", "ูฃ. ููุฒุน ุญุฏูุฏ ุงูููุณ ุงูุฃูู ุนูู ุงูุซุงูู ุจุชุฑููุฒ.", "ูค. ูุฌูุน ุณยณ ุซู (ูฃุณยฒ+ูฃุณยฒ) ุซู (ูฉุณ+ูขุณ) ุซู ุงูุซุงุจุช ูฆ.", "ูฅ. ุงููุงุชุฌ ุงูููุงุฆู: ุณยณ + ูฆุณยฒ + ูกูกุณ + ูฆ."] },
                { q: "(ุณ - ูก)(ุณ + ูก)(ุณ + ูข)", options: ["ุณ<span class='math-exp'>ูฃ</span> + ูขุณ<span class='math-exp'>ูข</span> - ุณ - ูข", "ุณ<span class='math-exp'>ูฃ</span> + ูข", "ุณ<span class='math-exp'>ูฃ</span> - ุณ + ูข", "ุณ<span class='math-exp'>ูข</span> + ูข"], correct: 0, steps: ["ูก. ูุถุฑุจ ุฃูู ููุณูู (ูุฑู ุจูู ูุฑุจุนูู): (ุณ-ูก)(ุณ+ูก) = ุณยฒ-ูก.", "ูข. ูุถุฑุจ ุงููุงุชุฌ ูู ุงูููุณ ุงูุซุงูุซ: (ุณยฒ-ูก)(ุณ+ูข).", "ูฃ. ููุฒุน ุณยฒ ุนูู (ุณ+ูข): ุณยณ + ูขุณยฒ.", "ูค. ููุฒุน -ูก ุนูู (ุณ+ูข): -ุณ - ูข.", "ูฅ. ุงููุงุชุฌ ุงูููุงุฆู ุจุงูุชุฑุชูุจ: ุณยณ + ูขุณยฒ - ุณ - ูข."] }
            ]
        ];

        let activeQuestions = [];
        let currentQuestionIdx = 0;
        let mainScore = 0;
        let isAnswering = false;
        let startTime, timerInterval;

        window.startGame = () => {
            activeQuestions = questionBank.map(level => level[Math.floor(Math.random() * level.length)]);
            currentQuestionIdx = 0;
            mainScore = 0;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            startTime = Date.now();
            timerInterval = setInterval(() => {
                document.getElementById('timer-display').textContent = toAr(Math.floor((Date.now() - startTime) / 1000));
            }, 1000);
            renderQuestion();
        };

        function renderQuestion() {
            isAnswering = false;
            const qData = activeQuestions[currentQuestionIdx];
            document.getElementById('progress-text').textContent = `ุงูุณุคุงู ${toAr(currentQuestionIdx + 1)} ูู ูจ`;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIdx + 1) / 8) * 100}%`;
            document.getElementById('question-text').innerHTML = qData.q.replace(/ุณ/g, '<span class="math-var">ุณ</span>');
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-card math-text';
                btn.innerHTML = opt.replace(/ุณ/g, '<span class="math-var">ุณ</span>');
                btn.onclick = () => checkAnswer(idx, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(idx, element) {
            if (isAnswering) return;
            isAnswering = true;
            const qData = activeQuestions[currentQuestionIdx];
            const allOptions = document.querySelectorAll('.option-card');
            const correctElement = allOptions[qData.correct];
            const isCorrect = (idx === qData.correct);
            if (isCorrect) { element.classList.add('correct', 'blink-correct'); mainScore++; }
            else { element.classList.add('wrong'); correctElement.classList.add('correct', 'blink-correct'); }
            setTimeout(() => showFeedback(isCorrect), 1800);
        }

        function showFeedback(isCorrect) {
            const qData = activeQuestions[currentQuestionIdx];
            const screen = document.getElementById('feedback-screen');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-title');
            const subtitle = document.getElementById('feedback-subtitle');
            icon.innerHTML = isCorrect ? '๐' : '๐ก';
            title.textContent = isCorrect ? 'ุฅุฌุงุจุฉ ุนุจูุฑูุฉ!' : 'ูุง ุจุฃุณุ ุชุนููู ูููุง!';
            title.className = `text-xl font-black ${isCorrect ? 'text-emerald-500' : 'text-amber-500'}`;
            subtitle.textContent = isCorrect ? 'ุฃูุช ุชูุถู ูุฏูุงู ูุญู ุงูุจุทููุฉ' : 'ูู ุฎุทุฃ ูู ูุฑุตุฉ ูุชุตุจุญ ุฃูุถู';
            document.getElementById('feedback-correct-text').innerHTML = qData.options[qData.correct].replace(/ุณ/g, '<span class="math-var">ุณ</span>');
            document.getElementById('exp-small-q').innerHTML = qData.q.replace(/ุณ/g, '<span class="math-var">ุณ</span>');
            const list = document.getElementById('steps-list');
            list.innerHTML = qData.steps.map(s => `<div class="step-row text-xs font-bold text-slate-700">${s}</div>`).join('');
            screen.classList.add('overlay-active');
        }

        window.openExplanation = () => document.getElementById('explanation-modal').style.display = 'flex';
        window.closeExplanation = () => document.getElementById('explanation-modal').style.display = 'none';

        window.nextStep = () => {
            document.getElementById('feedback-screen').classList.remove('overlay-active');
            currentQuestionIdx++;
            if (currentQuestionIdx < activeQuestions.length) { renderQuestion(); }
            else { showFinalResults(); }
        };

        function showFinalResults() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const finalGrade = ((mainScore / 8) * 5).toFixed(1); 
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `
                <div class="bg-blue-50 p-3 rounded-2xl flex flex-col justify-center"><p class="text-[8px] font-black text-blue-400 uppercase">ุตุญ</p><p class="text-lg font-black text-blue-900">${toAr(mainScore)} / ูจ</p></div>
                <div class="bg-emerald-50 p-3 rounded-2xl flex flex-col justify-center"><p class="text-[8px] font-black text-emerald-600 uppercase">ุงูุฏุฑุฌุฉ</p><p class="text-2xl font-black text-emerald-900">${toAr(finalGrade)}</p></div>
                <div class="bg-purple-50 p-3 rounded-2xl flex flex-col justify-center"><p class="text-[8px] font-black text-purple-400 uppercase">ุซุงููุฉ</p><p class="text-lg font-black text-purple-900">${toAr(totalTime)}</p></div>
            `;
            if (studentId && classId) {
                const p = new URLSearchParams({ action: 'saveScore', studentId, classId, itemId: GAME_ID, score: finalGrade, metricValue: totalTime, type: 'game' });
                fetch(`${SCRIPT_URL}?${p.toString()}`);
            }
        }

        window.fetchAndShowLeaderboard = function(isManual = false) {
            const modal = document.getElementById('leaderboard-modal');
            if (isManual) { modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal'); }
            
            // ุฅุฎูุงุก ุฒุฑ "ูุตูู" ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุฒุงุฆุฑุงู (ููุณ ูุฏูู classId)
            const tabClass = document.getElementById('tab-class');
            if (!classId) {
                tabClass.style.display = 'none';
                currentLeaderboardMode = 'global';
            } else {
                tabClass.style.display = 'block';
            }

            switchTab(currentLeaderboardMode);
        };

        window.switchTab = (m) => { 
            currentLeaderboardMode = m; 
            document.getElementById('tab-class').className = m === 'class' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; 
            document.getElementById('tab-global').className = m === 'global' ? 'tab-btn tab-active' : 'tab-btn tab-inactive'; 
            
            const content = document.getElementById('leaderboard-content');
            document.getElementById('modal-loader').classList.remove('hidden');
            let reqClassId = (m === 'class') ? classId : 'all';
            const url = `${SCRIPT_URL}?action=getLeaderboard&gameId=${GAME_ID}&classId=${encodeURIComponent(reqClassId || 'all')}&t=${Date.now()}`;
            fetch(url).then(r => r.json()).then(res => {
                let data = res.data || [];
                let h = `<table class="w-full text-right text-[11px]"><thead class="bg-slate-100"><tr><th class="p-2 text-center">#</th><th class="p-2">ุงูุจุทู</th><th class="p-2 text-center">ุงูุฏุฑุฌุฉ</th></tr></thead><tbody>`;
                if (data.length > 0) {
                    data.forEach((p, i) => {
                        const isMe = studentId && String(p.name).trim() === String(studentName).trim();
                        h += `<tr class="${isMe ? 'rank-row-me' : 'border-b border-slate-50'}">
                            <td class="p-2 text-center font-black">${i < 3 ? ['๐ฅ','๐ฅ','๐ฅ'][i] : toAr(i+1)}</td>
                            <td class="p-2 font-black">${p.name}</td>
                            <td class="p-2 text-center text-emerald-600 font-black">${toAr(parseFloat(p.grade).toFixed(1))}</td>
                        </tr>`;
                    });
                    content.innerHTML = h + `</tbody></table>`;
                } else content.innerHTML = `<div class="py-10 text-center text-slate-400">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ</div>`;
            }).finally(() => document.getElementById('modal-loader').classList.add('hidden'));
        };

        window.closeLeaderboardModal = () => document.getElementById('leaderboard-modal').classList.replace('visible-modal', 'hidden-modal');
        document.getElementById('finish-btn').onclick = () => window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('top-student-name').textContent = studentName;
            if (studentId && classId) {
                const url = `${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${encodeURIComponent(classId)}&itemId=${GAME_ID}&t=${Date.now()}`;
                fetch(url).then(r => r.json()).then(res => {
                    if (res.status === 'success' && res.data?.games?.[GAME_ID]) {
                        document.getElementById('top-prev-score').textContent = toAr(parseFloat(res.data.games[GAME_ID].grade).toFixed(1)) + " / ูฅ";
                    }
                }).catch(() => {});
            }
        });
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ…</title>
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Tailwind CSS Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ØªØ®ØµÙŠØµ Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        body {
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ù…Ø³ÙŠØ© */
            /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
            background-image: url('https://ablan-math.github.io/img/g3_2/g3_2.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆØ¶Ù…Ø§Ù† Ø§Ù…ØªØ¯Ø§Ø¯Ù‡Ø§ */
        }
        /* ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ Ù„Ù„Ø²Ø± Ù„ÙŠØ¹Ø·ÙŠ Ø´Ø¹ÙˆØ±Ø§Ù‹ Ø£ÙØ¶Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± */
        .answer-btn {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .answer-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ø®Ø§Ø·Ø¦Ø© */
        .correct {
            background-color: #28a745 !important; /* Ø£Ø®Ø¶Ø± */
            color: white !important;
            border-color: #218838 !important;
            animation: pulse 0.6s ease;
        }
        .incorrect {
            background-color: #dc3545 !important; /* Ø£Ø­Ù…Ø± */
            color: white !important;
            border-color: #c82333 !important;
            animation: shake 0.6s ease;
        }
        /* Ø­Ø±ÙƒØ§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù…Ø³Ø© Ø¬Ù…Ø§Ù„ÙŠØ© */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .disabled-options {
            pointer-events: none;
            opacity: 0.8;
        }
        /* Ø£Ù†Ù…Ø§Ø· Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø±Ø­ (Modal) */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©/Ø§Ù„Ø¨Ù†ÙŠØ© */
        .card-bg {
            background-color: rgba(255, 255, 255, 0.9);
        }
        #score-container {
             background-color: rgba(255, 255, 255, 0.95);
             color: #8B4513; /* Ø¨Ù†ÙŠ */
        }
        #question-container {
            background-color: rgba(250, 240, 230, 0.9); /* Ø¨ÙŠØ¬ ÙØ§ØªØ­ */
            border-color: #deb887; /* Ø°Ù‡Ø¨ÙŠ Ø¨Ø§Ù‡Øª */
            color: #2c3e50;
        }
        .text-blue-600 { /* Ù„ÙˆÙ† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ */
            color: #8B4513; /* Ø¨Ù†ÙŠ */
        }
        .text-slate-700 {
            color: #3d2b1f; /* Ø¨Ù†ÙŠ Ø¯Ø§ÙƒÙ† */
        }
        .answer-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: #d2b48c; /* ØªØ§Ù† */
        }
        .answer-btn:hover {
            background-color: rgba(253, 245, 230, 0.95);
            border-color: #c7993b; /* Ø°Ù‡Ø¨ÙŠ */
        }
        .text-amber-500 {
            color: #ffc107; /* Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ Ù„Ù„ÙƒØ£Ø³ */
        }
        
        #explanation-button {
            background-color: rgba(220, 220, 220, 0.9);
            color: #34495e;
        }
        #explanation-button:hover {
            background-color: rgba(200, 200, 200, 0.95);
        }
        .text-green-700 { color: #28a745; }
        .bg-green-100 { background-color: #d4edda; }
        .border-green-300 { border-color: #c3e6cb; }
        .text-red-600 { color: #dc3545; }
        .bg-blue-50 { background-color: rgba(253, 245, 230, 0.8); }
        .text-blue-700 { color: #8B4513; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© --><div id="start-screen" class="w-full max-w-md mx-auto p-6 card-bg rounded-2xl shadow-2xl text-center">
        <h1 class="text-3xl font-bold text-[#b8860b] mb-4">ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ©</h1>
        <p id="welcomeMessage" class="text-slate-700 text-base mb-6">Ø§Ø®ØªØ¨Ø± Ù…Ù‡Ø§Ø±ØªÙƒ ÙÙŠ Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ… Ø¨ØµÙŠØºØ© Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹.</p>
        <p class="text-slate-700 font-medium mb-8 bg-blue-50 p-3 rounded-lg border border-[#deb887]">ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø¬Ù‡Ù‘Ø² ÙˆØ±Ù‚Ø© ÙˆÙ‚Ù„Ù…Ù‹Ø§ Ù„ØªØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø­Ù„!</p>
        <button id="start-button" class="w-full bg-[#c7993b] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#a97e28] focus:outline-none focus:ring-4 focus:ring-[#c7993b]/50 transition-all duration-300 shadow-lg text-lg">
            Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!
        </button>
        <p class="text-sm text-slate-500 mt-8">Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø®ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) --><div id="game-container" class="hidden w-full max-w-md mx-auto p-4 md:p-6 card-bg rounded-2xl shadow-2xl text-center flex flex-col">
        <!-- SVG Icons --><div class="hidden">
            <svg id="trophy-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            <svg id="checkmark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
            <svg id="cross-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </div>
        
        <div class="flex-grow">
            <div id="score-container" class="flex justify-center items-center gap-2 text-lg font-bold text-amber-500 mb-4 rounded-lg shadow-inner">
                <div id="trophy-container"></div>
                <span>Ø§Ù„Ù†Ù‚Ø§Ø·: </span>
                <span id="score">Ù </span>
            </div>
            <div id="question-container" class="p-4 border-2 rounded-lg mb-4 text-lg font-bold transition-all duration-300 shadow-md">
                <p id="question-text">Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!</p>
            </div>
            <div id="answers-container" class="grid grid-cols-2 gap-3"></div>
        </div>
        
        <div class="mt-auto pt-4">
            <div id="feedback-container" class="mb-2 h-8 flex items-center justify-center transition-all duration-300"></div>
            <div id="controls-container" class="grid grid-cols-2 gap-3">
                <button id="explanation-button" class="hidden w-full text-gray-700 font-bold py-2 px-3 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300 text-sm shadow-sm">Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                <button id="next-button" class="hidden w-full bg-[#c7993b] text-white font-bold py-2 px-3 rounded-lg hover:bg-[#a97e28] focus:outline-none focus:ring-4 focus:ring-[#c7993b]/50 transition-all duration-300 shadow-lg text-base">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© --><div id="finish-screen" class="hidden w-full max-w-md mx-auto p-6 card-bg rounded-2xl shadow-2xl text-center">
        <h2 class="text-3xl font-bold text-[#b8860b] mb-4">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ!</h2>
        <div id="final-result-display" class="space-y-2 mb-6">
            <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
        </div>
        <div id="leaderboard-loader" style="display: none;" class="flex justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
        </div>
        <div id="leaderboard-container">
            <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
        </div>
        <div id="finish-game-wrapper" style="display: none;" class="mt-6">
             <button id="finish-game-btn" class="w-full bg-[#c7993b] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#a97e28] focus:outline-none focus:ring-4 focus:ring-[#c7993b]/50 transition-all duration-300 shadow-lg text-lg">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø±Ø­ (Modal) --><div id="explanation-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal-content w-full max-w-md bg-white/80 backdrop-blur-sm rounded-2xl p-5 shadow-xl text-right scale-95 opacity-0">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-[#b8860b]">Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„</h2>
                <button id="close-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="explanation-content" class="text-slate-700 space-y-2 leading-relaxed text-sm"></div>
        </div>
    </div>

    <script>
        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const startScreenEl = document.getElementById('start-screen');
        const gameContainerEl = document.getElementById('game-container');
        const finishScreenEl = document.getElementById('finish-screen');
        const startButtonEl = document.getElementById('start-button');
        const questionTextEl = document.getElementById('question-text');
        const answersContainerEl = document.getElementById('answers-container');
        const feedbackContainerEl = document.getElementById('feedback-container');
        const nextButtonEl = document.getElementById('next-button');
        const scoreEl = document.getElementById('score');
        const trophyContainerEl = document.getElementById('trophy-container');
        const explanationButtonEl = document.getElementById('explanation-button');
        const explanationModalEl = document.getElementById('explanation-modal');
        const explanationContentEl = document.getElementById('explanation-content');
        const closeModalButtonEl = document.getElementById('close-modal-button');

        // --- Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        let state = {
            score: 0,
            currentQuestionDetails: {},
            questionCount: 0,
        };
        const TOTAL_QUESTIONS = 5;
        let startTime;

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const toArabicNumerals = (num) => {
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return String(num).replace(/[0-9.-]/g, (d) => {
                if (d === '-') return '-';
                if (d === '.') return 'Ù«';
                return arabicNumerals[parseInt(d)];
            });
        };
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };
        const formatEquation = (m, b) => {
            if (m === 0) return `Øµ = ${toArabicNumerals(b)}`;
            let equation = 'Øµ = ';
            if (m === 1) equation += 'Ø³';
            else if (m === -1) equation += '-Ø³';
            else equation += `${toArabicNumerals(m)} Ø³`;
            if (b > 0) equation += ` + ${toArabicNumerals(b)}`;
            else if (b < 0) equation += ` - ${toArabicNumerals(Math.abs(b))}`;
            return equation;
        };
        
        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function generateQuestion() {
            state.questionCount++;
            let questionType;
            if (state.questionCount === 1) questionType = 'direct';
            else if (state.questionCount <= 3) questionType = 'pointSlope';
            else if (state.questionCount <= 5) questionType = 'twoPoints';
            
            let m = getRandomInt(-5, 5);
            if (m === 0) m = getRandomInt(1, 4) * (Math.random() < 0.5 ? 1 : -1);
            let b = getRandomInt(-10, 10);
            
            if (questionType === 'direct') {
                questionTextEl.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ… Ø§Ù„Ø°ÙŠ Ù…ÙŠÙ„Ù‡ <span class="text-blue-600">${toArabicNumerals(m)}</span> ÙˆÙ…Ù‚Ø·Ø¹Ù‡ Ø§Ù„ØµØ§Ø¯ÙŠ <span class="text-blue-600">${toArabicNumerals(b)}</span>ØŸ`;
                state.currentQuestionDetails = { questionType, m, b };
            } else {
                let x1 = getRandomInt(-5, 5);
                let y1 = m * x1 + b;
                state.currentQuestionDetails = { questionType, m, b, x1, y1 };
                if (questionType === 'pointSlope') {
                    questionTextEl.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ… Ø§Ù„Ø°ÙŠ Ù…ÙŠÙ„Ù‡ <span class="text-blue-600">${toArabicNumerals(m)}</span> ÙˆÙŠÙ…Ø± Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© <span class="text-blue-600">(${toArabicNumerals(x1)}ØŒ ${toArabicNumerals(y1)})</span>ØŸ`;
                } else { // twoPoints
                    let x2;
                    do { x2 = getRandomInt(-5, 5); } while (x2 === x1);
                    let y2 = m * x2 + b;
                    state.currentQuestionDetails.x2 = x2;
                    state.currentQuestionDetails.y2 = y2;
                    questionTextEl.innerHTML = `Ù…Ø§ Ù‡ÙŠ Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‚ÙŠÙ… Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø± Ø¨Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† <span class="text-blue-600">(${toArabicNumerals(x1)}ØŒ ${toArabicNumerals(y1)})</span> Ùˆ <span class="text-blue-600">(${toArabicNumerals(x2)}ØŒ ${toArabicNumerals(y2)})</span>ØŸ`;
                }
            }
            
            const options = [{ m, b, correct: true }];
            const addedOptions = new Set([`${m},${b}`]);

            // **Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¶Ù„Ù„Ø©**
            // 1. Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ù…ÙŠÙ„ ÙˆÙ…Ù‚Ø·Ø¹ Ø®Ø§Ø·Ø¦
            if (options.length < 4) {
                let wrongB;
                do { wrongB = b + getRandomInt(-5, 5); } while (wrongB === b);
                const optionKey = `${m},${wrongB}`;
                if (!addedOptions.has(optionKey)) {
                    options.push({ m: m, b: wrongB, correct: false });
                    addedOptions.add(optionKey);
                }
            }

            // 2. ØªØ¹Ø¨Ø¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙ†ÙˆØ¹
            while (options.length < 4) {
                let wrongM, wrongB;
                // 50% ÙØ±ØµØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®ÙŠØ§Ø± Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ù…ÙŠÙ„ (Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠ)
                if (Math.random() < 0.5) {
                    wrongM = m;
                    do { wrongB = b + getRandomInt(-6, 6); } while (wrongB === b);
                } else {
                    // Ø®ÙŠØ§Ø± Ø¨Ù…ÙŠÙ„ Ù…Ø®ØªÙ„Ù
                    do {
                        wrongM = m + getRandomInt(-2, 2);
                        wrongB = b + getRandomInt(-5, 5);
                    } while (wrongM === m); // Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙŠÙ„ Ù…Ø®ØªÙ„Ù
                }
                
                const optionKey = `${wrongM},${wrongB}`;
                if (!addedOptions.has(optionKey)) {
                    options.push({ m: wrongM, b: wrongB, correct: false });
                    addedOptions.add(optionKey);
                }
            }
            shuffleArray(options);
            displayOptions(options);
        }

        function displayOptions(options) {
            answersContainerEl.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'answer-btn w-full p-3 border-2 rounded-lg text-base font-bold hover:border-[#c7993b] focus:outline-none focus:ring-2 focus:ring-[#c7993b]/50 shadow-md';
                button.textContent = formatEquation(option.m, option.b);
                button.onclick = () => checkAnswer(option.correct, button);
                answersContainerEl.appendChild(button);
            });
        }
        
        function checkAnswer(isCorrect, button) {
            answersContainerEl.classList.add('disabled-options');
            explanationButtonEl.classList.remove('hidden');
            feedbackContainerEl.innerHTML = '';

            if (isCorrect) {
                state.score += 10;
                scoreEl.textContent = toArabicNumerals(state.score);
                button.classList.add('correct');
                const feedbackIcon = document.getElementById('checkmark-icon').cloneNode(true);
                const feedbackText = document.createElement('span');
                feedbackIcon.classList.add('text-green-500', 'w-7', 'h-7');
                feedbackText.className = 'text-green-600 font-bold text-lg mr-2';
                feedbackText.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø±Ø§Ø¦Ø¹Ø©!';
                feedbackContainerEl.appendChild(feedbackText);
                feedbackContainerEl.appendChild(feedbackIcon);
            } else {
                button.classList.add('incorrect');
                const correctButton = Array.from(answersContainerEl.children).find(btn => btn.textContent === formatEquation(state.currentQuestionDetails.m, state.currentQuestionDetails.b));
                if(correctButton) correctButton.classList.add('correct');
                const feedbackIcon = document.getElementById('cross-icon').cloneNode(true);
                feedbackIcon.classList.add('text-red-500', 'w-7', 'h-7');
                feedbackContainerEl.appendChild(feedbackIcon);
            }
            
            if(state.questionCount >= TOTAL_QUESTIONS){
                nextButtonEl.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©';
            }
            nextButtonEl.classList.remove('hidden');
        }
        
        function handleNextStep(){
            if(state.questionCount >= TOTAL_QUESTIONS){
                endGame();
            } else {
                resetForNextQuestion();
            }
        }

        function endGame(){
            const endTime = new Date();
            const totalTimeInSeconds = Math.round((endTime - startTime) / 1000);
            gameContainerEl.classList.add('hidden');
            finishScreenEl.classList.remove('hidden');
            saveAndFinishGame(state.score, totalTimeInSeconds);
        }

        function generateExplanationHTML() {
            const { questionType, m, b, x1, y1, x2, y2 } = state.currentQuestionDetails;
            let html = '';
            if (questionType === 'direct') {
                html = `<p>Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù…Ù† Ø§Ù„Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹:</p>
                    <ol class="list-decimal list-inside space-y-2 mt-2">
                        <li>Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØµÙŠØºØ©: <code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">Øµ = Ù… Ø³ + Ø¨</code></li>
                        <li>Ù„Ø¯ÙŠÙ†Ø§ Ø§Ù„Ù…ÙŠÙ„ <strong class="text-red-600">Ù… = ${toArabicNumerals(m)}</strong> ÙˆØ§Ù„Ù…Ù‚Ø·Ø¹ <strong class="text-red-600">Ø¨ = ${toArabicNumerals(b)}</strong>.</li>
                        <li>Ù†Ø¹ÙˆØ¶ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ Ø§Ù„ØµÙŠØºØ©:
                            <div class="text-center my-2"><code class="font-bold text-base text-green-700 bg-green-100 p-2 rounded-lg border-2 border-green-300 inline-block">${formatEquation(m,b)}</code></div>
                        </li></ol>`;
            } else if (questionType === 'pointSlope') {
                html = `<p>Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù…Ù† Ù…ÙŠÙ„ ÙˆÙ†Ù‚Ø·Ø©:</p>
                    <ol class="list-decimal list-inside space-y-2 mt-2">
                        <li>Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØµÙŠØºØ©: <code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">Øµ = Ù… Ø³ + Ø¨</code></li>
                        <li>Ù„Ø¯ÙŠÙ†Ø§ Ø§Ù„Ù…ÙŠÙ„ <strong class="text-red-600">Ù… = ${toArabicNumerals(m)}</strong>. ÙˆÙ†Ø±ÙŠØ¯ Ø¥ÙŠØ¬Ø§Ø¯ (Ø¨).</li>
                        <li>Ù†Ø¹ÙˆØ¶ Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© <strong class="text-red-600">(${toArabicNumerals(x1)}ØŒ ${toArabicNumerals(y1)})</strong> ÙˆØ§Ù„Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„ØµÙŠØºØ©:
                            <br><code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">${toArabicNumerals(y1)} = (${toArabicNumerals(m)}) Ã— (${toArabicNumerals(x1)}) + Ø¨</code></li>
                        <li>Ù†Ø¨Ø³Ø· Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„Ø¥ÙŠØ¬Ø§Ø¯ (Ø¨):
                            <br><code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">${toArabicNumerals(y1)} = ${toArabicNumerals(m * x1)} + Ø¨</code>
                            <br><code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">Ø¨ = ${toArabicNumerals(y1)} - (${toArabicNumerals(m * x1)}) = ${toArabicNumerals(b)}</code></li>
                        <li>Ù†ÙƒØªØ¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:
                            <div class="text-center my-2"><code class="font-bold text-base text-green-700 bg-green-100 p-2 rounded-lg border-2 border-green-300 inline-block">${formatEquation(m,b)}</code></div>
                        </li></ol>`;
            } else { // twoPoints
                 const fractionHTML = (num, den) => `<span class="inline-flex flex-col text-center align-middle mx-1 leading-none"><span class="px-1 pb-1">${num}</span><span class="border-t-2 border-current w-full"></span><span class="px-1 pt-1">${den}</span></span>`;
                 html = `<p>Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ù…Ù† Ù†Ù‚Ø·ØªÙŠÙ†:</p>
                    <ol class="list-decimal list-inside space-y-2 mt-2">
                        <li>Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…ÙŠÙ„ (Ù…):
                            <div class="flex items-center justify-center bg-blue-50 p-2 rounded my-1 text-blue-700 font-mono text-sm">
                                <span class="mx-1">Ù… =</span>${fractionHTML('Øµâ‚‚ - Øµâ‚', 'Ø³â‚‚ - Ø³â‚')}<span class="mx-1">=</span>${fractionHTML(`${toArabicNumerals(y2)} - (${toArabicNumerals(y1)})`, `${toArabicNumerals(x2)} - (${toArabicNumerals(x1)})`)}<span class="mx-1">= ${toArabicNumerals(m)}</span>
                            </div>
                        </li>
                        <li>Ø§Ù„Ø¢Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙ„ Ù…Ø¹ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ø£ÙˆÙ„Ù‰) Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø·Ø¹ (Ø¨).</li>
                        <li>Ù†Ø¹ÙˆØ¶ Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© <strong class="text-red-600">(${toArabicNumerals(x1)}ØŒ ${toArabicNumerals(y1)})</strong> ÙˆØ§Ù„Ù…ÙŠÙ„:
                            <br><code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">${toArabicNumerals(y1)} = (${toArabicNumerals(m)}) Ã— (${toArabicNumerals(x1)}) + Ø¨</code></li>
                        <li>Ù†Ø¨Ø³Ø· Ù„Ø¥ÙŠØ¬Ø§Ø¯ (Ø¨):<br><code class="font-mono text-blue-700 bg-blue-50 p-1 rounded">Ø¨ = ${toArabicNumerals(b)}</code></li>
                        <li>Ù†ÙƒØªØ¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:
                            <div class="text-center my-2"><code class="font-bold text-base text-green-700 bg-green-100 p-2 rounded-lg border-2 border-green-300 inline-block">${formatEquation(m,b)}</code></div>
                        </li></ol>`;
            }
            return html;
        }

        function showExplanation() {
            explanationContentEl.innerHTML = generateExplanationHTML();
            explanationModalEl.classList.remove('hidden');
            setTimeout(() => {
                explanationModalEl.classList.remove('opacity-0');
                explanationModalEl.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                explanationModalEl.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideExplanation() {
             explanationModalEl.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
             explanationModalEl.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
             explanationModalEl.classList.add('opacity-0');
             setTimeout(() => {
                explanationModalEl.classList.add('hidden');
             }, 300);
        }

        function resetForNextQuestion() {
            answersContainerEl.classList.remove('disabled-options');
            feedbackContainerEl.innerHTML = '';
            nextButtonEl.classList.add('hidden');
            explanationButtonEl.classList.add('hidden');
            generateQuestion();
        }

        function initializeGame() {
            startButtonEl.addEventListener('click', () => {
                state.score = 0;
                state.questionCount = 0;
                scoreEl.textContent = toArabicNumerals(state.score);
                startTime = new Date();
                startScreenEl.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');
                finishScreenEl.classList.add('hidden');
                resetForNextQuestion();
            });
            
            trophyContainerEl.appendChild(document.getElementById('trophy-icon').cloneNode(true));
            nextButtonEl.addEventListener('click', handleNextStep);
            explanationButtonEl.addEventListener('click', showExplanation);
            closeModalButtonEl.addEventListener('click', hideExplanation);
            explanationModalEl.addEventListener('click', (e) => {
                if (e.target === explanationModalEl) hideExplanation();
            });
        }
        
        document.addEventListener('DOMContentLoaded', initializeGame);

// --- START OF CONNECTION & LEADERBOARD ENGINE ---
(function() {
    // --- CONFIGURATION (Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù„Ø¹Ø¨Ø©) ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const GAME_ID = 'g3_2_1';                       // Ù…Ø«Ø§Ù„: 'g1_1_1'
    const GAME_MAX_POINTS = 50;                     // Ø£Ù‚ØµÙ‰ Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
    const PLATFORM_MAX_GRADE = 5;                   // Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©
    const METRIC_TYPE = 'time';                     // Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±: 'time', 'stars', 'errors'
    const METRIC_LABEL = 'Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ)';           // Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„

    // --- Read URL Parameters ---
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('studentId');
    const classId = urlParams.get('classId');
    const studentName = urlParams.get('studentName');

    let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

    // --- CORE FUNCTIONS ---

    // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    window.saveAndFinishGame = function(points, metricValue) {
        const finalPoints = parseFloat(points) || 0;
        const finalMetric = parseFloat(metricValue) || 0;
        const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
        const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

        const resultDisplay = document.getElementById('final-result-display');
        if (resultDisplay) {
            resultDisplay.innerHTML = `
                <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                <p class="text-[#b8860b]">Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
            `;
        }

        if (studentId && classId) {
            const params = new URLSearchParams({
                action: 'saveGrade',
                studentId: studentId,
                classId: classId,
                itemId: GAME_ID,
                grade: finalGrade.toFixed(2),
                metricValue: Math.round(finalMetric).toString()
            });
            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(result => console.log('Save result:', result.status))
                .catch(err => console.error("Save Error:", err))
                .finally(fetchAndShowLeaderboard);
        } else {
            console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
            fetchAndShowLeaderboard();
        }
    }

    // 2. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
    function fetchAndShowLeaderboard() {
        const loader = document.getElementById('leaderboard-loader');
        const container = document.getElementById('leaderboard-container');
        if (!loader || !container) return;
        
        if (!classId) {
            console.log("No classId found, skipping leaderboard for visitor.");
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
            showFinishButton();
            return;
        }

        loader.style.display = 'block';
        container.innerHTML = '';

        const params = new URLSearchParams({
            action: 'getLeaderboard',
            gameId: GAME_ID,
            metricType: METRIC_TYPE,
            classId: classId
        });

        fetch(`${SCRIPT_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success' && response.data) {
                    displayLeaderboard(response.data);
                } else {
                    throw new Error(response.message || 'Failed to load leaderboard data.');
                }
            })
            .catch(err => {
                console.error("Leaderboard Error:", err);
                container.innerHTML = `<p class="text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
            })
            .finally(() => {
                loader.style.display = 'none';
                showFinishButton();
            });
    }
    
    // 3. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
    function displayLeaderboard(data) {
        const container = document.getElementById('leaderboard-container');
        if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
            return;
        }

        let tableHTML = `
            <div class="mt-6 border-t pt-4">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                <table class="min-w-full bg-white shadow-md rounded-lg">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="text-center py-2 px-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                            <th class="text-right py-2 px-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th class="text-center py-2 px-3">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">`;

        data.forEach((player, index) => {
            const rank = index + 1;
            let rankDisplay = rank;
            if (rank === 1) rankDisplay = 'ğŸ¥‡';
            if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
            if (rank === 3) rankDisplay = 'ğŸ¥‰';

            const isCurrentUser = (currentUser && player.name === currentUser.name);
            const rowClass = isCurrentUser ? 'bg-amber-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

            tableHTML += `
                <tr class="${rowClass}">
                    <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                    <td class="text-right py-2 px-3">${player.name}</td>
                    <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                    <td class="text-center py-2 px-3">${player.metricValue}</td>
                </tr>`;
        });

        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
    function showFinishButton() {
        const finishWrapper = document.getElementById('finish-game-wrapper');
        if (finishWrapper) {
            finishWrapper.style.display = 'block';
        }
    }

    // 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ®ØµÙŠØµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    document.addEventListener('DOMContentLoaded', () => {
        // Personalize welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (studentName && welcomeMessage) {
            welcomeMessage.innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ <span class="font-bold text-[#b8860b]">${studentName}</span>! Ø§Ù†Ø·Ù„Ù‚ ÙÙŠ Ø±Ø­Ù„ØªÙƒ Ù„Ø­Ù„ Ø£Ù„ØºØ§Ø² Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ©.`;
        }

        const finishBtn = document.getElementById('finish-game-btn');
        if (finishBtn) {
            finishBtn.addEventListener('click', () => {
                window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
            });
        }
    });
})();
// --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‡Ù…Ø© Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙˆØ§Ù„</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice Arabic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: 'Cairo', sans-serif;
            touch-action: manipulation;
        }
        .choice-btn {
            transition: all 0.2s ease-in-out;
        }
        .choice-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
            transform: scale(1.05);
            animation: popIn 0.3s ease;
        }
        .incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626 !important;
            animation: shake 0.5s ease;
        }
        .hidden { display: none; }
        .math-expr {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            direction: ltr;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(243, 244, 246, 0.9); /* Semi-transparent background */
            border: 1px solid #e5e7eb;
            display: inline-flex; /* Use flex for alignment */
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 58px; /* Ensure consistent height */
        }
        /* Styling for fractions */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2em;
        }
        .fraction > span:first-child {
            border-bottom: 1.5px solid currentColor;
            padding: 0 0.4em;
        }
        .fraction > span:last-child {
            padding: 0 0.4em;
        }
        /* Styling for Arabic Square Root */
        .arabic-root {
            display: inline-flex;
            align-items: center;
            direction: rtl;
        }
        .arabic-root .radicand {
            border-top: 1.5px solid currentColor;
            padding: 0 0.3em;
        }
        .arabic-root .symbol {
            font-size: 1.5em;
            line-height: 1;
        }
        .highlight {
            color: #6d28d9;
            font-weight: bold;
        }
        .highlight-equation {
            display: inline-block;
            font-size: 1.25rem;
            font-weight: bold;
            color: #5b21b6;
            margin: 0 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: #f5f3ff;
            border-radius: 0.5rem;
        }
        #question small {
            font-size: 0.8rem;
            color: #475569;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.9); }
            70% { transform: scale(1.08); }
            100% { transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .fade-in-section { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 text-center flex flex-col h-full max-h-[95vh] overflow-y-auto">

        <!-- Start Screen -->
        <div id="start-screen" class="fade-in-section">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800 mb-2">ğŸš€ Ù…Ù‡Ù…Ø© Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ ğŸš€</h1>
            <p id="welcomeMessage" class="text-slate-600 text-base sm:text-lg mb-4">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ù‡Ù…ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©!</p>

            <div class="text-center border-t border-b py-3 mb-4 space-y-2">
                <h2 class="text-lg sm:text-xl font-bold text-violet-700">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³: Ø§Ù„Ø¯ÙˆØ§Ù„</h2>
                <p class="text-slate-600 text-sm sm:text-base leading-relaxed px-2">
                    Ø³ØªÙˆØ§Ø¬Ù‡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø© Ø§Ù„ØªÙŠ ØªØºØ·ÙŠ Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ§Ù„ØŒ Ù…Ù† Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ†Ù‡Ø§ ÙˆØ¨ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙŠØ©ØŒ ÙˆØµÙˆÙ„Ù‹Ø§ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ù‡Ø§ ÙˆØªØ·Ø¨ÙŠÙ‚Ø§ØªÙ‡Ø§ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.
                    <br>
                    <span class="font-bold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨:</span> ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªÙ…Ù†Ø­Ùƒ <span class="highlight">Ù¡Ù  Ù†Ù‚Ø§Ø·</span>. Ø³ÙŠØªÙ… Ø£ÙŠØ¶Ù‹Ø§ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø°ÙŠ ØªØ³ØªØºØ±Ù‚Ù‡ ÙÙŠ Ø§Ù„Ø­Ù„ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø£Ø³Ø±Ø¹!
                </p>
            </div>
            
            <button id="start-btn" class="w-full md:w-auto bg-violet-600 text-white font-bold py-3 px-12 rounded-lg text-lg sm:text-xl hover:bg-violet-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ!
            </button>
            
            <p class="text-xs text-slate-400 mt-6">
                ØªØ·ÙˆÙŠØ± ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†
            </p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden h-full flex flex-col">
            <!-- Header: Score and Timer -->
            <div class="flex justify-between items-center mb-2">
                <div class="text-base sm:text-lg font-bold text-violet-600">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
                <div id="timer" class="text-lg sm:text-xl font-bold bg-slate-200 text-slate-800 rounded-full w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center shadow-inner">Ù¡Ù¥</div>
            </div>
             <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                <div id="progress-bar" class="bg-violet-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
            </div>
            
            <!-- Question Section -->
            <div id="question-section" class="fade-in-section relative flex-grow flex flex-col justify-center">
                <!-- Background Icon -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <span id="background-icon" class="text-[12rem] sm:text-[14rem] text-gray-200 select-none" style="opacity: 0.5;"></span>
                </div>
                
                <!-- Content -->
                <div class="relative z-10">
                    <h2 id="stage-title" class="text-xl sm:text-2xl md:text-3xl font-bold text-violet-800 mb-2"></h2>
                    <div id="question" class="text-slate-700 text-base sm:text-lg mb-3 min-h-[56px] p-2 sm:p-4 border-2 border-white/50 rounded-lg bg-white/75 backdrop-blur-sm"></div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedback-section" class="hidden fade-in-section flex-grow flex flex-col justify-center">
                 <h3 id="feedback-title" class="text-2xl sm:text-3xl font-bold mb-3"></h3>
                 
                 <div id="correct-answer-display" class="hidden mb-3">
                    <p class="text-slate-600">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ:</p>
                    <div id="correct-answer-box" class="mt-2 p-2 sm:p-3 border-2 border-green-500 rounded-lg bg-green-50 text-green-700 font-bold text-lg">
                    </div>
                 </div>

                 <p id="feedback-explanation" class="hidden text-base sm:text-lg bg-slate-100 p-3 rounded-lg text-slate-700 mb-4"></p>
                 
                 <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="show-solution-btn" class="w-full sm:w-auto bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">
                        Ø§Ø¹Ø±Ù Ø§Ù„Ø­Ù„
                    </button>
                    <button id="next-btn" class="w-full sm:w-auto bg-gray-800 text-white font-bold py-3 px-12 rounded-lg text-lg hover:bg-gray-900 transition-colors">
                        Ø§Ù„ØªØ§Ù„ÙŠ (<span id="next-stage-timer">Ù§</span>)
                    </button>
                 </div>
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden fade-in-section flex flex-col h-full">
             <div class="text-6xl sm:text-8xl mb-2">ğŸ†</div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mb-2">Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø£Ù†Ø¬Ø²Øª Ø§Ù„Ù…Ù‡Ù…Ø©</h1>
            <div id="final-result-display" class="my-2 sm:my-4 text-base sm:text-lg"></div>
            
            <div id="leaderboard-loader" style="display: none;" class="mt-4">
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„...</p>
            </div>
            <div id="leaderboard-container" class="flex-grow overflow-hidden">
                <!-- Leaderboard table will be injected here -->
            </div>
            
            <div id="finish-game-wrapper" style="display: none;" class="mt-4 flex flex-col sm:flex-row items-center gap-3 sm:gap-4">
                 <button id="restart-btn" class="w-full sm:w-auto bg-violet-600 text-white font-bold py-3 px-10 rounded-lg text-lg hover:bg-violet-700 transition-colors duration-300 shadow-lg">
                    Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                </button>
                <button id="finish-game-btn" class="w-full sm:w-auto bg-gray-800 text-white font-bold py-3 px-10 rounded-lg text-lg hover:bg-gray-900 transition-colors">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Helper function for Arabic Numerals ---
        const toArabicNumerals = (num) => {
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return String(num).replace(/[0-9]/g, (digit) => arabicNumerals[digit]);
        };
        
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        
        // Question Section Elements
        const questionSection = document.getElementById('question-section');
        const backgroundIcon = document.getElementById('background-icon');
        const stageTitle = document.getElementById('stage-title');
        const questionText = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');

        // Feedback Section Elements
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackTitle = document.getElementById('feedback-title');
        const correctAnswerDisplay = document.getElementById('correct-answer-display');
        const correctAnswerBox = document.getElementById('correct-answer-box');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const showSolutionBtn = document.getElementById('show-solution-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // --- Audio Context for Sound Effects ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            } else if (type === 'incorrect') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            } else { // click
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            }
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        // --- Question Banks ---
        const questionBanks = [
            // Bank 1: Is it a function? (Sets of ordered pairs)
            [
                { icon: 'ğŸšª', title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ", question: "Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙŠ <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>!", options: ["{ (Ù¢ØŒ Ù¡)ØŒ (Ù£ØŒ <span dir='rtl'>-Ù¢</span>)ØŒ (Ù¢ØŒ Ù¤) }", "{ (Ù¡ØŒ Ù¥)ØŒ (Ù¢ØŒ Ù¦)ØŒ (Ù§ØŒ Ù¦) }"], correctAnswer: "{ (Ù¡ØŒ Ù¥)ØŒ (Ù¢ØŒ Ù¦)ØŒ (Ù§ØŒ Ù¦) }", explanation: "ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø©ØŒ ÙƒÙ„ Ù…Ø¯Ø®Ù„ (Ø³) ÙŠØ±ØªØ¨Ø· Ø¨Ù…Ø®Ø±Ø¬ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·. <br> Ø¥Ø°Ø§ ØªÙƒØ±Ø± Ø¹Ù†ØµØ± Ù…Ù† (Ø³)ØŒ ÙÙ‡ÙŠ Ù„ÙŠØ³Øª Ø¯Ø§Ù„Ø©." },
                { icon: 'ğŸšª', title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ", question: "Ø£ÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>Ù„Ø§ ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ", options: ["{ (Ù¡ØŒ Ù¡)ØŒ (Ù¢ØŒ Ù¢)ØŒ (Ù£ØŒ Ù£) }", "{ (Ù¤ØŒ Ù¥)ØŒ (Ù¤ØŒ Ù¦)ØŒ (Ù§ØŒ Ù¨) }"], correctAnswer: "{ (Ù¤ØŒ Ù¥)ØŒ (Ù¤ØŒ Ù¦)ØŒ (Ù§ØŒ Ù¨) }", explanation: "Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ù„ÙŠØ³Øª Ø¯Ø§Ù„Ø© Ù„Ø£Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ Ù¤ ØªÙƒØ±Ø± ÙˆØ§Ø±ØªØ¨Ø· Ø¨Ù…Ø®Ø±Ø¬ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ† (Ù¥ Ùˆ Ù¦)." },
                { icon: 'ğŸšª', title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ", question: "Ø£ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ", options: ["{ (Ø£ ØŒ Ø¨)ØŒ (Ø¬ ØŒ Ø¯)ØŒ (Ù‡Ù€ ØŒ Ùˆ) }", "{ (Ùƒ ØŒ Ù„)ØŒ (Ù… ØŒ Ù†)ØŒ (Ùƒ ØŒ Ø³) }"], correctAnswer: "{ (Ø£ ØŒ Ø¨)ØŒ (Ø¬ ØŒ Ø¯)ØŒ (Ù‡Ù€ ØŒ Ùˆ) }", explanation: "ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø© Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªÙƒØ±Ø§Ø± ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¬Ø§Ù„ (Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª)." },
                { icon: 'ğŸšª', title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ", question: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØªÙŠ <span class='highlight'>Ù„Ø§ ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>:", options: ["{ (Ù¡Ù ØŒ Ù¢Ù )ØŒ (Ù¢Ù ØŒ Ù£Ù )ØŒ (Ù£Ù ØŒ Ù¢Ù ) }", "{ (Ù ØŒ Ù )ØŒ (Ù¡ØŒ Ù¡)ØŒ (Ù ØŒ Ù¢) }"], correctAnswer: "{ (Ù ØŒ Ù )ØŒ (Ù¡ØŒ Ù¡)ØŒ (Ù ØŒ Ù¢) }", explanation: "Ø§Ù„Ù…Ø¯Ø®Ù„ Ù  Ø§Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø®Ø±Ø¬ÙŠÙ† Ù  Ùˆ Ù¢ØŒ Ù„Ø°Ù„Ùƒ Ù‡ÙŠ Ù„ÙŠØ³Øª Ø¯Ø§Ù„Ø©." }
            ],
            // Bank 2: Is it a function? (Yes/No)
            [
                { icon: 'ğŸ”', title: "ÙØ­Øµ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©", question: "Ù‡Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ { (Ù¡ØŒ Ù¥)ØŒ (Ù¢ØŒ Ù§)ØŒ (Ù£ØŒ Ù¥) }", options: ["Ù†Ø¹Ù…", "Ù„Ø§"], correctAnswer: "Ù†Ø¹Ù…", explanation: "ØµØ­ÙŠØ­ØŒ Ù„Ø£Ù† ÙƒÙ„ Ù…Ø¯Ø®Ù„ Ù„Ù‡ Ù…Ø®Ø±Ø¬ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·. Ù„Ø§ ÙŠÙ‡Ù… Ø¥Ø°Ø§ ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ù…Ø®Ø±Ø¬." },
                { icon: 'ğŸ”', title: "ÙØ­Øµ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©", question: "Ù‡Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ { (Ù¤ØŒ Ù¨)ØŒ (<span dir='rtl'>-Ù¡</span>ØŒ Ù©)ØŒ (Ù¤ØŒ Ù¡Ù ) }", options: ["Ù†Ø¹Ù…", "Ù„Ø§"], correctAnswer: "Ù„Ø§", explanation: "Ù„ÙŠØ³Øª Ø¯Ø§Ù„Ø©ØŒ Ù„Ø£Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ Ù¤ Ø§Ø±ØªØ¨Ø· Ø¨Ù…Ø®Ø±Ø¬ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ† (Ù¨ Ùˆ Ù¡Ù )." },
                { icon: 'ğŸ”', title: "ÙØ­Øµ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©", question: "Ù‡Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ { (Ù ØŒ Ù¡)ØŒ (Ù¡ØŒ Ù¢)ØŒ (Ù¢ØŒ Ù£) }", options: ["Ù†Ø¹Ù…", "Ù„Ø§"], correctAnswer: "Ù†Ø¹Ù…", explanation: "Ù†Ø¹Ù…ØŒ ÙƒÙ„ Ù…Ø¯Ø®Ù„ Ù„Ù‡ Ù…Ø®Ø±Ø¬ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø© Ù…Ù†ØªØ¸Ù…Ø©." },
                { icon: 'ğŸ”', title: "ÙØ­Øµ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©", question: "Ù‡Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© { (<span dir='rtl'>-Ù¢</span>ØŒ Ù¤)ØŒ (<span dir='rtl'>-Ù¡</span>ØŒ Ù¡)ØŒ (Ù ØŒ Ù )ØŒ (Ù¡ØŒ Ù¡)ØŒ (Ù¢ØŒ Ù¤) } <span class='highlight'>ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©</span>ØŸ", options: ["Ù†Ø¹Ù…", "Ù„Ø§"], correctAnswer: "Ù†Ø¹Ù…", explanation: "Ù†Ø¹Ù… ØªÙ…Ø«Ù„ Ø¯Ø§Ù„Ø©. ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª (Øµ) Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ØŒ Ø§Ù„Ù…Ù‡Ù… Ø£Ù„Ø§ ÙŠØªÙƒØ±Ø± Ø§Ù„Ù…Ø¯Ø®Ù„ (Ø³)." }
            ],
            // Bank 3: Is it a linear function?
            [
                { icon: 'ğŸ›£ï¸', title: "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª", question: "Ø£ÙŠ Ø·Ø±ÙŠÙ‚ ÙŠÙ…Ø«Ù„ <span class='highlight'>Ø¯Ø§Ù„Ø© Ø®Ø·ÙŠØ©</span>ØŸ", options: ["Øµ = <span dir='rtl'>Ø³<sup>Ù¢</sup> + Ù¡</span>", "Øµ = Ù£ - Ø³", "Øµ Ø³ = Ù¡Ù ", "Øµ = |&lrm;Ø³&lrm;|"], correctAnswer: "Øµ = Ù£ - Ø³", explanation: "Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ© Ø£Ø³ Ù…ØªØºÙŠØ±Ù‡Ø§ (Ø³) Ù‡Ùˆ Ù¡." },
                { icon: 'ğŸ›£ï¸', title: "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª", question: "Ø£ÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© <span class='highlight'>Ù„ÙŠØ³Øª Ø¯Ø§Ù„Ø© Ø®Ø·ÙŠØ©</span>ØŸ", options: ["Øµ = Ù¥Ø³", 'Øµ = <span class="fraction"><span>Ù¢</span><span>Ø³</span></span>', "Øµ = Ø³ + Ù¡", "Øµ = Ù©"], correctAnswer: 'Øµ = <span class="fraction"><span>Ù¢</span><span>Ø³</span></span>', explanation: "Ù„ÙŠØ³Øª Ø®Ø·ÙŠØ© Ù„Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø³ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ù…." },
                { icon: 'ğŸ›£ï¸', title: "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª", question: "Ø§Ø®ØªØ± Ø§Ù„<span class='highlight'>Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ©</span> Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:", options: ["Ù¢Ø³ + Ù£Øµ = Ù¦", "Øµ = <span dir='rtl'>Ø³<sup>Ù£</sup></span>", "Øµ = |&lrm;Ø³ + Ù¡&lrm;|", 'Øµ = <span class="fraction"><span>Ù¥</span><span>Ø³</span></span>'], correctAnswer: "Ù¢Ø³ + Ù£Øµ = Ù¦", explanation: "Ù‡Ø°Ù‡ Ù…Ø¹Ø§Ø¯Ù„Ø© Ø®Ø·ÙŠØ© ÙŠÙ…ÙƒÙ† ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Øµ = Ù… Ø³ + Ø¨." },
                { icon: 'ğŸ›£ï¸', title: "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª", question: "Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠØ¹ØªØ¨Ø± <span class='highlight'>Ø¯Ø§Ù„Ø© Ø®Ø·ÙŠØ©</span>ØŸ", options: ["Øµ = Ù§", "Ø³ Øµ = Ù¥", "Øµ = <span dir='rtl'>Ø³<sup>Ù¢</sup> - Ù¡</span>", 'Øµ = <span class="arabic-root"><span class="radicand">Ø³</span><span class="symbol">âˆš</span></span>'], correctAnswer: "Øµ = Ù§", explanation: "Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù‡ÙŠ Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙŠØ© ÙˆÙ…ÙŠÙ„Ù‡Ø§ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ±." }
            ],
            // Bank 4: Evaluate the function
            [
                { icon: 'ğŸŒ‰', title: "Ø¬Ø³Ø± Ø§Ù„Ù‚ÙŠÙ…Ø©", question: "Ø£ÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ø¯(Ù¤) Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø³Ø±: <div class='highlight-equation'><span dir='rtl'>Ø¯(Ø³) = </span><span dir='ltr'>Ù£Ø³ - Ù¢</span></div>", options: ["Ù¡Ù ", "Ù¥", "Ù¡Ù£", "Ù¡Ù¤"], correctAnswer: "Ù¡Ù ", explanation: "Ø§Ù„Ø­Ù„: Ø¯(Ù¤) = (Ù£ Ã— Ù¤) - Ù¢ <br> = Ù¡Ù¢ - Ù¢ = Ù¡Ù " },
                { icon: 'ğŸŒ‰', title: "Ø¬Ø³Ø± Ø§Ù„Ù‚ÙŠÙ…Ø©", question: "Ø¥Ø°Ø§ ÙƒØ§Ù†Øª <div class='highlight-equation'><span dir='rtl'>Ø¯(Ø³) = </span><span dir='ltr'>Ù¡Ù  - Ù¢Ø³</span></div>ØŒ ÙÙ…Ø§ Ù‚ÙŠÙ…Ø© Ø¯(Ù£)ØŸ", options: ["Ù¤", "Ù¦", "Ù§", "Ù¨"], correctAnswer: "Ù¤", explanation: "Ø§Ù„Ø­Ù„: Ø¯(Ù£) = Ù¡Ù  - (Ù¢ Ã— Ù£) <br> = Ù¡Ù  - Ù¦ = Ù¤" },
                { icon: 'ğŸŒ‰', title: "Ø¬Ø³Ø± Ø§Ù„Ù‚ÙŠÙ…Ø©", question: "Ø¥Ø°Ø§ ÙƒØ§Ù†Øª <div class='highlight-equation'><span dir='rtl'>Ø¯(Ø³) = Ø³<sup>Ù¢</sup> + Ù¡</span></div>ØŒ ÙÙ…Ø§ Ù‚ÙŠÙ…Ø© Ø¯(Ù¥)ØŸ", options: ["Ù¢Ù¦", "Ù¡Ù¡", "Ù¡Ù ", "Ù¢Ù¥"], correctAnswer: "Ù¢Ù¦", explanation: "Ø§Ù„Ø­Ù„: Ø¯(Ù¥) = (Ù¥)<sup>Ù¢</sup> + Ù¡ <br> = Ù¢Ù¥ + Ù¡ = Ù¢Ù¦" },
                { icon: 'ğŸŒ‰', title: "Ø¬Ø³Ø± Ø§Ù„Ù‚ÙŠÙ…Ø©", question: 'Ø¥Ø°Ø§ ÙƒØ§Ù†Øª <div class="highlight-equation"><span dir="rtl">Ø¯(Ø³) = </span><span class="fraction"><span>Ø³ + Ù¤</span><span>Ù¢</span></span></div>ØŒ ÙÙ…Ø§ Ù‚ÙŠÙ…Ø© Ø¯(Ù¦)ØŸ', options: ["Ù¥", "Ù§", "Ù¡Ù ", "Ù£"], correctAnswer: "Ù¥", explanation: 'Ø§Ù„Ø­Ù„: <span class="fraction"><span>Ù¦ + Ù¤</span><span>Ù¢</span></span> = <span class="fraction"><span>Ù¡Ù </span><span>Ù¢</span></span> = Ù¥' }
            ],
            // Bank 5: Application/Word Problem
            [
                { icon: 'ğŸš—', title: "Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©", question: "ØªÙƒÙ„ÙØ© Ø§Ø³ØªØ¦Ø¬Ø§Ø± Ø³ÙŠØ§Ø±Ø© Ù‡ÙŠ <span class='highlight-equation'><span dir='rtl'>Øª(ÙŠ) = </span><span dir='ltr'>Ù¥Ù  + Ù©Ù ÙŠ</span></span>ØŒ Ù…Ø§ ØªÙƒÙ„ÙØ© Ù£ Ø£ÙŠØ§Ù…ØŸ <small class='text-slate-500'>(Ø­ÙŠØ« Øª: Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ ÙŠ: Ø§Ù„Ø£ÙŠØ§Ù…)</small>", options: ["Ù¢Ù¤Ù  Ø±ÙŠØ§Ù„", "Ù£Ù¢Ù  Ø±ÙŠØ§Ù„", "Ù¡Ù¤Ù  Ø±ÙŠØ§Ù„", "Ù¢Ù§Ù  Ø±ÙŠØ§Ù„"], correctAnswer: "Ù£Ù¢Ù  Ø±ÙŠØ§Ù„", explanation: "Ø§Ù„Ø­Ù„: Øª(Ù£) = Ù¥Ù  + (Ù©Ù  Ã— Ù£) <br> = Ù¥Ù  + Ù¢Ù§Ù  = Ù£Ù¢Ù  Ø±ÙŠØ§Ù„." },
                { icon: 'ğŸ“±', title: "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ", question: "ÙØ§ØªÙˆØ±Ø© Ù‡Ø§ØªÙ ØªØ­Ø³Ø¨ ÙƒØ§Ù„ØªØ§Ù„ÙŠ: <span class='highlight-equation'><span dir='rtl'>Ù(Ø¯) = </span><span dir='ltr'>Ù¢Ù¥ + Ù .Ù¥Ø¯</span></span>ØŒ Ù…Ø§ ØªÙƒÙ„ÙØ© Ù¢Ù  Ø¯Ù‚ÙŠÙ‚Ø©ØŸ <small class='text-slate-500'>(Ø­ÙŠØ« Ù: Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŒ Ø¯: Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</small>", options: ["Ù£Ù¥ Ø±ÙŠØ§Ù„", "Ù¤Ù¥ Ø±ÙŠØ§Ù„", "Ù¡Ù Ù  Ø±ÙŠØ§Ù„", "Ù¢Ù¥ Ø±ÙŠØ§Ù„"], correctAnswer: "Ù£Ù¥ Ø±ÙŠØ§Ù„", explanation: "Ø§Ù„Ø­Ù„: Ù(Ù¢Ù ) = Ù¢Ù¥ + (Ù .Ù¥ Ã— Ù¢Ù ) <br> = Ù¢Ù¥ + Ù¡Ù  = Ù£Ù¥ Ø±ÙŠØ§Ù„" },
                { icon: 'ğŸŒ¡ï¸', title: "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø±Ø§Ø±Ø©", question: "Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ù…Ø¦ÙˆÙŠ Ù„ÙÙ‡Ø±Ù†Ù‡Ø§ÙŠØª: <span class='highlight-equation'><span dir='rtl'>Ù = </span><span dir='ltr'>Ù¡.Ù¨Ù… + Ù£Ù¢</span></span>ØŒ ÙƒÙ… ØªØ³Ø§ÙˆÙŠ Ù¡Ù  Ø¯Ø±Ø¬Ø§Øª Ù…Ø¦ÙˆÙŠØ©ØŸ <small class='text-slate-500'>(Ø­ÙŠØ« Ù: ÙÙ‡Ø±Ù†Ù‡Ø§ÙŠØªØŒ Ù…: Ù…Ø¦ÙˆÙŠ)</small>", options: ["Ù¥Ù  Ù", "Ù¤Ù¢ Ù", "Ù£Ù£.Ù¨ Ù", "Ù¡Ù¨ Ù"], correctAnswer: "Ù¥Ù  Ù", explanation: "Ø§Ù„Ø­Ù„: Ù = (Ù¡.Ù¨ Ã— Ù¡Ù ) + Ù£Ù¢ <br> = Ù¡Ù¨ + Ù£Ù¢ = Ù¥Ù  ÙÙ‡Ø±Ù†Ù‡Ø§ÙŠØª." },
                { icon: 'ğŸ’§', title: "Ù…Ù„Ø¡ Ø®Ø²Ø§Ù†", question: "Ø­Ø¬Ù… Ø§Ù„Ù…Ø§Ø¡ ÙÙŠ Ø®Ø²Ø§Ù† Ù‡Ùˆ <span class='highlight-equation'><span dir='rtl'>Ø­(Ù†) = </span><span dir='ltr'>Ù¡Ù Ù  + Ù¢Ù Ù†</span></span>ØŒ ÙƒÙ… Ø§Ù„Ø­Ø¬Ù… Ø¨Ø¹Ø¯ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚ØŸ <small class='text-slate-500'>(Ø­ÙŠØ« Ø­: Ø§Ù„Ø­Ø¬Ù…ØŒ Ù†: Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</small>", options: ["Ù¢Ù Ù  Ù„ØªØ±", "Ù¡Ù¢Ù¥ Ù„ØªØ±", "Ù¥Ù Ù  Ù„ØªØ±", "Ù¦Ù Ù  Ù„ØªØ±"], correctAnswer: "Ù¢Ù Ù  Ù„ØªØ±", explanation: "Ø§Ù„Ø­Ù„: Ø­(Ù¥) = Ù¡Ù Ù  + (Ù¢Ù  Ã— Ù¥) <br> = Ù¡Ù Ù  + Ù¡Ù Ù  = Ù¢Ù Ù  Ù„ØªØ±" }
            ]
        ];

        let gameData = [];
        let currentStageIndex = 0;
        let score = 0;
        let totalTimeTaken = 0;
        let timerInterval;
        let timeLeft = 15;
        let nextStageTimerInterval;

        // --- Game Logic ---
        function generateRandomQuiz() {
            gameData = [];
            questionBanks.forEach(bank => {
                const randomIndex = Math.floor(Math.random() * bank.length);
                const randomQuestion = bank[randomIndex];
                gameData.push(randomQuestion);
            });
        }
        
        function startGame() {
            initAudio();
            playSound('click');
            generateRandomQuiz();
            score = 0;
            totalTimeTaken = 0;
            scoreDisplay.textContent = toArabicNumerals(score);
            currentStageIndex = 0;
            progressBar.style.width = '0%';
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadStage(currentStageIndex);
        }

        function startTimer() {
            timeLeft = 15;
            timerDisplay.textContent = toArabicNumerals(timeLeft);
            timerDisplay.classList.remove('text-red-500');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = toArabicNumerals(timeLeft);
                if (timeLeft < 6) {
                    timerDisplay.classList.add('text-red-500');
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(null, null); // Time's up
                }
            }, 1000);
        }

        function loadStage(stageIndex) {
            feedbackSection.classList.add('hidden');
            questionSection.classList.remove('hidden');
            
            const stage = gameData[stageIndex];

            if (stage.options.length > 2) {
                optionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4';
            } else {
                optionsContainer.className = 'grid grid-cols-1 gap-2 sm:gap-4';
            }
            
            backgroundIcon.textContent = stage.icon;
            stageTitle.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${toArabicNumerals(stageIndex + 1)}: ${stage.title}`;
            questionText.innerHTML = stage.question; 
            optionsContainer.innerHTML = '';

            stage.options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span class="math-expr">${option}</span>`;
                button.classList.add('choice-btn', 'w-full', 'p-2', 'sm:p-4', 'border-2', 'border-white/50', 'rounded-lg', 'text-slate-800', 'font-semibold', 'bg-white/75', 'backdrop-blur-sm', 'hover:bg-violet-100/90', 'hover:border-violet-400');
                button.onclick = (e) => {
                    playSound('click');
                    checkAnswer(button, option);
                };
                optionsContainer.appendChild(button);
            });
            startTimer();
        }
        
        function checkAnswer(button, selectedOption) {
            clearInterval(timerInterval);
            const timeTaken = 15 - (timeLeft > 0 ? timeLeft : 0);
            totalTimeTaken += timeTaken;
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            
            const stage = gameData[currentStageIndex];
            const isCorrect = selectedOption === stage.correctAnswer;
            
            if (timeLeft <= 0) {
                 playSound('incorrect');
                 displayFeedback('timeout', stage.explanation);
            } else if (isCorrect) {
                playSound('correct');
                // Scoring system: 10 points for each correct answer
                const pointsGained = 10;
                score += pointsGained;
                scoreDisplay.textContent = toArabicNumerals(score);
                button.classList.add('correct');
                const progressPercentage = ((currentStageIndex + 1) / gameData.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                displayFeedback('correct', stage.explanation, pointsGained);
            } else {
                playSound('incorrect');
                button.classList.add('incorrect');
                displayFeedback('incorrect', stage.explanation);
            }
        }

        function displayFeedback(resultType, explanation, points) {
            questionSection.classList.add('hidden');
            feedbackSection.classList.remove('hidden');
            
            // Reset feedback view
            correctAnswerDisplay.classList.add('hidden');
            feedbackExplanation.classList.add('hidden');
            showSolutionBtn.classList.remove('hidden');
            nextBtn.innerHTML = `Ø§Ù„ØªØ§Ù„ÙŠ (<span id="next-stage-timer">Ù§</span>)`;

            switch(resultType) {
                case 'correct':
                    feedbackTitle.innerHTML = `âœ… Ø±Ø§Ø¦Ø¹! +${toArabicNumerals(points)} Ù†Ù‚Ø·Ø©`;
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-green-500';
                    break;
                case 'incorrect':
                    feedbackTitle.textContent = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©';
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-red-500';
                    break;
                case 'timeout':
                    feedbackTitle.textContent = 'â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!';
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-yellow-600';
                    break;
            }
            feedbackExplanation.innerHTML = explanation;
            startNextStageTimer();
        }

        function startNextStageTimer() {
            let nextStageTimeLeft = 7;
            const timerDisplay = document.getElementById('next-stage-timer');
            if (timerDisplay) timerDisplay.textContent = toArabicNumerals(nextStageTimeLeft);
            
            clearInterval(nextStageTimerInterval);
            nextStageTimerInterval = setInterval(() => {
                nextStageTimeLeft--;
                if(timerDisplay) timerDisplay.textContent = toArabicNumerals(nextStageTimeLeft);
                if (nextStageTimeLeft <= 0) nextStage();
            }, 1000);
        }

        function showSolution() {
            playSound('click');
            clearInterval(nextStageTimerInterval);
            
            const stage = gameData[currentStageIndex];
            const correctAnswer = stage.correctAnswer;

            correctAnswerBox.innerHTML = `<span class="math-expr !bg-transparent !border-none !p-0">${correctAnswer}</span>`;
            correctAnswerDisplay.classList.remove('hidden');
            
            feedbackExplanation.classList.remove('hidden');
            showSolutionBtn.classList.add('hidden');
            nextBtn.innerHTML = 'Ø§Ù„ØªØ§Ù„ÙŠ';
        }

        function nextStage() {
            playSound('click');
            clearInterval(nextStageTimerInterval);
            currentStageIndex++;
            if (currentStageIndex < gameData.length) {
                loadStage(currentStageIndex);
            } else {
                showEndScreen();
            }
        }

        function showEndScreen() {
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            window.saveAndFinishGame(score, totalTimeTaken);
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', nextStage);
        showSolutionBtn.addEventListener('click', showSolution);

        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
        (function() {
            // --- CONFIGURATION (Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù„Ø¹Ø¨Ø©) ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const GAME_ID = 'g2_2_2';         // Example: 'g1_1_1'
            const GAME_MAX_POINTS = 50;                     // Max points in the game (10 points/q * 5 questions)
            const PLATFORM_MAX_GRADE = 5;                   // Final grade in the platform
            const METRIC_TYPE = 'time';                     // Metric type: 'time', 'stars', 'errors'
            const METRIC_LABEL = 'Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ)';           // Metric label for display

            // --- Read URL Parameters ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const classId = urlParams.get('classId');
            const studentName = urlParams.get('studentName');

            let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

            // --- CORE FUNCTIONS ---

            // 1. Main function called when the game ends
            window.saveAndFinishGame = function(points, metricValue) {
                const finalPoints = parseFloat(points) || 0;
                const finalMetric = parseFloat(metricValue) || 0;
                const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
                const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

                const resultDisplay = document.getElementById('final-result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span class="font-bold text-xl">${toArabicNumerals(finalPoints)} / ${toArabicNumerals(maxPoints)}</span></p>
                        <p class="text-blue-600">Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-2xl">${toArabicNumerals(finalGrade.toFixed(1))} / ${toArabicNumerals(PLATFORM_MAX_GRADE)}</span></p>
                    `;
                }

                if (studentId && classId) {
                    const params = new URLSearchParams({
                        action: 'saveGrade',
                        studentId: studentId,
                        classId: classId,
                        itemId: GAME_ID,
                        grade: finalGrade.toFixed(2),
                        metricValue: Math.round(finalMetric).toString()
                    });
                    fetch(`${SCRIPT_URL}?${params.toString()}`)
                        .then(res => res.json())
                        .then(result => console.log('Save result:', result.status))
                        .catch(err => console.error("Save Error:", err))
                        .finally(fetchAndShowLeaderboard);
                } else {
                    console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                    fetchAndShowLeaderboard();
                }
            }

            // 2. Function to fetch and display the leaderboard
            function fetchAndShowLeaderboard() {
                const loader = document.getElementById('leaderboard-loader');
                const container = document.getElementById('leaderboard-container');
                if (!loader || !container) return;
                
                if (!classId) {
                    console.log("No classId found, skipping leaderboard for visitor.");
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
                    showFinishButton();
                    return;
                }

                loader.style.display = 'block';
                container.innerHTML = '';

                const params = new URLSearchParams({
                    action: 'getLeaderboard',
                    gameId: GAME_ID,
                    metricType: METRIC_TYPE,
                    classId: classId
                });

                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            displayLeaderboard(response.data);
                        } else {
                            throw new Error(response.message || 'Failed to load leaderboard data.');
                        }
                    })
                    .catch(err => {
                        console.error("Leaderboard Error:", err);
                        container.innerHTML = `<p class="text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                        showFinishButton();
                    });
            }
            
            // 3. Function to build the leaderboard table
            function displayLeaderboard(data) {
                const container = document.getElementById('leaderboard-container');
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
                    return;
                }

                let tableHTML = `
                    <div class="mt-4 border-t pt-4">
                        <h3 class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-4">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white shadow-md rounded-lg text-sm">
                                <thead class="bg-gray-800 text-white">
                                    <tr>
                                        <th class="text-center py-2 px-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                        <th class="text-right py-2 px-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th class="text-center py-2 px-3">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                        <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-700">`;

                data.forEach((player, index) => {
                    const rank = index + 1;
                    let rankDisplay = toArabicNumerals(rank);
                    if (rank === 1) rankDisplay = 'ğŸ¥‡';
                    if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                    if (rank === 3) rankDisplay = 'ğŸ¥‰';

                    const isCurrentUser = (currentUser && player.name === currentUser.name);
                    const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center py-2 px-3 text-lg">${rankDisplay}</td>
                            <td class="text-right py-2 px-3">${player.name}</td>
                            <td class="text-center py-2 px-3">${toArabicNumerals(player.grade.toFixed(1))}</td>
                            <td class="text-center py-2 px-3">${toArabicNumerals(player.metricValue)}</td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div></div>`;
                container.innerHTML = tableHTML;
            }

            // 4. Show the finish button
            function showFinishButton() {
                const finishWrapper = document.getElementById('finish-game-wrapper');
                if (finishWrapper) {
                    finishWrapper.style.display = 'flex';
                }
            }

            // 5. Handle the finish button and personalize the welcome message
            document.addEventListener('DOMContentLoaded', () => {
                // Personalize welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (studentName && welcomeMessage) {
                    welcomeMessage.innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ <span class="font-bold text-violet-500">${studentName}</span>! Ø§Ù†Ø·Ù„Ù‚ ÙÙŠ Ù…Ù‡Ù…ØªÙƒ Ø¹Ø¨Ø± Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ ÙˆØ­Ù„ Ø§Ù„Ø£Ù„ØºØ§Ø² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ù„ØªØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©. ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªÙ‚Ø±Ø¨Ùƒ Ù…Ù† Ù‡Ø¯ÙÙƒ!`;
                }

                const finishBtn = document.getElementById('finish-game-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', () => {
                        window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                    });
                }
            });
        })();
        // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>
</body>
</html>


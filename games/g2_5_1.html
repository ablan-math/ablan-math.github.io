<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ­Ø¯ÙŠ ØºØ±ÙØ© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            touch-action: manipulation;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
            position: relative; /* For background pseudo-element */
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://ablan-math.github.io/img/GZAA.png');
            background-size: cover;
            background-position: center;
            z-index: -1;
            opacity: 0.4; /* Adjust the opacity to make it more or less visible */
        }
        .card-enter {
            animation: card-enter 0.5s ease-out forwards;
        }
        @keyframes card-enter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .feedback-correct {
            animation: feedback-pop 0.3s ease-in-out;
            background-color: #10B981;
            color: white;
        }
        .feedback-incorrect {
            animation: feedback-shake 0.5s ease-in-out;
            background-color: #EF4444;
            color: white;
        }
        @keyframes feedback-pop {
            0% { transform: scale(0.8); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes feedback-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .fraction-display {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            margin: 0 0.2em;
            line-height: 1;
        }
        .fraction-display .numerator {
            padding: 0 0.4em;
            border-bottom: 1.5px solid currentColor;
        }
        .fraction-display .denominator {
            padding: 0 0.4em;
        }
        .modal-content {
            animation: modal-pop 0.3s ease-out;
        }
        @keyframes modal-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #leaderboard-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-sm mx-auto bg-white/50 backdrop-blur-sm rounded-2xl shadow-xl p-4 space-y-3">
        
        <!-- Start Screen -->
        <div id="start-screen" class="text-center card-enter flex flex-col justify-center items-center h-full py-6">
            <h1 class="text-3xl font-bold text-indigo-600">ØªØ­Ø¯ÙŠ ØºØ±ÙØ© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h1>
            <div id="welcomeMessage" class="text-sm text-gray-800 mt-4 mb-6 text-center bg-gray-100/70 p-3 rounded-lg shadow-inner space-y-2">
                <p>Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…Ø³Ø§Ø¹Ø¯ Ø·Ø¨ÙŠ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø¨Ø³Ø±Ø¹Ø© ÙˆØ¯Ù‚Ø©. Ø¹Ù„ÙŠÙƒ Ù‚ÙŠØ§Ø³ <span class="font-bold text-blue-600">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ±</span> Ù„Ù…Ø¹Ø±ÙØ© Ø¥Ù† ÙƒØ§Ù† Ø«Ø§Ø¨ØªØ§Ù‹ Ø£Ù… Ù„Ø§. Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¯ ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø¥Ù†Ù‚Ø§Ø° Ø­ÙŠØ§Ø© Ø§Ù„Ù…ØµØ§Ø¨.</p>
            </div>
            <button onclick="startGame()" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ
            </button>
            <p class="text-xs text-gray-600 font-semibold mt-8">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ø¨Ù„Ø§Ù†</p>
        </div>
        
        <!-- Game Screen (Initially Hidden) -->
        <div id="game-screen" class="hidden">
            <!-- This container will be overwritten by the end-game summary -->
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanation-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-5 w-full max-w-sm modal-content">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold text-indigo-700">Ø´Ø±Ø­ Ø§Ù„Ø­Ù„</h3>
                <button onclick="hideExplanation()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="explanation-content" class="space-y-3 text-gray-700 max-h-[60vh] overflow-y-auto pr-2"></div>
            <button onclick="hideExplanation()" class="mt-4 w-full bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // --- Game Code START ---
        
        // --- Question Bank ---
        const questionBank = [
            // Group 1: Constant Positive Rate
            [
                { scenarioTitle: "ğŸ©¸ Ù†Ù‚Ù„ Ø¯Ù… Ø¹Ø§Ø¬Ù„", scenarioDescription: "ÙØ±ÙŠÙ‚ Ø·Ø¨ÙŠ ÙŠØ³Ø¹Ù Ø£Ø­Ø¯ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø¨Ù†Ø²ÙŠÙ Ø­Ø§Ø¯ Ø¬Ø±Ø§Ø¡ Ù‡Ø¬ÙˆÙ… Ù„Ù‚ÙˆØ§Øª Ø§Ù„Ø§Ø­ØªÙ„Ø§Ù„.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø­Ø¬Ù… Ø§Ù„Ø¯Ù… (Ù…Ù„)", data: [[5, 40], [15, 120], [25, 200]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '8' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1/8' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-8' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: '8', explanation: { type: 'constant', rate1: { y2: 120, y1: 40, x2: 15, x1: 5 }, rate2: { y2: 200, y1: 120, x2: 25, x1: 15 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…ØªØ³Ø§ÙˆÙØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸ’“ ØªØ³Ø§Ø±Ø¹ Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨", scenarioDescription: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ø¨Ø¶Ø§Øª Ù‚Ù„Ø¨ Ù…ØµØ§Ø¨ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø·Ø§Ø¦Ù‡ Ø¯ÙˆØ§Ø¡ Ù…Ù†Ø´Ø· Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¯Ù…ÙˆÙŠØ©.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø§Ù„Ù†Ø¨Ø¶ (Ù†/Ø¯)", data: [[2, 70], [4, 80], [6, 90]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '5' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '10' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-5' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: '5', explanation: { type: 'constant', rate1: { y2: 80, y1: 70, x2: 4, x1: 2 }, rate2: { y2: 90, y1: 80, x2: 6, x1: 4 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…ØªØ³Ø§ÙˆÙØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸ’‰ Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ", scenarioDescription: "Ø£Ø­Ø¯ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† ÙÙŠ Ù‡Ø¬ÙˆÙ… Ù„Ù„Ø¹Ø¯Ùˆ ÙŠØªÙ„Ù‚Ù‰ Ù…Ø¶Ø§Ø¯Ù‹Ø§ Ø­ÙŠÙˆÙŠÙ‹Ø§ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ±ÙŠØ¯ Ù„Ù…Ù†Ø¹ ØªÙØ§Ù‚Ù… Ø¥ØµØ§Ø¨ØªÙ‡.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø³Ø§Ø¹Ø©)", headerY: "Ø§Ù„Ø¬Ø±Ø¹Ø© (Ù…Ù„Øº)", data: [[1, 250], [2, 500], [3, 750]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-250' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '250' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1/250' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: '250', explanation: { type: 'constant', rate1: { y2: 500, y1: 250, x2: 2, x1: 1 }, rate2: { y2: 750, y1: 500, x2: 3, x1: 2 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…ØªØ³Ø§ÙˆÙØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª." } }
            ],
            // Group 2: Variable Rate
            [
                { scenarioTitle: "ğŸ“‰ ØªØ®ÙÙŠÙ Ø§Ù„Ø£Ù„Ù…", scenarioDescription: "Ø¨Ø¹Ø¯ Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø³ÙƒÙ† Ù„Ù…ØµØ§Ø¨ Ø¬Ø±Ø§Ø¡ Ù‚ØµÙ Ù…Ø¹Ø§Ø¯ÙØŒ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù„Ù… Ø§Ù„Ø°ÙŠ ÙŠØ´Ø¹Ø± Ø¨Ù‡.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù„Ù… (Ù…Ù† Ù¡Ù )", data: [[5, 8], [20, 5], [35, 3]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-0.2' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '3' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-3' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 5, y1: 8, x2: 20, x1: 5 }, rate2: { y2: 3, y1: 5, x2: 35, x1: 20 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸ©¹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¦Ø§Ù… Ø¬Ø±Ø­", scenarioDescription: "Ø·Ø¨ÙŠØ¨ ÙŠØªØ§Ø¨Ø¹ Ø§Ù„ØªØ¦Ø§Ù… Ø¬Ø±Ø­ Ø£Ø­Ø¯ Ø¶Ø­Ø§ÙŠØ§ Ù‡Ø¬ÙˆÙ… Ù‚ÙˆØ§Øª Ø§Ù„Ø§Ø­ØªÙ„Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø¯Ù‰ Ø£ÙŠØ§Ù….", headerX: "Ø§Ù„ÙŠÙˆÙ…", headerY: "Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¬Ø±Ø­ (Ø³Ù…Â²)", data: [[1, 20], [3, 15], [5, 11]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-2.5' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '2.5' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-2' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 15, y1: 20, x2: 3, x1: 1 }, rate2: { y2: 11, y1: 15, x2: 5, x1: 3 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸŒ¡ï¸ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø­Ø±Ø§Ø±Ø©", scenarioDescription: "Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ù…ØµØ§Ø¨ Ø¨Ø§Ù„Ø­Ù…Ù‰ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø·Ø§Ø¦Ù‡ Ø¯ÙˆØ§Ø¡ Ø®Ø§ÙØ¶ Ù„Ù„Ø­Ø±Ø§Ø±Ø©.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø³Ø§Ø¹Ø©)", headerY: "Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Ù…Ø¦ÙˆÙŠØ©)", data: [[0.5, 39.0], [1.5, 38.0], [2.5, 37.5]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-1' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-0.5' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 38.0, y1: 39.0, x2: 1.5, x1: 0.5 }, rate2: { y2: 37.5, y1: 38.0, x2: 2.5, x1: 1.5 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } }
            ],
            // Group 3: Constant Negative Rate
            [
                { scenarioTitle: "ğŸ’§ ØªÙØ±ÙŠØº Ù…Ø­Ù„ÙˆÙ„ ÙˆØ±ÙŠØ¯ÙŠ", scenarioDescription: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø¬Ù… Ø§Ù„Ù…Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù„Ø­ÙŠ ÙÙŠ ÙƒÙŠØ³ Ø§Ù„ØªØ³Ø±ÙŠØ¨ Ø§Ù„ÙˆØ±ÙŠØ¯ÙŠ Ù„Ù…ØµØ§Ø¨.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ù…Ù„)", data: [[10, 190], [40, 160], [70, 130]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-30' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-1' } ], correctAnswer: '-1', explanation: { type: 'constant', rate1: { y2: 160, y1: 190, x2: 40, x1: 10 }, rate2: { y2: 130, y1: 160, x2: 70, x1: 40 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…ØªØ³Ø§ÙˆÙØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "â›½ï¸ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø¨Ø§Ù„Ø¥Ø³Ø¹Ø§Ù", scenarioDescription: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯ ÙÙŠ Ø³ÙŠØ§Ø±Ø© Ø¥Ø³Ø¹Ø§Ù Ø£Ø«Ù†Ø§Ø¡ Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù…ØµØ§Ø¨.", headerX: "Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)", headerY: "Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±)", data: [[10, 38], [35, 33], [60, 28]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-0.2' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '0.2' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-5' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: '-0.2', explanation: { type: 'constant', rate1: { y2: 33, y1: 38, x2: 35, x1: 10 }, rate2: { y2: 28, y1: 33, x2: 60, x1: 35 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù…ØªØ³Ø§ÙˆÙØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸ’Š ØªØ±ÙƒÙŠØ² Ø¯ÙˆØ§Ø¡ Ø¨Ø§Ù„Ø¯Ù…", scenarioDescription: "Ù‚ÙŠØ§Ø³ Ø§Ù†Ø®ÙØ§Ø¶ ØªØ±ÙƒÙŠØ² Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø¯Ù… Ù…ØµØ§Ø¨ Ø¨Ù…Ø±ÙˆØ± Ø§Ù„ÙˆÙ‚Øª.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø³Ø§Ø¹Ø©)", headerY: "Ø§Ù„ØªØ±ÙƒÙŠØ² (Ù…ÙƒØº/Ù…Ù„)", data: [[1, 80], [2, 40], [3, 20]], options: [ { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-40' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '-20' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '40' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 40, y1: 80, x2: 2, x1: 1 }, rate2: { y2: 20, y1: 40, x2: 3, x1: 2 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } }
            ],
             // Group 4: Variable Rate (Positive)
            [
                { scenarioTitle: "ğŸ“ˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…", scenarioDescription: "Ù‚ÙŠØ§Ø³ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ Ù„Ù…ØµØ§Ø¨ ÙŠØªØ¹Ø§ÙÙ‰ Ù…Ù† ØµØ¯Ù…Ø©.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø§Ù„Ø¶ØºØ· (Ù…Ù„Ù… Ø²Ø¦Ø¨Ù‚)", data: [[2, 85], [7, 105], [12, 120]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '4' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '3' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '3.5' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 105, y1: 85, x2: 7, x1: 2 }, rate2: { y2: 120, y1: 105, x2: 12, x1: 7 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸŒ¬ï¸ ØªØ­Ø³Ù† Ø³Ø¹Ø© Ø§Ù„Ø±Ø¦Ø©", scenarioDescription: "Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù„Ø±Ø¦Ø© Ù…ØµØ§Ø¨ ÙÙŠ ØµØ¯Ø±Ù‡ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ.", headerX: "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", headerY: "Ø§Ù„Ø³Ø¹Ø© (Ù„ØªØ±)", data: [[1, 2.5], [3, 3.0], [5, 3.4]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '0.25' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '0.2' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '0.5' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 3.0, y1: 2.5, x2: 3, x1: 1 }, rate2: { y2: 3.4, y1: 3.0, x2: 5, x1: 3 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } },
                { scenarioTitle: "ğŸ’ª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙˆØ© Ø§Ù„Ø¹Ø¶Ù„Ø§Øª", scenarioDescription: "Ù‚ÙŠØ§Ø³ Ù‚ÙˆØ© Ù‚Ø¨Ø¶Ø© Ø§Ù„ÙŠØ¯ Ù„Ù…ØµØ§Ø¨ ÙŠØªØ¹Ø§ÙÙ‰ Ù…Ù† Ø¥ØµØ§Ø¨Ø© ÙÙŠ Ø°Ø±Ø§Ø¹Ù‡.", headerX: "Ø§Ù„ÙŠÙˆÙ…", headerY: "Ø§Ù„Ù‚ÙˆØ© (ÙƒØº)", data: [[5, 8], [12, 18], [19, 26]], options: [ { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1.4' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1.2' }, { text: 'Ù†Ø¹Ù…ØŒ Ø«Ø§Ø¨Øª. Ù… =', value: '1.3' }, { text: 'Ù„Ø§ØŒ ØºÙŠØ± Ø«Ø§Ø¨Øª', value: 'ØºÙŠØ± Ø«Ø§Ø¨Øª' } ], correctAnswer: 'ØºÙŠØ± Ø«Ø§Ø¨Øª', explanation: { type: 'variable', rate1: { y2: 18, y1: 8, x2: 12, x1: 5 }, rate2: { y2: 26, y1: 18, x2: 19, x1: 12 }, conclusion: "Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª ØºÙŠØ± Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ ÙØ¥Ù† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± ØºÙŠØ± Ø«Ø§Ø¨Øª." } }
            ],
            // Group 5: Specific Interval
            [
                { type: 'interval', questionText: "Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± <b>Ø¨ÙŠÙ† Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø¹Ø© ÙÙ‚Ø·</b>ØŸ", scenarioTitle: "ğŸ“‰ ØªØ¯Ù‡ÙˆØ± ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", scenarioDescription: "Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙˆÙ‰ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ù… Ù„Ù…ØµØ§Ø¨ ÙŠØ¹Ø§Ù†ÙŠ Ù…Ù† ØµØ¹ÙˆØ¨Ø§Øª Ø­Ø§Ø¯Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙØ³.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø§Ù„ØªØ´Ø¨Ø¹ Oâ‚‚ (%)", data: [[0, 98], [2, 95], [4, 92]], options: [ { text: 'Ù… =', value: '-1.5' }, { text: 'Ù… =', value: '-3' }, { text: 'Ù… =', value: '1.5' }, { text: 'Ù… =', value: '3' } ], correctAnswer: '-1.5', explanation: { type: 'interval', rate: { y2: 92, y1: 95, x2: 4, x1: 2 }, conclusion: "Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙŠÙ…Ø«Ù„ Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶ ÙÙŠ ØªØ´Ø¨Ø¹ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø±Ø¬Ø©." } },
                { type: 'interval', questionText: "Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± <b>Ø¨ÙŠÙ† Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø© ÙˆØ§Ù„Ø¹Ø§Ø´Ø±Ø© ÙÙ‚Ø·</b>ØŸ", scenarioTitle: "âš¡ï¸ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¯ÙˆØ§Ø¡", scenarioDescription: "Ù‚ÙŠØ§Ø³ ØªØ±ÙƒÙŠØ² Ø¯ÙˆØ§Ø¡ Ù…Ù†Ù‚Ø° Ù„Ù„Ø­ÙŠØ§Ø© ÙÙŠ Ø¯Ù… Ù…ØµØ§Ø¨ Ø¨Ø¹Ø¯ Ø­Ù‚Ù†Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø¯Ù‚ÙŠÙ‚Ø©)", headerY: "Ø§Ù„ØªØ±ÙƒÙŠØ² (ÙˆØ­Ø¯Ø©/Ù„ØªØ±)", data: [[2, 60], [5, 150], [10, 250]], options: [ { text: 'Ù… =', value: '20' }, { text: 'Ù… =', value: '30' }, { text: 'Ù… =', value: '10' }, { text: 'Ù… =', value: '-20' } ], correctAnswer: '20', explanation: { type: 'interval', rate: { y2: 250, y1: 150, x2: 10, x1: 5 }, conclusion: "Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙŠÙ…Ø«Ù„ Ø³Ø±Ø¹Ø© Ø§Ù…ØªØµØ§Øµ Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ø¯Ù… Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©." } },
                { type: 'interval', questionText: "Ù…Ø§ Ù‡Ùˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± <b>Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø·</b>ØŸ", scenarioTitle: "ğŸ”¥ Ø§Ø±ØªÙØ§Ø¹ Ù…ÙØ§Ø¬Ø¦ Ø¨Ø§Ù„Ø­Ø±Ø§Ø±Ø©", scenarioDescription: "ÙØ±ÙŠÙ‚ Ø·Ø¨ÙŠ ÙŠÙ„Ø§Ø­Ø¸ Ø§Ø±ØªÙØ§Ø¹Ø§Ù‹ Ø³Ø±ÙŠØ¹Ø§Ù‹ ÙÙŠ Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ù…ØµØ§Ø¨ Ø¨Ø¬Ø±Ø­ Ø¹Ù…ÙŠÙ‚.", headerX: "Ø§Ù„Ø²Ù…Ù† (Ø³Ø§Ø¹Ø©)", headerY: "Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Ù…Ø¦ÙˆÙŠØ©)", data: [[0.5, 37.8], [1, 38.0], [2, 39.0]], options: [ { text: 'Ù… =', value: '0.5' }, { text: 'Ù… =', value: '1' }, { text: 'Ù… =', value: '-1' }, { text: 'Ù… =', value: '2' } ], correctAnswer: '1', explanation: { type: 'interval', rate: { y2: 39.0, y1: 38.0, x2: 2, x1: 1 }, conclusion: "Ø§Ù„Ù…Ø¹Ø¯Ù„ ÙŠÙ…Ø«Ù„ Ù…Ø¯Ù‰ Ø³Ø±Ø¹Ø© Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø±Ø§Ø±Ø©ØŒ ÙˆÙ‡Ùˆ Ù…Ø¤Ø´Ø± Ø®Ø·Ø±." } }
            ]
        ];

        // --- DOM Elements ---
        const startScreenEl = document.getElementById('start-screen');
        const gameScreenEl = document.getElementById('game-screen');
        const explanationModalEl = document.getElementById('explanation-modal');
        const explanationContentEl = document.getElementById('explanation-content');

        // --- Game State ---
        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let timerInterval;
        let startTime;
        let totalPausedDuration = 0;
        let pauseStartTime;
        
        // --- Helper Functions ---
        function toArabicNumerals(numStr) {
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return String(numStr).replace(/[0-9.-]/g, (char) => {
                if (char === '.') return ',';
                if (char === '-') return '-';
                return arabicNumerals[parseInt(char)];
            });
        }

        function formatValue(valueString) {
            const num = parseFloat(valueString);
            const formattedNum = Number.isInteger(num) ? num : num.toFixed(2).replace('.',',');

            if (String(valueString).includes('/')) {
                const parts = String(valueString).split('/');
                return `<span class="fraction-display"><span class="numerator">${toArabicNumerals(parts[0])}</span><span class="denominator">${toArabicNumerals(parts[1])}</span></span>`;
            }
            return toArabicNumerals(formattedNum);
        }
        
        // --- Game Logic ---
        function startGame() {
            gameQuestions = [];
            for (let i = 0; i < questionBank.length; i++) {
                const group = questionBank[i];
                const randomIndex = Math.floor(Math.random() * group.length);
                gameQuestions.push(group[randomIndex]);
            }
            for (let i = gameQuestions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gameQuestions[i], gameQuestions[j]] = [gameQuestions[j], gameQuestions[i]];
            }

            currentQuestionIndex = 0;
            score = 0;
            startScreenEl.classList.add('hidden');
            gameScreenEl.classList.remove('hidden');
            gameScreenEl.innerHTML = `
                <div id="game-content">
                    <div id="scenario-section" class="bg-gray-50/50 border border-gray-200 rounded-lg p-3 text-center card-enter">
                        <p class="text-base font-semibold text-gray-800" id="scenario-title"></p>
                        <p class="text-sm text-gray-600 mt-1" id="scenario-description"></p>
                    </div>
                    <div class="overflow-x-auto card-enter my-3">
                        <table class="w-full text-center bg-white/50 rounded-lg shadow-sm border border-gray-200">
                            <thead class="bg-indigo-50/50">
                                <tr>
                                    <th class="p-2 text-sm font-bold text-indigo-700" id="table-header-x"></th>
                                    <th class="p-2 text-sm font-bold text-indigo-700" id="table-header-y"></th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-gray-200 text-sm"></tbody>
                        </table>
                    </div>
                    <div class="text-center space-y-3 pt-2 card-enter">
                        <p class="text-lg font-medium text-gray-900" id="question-text"></p>
                        <div id="options-container" class="grid grid-cols-2 gap-2"></div>
                    </div>
                    <div id="feedback" class="text-center font-bold p-2 rounded-lg text-base hidden my-2"></div>
                    <div id="action-buttons" class="hidden flex justify-center items-center gap-2">
                        <button onclick="nextQuestion()" class="w-1/2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        <button onclick="showExplanation()" class="w-1/2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none">Ø§Ø¹Ø±Ù Ù„Ù…Ø§Ø°Ø§ØŸ</button>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-500 font-medium pt-2">
                        <span>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score" class="font-bold text-indigo-600 text-base">Ù </span></span>
                        <span>Ø§Ù„ÙˆÙ‚Øª: <span id="timer" class="font-bold text-indigo-600 text-base">Ù Ù :Ù Ù </span></span>
                    </div>
                </div>`;
            
            startTime = Date.now();
            totalPausedDuration = 0;
            pauseStartTime = null;
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
            loadQuestion(currentQuestionIndex);
        }

        function updateTimer() {
            const runningTime = Date.now() - startTime;
            const elapsedTime = Math.floor((runningTime - totalPausedDuration) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            const timerEl = document.getElementById('timer');
            if (timerEl && elapsedTime >= 0) {
                 timerEl.textContent = `${toArabicNumerals(String(minutes).padStart(2, '0'))}:${toArabicNumerals(String(seconds).padStart(2, '0'))}`;
            }
        }

        function loadQuestion(index) {
            answered = false;
            
            const scenarioTitleEl = document.getElementById('scenario-title');
            const scenarioDescriptionEl = document.getElementById('scenario-description');
            const tableHeaderXEl = document.getElementById('table-header-x');
            const tableHeaderYEl = document.getElementById('table-header-y');
            const tableBodyEl = document.getElementById('table-body');
            const questionTextEl = document.getElementById('question-text');
            const optionsContainerEl = document.getElementById('options-container');
            const feedbackEl = document.getElementById('feedback');
            const actionButtonsEl = document.getElementById('action-buttons');
            const scoreEl = document.getElementById('score');

            scoreEl.textContent = toArabicNumerals(score);

            const question = gameQuestions[index];
            scenarioTitleEl.textContent = question.scenarioTitle;
            scenarioDescriptionEl.textContent = question.scenarioDescription;
            tableHeaderXEl.textContent = question.headerX;
            tableHeaderYEl.textContent = question.headerY;
            questionTextEl.innerHTML = question.questionText || "Ù‡Ù„ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨ØªØŸ ÙˆÙ…Ø§ Ù‡ÙˆØŸ";
            tableBodyEl.innerHTML = '';

            question.data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50/50";
                tr.innerHTML = `<td class="p-2 text-gray-700">${toArabicNumerals(row[0])}</td><td class="p-2 text-gray-900 font-semibold">${toArabicNumerals(row[1])}</td>`;
                tableBodyEl.appendChild(tr);
            });

            optionsContainerEl.innerHTML = '';
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = "w-full bg-indigo-500 text-white font-bold p-2 rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none flex items-center justify-center min-h-[50px] text-sm";
                button.onclick = () => checkAnswer(option.value);

                if (option.value === 'ØºÙŠØ± Ø«Ø§Ø¨Øª') {
                    button.innerHTML = option.text;
                } else {
                    button.innerHTML = `<span>${option.text}</span>&nbsp;${formatValue(option.value)}`;
                }
                optionsContainerEl.appendChild(button);
            });
            
            feedbackEl.classList.add('hidden');
            feedbackEl.classList.remove('feedback-correct', 'feedback-incorrect');
            optionsContainerEl.style.display = 'grid';
            actionButtonsEl.classList.add('hidden');
        }

        function checkAnswer(selectedValue) {
            if (answered) return;
            answered = true;
            const correct = gameQuestions[currentQuestionIndex].correctAnswer;
            
            const feedbackEl = document.getElementById('feedback');
            const optionsContainerEl = document.getElementById('options-container');
            const actionButtonsEl = document.getElementById('action-buttons');
            const scoreEl = document.getElementById('score');

            feedbackEl.classList.remove('hidden');
            optionsContainerEl.style.display = 'none';
            actionButtonsEl.classList.remove('hidden');

            if (selectedValue === correct) {
                score++;
                scoreEl.textContent = toArabicNumerals(score);
                feedbackEl.textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!";
                feedbackEl.classList.add('feedback-correct');
            } else {
                let correctAnswerText = correct === 'ØºÙŠØ± Ø«Ø§Ø¨Øª' ? 'ØºÙŠØ± Ø«Ø§Ø¨Øª' : formatValue(correct);
                feedbackEl.innerHTML = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswerText}`;
                feedbackEl.classList.add('feedback-incorrect');
            }
        }
        
        function nextQuestion() {
            hideExplanation(false); 
            currentQuestionIndex++;
            if (currentQuestionIndex < gameQuestions.length) {
                loadQuestion(currentQuestionIndex);
            } else {
                clearInterval(timerInterval);
                const finalRunningTime = Date.now() - startTime;
                const finalTimeInSeconds = Math.floor((finalRunningTime - totalPausedDuration) / 1000);
                
                gameScreenEl.innerHTML = `
                 <div class="text-center space-y-2 card-enter p-4">
                    <h1 class="text-2xl font-bold text-indigo-600">ğŸ©º Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ© â¤ï¸â€ğŸ©¹</h1>
                    <div id="final-result-display" class="space-y-2 my-4"></div>
                    <div id="leaderboard-loader" style="display: none;"></div>
                    <div id="leaderboard-container"></div>
                    <div id="finish-game-wrapper" style="display: none;">
                       <button id="finish-game-btn" class="mt-4 w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-800">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©</button>
                    </div>
                </div>`;
                
                window.saveAndFinishGame(score, finalTimeInSeconds);
            }
        }
        
        function showExplanation() {
            clearInterval(timerInterval);
            pauseStartTime = Date.now();

            const q = gameQuestions[currentQuestionIndex];
            const ex = q.explanation;
            let html = '';

            const calcRate = (rate) => {
                const dy = rate.y2 - rate.y1;
                const dx = rate.x2 - rate.x1;
                return { dy, dx, result: dx !== 0 ? dy / dx : 0 };
            };

            const createMiniTable = (row1, row2, highlight = false) => {
                return `
                    <table class="w-full text-center text-sm my-2 border bg-white">
                        <thead>
                            <tr>
                                <th class="p-1 border font-semibold ${highlight ? 'bg-yellow-200 text-yellow-900' : 'bg-green-100 text-green-800'}">${q.headerX}</th>
                                <th class="p-1 border font-semibold ${highlight ? 'bg-yellow-200 text-yellow-900' : 'bg-red-100 text-red-800'}">${q.headerY}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-1 border ${highlight ? 'bg-yellow-100' : 'bg-green-50'}">${toArabicNumerals(row1[0])}</td>
                                <td class="p-1 border ${highlight ? 'bg-yellow-100' : 'bg-red-50'}">${toArabicNumerals(row1[1])}</td>
                            </tr>
                            <tr>
                                <td class="p-1 border ${highlight ? 'bg-yellow-100' : 'bg-green-50'}">${toArabicNumerals(row2[0])}</td>
                                <td class="p-1 border ${highlight ? 'bg-yellow-100' : 'bg-red-50'}">${toArabicNumerals(row2[1])}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            };
            
            if (ex.type === 'interval') {
                const rate = calcRate(ex.rate);
                html += `<div class="border-r-4 border-indigo-500 pr-3 mb-4">`;
                html += `<p class="font-bold">${q.questionText.replace(/<\/?b>/g, '')}</p>`;
                html += createMiniTable(q.data[1], q.data[2], true);
                html += `<p class="text-center text-base sm:text-lg my-2">
                    <span class="text-gray-600">Ø§Ù„Ù…Ø¹Ø¯Ù„ = </span>
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(ex.rate.y2)} - ${toArabicNumerals(ex.rate.y1)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(ex.rate.x2)} - ${toArabicNumerals(ex.rate.x1)}</span></span> = 
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(rate.dy)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(rate.dx)}</span></span> = 
                    ${formatValue(rate.result)}
                </p></div>`;
                 html += `<div class="border-r-4 border-green-500 pr-3"><p class="font-bold pt-2">Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬:</p><p>${ex.conclusion}</p></div>`;
            } else {
                const rate1 = calcRate(ex.rate1);
                const rate2 = calcRate(ex.rate2);

                html += `<div class="border-r-4 border-indigo-500 pr-3 mb-4">`;
                html += `<p class="font-bold">Ù¡. Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠØ©:</p>`;
                html += createMiniTable(q.data[0], q.data[1]);
                html += `<p class="text-center text-base sm:text-lg my-2">
                    <span class="text-gray-600">Ø§Ù„Ù…Ø¹Ø¯Ù„ = </span>
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(ex.rate1.y2)} - ${toArabicNumerals(ex.rate1.y1)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(ex.rate1.x2)} - ${toArabicNumerals(ex.rate1.x1)}</span></span> = 
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(rate1.dy)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(rate1.dx)}</span></span> = 
                    ${formatValue(rate1.result)}
                </p></div>`;

                html += `<div class="border-r-4 border-indigo-500 pr-3 mb-4">`;
                html += `<p class="font-bold">Ù¢. Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø«Ø§Ù„Ø«Ø©:</p>`;
                html += createMiniTable(q.data[1], q.data[2]);
                html += `<p class="text-center text-base sm:text-lg my-2">
                    <span class="text-gray-600">Ø§Ù„Ù…Ø¹Ø¯Ù„ = </span>
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(ex.rate2.y2)} - ${toArabicNumerals(ex.rate2.y1)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(ex.rate2.x2)} - ${toArabicNumerals(ex.rate2.x1)}</span></span> = 
                    <span class="fraction-display"><span class="numerator font-bold text-red-600">${toArabicNumerals(rate2.dy)}</span><span class="denominator font-bold text-green-600">${toArabicNumerals(rate2.dx)}</span></span> = 
                    ${formatValue(rate2.result)}
                </p></div>`;
                
                html += `<div class="border-r-4 border-green-500 pr-3"><p class="font-bold pt-2">Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬:</p><p>${ex.conclusion}</p></div>`;
            }

            explanationContentEl.innerHTML = html;
            explanationModalEl.classList.remove('hidden');
        }

        function hideExplanation(resumeTimer = true) {
            if (pauseStartTime) {
                totalPausedDuration += Date.now() - pauseStartTime;
                pauseStartTime = null;
            }

            if (resumeTimer && currentQuestionIndex < gameQuestions.length) {
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            explanationModalEl.classList.add('hidden');
        }
        // --- Game Code END ---
    </script>
    
    <script>
        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
        (function() {
            // --- CONFIGURATION (Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù„Ø¹Ø¨Ø©) ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const GAME_ID = 'g2_5_1';      // Ù…Ø«Ø§Ù„: 'g1_1_1'
            const GAME_MAX_POINTS = 5;                  // Ø£Ù‚ØµÙ‰ Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
            const PLATFORM_MAX_GRADE = 5;               // Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©
            const METRIC_TYPE = 'time';                 // Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±: 'time', 'stars', 'errors'
            const METRIC_LABEL = 'Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ)';        // Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„

            // --- Read URL Parameters ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const classId = urlParams.get('classId');
            const studentName = urlParams.get('studentName');

            let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

            // --- CORE FUNCTIONS ---

            // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
            window.saveAndFinishGame = function(points, metricValue) {
                const finalPoints = parseFloat(points) || 0;
                const finalMetric = parseFloat(metricValue) || 0;
                const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
                const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

                const resultDisplay = document.getElementById('final-result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø·: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                        <p class="text-gray-700">Ø§Ù„ÙˆÙ‚Øª: <span class="font-bold text-xl">${finalMetric} Ø«Ø§Ù†ÙŠØ©</span></p>
                        <p class="text-blue-600 mt-2">Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                    `;
                }

                if (studentId && classId) {
                    const params = new URLSearchParams({
                        action: 'saveGrade',
                        studentId: studentId,
                        classId: classId,
                        itemId: GAME_ID,
                        grade: finalGrade.toFixed(2),
                        metricValue: Math.round(finalMetric).toString()
                    });
                    fetch(`${SCRIPT_URL}?${params.toString()}`)
                        .then(res => res.json())
                        .then(result => console.log('Save result:', result.status))
                        .catch(err => console.error("Save Error:", err))
                        .finally(fetchAndShowLeaderboard);
                } else {
                    console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                    fetchAndShowLeaderboard();
                }
            }

            // 2. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
            function fetchAndShowLeaderboard() {
                const loader = document.getElementById('leaderboard-loader');
                const container = document.getElementById('leaderboard-container');
                if (!loader || !container) return;
                
                if (!classId) {
                    console.log("No classId found, skipping leaderboard for visitor.");
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·.</p>`;
                    showFinishButton();
                    return;
                }

                loader.style.display = 'block';
                container.innerHTML = '';

                const params = new URLSearchParams({
                    action: 'getLeaderboard',
                    gameId: GAME_ID,
                    metricType: METRIC_TYPE,
                    classId: classId
                });

                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            displayLeaderboard(response.data);
                        } else {
                            throw new Error(response.message || 'Failed to load leaderboard data.');
                        }
                    })
                    .catch(err => {
                        console.error("Leaderboard Error:", err);
                        container.innerHTML = `<p class="text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„.</p>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                        showFinishButton();
                    });
            }
            
            // 3. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
            function displayLeaderboard(data) {
                const container = document.getElementById('leaderboard-container');
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!</p>`;
                    return;
                }

                let tableHTML = `
                    <div class="mt-6 border-t pt-4 max-h-60 overflow-y-auto">
                        <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ†</h3>
                        <table class="min-w-full bg-white shadow-md rounded-lg">
                            <thead class="bg-gray-800 text-white sticky top-0">
                                <tr>
                                    <th class="text-center py-2 px-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th class="text-right py-2 px-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th class="text-center py-2 px-3">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;

                data.forEach((player, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = 'ğŸ¥‡';
                    if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                    if (rank === 3) rankDisplay = 'ğŸ¥‰';

                    const isCurrentUser = (currentUser && player.name === currentUser.name);
                    const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                            <td class="text-right py-2 px-3">${player.name}</td>
                            <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                            <td class="text-center py-2 px-3">${player.metricValue}</td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
            function showFinishButton() {
                const finishWrapper = document.getElementById('finish-game-wrapper');
                if (finishWrapper) {
                    finishWrapper.style.display = 'block';
                }
            }

            // 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ®ØµÙŠØµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
            document.addEventListener('DOMContentLoaded', () => {
                const welcomeMessageEl = document.getElementById('welcomeMessage');
                if (studentName && welcomeMessageEl) {
                    // This will be handled by the game's own welcome screen now.
                    // We just ensure it exists.
                } else if (welcomeMessageEl) {
                     // Keep default message if no student name
                }

                // The button listener is now added dynamically when the end screen is created
                // to avoid issues with the element not existing on page load.
                document.body.addEventListener('click', function(event) {
                    if (event.target && event.target.id === 'finish-game-btn') {
                        window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                    }
                });
            });
        })();
        // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>
</body>
</html>


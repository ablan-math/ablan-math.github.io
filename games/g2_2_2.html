<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهمة عالم الدوال</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice Arabic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: 'Cairo', sans-serif;
            touch-action: manipulation;
        }
        .choice-btn {
            transition: all 0.2s ease-in-out;
        }
        .choice-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
            transform: scale(1.05);
            animation: popIn 0.3s ease;
        }
        .incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626 !important;
            animation: shake 0.5s ease;
        }
        .hidden { display: none; }
        .math-expr {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            direction: ltr;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(243, 244, 246, 0.9); /* Semi-transparent background */
            border: 1px solid #e5e7eb;
            display: inline-flex; /* Use flex for alignment */
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 58px; /* Ensure consistent height */
        }
        /* Styling for fractions */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2em;
        }
        .fraction > span:first-child {
            border-bottom: 1.5px solid currentColor;
            padding: 0 0.4em;
        }
        .fraction > span:last-child {
            padding: 0 0.4em;
        }
        /* Styling for Arabic Square Root */
        .arabic-root {
            display: inline-flex;
            align-items: center;
            direction: rtl;
        }
        .arabic-root .radicand {
            border-top: 1.5px solid currentColor;
            padding: 0 0.3em;
        }
        .arabic-root .symbol {
            font-size: 1.5em;
            line-height: 1;
        }
        .highlight {
            color: #6d28d9;
            font-weight: bold;
        }
        .highlight-equation {
            display: inline-block;
            font-size: 1.25rem;
            font-weight: bold;
            color: #5b21b6;
            margin: 0 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: #f5f3ff;
            border-radius: 0.5rem;
        }
        #question small {
            font-size: 0.8rem;
            color: #475569;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.9); }
            70% { transform: scale(1.08); }
            100% { transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .fade-in-section { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 text-center flex flex-col h-full max-h-[95vh] overflow-y-auto">

        <!-- Start Screen -->
        <div id="start-screen" class="fade-in-section">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800 mb-2">🚀 مهمة عالم الدوال 🚀</h1>
            <p id="welcomeMessage" class="text-slate-600 text-base sm:text-lg mb-4">مرحبًا بك في مهمتك التعليمية!</p>

            <div class="text-center border-t border-b py-3 mb-4 space-y-2">
                <h2 class="text-lg sm:text-xl font-bold text-violet-700">عنوان الدرس: الدوال</h2>
                <p class="text-slate-600 text-sm sm:text-base leading-relaxed px-2">
                    ستواجه في هذه المهمة مجموعة من الأسئلة المتنوعة التي تغطي أساسيات الدوال، من التمييز بينها وبين العلاقات، وتحديد الدوال الخطية، وصولًا إلى حساب قيمها وتطبيقاتها العملية.
                    <br>
                    <span class="font-bold">طريقة اللعب:</span> كل إجابة صحيحة تمنحك <span class="highlight">١٠ نقاط</span>. سيتم أيضًا تسجيل الوقت الذي تستغرقه في الحل لتمييز الأبطال الأسرع!
                </p>
            </div>
            
            <button id="start-btn" class="w-full md:w-auto bg-violet-600 text-white font-bold py-3 px-12 rounded-lg text-lg sm:text-xl hover:bg-violet-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                ابدأ التحدي!
            </button>
            
            <p class="text-xs text-slate-400 mt-6">
                تطوير وبرمجة: الأستاذ عبد العزيز خالد العبلان
            </p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden h-full flex flex-col">
            <!-- Header: Score and Timer -->
            <div class="flex justify-between items-center mb-2">
                <div class="text-base sm:text-lg font-bold text-violet-600">النقاط: <span id="score">0</span></div>
                <div id="timer" class="text-lg sm:text-xl font-bold bg-slate-200 text-slate-800 rounded-full w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center shadow-inner">١٥</div>
            </div>
             <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                <div id="progress-bar" class="bg-violet-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
            </div>
            
            <!-- Question Section -->
            <div id="question-section" class="fade-in-section relative flex-grow flex flex-col justify-center">
                <!-- Background Icon -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <span id="background-icon" class="text-[12rem] sm:text-[14rem] text-gray-200 select-none" style="opacity: 0.5;"></span>
                </div>
                
                <!-- Content -->
                <div class="relative z-10">
                    <h2 id="stage-title" class="text-xl sm:text-2xl md:text-3xl font-bold text-violet-800 mb-2"></h2>
                    <div id="question" class="text-slate-700 text-base sm:text-lg mb-3 min-h-[56px] p-2 sm:p-4 border-2 border-white/50 rounded-lg bg-white/75 backdrop-blur-sm"></div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedback-section" class="hidden fade-in-section flex-grow flex flex-col justify-center">
                 <h3 id="feedback-title" class="text-2xl sm:text-3xl font-bold mb-3"></h3>
                 
                 <div id="correct-answer-display" class="hidden mb-3">
                    <p class="text-slate-600">الإجابة الصحيحة هي:</p>
                    <div id="correct-answer-box" class="mt-2 p-2 sm:p-3 border-2 border-green-500 rounded-lg bg-green-50 text-green-700 font-bold text-lg">
                    </div>
                 </div>

                 <p id="feedback-explanation" class="hidden text-base sm:text-lg bg-slate-100 p-3 rounded-lg text-slate-700 mb-4"></p>
                 
                 <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="show-solution-btn" class="w-full sm:w-auto bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">
                        اعرف الحل
                    </button>
                    <button id="next-btn" class="w-full sm:w-auto bg-gray-800 text-white font-bold py-3 px-12 rounded-lg text-lg hover:bg-gray-900 transition-colors">
                        التالي (<span id="next-stage-timer">٧</span>)
                    </button>
                 </div>
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden fade-in-section flex flex-col h-full">
             <div class="text-6xl sm:text-8xl mb-2">🏆</div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600 mb-2">رائع! لقد أنجزت المهمة</h1>
            <div id="final-result-display" class="my-2 sm:my-4 text-base sm:text-lg"></div>
            
            <div id="leaderboard-loader" style="display: none;" class="mt-4">
                <p>جاري تحميل سجل الأبطال...</p>
            </div>
            <div id="leaderboard-container" class="flex-grow overflow-hidden">
                <!-- Leaderboard table will be injected here -->
            </div>
            
            <div id="finish-game-wrapper" style="display: none;" class="mt-4 flex flex-col sm:flex-row items-center gap-3 sm:gap-4">
                 <button id="restart-btn" class="w-full sm:w-auto bg-violet-600 text-white font-bold py-3 px-10 rounded-lg text-lg hover:bg-violet-700 transition-colors duration-300 shadow-lg">
                    العب مرة أخرى
                </button>
                <button id="finish-game-btn" class="w-full sm:w-auto bg-gray-800 text-white font-bold py-3 px-10 rounded-lg text-lg hover:bg-gray-900 transition-colors">
                    العودة للمنصة
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Helper function for Arabic Numerals ---
        const toArabicNumerals = (num) => {
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).replace(/[0-9]/g, (digit) => arabicNumerals[digit]);
        };
        
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressBar = document.getElementById('progress-bar');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        
        // Question Section Elements
        const questionSection = document.getElementById('question-section');
        const backgroundIcon = document.getElementById('background-icon');
        const stageTitle = document.getElementById('stage-title');
        const questionText = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');

        // Feedback Section Elements
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackTitle = document.getElementById('feedback-title');
        const correctAnswerDisplay = document.getElementById('correct-answer-display');
        const correctAnswerBox = document.getElementById('correct-answer-box');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const showSolutionBtn = document.getElementById('show-solution-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // --- Audio Context for Sound Effects ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            } else if (type === 'incorrect') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            } else { // click
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            }
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        // --- Question Banks ---
        const questionBanks = [
            // Bank 1: Is it a function? (Sets of ordered pairs)
            [
                { icon: '🚪', title: "بوابة التعريف", question: "اختر البوابة التي <span class='highlight'>تمثل دالة</span>!", options: ["{ (٢، ١)، (٣، <span dir='rtl'>-٢</span>)، (٢، ٤) }", "{ (١، ٥)، (٢، ٦)، (٧، ٦) }"], correctAnswer: "{ (١، ٥)، (٢، ٦)، (٧، ٦) }", explanation: "في الدالة، كل مدخل (س) يرتبط بمخرج واحد فقط. <br> إذا تكرر عنصر من (س)، فهي ليست دالة." },
                { icon: '🚪', title: "بوابة التعريف", question: "أي العلاقات التالية <span class='highlight'>لا تمثل دالة</span>؟", options: ["{ (١، ١)، (٢، ٢)، (٣، ٣) }", "{ (٤، ٥)، (٤، ٦)، (٧، ٨) }"], correctAnswer: "{ (٤، ٥)، (٤، ٦)، (٧، ٨) }", explanation: "هذه العلاقة ليست دالة لأن المدخل ٤ تكرر وارتبط بمخرجين مختلفين (٥ و ٦)." },
                { icon: '🚪', title: "بوابة التعريف", question: "أي المجموعات التالية <span class='highlight'>تمثل دالة</span>؟", options: ["{ (أ ، ب)، (ج ، د)، (هـ ، و) }", "{ (ك ، ل)، (م ، ن)، (ك ، س) }"], correctAnswer: "{ (أ ، ب)، (ج ، د)، (هـ ، و) }", explanation: "تمثل دالة لأنه لا يوجد أي تكرار في عناصر المجال (المدخلات)." },
                { icon: '🚪', title: "بوابة التعريف", question: "اختر العلاقة التي <span class='highlight'>لا تمثل دالة</span>:", options: ["{ (١٠، ٢٠)، (٢٠، ٣٠)، (٣٠، ٢٠) }", "{ (٠، ٠)، (١، ١)، (٠، ٢) }"], correctAnswer: "{ (٠، ٠)، (١، ١)، (٠، ٢) }", explanation: "المدخل ٠ ارتبط بالمخرجين ٠ و ٢، لذلك هي ليست دالة." }
            ],
            // Bank 2: Is it a function? (Yes/No)
            [
                { icon: '🔍', title: "فحص العلاقة", question: "هل العلاقة التالية <span class='highlight'>تمثل دالة</span>؟ { (١، ٥)، (٢، ٧)، (٣، ٥) }", options: ["نعم", "لا"], correctAnswer: "نعم", explanation: "صحيح، لأن كل مدخل له مخرج واحد فقط. لا يهم إذا تشابه المخرج." },
                { icon: '🔍', title: "فحص العلاقة", question: "هل العلاقة التالية <span class='highlight'>تمثل دالة</span>؟ { (٤، ٨)، (<span dir='rtl'>-١</span>، ٩)، (٤، ١٠) }", options: ["نعم", "لا"], correctAnswer: "لا", explanation: "ليست دالة، لأن المدخل ٤ ارتبط بمخرجين مختلفين (٨ و ١٠)." },
                { icon: '🔍', title: "فحص العلاقة", question: "هل العلاقة التالية <span class='highlight'>تمثل دالة</span>؟ { (٠، ١)، (١، ٢)، (٢، ٣) }", options: ["نعم", "لا"], correctAnswer: "نعم", explanation: "نعم، كل مدخل له مخرج واحد فقط والعلاقة منتظمة." },
                { icon: '🔍', title: "فحص العلاقة", question: "هل العلاقة { (<span dir='rtl'>-٢</span>، ٤)، (<span dir='rtl'>-١</span>، ١)، (٠، ٠)، (١، ١)، (٢، ٤) } <span class='highlight'>تمثل دالة</span>؟", options: ["نعم", "لا"], correctAnswer: "نعم", explanation: "نعم تمثل دالة. تكرار المخرجات (ص) مسموح به، المهم ألا يتكرر المدخل (س)." }
            ],
            // Bank 3: Is it a linear function?
            [
                { icon: '🛣️', title: "طريق المعادلات", question: "أي طريق يمثل <span class='highlight'>دالة خطية</span>؟", options: ["ص = <span dir='rtl'>س<sup>٢</sup> + ١</span>", "ص = ٣ - س", "ص س = ١٠", "ص = |&lrm;س&lrm;|"], correctAnswer: "ص = ٣ - س", explanation: "الدالة الخطية أس متغيرها (س) هو ١." },
                { icon: '🛣️', title: "طريق المعادلات", question: "أي المعادلات التالية <span class='highlight'>ليست دالة خطية</span>؟", options: ["ص = ٥س", 'ص = <span class="fraction"><span>٢</span><span>س</span></span>', "ص = س + ١", "ص = ٩"], correctAnswer: 'ص = <span class="fraction"><span>٢</span><span>س</span></span>', explanation: "ليست خطية لأن المتغير س موجود في المقام." },
                { icon: '🛣️', title: "طريق المعادلات", question: "اختر ال<span class='highlight'>دالة الخطية</span> من بين الخيارات:", options: ["٢س + ٣ص = ٦", "ص = <span dir='rtl'>س<sup>٣</sup></span>", "ص = |&lrm;س + ١&lrm;|", 'ص = <span class="fraction"><span>٥</span><span>س</span></span>'], correctAnswer: "٢س + ٣ص = ٦", explanation: "هذه معادلة خطية يمكن كتابتها على الصورة ص = م س + ب." },
                { icon: '🛣️', title: "طريق المعادلات", question: "أي مما يلي يعتبر <span class='highlight'>دالة خطية</span>؟", options: ["ص = ٧", "س ص = ٥", "ص = <span dir='rtl'>س<sup>٢</sup> - ١</span>", 'ص = <span class="arabic-root"><span class="radicand">س</span><span class="symbol">√</span></span>'], correctAnswer: "ص = ٧", explanation: "الدالة الثابتة هي حالة خاصة من الدالة الخطية وميلها يساوي صفر." }
            ],
            // Bank 4: Evaluate the function
            [
                { icon: '🌉', title: "جسر القيمة", question: "أوجد قيمة د(٤) لبناء الجسر: <div class='highlight-equation'><span dir='rtl'>د(س) = </span><span dir='ltr'>٣س - ٢</span></div>", options: ["١٠", "٥", "١٣", "١٤"], correctAnswer: "١٠", explanation: "الحل: د(٤) = (٣ × ٤) - ٢ <br> = ١٢ - ٢ = ١٠" },
                { icon: '🌉', title: "جسر القيمة", question: "إذا كانت <div class='highlight-equation'><span dir='rtl'>د(س) = </span><span dir='ltr'>١٠ - ٢س</span></div>، فما قيمة د(٣)؟", options: ["٤", "٦", "٧", "٨"], correctAnswer: "٤", explanation: "الحل: د(٣) = ١٠ - (٢ × ٣) <br> = ١٠ - ٦ = ٤" },
                { icon: '🌉', title: "جسر القيمة", question: "إذا كانت <div class='highlight-equation'><span dir='rtl'>د(س) = س<sup>٢</sup> + ١</span></div>، فما قيمة د(٥)؟", options: ["٢٦", "١١", "١٠", "٢٥"], correctAnswer: "٢٦", explanation: "الحل: د(٥) = (٥)<sup>٢</sup> + ١ <br> = ٢٥ + ١ = ٢٦" },
                { icon: '🌉', title: "جسر القيمة", question: 'إذا كانت <div class="highlight-equation"><span dir="rtl">د(س) = </span><span class="fraction"><span>س + ٤</span><span>٢</span></span></div>، فما قيمة د(٦)؟', options: ["٥", "٧", "١٠", "٣"], correctAnswer: "٥", explanation: 'الحل: <span class="fraction"><span>٦ + ٤</span><span>٢</span></span> = <span class="fraction"><span>١٠</span><span>٢</span></span> = ٥' }
            ],
            // Bank 5: Application/Word Problem
            [
                { icon: '🚗', title: "الوجهة النهائية", question: "تكلفة استئجار سيارة هي <span class='highlight-equation'><span dir='rtl'>ت(ي) = </span><span dir='ltr'>٥٠ + ٩٠ي</span></span>، ما تكلفة ٣ أيام؟ <small class='text-slate-500'>(حيث ت: التكلفة، ي: الأيام)</small>", options: ["٢٤٠ ريال", "٣٢٠ ريال", "١٤٠ ريال", "٢٧٠ ريال"], correctAnswer: "٣٢٠ ريال", explanation: "الحل: ت(٣) = ٥٠ + (٩٠ × ٣) <br> = ٥٠ + ٢٧٠ = ٣٢٠ ريال." },
                { icon: '📱', title: "فاتورة الهاتف", question: "فاتورة هاتف تحسب كالتالي: <span class='highlight-equation'><span dir='rtl'>ف(د) = </span><span dir='ltr'>٢٥ + ٠.٥د</span></span>، ما تكلفة ٢٠ دقيقة؟ <small class='text-slate-500'>(حيث ف: الفاتورة، د: الدقائق)</small>", options: ["٣٥ ريال", "٤٥ ريال", "١٠٠ ريال", "٢٥ ريال"], correctAnswer: "٣٥ ريال", explanation: "الحل: ف(٢٠) = ٢٥ + (٠.٥ × ٢٠) <br> = ٢٥ + ١٠ = ٣٥ ريال" },
                { icon: '🌡️', title: "تحويل الحرارة", question: "لتحويل من مئوي لفهرنهايت: <span class='highlight-equation'><span dir='rtl'>ف = </span><span dir='ltr'>١.٨م + ٣٢</span></span>، كم تساوي ١٠ درجات مئوية؟ <small class='text-slate-500'>(حيث ف: فهرنهايت، م: مئوي)</small>", options: ["٥٠ ف", "٤٢ ف", "٣٣.٨ ف", "١٨ ف"], correctAnswer: "٥٠ ف", explanation: "الحل: ف = (١.٨ × ١٠) + ٣٢ <br> = ١٨ + ٣٢ = ٥٠ فهرنهايت." },
                { icon: '💧', title: "ملء خزان", question: "حجم الماء في خزان هو <span class='highlight-equation'><span dir='rtl'>ح(ن) = </span><span dir='ltr'>١٠٠ + ٢٠ن</span></span>، كم الحجم بعد ٥ دقائق؟ <small class='text-slate-500'>(حيث ح: الحجم، ن: الدقائق)</small>", options: ["٢٠٠ لتر", "١٢٥ لتر", "٥٠٠ لتر", "٦٠٠ لتر"], correctAnswer: "٢٠٠ لتر", explanation: "الحل: ح(٥) = ١٠٠ + (٢٠ × ٥) <br> = ١٠٠ + ١٠٠ = ٢٠٠ لتر" }
            ]
        ];

        let gameData = [];
        let currentStageIndex = 0;
        let score = 0;
        let totalTimeTaken = 0;
        let timerInterval;
        let timeLeft = 15;
        let nextStageTimerInterval;

        // --- Game Logic ---
        function generateRandomQuiz() {
            gameData = [];
            questionBanks.forEach(bank => {
                const randomIndex = Math.floor(Math.random() * bank.length);
                const randomQuestion = bank[randomIndex];
                gameData.push(randomQuestion);
            });
        }
        
        function startGame() {
            initAudio();
            playSound('click');
            generateRandomQuiz();
            score = 0;
            totalTimeTaken = 0;
            scoreDisplay.textContent = toArabicNumerals(score);
            currentStageIndex = 0;
            progressBar.style.width = '0%';
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadStage(currentStageIndex);
        }

        function startTimer() {
            timeLeft = 15;
            timerDisplay.textContent = toArabicNumerals(timeLeft);
            timerDisplay.classList.remove('text-red-500');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = toArabicNumerals(timeLeft);
                if (timeLeft < 6) {
                    timerDisplay.classList.add('text-red-500');
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(null, null); // Time's up
                }
            }, 1000);
        }

        function loadStage(stageIndex) {
            feedbackSection.classList.add('hidden');
            questionSection.classList.remove('hidden');
            
            const stage = gameData[stageIndex];

            if (stage.options.length > 2) {
                optionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4';
            } else {
                optionsContainer.className = 'grid grid-cols-1 gap-2 sm:gap-4';
            }
            
            backgroundIcon.textContent = stage.icon;
            stageTitle.textContent = `المرحلة ${toArabicNumerals(stageIndex + 1)}: ${stage.title}`;
            questionText.innerHTML = stage.question; 
            optionsContainer.innerHTML = '';

            stage.options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span class="math-expr">${option}</span>`;
                button.classList.add('choice-btn', 'w-full', 'p-2', 'sm:p-4', 'border-2', 'border-white/50', 'rounded-lg', 'text-slate-800', 'font-semibold', 'bg-white/75', 'backdrop-blur-sm', 'hover:bg-violet-100/90', 'hover:border-violet-400');
                button.onclick = (e) => {
                    playSound('click');
                    checkAnswer(button, option);
                };
                optionsContainer.appendChild(button);
            });
            startTimer();
        }
        
        function checkAnswer(button, selectedOption) {
            clearInterval(timerInterval);
            const timeTaken = 15 - (timeLeft > 0 ? timeLeft : 0);
            totalTimeTaken += timeTaken;
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            
            const stage = gameData[currentStageIndex];
            const isCorrect = selectedOption === stage.correctAnswer;
            
            if (timeLeft <= 0) {
                 playSound('incorrect');
                 displayFeedback('timeout', stage.explanation);
            } else if (isCorrect) {
                playSound('correct');
                // Scoring system: 10 points for each correct answer
                const pointsGained = 10;
                score += pointsGained;
                scoreDisplay.textContent = toArabicNumerals(score);
                button.classList.add('correct');
                const progressPercentage = ((currentStageIndex + 1) / gameData.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                displayFeedback('correct', stage.explanation, pointsGained);
            } else {
                playSound('incorrect');
                button.classList.add('incorrect');
                displayFeedback('incorrect', stage.explanation);
            }
        }

        function displayFeedback(resultType, explanation, points) {
            questionSection.classList.add('hidden');
            feedbackSection.classList.remove('hidden');
            
            // Reset feedback view
            correctAnswerDisplay.classList.add('hidden');
            feedbackExplanation.classList.add('hidden');
            showSolutionBtn.classList.remove('hidden');
            nextBtn.innerHTML = `التالي (<span id="next-stage-timer">٧</span>)`;

            switch(resultType) {
                case 'correct':
                    feedbackTitle.innerHTML = `✅ رائع! +${toArabicNumerals(points)} نقطة`;
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-green-500';
                    break;
                case 'incorrect':
                    feedbackTitle.textContent = '❌ إجابة خاطئة';
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-red-500';
                    break;
                case 'timeout':
                    feedbackTitle.textContent = '⏳ انتهى الوقت!';
                    feedbackTitle.className = 'text-2xl sm:text-3xl font-bold mb-3 text-yellow-600';
                    break;
            }
            feedbackExplanation.innerHTML = explanation;
            startNextStageTimer();
        }

        function startNextStageTimer() {
            let nextStageTimeLeft = 7;
            const timerDisplay = document.getElementById('next-stage-timer');
            if (timerDisplay) timerDisplay.textContent = toArabicNumerals(nextStageTimeLeft);
            
            clearInterval(nextStageTimerInterval);
            nextStageTimerInterval = setInterval(() => {
                nextStageTimeLeft--;
                if(timerDisplay) timerDisplay.textContent = toArabicNumerals(nextStageTimeLeft);
                if (nextStageTimeLeft <= 0) nextStage();
            }, 1000);
        }

        function showSolution() {
            playSound('click');
            clearInterval(nextStageTimerInterval);
            
            const stage = gameData[currentStageIndex];
            const correctAnswer = stage.correctAnswer;

            correctAnswerBox.innerHTML = `<span class="math-expr !bg-transparent !border-none !p-0">${correctAnswer}</span>`;
            correctAnswerDisplay.classList.remove('hidden');
            
            feedbackExplanation.classList.remove('hidden');
            showSolutionBtn.classList.add('hidden');
            nextBtn.innerHTML = 'التالي';
        }

        function nextStage() {
            playSound('click');
            clearInterval(nextStageTimerInterval);
            currentStageIndex++;
            if (currentStageIndex < gameData.length) {
                loadStage(currentStageIndex);
            } else {
                showEndScreen();
            }
        }

        function showEndScreen() {
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            window.saveAndFinishGame(score, totalTimeTaken);
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', nextStage);
        showSolutionBtn.addEventListener('click', showSolution);

        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
        (function() {
            // --- CONFIGURATION (عدّل هذه الإعدادات لكل لعبة) ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const GAME_ID = 'g2_2_2';         // Example: 'g1_1_1'
            const GAME_MAX_POINTS = 50;                     // Max points in the game (10 points/q * 5 questions)
            const PLATFORM_MAX_GRADE = 5;                   // Final grade in the platform
            const METRIC_TYPE = 'time';                     // Metric type: 'time', 'stars', 'errors'
            const METRIC_LABEL = 'الوقت (ثواني)';           // Metric label for display

            // --- Read URL Parameters ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const classId = urlParams.get('classId');
            const studentName = urlParams.get('studentName');

            let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

            // --- CORE FUNCTIONS ---

            // 1. Main function called when the game ends
            window.saveAndFinishGame = function(points, metricValue) {
                const finalPoints = parseFloat(points) || 0;
                const finalMetric = parseFloat(metricValue) || 0;
                const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
                const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

                const resultDisplay = document.getElementById('final-result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">النقاط: <span class="font-bold text-xl">${toArabicNumerals(finalPoints)} / ${toArabicNumerals(maxPoints)}</span></p>
                        <p class="text-blue-600">الدرجة في المنصة: <span class="font-bold text-2xl">${toArabicNumerals(finalGrade.toFixed(1))} / ${toArabicNumerals(PLATFORM_MAX_GRADE)}</span></p>
                    `;
                }

                if (studentId && classId) {
                    const params = new URLSearchParams({
                        action: 'saveGrade',
                        studentId: studentId,
                        classId: classId,
                        itemId: GAME_ID,
                        grade: finalGrade.toFixed(2),
                        metricValue: Math.round(finalMetric).toString()
                    });
                    fetch(`${SCRIPT_URL}?${params.toString()}`)
                        .then(res => res.json())
                        .then(result => console.log('Save result:', result.status))
                        .catch(err => console.error("Save Error:", err))
                        .finally(fetchAndShowLeaderboard);
                } else {
                    console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                    fetchAndShowLeaderboard();
                }
            }

            // 2. Function to fetch and display the leaderboard
            function fetchAndShowLeaderboard() {
                const loader = document.getElementById('leaderboard-loader');
                const container = document.getElementById('leaderboard-container');
                if (!loader || !container) return;
                
                if (!classId) {
                    console.log("No classId found, skipping leaderboard for visitor.");
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">سجل الأبطال متاح للطلاب المسجلين فقط.</p>`;
                    showFinishButton();
                    return;
                }

                loader.style.display = 'block';
                container.innerHTML = '';

                const params = new URLSearchParams({
                    action: 'getLeaderboard',
                    gameId: GAME_ID,
                    metricType: METRIC_TYPE,
                    classId: classId
                });

                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            displayLeaderboard(response.data);
                        } else {
                            throw new Error(response.message || 'Failed to load leaderboard data.');
                        }
                    })
                    .catch(err => {
                        console.error("Leaderboard Error:", err);
                        container.innerHTML = `<p class="text-center text-red-500">حدث خطأ في تحميل سجل الأبطال.</p>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                        showFinishButton();
                    });
            }
            
            // 3. Function to build the leaderboard table
            function displayLeaderboard(data) {
                const container = document.getElementById('leaderboard-container');
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">لا توجد نتائج بعد. كن أول الأبطال!</p>`;
                    return;
                }

                let tableHTML = `
                    <div class="mt-4 border-t pt-4">
                        <h3 class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-4">🏆 سجل الأبطال 🏆</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white shadow-md rounded-lg text-sm">
                                <thead class="bg-gray-800 text-white">
                                    <tr>
                                        <th class="text-center py-2 px-3">الترتيب</th>
                                        <th class="text-right py-2 px-3">اسم الطالب</th>
                                        <th class="text-center py-2 px-3">الدرجة</th>
                                        <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-700">`;

                data.forEach((player, index) => {
                    const rank = index + 1;
                    let rankDisplay = toArabicNumerals(rank);
                    if (rank === 1) rankDisplay = '🥇';
                    if (rank === 2) rankDisplay = '🥈';
                    if (rank === 3) rankDisplay = '🥉';

                    const isCurrentUser = (currentUser && player.name === currentUser.name);
                    const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center py-2 px-3 text-lg">${rankDisplay}</td>
                            <td class="text-right py-2 px-3">${player.name}</td>
                            <td class="text-center py-2 px-3">${toArabicNumerals(player.grade.toFixed(1))}</td>
                            <td class="text-center py-2 px-3">${toArabicNumerals(player.metricValue)}</td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div></div>`;
                container.innerHTML = tableHTML;
            }

            // 4. Show the finish button
            function showFinishButton() {
                const finishWrapper = document.getElementById('finish-game-wrapper');
                if (finishWrapper) {
                    finishWrapper.style.display = 'flex';
                }
            }

            // 5. Handle the finish button and personalize the welcome message
            document.addEventListener('DOMContentLoaded', () => {
                // Personalize welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (studentName && welcomeMessage) {
                    welcomeMessage.innerHTML = `أهلاً بك يا <span class="font-bold text-violet-500">${studentName}</span>! انطلق في مهمتك عبر عالم الدوال وحل الألغاز الرياضية لتصل إلى النهاية. كل إجابة صحيحة تقربك من هدفك!`;
                }

                const finishBtn = document.getElementById('finish-game-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', () => {
                        window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                    });
                }
            });
        })();
        // --- END OF CONNECTION & LEADERBOARD ENGINE ---
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدرس ٢-٢: الدوال | منصة الرياضيات التفاعلية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden { display: none; }
        .step-box { border-right: 4px solid #1d4ed8; }
        .vocab-term { background-color: #ffefc5; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .option-label { display: block; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-label:hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="radio"]:checked + .option-label { border-color: #2563eb; background-color: #dbeafe; box-shadow: 0 0 0 2px #bfdbfe; }
        input[type="radio"] { display: none; }
        .feedback-correct { color: #16a34a; }
        .feedback-incorrect { color: #dc2626; }
        .highlight-change { color: #ef4444; font-weight: bold; }
        
        /* === تعديل الرموز الرياضية === */
        .math-eq {
            font-family: "Courier New", monospace; /* خط عريض ومتباعد */
            font-size: 1.1rem; /* تكبير حجم الخط */
            font-weight: bold;
            color: #4338ca;
            background-color: #f3f4f6; /* خلفية رمادية فاتحة */
            border: 1px solid #d1d5db; /* إطار خفيف */
            padding: 2px 8px; /* هوامش داخلية */
            border-radius: 6px; /* زوايا دائرية */
            display: inline-block;
            vertical-align: middle; /* محاذاة أفضل مع النص */
        }
        
        .fraction { display: inline-flex; flex-direction: column; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding: 0 0.4em; }
        .fraction > .frac-bar { border-top: 2px solid #4338ca; }
        
        /* Classes for interactive example */
        .example-diagram {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .example-diagram.dimmed {
            opacity: 0.4;
        }
        .example-diagram.active {
            opacity: 1;
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .step-interactive { display: none; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateY(10px); }
        .step-interactive.active { display: block; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="grid grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto max-w-4xl my-8">
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-200">
                    <h1 id="lesson-title" class="text-3xl font-bold text-blue-800">الدرس ٢-٢: الدوال</h1>
                    <a href="../index.html" target="_top" class="text-sm text-blue-600 hover:underline">&larr; العودة إلى الفهرس</a>
                </header>
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">💡 أولاً: المفهوم الأساسي</h2>
                    <div class="p-4 bg-blue-50 rounded-lg space-y-3">
                        <p><span class="vocab-term">الدالة</span> هي علاقة خاصة تربط كل عنصر في المجال بعنصر <strong class="text-red-600">واحد فقط</strong> في المدى. هذا يعني أن كل قيمة لـ <span class="math-eq">س</span> يجب أن ترتبط بقيمة واحدة فقط لـ <span class="math-eq">ص</span>.</p>
                    </div>
                </section>
                
                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثانياً: أمثلة تفاعلية</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div class="flex flex-col space-y-8">
                            <div id="interactive-container-1" class="p-4 bg-white rounded-lg shadow">
                                <p class="text-lg font-semibold mb-4">مثال ١: تحديد الدوال من المخططات السهمية</p>
                                <div id="diagram-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 min-h-[250px] items-start">
                                    <div class="interactive-placeholder text-center text-gray-500 p-4 md:col-span-4"><p>اضغط "التالي" لبدء خطوات الحل</p></div>
                                    
                                    <div id="ex1-col" class="example-diagram flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold mb-2">المثال الأول</h4>
                                        <svg viewBox="0 0 100 80" class="w-full h-32 bg-white border rounded-lg"><defs><marker id="ex1-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="70" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="15" font-size="7" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="30" font-size="7" text-anchor="middle">-٢</text><text x="80" y="45" font-size="7" text-anchor="middle">٣</text><text x="80" y="60" font-size="7" text-anchor="middle">٤</text><rect x="5" y="5" width="30" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="15" font-size="7" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="30" font-size="7" text-anchor="middle">-٣</text><text x="20" y="45" font-size="7" text-anchor="middle">٦</text><text x="20" y="60" font-size="7" text-anchor="middle">٩</text><path d="M 65 30 Q 50 30 35 30" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex1-arrow)" /><path d="M 65 45 Q 50 52.5 35 60" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex1-arrow)" /><path d="M 65 60 Q 50 52.5 35 45" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex1-arrow)" /></svg>
                                        <div id="ex1-analysis" class="hidden mt-2 p-2 w-full bg-green-100 rounded-md text-green-800 text-sm text-center"><strong>نعم، دالة:</strong> كل عنصر في المجال ارتبط بعنصر واحد فقط.</div>
                                    </div>

                                    <div id="ex2-col" class="example-diagram flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold mb-2">المثال الثاني</h4>
                                        <div id="ex2-initial">
                                            <svg viewBox="0 0 100 80" class="w-full h-32 bg-white border rounded-lg"><defs><marker id="ex2-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="70" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="15" font-size="7" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="30" font-size="7" text-anchor="middle">١</text><text x="80" y="45" font-size="7" text-anchor="middle">٢</text><text x="80" y="60" font-size="7" text-anchor="middle">٣</text><rect x="5" y="15" width="30" height="55" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="25" font-size="7" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="40" font-size="7" text-anchor="middle">٤</text><text x="20" y="55" font-size="7" text-anchor="middle">٥</text><path d="M 65 30 Q 50 35 35 40" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow)" /><path d="M 65 30 Q 50 45 35 55" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow)" /><path d="M 65 45 Q 50 50 35 55" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow)" /></svg>
                                        </div>
                                        <div id="ex2-analysis" class="hidden w-full">
                                            <svg viewBox="0 0 100 80" class="w-full h-32 bg-white border rounded-lg"><defs><marker id="ex2-arrow-red" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444" /></marker><marker id="ex2-arrow-blue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="70" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="15" font-size="7" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="30" font-size="7" text-anchor="middle">١</text><text x="80" y="45" font-size="7" text-anchor="middle">٢</text><text x="80" y="60" font-size="7" text-anchor="middle">٣</text><rect x="5" y="15" width="30" height="55" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="25" font-size="7" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="40" font-size="7" text-anchor="middle">٤</text><text x="20" y="55" font-size="7" text-anchor="middle">٥</text><path d="M 65 30 Q 50 35 35 40" stroke="#ef4444" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow-red)" /><path d="M 65 30 Q 50 45 35 55" stroke="#ef4444" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow-red)" /><path d="M 65 45 Q 50 50 35 55" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex2-arrow-blue)" /></svg>
                                            <div class="mt-2 p-2 w-full bg-red-100 rounded-md text-red-800 text-sm text-center"><strong>ليست دالة:</strong> العنصر <strong class="highlight-change">١</strong> ارتبط بعنصرين.</div>
                                        </div>
                                    </div>

                                    <div id="ex3-col" class="example-diagram flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold mb-2">المثال الثالث</h4>
                                        <svg viewBox="0 0 100 80" class="w-full h-32 bg-white border rounded-lg"><defs><marker id="ex3-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="70" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="15" font-size="7" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="30" font-size="7" text-anchor="middle">١</text><text x="80" y="45" font-size="7" text-anchor="middle">٢</text><text x="80" y="60" font-size="7" text-anchor="middle">٣</text><rect x="5" y="25" width="30" height="30" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="35" font-size="7" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="50" font-size="7" text-anchor="middle">٥</text><path d="M 65 30 Q 50 40 35 50" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex3-arrow)" /><path d="M 65 45 Q 50 47.5 35 50" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex3-arrow)" /><path d="M 65 60 Q 50 52.5 35 50" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex3-arrow)" /></svg>
                                        <div id="ex3-analysis" class="hidden mt-2 p-2 w-full bg-green-100 rounded-md text-green-800 text-sm text-center"><strong>نعم، دالة:</strong> لا يهم ارتباط أكثر من عنصر بنفس المدى.</div>
                                    </div>
                                    
                                    <div id="ex4-col" class="example-diagram flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold mb-2">المثال الرابع</h4>
                                        <svg viewBox="0 0 100 80" class="w-full h-32 bg-white border rounded-lg"><defs><marker id="ex4-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs><rect x="65" y="5" width="30" height="70" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="80" y="15" font-size="7" font-weight="bold" text-anchor="middle">المجال</text><text x="80" y="30" font-size="7" text-anchor="middle">أ</text><text x="80" y="45" font-size="7" text-anchor="middle">ب</text><text x="80" y="60" font-size="7" text-anchor="middle">ج</text><rect x="5" y="15" width="30" height="55" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="20" y="25" font-size="7" font-weight="bold" text-anchor="middle">المدى</text><text x="20" y="40" font-size="7" text-anchor="middle">١</text><text x="20" y="55" font-size="7" text-anchor="middle">٢</text><path d="M 65 30 Q 50 35 35 40" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex4-arrow)" /><path d="M 65 60 Q 50 57.5 35 55" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#ex4-arrow)" /></svg>
                                        <div id="ex4-analysis" class="hidden mt-2 p-2 w-full bg-red-100 rounded-md text-red-800 text-sm text-center"><strong>ليست دالة:</strong> العنصر <strong class="highlight-change">'ب'</strong> في المجال لم يرتبط بأي عنصر.</div>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-6">
                                    <button data-example="1" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                    <div>
                                        <button data-example="1" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                        <button data-example="1" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🎯 ثالثاً: أمثلة تفاعلية إضافية</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Example 2: Tables -->
                            <div id="interactive-container-2" class="p-4 bg-white rounded-lg shadow">
                                    <p class="text-lg font-semibold mb-4">مثال ٢: تحديد الدوال من الجداول</p>
                                    <div class="problem-statement p-4 bg-gray-50 rounded-lg step-box mb-4">
                                        <h4 class="font-bold">الجداول (مثال أ)</h4>
                                        <p>هل الجدول التالي يمثل دالة؟</p>
                                        <div class="p-3"><table class="w-full border-collapse border border-slate-400"><thead><tr class="bg-gray-200"><th class="p-2 border border-slate-300">س</th><th class="p-2 border border-slate-300">ص</th></tr></thead><tbody><tr><td class="border border-slate-300 p-1">١</td><td class="border border-slate-300 p-1">٥</td></tr><tr><td class="border border-slate-300 p-1">٣</td><td class="border border-slate-300 p-1">-٤</td></tr><tr><td class="border border-slate-300 p-1">١</td><td class="border border-slate-300 p-1">-٤</td></tr></tbody></table></div>
                                    </div>
                                    <div class="steps-container space-y-4">
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                            <h4 class="font-bold">تحليل الجدول (مثال أ)</h4>
                                            <div class="p-3"><table class="w-full border-collapse border border-slate-400"><thead><tr class="bg-gray-200"><th class="p-2 border border-slate-300">س</th><th class="p-2 border border-slate-300">ص</th></tr></thead><tbody><tr><td class="border border-slate-300 p-1"><span class="highlight-change">١</span></td><td class="border border-slate-300 p-1">٥</td></tr><tr><td class="border border-slate-300 p-1">٣</td><td class="border border-slate-300 p-1">-٤</td></tr><tr><td class="border border-slate-300 p-1"><span class="highlight-change">١</span></td><td class="border border-slate-300 p-1">-٤</td></tr></tbody></table></div>
                                            <p class="mt-2 p-2 bg-red-100 rounded-md text-red-800 text-sm"><strong>ليست دالة:</strong> العنصر ١ في المجال ارتبط بـ ٥ و -٤.</p>
                                        </div>
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                            <h4 class="font-bold">الجداول (مثال ب)</h4>
                                            <p>هل الجدول التالي يمثل دالة؟</p>
                                            <div class="p-3"><table class="w-full border-collapse border border-slate-400"><thead><tr class="bg-gray-200"><th class="p-2 border border-slate-300">س</th><th class="p-2 border border-slate-300">ص</th></tr></thead><tbody><tr><td class="border border-slate-300 p-1">٢</td><td class="border border-slate-300 p-1">١</td></tr><tr><td class="border border-slate-300 p-1">٣</td><td class="border border-slate-300 p-1">-٢</td></tr><tr><td class="border border-slate-300 p-1">٤</td><td class="border border-slate-300 p-1">١</td></tr></tbody></table></div>
                                        </div>
                                        <div class="step-interactive p-4 bg-white rounded-lg border-4 border-green-500">
                                            <h4 class="font-bold">تحليل الجدول (مثال ب)</h4>
                                            <div class="p-3"><table class="w-full border-collapse border border-slate-400 bg-white"><thead><tr class="bg-gray-200"><th class="p-2 border border-slate-300">س</th><th class="p-2 border border-slate-300">ص</th></tr></thead><tbody><tr><td class="border border-slate-300 p-1">٢</td><td class="border border-slate-300 p-1">١</td></tr><tr><td class="border border-slate-300 p-1">٣</td><td class="border border-slate-300 p-1">-٢</td></tr><tr><td class="border border-slate-300 p-1">٤</td><td class="border border-slate-300 p-1">١</td></tr></tbody></table></div>
                                            <p class="mt-2 p-2 bg-green-100 rounded-md text-green-800 text-sm"><strong>نعم، دالة:</strong> كل عنصر في المجال {٢, ٣, ٤} له مخرجة واحدة فقط.</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button data-example="2" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                        <div>
                                            <button data-example="2" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                            <button data-example="2" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                        </div>
                                    </div>
                            </div>
                            <!-- Example 3: Ordered Pairs -->
                            <div id="interactive-container-3" class="p-4 bg-white rounded-lg shadow">
                                    <p class="text-lg font-semibold mb-4">مثال ٣: تحديد الدوال من الأزواج المرتبة</p>
                                    <div class="problem-statement p-4 bg-gray-50 rounded-lg step-box mb-4">
                                        <h4 class="font-bold">الأزواج المرتبة</h4>
                                        <p>حدد أي من المجموعات التالية تمثل دالة:</p>
                                        <div class="space-y-4 mt-2">
                                            <div class="p-2 bg-white rounded shadow"><p class="font-semibold">المجموعة الأولى:</p><p class="math-eq text-sm">{(٢,١), (٣,-٢), (٤,١), (٥,-٢)}</p></div>
                                            <div class="p-2 bg-white rounded shadow"><p class="font-semibold">المجموعة الثانية:</p><p class="math-eq text-sm">{(١,٥), (٢,٦), (١,٧), (٣,٨)}</p></div>
                                        </div>
                                    </div>
                                    <div class="steps-container space-y-4">
                                        <div class="step-interactive p-4 bg-gray-50 rounded-lg step-box">
                                            <h4 class="font-bold">تحليل المجموعة الأولى</h4>
                                            <div class="p-2 bg-white rounded shadow">
                                                <p class="font-semibold">المجموعة الأولى:</p>
                                                <p class="math-eq text-sm">{(<span class="text-blue-600 font-bold">٢</span>,١), (<span class="text-blue-600 font-bold">٣</span>,-٢), (<span class="text-blue-600 font-bold">٤</span>,١), (<span class="text-blue-600 font-bold">٥</span>,-٢)}</p>
                                                <p class="mt-2 p-2 bg-green-100 rounded-md text-green-800 text-sm"><strong>نعم، دالة:</strong> كل عنصر في المجال {٢, ٣, ٤, ٥} لم يتكرر.</p>
                                            </div>
                                        </div>
                                        <div class="step-interactive p-4 bg-white rounded-lg border-4 border-red-500">
                                            <h4 class="font-bold">تحليل المجموعة الثانية (الحل النهائي)</h4>
                                            <div class="p-2 bg-white rounded shadow">
                                                <p class="font-semibold">المجموعة الثانية:</p>
                                                <p class="math-eq text-sm">{(<span class="highlight-change">١</span>,٥), (٢,٦), (<span class="highlight-change">١</span>,٧), (٣,٨)}</p>
                                                <p class="mt-2 p-2 bg-red-100 rounded-md text-red-800 text-sm"><strong>ليست دالة:</strong> العنصر ١ في المجال ارتبط بقيمتين مختلفتين (٥ و ٧).</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button data-example="3" class="prev-btn bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">رجوع</button>
                                        <div>
                                            <button data-example="3" class="next-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">التالي</button>
                                            <button data-example="3" class="reset-btn hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">إعادة</button>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📐 رابعاً: اختبار الخط الرأسي المتحرك</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <p>يمكنك استعمال <span class="vocab-term">اختبار الخط الرأسي</span> للتحقق مما إذا كان التمثيل البياني يمثل دالة أم لا. فإذا قطع الخط الرأسي التمثيل البياني في أكثر من نقطة، فإن العلاقة لا تمثل دالة.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mt-6">
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">مثال (أ)</h4>
                                <canvas id="vlt-canvas-1" class="w-full h-40 bg-white border rounded-lg"></canvas>
                                <p id="vlt-status-1" class="text-sm mt-2 font-semibold"></p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">مثال (ب)</h4>
                                <canvas id="vlt-canvas-2" class="w-full h-40 bg-white border rounded-lg"></canvas>
                                <p id="vlt-status-2" class="text-sm mt-2 font-semibold"></p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">مثال (ج)</h4>
                                <canvas id="vlt-canvas-3" class="w-full h-40 bg-white border rounded-lg"></canvas>
                                <p id="vlt-status-3" class="text-sm mt-2 font-semibold"></p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 خامساً: الدوال المتصلة والمنفصلة</h2>
                    <div class="p-6 bg-gray-50 rounded-lg space-y-4">
                        <p>تُسمى الدالة التي تُمثَّل بيانيًا بنقاط غير متصلة <span class="vocab-term">دالة منفصلة</span>.</p>
                        <p>أما الدالة التي تُمثَّل بخط أو منحنى دون انقطاع فتُسمى <span class="vocab-term">دالة متصلة</span>.</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mt-6">
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">دالة متصلة</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg"><path d="M -4 3 L 0 -3 L 4 3" stroke="#3b82f6" stroke-width="0.3" fill="none"/></svg>
                                <p class="text-xs mt-2 text-gray-600">الرسم عبارة عن خطوط متصلة.</p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">دالة منفصلة</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg">
                                    <circle cx="-3" cy="1" r="0.3" fill="#3b82f6" />
                                    <circle cx="-1" cy="-2" r="0.3" fill="#3b82f6" />
                                    <circle cx="1.5" cy="2" r="0.3" fill="#3b82f6" />
                                    <circle cx="4" cy="-1" r="0.3" fill="#3b82f6" />
                                </svg>
                                <p class="text-xs mt-2 text-gray-600">الرسم عبارة عن نقاط منفصلة.</p>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">دالة متصلة</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg"><path d="M -4 -2 Q 0 4 4 -2" stroke="#3b82f6" stroke-width="0.3" fill="none"/></svg>
                                <p class="text-xs mt-2 text-gray-600">الرسم عبارة عن منحنى متصل.</p>
                            </div>
                             <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">دالة غير متصلة</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg">
                                    <path d="M -4 -1 Q -1 3 0.5 3" stroke="#3b82f6" stroke-width="0.3" fill="none"/>
                                    <path d="M 1.5 3 Q 3 3 4 -1" stroke="#3b82f6" stroke-width="0.3" fill="none"/>
                                    <circle cx="1" cy="3" r="0.3" fill="white" stroke="#3b82f6" stroke-width="0.2" />
                                </svg>
                                <p class="text-xs mt-2 text-gray-600">منحنى به انقطاع (فجوة) في المنتصف.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">✍️ سادساً: حان دورك! اختبر فهمك</h2>
                        <div id="attempts-counter" class="text-sm font-bold text-gray-600"></div>
                    </div>
                    <form id="quizForm" class="p-6 bg-gray-50 rounded-lg space-y-8"></form>
                    <div id="quiz-results" class="hidden mt-6 p-4 rounded-lg text-center">
                        <h3 class="text-xl font-bold">نتيجتك النهائية</h3>
                        <p id="quiz-score" class="text-4xl font-bold my-2"></p>
                        <div id="save-status" class="mt-4 text-sm font-semibold"></div>
                        <button id="retake-quiz-btn" class="hidden mt-4 bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700">إعادة الاختبار</button>
                    </div>
                </section>
            </div>
        </main>
        <footer id="main-footer" class="bg-gray-200 py-4"></footer>
    </div>
    <div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">💡 شرح الإجابة</h3>
                <button id="closeModalBtn" class="p-2 -m-2 rounded-full hover:bg-gray-200">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="explanationText" class="text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    <script>
    // --- دوال مشتركة ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
    const MAX_ATTEMPTS = 3;
    let currentQuestions = []; 
    function getStudentFromStorage() { const studentDataString = localStorage.getItem('currentStudent'); if (studentDataString) { try { return JSON.parse(studentDataString); } catch (e) { return null; } } return null; }
    function buildHeader(studentData, lessonTitle = null) { const headerContainer = document.getElementById('main-header'); if (!headerContainer) return; let titleHtml; if (lessonTitle) { titleHtml = `<div><h2 class="text-sm text-gray-500 leading-tight">منصة الرياضيات التفاعلية</h2><h1 class="text-xl font-bold text-indigo-700 leading-tight">${lessonTitle}</h1></div>`; } else { titleHtml = `<a href="../index.html" target="_top"><h1 class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</h1></a>`; } let userInfoHtml = ''; if (studentData) { userInfoHtml = `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name}</span><a href="../index.html" target="_top" id="logout-link" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600">خروج</a></div>`; } else { userInfoHtml = `<p class="text-lg text-gray-600">زائر</p>`; } headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center">${titleHtml}${userInfoHtml}</div>`; const logoutLink = headerContainer.querySelector('#logout-link'); if(logoutLink) { logoutLink.addEventListener('click', () => { localStorage.removeItem('currentStudent'); }); } }
    function buildFooter() { const footerContainer = document.getElementById('main-footer'); if (!footerContainer) return; footerContainer.innerHTML = `<div class="container mx-auto px-6"><p class="text-center text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تصميم وتطوير: أ. عبدالعزيز خالد العبلان</p></div>`; }
    function initializeQuiz(lessonId, questions, studentData) { currentQuestions = questions; const quizForm = document.getElementById('quizForm'); if (!quizForm) return; if (questions.length === 0) { quizForm.innerHTML = `<p class="text-center text-gray-600">لا توجد أسئلة متاحة لهذا الدرس حالياً.</p>`; return; } let attemptsLeft; if (studentData) { const studentLessonData = studentData.lessons?.[lessonId] || { attempts: 0 }; attemptsLeft = MAX_ATTEMPTS - studentLessonData.attempts; } else { attemptsLeft = 1; } const attemptsCounter = document.getElementById('attempts-counter'); if (attemptsCounter) { attemptsCounter.innerHTML = `المحاولات المتبقية: <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${attemptsLeft}</span>`; } const quizHtml = questions.map((q, index) => { const optionsHTML = q.options.map((opt, optIndex) => `<div><input type="radio" name="q${index}" value="${opt.value}" id="q${index}_opt${optIndex}" class="hidden"><label for="q${index}_opt${optIndex}" class="option-label">${opt.display}</label></div>`).join(''); const smartExplanationButton = q.smartExplanation ? `<button type="button" data-question-index="${index}" class="smart-explain-btn hidden mt-2 text-xs text-purple-600 font-bold hover:underline">الحل الذكي 🧠</button>` : ''; return `<div class="p-4 border-2 border-gray-200 rounded-lg bg-white"><p class="font-bold text-lg">${index + 1}. <span class="text-yellow-500">${q.level}</span> ${q.text}</p>${q.graph || ''}<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">${optionsHTML}</div><div id="feedback-q${index}" class="mt-2 text-sm font-bold"></div><div class="flex items-center space-x-4">${smartExplanationButton}<button type="button" data-question-index="${index}" class="explain-btn hidden mt-2 text-xs text-blue-600 hover:underline">اعرف لماذا؟</button></div></div>`; }).join(''); quizForm.innerHTML = quizHtml + `<button type="submit" id="submit-quiz-btn" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-5 py-3 mt-8">تحقق من إجاباتي</button>`; if (attemptsLeft <= 0) { const submitBtn = quizForm.querySelector('#submit-quiz-btn'); submitBtn.disabled = true; submitBtn.textContent = 'لا توجد محاولات متبقية'; submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400'); } quizForm.onsubmit = (e) => { e.preventDefault(); let score = 0; questions.forEach((q, index) => { const userAnswer = e.target.elements[`q${index}`]?.value; const feedbackEl = document.getElementById(`feedback-q${index}`); if (userAnswer === q.correct) { score++; feedbackEl.textContent = '✔ إجابة صحيحة!'; feedbackEl.className = 'mt-2 text-sm font-bold text-green-600'; } else { feedbackEl.textContent = `❌ إجابة خاطئة.`; feedbackEl.className = 'mt-2 text-sm font-bold text-red-600'; } quizForm.querySelector(`[data-question-index="${index}"].explain-btn`).classList.remove('hidden'); const smartBtn = quizForm.querySelector(`[data-question-index="${index}"].smart-explain-btn`); if(smartBtn) smartBtn.classList.remove('hidden'); }); const finalGrade = Math.round((score / questions.length) * 10); const resultsDiv = document.getElementById('quiz-results'); resultsDiv.classList.remove('hidden'); document.getElementById('quiz-score').textContent = `${finalGrade} / 10`; if (studentData) { saveGrade(lessonId, finalGrade, studentData.id); if (attemptsLeft - 1 > 0) { document.getElementById('retake-quiz-btn').classList.remove('hidden'); } } else { document.getElementById('save-status').textContent = 'تم عرض نتيجتك. سجل الدخول لحفظ تقدمك.'; } e.target.querySelector('#submit-quiz-btn').disabled = true; }; }
    function saveGrade(lessonId, grade, studentId) { if (!studentId) return; const saveStatus = document.getElementById('save-status'); saveStatus.textContent = 'جارٍ حفظ نتيجتك...'; const url = `${SCRIPT_URL}?action=saveGrade&studentId=${studentId}&lessonId=${lessonId}&grade=${grade}`; fetch(url) .then(res => res.json()) .then(result => { if (result.status === 'success') { saveStatus.textContent = '✔ تم حفظ نتيجتك بنجاح! ستظهر في لوحة التحكم عند العودة.'; const studentData = JSON.parse(localStorage.getItem('currentStudent')); if (!studentData.lessons) studentData.lessons = {}; if (!studentData.lessons[lessonId] || studentData.lessons[lessonId].grade < grade) { studentData.lessons[lessonId] = { grade: grade, attempts: (studentData.lessons[lessonId]?.attempts || 0) + 1 }; } else { studentData.lessons[lessonId].attempts++; } localStorage.setItem('currentStudent', JSON.stringify(studentData)); } else { throw new Error(result.message); } }) .catch(error => { saveStatus.textContent = '❌ حدث خطأ أثناء حفظ الدرجة.'; console.error("Save Grade Error:", error); }); }
    function showExplanation(questionIndex, type = 'regular') { const modal = document.getElementById('explanationModal'); const modalTitle = document.getElementById('modal-title'); const explanationText = document.getElementById('explanationText'); const question = currentQuestions[questionIndex]; if(modal && explanationText && modalTitle && question) { if (type === 'smart' && question.smartExplanation) { modalTitle.textContent = '🧠 الحل الذكي'; explanationText.innerHTML = question.smartExplanation; } else { modalTitle.textContent = '💡 شرح الإجابة'; explanationText.innerHTML = question.explanation; } modal.classList.remove('hidden'); } }
    function closeModal() { const modal = document.getElementById('explanationModal'); if(modal) modal.classList.add('hidden'); }
    
    // --- مشغل الكود الخاص بالدرس ---
    const LESSON_ID = 'c2_l2'; 
    function generateQuiz() {
        const questionBank = [
             { type: 'mcq', level: '⭐⭐', topic: 'linear-function', text: 'أي من المعادلات التالية تمثل دالة خطية؟', 
                options: [ 
                    { display: '<span class="math-eq">ص = ٥س - ٢</span>', value: 'A' },
                    { display: '<span class="math-eq">ص = س<sup>٢</sup></span>', value: 'B' },
                    { display: '<span class="math-eq">ص = |س|</span>', value: 'C' },
                    { display: '<span class="math-eq">ص = <span class="fraction"><span>١</span><span class="frac-bar"></span><span>س</span></span></span>', value: 'D' }
                ], 
                correct: 'A', 
                explanation: `<p class='mb-2'>الدالة الخطية هي التي يكون فيها المتغير 'س' مرفوعاً للأس ١ (أو ٠). المعادلة <span class='math-eq'>ص = ٥س - ٢</span> هي دالة خطية. أما الخيارات الأخرى (<span class='math-eq'>ص = س<sup>٢</sup></span>، <span class='math-eq'>ص = |س|</span>، و <span class='math-eq'>ص = <span class="fraction"><span>١</span><span class="frac-bar"></span><span>س</span></span></span>) فليست خطية.</p>`,
                smartExplanation: `<p>ببساطة، الدالة الخطية لا تحتوي على أسس (مثل س<sup>٢</sup>) أو رموز خاصة (مثل |س|) أو متغير في المقام. الخيار (أ) هو الوحيد الذي يحقق هذا الشرط.</p>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'linear-function', text: 'أي من المعادلات التالية <strong>لا</strong> تمثل دالة خطية؟', 
                options: [ { display: '<span class="math-eq">ص = س + ٧</span>', value: 'A' }, { display: '<span class="math-eq">ص = س<sup>٣</sup> + ١</span>', value: 'B' }, { display: '<span class="math-eq">ص = ٣س</span>', value: 'C' }, { display: '<span class="math-eq">ص = ١٠</span>', value: 'D' } ], 
                correct: 'B', 
                explanation: `<p class='mb-2'>الدالة <span class='math-eq'>ص = س<sup>٣</sup> + ١</span> ليست خطية لأن المتغير 'س' مرفوع للأس ٣ (دالة تكعيبية). باقي الخيارات تمثل دوالاً خطية.</p>`,
                smartExplanation: `<p>ابحث عن المعادلة التي تحتوي على أس أعلى من ١. الخيار (ب) يحتوي على س<sup>٣</sup>، إذن هي ليست دالة خطية.</p>`
             },
             { type: 'mcq', level: '⭐', topic: 'is-function', text: 'هل العلاقة <span class="math-eq">{ (٥، ٣)، (٧، ٢)، (٥، ١) }</span> تمثل دالة؟', 
                options: [ { display: 'نعم', value: 'نعم' }, { display: 'لا', value: 'لا' } ], 
                correct: 'لا', 
                explanation: `<p class='mb-2'>لا، لأن العنصر <span class="math-eq">٥</span> في المجال ارتبط بعنصرين مختلفين في المدى (<span class="math-eq">٣</span> و <span class="math-eq">١</span>).</p>`,
                smartExplanation: `<p>بمجرد النظر، نلاحظ تكرار الرقم ٥ في الإحداثي الأول (السيني) مع إحداثي ثانٍ (صادي) مختلف. إذن هي ليست دالة.</p>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'vertical-line-test', text: 'أي من التمثيلات البيانية التالية لا يمثل دالة؟', 
                graph: `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mt-6">
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">الخيار (أ)</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg"><path d="M -4 4 Q 0 -4 4 4" stroke="#3b82f6" stroke-width="0.3" fill="none"/></svg>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">الخيار (ب)</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg"><path d="M 4 4 L -2 0 L 4 -4" stroke="#3b82f6" stroke-width="0.3" fill="none"/></svg>
                            </div>
                            <div class="p-2 bg-white rounded-lg shadow">
                                <h4 class="font-semibold mb-2">الخيار (ج)</h4>
                                <svg viewBox="-5 -5 10 10" class="w-full h-32 bg-white border rounded-lg"><line x1="-4" y1="-2" x2="0" y2="-2" stroke="#3b82f6" stroke-width="0.3"/><circle cx="0" cy="-2" r="0.3" fill="white" stroke="#3b82f6" stroke-width="0.2" /><line x1="0" y1="2" x2="4" y2="2" stroke="#3b82f6" stroke-width="0.3"/><circle cx="0" cy="2" r="0.3" fill="#3b82f6" /></svg>
                            </div>
                        </div>`,
                options: [ { display: 'أ', value: 'A' }, { display: 'ب', value: 'B' }, { display: 'ج', value: 'C' } ], 
                correct: 'B', 
                explanation: `<p class='mb-2'>الخيار (ب) هو الذي لا يمثل دالة. عند تطبيق اختبار الخط الرأسي، نجد أن الخط الرأسي يمكن أن يقطع التمثيل البياني في أكثر من نقطة واحدة، مما يعني أن هناك قيمة لـ 'س' ترتبط بأكثر من قيمة لـ 'ص'.</p>`
             },
             { type: 'mcq', level: '⭐⭐⭐', topic: 'function-value', text: 'إذا كانت <span class="math-eq">د(س) = ٢س - ٨</span>، فما قيمة <span class="math-eq">د(٦)</span>؟', 
                options: [ { display: '<span class="math-eq">٤</span>', value: '٤' }, { display: '<span class="math-eq">١٢</span>', value: '١٢' }, { display: '<span class="math-eq">-٤</span>', value: '-٤' }, { display: '<span class="math-eq">٢٠</span>', value: '٢٠' } ], 
                correct: '٤', 
                explanation: `<p class='mb-2'>لإيجاد قيمة د(٦)، نعوض عن كل <span class="math-eq">س</span> بالرقم <span class="math-eq">٦</span> في المعادلة.</p><div class='text-right space-y-2 p-2 bg-gray-100 rounded-md'><p>المعادلة: <span class='math-eq'>د(س) = ٢س - ٨</span></p><p>التعويض: <span class='math-eq'>د(٦) = ٢(٦) - ٨</span></p><p>الضرب: <span class='math-eq'>د(٦) = ١٢ - ٨</span></p><p>الناتج: <span class='math-eq'>د(٦) = ٤</span></p></div>`,
                smartExplanation: `<p>ذهنياً: ٢ ضرب ٦ يساوي ١٢، ثم ١٢ ناقص ٨ يساوي ٤.</p>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'is-function', text: 'أي الجداول التالية يمثل دالة؟', 
                options: [ { display: '<table class="w-full text-center border"><thead><tr><th class="border p-1">س</th><th class="border p-1">ص</th></tr></thead><tbody><tr><td class="border p-1">١</td><td class="border p-1">٣</td></tr><tr><td class="border p-1">٢</td><td class="border p-1">٤</td></tr><tr><td class="border p-1">١</td><td class="border p-1">٥</td></tr></tbody></table>', value: 'A' }, { display: '<table class="w-full text-center border"><thead><tr><th class="border p-1">س</th><th class="border p-1">ص</th></tr></thead><tbody><tr><td class="border p-1">-١</td><td class="border p-1">٥</td></tr><tr><td class="border p-1">٠</td><td class="border p-1">٥</td></tr><tr><td class="border p-1">١</td><td class="border p-1">٥</td></tr></tbody></table>', value: 'B' } ], 
                correct: 'B', 
                explanation: `<p class='mb-2'>الجدول (ب) يمثل دالة لأن كل قيمة لـ س (المجال) لها قيمة واحدة فقط لـ ص (المدى). أما في الجدول (أ)، القيمة ١ في المجال ارتبطت بقيمتين مختلفتين (٣ و ٥).</p>`,
                smartExplanation: `<p>ابحث عن تكرار في عمود 'س'. الجدول (أ) يكرر الرقم ١، إذن هو ليس دالة. الجدول (ب) لا يكرر أي رقم في عمود 'س'، إذن هو دالة.</p>`
             },
             { type: 'mcq', level: '⭐', topic: 'domain-range', text: 'ما هو مدى الدالة <span class="math-eq">{ (٠, ١), (١, ٢), (٢, ٣) }</span>؟',
                 options: [ 
                     { display: '<span class="math-eq">{٠, ١, ٢}</span>', value: 'A' }, 
                     { display: '<span class="math-eq">{١, ٢, ٣}</span>', value: 'B' },
                     { display: '<span class="math-eq">{٠, ٣}</span>', value: 'C' },
                     { display: '<span class="math-eq">{٠, ١, ٢, ٣}</span>', value: 'D' }
                 ],
                 correct: 'B',
                 explanation: `<p class='mb-2'>المدى هو مجموعة كل الإحداثيات الثانية (قيم ص) في الأزواج المرتبة. في هذه الحالة، قيم ص هي ١، ٢، و ٣. لذلك، المدى هو {١, ٢, ٣}. الخيار {٠, ١, ٢} يمثل المجال.</p>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'domain-graph', text: 'من خلال الرسم البياني التالي، ما هو مجال الدالة؟',
                options: [ { display: '<span class="math-eq">[-٣, ٤]</span>', value: 'A' }, { display: '<span class="math-eq">[-٢, ٣]</span>', value: 'B' }, { display: 'كل الأعداد الحقيقية', value: 'C' }, { display: '<span class="math-eq">[-٢, ٤]</span>', value: 'D' } ],
                correct: 'A',
                explanation: `<p class='mb-2'>المجال هو مجموعة كل قيم 'س' الممكنة التي يغطيها الرسم البياني. نلاحظ أن الخط يبدأ من <span class='math-eq'>س = -٣</span> (نقطة مغلقة) وينتهي عند <span class='math-eq'>س = ٤</span> (نقطة مغلقة). لذلك، المجال هو الفترة المغلقة من -٣ إلى ٤، والتي تكتب على الصورة <span class='math-eq'>[-٣, ٤]</span>.</p>`,
                graph: `<svg viewBox="-5 -5 10 10" class="w-full h-40 bg-white border rounded-lg mt-2">
                                <!-- Grid lines -->
                                <line x1="-5" y1="-4" x2="5" y2="-4" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="-3" x2="5" y2="-3" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="-2" x2="5" y2="-2" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="-1" x2="5" y2="-1" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="1" x2="5" y2="1" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="2" x2="5" y2="2" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="3" x2="5" y2="3" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-5" y1="4" x2="5" y2="4" stroke="#e5e7eb" stroke-width="0.1" />
                                <line x1="-4" y1="-5" x2="-4" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-3" y1="-5" x2="-3" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-2" y1="-5" x2="-2" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="-1" y1="-5" x2="-1" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="1" y1="-5" x2="1" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="2" y1="-5" x2="2" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="3" y1="-5" x2="3" y2="5" stroke="#e5e7eb" stroke-width="0.1" /><line x1="4" y1="-5" x2="4" y2="5" stroke="#e5e7eb" stroke-width="0.1" />
                                <!-- Axes -->
                                <line x1="-5" y1="0" x2="5" y2="0" stroke="#9ca3af" stroke-width="0.2"/><line x1="0" y1="-5" x2="0" y2="5" stroke="#9ca3af" stroke-width="0.2"/>
                                <text x="4.5" y="-0.5" font-size="0.8" fill="#9ca3af">س</text><text x="0.5" y="-4.5" font-size="0.8" fill="#9ca3af">ص</text>
                                <!-- Function line -->
                                <line x1="-3" y1="-2" x2="4" y2="3" stroke="#3b82f6" stroke-width="0.4"/><circle cx="-3" cy="-2" r="0.3" fill="#3b82f6" /><circle cx="4" cy="3" r="0.3" fill="#3b82f6" />
                              </svg>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'arrow-diagram', text: 'هل المخطط السهمي التالي يمثل دالة؟',
                options: [ { display: 'نعم', value: 'نعم' }, { display: 'لا', value: 'لا' } ],
                correct: 'نعم',
                explanation: `<p class='mb-2'>نعم، هذه العلاقة تمثل دالة. الشرط الأساسي للدالة هو أن كل عنصر في <strong>المجال</strong> يجب أن يخرج منه سهم <strong>واحد فقط</strong>. في هذا المثال، كل عنصر من عناصر المجال (أ، ب، ج) يخرج منه سهم واحد بالضبط، وهذا يحقق شرط الدالة. لا يهم أن عنصرين من المجال (أ و ب) يشيران إلى نفس العنصر في المدى.</p>`,
                graph: `<svg viewBox="0 0 120 100" class="w-full h-40 bg-white border rounded-lg mt-2"><defs><marker id="q-arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs>
                                <rect x="75" y="5" width="40" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="95" y="20" font-size="9" font-weight="bold" text-anchor="middle">المجال</text>
                                <text x="95" y="40" font-size="9" text-anchor="middle">أ</text><text x="95" y="60" font-size="9" text-anchor="middle">ب</text><text x="95" y="80" font-size="9" text-anchor="middle">ج</text>
                                <rect x="5" y="15" width="40" height="70" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="25" y="30" font-size="9" font-weight="bold" text-anchor="middle">المدى</text>
                                <text x="25" y="50" font-size="9" text-anchor="middle">١</text><text x="25" y="70" font-size="9" text-anchor="middle">٢</text>
                                <path d="M 75 40 Q 60 45 45 50" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#q-arrow)" />
                                <path d="M 75 60 Q 60 55 45 50" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#q-arrow)" />
                                <path d="M 75 80 Q 60 75 45 70" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#q-arrow)" />
                              </svg>`
             },
             { type: 'mcq', level: '⭐⭐', topic: 'arrow-diagram', text: 'هل المخطط السهمي التالي يمثل دالة؟',
                options: [ { display: 'نعم', value: 'نعم' }, { display: 'لا', value: 'لا' } ],
                correct: 'لا',
                explanation: `<p class='mb-2'>لا، هذه العلاقة <strong>ليست دالة</strong>. السبب هو أن العنصر <strong class="text-red-600">'س'</strong> في المجال قد خرج منه سهمان، أحدهما يشير إلى '١٠' والآخر إلى '٢٠' في المدى. هذا يخالف الشرط الأساسي للدالة الذي ينص على أن كل عنصر في المجال يجب أن يرتبط بعنصر <strong>واحد فقط</strong> في المدى.</p>`,
                graph: `<svg viewBox="0 0 120 100" class="w-full h-40 bg-white border rounded-lg mt-2"><defs><marker id="q-arrow2" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker></defs>
                                <rect x="75" y="5" width="40" height="90" rx="5" stroke="#60a5fa" fill="#eff6ff" /><text x="95" y="20" font-size="9" font-weight="bold" text-anchor="middle">المجال</text>
                                <text x="95" y="40" font-size="9" text-anchor="middle">س</text><text x="95" y="60" font-size="9" text-anchor="middle">ص</text><text x="95" y="80" font-size="9" text-anchor="middle">ع</text>
                                <rect x="5" y="5" width="40" height="90" rx="5" stroke="#34d399" fill="#f0fdf4" /><text x="25" y="20" font-size="9" font-weight="bold" text-anchor="middle">المدى</text>
                                <text x="25" y="40" font-size="9" text-anchor="middle">١٠</text><text x="25" y="60" font-size="9" text-anchor="middle">٢٠</text><text x="25" y="80" font-size="9" text-anchor="middle">٣٠</text>
                                <path d="M 75 40 Q 60 40 45 40" stroke="#ef4444" stroke-width="0.5" fill="none" marker-end="url(#q-arrow2)" />
                                <path d="M 75 40 Q 60 50 45 60" stroke="#ef4444" stroke-width="0.5" fill="none" marker-end="url(#q-arrow2)" />
                                <path d="M 75 60 Q 60 70 45 80" stroke="#3b82f6" stroke-width="0.5" fill="none" marker-end="url(#q-arrow2)" />
                              </svg>`
             },
             { type: 'mcq', level: '⭐⭐⭐', topic: 'real-life', text: "إذا كانت تكلفة استئجار سيارة تُحسب بالمعادلة <span class='math-eq'>ت(ي) = ٩٠ي + ٥٠</span>، حيث <span class='math-eq'>ت</span> هي التكلفة الإجمالية بالريال و <span class='math-eq'>ي</span> هو عدد الأيام. ما هي تكلفة استئجار السيارة لمدة ٣ أيام؟",
                options: [ { display: '٣٢٠ ريال', value: '320' }, { display: '٢٧٠ ريال', value: '270' }, { display: '١٤٠ ريال', value: '140' }, { display: '٣٦٠ ريال', value: '360' } ],
                correct: '320',
                explanation: `<p class='mb-2'>لإيجاد التكلفة، نعوض عن عدد الأيام (ي) بالرقم ٣ في المعادلة: <span class='math-eq'>ت(٣) = ٩٠(٣) + ٥٠</span>. أولاً، نضرب ٩٠ في ٣ لنحصل على ٢٧٠. ثم نضيف ٥٠. <span class='math-eq'>٢٧٠ + ٥٠ = ٣٢٠</span>. إذن، التكلفة هي ٣٢٠ ريال.</p>`,
                smartExplanation: `<p>ذهنياً: تكلفة ٣ أيام هي (٣ × ٩٠) = ٢٧٠، زائد الرسوم الثابتة ٥٠، المجموع ٣٢٠.</p>`
             },
             { type: 'mcq', level: '⭐⭐⭐', topic: 'real-life', text: "تستخدم الدالة <span class='math-eq'>ف(س) = ١.٨س + ٣٢</span> لتحويل درجة الحرارة من مئوية (س) إلى فهرنهايت (ف). إذا كانت درجة الحرارة ٢٠ درجة مئوية، فكم تكون بالفهرنهايت؟",
                options: [ { display: '٦٨° ف', value: '68' }, { display: '٥٢° ف', value: '52' }, { display: '٣٦° ف', value: '36' }, { display: '٧٢° ف', value: '72' } ],
                correct: '68',
                explanation: `<p class='mb-2'>نعوض عن درجة الحرارة المئوية (س) بالرقم ٢٠: <span class='math-eq'>ف(٢٠) = ١.٨(٢٠) + ٣٢</span>. نضرب ١.٨ في ٢٠ لنحصل على ٣٦. ثم نضيف ٣٢. <span class='math-eq'>٣٦ + ٣٢ = ٦٨</span>. إذن، درجة الحرارة هي ٦٨° فهرنهايت.</p>`,
                smartExplanation: `<p>ذهنياً: ١.٨ ضرب ٢٠ هو نفسه ١٨ ضرب ٢ = ٣٦. ثم ٣٦ زائد ٣٢ يساوي ٦٨.</p>`
             }
        ];
        const shuffled = [...questionBank].sort(() => 0.5 - Math.random());
        const questionCount = Math.min(shuffled.length, 5);
        return shuffled.slice(0, questionCount);
    }
    document.addEventListener('DOMContentLoaded', () => {
        const student = getStudentFromStorage();
        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonTitle = lessonTitleElement ? lessonTitleElement.textContent : null;
        buildHeader(student, lessonTitle);
        buildFooter();
        const questions = generateQuiz();
        initializeQuiz(LESSON_ID, questions, student);
        
        // --- Interactive Examples Logic ---
        const exampleContainers = document.querySelectorAll('[id^="interactive-container-"]');
        exampleContainers.forEach(container => {
            const exampleId = container.id.split('-')[2];
            if (exampleId === '1') {
                // Logic for Arrow Diagrams (Horizontal)
                const state = {
                    currentIndex: -1,
                    prevBtn: container.querySelector('.prev-btn'),
                    nextBtn: container.querySelector('.next-btn'),
                    resetBtn: container.querySelector('.reset-btn'),
                    diagrams: container.querySelectorAll('.example-diagram'),
                    placeholder: container.querySelector('.interactive-placeholder')
                };

                const updateButtons = () => {
                    const isFirstStep = state.currentIndex <= -1;
                    const isLastStep = state.currentIndex >= state.diagrams.length - 1;
                    state.prevBtn.disabled = isFirstStep;
                    
                    if (isLastStep) {
                        state.nextBtn.classList.add('hidden');
                        state.resetBtn.classList.remove('hidden');
                    } else {
                        state.nextBtn.classList.remove('hidden');
                        state.resetBtn.classList.add('hidden');
                    }
                };

                const resetExample = () => {
                    state.currentIndex = -1;
                    state.placeholder.classList.add('hidden');
                    state.diagrams.forEach(el => {
                        el.classList.remove('hidden');
                        el.classList.add('dimmed');
                        el.classList.remove('active');
                        
                        const analysis = el.querySelector('[id$="-analysis"]');
                        if (analysis) analysis.classList.add('hidden');

                        if (el.id === 'ex2-col') {
                            const ex2initial = el.querySelector('#ex2-initial');
                            const ex2analysis = el.querySelector('#ex2-analysis');
                            if (ex2initial) ex2initial.classList.remove('hidden');
                            if (ex2analysis) ex2analysis.classList.add('hidden');
                        }
                    });
                    updateButtons();
                };

                state.nextBtn.addEventListener('click', () => {
                    if (state.currentIndex < state.diagrams.length - 1) {
                        state.currentIndex++;
                        const currentDiagram = state.diagrams[state.currentIndex];
                        currentDiagram.classList.remove('dimmed');
                        currentDiagram.classList.add('active');
                        
                        const analysis = currentDiagram.querySelector('[id$="-analysis"]');
                        if (analysis) analysis.classList.remove('hidden');

                        if (currentDiagram.id === 'ex2-col') {
                            const ex2initial = currentDiagram.querySelector('#ex2-initial');
                            if (ex2initial) ex2initial.classList.add('hidden');
                        }
                        updateButtons();
                    }
                });

                state.prevBtn.addEventListener('click', () => {
                    if (state.currentIndex > -1) {
                        const currentDiagram = state.diagrams[state.currentIndex];
                        currentDiagram.classList.add('dimmed');
                        currentDiagram.classList.remove('active');

                        const analysis = currentDiagram.querySelector('[id$="-analysis"]');
                        if (analysis) analysis.classList.add('hidden');
                        
                        if (currentDiagram.id === 'ex2-col') {
                            const ex2initial = currentDiagram.querySelector('#ex2-initial');
                            if (ex2initial) ex2initial.classList.remove('hidden');
                        }

                        state.currentIndex--;
                        updateButtons();
                    }
                });

                state.resetBtn.addEventListener('click', resetExample);
                
                resetExample();

            } else if (exampleId === '3') {
                 // Logic for Example 3 (Additive steps)
                const state = { 
                    currentIndex: -1, 
                    steps: container.querySelectorAll('.step-interactive'), 
                    problemStatement: container.querySelector('.problem-statement'),
                    prevBtn: container.querySelector('.prev-btn'), 
                    nextBtn: container.querySelector('.next-btn'), 
                    resetBtn: container.querySelector('.reset-btn') 
                };

                const updateButtons = () => {
                    if (!state.nextBtn) return;
                    const isFirstStep = state.currentIndex <= -1;
                    const isLastStep = state.currentIndex >= state.steps.length - 1;
                    state.prevBtn.disabled = isFirstStep;
                    
                    if (isLastStep) {
                        state.nextBtn.classList.add('hidden');
                        state.resetBtn.classList.remove('hidden');
                    } else {
                        state.nextBtn.classList.remove('hidden');
                        state.resetBtn.classList.add('hidden');
                    }
                };

                const updateView = () => {
                    const inProgress = state.currentIndex !== -1;
                    if (state.problemStatement) {
                        state.problemStatement.classList.toggle('hidden', inProgress);
                    }
                    
                    state.steps.forEach((step, index) => {
                        if (index <= state.currentIndex) {
                            step.classList.add('active');
                        } else {
                            step.classList.remove('active');
                        }
                    });
                    updateButtons();
                };
                
                const resetExample = () => {
                    state.currentIndex = -1;
                    updateView();
                };

                state.nextBtn.addEventListener('click', () => {
                    if (state.currentIndex < state.steps.length - 1) {
                        state.currentIndex++;
                        updateView();
                    }
                });

                state.prevBtn.addEventListener('click', () => {
                    if (state.currentIndex > -1) {
                        state.currentIndex--;
                        updateView();
                    }
                });

                if (state.resetBtn) {
                    state.resetBtn.addEventListener('click', resetExample);
                }

                resetExample();
            } else {
                // Logic for Example 2 and other vertical examples (Replacement)
                const state = { 
                    currentIndex: -1, 
                    steps: container.querySelectorAll('.step-interactive'), 
                    problemStatement: container.querySelector('.problem-statement'),
                    prevBtn: container.querySelector('.prev-btn'), 
                    nextBtn: container.querySelector('.next-btn'), 
                    resetBtn: container.querySelector('.reset-btn') 
                };

                const updateButtons = () => {
                    if (!state.nextBtn) return;
                    const isFirstStep = state.currentIndex <= -1;
                    const isLastStep = state.currentIndex >= state.steps.length - 1;
                    state.prevBtn.disabled = isFirstStep;

                    if (isLastStep) {
                        state.nextBtn.classList.add('hidden');
                        state.resetBtn.classList.remove('hidden');
                    } else {
                        state.nextBtn.classList.remove('hidden');
                        state.resetBtn.classList.add('hidden');
                    }
                };
                
                const updateView = () => {
                    const inProgress = state.currentIndex !== -1;
                    if (state.problemStatement) {
                        state.problemStatement.classList.toggle('hidden', inProgress);
                    }

                    state.steps.forEach((step, index) => {
                        step.classList.toggle('active', index === state.currentIndex);
                    });
                    updateButtons();
                };

                const resetExample = () => {
                    state.currentIndex = -1;
                    updateView();
                };

                state.nextBtn.addEventListener('click', () => {
                    if (state.currentIndex < state.steps.length - 1) {
                        state.currentIndex++;
                        updateView();
                    }
                });

                state.prevBtn.addEventListener('click', () => {
                    if (state.currentIndex > -1) {
                        state.currentIndex--;
                        updateView();
                    }
                });

                if (state.resetBtn) {
                    state.resetBtn.addEventListener('click', resetExample);
                }
                
                resetExample();
            }
        });
        
        // --- Vertical Line Test Canvas Logic ---
        const vltCanvases = [
            { id: 'vlt-canvas-1', statusId: 'vlt-status-1', type: 'parabola' },
            { id: 'vlt-canvas-2', statusId: 'vlt-status-2', type: 'sideways-parabola' },
            { id: 'vlt-canvas-3', statusId: 'vlt-status-3', type: 'step' }
        ];

        vltCanvases.forEach(vlt => {
            const canvas = document.getElementById(vlt.id);
            const statusEl = document.getElementById(vlt.statusId);
            if (!canvas || !statusEl) return;
            const ctx = canvas.getContext('2d');
            let lineX = 0;
            let direction = 1;
            let animationFrameId = null;

            function draw() {
                const width = canvas.width;
                const height = canvas.height;
                const midX = width / 2;
                const midY = height / 2;
                const scale = 20;

                ctx.clearRect(0, 0, width, height);

                // Draw axes
                ctx.beginPath();
                ctx.moveTo(0, midY);
                ctx.lineTo(width, midY);
                ctx.moveTo(midX, 0);
                ctx.lineTo(midX, height);
                ctx.strokeStyle = '#cbd5e1';
                ctx.stroke();
                
                // Draw function graph
                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;

                if (vlt.type === 'parabola') {
                    for (let i = 0; i < width; i++) {
                        const x = (i - midX) / scale;
                        const y = -(0.25 * x * x - 2) * scale + midY;
                        if (i === 0) ctx.moveTo(i, y); else ctx.lineTo(i, y);
                    }
                } else if (vlt.type === 'sideways-parabola') {
                    for (let i = 0; i < height; i++) {
                        const y = (i - midY) / scale;
                        const x = (-0.5 * y * y + 3) * scale + midX;
                        if (i === 0) ctx.moveTo(x, i); else ctx.lineTo(x, i);
                    }
                } else if (vlt.type === 'step') {
                    ctx.moveTo(0, midY + 2 * scale);
                    ctx.lineTo(midX, midY + 2 * scale);
                    ctx.moveTo(midX, midY - 2 * scale);
                    ctx.lineTo(width, midY - 2 * scale);
                }
                ctx.stroke();

                if (vlt.type === 'step') {
                    ctx.beginPath();
                    ctx.arc(midX, midY - 2 * scale, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(midX, midY + 2 * scale, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = '#3b82f6';
                    ctx.fill();
                }

                // Draw vertical line
                ctx.beginPath();
                ctx.moveTo(lineX, 0);
                ctx.lineTo(lineX, height);
                ctx.strokeStyle = 'rgba(220, 38, 38, 0.7)';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);

                // Check intersections
                let intersections = [];
                const xVal = (lineX - midX) / scale;

                if (vlt.type === 'parabola') {
                    const y = -(0.25 * xVal * xVal - 2) * scale + midY;
                    intersections.push({ x: lineX, y: y });
                } else if (vlt.type === 'sideways-parabola') {
                    const innerSqrt = 2 * (3 - xVal);
                    if (innerSqrt >= 0) {
                        const y1 = -Math.sqrt(innerSqrt) * scale + midY;
                        const y2 = Math.sqrt(innerSqrt) * scale + midY;
                        intersections.push({ x: lineX, y: y1 });
                        intersections.push({ x: lineX, y: y2 });
                    }
                } else if (vlt.type === 'step') {
                    if (xVal < 0) {
                        intersections.push({ x: lineX, y: midY + 2 * scale });
                    } else {
                        intersections.push({ x: lineX, y: midY - 2 * scale });
                    }
                }
                
                // Draw intersection points and update status
                ctx.fillStyle = '#dc2626';
                intersections.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });

                if (intersections.length > 1) {
                    statusEl.textContent = `نقاط التقاطع: ${intersections.length} (ليست دالة)`;
                    statusEl.className = 'text-sm mt-2 font-semibold text-red-600';
                } else if (intersections.length === 1) {
                    statusEl.textContent = 'نقاط التقاطع: ١ (دالة)';
                    statusEl.className = 'text-sm mt-2 font-semibold text-green-600';
                } else {
                    statusEl.textContent = 'نقاط التقاطع: ٠';
                    statusEl.className = 'text-sm mt-2 font-semibold text-gray-600';
                }

                // Animate line
                lineX += direction * 0.5;
                if (lineX > width || lineX < 0) {
                    direction *= -1;
                }
            }

            function animate() {
                draw();
                animationFrameId = requestAnimationFrame(animate);
            }
            
            function resizeCanvas() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                animate();
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        });

        const retakeBtn = document.getElementById('retake-quiz-btn');
        if(retakeBtn) { retakeBtn.addEventListener('click', () => { window.location.reload(); }); }
        const closeModalBtn = document.getElementById('closeModalBtn');
        if(closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); }
        
        document.querySelector('#quizForm').addEventListener('click', function(event) {
            if (event.target.classList.contains('explain-btn')) {
                const index = event.target.getAttribute('data-question-index');
                showExplanation(index, 'regular');
            }
            if (event.target.classList.contains('smart-explain-btn')) {
                const index = event.target.getAttribute('data-question-index');
                showExplanation(index, 'smart');
            }
        });
    });
    </script>
</body>
</html>

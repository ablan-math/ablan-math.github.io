<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الرياضيات التفاعلية | أ.عبدالعزيز خالد العبلان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f4f8;
        }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-container, #login-view { flex-grow: 1; }
        #login-view { display: flex; align-items: center; justify-content: center; }
        #app-container { display: grid; grid-template-rows: auto 1fr; }

        /* --- Tabbed Card Styles --- */
        .tabbed-card-container {
            background-color: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            overflow: hidden;
        }
        .card-tabs {
            display: flex;
            justify-content: space-between; /* Pushes tabs to edges */
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            flex-grow: 0; /* Removed flex-grow to allow natural width */
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #6b7280;
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-button.active {
            color: #4f46e5;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #4f46e5;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        .card-content .content-view {
            padding: 1.5rem;
        }
        @media (max-width: 768px) {
            .card-content .content-view {
                padding: 1rem;
            }
            .tab-button {
                font-size: 1rem;
                padding: 1rem 0.75rem;
            }
        }

        /* --- Leaderboard Styles --- */
        .leaderboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .leaderboard-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1rem;
        }
        .leaderboard-title {
            font-size: 1.25rem;
            font-weight: 800;
            color: #1e3a8a;
            margin-bottom: 1rem;
            text-align: center;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 0.75rem 0.5rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .leaderboard-table th {
            font-weight: 700;
            color: #4b5563;
        }
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        .leaderboard-table .rank {
            font-weight: 700;
            color: #1d4ed8;
            width: 40px;
            text-align: center;
        }
        .leaderboard-table .score {
            text-align: left;
            line-height: 1.2;
        }
        .leaderboard-table tr.current-student {
            background-color: #eef2ff;
        }
        .current-student-rank-card {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #e0e7ff;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 700;
            color: #312e81;
        }
        .expand-leaderboard-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .expand-leaderboard-btn:hover {
            background-color: #e5e7eb;
        }
        .expand-leaderboard-btn .fas {
            transition: transform 0.3s;
        }

        /* --- Lesson Locking Styles --- */
        .lesson-checkpoint.locked .lesson-card {
            opacity: 0.6;
            background-color: #f3f4f6;
        }
        .lesson-checkpoint.locked .checkpoint-icon {
            background-color: #9ca3af;
            box-shadow: 0 0 0 3px #9ca3af;
        }
        .lesson-checkpoint.locked .lesson-title, .lesson-checkpoint.locked .game-card {
            pointer-events: none; /* Specifically disable links */
            cursor: not-allowed;
        }
        .lesson-summary-box.locked {
            opacity: 0.5;
            background-color: #f8f8f8;
            pointer-events: none;
            cursor: not-allowed;
        }
        .lesson-summary-box.locked .summary-icon {
            color: #b0b0b0 !important;
        }
        .unlock-date {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            background-color: #e5e7eb;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        /* --- Other Styles from previous versions --- */
        .card { background-color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .chapter-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .chapter-card-header { padding: 1.5rem; cursor: pointer; }
        .chapter-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); border-color: #4f46e5; }
        .chapter-lessons-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 1.5rem; border-top: 1px solid #e5e7eb; }
        .chapter-card.expanded .chapter-lessons-container { max-height: 2000px; padding: 1.5rem; }
        .chapter-card.expanded .expand-icon { transform: rotate(180deg); }
        .expand-icon { transition: transform 0.3s ease-in-out; }
        .lesson-summary-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; justify-content: center; }
        .lesson-summary-box { width: 80px; height: 80px; border: 2px solid #e5e7eb; background-color: #f9fafb; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.25rem; transition: all 0.2s ease; }
        .lesson-summary-box:hover:not(.locked) { border-color: #4f46e5; transform: scale(1.05); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .lesson-summary-box .top-part, .lesson-summary-box .bottom-part a { transition: background-color 0.2s ease; width: 100%; display: flex; justify-content: center; align-items: center; text-decoration: none; color: inherit; }
        .lesson-summary-box .top-part:hover, .lesson-summary-box .bottom-part a:hover { background-color: #eef2ff; }
        .lesson-summary-box .top-part { gap: 0.5rem; flex-grow: 1; border-top-left-radius: 0.6rem; border-top-right-radius: 0.6rem; }
        .lesson-summary-box .bottom-part { display: flex; gap: 1rem; flex-grow: 1; }
        .lesson-summary-box .bottom-part a { border-bottom-left-radius: 0.6rem; border-bottom-right-radius: 0.6rem; }
        .lesson-summary-box .lesson-number { font-size: 1.2rem; font-weight: 700; color: #6b7280; }
        .lesson-summary-box .top-part .summary-icon { font-size: 1.8rem; }
        .lesson-summary-box .bottom-part .summary-icon { font-size: 1.2rem; }
        .summary-icon { font-size: 1.4rem; }
        .summary-icon.fa-trophy { color: #f59e0b; }
        .summary-icon.fa-check { color: #22c55e; }
        .summary-icon.fa-sync-alt { color: #ef4444; }
        .summary-icon.fa-circle-notch { color: #9ca3af; font-size: 1.2rem; }
        .lessons-path { padding-top: 1rem; }
        .lesson-checkpoint { display: flex; align-items: flex-start; position: relative; padding-bottom: 2rem; }
        .lesson-checkpoint:not(:last-child)::before { content: ''; position: absolute; top: 25px; right: 24px; width: 2px; height: 100%; background-color: #d1d5db; }
        .checkpoint-icon { width: 50px; height: 50px; border-radius: 50%; display: grid; place-items: center; font-size: 1.5rem; color: white; border: 4px solid #f0f4f8; transition: all 0.3s ease; }
        .lesson-checkpoint.not-started .checkpoint-icon { background-color: #6366f1; box-shadow: 0 0 0 3px #6366f1; }
        .lesson-checkpoint.improve .checkpoint-icon { background-color: #ef4444; box-shadow: 0 0 0 3px #ef4444; }
        .lesson-checkpoint.good .checkpoint-icon { background-color: #22c55e; box-shadow: 0 0 0 3px #22c55e; }
        .lesson-checkpoint.excellent .checkpoint-icon { background-color: #f59e0b; box-shadow: 0 0 0 3px #f59e0b; }
        .checkpoint-content { margin-right: 1.5rem; width: 100%; }
        .lesson-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; transition: border-color 0.3s; }
        .lesson-checkpoint.excellent .lesson-card, .lesson-checkpoint.good .lesson-card { border-color: #22c55e; }
        .lesson-card-header { display: flex; justify-content: space-between; align-items: center; }
        .lesson-title { font-size: 1.125rem; font-weight: 700; color: #1f2937; text-decoration: none; }
        .lesson-title:hover { color: #4f46e5; }
        .lesson-grade { font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 9999px; }
        .lesson-grade.passed { background-color: #dcfce7; color: #166534; }
        .lesson-grade.failed { background-color: #fee2e2; color: #991b1b; }
        .lesson-grade.not-tested { background-color: #e5e7eb; color: #4b5563; }
        .games-grid { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #d1d5db; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1rem; }
        .game-card { background-color: white; border-radius: 0.5rem; padding: 0.75rem; text-align: center; border: 1px solid #e5e7eb; transition: transform 0.2s; text-decoration: none; color: #374151; cursor: pointer; }
        .game-card:hover { transform: translateY(-3px); }
        .game-title { font-weight: 600; font-size: 0.875rem; }
        .game-grade { font-size: 0.875rem; font-weight: 700; color: #1d4ed8; margin-top: 0.25rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background-color: white; border-radius: 1rem; padding: 1rem; width: 100%; max-width: 900px; max-height: 90%; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: flex-end; padding-bottom: 0.5rem; }
        .modal-close-btn { background: #e5e7eb; color: #4b5563; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; border: none; cursor: pointer; }
        .modal-body { flex-grow: 1; }
        .modal-body iframe { width: 100%; height: 100%; border: none; min-height: 500px; }
        .diagnostic-modal-content { background-color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; text-align: center; padding: 2.5rem; border-radius: 1rem; position: relative; }
        .diagnostic-modal-content .fa-rocket { font-size: 4rem; color: #3b82f6; margin-bottom: 1rem; }
        .diagnostic-modal-content h2 { font-size: 1.75rem; font-weight: 800; color: #1e3a8a; margin-bottom: 0.5rem; }
        .diagnostic-modal-content p { color: #4b5563; margin-bottom: 1.5rem; }
        .diagnostic-modal-content .start-test-btn { background: linear-gradient(to right, #22c55e, #16a34a); color: white; font-weight: 700; font-size: 1.1rem; padding: 0.75rem 2rem; border-radius: 9999px; text-decoration: none; display: inline-block; transition: transform 0.2s; }
        .diagnostic-modal-content .start-test-btn:hover { transform: scale(1.05); }
        #close-diagnostic-modal { position: absolute; top: 0.75rem; left: 0.75rem; background: #f1f5f9; color: #64748b; border: none; width: 2.25rem; height: 2.25rem; border-radius: 50%; font-size: 1.5rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .progress-circle { width: 150px; height: 150px; border-radius: 50%; display: grid; place-items: center; transition: background 0.5s; }
        .progress-circle-inner { width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .overall-percentage-text { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        .total-label { background-color: #eef2ff; color: #4338ca; font-size: 0.75rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; margin-top: 4px; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login View -->
    <div id="login-view" style="display: none;">
        <main class="container mx-auto px-6 py-8">
            <div class="max-w-md mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-3xl font-bold text-blue-800 mb-4">منصة الرياضيات التفاعلية</h1>
                    <p class="text-lg text-gray-600 mb-2">للمعلم: عبدالعزيز خالد العبلان</p>
                    <hr class="my-6">
                    <h2 class="text-2xl font-bold mb-2">أهلاً بك</h2>
                    <p class="text-gray-600 mb-6">أدخل رقم هويتك للدخول كطالب مسجل</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <input type="text" id="login-id" placeholder="رقم الهوية / الإقامة" class="w-full text-center text-lg px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 text-lg flex justify-center items-center transition-all duration-300 transform hover:scale-105">
                            <span id="login-submit-text">دخول</span>
                            <div id="login-loader" class="loader hidden"></div>
                        </button>
                    </form>
                    <div id="login-error" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"></div>
                    <div class="mt-8">
                        <p class="text-gray-600 mb-2">أو</p>
                        <button id="visitor-btn" class="font-bold text-gray-700 hover:underline">المتابعة كزائر</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Main App Container -->
    <div id="app-container" style="display: none;">
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50"></header>
        <main class="container mx-auto px-4 sm:px-6 py-8">
            
            <!-- NEW: Tabbed Card Container -->
            <div id="dashboard-container" class="tabbed-card-container">
                <div class="card-tabs">
                    <button id="student-data-tab" class="tab-button active">
                        <i class="fas fa-user-chart mr-2"></i>بيانات الطالب
                    </button>
                    <button id="leaderboard-tab" class="tab-button">
                        <i class="fas fa-trophy mr-2"></i>لوحة الأوائل
                    </button>
                </div>
                <div class="card-content">
                    <!-- View 1: Student Data -->
                    <div id="student-data-view" class="content-view">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="card space-y-4 border border-gray-200">
                                <div id="student-info-card"></div>
                                <div id="diagnostic-card"></div>
                            </div>
                            <div class="card flex flex-col items-center justify-center border border-gray-200">
                                <h3 class="text-2xl font-bold text-blue-800 mb-4">مستوى التقدم والإتقان</h3>
                                <div id="overall-progress-circle" class="progress-circle bg-gray-200">
                                    <div class="progress-circle-inner">
                                        <span id="mastery-percentage-text" class="overall-percentage-text">0%</span>
                                        <span class="total-label">مستوى الإتقان</span>
                                    </div>
                                </div>
                                <div id="progress-legend" class="flex flex-wrap justify-center items-center gap-4 mt-4 w-full">
                                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span><span class="text-sm font-semibold text-gray-600">مكتسبة</span></div>
                                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-sm font-semibold text-gray-600">مفقودة</span></div>
                                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span><span class="text-sm font-semibold text-gray-600">متبقية</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- View 2: Leaderboards -->
                    <div id="leaderboard-view" class="content-view hidden">
                        <div class="text-center p-8" id="leaderboard-loader">
                             <div class="loader inline-block"></div>
                             <p class="mt-2 font-semibold text-gray-600">جاري تحميل بيانات الأوائل...</p>
                        </div>
                        <div id="leaderboard-grid" class="leaderboard-grid hidden">
                            <!-- Leaderboards will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning Path Section -->
            <div id="learning-path-section" class="space-y-4 mt-8">
                <h2 class="text-3xl font-bold text-center text-blue-800">مسار الإنجاز</h2>
                <!-- Chapter cards will be injected here by JS -->
            </div>
        </main>
    </div>
    
    <footer id="main-footer" class="bg-gray-200 py-4 mt-auto"></footer>

    <!-- Game Modal & Diagnostic Modal -->
    <div id="game-modal" class="modal-overlay hidden"><div class="modal-content"><div class="modal-header"><button id="modal-close-btn" class="modal-close-btn">&times;</button></div><div class="modal-body"><iframe id="game-iframe"></iframe></div></div></div>
    <div id="diagnostic-modal" class="modal-overlay hidden"><div class="diagnostic-modal-content"><button id="close-diagnostic-modal" title="إغلاق">&times;</button><i class="fas fa-rocket"></i><h2>ابدأ رحلتك في الرياضيات!</h2><p>قبل أن تبدأ, نود قياس مهاراتك الأساسية. سيساعدنا هذا الاختبار في فهم نقاط قوتك وتحديد المهارات التي تحتاج إلى تركيز أكبر.</p><a id="start-diagnostic-btn" href="#" target="_top" class="start-test-btn"><i class="fas fa-play-circle mr-2"></i>ابدأ الاختبار التشخيصي</a></div></div>

    <script>
    (function() {
        // This URL must match your deployed Google Apps Script URL.
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const VISITOR_MAX_ATTEMPTS = 3;

        // --- RESTORED: Full Curriculum Index ---
        const curriculumIndex = {
            'c1': { 
                title: "الفصل ١: المعادلات الخطية",
                lessons: [
                    { id: 'c1_l1', title: 'الدرس ١-١: المعادلات', maxScore: 10, games: [ { id: 'g1_1_1', title: 'حماية الذرة', maxScore: 5 }, { id: 'g1_1_2', title: 'مصنع المعادلات', maxScore: 5 } ]},
                    { id: 'c1_l2', title: 'الدرس ١-٢: حل المعادلات ذات الخطوة الواحدة', maxScore: 10, games: [ { id: 'g1_2_1', title: 'رامي السهام', maxScore: 5 }, { id: 'g1_2_2', title: '....', maxScore: 5 } ]},
                    { id: 'c1_l3', title: 'الدرس ١-٣: حل المعادلات المتعددة الخطوات', maxScore: 10, games: [ { id: 'g1_3_1', title: ' ..... ', maxScore: 5 }, { id: 'g1_3_2', title: 'المغامرة الجبلية', maxScore: 5 } ]},
                    { id: 'c1_l4', title: 'الدرس ١-٤: حل المعادلات التي تحتوي متغيراً في طرفيها', maxScore: 10, games: [ { id: 'g1_4_1', title: '.....', maxScore: 5 }, { id: 'g1_4_2', title: '....', maxScore: 5 } ]},
                    { id: 'c1_l5', title: 'الدرس ١-٥: حل المعادلات التي تتضمن القيمة المطلقة', maxScore: 10, games: [ { id: 'g1_5_1', title: 'هداف الرياضيات', maxScore: 5 }, { id: 'g1_5_2', title: 'حارس الرياضيات', maxScore: 5 } ]},
                ]
            },
            'c2': {
                title: "الفصل ٢: العلاقات والدوال الخطية",
                lessons: [
                    { id: 'c2_l1', title: 'الدرس ٢-١: العلاقات', maxScore: 10, games: [ { id: 'g2_1_1', title: 'مغامرة سفينة الكنز', maxScore: 5 }, { id: 'g2_1_2', title: 'صيد الأسماك', maxScore: 5 } ]},
                    { id: 'c2_l2', title: 'الدرس ٢-٢: الدوال', maxScore: 10, games: [ { id: 'g2_2_1', title: '.....', maxScore: 5 }, { id: 'g2_2_2', title: '........', maxScore: 5 } ]},
                    { id: 'c2_l3', title: 'الدرس ٢-٣: تمثيل المعادلات الخطية بيانياً', maxScore: 10, games: [ { id: 'g2_3_1', title: '.........', maxScore: 5 }, { id: 'g2_3_2', title: '.........', maxScore: 5 } ]},
                    { id: 'c2_l4', title: 'الدرس ٢-٤: حل المعادلات الخطية بيانياً', maxScore: 10, games: [ { id: 'g2_4_1', title: '.........', maxScore: 5 }, { id: 'g2_4_2', title: '.........', maxScore: 5 } ]},
                    { id: 'c2_l5', title: 'الدرس ٢-٥: معدل التغير والميل', maxScore: 10, games: [ { id: 'g2_5_1', title: '.....', maxScore: 5 }, { id: 'g2_5_2', title: '........', maxScore: 5 } ]},
                    { id: 'c2_l6', title: 'الدرس ٢-٦: المتتابعات الحسابية كدوال خطية', maxScore: 10, games: [ { id: 'g2_6_1', title: '......', maxScore: 5 }, { id: 'g2_6_2', title: '.......', maxScore: 5 } ]},
                ]
            },
            'c3': { 
                title: "الفصل ٣: الدوال الخطية",
                lessons: [
                    { id: 'c3_l1', title: 'الدرس ٣-١: تمثيل المعادلات المكتوبة بصيغة الميل والمقطع بيانياً', maxScore: 10, games: [ { id: 'g3_1_1', title: 'طائرة المعادلات', maxScore: 5 }, { id: 'g3_1_2', title: '........', maxScore: 5 } ]},
                    { id: 'c3_l2', title: 'الدرس ٣-٢: كتابة المعادلات بصيغة الميل والمقطع', maxScore: 10, games: [ { id: 'g3_2_1', title: '........', maxScore: 5 }, { id: 'g3_2_2', title: '........', maxScore: 5 } ]},
                    { id: 'c3_l3', title: 'الدرس ٣-٣: كتابة المعادلات بصيغة الميل ونقطة', maxScore: 10, games: [ { id: 'g3_3_1', title: '.........', maxScore: 5 }, { id: 'g3_3_2', title: '........', maxScore: 5 } ]},
                    { id: 'c3_l4', title: 'الدرس ٣-٤: المستقيمات المتوازية والمتعامدة', maxScore: 10, games: [ { id: 'g3_4_1', title: '........', maxScore: 5 }, { id: 'g3_4_2', title: '.........', maxScore: 5 } ]},
                ]
            },
            'c4': { 
                title: "الفصل ٤: المتباينات الخطية",
                lessons: [
                    { id: 'c4_l1', title: 'الدرس ٤-١: حل المتباينات بالجمع أو بالطرح', maxScore: 10, games: [ { id: 'g4_1_1', title: '.........', maxScore: 5 }, { id: 'g4_1_2', title: '.........', maxScore: 5 } ]},
                    { id: 'c4_l2', title: 'الدرس ٤-٢: حل المتباينات بالضرب أو بالقسمة', maxScore: 10, games: [ { id: 'g4_2_1', title: '........', maxScore: 5 }, { id: 'g4_2_2', title: '........', maxScore: 5 } ]},
                    { id: 'c4_l3', title: 'الدرس ٤-٣: حل المتباينات المتعددة الخطوات', maxScore: 10, games: [ { id: 'g4_3_1', title: '.......', maxScore: 5 }, { id: 'g4_3_2', title: '........', maxScore: 5 } ]},
                    { id: 'c4_l4', title: 'الدرس ٤-٤: حل المتباينات المركبة', maxScore: 10, games: [ { id: 'g4_4_1', title: '..........', maxScore: 5 }, { id: 'g4_4_2', title: '........', maxScore: 5 } ]},
                    { id: 'c4_l5', title: 'الدرس ٤-٥: حل المتباينات التي تتضمن القيمة المطلقة', maxScore: 10, games: [ { id: 'g4_5_1', title: '....... ', maxScore: 5 }, { id: 'g4_5_2', title: '.......', maxScore: 5 } ]},
                ]
            },
            'c5': { 
                title: "الفصل ٥: أنظمة المعادلات الخطية",
                lessons: [
                    { id: 'c5_l1', title: 'الدرس ٥-١: حل نظام من معادلتين خطيتين بيانياً', maxScore: 10, games: [ { id: 'g5_1_1', title: '.........', maxScore: 5 }, { id: 'g5_1_2', title: '.........', maxScore: 5 } ]},
                    { id: 'c5_l2', title: 'الدرس ٥-٢: حل نظام من معادلتين خطيتين بالتعويض', maxScore: 10, games: [ { id: 'g5_2_1', title: '.......', maxScore: 5 }, { id: 'g5_2_2', title: '.......', maxScore: 5 } ]},
                    { id: 'c5_l3', title: 'الدرس ٥-٣: الحل بالحذف (الجمع أو الطرح)', maxScore: 10, games: [ { id: 'g5_3_1', title: '..........', maxScore: 5 }, { id: 'g5_3_2', title: '..........', maxScore: 5 } ]},
                    { id: 'c5_l4', title: 'الدرس ٥-٤: الحل بالحذف (الضرب)', maxScore: 10, games: [ { id: 'g5_4_1', title: '.......', maxScore: 5 }, { id: 'g5_4_2', title: '........', maxScore: 5 } ]},
                    { id: 'c5_l5', title: 'الدرس ٥-٥: تطبيقات على النظام الخطي', maxScore: 10, games: [ { id: 'g5_5_1', title: '........', maxScore: 5 }, { id: 'g5_5_2', title: '.........', maxScore: 5 } ]},
                ]
            }
        };

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const gameModal = document.getElementById('game-modal');
        const gameIframe = document.getElementById('game-iframe');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const diagnosticModal = document.getElementById('diagnostic-modal');
        const startDiagnosticBtn = document.getElementById('start-diagnostic-btn');
        const closeDiagnosticModalBtn = document.getElementById('close-diagnostic-modal');
        const studentDataTab = document.getElementById('student-data-tab');
        const leaderboardTab = document.getElementById('leaderboard-tab');
        const studentDataView = document.getElementById('student-data-view');
        const leaderboardView = document.getElementById('leaderboard-view');

        // --- Utility Functions ---
        function getClassIdentifier(fullClassName) { if (!fullClassName) return null; const classMap = { "ثالث / أول": "3-1", "ثالث / ثاني": "3-2", "ثالث / ثالث": "3-3" }; return classMap[fullClassName.trim()] || null; }
        function robustParseFloat(value) { if (value === null || value === undefined || value === "") return 0; const stringValue = String(value); const sanitizedValue = stringValue.replace(',', '.').trim(); const parsed = parseFloat(sanitizedValue); return isNaN(parsed) ? 0 : parsed; }
        
        // --- View Switching ---
        function switchView(viewName) {
            loginView.style.display = viewName === 'login' ? 'flex' : 'none';
            appContainer.style.display = viewName === 'app' ? 'block' : 'none';
        }
        
        function switchDashboardTab(tabName) {
            studentDataTab.classList.toggle('active', tabName === 'student');
            leaderboardTab.classList.toggle('active', tabName === 'leaderboard');
            studentDataView.classList.toggle('hidden', tabName !== 'student');
            leaderboardView.classList.toggle('hidden', tabName !== 'leaderboard');
        }

        // --- Main Rendering Functions ---
        function renderAppContent(studentData) {
            buildHeader(studentData);
            buildFooter();
            if (studentData) {
                showStudentDashboard(studentData);
                fetchAndRenderLeaderboards(studentData);
            } else { 
                document.getElementById('dashboard-container').classList.add('hidden');
                buildLearningPath({ lessons: {}, games: {} });
            }
        }
        
        function getStudentFromStorage() { const s = localStorage.getItem('currentStudent'); return s ? JSON.parse(s) : null; }

        function handleLogin(studentId) {
            const loader = document.getElementById('login-loader');
            const errorDiv = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');

            fetch(`${SCRIPT_URL}?action=findStudentById&studentId=${studentId}`, { redirect: 'follow' })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        result.data.classIdentifier = getClassIdentifier(result.data.class);
                        // The 'role' property is now expected from the Google Apps Script
                        // e.g., result.data.role = 'teacher' or 'student'
                        if (!result.data.classIdentifier && result.data.role !== 'teacher') {
                                errorDiv.textContent = 'خطأ: لم يتم التعرف على صيغة الفصل للطالب.';
                                errorDiv.classList.remove('hidden');
                                return;
                        }
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        switchView('app');
                        renderAppContent(result.data);
                    } else {
                        errorDiv.textContent = result.message || 'رقم الهوية غير مسجل في أي فصل.';
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error("Login Error:", err);
                    errorDiv.textContent = 'خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.';
                    errorDiv.classList.remove('hidden');
                })
                .finally(() => {
                    loader.classList.add('hidden');
                    submitBtn.disabled = false;
                });
        }
        
        function refreshStudentData(studentId, classIdentifier) {
            if (!studentId || !classIdentifier) return;
            fetch(`${SCRIPT_URL}?action=getStudentData&studentId=${studentId}&classId=${classIdentifier}`, { redirect: 'follow' })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success' && result.data) {
                        result.data.classIdentifier = getClassIdentifier(result.data.class);
                        // Preserve the role from the initial login
                        const currentData = getStudentFromStorage();
                        if(currentData && currentData.role) {
                            result.data.role = currentData.role;
                        }
                        localStorage.setItem('currentStudent', JSON.stringify(result.data));
                        renderAppContent(result.data); 
                    }
                })
                .catch(err => console.error("Data refresh error:", err));
        }

        function buildHeader(studentData) {
            const headerContainer = document.getElementById('main-header');
            if (!headerContainer) return;
            let userInfoHtml = studentData ? `<div class="flex items-center gap-4"><span class="font-semibold">أهلاً، ${studentData.name} ${studentData.role === 'teacher' ? '(معلم)' : ''}</span><button id="logout-btn" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600 transition-colors">خروج</button></div>` : `<div class="flex items-center gap-4"><p class="text-lg text-gray-600">زائر</p><button id="visitor-login-btn" class="bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 transition-colors">تسجيل الدخول</button></div>`;
            headerContainer.innerHTML = `<div class="container mx-auto px-6 py-4 flex justify-between items-center"><a href="#" onclick="window.location.reload()" class="text-2xl font-bold text-blue-800">منصة الرياضيات التفاعلية</a>${userInfoHtml}</div>`;
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', () => { localStorage.removeItem('currentStudent'); window.location.reload(); });
            const visitorLoginBtn = document.getElementById('visitor-login-btn');
            if (visitorLoginBtn) visitorLoginBtn.addEventListener('click', () => switchView('login'));
        }

        function buildFooter() {
            const footerContainer = document.getElementById('main-footer');
            if (!footerContainer) return;
            const shareText = encodeURIComponent('أدعوك للاستفادة من منصة الرياضيات التفاعلية للمعلم عبدالعزيز العبلان:');
            const pageUrl = encodeURIComponent(window.location.href);
            footerContainer.innerHTML = `<div class="container mx-auto px-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0"><p class="text-gray-600 text-sm">© 2024 جميع الحقوق محفوظة | تطوير: أ. عبدالعزيز خالد العبلان</p><div class="flex items-center space-x-4" dir="ltr"><a href="https://www.snapchat.com/share?url=${pageUrl}" target="_blank" aria-label="Share on Snapchat" class="social-icon"><svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#FFFC00"/><path d="M12.0118 6.66667C8.68183 6.66667 6 9.3485 6 12.6785C6 14.8385 7.15233 16.7385 8.88233 17.8485C8.96233 17.9085 9.05233 17.9485 9.14233 17.9485C9.28233 17.9485 9.42233 17.8785 9.51233 17.7485C9.66233 17.5385 9.60233 17.2385 9.39233 17.0885C7.98233 16.1485 7 14.5085 7 12.6785C7 9.8985 9.22183 7.66667 12.0118 7.66667C14.7918 7.66667 17.0218 9.8985 17.0218 12.6785C17.0218 14.5085 16.0318 16.1485 14.6218 17.0885C14.4118 17.2385 14.3518 17.5385 14.5018 17.7485C14.5918 17.8785 14.7318 17.9485 14.8718 17.9485C14.9618 17.9485 15.0518 17.9085 15.1418 17.8485C16.8618 16.7385 18.0218 14.8385 18.0218 12.6785C18.0218 9.3485 15.3418 6.66667 12.0118 6.66667Z" fill="white"/></svg></a><a href="https://t.me/share/url?url=${pageUrl}&text=${shareText}" target="_blank" aria-label="Share on Telegram" class="social-icon"><svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#2AABEE"/><path d="m9.417 15.181-.397 5.584c.568 0 .814-.244 1.109-.537l2.663-2.545 5.518 4.041c1.012.564 1.725.267 1.998-.931L22.43 5.218c.347-1.61-1.2-2.127-2.299-1.594L4.543 11.177c-1.636.682-1.66 1.32.285 1.721l4.252 1.325 9.46-5.924c.448-.277.855-.136.524.162z" fill="#fff"/></svg></a><a href="https://twitter.com/intent/tweet?text=${shareText}&url=${pageUrl}" target="_blank" aria-label="Share on Twitter" class="social-icon"><svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#000"/><path d="m10.215 13.584-6.328 7.163h1.416l5.59-6.328 4.35 6.328h6.92l-6.7-9.74 6.13-6.95h-1.416l-5.18 5.86-4.01-5.86h-6.92l7.07 10.28zm-.76-1.13-1.42-2.02-5.1-7.25h2.15l4.2 5.97 1.42 2.02 5.43 7.72h-2.15l-4.58-6.5z" fill="#fff"/></svg></a><a href="https://api.whatsapp.com/send?text=${shareText}%20${pageUrl}" target="_blank" aria-label="Share on WhatsApp" class="social-icon"><svg class="w-7 h-7" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#25D366" d="M12 2C6.477 2 2 6.477 2 12c0 1.742.448 3.385 1.253 4.814L2 22l5.186-1.253A9.93 9.93 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z"/><path fill="#FFF" d="M17.23 14.25c-.21-.12-.83-.41-1-.47-.16-.07-.3-.07-.42.12-.12.2-.4.48-.48.57-.08.1-.16.1-.28 0-.12-.07-.5-.18-1.03-.63-.8-.7-1.33-1.56-1.48-1.82-.15-.26-.02-.4.07-.53.08-.12.18-.3.27-.4.1-.1.12-.18.18-.3.06-.12.03-.23 0-.33-.03-.1-.28-.68-.38-1-.1-.31-.2-.26-.28-.26-.08 0-.18 0-.28 0-.1 0-.26.04-.4.2-.13.16-.52.5-.52 1.22 0 .72.53 1.42.6 1.52.08.1.92 1.47 2.4 2.1.37.16.66.25.88.32.22.07.42.06.58.02.18-.04.58-.24.7-.47.12-.24.12-.44.08-.48-.03-.05-.1-.07-.2-.1z"/></svg></a><span class="text-gray-600 text-sm">:شاركنا</span></div></div>`;
        }
        
        function showStudentDashboard(studentData) {
            document.getElementById('dashboard-container').classList.remove('hidden');
            
            const studentInfoCard = document.getElementById('student-info-card');
            studentInfoCard.innerHTML = `<h4 class="text-2xl font-bold text-blue-800 mb-4">بيانات الطالب</h4><div class="space-y-2 text-gray-800 text-lg"><p><strong>الاسم:</strong> <span id="display-name">${studentData.name || '-'}</span></p><p><strong>رقم الهوية:</strong> <span id="display-id">${studentData.id || '-'}</span></p><p><strong>الصف:</strong> <span id="display-class">${studentData.class || '-'}</span></p></div>`;

            renderTestCard(studentData);

            const diagnostics = studentData.diagnostics || {};
            if (!diagnostics.d_best_weighted && !diagnostics.d_test_overall) {
                showDiagnosticModal(studentData.id, studentData.classIdentifier);
            }

            let totalMaxPossibleScore = 0, totalStudentScoreGained = 0, totalPossibleScoreFromAttempted = 0;
            Object.values(curriculumIndex).forEach(chapter => {
                chapter.lessons.forEach(lesson => {
                    const lessonMaxScore = lesson.maxScore || 10;
                    totalMaxPossibleScore += lessonMaxScore;
                    if (studentData.lessons && studentData.lessons[lesson.id] !== undefined) {
                        totalStudentScoreGained += robustParseFloat(studentData.lessons[lesson.id].grade);
                        totalPossibleScoreFromAttempted += lessonMaxScore;
                    }
                    (lesson.games || []).forEach(game => {
                        const gameMaxScore = game.maxScore || 5;
                        totalMaxPossibleScore += gameMaxScore;
                        if (studentData.games && studentData.games[game.id] !== undefined) {
                            totalStudentScoreGained += robustParseFloat(studentData.games[game.id].grade);
                            totalPossibleScoreFromAttempted += gameMaxScore;
                        }
                    });
                });
            });

            const totalScoreLost = totalPossibleScoreFromAttempted - totalStudentScoreGained;
            const gainedPercentage = totalMaxPossibleScore > 0 ? (totalStudentScoreGained / totalMaxPossibleScore) * 100 : 0;
            const lostPercentage = totalMaxPossibleScore > 0 ? (totalScoreLost / totalMaxPossibleScore) * 100 : 0;
            const masteryPercentage = totalPossibleScoreFromAttempted > 0 ? Math.round((totalStudentScoreGained / totalPossibleScoreFromAttempted) * 100) : 0;
            const progressCircle = document.getElementById('overall-progress-circle');
            const masteryText = document.getElementById('mastery-percentage-text');
            const gainedDegrees = gainedPercentage * 3.6;
            const lostDegrees = lostPercentage * 3.6;
            progressCircle.style.background = `conic-gradient(#22c55e 0deg ${gainedDegrees}deg, #ef4444 ${gainedDegrees}deg ${gainedDegrees + lostDegrees}deg, #e5e7eb ${gainedDegrees + lostDegrees}deg 360deg)`;
            masteryText.textContent = `${masteryPercentage}%`;
            
            masteryText.classList.remove('text-red-600', 'text-blue-800'); 
            masteryText.style.color = '#22c55e';

            buildLearningPath(studentData);
        }

        // --- Leaderboard Functions ---
        function fetchAndRenderLeaderboards(currentStudent) {
            const loader = document.getElementById('leaderboard-loader');
            const grid = document.getElementById('leaderboard-grid');
            loader.classList.remove('hidden');
            grid.classList.add('hidden');

            fetch(`${SCRIPT_URL}?action=getLeaderboardData&studentId=${currentStudent.id}&classId=${currentStudent.classIdentifier}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        const data = response.data;
                        grid.innerHTML = ''; // Clear previous leaderboards
                        grid.appendChild(createLeaderboardCard('أوائل جميع الفصول', 'مجموع النقاط', data.overallTop10, currentStudent.id, data.ranks.overall));
                        grid.appendChild(createLeaderboardCard(`أوائل فصل ${currentStudent.class}`, 'مجموع النقاط', data.classTop10, currentStudent.id, data.ranks.class));
                        grid.appendChild(createLeaderboardCard('أوائل الاختبار التشخيصي', 'المعدل', data.diagnosticTop10, currentStudent.id, data.ranks.diagnostic, true));
                        loader.classList.add('hidden');
                        grid.classList.remove('hidden');
                    } else {
                        throw new Error(response.message || "Failed to load leaderboard data.");
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    loader.innerHTML = `<p class="text-red-500 font-semibold">حدث خطأ أثناء تحميل لوحة الأوائل.</p>`;
                });
        }

        function createLeaderboardCard(title, scoreLabel, data, currentStudentId, rank, isDiagnostic = false) {
            const card = document.createElement('div');
            card.className = 'leaderboard-card';
            const uniqueId = `leaderboard-${title.replace(/[\s/]/g, '-')}`;

            let tableRows = data.slice(0, 10).map((student, index) => {
                const isCurrentUser = student.id.toString() === currentStudentId.toString();
                let scoreDisplay;
                if (isDiagnostic) {
                    scoreDisplay = `
                        <div>
                            <span class="font-bold">${student.diagnosticGrade}%</span>
                            <span class="block text-xs text-gray-500 font-normal">${student.diagnosticPoints} نقطة</span>
                        </div>
                    `;
                } else {
                    scoreDisplay = `<span class="font-bold">${student.totalScore}</span>`;
                }
                const hiddenClass = index >= 3 ? 'expandable-row hidden' : '';
                return `<tr class="${isCurrentUser ? 'current-student' : ''} ${hiddenClass}" data-table-id="${uniqueId}"><td class="rank">#${index + 1}</td><td>${student.name} <span class="text-sm text-gray-500">(${student.class})</span></td><td class="score">${scoreDisplay}</td></tr>`;
            }).join('');

            const rankCard = rank > 0 ? `<div class="current-student-rank-card">مركزك الحالي: ${rank}</div>` : '';
            const expandButton = data.length > 3 ? `<button onclick="toggleLeaderboard(this, '${uniqueId}')" class="expand-leaderboard-btn">توسيع الجدول <i class="fas fa-chevron-down ml-1"></i></button>` : '';

            card.innerHTML = `<h3 class="leaderboard-title">${title}</h3><table class="leaderboard-table"><thead><tr><th>#</th><th>الاسم</th><th class="score">${scoreLabel}</th></tr></thead><tbody>${tableRows}</tbody></table>${expandButton}${rankCard}`;
            return card;
        }

        window.toggleLeaderboard = (button, tableId) => {
            const rows = document.querySelectorAll(`.expandable-row[data-table-id="${tableId}"]`);
            if (!rows.length) return;
            const isHidden = rows[0].classList.contains('hidden');
            rows.forEach(row => row.classList.toggle('hidden'));
            button.innerHTML = isHidden ? 'إخفاء <i class="fas fa-chevron-up ml-1"></i>' : 'توسيع الجدول <i class="fas fa-chevron-down ml-1"></i>';
        };

        // --- Learning Path & Other UI Functions ---
        function buildLearningPath(studentData) {
            const learningPathContainer = document.getElementById('learning-path-section');
            const studentLessons = studentData.lessons || {};
            const studentGames = studentData.games || {};
            const lessonRules = studentData.lessonRules || {};

            learningPathContainer.innerHTML = '<h2 class="text-3xl font-bold text-center text-blue-800 mb-6">مسار الإنجاز</h2>';
            Object.keys(curriculumIndex).forEach((chapterKey) => {
                const chapter = curriculumIndex[chapterKey];
                let lessonSummariesHtml = '';
                const lessonsHtml = chapter.lessons.map((lesson, index) => {
                    const lessonData = studentLessons[lesson.id];
                    const lessonGrade = (lessonData !== undefined) ? robustParseFloat(lessonData.grade) : null;
                    
                    // Lesson Locking Logic
                    const rule = lessonRules[lesson.id];
                    let isLocked = true;
                    let unlockDate = null;

                    if (rule) {
                        if (rule.method === 'يدوي' && rule.value === 'مفتوح') {
                            isLocked = false;
                        } else if (rule.method === 'تاريخ') {
                            const today = new Date();
                            const openDate = new Date(rule.value);
                            today.setHours(0, 0, 0, 0); // Normalize today's date
                            if (today >= openDate) {
                                isLocked = false;
                            } else {
                                unlockDate = rule.value;
                            }
                        }
                    } else {
                        isLocked = false; // Default to open if no rule is set
                    }
                    
                    // =======================================================
                    // NEW: Teacher Override Logic
                    // If the logged-in user has the role 'teacher', unlock everything.
                    if (studentData && studentData.role === 'teacher') {
                        isLocked = false;
                        unlockDate = null; // Also clear any "unlocks on" date message
                    }
                    // =======================================================

                    const game1 = lesson.games && lesson.games[0] ? lesson.games[0] : null;
                    const game1Data = game1 ? studentGames[game1.id] : null;
                    const game1Grade = (game1Data !== undefined) ? robustParseFloat(game1Data.grade) : null;
                    const game2 = lesson.games && lesson.games[1] ? lesson.games[1] : null;
                    const game2Data = game2 ? studentGames[game2.id] : null;
                    const game2Grade = (game2Data !== undefined) ? robustParseFloat(game2Data.grade) : null;
                    
                    lessonSummariesHtml += buildSummaryBox(lesson, index, { lessonGrade, game1Grade, game2Grade }, studentData, isLocked);

                    const { state, icon } = isLocked ? { state: 'locked', icon: 'fa-lock' } : getPerformanceDetails(lessonGrade, lesson.maxScore);
                    let gradeHtml = `<span class="lesson-grade not-tested">لم يتم</span>`;
                    if (lessonGrade !== null) { gradeHtml = `<span class="lesson-grade ${lessonGrade >= lesson.maxScore / 2 ? 'passed' : 'failed'}">${lessonGrade}/${lesson.maxScore}</span>`; }
                    
                    const lessonLink = studentData.id ? `lessons/${lesson.id}.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}` : `lessons/${lesson.id}.html`;
                    
                    const gamesHtml = (lesson.games || []).map(game => {
                        const gameData = studentGames[game.id];
                        const gameGrade = (gameData !== undefined) ? robustParseFloat(gameData.grade) : null;
                        return `<div onclick="openGameModal('${game.id}')" class="game-card"><div class="game-title">${game.title}</div><div class="game-grade">${gameGrade !== null ? `${gameGrade} / ${game.maxScore}` : '- / -'} ${gameGrade === game.maxScore ? '<i class="fas fa-star text-yellow-400 ml-1"></i>' : ''}</div></div>`;
                    }).join('');

                    const unlockDateHtml = unlockDate ? `<div class="unlock-date">يفتح بتاريخ: ${unlockDate}</div>` : '';

                    return `<div class="lesson-checkpoint ${state}"><div class="checkpoint-icon"><i class="fas ${icon}"></i></div><div class="checkpoint-content"><div class="lesson-card"><div class="lesson-card-header"><a href="${lessonLink}" target="_top" class="lesson-title">${lesson.title}</a>${gradeHtml}</div>${unlockDateHtml}${gamesHtml ? `<div class="games-grid">${gamesHtml}</div>` : ''}</div></div></div>`;
                }).join('');
                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-card';
                chapterCard.innerHTML = `<div class="chapter-card-header"><div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-blue-800">${chapter.title}</h3><i class="fas fa-chevron-down text-2xl text-gray-400 expand-icon"></i></div><div class="lesson-summary-grid">${lessonSummariesHtml}</div></div><div class="chapter-lessons-container"><div class="lessons-path">${lessonsHtml}</div></div>`;
                learningPathContainer.appendChild(chapterCard);
                chapterCard.querySelector('.chapter-card-header').addEventListener('click', (e) => { if (!e.target.closest('.lesson-summary-box')) { chapterCard.classList.toggle('expanded'); } });
            });
        }
        function buildSummaryBox(lesson, index, grades, studentData, isLocked) {
            const { lessonGrade, game1Grade, game2Grade } = grades;
            const lessonIcon = isLocked ? 'fa-lock' : getPerformanceIcon(lessonGrade, lesson.maxScore);
            const game1 = lesson.games && lesson.games[0];
            const game2 = lesson.games && lesson.games[1];
            const game1Icon = isLocked ? 'fa-lock' : (game1 ? getPerformanceIcon(game1Grade, game1.maxScore) : 'fa-times');
            const game2Icon = isLocked ? 'fa-lock' : (game2 ? getPerformanceIcon(game2Grade, game2.maxScore) : 'fa-times');
            const lessonLink = studentData.id ? `lessons/${lesson.id}.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}` : `lessons/${lesson.id}.html`;
            let content = `<a href="${lessonLink}" target="_top" class="top-part"><span class="lesson-number">${index + 1}</span><i class="fas ${lessonIcon} summary-icon"></i></a><div class="bottom-part"><a href="#" onclick="openGameModal('${game1 ? game1.id : ''}'); return false;"><i class="fas ${game1Icon} summary-icon"></i></a><a href="#" onclick="openGameModal('${game2 ? game2.id : ''}'); return false;"><i class="fas ${game2Icon} summary-icon"></i></a></div>`;
            return `<div class="lesson-summary-box ${isLocked ? 'locked' : ''}" title="${isLocked ? 'الدرس مغلق' : lesson.title}">${content}</div>`;
        }
        function getPerformanceIcon(grade, maxScore) { if (grade === null) return 'fa-circle-notch'; if (grade === maxScore) return 'fa-trophy'; if (grade >= maxScore / 2) return 'fa-check'; return 'fa-sync-alt'; }
        function getPerformanceDetails(grade, maxScore) { if (grade === null) return { state: 'not-started', icon: 'fa-book-open' }; if (grade === maxScore) return { state: 'excellent', icon: 'fa-trophy' }; if (grade >= maxScore / 2) return { state: 'good', icon: 'fa-check' }; return { state: 'improve', icon: 'fa-sync-alt' }; }
        function renderTestCard(studentData) {
            const card = document.getElementById('diagnostic-card');
            if (!card) return;
            const diagnostics = studentData.diagnostics || {};
            const diagnosticLink = `diagnostic.html?studentId=${studentData.id}&classId=${studentData.classIdentifier}`;
            if (diagnostics.d_best_weighted !== undefined) {
                const scoreData = diagnostics.d_best_weighted;
                const score = robustParseFloat((typeof scoreData === 'object' && scoreData.grade !== undefined) ? scoreData.grade : scoreData);
                const scoreColor = score >= 80 ? 'text-green-600' : (score >= 50 ? 'text-yellow-600' : 'text-red-600');
                const totalPoints = (typeof scoreData === 'object' && scoreData.metricValue !== undefined) ? scoreData.metricValue : 'N/A';
                card.innerHTML = `<h4 class="text-xl font-bold text-purple-700 mb-3">الاختبار التحصيلي</h4><div class="flex justify-around items-center text-center p-3 bg-purple-50 rounded-lg"><div><p class="text-sm font-bold text-gray-500 mb-1">المعدل الأفضل</p><span class="text-4xl font-extrabold ${scoreColor}">${score}%</span></div><div class="border-r border-purple-200 h-12 mx-2"></div><div><p class="text-sm font-bold text-gray-500 mb-1">مجموع النقاط</p><span class="text-4xl font-extrabold text-purple-800">${totalPoints} <span class="text-lg font-semibold text-gray-600">/ 144</span></span></div></div><a href="${diagnosticLink}" target="_top" class="mt-4 w-full text-center block bg-purple-100 text-purple-800 font-bold py-2 rounded-lg hover:bg-purple-200 transition-colors">الدخول للاختبار</a>`;
            } else {
                card.innerHTML = `<h4 class="text-xl font-bold text-purple-700 mb-2">الاختبار التشخيصي</h4><p class="text-gray-600 my-4 text-center font-semibold">لم يتم أداء الاختبار بعد.</p><a href="${diagnosticLink}" target="_top" class="w-full text-center block bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors shadow-md hover:shadow-lg">ابدأ الاختبار الآن</a>`;
            }
        }
        function showDiagnosticModal(studentId, classIdentifier) { startDiagnosticBtn.href = `diagnostic.html?studentId=${studentId}&classId=${classIdentifier}`; diagnosticModal.classList.remove('hidden'); }
        window.openGameModal = (gameId) => {
            if (!gameId || gameId === 'null') return;
            const student = getStudentFromStorage();
            if (!student) {
                const attempts = JSON.parse(localStorage.getItem('visitorGameAttempts') || '{}');
                const gameAttempts = attempts[gameId] || 0;
                if (gameAttempts >= VISITOR_MAX_ATTEMPTS) {
                    const body = document.querySelector('body');
                    const msgBox = document.createElement('div');
                    msgBox.textContent = `لقد استنفدت محاولاتك المجانية (${VISITOR_MAX_ATTEMPTS}). يرجى تسجيل الدخول.`;
                    msgBox.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 1rem; border-radius: 0.5rem; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                    body.appendChild(msgBox);
                    setTimeout(() => body.removeChild(msgBox), 4000);
                    return;
                }
            }
            const gameSrc = student ? `games/${gameId}.html?studentId=${student.id}&classId=${student.classIdentifier}` : `games/${gameId}.html`;
            gameIframe.src = gameSrc;
            gameModal.classList.remove('hidden');
        };
        function closeGameModal() {
            gameModal.classList.add('hidden');
            gameIframe.src = 'about:blank';
            const student = getStudentFromStorage();
            if (student) { refreshStudentData(student.id, student.classIdentifier); }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const student = getStudentFromStorage();
            if (student) {
                switchView('app');
                renderAppContent(student);
                refreshStudentData(student.id, student.classIdentifier);
            } else {
                switchView('login');
                buildFooter();
            }
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('login-id').value.trim();
                if (studentId) { handleLogin(studentId); }
            });

            document.getElementById('visitor-btn').addEventListener('click', () => {
                localStorage.removeItem('currentStudent');
                switchView('app');
                renderAppContent(null);
            });

            studentDataTab.addEventListener('click', () => switchDashboardTab('student'));
            leaderboardTab.addEventListener('click', () => switchDashboardTab('leaderboard'));

            modalCloseBtn.addEventListener('click', closeGameModal);
            closeDiagnosticModalBtn.addEventListener('click', () => diagnosticModal.classList.add('hidden'));

            window.addEventListener('message', (event) => {
                if (event.data && event.data.event === 'gameFinished') {
                    const student = getStudentFromStorage();
                    if (!student && event.data.gameId) {
                        const attempts = JSON.parse(localStorage.getItem('visitorGameAttempts') || '{}');
                        attempts[event.data.gameId] = (attempts[event.data.gameId] || 0) + 1;
                        localStorage.setItem('visitorGameAttempts', JSON.stringify(attempts));
                    }
                    closeGameModal();
                }
            });
        });
    })();
    </script>
</body>
</html>

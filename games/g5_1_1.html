<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุนุจุฉ ุฃูุธูุฉ ุงููุนุงุฏูุงุช ุงูุฎุทูุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ุงุณุชุฎุฏุงู ุฎุท Cairo ูุฎุท ุฃุณุงุณู */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            overscroll-behavior: none;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ุชูุณูู ูุฎุตุต ูููุนุงุฏูุงุช ูุงูุฃุฑูุงู (ุชู ุชุตุบูุฑ ุงูุฎุท ููููุงู) */
        .equation-font {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.05rem; /* 17px (ูุงู 1.1rem) */
            font-weight: 700;
            text-align: center;
        }

        /* ุชูุณูู ุงูุฃุฑูุงู ุงูุณูููุฉ (subscript) */
        sub {
            font-size: 0.75em;
            vertical-align: sub;
            line-height: 0;
            font-family: 'Courier New', Courier, monospace;
        }

        /* ุชูุณูู ุงููุณูุฑ ุงูุนููุฏูุฉ */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.2em;
            vertical-align: middle;
            position: relative;
            top: -0.3em;
        }
        .numerator {
            font-size: 0.85em;
            line-height: 1;
        }
        .denominator {
            font-size: 0.85em;
            border-top: 2px solid currentColor; /* ุฎุท ุงููุณุฑ */
            line-height: 1;
            padding-top: 2px;
        }
        
        /* ุชูุณูู ุฒุฑ ุงูุฎูุงุฑ (ุชู ุชุตุบูุฑ ุงูุญุฌู ูุงูุฎุท) */
        .choice-button {
            width: 100%;
            padding: 0.6rem 0.75rem; /* (ูุงู 0.75rem 1rem) */
            background-color: #ffffff;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            font-size: 0.95rem; /* (ูุงู 1rem) */
            font-weight: 600;
        }
        .choice-button:hover:not(:disabled) {
            background-color: #f9fafb; /* gray-50 */
            border-color: #6b7280; /* gray-500 */
        }
        .choice-button.selected {
            border-color: #2563eb; /* blue-600 */
            background-color: #dbeafe; /* blue-100 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        /* (ุชุนุฏูู) ุชุนุทูู ุงูุฒุฑ ุนูุฏ ุงูุฎุทุฃ */
        .choice-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ุญุงูุฉ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ */
        .choice-button.correct {
            border-color: #16a34a; /* green-600 */
            background-color: #dcfce7; /* green-100 */
        }
        
        /* ุญุงูุฉ ุงูุฅุฌุงุจุฉ ุงูุฎุงุทุฆุฉ */
        .choice-button.incorrect {
            border-color: #dc2626; /* red-600 */
            background-color: #fee2e2; /* red-100 */
        }
        
        /* ุญุงููุฉ ุงูุฎูุงุฑุงุช ูู 3 ุฎูุงุฑุงุช (ุนููุฏ ูุงุญุฏ ููุฌูุงูุ 3 ุฃุนูุฏุฉ ูููุจูุฑ) */
        .choices-grid-3 {
            display: grid;
            grid-template-columns: 1fr; /* ุนููุฏ ูุงุญุฏ ุงูุชุฑุงุถูุงู ููุฌูุงู */
            gap: 0.75rem; /* 12px */
        }

        @media (min-width: 640px) { /* sm */
            .choices-grid-3 {
                grid-template-columns: repeat(3, 1fr); /* 3 ุฃุนูุฏุฉ ููุดุงุดุงุช ุงูุฃูุจุฑ */
                gap: 1rem; /* 16px */
            }
        }
        
        /* ุชูุณูู ุงูููุงูุฐ ุงูููุจุซูุฉ (Modal) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        
        /* ูุฒูุงู ููุงูุฐุฉ ุงูุดุฑุญ */
        #solution-content {
            max-height: 50vh; /* ุชุญุฏูุฏ ุฃูุตู ุงุฑุชูุงุน 50% ูู ุงูุดุงุดุฉ */
            overflow-y: auto; /* ุฅุถุงูุฉ ูุฒูุงู ุนููุฏู ุนูุฏ ุงูุญุงุฌุฉ */
            padding-left: 1rem; /* ูุณุงุญุฉ ูููุฒูุงู ูู ูุถุน RTL */
            margin-left: -1rem; /* ุชุนููุถ ุงููุณุงุญุฉ */
        }

        /* ูุฒูุงู ูุณุฌู ุงูุฃุจุทุงู */
        .leaderboard-scroll-container {
            max-height: 40vh; /* ุชุญุฏูุฏ ุฃูุตู ุงุฑุชูุงุน */
            overflow-y: auto; /* ุฅุถุงูุฉ ูุฒูุงู ุนููุฏู ุนูุฏ ุงูุญุงุฌุฉ */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            margin-top: 1rem; /* mb-4 */
        }
         .leaderboard-scroll-container table {
             margin-bottom: 0; /* ุฅุฒุงูุฉ ุงููุงูุด ุงูุณููู ููุฌุฏูู */
         }

        /* ุญุงููุฉ ุงููุนุงุฏูุชูู ูู ุงูุณุคุงู */
        .equations-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* 8px */
            min-height: 5rem; /* 80px */
            padding: 0.5rem;
        }
        @media (min-width: 400px) {
            .equations-box {
                flex-direction: row;
                gap: 1rem; /* 16px */
            }
        }

        /* ุชูุณููุงุช ุฃุฒุฑุงุฑ ุงููุณุชููุงุช */
        .level-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.75rem; /* (ุชุนุฏูู) ุชู ุชูููู ุงูุญุดู ูู 1rem */
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
        }
        .level-button.locked {
            background-color: #d1d5db; /* gray-300 */
            border-color: #9ca3af; /* gray-400 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
        }
        .level-button.unlocked {
            background-color: #ffffff; /* white */
            border-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-800 */
            cursor: pointer;
        }
        .level-button.unlocked:hover {
            background-color: #eff6ff; /* blue-50 */
            transform: translateY(-2px);
        }
        /* ุงููุณุชูู ุงููุชุงุญ ููุนุจ (ูููุถ) */
        .level-button.unlocked.glowing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .level-button.completed {
            background-color: #dcfce7; /* green-100 */
            border-color: #22c55e; /* green-500 */
            color: #15803d; /* green-700 */
            cursor: pointer;
        }
        .level-button.completed:hover {
            background-color: #f0fdf4; /* green-50 */
            transform: translateY(-2px);
        }

        .level-title {
            font-size: 1.125rem; /* (ุชุนุฏูู) ุชู ุงูุชุตุบูุฑ */
            font-weight: 700; /* font-bold */
        }
        .level-score {
            font-size: 0.75rem; /* (ุชุนุฏูู) ุชู ุงูุชุตุบูุฑ */
            font-weight: 600; /* font-semibold */
            margin-top: 0.25rem; /* mt-1 */
        }
        .level-icon {
            font-size: 1.25rem; /* (ุชุนุฏูู) ุชู ุงูุชุตุบูุฑ */
        }
        .replay-icon {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        .level-button.completed:hover .replay-icon {
            color: #15803d; /* green-700 */
            opacity: 1;
        }
        /* ุฃููููุฉ ุงูููู */
        .lock-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-dvh flex items-center justify-center p-2 sm:p-4">

    <!-- ุดุงุดุฉ ุงูุชุฑุญูุจ (ุชุธูุฑ ุฃููุงู) -->
    <div id="welcome-modal" class="modal-overlay show" style="z-index: 80;">
        <div class="modal-content text-center" style="width: 480px;">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-700 mb-4">
                ูุนุจุฉ ุฃูุธูุฉ ุงููุนุงุฏูุงุช
            </h1>
            <!-- (ุชุนุฏูู) ุฅุถุงูุฉ id ูุฑุณุงูุฉ ุงูุชุฑุญูุจ ูุชุฎุตูุตูุง ูุงุญูุงู -->
            <p id="welcomeMessage" class="text-base text-gray-700 mb-4">
                ุฃููุงู ุจู ุฃููุง ุงูุจุทู! ูู ูุฐู ุงููุนุจุฉ ุณุชุชุนูู ููู ุชููุฒ ุจูู ุฃููุงุน ุฃูุธูุฉ ุงููุนุงุฏูุงุช ุงูุฎุทูุฉ ุงูุซูุงุซุฉ.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                ุฅุนุฏุงุฏ ูุชุทููุฑ: ุงูุฃุณุชุงุฐ ุนุจุฏุงูุนุฒูุฒ ุฎุงูุฏ ุงูุนุจูุงู
            </p>
            <button id="show-levels-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200">
                ุงุจุฏุฃ ุงููุนุจุฉ
            </button>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุงุฎุชูุงุฑ ุงููุณุชููุงุช (ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ) -->
    <div id="level-select-modal" class="modal-overlay" style="z-index: 79;">
        <!-- (ุชุนุฏูู) ุชู ุชุนุฏูู ุงูุนุฑุถ ุฅูู 320px ููุชุณุน ูุนููุฏูู ุจุดูู ูุฑูุญ -->
        <div class="modal-content" style="width: 320px;">
            
            <!-- (ุชุนุฏูู) ุฅุนุงุฏุฉ ุฒุฑ ุงููุฃุณ -->
            <div class="flex items-center justify-between w-full mb-4 relative">
                <h3 class="text-2xl font-bold text-blue-700 text-center w-full">
                    ุงุฎุชุฑ ุงููุณุชูู
                </h3>
                <!-- (ุฌุฏูุฏ) ุฒุฑ ุงููุฃุณ (ูุฎูู ุงูุชุฑุงุถูุงู) -->
                <button id="show-leaderboard-btn" title="ุนุฑุถ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ" class="absolute left-0 top-1/2 -translate-y-1/2 w-8 h-8 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center font-bold text-xl transition hover:bg-yellow-200 hidden">
                    ๐
                </button>
           </div>
            
            <!-- (ุชุนุฏูู) ุชุญููู ุงูุญุงููุฉ ุฅูู ุดุจูุฉ (Grid) ูู ุนููุฏูู -->
            <div id="levels-container" class="grid grid-cols-2 gap-3 mb-6"> 
                <!-- ุณูุชู ููุก ุงูุฃุฒุฑุงุฑ ูุฅุทุงุฑ ุงูุนุจุงุฑุฉ ููุง ุจูุงุณุทุฉ ุงูุฌุงูุงุณูุฑุจุช -->
            </div>

            <!-- (ุชุนุฏูู) ุชูุช ุฅุฒุงูุฉ ุงูุญุงููุฉ ุงูุซุงุจุชุฉ ููุนุจุงุฑุฉ ูุฃููุง ุณุชุถุงู ุฏุงุฎู ุงูุดุจูุฉ -->
        </div>
    </div>


    <!-- ุดุงุดุฉ ุดุฑุญ ุฃููุงุน ุงูุฃูุธูุฉ (info-modal) -->
    <div id="info-modal" class="modal-overlay" style="z-index: 60;"> 
        <div class="modal-content" style="width: 480px;"> 
            <h3 class="text-lg font-bold text-blue-700 mb-2 text-center">
                ุดุฑุญ ุฃููุงุน ุงูุฃูุธูุฉ
            </h3>
            <p class="text-xs text-center text-gray-600 mb-3 px-1">ุนูุฏ ููุงุฑูุฉ ูุนุงุฏูุชูู (ุจุนุฏ ูุถุนููุง ุจุตูุบุฉ ุงูููู ูุงูููุทุน ุต = ู ุณ + ุจ):</p>
            
            <div class="space-y-2 text-gray-700 text-sm text-right">
                <!-- 1. ูุชุณู ููุณุชูู -->
                <div class="border border-blue-200 bg-blue-50 p-2 rounded-lg">
                    <p class="font-bold text-blue-600 text-base">ูก. ูุชุณู ููุณุชูู: <span class="font-normal">ูุญุฏุซ ุนูุฏูุง ูููู</span> ุงูููู ูุฎุชููุงู.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                        ู<sub>ูก</sub> โ ู<sub>ูข</sub>
                    </div>
                    <p class="text-xs">ุงููุชูุฌุฉ: ุงููุณุชูููุงู <span class="font-bold">ูุชูุงุทุนุงู</span> ูู ููุทุฉ ูุงุญุฏุฉ (ุญู ูุญูุฏ).</p>
                </div>
                <!-- 2. ุบูุฑ ูุชุณู -->
                <div class="border border-red-200 bg-red-50 p-2 rounded-lg">
                    <p class="font-bold text-red-600 text-base">ูข. ุบูุฑ ูุชุณู: <span class="font-normal">ูุญุฏุซ ุนูุฏูุง ูููู</span> ุงูููู ูุชุณุงููุงู <span class="font-normal">ูุงูููุทุน ุงูุตุงุฏู (ุจ)</span> ูุฎุชููุงู.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                        ู<sub>ูก</sub> = ู<sub>ูข</sub>  ,  ุจ<sub>ูก</sub> โ ุจ<sub>ูข</sub>
                    </div>
                    <p class="text-xs">ุงููุชูุฌุฉ: ุงููุณุชูููุงู <span class="font-bold">ูุชูุงุฒูุงู</span> (ูุง ููุฌุฏ ุญู).</p>
                </div>
                <!-- 3. ูุชุณู ูุบูุฑ ูุณุชูู -->
                <div class="border border-green-200 bg-green-50 p-2 rounded-lg">
                    <p class="font-bold text-green-600 text-base">ูฃ. ูุชุณู ูุบูุฑ ูุณุชูู: <span class="font-normal">ูุญุฏุซ ุนูุฏูุง ูููู</span> ุงูููู ูุชุณุงููุงู <span class="font-normal">ูุงูููุทุน ุงูุตุงุฏู (ุจ)</span> ูุชุณุงููุงู.</p>
                    <div class="equation-font text-gray-700 py-1" dir="ltr">
                         ู<sub>ูก</sub> = ู<sub>ูข</sub>  ,  ุจ<sub>ูก</sub> = ุจ<sub>ูข</sub>
                    </div>
                    <p class="text-xs">ุงููุชูุฌุฉ: <span class="font-bold">ููุณ ุงููุณุชููู</span> (ุนุฏุฏ ูุง ููุงุฆู ูู ุงูุญููู).</p>
                </div>
            </div>
            <!-- ุชู ุชุนุฏูู ูุฐุง ุงูุฒุฑุ ุณูุชู ุฅุฎูุงุคู ูุฅุธูุงุฑู ุญุณุจ ุงูุญุงุฌุฉ -->
            <button id="close-info-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ูููุชุ ูุชุงุจุนุฉ!
            </button>
        </div>
    </div>


    <!-- ุดุงุดุฉ ุชุฃููุฏ ุฅุนุงุฏุฉ ุงููุณุชูู -->
    <div id="replay-confirm-modal" class="modal-overlay" style="z-index: 85;">
        <div class="modal-content text-center" style="width: 300px;">
            <h3 class="text-xl font-bold text-yellow-700 mb-3">
                ุฅุนุงุฏุฉ ุงููุณุชูู
            </h3>
            <p class="text-gray-700 mb-5">
                ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุฅุนุงุฏุฉ ูุฐุง ุงููุณุชููุ<br>
                <!-- (ุชุนุฏูู) ุชุบููุฑ ุงููุต ููุนูุณ ุงููุงุนุฏุฉ ุงูุฌุฏูุฏุฉ -->
                <span class="text-sm text-gray-500">ุณูุชู ุชุณุฌูู ุฏุฑุฌุชู ุงูุฌุฏูุฏุฉ ุจุฏูุงู ูู ุงููุฏููุฉ (ุญุชู ูู ูุงูุช ุฃูู).</span>
            </p>
            <div class="flex justify-center gap-4">
                <button id="confirm-replay-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-8 rounded-lg transition duration-200">
                    ูุนูุ ุฃุนุฏ
                </button>
                <button id="cancel-replay-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg transition duration-200">
                    ุฅูุบุงุก
                </button>
            </div>
        </div>
    </div>

    <!-- (ุฌุฏูุฏ) ุดุงุดุฉ ุงูุงุฎุชูุงุฑ ุจุนุฏ ุฅููุงุก ุงููุนุจุฉ -->
    <div id="post-game-modal" class="modal-overlay" style="z-index: 84;">
        <div class="modal-content text-center" style="width: 300px;">
            <h3 class="text-2xl font-bold text-green-600 mb-3">
                ๐ ุฃุญุณูุช! ๐
            </h3>
            <p class="text-gray-700 mb-6 text-lg">
                ููุฏ ุฃูููุช ุฌููุน ุงููุณุชููุงุช ุจูุฌุงุญ!
            </p>
            <div class="flex flex-col gap-3">
                <button id="show-result-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 text-base">
                    ุนุฑุถ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ูุณุฌู ุงูุฃุจุทุงู
                </button>
                <button id="improve-score-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 text-base">
                    ุงูุนูุฏุฉ ูุชุญุณูู ุฏุฑุฌุงุชู
                </button>
            </div>
        </div>
    </div>


    <!-- ุดุงุดุฉ ุฅุธูุงุฑ ุงูููุงุท ุงูููุชุณุจุฉ (score-modal) -->
    <div id="score-modal" class="modal-overlay" style="z-index: 70;">
        <div class="modal-content text-center">
            <h3 id="score-title" class="text-2xl font-bold text-green-600 mb-2">ุฃุญุณูุช!</h3>
            <p id="points-earned-text" class="text-4xl font-bold text-blue-700 mb-4 equation-font">+ูกู ููุงุท</p>
            <div class="border-t pt-4 mt-4 space-y-2 text-sm sm:text-base text-gray-600">
                <p id="current-question-text">ุงูุณุคุงู: ูก / ูฃ</p>
                <p id="total-score-text">ุงูููุงุท ูู ุงููุณุชูู: ูกู</p>
            </div>
            <button id="continue-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ูุชุงุจุนุฉ
            </button>
        </div>
    </div>

    <!-- ุดุงุดุฉ ุดุฑุญ ุงูุญู -->
    <div id="solution-modal" class="modal-overlay" style="z-index: 75;">
        <!-- (ุชุนุฏูู) ุชู ุชุตุบูุฑ ุงูุนุฑุถ ููููุงู -->
        <div class="modal-content text-right" style="width: 420px;">
            <h3 class="text-xl font-bold text-blue-700 mb-3 text-center">
                ุดุฑุญ ุฎุทูุงุช ุงูุญู
            </h3>
            <!-- (ุชุนุฏูู) ุชูุช ุฅุถุงูุฉ ุงููุฒูุงู ููุง -->
            <div id="solution-content" class="space-y-3 text-gray-700">
                <!-- ุณูุชู ููุก ุงูุดุฑุญ ููุง -->
            </div>
            <button id="close-solution-btn" class="mt-5 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                ูููุช
            </button>
        </div>
    </div>


    <!-- ุดุงุดุฉ ุงูููุงูุฉ (end-game-screen) -->
    <div id="end-game-screen" class="container max-w-lg w-full mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-xl flex-col items-center justify-center text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-700 mb-4">
            ุฃูููุช ูู ุงููุณุชููุงุช!
        </h1>
        <p class="text-lg text-gray-700 mb-4">
            ููุฏ ุฃูููุช ุฌููุน ุงูุชุญุฏูุงุช ุจูุฌุงุญุ ุฃุญุณูุช ูุง ุจุทู!
        </p>
        <p class="text-base text-gray-500 mb-6">
            ุฅุนุฏุงุฏ: ุงูุฃุณุชุงุฐ ุนุจุฏุงูุนุฒูุฒ ุงูุนุจูุงู
        </p>
        <div id="final-result-display" class="my-4 p-4 bg-gray-100 rounded-lg w-full">
            <!-- ุณูุชู ุงูุชุนุจุฆุฉ ุนูุฏ ููุงูุฉ ุงููุนุจุฉ -->
        </div>
        <div id="leaderboard-loader" class="my-4" style="display: none;">
            <p class="text-blue-500">ูุชู ุชุญููู ุณุฌู ุงูุฃุจุทุงู...</p>
        </div>
        <div id="leaderboard-container" class="w-full">
            <!-- ุณูุชู ุชุนุจุฆุฉ ุณุฌู ุงูุฃุจุทุงู ููุง -->
        </div>
        <div id="finish-game-wrapper" class="mt-8" style="display: none;">
            <button id="finish-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200">
                ุงูุนูุฏุฉ ุฅูู ุงูููุตุฉ
            </button>
            <button onclick="location.reload()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200 ml-2">
                ุงูุนุจ ูุฑุฉ ุฃุฎุฑู
            </button>
             <!-- (ุชุนุฏูู) ุฅุนุงุฏุฉ ุฒุฑ ุงูุนูุฏุฉ ูููุณุชููุงุช -->
             <button id="back-to-levels-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg text-lg shadow-md transition duration-200 mt-3 w-full">
                ุงูุนูุฏุฉ ูุงุฎุชูุงุฑ ุงููุณุชููุงุช
            </button>
        </div>
    </div>

    <!-- ุญุงููุฉ ุงููุนุจุฉ (game-container) -->
    <div id="game-container" class="container max-w-xl w-full mx-auto bg-white p-4 sm:p-5 rounded-xl shadow-xl flex-col hidden">
        
        <div class="flex-shrink-0 mb-3 p-3 bg-gray-50 rounded-lg shadow-inner text-center">
            
            <div class="flex items-center justify-between gap-2 mb-2">
                 <button id="back-to-menu-btn" title="ุงูุนูุฏุฉ ููุงุฆูุฉ ุงููุณุชููุงุช" class="w-8 h-8 bg-red-100 text-red-700 rounded-full flex items-center justify-center font-bold text-lg transition hover:bg-red-200">
                    &#x2715;
                 </button>
                 <h2 id="question-text" class="text-base sm:text-lg font-semibold text-gray-800 text-center">
                     <!-- ุณูุชู ุชุญุฏูุซ ูุต ุงูุณุคุงู ููุง -->
                 </h2>
                 <button id="info-btn" title="ุดุฑุญ ุฃููุงุน ุงูุฃูุธูุฉ" class="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-lg transition hover:bg-blue-200">
                     โน๏ธ
                 </button>
            </div>
            
            
            <div class="equations-box">
                <span id="equation1" class="equation-font text-blue-600 bg-white px-3 py-1 rounded-md border border-blue-200"></span>
                <span class="text-gray-500 font-bold text-lg">ู</span>
                <span id="equation2" class="equation-font text-purple-600 bg-white px-3 py-1 rounded-md border border-purple-200"></span>
            </div>
        </div>

        <!-- ุญุงููุฉ ุงูุฎูุงุฑุงุช -->
        <div class="flex-grow min-h-0 mb-3 px-1"> 
            <div id="options-container" class="choices-grid-3"> 
                <!-- ุณูุชู ุชุนุจุฆุฉ ุงูุฎูุงุฑุงุช ููุง -->
            </div>
        </div>
        
        <!-- ุงูุฃุฒุฑุงุฑ ูุงููุชูุฌุฉ -->
        <div class="flex-shrink-0 text-center">
            <div id="feedback" class="h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold"></div>
            
            <button id="check-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200">
                ุชุญูู ูู ุงูุฅุฌุงุจุฉ
            </button>
            <button id="next-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 hidden">
                ุงูุณุคุงู ุงูุชุงูู
            </button>
            <!-- ุฒุฑ ุงุนุฑู ููุงุฐุงุ -->
            <button id="show-solution-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 ml-2 hidden">
                ุงุนุฑู ููุงุฐุงุ
            </button>
            <button id="reset-choices-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-lg text-sm sm:text-lg shadow-md transition duration-200 ml-2">
                ูุณุญ ุงูุงุฎุชูุงุฑ
            </button>
        </div>
    </div>

    <!-- ุฃููููุงุช SVG ููุญูู (ุฌุฏูุฏ) -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <symbol id="icon-lock" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
            </symbol>
            <symbol id="icon-replay" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.755l-.091-.454A6.5 6.5 0 002.5 12.5a6.5 6.5 0 0011.603 4.475l.894.447A7.5 7.5 0 014.28 18.179a.75.75 0 011.04-1.082l.006.003a5.5 5.5 0 019.986-3.676l.091.454A6.5 6.5 0 0017.5 7.5a6.5 6.5 0 00-11.603-4.475l-.894-.447A7.5 7.5 0 0115.72 1.821a.75.75 0 01-1.04 1.082l-.006-.003a5.5 5.5 0 01-4.688 8.524l.003-.001.002.001z" clip-rule="evenodd" />
            </symbol>
            <!-- (ุฌุฏูุฏ) ุฃููููุฉ ุงููุฃุณ (ูู ุฃุณุชุฎุฏููุง ูุฃู ุงูุฅูููุฌู ุฃูุถุญ) -->
        </defs>
    </svg>

    <script>
        // --- ุฏุงูุฉ ุชูุณูู ุงูุฃุฑูุงู ูุงููุนุงุฏูุงุช ---
        const arabicNumerals = ['ู', 'ูก', 'ูข', 'ูฃ', 'ูค', 'ูฅ', 'ูฆ', 'ูง', 'ูจ', 'ูฉ'];
        
        function toArabicNumerals(num) {
            if (num === null || num === undefined) return '';
            let str = String(num);
            let result = '';
            for (let i = 0; i < str.length; i++) {
                if (str[i] === '-') {
                    result += '\u200E-'; // ุนูุงูุฉ ุงูุชุญูู ุจุงูุงุชุฌุงู
                } else if (/\d/.test(str[i])) {
                    result += arabicNumerals[parseInt(str[i])];
                } else {
                    result += str[i];
                }
            }
            return result;
        }

        function formatEquation(equation, showOne = false) { 
            let formatted = String(equation);
            
            if (!showOne) {
                formatted = formatted.replace(/=\s*1x/g, '= x');
                formatted = formatted.replace(/\(\s*1x/g, '(x');
                formatted = formatted.replace(/=\s*-1x/g, '= -x');
                formatted = formatted.replace(/\(\s*-1x/g, '(-x');
                 formatted = formatted.replace(/= -x/g, '= \u200E-ุณ'); 
            } else {
                 formatted = formatted.replace(/=\s*-x/g, '= -1x'); 
                 formatted = formatted.replace(/\(\s*-x/g, '(-1x');
                formatted = formatted.replace(/=\s*x/g, '= 1x'); 
                 formatted = formatted.replace(/\(\s*x/g, '(1x');
            }
            
            // (ุชุนุฏูู) ุฅุฎูุงุก + 0 ุฃู - 0
            formatted = formatted.replace(/\+\s*0$/, ''); // "y = 3x + 0" -> "y = 3x"
            formatted = formatted.replace(/\-\s*0$/, ''); // "y = 3x - 0" -> "y = 3x"

            formatted = formatted.replace(/\((-?\d+)\/(\d+)\)/g, (match, num, den) => {
                const numArabic = toArabicNumerals(num);
                const denArabic = toArabicNumerals(den);
                return `<span class="fraction"><span class="numerator">${numArabic}</span><span class="denominator">${denArabic}</span></span>`;
            });
            
            formatted = formatted.replace(/-?\d+/g, (match) => {
                if (match.includes('<')) return match; 
                return toArabicNumerals(match);
            });
            
            // (ุชุนุฏูู) ุฅุฎูุงุก + ู ุฃู - ู (ุจุนุฏ ุชุญููู ุงูุฃุฑูุงู)
            const zero = arabicNumerals[0];
            formatted = formatted.replace(new RegExp(`\\s*\\+\\s*${zero}(\\s|$)`), ' ');
            formatted = formatted.replace(new RegExp(`\\s*\\-\\s*${zero}(\\s|$)`), ' ');
            
            formatted = formatted.replace(/x/g, 'ุณ').replace(/y/g, 'ุต');

             formatted = formatted.replace(/=\s*(\u200E-)/g, '=$1'); 
             formatted = formatted.replace(/\(\s*(\u200E-)/g, '($1');

             formatted = formatted.replace(new RegExp(toArabicNumerals('-') + 'ุณ', 'g'), '\u200E-ุณ');

            formatted = formatted.replace(/(\d*)ุณ\s*-\s*(\d*)ุต/g, (match, a, b) => `${a || ''}ุณ \u200E- ${b || ''}ุต`); 

            formatted = formatted.replace(/ \+ /g, ' \u200E+\u200E ');
            formatted = formatted.replace(/ \- /g, ' \u200E-\u200E ');

            return formatted.trim(); // (ุฌุฏูุฏ) ุฅุฒุงูุฉ ุฃู ูุณุงูุงุช ุฒุงุฆุฏุฉ ูู ุงูููุงูุฉ
        }
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GAME_ID = 'g5_1_1'; // (ุชุนุฏูู) ุชุนุฑูู ุซุงุจุช GAME_ID ูุญููุงู
            const GAME_MAX_POINTS = 100; // (ุชุนุฏูู) ุชุนุฑูู ุซุงุจุช GAME_MAX_POINTS ูุญููุงู

            // --- ุจูู ุงูุฃุณุฆูุฉ ุงูุดุงูู (ูุน ุงูุชูููุญุงุช) ---
            const hint_slope = "ูุงุญุธ ุงูููู (ู). ูู ูู ูุชุณุงูู ุฃู ูุฎุชููุ";
            const hint_intercept = "ุงูููู ูุชุณุงูู. ูุงุฐุง ุนู ุงูููุทุน ุงูุตุงุฏู (ุจ)ุ";
            
            const questionBank = {
                // --- ุงููุณุชูู ุงูุณูู (9 ุฃุณุฆูุฉ) ---
                easy: [
                    { eq1: "y = 2x + 1", m1: 2, b1: 1, eq2: "y = 2x - 3", m2: 2, b2: -3, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "y = -1x + 4", m1: -1, b1: 4, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = 1x + 5", m1: 1, b1: 5, eq2: "y = 1x + 5", m2: 1, b2: 5, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = -4x + 1", m1: -4, b1: 1, eq2: "y = -4x + 1", m2: -4, b2: 1, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y = 1x - 3", m1: 1, b1: -3, eq2: "y = 1x + 4", m2: 1, b2: 4, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "y = 5x + 0", m1: 5, b1: 0, eq2: "y = -1x + 0", m2: -1, b2: 0, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = (1/2)x + 1", m1: 0.5, b1: 1, eq2: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "y = -2x + 7", m1: -2, b1: 7, eq2: "y = -2x + 7", m2: -2, b2: 7, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept }
                ],
                // --- ุงููุณุชูู ุงููุชูุณุท (9 ุฃุณุฆูุฉ) ---
                medium: [
                    { eq1: "y = 4x - 5", m1: 4, b1: -5, eq2: "3x + y = 2", eq2_simple: "y = -3x + 2", m2: -3, b2: 2, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = -2x + 4", m1: -2, b1: 4, eq2: "2x + y = 1", eq2_simple: "y = -2x + 1", m2: -2, b2: 1, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "y = 1x + 3", m1: 1, b1: 3, eq2: "x - y = -3", eq2_simple: "y = 1x + 3", m2: 1, b2: 3, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "x + y = 5", eq1_simple: "y = -1x + 5", m1: -1, b1: 5, eq2: "y = -1x + 2", m2: -1, b2: 2, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "2x - y = 1", eq1_simple: "y = 2x - 1", m1: 2, b1: -1, eq2: "y = 3x + 0", m2: 3, b2: 0, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "6x + 2y = 8", eq1_simple: "y = -3x + 4", m1: -3, b1: 4, eq2: "y = -3x + 4", m2: -3, b2: 4, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y = 5x - 1", m1: 5, b1: -1, eq2: "10x - 2y = 2", eq2_simple: "y = 5x - 1", m2: 5, b2: -1, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y = 1x - 6", m1: 1, b1: -6, eq2: "4x + y = 9", eq2_simple: "y = -4x + 9", m2: -4, b2: 9, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = -1x + 7", m1: -1, b1: 7, eq2: "3x + 3y = 1", eq2_simple: "y = -1x + (1/3)", m2: -1, b2: 1/3, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept }
                ],
                // --- ุงููุณุชูู ุงูุตุนุจ (12 ุณุคุงูุงู) ---
                hard: [
                    { eq1: "2x + y = 6", eq1_simple: "y = -2x + 6", m1: -2, b1: 6, eq2: "x + y = 4", eq2_simple: "y = -1x + 4", m2: -1, b2: 4, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y + 4 = -2(x - 1)", eq1_simple: "y = -2x - 2", m1: -2, b1: -2, eq2: "y = -2x + 1", m2: -2, b2: 1, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "2y = 6x + 4", eq1_simple: "y = 3x + 2", m1: 3, b1: 2, eq2: "y = 3x + 2", m2: 3, b2: 2, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "x - 3y = 6", eq1_simple: "y = (1/3)x - 2", m1: 1/3, b1: -2, eq2: "y = (1/3)x + 1", m2: 1/3, b2: 1, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "y - 2 = 3(x - 1)", eq1_simple: "y = 3x - 1", m1: 3, b1: -1, eq2: "y + 1 = 3(x + 1)", eq2_simple: "y = 3x + 2", m2: 3, b2: 2, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "x + 2y = 4", eq1_simple: "y = (-1/2)x + 2", m1: -0.5, b1: 2, eq2: "3x - y = 5", eq2_simple: "y = 3x - 5", m2: 3, b2: -5, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "4x - 2y = 8", eq1_simple: "y = 2x - 4", m1: 2, b1: -4, eq2: "y = 2x - 4", m2: 2, b2: -4, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y - 5 = 2(x - 1)", eq1_simple: "y = 2x + 3", m1: 2, b1: 3, eq2: "y - 1 = -1(x - 4)", eq2_simple: "y = -1x + 5", m2: -1, b2: 5, answer: "ูุชุณู ููุณุชูู", hint: hint_slope },
                    { eq1: "y = (1/2)x - 1", m1: 0.5, b1: -1, eq2: "2x - 4y = 4", eq2_simple: "y = (1/2)x - 1", m2: 0.5, b2: -1, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "3x + 3y = 9", eq1_simple: "y = -1x + 3", m1: -1, b1: 3, eq2: "x + y = 3", eq2_simple: "y = -1x + 3", m2: -1, b2: 3, answer: "ูุชุณู ูุบูุฑ ูุณุชูู", hint: hint_intercept },
                    { eq1: "y = (2/3)x + 1", m1: 2/3, b1: 1, eq2: "3y = 2x - 6", eq2_simple: "y = (2/3)x - 2", m2: 2/3, b2: -2, answer: "ุบูุฑ ูุชุณู", hint: hint_intercept },
                    { eq1: "5x - y = 0", eq1_simple: "y = 5x + 0", m1: 5, b1: 0, eq2: "x + y = 6", eq2_simple: "y = -1x + 6", m2: -1, b2: 6, answer: "ูุชุณู ููุณุชูู", hint: hint_slope }
                ]
            };
            
            const gameChoices = ["ูุชุณู ููุณุชูู", "ูุชุณู ูุบูุฑ ูุณุชูู", "ุบูุฑ ูุชุณู"];
            const motivationalQuotes = [
                "ูููุง ุชุฏุฑุจุช ุฃูุซุฑุ ุฃุตุจุญุช ุฃููู!",
                "ูุง ุชุชูููุ ุฃูุช ุนูู ูุดู ุชุญููู ุฅูุฌุงุฒ ุฑุงุฆุน!",
                "ุงูุฑูุงุถูุงุช ููุชุนุฉุ ุงุณุชูุฑ ูู ุงูุชุญุฏู!",
                "ููููู ุชุญููู ุฏุฑุฌุฉ ุฃูุถูุ ุญุงูู ูุฑุฉ ุฃุฎุฑู!",
                "ุฃูุช ุจุทู ุงูุฑูุงุถูุงุช ุงููุงุฏู!"
            ];

            // --- ูุชุบูุฑุงุช ุญุงูุฉ ุงููุนุจุฉ ---
            const APP_STORAGE_KEY = `linearGameProgress_${GAME_ID}`;
            
            // (ุชุนุฏูู) ูููู ุงูุชูุฏู ูุฎุฒู ุงูููุงุท (30ุ 30ุ 40) ุจุฏูุงู ูู ุนุฏุฏ ุงูุฅุฌุงุจุงุช
            const defaultProgress = {
                easy: { score: -1, total: 30, questions: 3, unlocked: true },
                medium: { score: -1, total: 30, questions: 3, unlocked: false },
                hard: { score: -1, total: 40, questions: 4, unlocked: false }
            };
            let playerProgress = { ...defaultProgress };

            // ูุชุบูุฑุงุช ุงููุณุชูู ุงูุญุงูู
            let currentLevelName = 'easy'; 
            let currentLevelQuestions = []; 
            let currentQuestionIndex = 0; 
            
            // ูุชุบูุฑุงุช ุงูููุงุท
            let currentLevelScore = 0; // (ุชุนุฏูู) ูุฎุฒู 10 ุฃู 5 ุฃู 0
            let lastPointsEarned = 0; // (10, 5, 0)
            
            // (ุฌุฏูุฏ) ูุชุบูุฑ ุงููุญุงููุฉ ุงูุซุงููุฉ
            let isSecondTry = false; 

            // ูุชุบูุฑุงุช ุงููุนุจุฉ ุงูุฅุฌูุงููุฉ (ูููุญุฉ ุงูุฃุจุทุงู)
            let totalGameErrors = 0; // ูุฌููุน ุงูุฃุฎุทุงุก (ุจุนุฏ ุงููุญุงููุฉ ุงูุซุงููุฉ)

            
            // --- ุนูุงุตุฑ ุงููุงุฌูุฉ ---
            const welcomeModal = document.getElementById('welcome-modal');
            const showLevelsBtn = document.getElementById('show-levels-btn');
            const levelSelectModal = document.getElementById('level-select-modal');
            const levelsContainer = document.getElementById('levels-container'); // (ุชุนุฏูู) ุชู ุชุตุญูุญ ID
            // const quoteEl = document.getElementById('motivational-quote'); // (ุชุนุฏูู) ุณูุชู ุฅูุดุงุคู
            // const quoteContainer = document.getElementById('quote-container'); // (ุชุนุฏูู) ุณูุชู ุฅูุดุงุคู
            const showLeaderboardBtn = document.getElementById('show-leaderboard-btn'); // (ุฌุฏูุฏ)

            const replayConfirmModal = document.getElementById('replay-confirm-modal');
            const confirmReplayBtn = document.getElementById('confirm-replay-btn');
            const cancelReplayBtn = document.getElementById('cancel-replay-btn');
            let levelToReplay = null; 

            // (ุฌุฏูุฏ) ูุงูุฐุฉ ูุง ุจุนุฏ ุงููุนุจุฉ
            const postGameModal = document.getElementById('post-game-modal');
            const showResultBtn = document.getElementById('show-result-btn');
            const improveScoreBtn = document.getElementById('improve-score-btn');

            const endGameScreen = document.getElementById('end-game-screen');
            const gameContainer = document.getElementById('game-container');
            const backToLevelsBtn = document.getElementById('back-to-levels-btn'); // (ุฌุฏูุฏ)
            
            const equation1El = document.getElementById('equation1');
            const equation2El = document.getElementById('equation2');
            const optionsContainer = document.getElementById('options-container');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackEl = document.getElementById('feedback');
            const resetChoicesBtn = document.getElementById('reset-choices-btn');
            const questionTextEl = document.getElementById('question-text');
            const infoModal = document.getElementById('info-modal');
            const infoBtn = document.getElementById('info-btn');
            const closeInfoBtn = document.getElementById('close-info-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            
            const solutionModal = document.getElementById('solution-modal');
            const solutionContentEl = document.getElementById('solution-content');
            const closeSolutionBtn = document.getElementById('close-solution-btn');
            const showSolutionBtn = document.getElementById('show-solution-btn');

            // ููุงูุฐ ุงูููุงุท
            const scoreModal = document.getElementById('score-modal');
            const scoreTitle = document.getElementById('score-title');
            const pointsEarnedText = document.getElementById('points-earned-text');
            const continueBtn = document.getElementById('continue-btn');
            const currentQuestionText = document.getElementById('current-question-text');
            const totalScoreText = document.getElementById('total-score-text');

            // --- ุฏูุงู ุญูุธ ูุชุญููู ุงูุชูุฏู ---
            function loadProgress() {
                const savedProgress = localStorage.getItem(APP_STORAGE_KEY);
                if (savedProgress) {
                    playerProgress = JSON.parse(savedProgress);
                    // ุงูุชุฃูุฏ ูู ุฃู ุงููููู ูุชูุงูู
                    if (!playerProgress.easy || !playerProgress.easy.questions) {
                        playerProgress = { ...defaultProgress };
                        saveProgress();
                    }
                } else {
                    playerProgress = { ...defaultProgress };
                    saveProgress();
                }
            }

            function saveProgress() {
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(playerProgress));
            }

            // --- ุฏูุงู ุงูููุงูุฐ ุงูููุจุซูุฉ (Modal) ---
            function showModal(modal) {
                if(modal) modal.classList.add('show');
            }
            function hideModal(modal) {
                if(modal) modal.classList.remove('show');
            }
            
            function hideAllScreens() {
                hideModal(welcomeModal);
                hideModal(levelSelectModal);
                hideModal(scoreModal);
                hideModal(infoModal);
                hideModal(replayConfirmModal);
                hideModal(solutionModal);
                hideModal(postGameModal); // (ุฌุฏูุฏ)
                gameContainer.classList.add('hidden');
                endGameScreen.classList.add('hidden');
                endGameScreen.classList.remove('flex');
                gameContainer.classList.remove('flex');
            }

            // --- ุฏูุงู ูุงุฆูุฉ ุงููุณุชููุงุช ---
            function showWelcomeModal() {
                hideAllScreens();
                showModal(welcomeModal);
            }

            // (ุชุนุฏูู) ุฅุธูุงุฑ ุฒุฑ ุงููุฃุณ ุฅุฐุง ุงูุชูู ุงููุณุชูู ุงูุตุนุจ
            function showLevelSelectModal() {
                hideAllScreens();
                renderLevelButtons();
                
                // (ุชุนุฏูู) ุงูุนุจุงุฑุฉ ุงูุชุญููุฒูุฉ ุชููุดุฃ ูุชูุถุงู ูุนูุตุฑ ุฑุงุจุน ูู ุงูุดุจูุฉ
                const quoteContainer = document.createElement('div');
                quoteContainer.id = 'quote-container';
                // (ุชุนุฏูู) ุชูุณูู ุฅุทุงุฑ ุงูุนุจุงุฑุฉ ููุดุจู ุงูุฃุฒุฑุงุฑ ูู ุงูุงุฑุชูุงุน
                quoteContainer.className = "p-2 bg-gray-50 rounded-lg border border-gray-200 text-center flex items-center justify-center min-h-[80px]";
                
                const quoteEl = document.createElement('p');
                quoteEl.id = 'motivational-quote';
                quoteEl.className = "text-xs text-gray-600 font-medium leading-tight"; // (ุชุนุฏูู) leading-tight ูููุต
                quoteEl.innerHTML = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                
                quoteContainer.appendChild(quoteEl);
                
                // (ูุงู) ุฅุถุงูุฉ ุงูุนุจุงุฑุฉ ุฅูู ุญุงููุฉ ุงููุณุชููุงุช ูุชููู ุงูุนูุตุฑ ุงูุฑุงุจุน ูู ุงูุดุจูุฉ
                levelsContainer.appendChild(quoteContainer); 
                
                // (ุฌุฏูุฏ) ุฅุธูุงุฑ ุฒุฑ ุงููุฃุณ
                if (playerProgress.hard.score > -1) {
                    showLeaderboardBtn.classList.remove('hidden');
                } else {
                    showLeaderboardBtn.classList.add('hidden');
                }

                showModal(levelSelectModal);
            }

            // (ุชุนุฏูู) ุฏุงูุฉ ุฑุณู ุฃุฒุฑุงุฑ ุงููุณุชููุงุช (ูุนุฑุถ ุงูููุงุท)
            function renderLevelButtons() {
                levelsContainer.innerHTML = '';
                const levels = [
                    { id: 'easy', name: 'ุงููุณุชูู ุงูุณูู', icon: '๐' },
                    { id: 'medium', name: 'ุงููุณุชูู ุงููุชูุณุท', icon: '๐ค' },
                    { id: 'hard', name: 'ุงููุณุชูู ุงูุตุนุจ', icon: '๐ง' }
                ];

                levels.forEach(level => {
                    const progress = playerProgress[level.id];
                    const button = document.createElement('button');
                    button.classList.add('level-button');

                    let scoreText = '';
                    let iconHTML = '';

                    if (progress.unlocked) {
                        if (progress.score > -1) {
                            // ุงููุณุชูู ููุชูู (ูุนุฑุถ ุงูููุงุท)
                            button.classList.add('completed');
                            scoreText = `ุงูุฏุฑุฌุฉ: ${toArabicNumerals(progress.score)} / ${toArabicNumerals(progress.total)}`;
                            iconHTML = `<svg class="replay-icon"><use href="#icon-replay"></use></svg>`;
                            button.onclick = () => {
                                levelToReplay = level.id; 
                                showModal(replayConfirmModal); 
                            };
                        } else {
                            // ุงููุณุชูู ููุชูุญ ููููู ูู ููุชูู ุจุนุฏ (ูููุถ)
                            button.classList.add('unlocked', 'glowing');
                            scoreText = 'ุงุถุบุท ููุจุฏุก!';
                            button.onclick = () => startLevel(level.id);
                        }
                    } else {
                        // ุงููุณุชูู ูููู
                        button.classList.add('locked');
                        scoreText = 'ูููู';
                        iconHTML = `<svg class="lock-icon"><use href="#icon-lock"></use></svg>`;
                        button.disabled = true;
                    }

                    button.innerHTML = `
                        ${iconHTML}
                        <span class="level-icon">${level.icon}</span>
                        <span class="level-title">${level.name}</span>
                        <span class="level-score">${scoreText}</span>
                    `;
                    levelsContainer.appendChild(button);
                });
            }

            // --- ุฏูุงู ุจูู ุงูุฃุณุฆูุฉ ---
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // (ุชุนุฏูู) ุงุณุชุฎุฏุงู .questions ูุณุญุจ ุงูุฃุณุฆูุฉ
            function getLevelQuestions(levelName) {
                const bank = [...questionBank[levelName]]; 
                shuffleArray(bank);
                const count = playerProgress[levelName].questions; // (3 ุฃู 4)
                return bank.slice(0, count);
            }

            // --- ุฏูุงู ุจุฏุก ุงููุณุชูู ูุฅููุงุคู ---

            function startLevel(levelName) {
                currentLevelName = levelName;
                currentLevelQuestions = getLevelQuestions(levelName);
                currentQuestionIndex = 0;
                currentLevelScore = 0; // (ุชุนุฏูู) ุงูุจุฏุก ูู 0 ููุทุฉ
                isSecondTry = false; // (ุชุนุฏูู)
                
                hideAllScreens();
                gameContainer.classList.remove('hidden');
                gameContainer.classList.add('flex');
                
                loadProblem(currentQuestionIndex);
            }

            // (ูุนุฏู) ุชุญููู ุงูุณุคุงู
            function loadProblem(index) {
                resetChoices(); // (ุชุนุฏูู) resetChoices ูุชุถูู ุงูุขู isSecondTry = false
                feedbackEl.textContent = '';
                feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold';
                
                lastPointsEarned = 0;
                
                const problem = currentLevelQuestions[index];
                
                equation1El.innerHTML = formatEquation(problem.eq1, false); 
                equation2El.innerHTML = formatEquation(problem.eq2, false); 
                
                const levelNameArabic = (currentLevelName === 'easy' ? 'ุงูุณูู' : currentLevelName === 'medium' ? 'ุงููุชูุณุท' : 'ุงูุตุนุจ');
                const totalInLevel = currentLevelQuestions.length;
                questionTextEl.innerHTML = `ุงููุณุชูู ${levelNameArabic}: (${toArabicNumerals(index + 1)}/${toArabicNumerals(totalInLevel)})`;

                optionsContainer.innerHTML = '';
                
                const shuffledChoices = [...gameChoices];
                shuffleArray(shuffledChoices);

                shuffledChoices.forEach(choiceText => {
                    const choiceEl = document.createElement('button');
                    choiceEl.classList.add('choice-button');
                    if (choiceText === "ูุชุณู ููุณุชูู") {
                        choiceEl.classList.add('hover:border-blue-500');
                    } else if (choiceText === "ูุชุณู ูุบูุฑ ูุณุชูู") {
                        choiceEl.classList.add('hover:border-green-500');
                    } else {
                        choiceEl.classList.add('hover:border-red-500');
                    }
                    
                    choiceEl.innerHTML = choiceText;
                    choiceEl.dataset.value = choiceText; 
                    
                    choiceEl.addEventListener('click', () => {
                        toggleChoice(choiceEl);
                    });

                    optionsContainer.appendChild(choiceEl);
                });

                checkBtn.classList.remove('hidden');
                resetChoicesBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                showSolutionBtn.classList.add('hidden');
            }

            // (ุชุนุฏูู ุฌุฐุฑู) ุงูุชุญูู ูู ุงูุฅุฌุงุจุฉ (ูุฏุนู ุงููุญุงููุฉ ุงูุซุงููุฉ)
            function checkAnswer() {
                const problem = currentLevelQuestions[currentQuestionIndex];
                const selectedChoiceEl = optionsContainer.querySelector('.choice-button.selected');
                
                if (!selectedChoiceEl) {
                    feedbackEl.textContent = 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุฅุฌุงุจุฉ ุฃููุงู.';
                    feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-red-600';
                    return;
                }

                const selectedAnswer = selectedChoiceEl.dataset.value;
                const correctAnswer = problem.answer;
                let isCorrect = (selectedAnswer === correctAnswer);

                if (isCorrect) {
                    // --- ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ ---
                    feedbackEl.textContent = `ููุชุงุฒ! ุฅุฌุงุจุฉ ุตุญูุญุฉ.`;
                    feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-green-600';
                    selectedChoiceEl.classList.add('correct');
                    
                    if (isSecondTry) {
                        currentLevelScore += 5; // ูุตู ุงูุฏุฑุฌุฉ
                        lastPointsEarned = 5;
                        feedbackEl.textContent += ` (+${toArabicNumerals(5)} ููุงุท)`;
                    } else {
                        currentLevelScore += 10; // ุฏุฑุฌุฉ ูุงููุฉ
                        lastPointsEarned = 10;
                        feedbackEl.textContent += ` (+${toArabicNumerals(10)} ููุงุท)`;
                    }
                    
                    showEndButtons(); // ุฅุธูุงุฑ ุฒุฑ "ุงูุชุงูู" ู "ุงุนุฑู ููุงุฐุง"

                } else {
                    // --- ุงูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ ---
                    selectedChoiceEl.classList.add('incorrect');
                    
                    if (isSecondTry) {
                        // --- ุฎุทุฃ ูู ุงููุญุงููุฉ ุงูุซุงููุฉ (ุงูุฃุฎูุฑุฉ) ---
                        feedbackEl.textContent = 'ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ. ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ุจุงูููู ุงูุฃุฎุถุฑ.';
                        feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-red-600';
                        lastPointsEarned = 0;
                        totalGameErrors++; // ุชุณุฌูู ุงูุฎุทุฃ ุงูุขู
                        
                        // ูุดู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ
                        optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                            if (btn.dataset.value === correctAnswer) {
                                btn.classList.add('correct');
                            }
                        });
                        
                        showEndButtons(); // ุฅุธูุงุฑ ุฒุฑ "ุงูุชุงูู" ู "ุงุนุฑู ููุงุฐุง"
                    } else {
                        // --- ุฎุทุฃ ูู ุงููุญุงููุฉ ุงูุฃููู ---
                        isSecondTry = true;
                        feedbackEl.textContent = `ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ. ุชูููุญ: ${problem.hint}`;
                        feedbackEl.className = 'h-10 sm:h-12 mb-1 text-base sm:text-xl font-bold text-yellow-600'; // ููู ุงูุชูููุญ
                        
                        // ุชุนุทูู ุงูุฎูุงุฑ ุงูุฎุงุทุฆ ููุท
                        selectedChoiceEl.disabled = true;
                        selectedChoiceEl.classList.remove('selected');
                        
                        // ุฅุจูุงุก ุฒุฑ ุงูุชุญูู ูููุญุงููุฉ ุงูุซุงููุฉ ูุฅุฎูุงุก ุฒุฑ ุงููุณุญ
                        checkBtn.classList.remove('hidden');
                        resetChoicesBtn.classList.add('hidden'); // (ุชุนุฏูู) ุฅุฎูุงุก ุฒุฑ ุงููุณุญ ูููุน ุงูุบุด
                        nextBtn.classList.add('hidden');
                    }
                }
            }


            // (ูุนุฏู) ุฅููุงู ุงููุณุชูู (ูุญูุธ ุงูููุงุท)
            function completeLevel() {
                const currentProgress = playerProgress[currentLevelName];
                let isFirstTimeCompletingHard = false;

                // 1. (ุชุนุฏูู) ุชุญุฏูุซ ุงูุฏุฑุฌุฉ ุฏุงุฆูุงู
                // ุงูุชุญูู ุฅุฐุง ูุงูุช ุฃูู ูุฑุฉ ูููู ุงูุตุนุจ (ููุท ููุฑุฉ ูุงุญุฏุฉ)
                if (currentLevelName === 'hard' && currentProgress.score === -1) {
                    isFirstTimeCompletingHard = true;
                }
                // (ุชุนุฏูู) ุชุณุฌูู ุงูุฏุฑุฌุฉ ุงูุฌุฏูุฏุฉ ุฏุงุฆูุงู
                currentProgress.score = currentLevelScore;


                // 2. ูุชุญ ุงููุณุชูู ุงูุชุงูู
                if (currentLevelName === 'easy' && currentProgress.score > -1) { // ุงูุชุฃูุฏ ุฃูู ูุนุจ
                    playerProgress.medium.unlocked = true;
                } else if (currentLevelName === 'medium' && currentProgress.score > -1) {
                    playerProgress.hard.unlocked = true;
                }

                // 3. ุญูุธ ุงูุชูุฏู
                saveProgress();

                // 4. (ุชุนุฏูู) ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุงุฎุชูุงุฑ ุจุนุฏ ุฅููุงุก ุงูุตุนุจ ูุฃูู ูุฑุฉ
                if (isFirstTimeCompletingHard) {
                    hideAllScreens();
                    showModal(postGameModal); 
                } else {
                    // ุงูุนูุฏุฉ ุฅูู ูุงุฆูุฉ ุงููุณุชููุงุช
                    showLevelSelectModal();
                }
            }


            // --- ุฏูุงู ุงููุนุจุฉ ุงูุญุงููุฉ ---
            
            function toggleChoice(choiceEl) {
                optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                   if(btn !== choiceEl) btn.classList.remove('selected');
                });
                choiceEl.classList.toggle('selected');
            }

            // (ุชุนุฏูู) ูุณุญ ุงูุงุฎุชูุงุฑุงุช ูุนูุฏ ุงููุญุงููุฉ ุงูุฃููู
            function resetChoices() {
                optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                    btn.classList.remove('selected', 'correct', 'incorrect');
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
                feedbackEl.textContent = ''; 
                isSecondTry = false; // ุฅุนุงุฏุฉ ุชุนููู ุงููุญุงููุงุช
                showSolutionBtn.classList.add('hidden');
            }

            function showEndButtons() {
                checkBtn.classList.add('hidden');
                resetChoicesBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                showSolutionBtn.classList.remove('hidden');
                 optionsContainer.querySelectorAll('.choice-button').forEach(btn => {
                     btn.disabled = true;
                     btn.style.cursor = 'not-allowed';
                 });
            }

            // (ูุนุฏู) ุฅุธูุงุฑ ูุงูุฐุฉ ุงูููุงุท
            function showPointsModal(points) {
                 const displayPoints = Math.round(points);

                if (displayPoints > 0) {
                    pointsEarnedText.textContent = `+${toArabicNumerals(displayPoints)} ููุทุฉ`;
                    pointsEarnedText.classList.remove('text-red-600');
                    pointsEarnedText.classList.add('text-blue-700');
                    scoreTitle.textContent = (displayPoints === 10) ? 'ููุชุงุฒ!' : 'ุฃุญุณูุช!'; // (ุชุนุฏูู)
                    scoreTitle.classList.add('text-green-600');
                    scoreTitle.classList.remove('text-red-600');
                } else {
                    pointsEarnedText.textContent = `+${toArabicNumerals(0)} ููุทุฉ`;
                    pointsEarnedText.classList.remove('text-blue-700');
                    pointsEarnedText.classList.add('text-red-600');
                    scoreTitle.textContent = 'ูุง ุจุฃุณ!';
                    scoreTitle.classList.remove('text-green-600');
                    scoreTitle.classList.add('text-red-600');
                }
                
                // (ูุนุฏู) ุฅุธูุงุฑ ุงูุชูุฏู ูู ุงููุณุชูู ุงูุญุงูู
                totalScoreText.textContent = `ุงูููุงุท ูู ุงููุณุชูู: ${toArabicNumerals(Math.round(currentLevelScore))}`; 
                currentQuestionText.textContent = `ุงูุณุคุงู: ${toArabicNumerals(currentQuestionIndex + 1)} / ${toArabicNumerals(currentLevelQuestions.length)}`;
                showModal(scoreModal);
            }

            // (ูุนุฏู) ุฏุงูุฉ ุงููุชุงุจุนุฉ
            function handleContinueClick() {
                hideModal(scoreModal);
                
                const nextQuestionInLevel = currentQuestionIndex + 1;

                if (nextQuestionInLevel < currentLevelQuestions.length) {
                    currentQuestionIndex = nextQuestionInLevel;
                    loadProblem(currentQuestionIndex);
                } else {
                    completeLevel();
                }
            }

            // ุฏุงูุฉ ุฅุธูุงุฑ ุดุฑุญ ุงูุญู
            function showSolution() {
                const problem = currentLevelQuestions[currentQuestionIndex];
                
                function formatM(m) {
                    if (m === 0.5) return formatEquation("(1/2)");
                    if (m === -0.5) return formatEquation("(-1/2)");
                    if (m === 1/3) return formatEquation("(1/3)");
                    if (m === 2/3) return formatEquation("(2/3)");
                    return toArabicNumerals(m);
                }
                
                function formatB(b) {
                    if (b === 1/3) return formatEquation("(1/3)");
                    // (ุชุนุฏูู) ูุง ุชุธูุฑ ุงูุตูุฑ
                    if (b === 0) return toArabicNumerals(0);
                    return toArabicNumerals(b);
                }

                let html = '<p>ููููุงุฑูุฉุ ูุญูู ุงููุนุงุฏูุชูู ุฅูู ุตูุบุฉ ุงูููู ูุงูููุทุน (ุต = ู ุณ + ุจ):</p>';
                
                html += '<div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">';
                html += `<p><span class="font-bold">ุงููุนุงุฏูุฉ ูก:</span> <span class="equation-font text-sm">${formatEquation(problem.eq1)}</span></p>`;
                if (problem.eq1_simple) {
                    html += `<p>ุจุฅุนุงุฏุฉ ุชุฑุชูุจูุงุ ุชุตุจุญ: <span class="equation-font text-sm">${formatEquation(problem.eq1_simple)}</span></p>`;
                }
                html += `<p>ุฅุฐู: <span class="font-bold">ุงูููู (ููก) = ${formatM(problem.m1)}</span> , <span class="font-bold">ุงูููุทุน (ุจูก) = ${formatB(problem.b1)}</span></p>`;
                html += '</div>';

                html += '<div class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded-lg">';
                html += `<p><span class="font-bold">ุงููุนุงุฏูุฉ ูข:</span> <span class="equation-font text-sm">${formatEquation(problem.eq2)}</span></p>`;
                if (problem.eq2_simple) {
                    html += `<p>ุจุฅุนุงุฏุฉ ุชุฑุชูุจูุงุ ุชุตุจุญ: <span class="equation-font text-sm">${formatEquation(problem.eq2_simple)}</span></p>`;
                }
                html += `<p>ุฅุฐู: <span class="font-bold">ุงูููู (ููข) = ${formatM(problem.m2)}</span> , <span class="font-bold">ุงูููุทุน (ุจูข) = ${formatB(problem.b2)}</span></p>`;
                html += '</div>';

                html += '<div class="mt-3 pt-3 border-t">';
                let conclusion = '';
                
                const m1_rounded = Math.round(problem.m1 * 1000);
                const m2_rounded = Math.round(problem.m2 * 1000);
                const b1_rounded = Math.round(problem.b1 * 1000);
                const b2_rounded = Math.round(problem.b2 * 1000);

                if (m1_rounded !== m2_rounded) {
                    conclusion = `ุจูุง ุฃู <span class="font-bold">ุงูููู ูุฎุชูู</span> (ููก โ ููข)ุ ูุงููุณุชูููุงู ูุชูุงุทุนุงู.<br>ุงููุชูุฌุฉ: <span class="font-bold text-blue-600">ูุชุณู ููุณุชูู</span> (ุญู ูุญูุฏ).`;
                } else {
                    if (b1_rounded !== b2_rounded) {
                        conclusion = `ุจูุง ุฃู <span class="font-bold">ุงูููู ูุชุณุงูู</span> (ููก = ููข) ูููู <span class="font-bold">ุงูููุทุน ุงูุตุงุฏู ูุฎุชูู</span> (ุจูก โ ุจูข)ุ ูุงููุณุชูููุงู ูุชูุงุฒูุงู.<br>ุงููุชูุฌุฉ: <span class="font-bold text-red-600">ุบูุฑ ูุชุณู</span> (ูุง ููุฌุฏ ุญู).`;
                    } else {
                        conclusion = `ุจูุง ุฃู <span class="font-bold">ุงูููู ูุชุณุงูู</span> (ููก = ููข) ูู <span class="font-bold">ุงูููุทุน ุงูุตุงุฏู ูุชุณุงูู</span> (ุจูก = ุจูข)ุ ูููุง ููุณ ุงููุณุชููู.<br>ุงููุชูุฌุฉ: <span class="font-bold text-green-600">ูุชุณู ูุบูุฑ ูุณุชูู</span> (ุนุฏุฏ ูุง ููุงุฆู ูู ุงูุญููู).`;
                    }
                }
                html += `<p class="text-center font-semibold">${conclusion}</p></div>`;
                
                solutionContentEl.innerHTML = html;
                showModal(solutionModal);
            }

            // (ุฌุฏูุฏ) ุฏุงูุฉ ุนุฑุถ ุดุงุดุฉ ุงูููุงูุฉ/ุณุฌู ุงูุฃุจุทุงู (ููุนุฑุถ ููุท)
            function displayLeaderboardScreen() {
                hideAllScreens();
                endGameScreen.classList.remove('hidden'); 
                endGameScreen.classList.add('flex');

                // ุญุณุงุจ ุงูููุงุท ุงูุฅุฌูุงููุฉ ุงูุญุงููุฉ
                const totalLeaderboardScore = (playerProgress.easy.score > -1 ? playerProgress.easy.score : 0) +
                                              (playerProgress.medium.score > -1 ? playerProgress.medium.score : 0) +
                                              (playerProgress.hard.score > -1 ? playerProgress.hard.score : 0);
                
                const resultDisplay = document.getElementById('final-result-display');
                const maxPointsPossible = GAME_MAX_POINTS || 1;
                if (resultDisplay) {
                    const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                    // ุนุฑุถ ุงููุชูุฌุฉ ุงูุญุงููุฉ ุงููุฎุฒูุฉ
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">ุงูููุงุท ุงูุฅุฌูุงููุฉ: <span class="font-bold text-xl">${toAr(Math.round(totalLeaderboardScore))} / ${toAr(maxPointsPossible)}</span></p>
                        <p class="text-sm text-gray-500">(ูุฐู ูุชูุฌุชู ุงูุญุงููุฉ. ุณุฌู ุงูุฃุจุทุงู ูุนุฑุถ ุฃูุถู ูุชูุฌุฉ ูุญููุธุฉ ูู)</p>
                    `;
                }

                // ุฌูุจ ููุญุฉ ุงูุฃุจุทุงู (ุงูุชู ุชุญุชูู ุนูู ุฃูุถู ูุชูุฌุฉ ูุณุฌูุฉ)
                if (window.fetchAndShowLeaderboard) {
                    window.fetchAndShowLeaderboard();
                } else {
                    showFinishButton();
                }
            }


            // (ุชุนุฏูู) ุฏุงูุฉ ุฅููุงุก ุงููุนุจุฉ (ุชุญุณุจ ุงูููุงุท ูุชุณุชุฏุนู ุงูุญูุธ)
            function handleGameEnd() {
                hideAllScreens();
                endGameScreen.classList.remove('hidden'); 
                endGameScreen.classList.add('flex');
                
                const totalLeaderboardScore = playerProgress.easy.score + playerProgress.medium.score + playerProgress.hard.score;

                if (window.saveAndFinishGame) {
                    // ุฅุฑุณุงู ุงููุชูุฌุฉ ุงูุฅุฌูุงููุฉ ูุนุฏุฏ ุงูุฃุฎุทุงุก ุงูุฅุฌูุงูู
                    window.saveAndFinishGame(totalLeaderboardScore, totalGameErrors);
                } else {
                    console.error("Save function not found!");
                    const resultDisplay = document.getElementById('final-result-display');
                    const maxPointsPossible = GAME_MAX_POINTS || 1;
                    if (resultDisplay) {
                        const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                        resultDisplay.innerHTML = `
                            <p class="text-gray-700">ุงูููุงุท: <span class="font-bold text-xl">${toAr(Math.round(totalLeaderboardScore))} / ${toAr(maxPointsPossible)}</span></p>
                            <p class="text-red-600">${METRIC_LABEL}: <span class="font-bold text-xl">${toAr(totalGameErrors)}</span></p>
                        `;
                    }
                    if(window.fetchAndShowLeaderboard) window.fetchAndShowLeaderboard(); 
                }
            }

            // --- ุฑุจุท ุงููุณุชูุนูู ---
            
            showLevelsBtn.addEventListener('click', showLevelSelectModal);
            showLeaderboardBtn.addEventListener('click', displayLeaderboardScreen); // (ุฌุฏูุฏ)
            backToLevelsBtn.addEventListener('click', showLevelSelectModal); // (ุฌุฏูุฏ)

            // (ุฌุฏูุฏ) ูุณุชูุนู ูุงูุฐุฉ ูุง ุจุนุฏ ุงููุนุจุฉ
            showResultBtn.addEventListener('click', handleGameEnd);
            improveScoreBtn.addEventListener('click', showLevelSelectModal);

            checkBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', () => {
                showPointsModal(lastPointsEarned); 
            });
            resetChoicesBtn.addEventListener('click', resetChoices);

            continueBtn.addEventListener('click', handleContinueClick);
            scoreModal.addEventListener('click', (e) => {
                if (e.target === scoreModal) {
                    handleContinueClick();
                }
            });

            // (ุชุนุฏูู) ูุณุชูุนู ููุงูุฐ ุงูุชุฃููุฏ ูุงูุญู (ุชู ุชุญุฏูุซ ุงูููุทู)
            
            // ูุธููุฉ ูุฅุนุงุฏุฉ ุชุนููู ูุตูุต ูุงูุฐุฉ ุงูุชุฃููุฏ ุฅูู "ุฅุนุงุฏุฉ"
            function setModalToReplay() {
                const modal = document.getElementById('replay-confirm-modal');
                modal.querySelector('h3').textContent = 'ุฅุนุงุฏุฉ ุงููุณุชูู';
                modal.querySelector('p').innerHTML = 'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุฅุนุงุฏุฉ ูุฐุง ุงููุณุชููุ<br><span class="text-sm text-gray-500">ุณูุชู ุชุณุฌูู ุฏุฑุฌุชู ุงูุฌุฏูุฏุฉ ุจุฏูุงู ูู ุงููุฏููุฉ (ุญุชู ูู ูุงูุช ุฃูู).</span>';
                modal.querySelector('#confirm-replay-btn').textContent = 'ูุนูุ ุฃุนุฏ';
            }

            // ูุธููุฉ ูุฅุนุงุฏุฉ ุชุนููู ูุตูุต ูุงูุฐุฉ ุงูุชุฃููุฏ ุฅูู "ุฎุฑูุฌ"
            function setModalToExit() {
                 const modal = document.getElementById('replay-confirm-modal');
                 modal.querySelector('h3').textContent = 'ุงูุฎุฑูุฌ ูู ุงููุณุชูู';
                modal.querySelector('p').innerHTML = 'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุงูุฎุฑูุฌุ<br><span class="text-sm text-gray-500">ูู ูุชู ุญูุธ ุชูุฏูู ูู ูุฐุง ุงููุณุชูู ุงูุญุงูู.</span>';
                modal.querySelector('#confirm-replay-btn').textContent = 'ูุนูุ ุงุฎุฑุฌ';
            }

            cancelReplayBtn.addEventListener('click', () => {
                hideModal(replayConfirmModal);
                levelToReplay = null;
                setModalToReplay(); // ุฅุนุงุฏุฉ ุงูุชุนููู ููุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ
            });
            replayConfirmModal.addEventListener('click', (e) => {
                if (e.target === replayConfirmModal) {
                    hideModal(replayConfirmModal);
                    levelToReplay = null;
                    setModalToReplay(); // ุฅุนุงุฏุฉ ุงูุชุนููู ููุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ
                }
            });

            confirmReplayBtn.addEventListener('click', () => {
                if (levelToReplay === 'exit') {
                    // ุญุงูุฉ ุงูุฎุฑูุฌ
                    hideModal(replayConfirmModal);
                    showLevelSelectModal(); // ุงูุนูุฏุฉ ูููุงุฆูุฉ
                    levelToReplay = null;
                    setModalToReplay(); // ุฅุนุงุฏุฉ ุงูุชุนููู
                } else if (levelToReplay) {
                    // ุญุงูุฉ ุฅุนุงุฏุฉ ุงููุนุจ
                    hideModal(replayConfirmModal);
                    startLevel(levelToReplay);
                    levelToReplay = null;
                    setModalToReplay(); // ุฅุนุงุฏุฉ ุงูุชุนููู
                }
            });

            showSolutionBtn.addEventListener('click', showSolution);
            closeSolutionBtn.addEventListener('click', () => hideModal(solutionModal));
            solutionModal.addEventListener('click', (e) => {
                if (e.target === solutionModal) {
                    hideModal(solutionModal);
                }
            });


            infoBtn.addEventListener('click', () => {
                closeInfoBtn.textContent = 'ูููุชุ ูุชุงุจุนุฉ!'; 
                showModal(infoModal);
            });
            closeInfoBtn.addEventListener('click', () => {
                hideModal(infoModal);
            });
            
            backToMenuBtn.addEventListener('click', () => {
                setModalToExit(); // ุฅุนุฏุงุฏ ูุงูุฐุฉ ุงูุชุฃููุฏ ููุฎุฑูุฌ
                levelToReplay = 'exit'; // ุงุณุชุฎุฏุงู ูููุฉ ุฎุงุตุฉ
                showModal(replayConfirmModal);
            });

            // --- ุชุดุบูู ุงููุนุจุฉ ---
            loadProgress(); 
            showWelcomeModal(); 
        });
    </script>

    <!-- --- START OF CONNECTION & LEADERBOARD ENGINE --- -->
    <script>
    (function() {
        // --- CONFIGURATION (ุนุฏูู ูุฐู ุงูุฅุนุฏุงุฏุงุช ููู ูุนุจุฉ) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
        const GAME_ID = 'g5_1_1';         // ุชู ุงูุชุนุฏูู ุฅูู g5_1_1
        const GAME_MAX_POINTS = 100;                      // ุฃูุตู ููุงุท ูู ุงููุนุจุฉ
        const PLATFORM_MAX_GRADE = 5;                   // ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ ูู ุงูููุตุฉ
        const METRIC_TYPE = 'errors';                     // ููุน ุงููุนูุงุฑ
        const METRIC_LABEL = 'ุนุฏุฏ ุงูุฃุฎุทุงุก';            // ุงุณู ุงููุนูุงุฑ ููุนุฑุถ ูู ุงูุฌุฏูู

        // --- Read URL Parameters & APPLY FIX ---
        const urlParams = new URLSearchParams(window.location.search);
        
        // (ุชุนุฏูู) ุฅุฒุงูุฉ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ููููู ุฌุงูุฒุงู ููุทูุงุจ
        const studentId = urlParams.get('studentId'); 
        const classId = urlParams.get('classId');
        const studentName = urlParams.get('studentName');

        let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

        // --- CORE FUNCTIONS ---

        // 1. ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ุงูุชู ุชุณุชุฏุนููุง ุนูุฏ ุงูุชูุงุก ุงููุนุจุฉ
        window.saveAndFinishGame = function(points, metricValue) {
            const finalPoints = parseFloat(points) || 0;
            const finalMetric = parseFloat(metricValue) || 0;
            const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
            const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

            const resultDisplay = document.getElementById('final-result-display');
            if (resultDisplay) {
                // ุงุณุชุฎุฏุงู ุฏุงูุฉ toArabicNumerals ุฅุฐุง ูุงูุช ูุชุงุญุฉ ูุชูุณูู ุงูุฃุฑูุงู
                const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;
                
                resultDisplay.innerHTML = `
                    <p class="text-gray-700">ุงูููุงุท: <span class="font-bold text-xl">${toAr(Math.round(finalPoints))} / ${toAr(maxPoints)}</span></p>
                    <p class="text-blue-600">ุงูุฏุฑุฌุฉ ูู ุงูููุตุฉ: <span class="font-bold text-2xl">${toAr(finalGrade.toFixed(1))} / ${toAr(PLATFORM_MAX_GRADE)}</span></p>
                    <p class="text-red-600">${METRIC_LABEL}: <span class="font-bold text-xl">${toAr(finalMetric)}</span></p>
                `;
            }

            // (ุชุนุฏูู) ุงูุชุฃูุฏ ูู ูุฌูุฏ classId ูุจู ุงูุฅุฑุณุงู ูููุน ุงูุฎุทุฃ
            if (studentId && classId) {
                const params = new URLSearchParams({
                    action: 'saveGrade',
                    studentId: studentId,
                    classId: classId,
                    itemId: GAME_ID,
                    grade: finalGrade.toFixed(2),
                    metricValue: Math.round(finalMetric).toString()
                });
                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(result => console.log('Save result:', result.status))
                    .catch(err => console.error("Save Error:", err))
                    .finally(fetchAndShowLeaderboard);
            } else {
                console.log(`Visitor Mode (No Class ID). Score: ${finalPoints}, Metric: ${finalMetric}`);
                // (ุชุนุฏูู) ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูุนุฑุถ ุฑุณุงูุฉ ุงูุฒุงุฆุฑ ุจุฏูุงู ูู ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ุงููุงุดูุฉ
                fetchAndShowLeaderboard();
            }
        }

        // 2. ุฏุงูุฉ ุฌูุจ ูุนุฑุถ ุณุฌู ุงูุฃุจุทุงู
        window.fetchAndShowLeaderboard = function() {
            const loader = document.getElementById('leaderboard-loader');
            const container = document.getElementById('leaderboard-container');
            if (!loader || !container) return;
            
            // (ุชุนุฏูู) ุงูุชุนุงูู ุงูุตุญูุญ ูุน ุบูุงุจ classId
            if (!classId) {
                console.log("No classId found, skipping leaderboard fetch.");
                container.innerHTML = `
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-center">
                        <p class="text-yellow-800 font-bold">ูุถุน ุงูุฒุงุฆุฑ</p>
                        <p class="text-sm text-yellow-700">ูู ูุชู ุญูุธ ุงูุฏุฑุฌุฉ ูู ุณุฌู ุงููุตู ูุฃู ุฑุงุจุท ุงููุนุจุฉ ูุง ูุญุชูู ุนูู ุฑูุฒ ุงููุฌููุนุฉ (Class ID).</p>
                    </div>`;
                showFinishButton();
                return;
            }

            loader.style.display = 'block';
            container.innerHTML = '';

            const params = new URLSearchParams({
                action: 'getLeaderboard',
                gameId: GAME_ID,
                metricType: METRIC_TYPE,
                classId: classId
            });

            fetch(`${SCRIPT_URL}?${params.toString()}`)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'success' && response.data) {
                        displayLeaderboard(response.data);
                    } else {
                        throw new Error(response.message || 'Failed to load leaderboard data.');
                    }
                })
                .catch(err => {
                    console.error("Leaderboard Error:", err);
                    container.innerHTML = `<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุณุฌู ุงูุฃุจุทุงู.</p>`;
                })
                .finally(() => {
                    loader.style.display = 'none';
                    showFinishButton();
                });
        }
        
        // 3. ุฏุงูุฉ ุจูุงุก ุฌุฏูู ุณุฌู ุงูุฃุจุทุงู
        function displayLeaderboard(data) {
            const container = document.getElementById('leaderboard-container');
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ. ูู ุฃูู ุงูุฃุจุทุงู!</p>`;
                return;
            }

            const toAr = typeof toArabicNumerals === 'function' ? toArabicNumerals : (n) => n;

            let tableHTML = `
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">๐ ุณุฌู ุงูุฃุจุทุงู ๐</h3>
                    <div class="leaderboard-scroll-container">
                    <table class="min-w-full bg-white shadow-md rounded-lg">
                        <thead class="bg-gray-800 text-white sticky top-0 z-10">
                            <tr>
                                <th class="text-center py-2 px-3">ุงูุชุฑุชูุจ</th>
                                <th class="text-right py-2 px-3">ุงุณู ุงูุทุงูุจ</th>
                                <th class="text-center py-2 px-3">ุงูุฏุฑุฌุฉ</th>
                                <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">`;

            data.forEach((player, index) => {
                const rank = index + 1;
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = '๐ฅ';
                if (rank === 2) rankDisplay = '๐ฅ';
                if (rank === 3) rankDisplay = '๐ฅ';
                
                // ุชุญููู ุฑูู ุงูุชุฑุชูุจ ููุนุฑุจูุฉ ุฅุฐุง ูู ููู ุฑูุฒุงู
                if (typeof rankDisplay === 'number') rankDisplay = toAr(rankDisplay);

                const isCurrentUser = (currentUser && player.name === currentUser.name);
                const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                        <td class="text-right py-2 px-3">${player.name}</td>
                        <td class="text-center py-2 px-3">${toAr(player.grade.toFixed(1))}</td>
                        <td class="text-center py-2 px-3">${toAr(player.metricValue)}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table></div></div>`;
            container.innerHTML = tableHTML;
        }

        // 4. ุฅุธูุงุฑ ุฒุฑ ุงูุฅููุงุก
        function showFinishButton() {
            const finishWrapper = document.getElementById('finish-game-wrapper');
            if (finishWrapper) {
                finishWrapper.style.display = 'block';
            }
        }

        // 5. ุงูุชุนุงูู ูุน ุฒุฑ ุงูุฅููุงุก ูุชุฎุตูุต ุฑุณุงูุฉ ุงูุชุฑุญูุจ
        document.addEventListener('DOMContentLoaded', () => {
            // Personalize welcome message
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                if (studentName) {
                    welcomeMessage.innerHTML = `ุฃููุงู ุจู ูุง <span class="font-bold text-blue-600">${studentName}</span>! ูู ูุฐู ุงููุนุจุฉ ุณุชุชุนูู ููู ุชููุฒ ุจูู ุฃููุงุน ุฃูุธูุฉ ุงููุนุงุฏูุงุช ุงูุฎุทูุฉ ุงูุซูุงุซุฉ.`;
                } else {
                    // ุฑุณุงูุฉ ุงูุชุฑุงุถูุฉ ููุฒุงุฆุฑ
                    welcomeMessage.innerHTML = `ุฃููุงู ุจู ุฃููุง ุงูุจุทู! ูู ูุฐู ุงููุนุจุฉ ุณุชุชุนูู ููู ุชููุฒ ุจูู ุฃููุงุน ุฃูุธูุฉ ุงููุนุงุฏูุงุช ุงูุฎุทูุฉ ุงูุซูุงุซุฉ.`;
                }
            }

            const finishBtn = document.getElementById('finish-game-btn');
            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                });
            }
        });
    })();
    </script>
    <!-- --- END OF CONNECTION & LEADERBOARD ENGINE --- -->

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المنصة البحرية</title>
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-family: 'Inter', 'Cairo', sans-serif;
            /* (معدل) خلفية سماوية فاتحة */
            background-color: #E0F2FE; /* Corresponds to tailwind bg-sky-100 */
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            /* (معدل) إزالة الخلفية الداكنة، سيعتمد على لون الجسم */
            /* background-color: #0c2d48; */ 
            background-image: url('https://ablan-math.github.io/img/g3_2/g3_4_2.png');
            background-repeat: no-repeat;
            background-size: contain; 
            background-position: center bottom; 
            /* (جديد) إخفاء الخلفية في البداية */
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        /* حاوية الأمواج في الأسفل */
        .waves-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px; 
            overflow: hidden;
            z-index: 10;
        }

        @keyframes wave-animation {
            0% { background-position-x: 0; }
            100% { background-position-x: -1440px; }
        }
        
        /* الأمواج زرقاء ومناسبة للخلفية الفاتحة */
        .wave {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230077dd' fill-opacity='1' d='M0,160L48,181.3C96,203,192,245,288,261.3C384,277,480,267,576,240C672,213,768,171,864,165.3C960,160,1056,192,1152,197.3C1248,203,1344,181,1392,170.7L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E"); 
            background-repeat: repeat-x; 
            position: absolute;
            bottom: 0;
            width: 100%; 
            height: 150px; 
            animation: wave-animation 12s linear infinite;
        }

        .wave-2 {
            animation-duration: 15s;
            animation-direction: reverse;
            opacity: 0.7;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230099ff' fill-opacity='0.5' d='M0,224L48,208C96,192,192,160,288,170.7C384,181,480,235,576,234.7C672,235,768,181,864,176C960,171,1056,213,1152,213.3C1248,213,1344,171,1392,149.3L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E"); 
            background-repeat: repeat-x;
            width: 100%;
        }

        /* (معدل) تصميم الأزرار الزجاجي المشرق */
        .steel-btn {
            background-color: rgba(255, 255, 255, 0.7); /* خلفية زجاجية فاتحة */
            border: 2px solid rgba(59, 130, 246, 0.8); /* إطار أزرق ساطع */
            border-radius: 0.5rem;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease-in-out;
            width: 200px;  
            height: 220px; 
            padding: 1rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; 
            align-items: center; 
            text-align: center; 
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
            color: #1F2937; /* (جديد) لون نص غامق */
        }
        .steel-btn:hover {
            transform: scale(1.1);
            background-color: rgba(59, 130, 246, 0.9); /* خلفية زرقاء عند المرور */
            border-color: rgba(255, 255, 255, 1); /* إطار أبيض عند المرور */
            filter: drop-shadow(0 8px 12px rgba(0, 0, 0, 0.3));
            color: #FFFFFF; /* (جديد) لون نص أبيض عند المرور */
        }
        /* (جديد) ستايل الزر المعطل */
        .steel-btn:disabled {
            background-color: rgba(209, 213, 219, 0.5); /* رمادي باهت */
            border-color: rgba(156, 163, 175, 0.5);
            color: #6B7280; /* نص رمادي */
            filter: grayscale(80%) drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
            transform: none;
            cursor: not-allowed;
        }
        .steel-btn:disabled:hover {
            background-color: rgba(209, 213, 219, 0.5);
            border-color: rgba(156, 163, 175, 0.5);
            color: #6B7280;
            transform: none;
        }


        /* (معدل) لون الأعمدة الفولاذية إلى بني */
        .steel-beam {
            fill: #7B3F00; /* بني داكن */
            stroke: #5A2D00; /* بني أغمق للحدود */
            stroke-width: 4;
        }
        
        /* (معدل) ستايل شفافية النافذة المنبثقة */
        .modal-content-style {
            background-color: rgba(255, 255, 255, 0.9); /* شفافية 90% */
            backdrop-filter: blur(5px); /* تأثير ضبابي */
            max-height: 90vh; /* تحديد أقصى ارتفاع 90% من الشاشة */
            display: flex;
            flex-direction: column;
        }
        
        /* (معدل) رأس وتذييل النافذة المنبثقة */
        .modal-header {
            padding: 0.75rem 1rem; /* p-3 p-4 */
            background-color: rgba(249, 250, 251, 0.8);
            border-bottom: 1px solid #E5E7EB;
            /* (جديد) تقسيم رأس النافذة */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer {
            padding: 0.75rem; /* p-3 (تم تصغيره) */
            background-color: rgba(243, 244, 246, 0.8);
            border-top: 1px solid #E5E7EB;
        }

        /* (معدل) جسم النافذة المنبثقة (مع شريط تمرير) */
        .modal-body-style {
            padding: 1rem; /* p-4 (تم تصغيره) */
            space-y: 0.5rem; /* space-y-2 (تم تصغيره) */
            text-align: center;
            overflow-y: auto; /* !! الأهم: إضافة شريط تمرير داخلي عند الحاجة !! */
        }
        
        /* (معدل) ستايل أزرار الاختيارات (CSS صريح) */
        .choice-btn {
            width: 100%;
            padding: 0.5rem; /* p-2 (تم تصغيره) */
            background-color: #E5E7EB; /* bg-gray-200 */
            color: #1F2937; /* text-gray-800 */
            border-radius: 0.5rem; /* rounded-lg */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; /* font-mono */
            font-size: 0.9rem; /* text-sm (تم تصغيره) */
            line-height: 1.25rem;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
            border: 1px solid #D1D5DB; /* border border-gray-300 */
            cursor: pointer;
        }
        .choice-btn:hover {
            background-color: #DBEAFE; /* hover:bg-blue-200 */
            box-shadow: 0 0 0 2px #3B82F6; 
        }
        .choice-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* (معدل) ألوان إجابات أكثر إشراقاً */
        .choice-btn.correct {
            background-color: #10B981; /* bg-emerald-500 */
            color: #FFFFFF; /* text-white */
            border: 2px solid #059669; /* border-2 border-emerald-600 */
        }
        .choice-btn.wrong {
            background-color: #F43F5E; /* bg-rose-500 */
            color: #FFFFFF; /* text-white */
            border: 2px solid #E11D48; /* border-2 border-rose-600 */
        }


        /* ستايل الكسور */
        .fraction, .explanation-fraction, .smart-fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            font-size: 1em; 
            margin: 0 0.2em;
        }
        .fraction .numerator, .explanation-fraction .numerator, .smart-fraction .numerator {
            display: block;
            border-bottom: 2px solid currentColor; 
            padding: 0 0.2em;
            line-height: 1;
        }
        .fraction .denominator, .explanation-fraction .denominator, .smart-fraction .denominator {
            display: block;
            padding: 0 0.2em;
            line-height: 1;
        }
        /* حجم أصغر للشرح */
        .explanation-fraction {
            font-size: 0.9em;
        }
        .smart-fraction {
            font-size: 1.1em;
        }

        /* (جديد) ستايل نوافذ البداية */
        .intro-modal {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            padding: 1.5rem;
            text-align: center;
            z-index: 60;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* (جديد) ستايل نافذة الملخص */
        .summary-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #D1D5DB;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .summary-table th {
            background-color: #F3F4F6;
        }
        /* (جديد) ستايل نافذة النتيجة النهائية */
        .final-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #3B82F6; /* أزرق */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 1rem auto;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }
        .final-score-circle.green { background-color: #10B981; box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3); }
        .final-score-circle.yellow { background-color: #F59E0B; box-shadow: 0 8px 16px rgba(245, 158, 11, 0.3); }
        .final-score-circle.red { background-color: #EF4444; box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3); }

    </style>
</head>
<body class="bg-blue-50"> 

    <!-- (معدل) عداد النقاط الخارجي -->
    <div id="score-display" class="hidden absolute top-4 left-4 z-30 text-blue-800 text-2xl font-bold">النقاط: ٠</div>

    
    <div id="game-container">

        <!-- (معدل) حاوية الأزرار (مخفية في البداية) -->
        <div id="game-buttons-container" class="hidden absolute inset-0 z-20 flex items-center justify-center gap-10">
            
            <button 
                id="parallel-btn"
                onclick="showParallelQuestion()"
                class="steel-btn"
                aria-label="أسئلة التوازي">
                
                <span class="text-sm font-bold block">
                    تركيب عمود فولاذي
                </span>
                
                <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="10" width="15" height="60" rx="3" class="steel-beam" />
                    <rect x="45" y="10" width="15" height="60" rx="3" class="steel-beam" />
                </svg>
                
                <span class="text-sm font-bold block">
                    يوازي العمود المجاور
                </span>
            </button>

            <button 
                id="perpendicular-btn"
                onclick="showPerpendicularQuestion()"
                class="steel-btn"
                aria-label="أسئلة التعامد">
                
                <span class="text-sm font-bold block">
                    تركيب عمود فولاذي
                </span>
                
                <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <rect x="32.5" y="10" width="15" height="60" rx="3" class="steel-beam" />
                    <rect x="10" y="55" width="60" height="15" rx="3" class="steel-beam" />
                </svg>
                
                <span class="text-sm font-bold block">
                    يعامد العمود المجاور
                </span>
            </button>

        </div>
        
        <div class="waves-container">
            <div class="wave"></div>
            <div class="wave wave-2"></div>
        </div>
    </div>

    <!-- (جديد) نافذة البداية (التعريف باللعبة) -->
    <div id="intro-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="intro-modal transform scale-95 opacity-0 transition-all">
            <h2 class="text-2xl font-bold text-blue-700 mb-3">أهلاً بك في لعبة المنصة التعليمية</h2>
            <!-- (تم التعديل) إضافة id لرسالة الترحيب -->
            <p id="welcomeMessage" class="text-base text-gray-700 mb-4">
                هذه اللعبة مصممة لمساعدتك على إتقان مفهومي التوازي والتعامد في معادلات الخط المستقيم بطريقة تفاعلية وممتعة.
            </p>
            <p class="text-sm text-gray-600 mb-5">
                <strong>الفائدة:</strong> ستتدرب على إيجاد معادلات المستقيمات الموازية والمتعامدة، وهي مهارة أساسية في الرياضيات.
            </p>
            <hr class="my-3">
            <p class="text-base font-semibold text-gray-800">تطوير وتصميم</p>
            <p class="text-lg font-bold text-blue-600">الأستاذ / عبد العزيز خالد العبلان</p>
            <button
                onclick="showInstructionsModal()"
                class="mt-5 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-lg">
                ابدأ
            </button>
        </div>
    </div>

    <!-- (جديد) نافذة تعليمات احتساب الدرجات -->
    <div id="instructions-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="intro-modal transform scale-95 opacity-0 transition-all">
            <h2 class="text-2xl font-bold text-yellow-600 mb-3">كيفية احتساب النقاط</h2>
            <ul class="text-base text-gray-700 mb-5 list-disc list-inside text-right space-y-2">
                <li>كل مسار (التوازي أو التعامد) يتكون من مهمتين.</li>
                <li><strong>المحاولة الأولى الصحيحة:</strong> تحصل على كامل نقاط المهمة.</li>
                <li><strong>المحاولة الثانية الصحيحة:</strong> تحصل على نصف نقاط المهمة.</li>
                <li>سيتم حساب وقتك الإجمالي لكل مهمة.</li>
            </ul>
            <p class="text-base font-bold text-gray-800">استعد لتركيب الأعمدة الفولاذية!</p>
            <button
                onclick="startGame()"
                class="mt-5 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-lg">
                لنبدأ!
            </button>
        </div>
    </div>

    <!-- (جديد) نافذة ملخص المهام -->
    <div id="summary-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="intro-modal transform scale-95 opacity-0 transition-all">
            <h2 class="text-2xl font-bold text-blue-700 mb-3">ملخص الأداء</h2>
            <p class="text-base text-gray-700 mb-4">
                هذا هو ملخص أدائك في جميع المهام:
            </p>
            <table id="summary-table-content" class="summary-table">
                <thead>
                    <tr>
                        <th>المهمة</th>
                        <!-- (معدل) رأس جدول النقاط -->
                        <th>النقاط</th>
                        <th>الوقت المستغرق</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملء هذا الجدول عبر JS -->
                </tbody>
            </table>
            <button
                onclick="showFinalScoreModal()"
                class="mt-5 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-lg">
                التالي (النتيجة النهائية)
            </button>
        </div>
    </div>

    <!-- (جديد) نافذة النتيجة النهائية -->
    <div id="final-score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="intro-modal transform scale-95 opacity-0 transition-all">
            <h2 class="text-2xl font-bold text-blue-700 mb-3">النتيجة النهائية</h2>

            <!-- (جديد) هذا العنصر سيتم ملؤه بواسطة محرك الربط -->
            <div id="final-result-display" class="text-center mb-4">
                <!-- المحتوى الأصلي كعنصر نائب (سيتم استبداله) -->
                <p class="text-base text-gray-700 mb-2">
                    بناءً على مجموع نقاطك (<strong><span id="final-total-score">0</span> من ٦٠</strong>)...
                </p>
                <p class="text-base text-gray-700 mb-4">
                    تكون درجتك المكافئة من ٥ هي:
                </p>
                <div id="final-score-circle-display" class="final-score-circle blue">
                    <span id="final-rating-score" class="text-5xl font-bold">٠</span>
                    <span class="text-xl font-medium">من ٥</span>
                </div>
                <p id="final-score-message" class="text-lg font-semibold text-gray-800 mt-4"></p>
            </div>

            <!-- (جديد) عناصر سجل الأبطال -->
            <div id="leaderboard-loader" style="display: none;" class="text-center my-4">
                <p class="text-lg text-blue-600">جاري تحميل سجل الأبطال...</p>
            </div>
            <div id="leaderboard-container">
                <!-- سيتم حقن جدول سجل الأبطال هنا -->
            </div>

            <!-- (جديد) حاوية أزرار الإنهاء وإعادة اللعب -->
            <div id="finish-game-wrapper" class="mt-5" style="display: none;">
                <button
                    id="finish-game-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-lg mb-2">
                    العودة للمنصة
                </button>
                <button
                    onclick="restartGame()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-lg">
                    إعادة اللعب
                </button>
            </div>

        </div>
    </div>

    <!-- النافذة المنبثقة (Modal) لعرض السؤال -->
    <div id="question-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm">
        
        <div class="rounded-2xl shadow-2xl w-full max-w-lg mx-auto overflow-hidden transform transition-all scale-95 opacity-0 modal-content-style" id="modal-content">
            
            <!-- (معدل) رأس النافذة المقسم -->
            <div class="modal-header">
                <!-- يسار: المؤقت -->
                <span id="modal-timer" class="text-sm font-mono text-gray-600" style="direction: ltr;">٠٠:٠٠</span>
                <!-- وسط: العنوان -->
                <h2 id="modal-title" class="text-lg font-bold text-gray-800 text-center"></h2>
                <!-- يمين: النقاط -->
                <span id="modal-score" class="text-sm font-bold text-blue-600">النقاط: ٠</span>
            </div>
            
            <div id="modal-body" class="modal-body-style">
                <p id="modal-prompt" class="text-base text-gray-700"></p> 
                <div id="modal-equation" class="text-xl font-mono p-2 bg-gray-100 rounded-md inline-block"></div> 
                
                <div id="modal-choices" class="grid grid-cols-2 gap-2 pt-2">
                    <!-- سيتم ملء الأزرار هنا عبر JavaScript -->
                </div>
            </div>
            
            <div class="flex justify-between modal-footer">
                <button id="next-btn" onclick="goToNextQuestionOrHide()" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-all text-base">
                    التالي
                </button>

                <button 
                    id="smart-why-btn"
                    onclick="showSmartExplanation()"
                    class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-md hover:shadow-lg text-base">
                    الشرح الذكي
                </button>

                <button 
                    id="why-btn"
                    onclick="showExplanation()"
                    class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-md hover:shadow-lg text-base">
                    اعرف لماذا؟
                </button>
            </div>

        </div>
    </div>

    <!-- نافذة منبثقة خاصة بالتلميح -->
    <div id="hint-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
        <div id="hint-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-auto p-4 text-center transform scale-95 opacity-0 transition-all modal-content-style"> 
            <h3 class="text-lg font-bold text-yellow-600 mb-2">محاولة خاطئة!</h3>
            <!-- (جديد) رسالة التلميح المحدثة -->
            <p id="hint-text-main" class="text-base text-gray-700 mb-2"></p> 
            <p id="hint-text-extra" class="text-base text-gray-700 mb-4 font-semibold"></p> 
            <button
                onclick="hideHintModal()"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                متابعة المحاولة
            </button>
        </div>
    </div>

    <!-- (معدل) نافذة منبثقة خاصة بـ "اعرف لماذا؟" -->
    <div id="explanation-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
        <div id="explanation-modal-content" class="rounded-2xl shadow-2xl w-full max-w-lg mx-auto transform scale-95 opacity-0 transition-all modal-content-style">
            <div class="modal-header">
                <h2 id="exp-modal-title" class="text-lg font-bold text-gray-800 text-center" style="width: 100%;"></h2>
            </div>
            <div class="p-4 space-y-2 text-right modal-body-style"> 
                <p><strong>المعادلة الأصلية:</strong> <span id="exp-modal-equation" class="font-mono"></span></p>
                <p><strong>النقطة المعطاة:</strong> <span id="exp-modal-point" class="font-mono"></span></p>
                <hr>
                <p class="text-base font-bold">خطوات الحل:</p>
                <div id="exp-modal-text" class="text-sm whitespace-pre-line" style="text-align: right;">
                    <!-- سيتم ملء الشرح هنا -->
                </div>
            </div>
            <div class="modal-footer text-center">
                <button
                    onclick="hideExplanationModal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- (معدل) نافذة منبثقة خاصة بـ "الشرح الذكي" -->
    <div id="smart-explanation-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
        <div id="smart-explanation-modal-content" class="rounded-2xl shadow-2xl w-full max-w-lg mx-auto transform scale-95 opacity-0 transition-all modal-content-style">
            <div class="modal-header">
                <h2 class="text-lg font-bold text-yellow-600 text-center" style="width: 100%;">الشرح الذكي (التحقق بالتعويض)</h2>
            </div>
            <div id="smart-exp-modal-text" class="p-4 space-y-2 text-right font-mono text-base modal-body-style"> 
                <!-- سيتم ملء شرح التعويض هنا -->
            </div>
            <div class="modal-footer text-center">
                <button
                    onclick="hideSmartExplanationModal()"
                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- (جديد) دالة تحويل الأرقام إلى عربية ---
        function toArabicNumerals(num) {
            // (معدل) التأكد من أن الإدخال ليس null أو undefined قبل التحويل
            if (num === null || typeof num === 'undefined') {
                return ""; // إرجاع سلسلة فارغة بدلاً من "undefined"
            }
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).replace(/[0-9]/g, (d) => arabicNumerals[d]);
        }

        // --- (جديد) دالة خلط عشوائي لمصفوفة (لتنويع ترتيب الإجابات) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- (جديد) بنك الأسئلة المحدث (16 سؤال) ---
        const questionBank = {
            // المهمة الأولى: توازي بسيط (q1)
            'q1': [
                {
                    title: "المهمة الأولى: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (١، ٥) والموازي للعمود الذي معادلته:",
                    equation: "ص = ٢س + ١",
                    point: { x: 1, y: 5, text: "(١، ٥)" },
                    choices: [
                        { text: "ص = ٢س + ٣", correct: true },
                        { text: "ص = -٢س + ٥", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س + ٤", correct: false },
                        { text: "ص = ٢س + ١", correct: false }
                    ],
                    correctAnswerText: "ص = ٢س + ٣",
                    hint: "تلميح: المستقيمان المتوازيان لهما نفس الميل. ميل المعادلة (ص = ٢س + ١) هو ٢.",
                    explanation: "١. ميل العمود المعطى (ص = ٢س + ١) هو م = ٢.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = ٢.\n٣. نستخدم معادلة (ص - ص١) = م(س - س١) مع النقطة (١، ٥).\n٤. (ص - ٥) = ٢ × (س - ١) \n٥. ص - ٥ = ٢س - ٢ \n٦. ص = ٢س + ٣",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = ٢ × (${p.x}) + ٣ ؟</p><p>هل ${p.y} = ${2 * p.x} + ٣ ؟</p>`,
                    smartCalc: (p) => 2 * p.x + 3
                },
                {
                    title: "المهمة الأولى: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٢، ١) والموازي للعمود الذي معادلته:",
                    equation: "ص = ٣س - ٢",
                    point: { x: 2, y: 1, text: "(٢، ١)" },
                    choices: [
                        { text: "ص = ٣س - ٥", correct: true },
                        { text: "ص = -٣س + ٧", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س - <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>", correct: false },
                        { text: "ص = ٣س + ١", correct: false }
                    ],
                    correctAnswerText: "ص = ٣س - ٥",
                    hint: "تلميح: المستقيمان المتوازيان لهما نفس الميل. ميل المعادلة (ص = ٣س - ٢) هو ٣.",
                    explanation: "١. ميل العمود المعطى (ص = ٣س - ٢) هو م = ٣.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = ٣.\n٣. نستخدم النقطة (٢، ١).\n٤. (ص - ١) = ٣ × (س - ٢)\n٥. ص - ١ = ٣س - ٦ \n٦. ص = ٣س - ٥",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = ٣ × (${p.x}) - ٥ ؟</p><p>هل ${p.y} = ${3 * p.x} - ٥ ؟</p>`,
                    smartCalc: (p) => 3 * p.x - 5
                },
                {
                    title: "المهمة الأولى: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (-١، ٣) والموازي للعمود الذي معادلته:",
                    equation: "ص = -س + ٤",
                    point: { x: -1, y: 3, text: "(-١، ٣)" },
                    choices: [
                        { text: "ص = -س + ٢", correct: true },
                        { text: "ص = س + ٤", correct: false },
                        { text: "ص = -س - ١", correct: false },
                        { text: "ص = س + ٢", correct: false }
                    ],
                    correctAnswerText: "ص = -س + ٢",
                    hint: "تلميح: المستقيمان المتوازيان لهما نفس الميل. ميل المعادلة (ص = -س + ٤) هو -١.",
                    explanation: "١. ميل العمود المعطى (ص = -س + ٤) هو م = -١.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = -١.\n٣. نستخدم النقطة (-١، ٣).\n٤. (ص - ٣) = -١ × (س - (-١))\n٥. ص - ٣ = -س - ١ \n٦. ص = -س + ٢",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = -١ × (${p.x}) + ٢ ؟</p><p>هل ${p.y} = ${-1 * p.x} + ٢ ؟</p>`,
                    smartCalc: (p) => -1 * p.x + 2
                },
                {
                    title: "المهمة الأولى: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٤، -١) والموازي للعمود الذي معادلته:",
                    equation: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س + ١",
                    point: { x: 4, y: -1, text: "(٤، -١)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س - ٣", correct: true },
                        { text: "ص = -٢س + ٧", correct: false },
                        { text: "ص = ٢س - ٩", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س + ٤", correct: false }
                    ],
                    correctAnswerText: "ص = (١/٢)س - ٣",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س - ٣",
                    hint: "تلميح: المستقيمان المتوازيان لهما نفس الميل. الميل هو (١/٢).",
                    explanation: "١. ميل العمود المعطى هو م = ١/٢.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = ١/٢.\n٣. نستخدم النقطة (٤، -١).\n٤. (ص - (-١)) = (١/٢) × (س - ٤)\n٥. ص + ١ = (١/٢)س - ٢ \n٦. ص = (١/٢)س - ٣",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = (١/٢) × (${p.x}) - ٣ ؟</p><p>هل ${p.y} = ${(1/2) * p.x} - ٣ ؟</p>`,
                    smartCalc: (p) => (1/2) * p.x - 3
                }
            ],
            // المهمة الثانية: توازي قياسي (q3)
            'q3': [
                {
                    title: "المهمة الثانية: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٤، ٠) والموازي للعمود الذي معادلته:",
                    equation: "٢س + ص = ١",
                    point: { x: 4, y: 0, text: "(٤، ٠)" },
                    choices: [
                        { text: "ص = -٢س + ٨", correct: true },
                        { text: "ص = ٢س - ٨", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س - ٢", correct: false },
                        { text: "ص = -٢س + ٤", correct: false }
                    ],
                    correctAnswerText: "ص = -٢س + ٨",
                    hint: "تلميح: أعد كتابة المعادلة (٢س + ص = ١) على صيغة (ص = م س + ب) أولاً لإيجاد الميل.",
                    explanation: "١. نعدل المعادلة: ص = -٢س + ١. إذاً الميل هو م = -٢.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = -٢.\n٣. نستخدم النقطة (٤، ٠).\n٤. (ص - ٠) = -٢ × (س - ٤)\n٥. ص = -٢س + ٨",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = -٢ × (${p.x}) + ٨ ؟</p><p>هل ${p.y} = ${-2 * p.x} + ٨ ؟</p>`,
                    smartCalc: (p) => -2 * p.x + 8
                },
                {
                    title: "المهمة الثانية: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (١، ١) والموازي للعمود الذي معادلته:",
                    equation: "٣س + ص = ٥",
                    point: { x: 1, y: 1, text: "(١، ١)" },
                    choices: [
                        { text: "ص = -٣س + ٤", correct: true },
                        { text: "ص = ٣س - ٢", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س + <span class='fraction'><span class='numerator'>٢</span><span class='denominator'>٣</span></span>", correct: false },
                        { text: "ص = -٣س + ١", correct: false }
                    ],
                    correctAnswerText: "ص = -٣س + ٤",
                    hint: "تلميح: أعد كتابة المعادلة (٣س + ص = ٥) على صيغة (ص = م س + ب) أولاً لإيجاد الميل.",
                    explanation: "١. نعدل المعادلة: ص = -٣س + ٥. إذاً الميل هو م = -٣.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = -٣.\n٣. نستخدم النقطة (١، ١).\n٤. (ص - ١) = -٣ × (س - ١)\n٥. ص - ١ = -٣س + ٣ \n٦. ص = -٣س + ٤",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = -٣ × (${p.x}) + ٤ ؟</p><p>هل ${p.y} = ${-3 * p.x} + ٤ ؟</p>`,
                    smartCalc: (p) => -3 * p.x + 4
                },
                {
                    title: "المهمة الثانية: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (-٢، ٣) والموازي للعمود الذي معادلته:",
                    equation: "س - ٢ص = ٤",
                    point: { x: -2, y: 3, text: "(-٢، ٣)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س + ٤", correct: true },
                        { text: "ص = -٢س - ١", correct: false },
                        { text: "ص = ٢س + ٧", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س - ٢", correct: false }
                    ],
                    correctAnswerText: "ص = (١/٢)س + ٤",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س + ٤",
                    hint: "تلميح: أعد كتابة المعادلة (س - ٢ص = ٤) على صيغة (ص = م س + ب) أولاً لإيجاد الميل.",
                    explanation: "١. نعدل المعادلة: -٢ص = -س + ٤  =>  ص = (١/٢)س - ٢. الميل هو م = ١/٢.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = ١/٢.\n٣. نستخدم النقطة (-٢، ٣).\n٤. (ص - ٣) = (١/٢) × (س - (-٢))\n٥. ص - ٣ = (١/٢)س + ١ \n٦. ص = (١/٢)س + ٤",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = (١/٢) × (${p.x}) + ٤ ؟</p><p>هل ${p.y} = ${(1/2) * p.x} + ٤ ؟</p>`,
                    smartCalc: (p) => (1/2) * p.x + 4
                },
                {
                    title: "المهمة الثانية: تركيب عمود فولاذي موازٍ",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (١، -١) والموازي للعمود الذي معادلته:",
                    equation: "٤س - ص = ٠",
                    point: { x: 1, y: -1, text: "(١، -١)" },
                    choices: [
                        { text: "ص = ٤س - ٥", correct: true },
                        { text: "ص = -٤س + ٣", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٤</span></span>س - <span class='fraction'><span class='numerator'>٣</span><span class='denominator'>٤</span></span>", correct: false },
                        { text: "ص = ٤س - ١", correct: false }
                    ],
                    correctAnswerText: "ص = ٤س - ٥",
                    hint: "تلميح: أعد كتابة المعادلة (٤س - ص = ٠) على صيغة (ص = م س + ب) أولاً لإيجاد الميل.",
                    explanation: "١. نعدل المعادلة: -ص = -٤س  =>  ص = ٤س. الميل هو م = ٤.\n٢. العمود المطلوب يوازيه، إذاً ميله أيضاً م = ٤.\n٣. نستخدم النقطة (١، -١).\n٤. (ص - (-١)) = ٤ × (س - ١)\n٥. ص + ١ = ٤س - ٤ \n٦. ص = ٤س - ٥",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = ٤ × (${p.x}) - ٥ ؟</p><p>هل ${p.y} = ${4 * p.x} - ٥ ؟</p>`,
                    smartCalc: (p) => 4 * p.x - 5
                }
            ],
            // المهمة الثالثة: تعامد بسيط (q2)
            'q2': [
                {
                    title: "المهمة الثالثة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٣، ١) و يعامد العمود الذي معادلته:",
                    equation: "ص = ٣س - ٥",
                    point: { x: 3, y: 1, text: "(٣، ١)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٣</span></span>س + ٢", correct: true },
                        { text: "ص = ٣س - ٨", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س", correct: false },
                        { text: "ص = -٣س + ١٠", correct: false }
                    ],
                    correctAnswerText: "ص = (-١/٣)س + ٢",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٣</span></span>س + ٢",
                    hint: "تلميح: ميل العمود المُعامد هو مقلوب معكوس الميل الأصلي. إذا كان الميل (م)، فالميل الجديد هو (-١/م).",
                    explanation: "١. ميل العمود المعطى (ص = ٣س - ٥) هو م = ٣.\n٢. العمود المطلوب يعامده، إذاً ميله هو (-١/٣).\n٣. نستخدم النقطة (٣، ١).\n٤. (ص - ١) = (-١/٣) × (س - ٣)\n٥. ص - ١ = (-١/٣)س + ١\n٦. ص = (-١/٣)س + ٢",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = (-١/٣) × (${p.x}) + ٢ ؟</p><p>هل ${p.y} = ${(-1/3) * p.x} + ٢ ؟</p>`,
                    smartCalc: (p) => (-1/3) * p.x + 2
                },
                {
                    title: "المهمة الثالثة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٤، ٢) و يعامد العمود الذي معادلته:",
                    equation: "ص = ٢س + ١",
                    point: { x: 4, y: 2, text: "(٤، ٢)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٢</span></span>س + ٤", correct: true },
                        { text: "ص = ٢س - ٦", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٢</span></span>س", correct: false },
                        { text: "ص = -٢س + ١٠", correct: false }
                    ],
                    correctAnswerText: "ص = (-١/٢)س + ٤",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٢</span></span>س + ٤",
                    hint: "تلميح: ميل العمود المُعامد هو مقلوب معكوس الميل الأصلي. ميل (٢) يصبح (-١/٢).",
                    explanation: "١. ميل العمود المعطى (ص = ٢س + ١) هو م = ٢.\n٢. العمود المطلوب يعامده، إذاً ميله هو (-١/٢).\n٣. نستخدم النقطة (٤، ٢).\n٤. (ص - ٢) = (-١/٢) × (س - ٤)\n٥. ص - ٢ = (-١/٢)س + ٢\n٦. ص = (-١/٢)س + ٤",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = (-١/٢) × (${p.x}) + ٤ ؟</p><p>هل ${p.y} = ${(-1/2) * p.x} + ٤ ؟</p>`,
                    smartCalc: (p) => (-1/2) * p.x + 4
                },
                {
                    title: "المهمة الثالثة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (-٤، ٠) و يعامد العمود الذي معادلته:",
                    equation: "ص = -٤س + ٣",
                    point: { x: -4, y: 0, text: "(-٤، ٠)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٤</span></span>س + ١", correct: true },
                        { text: "ص = -٤س - ١٦", correct: false },
                        { text: "ص = ٤س + ١٦", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٤</span></span>س - ١", correct: false }
                    ],
                    correctAnswerText: "ص = (١/٤)س + ١",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٤</span></span>س + ١",
                    hint: "تلميح: ميل العمود المُعامد هو مقلوب معكوس الميل الأصلي. ميل (-٤) يصبح (١/٤).",
                    explanation: "١. ميل العمود المعطى (ص = -٤س + ٣) هو م = -٤.\n٢. العمود المطلوب يعامده، إذاً ميله هو (١/٤).\n٣. نستخدم النقطة (-٤، ٠).\n٤. (ص - ٠) = (١/٤) × (س - (-٤))\n٥. ص = (١/٤)س + ١",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = (١/٤) × (${p.x}) + ١ ؟</p><p>هل ${p.y} = ${(1/4) * p.x} + ١ ؟</p>`,
                    smartCalc: (p) => (1/4) * p.x + 1
                },
                {
                    title: "المهمة الثالثة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (١، -١) و يعامد العمود الذي معادلته:",
                    equation: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س - ١",
                    point: { x: 1, y: -1, text: "(١، -١)" },
                    choices: [
                        { text: "ص = -٣س + ٢", correct: true },
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٣</span></span>س - <span class='fraction'><span class='numerator'>٤</span><span class='denominator'>٣</span></span>", correct: false },
                        { text: "ص = ٣س - ٤", correct: false },
                        { text: "ص = -٣س - ١", correct: false }
                    ],
                    correctAnswerText: "ص = -٣س + ٢",
                    hint: "تلميح: ميل العمود المُعامد هو مقلوب معكوس الميل الأصلي. ميل (١/٣) يصبح (-٣).",
                    explanation: "١. ميل العمود المعطى هو م = ١/٣.\n٢. العمود المطلوب يعامده، إذاً ميله هو (-٣).\n٣. نستخدم النقطة (١، -١).\n٤. (ص - (-١)) = -٣ × (س - ١)\n٥. ص + ١ = -٣س + ٣\n٦. ص = -٣س + ٢",
                    score: 10,
                    smartVerification: (p) => `<p>هل ${p.y} = -٣ × (${p.x}) + ٢ ؟</p><p>هل ${p.y} = ${-3 * p.x} + ٢ ؟</p>`,
                    smartCalc: (p) => -3 * p.x + 2
                }
            ],
            // المهمة الرابعة: تعامد قياسي (q4)
            'q4': [
                {
                    title: "المهمة الرابعة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٢، ١) و يعامد العمود الذي معادلته:",
                    equation: "٢س - ٥ص = ١٠",
                    point: { x: 2, y: 1, text: "(٢، ١)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>-٥</span><span class='denominator'>٢</span></span>س + ٦", correct: true },
                        { text: "ص = <span class='fraction'><span class='numerator'>٢</span><span class='denominator'>٥</span></span>س - <span class='fraction'><span class='numerator'>٢٦</span><span class='denominator'>٥</span></span>", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>٥</span><span class='denominator'>٢</span></span>س - ٤", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>-٢</span><span class='denominator'>٥</span></span>س + <span class='fraction'><span class='numerator'>١٤</span><span class='denominator'>٥</span></span>", correct: false }
                    ],
                    correctAnswerText: "ص = (-٥/٢)س + ٦",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>-٥</span><span class='denominator'>٢</span></span>س + ٦",
                    hint: "تلميح: أعد كتابة المعادلة (٢س - ٥ص = ١٠) لإيجاد الميل (٢/٥)، ثم اوجد مقلوب معكوسه (-٥/٢).",
                    explanation: "١. نعدل المعادلة: -٥ص = -٢س + ١٠  =>  ص = (٢/٥)س - ٢. الميل هو م = (٢/٥).\n٢. العمود المطلوب يعامده، إذاً ميله هو (-٥/٢).\n٣. نستخدم النقطة (٢، ١).\n٤. (ص - ١) = (-٥/٢) × (س - ٢)\n٥. ص - ١ = (-٥/٢)س + ٥\n٦. ص = (-٥/٢)س + ٦",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = (-٥/٢) × (${p.x}) + ٦ ؟</p><p>هل ${p.y} = ${(-5/2) * p.x} + ٦ ؟</p>`,
                    smartCalc: (p) => (-5/2) * p.x + 6
                },
                {
                    title: "المهمة الرابعة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٣، -١) و يعامد العمود الذي معادلته:",
                    equation: "٣س + ٢ص = ٦",
                    point: { x: 3, y: -1, text: "(٣، -١)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>٢</span><span class='denominator'>٣</span></span>س - ٣", correct: true },
                        { text: "ص = <span class='fraction'><span class='numerator'>-٣</span><span class='denominator'>٢</span></span>س + ٣.٥", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>-٢</span><span class='denominator'>٣</span></span>س + ١", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>٢</span><span class='denominator'>٣</span></span>س + ٣", correct: false }
                    ],
                    correctAnswerText: "ص = (٢/٣)س - ٣",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>٢</span><span class='denominator'>٣</span></span>س - ٣",
                    hint: "تلميح: أعد كتابة المعادلة (٣س + ٢ص = ٦) لإيجاد الميل (-٣/٢)، ثم اوجد مقلوب معكوسه (٢/٣).",
                    explanation: "١. نعدل المعادلة: ٢ص = -٣س + ٦  =>  ص = (-٣/٢)س + ٣. الميل هو م = (-٣/٢).\n٢. العمود المطلوب يعامده، إذاً ميله هو (٢/٣).\n٣. نستخدم النقطة (٣، -١).\n٤. (ص - (-١)) = (٢/٣) × (س - ٣)\n٥. ص + ١ = (٢/٣)س - ٢\n٦. ص = (٢/٣)س - ٣",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = (٢/٣) × (${p.x}) - ٣ ؟</p><p>هل ${p.y} = ${(2/3) * p.x} - ٣ ؟</p>`,
                    smartCalc: (p) => (2/3) * p.x - 3
                },
                {
                    title: "المهمة الرابعة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (-١، -٢) و يعامد العمود الذي معادلته:",
                    equation: "س - ص = ٥",
                    point: { x: -1, y: -2, text: "(-١، -٢)" },
                    choices: [
                        { text: "ص = -س - ٣", correct: true },
                        { text: "ص = س - ١", correct: false },
                        { text: "ص = -س - ٢", correct: false },
                        { text: "ص = س + ٥", correct: false }
                    ],
                    correctAnswerText: "ص = -س - ٣",
                    hint: "تلميح: أعد كتابة المعادلة (س - ص = ٥) لإيجاد الميل (١)، ثم اوجد مقلوب معكوسه (-١).",
                    explanation: "١. نعدل المعادلة: -ص = -س + ٥  =>  ص = س - ٥. الميل هو م = ١.\n٢. العمود المطلوب يعامده، إذاً ميله هو (-١).\n٣. نستخدم النقطة (-١، -٢).\n٤. (ص - (-٢)) = -١ × (س - (-١))\n٥. ص + ٢ = -س - ١\n٦. ص = -س - ٣",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = -١ × (${p.x}) - ٣ ؟</p><p>هل ${p.y} = ${-1 * p.x} - ٣ ؟</p>`,
                    smartCalc: (p) => -1 * p.x - 3
                },
                {
                    title: "المهمة الرابعة: تركيب عمود فولاذي مُعامد",
                    prompt: "يراد تركيب عمود فولاذي في النقطة (٥، ٠) و يعامد العمود الذي معادلته:",
                    equation: "٥س + ص = ٢",
                    point: { x: 5, y: 0, text: "(٥، ٠)" },
                    choices: [
                        { text: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٥</span></span>س - ١", correct: true },
                        { text: "ص = -٥س + ٢٥", correct: false },
                        { text: "ص = ٥س - ٢٥", correct: false },
                        { text: "ص = <span class='fraction'><span class='numerator'>-١</span><span class='denominator'>٥</span></span>س + ١", correct: false }
                    ],
                    correctAnswerText: "ص = (١/٥)س - ١",
                    correctAnswerDisplay: "ص = <span class='fraction'><span class='numerator'>١</span><span class='denominator'>٥</span></span>س - ١",
                    hint: "تلميح: أعد كتابة المعادلة (٥س + ص = ٢) لإيجاد الميل (-٥)، ثم اوجد مقلوب معكوسه (١/٥).",
                    explanation: "١. نعدل المعادلة: ص = -٥س + ٢. الميل هو م = -٥.\n٢. العمود المطلوب يعامده، إذاً ميله هو (١/٥).\n٣. نستخدم النقطة (٥، ٠).\n٤. (ص - ٠) = (١/٥) × (س - ٥)\n٥. ص = (١/٥)س - ١",
                    score: 20,
                    smartVerification: (p) => `<p>هل ${p.y} = (١/٥) × (${p.x}) - ١ ؟</p><p>هل ${p.y} = ${(1/5) * p.x} - ١ ؟</p>`,
                    smartCalc: (p) => (1/5) * p.x - 1
                }
            ]
        };


        // --- تتبع الأسئلة ---
        // (معدل) هذه المصفوفات تحدد *ترتيب* المهام
        const parallelQuestions = ['q1', 'q3'];
        const perpendicularQuestions = ['q2', 'q4'];
        let parallelIndex = 0;
        let perpendicularIndex = 0;

        // --- متغيرات حالة اللعبة ---
        // (معدل) متغيرات لتتبع السؤال *الحالي* الذي تم اختياره عشوائياً
        let currentQuestion = null; // سيحتفظ بكائن السؤال المختار
        let currentMissionKey = null; // سيحتفظ بالمفتاح ('q1', 'q2', 'q3', 'q4')
        let currentMissionResult = null; // سيحتفظ بالمرجع لـ missionResults
        
        let hasMadeFirstAttempt = false;
        let totalScore = 0;
        
        // (جديد) متغيرات تتبع حالة الإكمال والنتائج
        let parallelTrackComplete = false;
        let perpendicularTrackComplete = false;
        let missionResults = {}; // سيتم ملؤه في دالة restartGame

        // (جديد) متغيرات المؤقت
        let gameTimerInterval = null;
        let totalGameSeconds = 0;
        let missionStartTime = 0; // لتتبع وقت بدء المهمة الحالية
        let isTimerPaused = false;

        // --- عناصر التحكم الرئيسية ---
        const gameContainer = document.getElementById('game-container');
        const gameButtonsContainer = document.getElementById('game-buttons-container');
        const parallelBtn = document.getElementById('parallel-btn');
        const perpendicularBtn = document.getElementById('perpendicular-btn');

        // --- عناصر التحكم بالنافذة المنبثقة ---
        const modal = document.getElementById('question-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalPrompt = document.getElementById('modal-prompt');
        const modalEquation = document.getElementById('modal-equation');
        const modalScore = document.getElementById('modal-score');
        const modalTimer = document.getElementById('modal-timer');
        
        // عناصر النافذة التفاعلية
        const modalChoices = document.getElementById('modal-choices');
        const scoreDisplay = document.getElementById('score-display');
        const whyBtn = document.getElementById('why-btn');
        const smartWhyBtn = document.getElementById('smart-why-btn');
        const nextBtn = document.getElementById('next-btn');

        // عناصر نافذة التلميح
        const hintModal = document.getElementById('hint-modal');
        const hintModalContent = document.getElementById('hint-modal-content');
        const hintTextMain = document.getElementById('hint-text-main');
        const hintTextExtra = document.getElementById('hint-text-extra');

        // عناصر نافذة "اعرف لماذا؟"
        const explanationModal = document.getElementById('explanation-modal');
        const explanationModalContent = document.getElementById('explanation-modal-content');
        const expModalTitle = document.getElementById('exp-modal-title');
        const expModalEquation = document.getElementById('exp-modal-equation');
        const expModalPoint = document.getElementById('exp-modal-point');
        const expModalText = document.getElementById('exp-modal-text');
        
        // عناصر نافذة "الشرح الذكي"
        const smartExplanationModal = document.getElementById('smart-explanation-modal');
        const smartExplanationModalContent = document.getElementById('smart-explanation-modal-content');
        const smartExpModalText = document.getElementById('smart-exp-modal-text');

        // (جديد) عناصر نوافذ البداية والملخص والنهاية
        const introModal = document.getElementById('intro-modal');
        const instructionsModal = document.getElementById('instructions-modal');
        const summaryModal = document.getElementById('summary-modal');
        const summaryTableBody = document.querySelector('#summary-table-content tbody');
        const finalScoreModal = document.getElementById('final-score-modal');
        const finalTotalScore = document.getElementById('final-total-score');
        const finalRatingScore = document.getElementById('final-rating-score');
        const finalScoreCircle = document.getElementById('final-score-circle-display');
        const finalScoreMessage = document.getElementById('final-score-message');


        // --- (جديد) دوال المؤقت ---
        function startTimer() {
            if (gameTimerInterval) clearInterval(gameTimerInterval); // ضمان عدم تكرار المؤقت
            isTimerPaused = false;
            gameTimerInterval = setInterval(() => {
                if (!isTimerPaused) {
                    totalGameSeconds++;
                    // تحديث المؤقت في نافذة المهمة (إذا كانت مفتوحة)
                    updateTimerDisplay(totalGameSeconds, modalTimer);
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerPaused = true;
        }

        function resumeTimer() {
            isTimerPaused = false;
        }

        function stopTimer() {
            clearInterval(gameTimerInterval);
            gameTimerInterval = null;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateTimerDisplay(seconds, element) {
            if (element) {
                element.textContent = toArabicNumerals(formatTime(seconds));
            }
        }
        
        function getMissionTime() {
            // حساب الوقت المستغرق للمهمة الحالية
            return totalGameSeconds - missionStartTime;
        }

        // --- (جديد) دوال نوافذ البداية ---
        window.onload = () => {
            // إظهار نافذة البداية عند تحميل الصفحة
            const introContent = introModal.querySelector('.intro-modal');
            introModal.classList.remove('hidden');
            setTimeout(() => {
                introContent.classList.remove('scale-95', 'opacity-0');
                introContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            // إظهار الخلفية تدريجياً
            setTimeout(() => {
                gameContainer.style.opacity = '1';
            }, 500); // إظهار الخلفية بعد 0.5 ثانية
            
            // تهيئة نتائج اللعبة عند البداية
            initializeMissionResults();
        };

        function showInstructionsModal() {
            const introContent = introModal.querySelector('.intro-modal');
            const instructionsContent = instructionsModal.querySelector('.intro-modal');
            
            introContent.classList.add('scale-95', 'opacity-0');
            introContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                introModal.classList.add('hidden');
                instructionsModal.classList.remove('hidden');
                instructionsContent.classList.remove('scale-95', 'opacity-0');
                instructionsContent.classList.add('scale-100', 'opacity-100');
            }, 300); // انتظار انتهاء تأثير الخروج
        }

        function startGame() {
            const instructionsContent = instructionsModal.querySelector('.intro-modal');
            
            instructionsContent.classList.add('scale-95', 'opacity-0');
            instructionsContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                instructionsModal.classList.add('hidden');
                // إظهار أزرار اللعبة وعداد النقاط الخارجي
                gameButtonsContainer.classList.remove('hidden');
                scoreDisplay.classList.remove('hidden');
                
                // بدء المؤقت العام للعبة
                totalGameSeconds = 0;
                startTimer();

            }, 300); // انتظار انتهاء تأثير الخروج
        }

        // --- دوال عرض الأسئلة ---
        function showParallelQuestion() {
            if (parallelTrackComplete) return; // لا تفعل شيئاً إذا اكتمل المسار
            parallelIndex = 0; 
            const missionKey = parallelQuestions[parallelIndex]; // 'q1'
            showQuestion(missionKey);
        }

        function showPerpendicularQuestion() {
            if (perpendicularTrackComplete) return; // لا تفعل شيئاً إذا اكتمل المسار
            perpendicularIndex = 0;
            const missionKey = perpendicularQuestions[perpendicularIndex]; // 'q2'
            showQuestion(missionKey);
        }

        // --- (معدلة) دالة إظهار السؤال (لاختيار سؤال عشوائي وخلط الإجابات) ---
        function showQuestion(missionKey) {
            
            // 1. تحديد بنك الأسئلة للمهمة واختيار سؤال عشوائي
            const questionBankForMission = questionBank[missionKey];
            currentQuestion = questionBankForMission[Math.floor(Math.random() * questionBankForMission.length)];
            
            // 2. تخزين المفتاح والمرجع لنتائج المهمة
            currentMissionKey = missionKey;
            currentMissionResult = missionResults[missionKey];

            // 3. إعادة تعيين حالة المحاولة
            hasMadeFirstAttempt = false;
            
            // 4. (جديد) تسجيل وقت بدء المهمة واستئناف المؤقت
            missionStartTime = totalGameSeconds;
            resumeTimer();
            updateModalScore(); 
            updateTimerDisplay(totalGameSeconds, modalTimer);

            const data = currentQuestion;
            if (!data) return;

            // 5. ملء بيانات السؤال (مع تحويل الأرقام)
            modalTitle.textContent = toArabicNumerals(data.title);
            modalPrompt.textContent = toArabicNumerals(data.prompt);
            modalEquation.innerHTML = toArabicNumerals(data.equation); // innerHTML للكسور

            // 6. مسح الاختيارات السابقة وإخفاء العناصر
            modalChoices.innerHTML = '';
            whyBtn.classList.add('hidden');
            smartWhyBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');

            // 7. (جديد) خلط الإجابات وإنشاؤها
            let shuffledChoices = [...data.choices]; // إنشاء نسخة
            shuffleArray(shuffledChoices); // خلط النسخة

            shuffledChoices.forEach(choice => {
                const button = document.createElement('button');
                button.innerHTML = toArabicNumerals(choice.text); // استخدام innerHTML لرض الكسور وتحويل الأرقام
                button.className = 'choice-btn'; 
                button.onclick = () => checkAnswer(button, choice.correct); // إرسال علامة "صحيح"
                modalChoices.appendChild(button);
            });

            // 8. إظهار النافذة
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); 
        }

        // --- (معدلة) دالة التحقق من الإجابة ---
        function checkAnswer(buttonElement, isCorrect) {
            // (معدل) استخدام المتغيرات العامة التي تم تعيينها في showQuestion
            const data = currentQuestion;
            const missionData = currentMissionResult;
            
            // (جديد) إيقاف المؤقت مؤقتاً عند الإجابة
            pauseTimer(); 
            missionData.attempts++;
            
            // تعطيل جميع الأزرار
            const allChoiceButtons = modalChoices.querySelectorAll('button');
            allChoiceButtons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                // --- الإجابة الصحيحة ---
                buttonElement.classList.add('correct');
                
                const points = hasMadeFirstAttempt ? Math.round(data.score / 2) : data.score;
                totalScore += points;
                
                // (جديد) تسجيل النقاط للمهمة الحالية
                missionData.points = points;
                missionData.completed = true;
                missionData.time = getMissionTime(); // تسجيل الوقت عند الإجابة الصحيحة
                
                scoreDisplay.textContent = `النقاط: ${toArabicNumerals(totalScore)}`;
                updateModalScore(); // تحديث النقاط داخل النافذة

                nextBtn.classList.remove('hidden');
                whyBtn.classList.remove('hidden');
                smartWhyBtn.classList.remove('hidden');

            } else {
                // --- الإجابة الخاطئة ---
                buttonElement.classList.add('wrong');
                
                if (!hasMadeFirstAttempt) {
                    // المحاولة الأولى الخاطئة -> إظهار نافذة التلميح
                    hasMadeFirstAttempt = true;
                    showHintModal(data.hint || "تلميح: حاول التركيز على إيجاد الميل الصحيح أولاً.", data.score); 
                    
                    // إعادة تفعيل الأزرار المتبقية
                    allChoiceButtons.forEach(btn => {
                        if (btn !== buttonElement) {
                            btn.disabled = false;
                        }
                    });
                } else {
                    // المحاولة الثانية الخاطئة
                    missionData.points = 0; // لم يحصل على نقاط
                    missionData.completed = true; // تعتبر المهمة منتهية (بفشل)
                    missionData.time = getMissionTime(); // تسجيل الوقت
                    
                    // (معدل) إظهار الإجابة الصحيحة بناءً على خاصية 'correct'
                    allChoiceButtons.forEach(btn => {
                        // للعثور على الزر الصحيح، نحتاج إلى مقارنة نصه أو استخدام خاصية بيانات
                        // الأسهل: إعادة البحث في الأزرار بناءً على النص الأصلي (غير فعال)
                        // أو إعادة تمكين الأزرار وإضافة علامة "correct"
                        // الطريقة الأبسط: بما أن الأزرار معطلة، يمكننا البحث في `shuffledChoices`
                        // لكن `checkAnswer` لا تملك الوصول إليها.
                        
                        // حل بسيط: بما أننا مررنا `isCorrect`، لا نحتاج للبحث مرة أخرى
                        // فقط نجد الزر الذي *لم* يتم النقر عليه وهو الصحيح
                        // هذا معقد.

                        // الحل الأسهل: عند الإجابة الخاطئة الثانية، نقوم بتلوين الزر المنقور بالأحمر
                        // ثم نعيد تفعيل *فقط* الزر الصحيح ونلونه بالأخضر.
                        // هذا غير جيد.

                        // (إصلاح) الطريقة الصحيحة:
                        // بما أن الأزرار تم إنشاؤها من `shuffledChoices`
                        // ونحن الآن داخل `checkAnswer`، لا يمكننا الوصول المباشر
                        // لذلك، سنعيد تفعيل الأزرار ونضيف علامة `correct` / `wrong`
                        
                        // (إعادة التفكير) الأزرار معطلة بالفعل.
                        // نحتاج لإيجاد الزر الصحيح وتلوينه.
                        // `data.choices` بها الإجابات الأصلية.
                        // `allChoiceButtons` بها الأزرار المخلوطة.
                        
                        const correctChoice = data.choices.find(c => c.correct);
                        
                        allChoiceButtons.forEach(btn => {
                            // نقارن `innerHTML` (بعد تحويله للأرقام العربية)
                            if (btn.innerHTML === toArabicNumerals(correctChoice.text)) {
                                btn.classList.add('correct');
                            }
                        });
                    });

                    nextBtn.classList.remove('hidden');
                    whyBtn.classList.remove('hidden');
                    smartWhyBtn.classList.remove('hidden');
                }
            }
        }
        
        // (جديد) دالة تحديث النقاط داخل النافذة
        function updateModalScore() {
             modalScore.textContent = `النقاط: ${toArabicNumerals(totalScore)}`;
        }

        // --- (معدل) دوال نافذة التلميح (لتحويل الأرقام) ---
        function showHintModal(hintMessage, score) {
            // (جديد) إيقاف المؤقت عند إظهار التلميح
            pauseTimer();
            
            const halfScore = Math.round(score / 2);
            hintTextMain.textContent = toArabicNumerals(hintMessage); // تحويل الأرقام
            hintTextExtra.textContent = `حاول مرة أخرى. الآن لك نصف الدرجة (${toArabicNumerals(halfScore)} نقاط).`;
            
            hintModal.classList.remove('hidden');
            setTimeout(() => {
                hintModalContent.classList.remove('scale-95', 'opacity-0');
                hintModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideHintModal() {
            // (جديد) استئناف المؤقت عند إغلاق التلميح
            resumeTimer();
            
            hintModalContent.classList.add('scale-95', 'opacity-0');
            hintModalContent.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                hintModal.classList.add('hidden');
            }, 200);
        }

        // --- (معدل) دوال نافذة "اعرف لماذا؟" (لتحويل الأرقام) ---
        function showExplanation() {
            // (جديد) إيقاف المؤقت عند إظهار الشرح
            pauseTimer();
            
            const data = currentQuestion; // (معدل)
            expModalTitle.textContent = toArabicNumerals(data.title);
            expModalEquation.innerHTML = toArabicNumerals(data.equation); // (معدل)
            expModalPoint.textContent = toArabicNumerals(data.point.text);
            expModalText.innerHTML = toArabicNumerals(data.explanation); // استخدام innerHTML للكسور وتحويل الأرقام
            
            explanationModal.classList.remove('hidden');
            setTimeout(() => {
                explanationModalContent.classList.remove('scale-95', 'opacity-0');
                explanationModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideExplanationModal() {
            // (جديد) استئناف المؤقت عند إغلاق الشرح
            resumeTimer();
            
            explanationModalContent.classList.add('scale-95', 'opacity-0');
            explanationModalContent.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                explanationModal.classList.add('hidden');
            }, 200);
        }

        // --- (معدل) دوال نافذة "الشرح الذكي" (لتحويل الأرقام واستخدام دالة الحساب) ---
        function showSmartExplanation() {
            // (جديد) إيقاف المؤقت عند إظهار الشرح الذكي
            pauseTimer();
            
            const data = currentQuestion; // (معدل)
            const p = data.point;
            const eqText = data.correctAnswerDisplay || data.correctAnswerText;
            
            try {
                // (جديد) استدعاء الدوال من كائن السؤال
                const verificationText = data.smartVerification(p);
                const calcResult = data.smartCalc(p);
                const roundedCalc = Math.round(calcResult * 1000) / 1000; // زيادة الدقة للكسور
                
                let finalResult = `${p.y} = ${roundedCalc}`;
                // تصحيح أخطاء الفاصلة العائمة الشائعة (مثل 0.333 * 3 = 0.999)
                if (Math.abs(p.y - roundedCalc) < 0.01) {
                    finalResult = `${p.y} = ${p.y}`; // إظهار التطابق
                }


                smartExpModalText.innerHTML = `
                    <p>المعادلة الصحيحة: ${toArabicNumerals(eqText)}</p>
                    <p>النقطة: ${toArabicNumerals(p.text)}</p>
                    <hr class="my-2">
                    <p>نتحقق بتعويض النقطة (س، ص):</p>
                    ${toArabicNumerals(verificationText)}
                    <hr class="my-2">
                    <p class="font-bold text-lg">${toArabicNumerals(finalResult)}</p>
                    <p class="font-bold text-green-600">المعادلة صحيحة!</p>
                `;
            } catch (e) {
                console.error("Smart Explanation Error:", e);
                smartExpModalText.innerHTML = "<p>خطأ في حساب التعويض.</p>";
            }

            smartExplanationModal.classList.remove('hidden');
            setTimeout(() => {
                smartExplanationModalContent.classList.remove('scale-95', 'opacity-0');
                smartExplanationModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideSmartExplanationModal() {
            // (جديد) استئناف المؤقت عند إغلاق الشرح الذكي
            resumeTimer();
            
            smartExplanationModalContent.classList.add('scale-95', 'opacity-0');
            smartExplanationModalContent.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                smartExplanationModal.classList.add('hidden');
            }, 200);
        }

        // --- (معدل) دالة للتحكم في الانتقال بين الأسئلة أو الإغلاق ---
        function goToNextQuestionOrHide() {
            // إخفاء أي نوافذ فرعية مفتوحة (شرح، تلميح)
            hideExplanationModal();
            hideSmartExplanationModal();
            // (جديد) إيقاف المؤقت مؤقتاً أثناء الانتقال
            pauseTimer();

            let nextMissionKey = null;
            let isTrackFinished = false;

            // (معدل) تحديد السؤال التالي بناءً على المفتاح الحالي
            if (currentMissionKey === 'q1') {
                nextMissionKey = 'q3'; // من المهمة الأولى (التوازي) إلى المهمة الثانية (التوازي)
                parallelIndex = 1; // تحديث الفهرس (هذا لم يعد مستخدماً للأسف، لكنه لا يضر)
            } else if (currentMissionKey === 'q3') {
                // انتهى مسار التوازي
                parallelTrackComplete = true;
                parallelBtn.disabled = true; // (جديد) تعطيل الزر الرئيسي
                isTrackFinished = true;
            } else if (currentMissionKey === 'q2') {
                nextMissionKey = 'q4'; // من المهمة الثالثة (التعامد) إلى المهمة الرابعة (التعامد)
                perpendicularIndex = 1; // تحديث الفهرس (غير مستخدم)
            } else if (currentMissionKey === 'q4') {
                // انتهى مسار التعامد
                perpendicularTrackComplete = true;
                perpendicularBtn.disabled = true; // (جديد) تعطيل الزر الرئيسي
                isTrackFinished = true;
            }

            // بدء تأثير التلاشي للخارج للنافذة الحالية
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');

            setTimeout(() => {
                if (nextMissionKey && !isTrackFinished) {
                    // إذا كان هناك سؤال تالٍ في نفس المسار، قم بتحميله وإظهاره
                    modalChoices.innerHTML = ''; // مسح الاختيارات القديمة
                    showQuestion(nextMissionKey);
                } else {
                    // إذا انتهى المسار، أغلق النافذة بالكامل
                    modal.classList.add('hidden');
                    // تنظيف النافذة عند الإغلاق
                    modalChoices.innerHTML = '';
                    whyBtn.classList.add('hidden');
                    smartWhyBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                    
                    // (جديد) التحقق مما إذا كان يجب إظهار الملخص
                    checkIfGameComplete();
                }
            }, 200); // انتظر انتهاء تأثير التلاشي للخارج قبل الانتقال أو الإغلاق
        }

        // --- (جديد) دوال الملخص والنتيجة النهائية ---
        
        function checkIfGameComplete() {
            if (parallelTrackComplete && perpendicularTrackComplete) {
                // إذا اكتمل المساران، أوقف المؤقت وأظهر الملخص
                stopTimer();
                showSummaryModal();
            }
        }

        // (معدل) دالة عرض الملخص لإظهار النقاط "من"
        function showSummaryModal() {
            summaryTableBody.innerHTML = ''; // مسح الجدول القديم
            
            const missionOrder = ['q1', 'q3', 'q2', 'q4']; // ترتيب عرض النتائج
            missionOrder.forEach(qId => {
                const data = missionResults[qId];
                
                // (معدل) الوصول لبيانات السؤال الأصلية (نأخذ أول سؤال كمثال للـ score)
                const qData = questionBank[qId][0]; 
                
                // (معدل) تنسيق عرض النقاط
                const pointsText = `${toArabicNumerals(data.points)} من ${toArabicNumerals(qData.score)}`;
                
                const row = `
                    <tr>
                        <td>${toArabicNumerals(data.title)}</td>
                        <td>${pointsText}</td>
                        <td>${toArabicNumerals(formatTime(data.time))}</td>
                    </tr>
                `;
                summaryTableBody.innerHTML += row;
            });

            const summaryContent = summaryModal.querySelector('.intro-modal');
            summaryModal.classList.remove('hidden');
            setTimeout(() => {
                summaryContent.classList.remove('scale-95', 'opacity-0');
                summaryContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function showFinalScoreModal() {
            // (جديد) استدعاء دالة الحفظ وإظهار النتائج
            if (window.saveAndFinishGame) {
                window.saveAndFinishGame(totalScore, totalGameSeconds); 
            }

            const summaryContent = summaryModal.querySelector('.intro-modal');
            const finalScoreContent = finalScoreModal.querySelector('.intro-modal');

            // حساب النتيجة من ٥
            const maxScore = 60; // (10 + 20 + 10 + 20)
            const rating = (totalScore / maxScore) * 5;
            // تقريب لأقرب نصف درجة
            const finalRating = Math.round(rating * 2) / 2; 

            finalTotalScore.textContent = toArabicNumerals(totalScore);
            finalRatingScore.textContent = toArabicNumerals(finalRating.toFixed(1)); // إظهار .٥ إذا وجدت

            // تحديد لون الدائرة والرسالة
            finalScoreCircle.classList.remove('green', 'yellow', 'red', 'blue');
            if (finalRating >= 4.5) {
                finalScoreCircle.classList.add('green'); // ممتاز
                finalScoreMessage.textContent = "أداء ممتاز! لقد أتقنت التوازي والتعامد.";
            } else if (finalRating >= 3.5) {
                finalScoreCircle.classList.add('blue'); // جيد جداً
                finalScoreMessage.textContent = "أداء جيد جداً! أنت في الطريق الصحيح.";
            } else if (finalRating >= 2.5) {
                finalScoreCircle.classList.add('yellow'); // جيد
                finalScoreMessage.textContent = "أداء جيد. تحتاج لبعض المراجعة.";
            } else {
                finalScoreCircle.classList.add('red'); // محاولة أخرى
                finalScoreMessage.textContent = "تحتاج للمزيد من التدريب. حاول مرة أخرى!";
            }


            summaryContent.classList.add('scale-95', 'opacity-0');
            summaryContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                summaryModal.classList.add('hidden');
                finalScoreModal.classList.remove('hidden');
                finalScoreContent.classList.remove('scale-95', 'opacity-0');
                finalScoreContent.classList.add('scale-100', 'opacity-100');
            }, 300);
        }
        
        function initializeMissionResults() {
             missionResults = {
                 // (معدل) تحديث العناوين لتطابق المهام
                'q1': { title: "المهمة الأولى", points: 0, time: 0, attempts: 0, completed: false },
                'q3': { title: "المهمة الثانية", points: 0, time: 0, attempts: 0, completed: false },
                'q2': { title: "المهمة الثالثة", points: 0, time: 0, attempts: 0, completed: false },
                'q4': { title: "المهمة الرابعة", points: 0, time: 0, attempts: 0, completed: false }
            };
        }

        function restartGame() {
            // إعادة تعيين كل شيء
            totalScore = 0;
            parallelTrackComplete = false;
            perpendicularTrackComplete = false;
            parallelIndex = 0;
            perpendicularIndex = 0;
            
            initializeMissionResults();

            // إعادة تفعيل الأزرار الرئيسية
            parallelBtn.disabled = false;
            perpendicularBtn.disabled = false;

            // تصفير عداد النقاط
            scoreDisplay.textContent = `النقاط: ٠`;
            
            // إيقاف المؤقت إذا كان يعمل
            stopTimer();
            totalGameSeconds = 0;
            
            // إخفاء نافذة النتيجة النهائية
            const finalScoreContent = finalScoreModal.querySelector('.intro-modal');
            finalScoreContent.classList.add('scale-95', 'opacity-0');
            finalScoreContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                finalScoreModal.classList.add('hidden');
                // إظهار نافذة البداية مرة أخرى
                const introContent = introModal.querySelector('.intro-modal');
                introModal.classList.remove('hidden');
                introContent.classList.remove('scale-95', 'opacity-0');
                introContent.classList.add('scale-100', 'opacity-100');
            }, 300);
        }

        // --- START OF CONNECTION & LEADERBOARD ENGINE ---
        (function() {
            // --- CONFIGURATION (عدّل هذه الإعدادات لكل لعبة) ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrf1-At3Pq7i39bGV3F1iD3-b0G-WWyRi5cgpKeQjyn_N5fh2EmGhoyRKUsbLd-F_UJQ/exec";
            const GAME_ID = 'g3_4_2';         // (تم التعديل)
            const GAME_MAX_POINTS = 60;       // (تم التعديل) أقصى نقاط في اللعبة
            const PLATFORM_MAX_GRADE = 5;                   // الدرجة النهائية في المنصة
            const METRIC_TYPE = 'time';                     // (تم التحقق) نوع المعيار: 'time', 'stars', 'errors'
            const METRIC_LABEL = 'الوقت (ثواني)';           // (تم التحقق) اسم المعيار للعرض في الجدول

            // --- Read URL Parameters ---
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const classId = urlParams.get('classId');
            const studentName = urlParams.get('studentName');

            let currentUser = (studentId && studentName) ? { id: studentId, name: studentName } : null;

            // --- CORE FUNCTIONS ---

            // 1. الدالة الرئيسية التي تستدعيها عند انتهاء اللعبة
            window.saveAndFinishGame = function(points, metricValue) {
                const finalPoints = parseFloat(points) || 0;
                const finalMetric = parseFloat(metricValue) || 0;
                const maxPoints = parseFloat(GAME_MAX_POINTS) || 1;
                const finalGrade = (finalPoints / maxPoints) * PLATFORM_MAX_GRADE;

                const resultDisplay = document.getElementById('final-result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <p class="text-gray-700">النقاط: <span class="font-bold text-xl">${finalPoints} / ${maxPoints}</span></p>
                        <p class="text-blue-600">الدرجة في المنصة: <span class="font-bold text-2xl">${finalGrade.toFixed(1)} / ${PLATFORM_MAX_GRADE}</span></p>
                    `;
                }

                if (studentId && classId) {
                    const params = new URLSearchParams({
                        action: 'saveGrade',
                        studentId: studentId,
                        classId: classId,
                        itemId: GAME_ID,
                        grade: finalGrade.toFixed(2),
                        metricValue: Math.round(finalMetric).toString()
                    });
                    fetch(`${SCRIPT_URL}?${params.toString()}`)
                        .then(res => res.json())
                        .then(result => console.log('Save result:', result.status))
                        .catch(err => console.error("Save Error:", err))
                        .finally(fetchAndShowLeaderboard);
                } else {
                    console.log(`Visitor finished. Score: ${finalPoints}, Metric: ${finalMetric}`);
                    fetchAndShowLeaderboard();
                }
            }

            // 2. دالة جلب وعرض سجل الأبطال
            function fetchAndShowLeaderboard() {
                const loader = document.getElementById('leaderboard-loader');
                const container = document.getElementById('leaderboard-container');
                if (!loader || !container) return;
                
                if (!classId) {
                    console.log("No classId found, skipping leaderboard for visitor.");
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">سجل الأبطال متاح للطلاب المسجلين فقط.</p>`;
                    showFinishButton();
                    return; 
                } 

                loader.style.display = 'block';
                container.innerHTML = '';

                const params = new URLSearchParams({
                    action: 'getLeaderboard',
                    gameId: GAME_ID,
                    metricType: METRIC_TYPE,
                    classId: classId
                });

                fetch(`${SCRIPT_URL}?${params.toString()}`)
                    .then(res => res.json())
                    .then(response => {
                        if (response.status === 'success' && response.data) {
                            displayLeaderboard(response.data);
                        } else {
                            throw new Error(response.message || 'Failed to load leaderboard data.');
                        }
                    })
                    .catch(err => {
                        console.error("Leaderboard Error:", err);
                        container.innerHTML = `<p class="text-center text-red-500">حدث خطأ في تحميل سجل الأبطال.</p>`;
                    })
                    .finally(() => {
                        loader.style.display = 'none';
                        showFinishButton();
                    });
            }
            
            // 3. دالة بناء جدول سجل الأبطال
            function displayLeaderboard(data) {
                const container = document.getElementById('leaderboard-container');
                if (!data || data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">لا توجد نتائج بعد. كن أول الأبطال!</p>`;
                    return;
                }

                let tableHTML = `
                    <!-- (تم التعديل) إضافة max-h-[300px] و overflow-y-auto لإضافة المزلاق -->
                    <div class="mt-6 border-t pt-4 max-h-[300px] overflow-y-auto">
                        <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">🏆 سجل الأبطال 🏆</h3>
                        <table class="min-w-full bg-white shadow-md rounded-lg">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="text-center py-2 px-3">الترتيب</th>
                                    <th class="text-right py-2 px-3">اسم الطالب</th>
                                    <th class="text-center py-2 px-3">الدرجة</th>
                                    <th class="text-center py-2 px-3">${METRIC_LABEL}</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">`;

                data.forEach((player, index) => {
                    const rank = index + 1;
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = '🥇';
                    if (rank === 2) rankDisplay = '🥈';
                    if (rank === 3) rankDisplay = '🥉';

                    const isCurrentUser = (currentUser && player.name === currentUser.name);
                    const rowClass = isCurrentUser ? 'bg-blue-100 font-bold' : (index % 2 === 0 ? 'bg-gray-100' : '');

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center py-2 px-3 text-xl">${rankDisplay}</td>
                            <td class="text-right py-2 px-3">${player.name}</td>
                            <td class="text-center py-2 px-3">${player.grade.toFixed(1)}</td>
                            <td class="text-center py-2 px-3">${player.metricValue}</td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            // 4. إظهار زر الإنهاء
            function showFinishButton() {
                const finishWrapper = document.getElementById('finish-game-wrapper');
                if (finishWrapper) {
                    finishWrapper.style.display = 'block';
                }
            }

            // 5. التعامل مع زر الإنهاء وتخصيص رسالة الترحيب
            document.addEventListener('DOMContentLoaded', () => {
                // Personalize welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (studentName && welcomeMessage) {
                    // (معدل) تعديل رسالة الترحيب لتناسب اللعبة
                    welcomeMessage.innerHTML = `أهلاً بك يا <span class="font-bold text-yellow-300">${studentName}</span>! ساعد في بناء المنصة البحرية بتركيب الأعمدة الفولاذية بشكل صحيح. كل إجابة صحيحة تقربك من إكمال البناء!`;
                }

                const finishBtn = document.getElementById('finish-game-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', () => {
                        window.parent.postMessage({ event: 'gameFinished', gameId: GAME_ID }, '*');
                    });
                }
            });
        })();
        // --- END OF CONNECTION & LEADERBOARD ENGINE ---

    </script>
</body>
</html>

